ZVSE2
A Mod by Perry R
Created between 2016 until 2021


********************************************************************************
                 Advanced Classes Mod for ERA 3.x

Content:

1. Disabled WoG Options and Global Settings
2. Handling of Class Points
3. Level up Procedure
4. Global Skill Balancing
5. Master and Grandmaster Secondary Skills (0-27)
6. Class Bonus Handling
7. Changes to Commanders
8. Setting Hero Specialisation descriptions
9. Scripting Hero Specialisation
10. New Artifact and Sets Section
11. Warmachine Upgrades
12. Spell Trainer

For feedback, bug reports and updates
Visit http://heroescommunity.com Advanced Classes Mod
Name on Heroescommunity RerryR
********************************************************************************


!#SN:W^Advanced_Classes_Mod_Active^/1;  [Set Mod Active]

!#SN:W^LeftSkill^/-3;
!#SN:W^RightSkill^/-3;
!#SN:W^After_Level_Up_Flag^/-1;
!#SN:W^After_Level_Click^/0;
!#SN:W^Game_Start_Value^/0;

!#SN:W^Adept_Level_Global_Value^/10;
!#SN:W^Expert_Level_Global_Value^/20;
!#SN:W^Master_Level_Global_Value^/35;
!#SN:W^Grandmaster_Level_Global_Value^/58; [Set Global Values for Class Here eg to reach Grandmaster or Master]

!#SN:W^Global_Skill_Limit^/8;           [Here comes the number of skills you intend to play with, usually 8 or 10]

!#SN:W^Spell_Trainer_Mod^/1;            [Spell Trainer Mod is enabled by default]


Disable Various WoG Options which can conflict with Advanced Classes Mod

!#UN:P201/0;                            [Check if Artillery is enabled in WoGify Options]
!#UN:P202/0;                            [Check if Eagle Eye is enabled in WoGify Options]
!#UN:P203/0;                            [Check if Estates is enabled in WoGify Options]
!#UN:P204/0;                            [Check if First Aid is enabled in WoGify Options]
!#UN:P205/0;                            [Check if Learning is enabled in WoGify Options]
!#UN:P206/0;                            [Check if Luck is enabled in WoGify Options]
!#UN:P207/0;                            [Check if Mysticism is enabled in WoGify Options]
!#UN:P35/0;                             [Check if Mysticism II is enabled in WoGify Options]
!#UN:P208/0;                            [Check if Navigation is enabled in WoGify Options]
!#UN:P209/0;                            [Check if Pathfinding is enabled in WoGify Options]
!#UN:P210/0;                            [Check if Resistance is enabled in WoGify Options]
!#UN:P211/0;                            [Check if Scholar is enabled in WoGify Options]
!#UN:P212/0;                            [Check if Scouting is enabled in WoGify Options]
!#UN:P213/0;                            [Check if Sorcery is enabled in WoGify Options]
!#UN:P214/0;                            [Check if Armorer is enabled in WoGify Options]

!#UN:P103/0;                            [Check if Eagle Eye is enabled in WoGify Options]
!#UN:P215/0;                            [Check if Scouting is enabled in WoGify Options]
!#UN:P217/0;                            [Check if Learning is enabled in WoGify Options]
!#UN:P218/0;                            [Check if tactics is enabled in WoG options]
!#UN:P193/0;                            [Warfare]
!#UN:P23/0;                             [Disable Sorcery Script]
!#UN:P191/0;                            [Disable Estate Script]
!#UN:P58/0;                             [Disable Espionage Script for free Z-Vars]
!#UN:P727/0;                            [Disable Backpack Artifacts from ES because it is included]
!#UN:P767/0;                            [Disable Misfortune from Era Scripts]

!#UN:P54/0;  !#VRv591:S0;               [Disabled Enhanced War Machines 1]
!#UN:P55/0;  !#VRv7180:S0;              [Disabled Enhanced War Machines 2]
!#UN:P73/0;  !#VRv847:S0;               [Disabled Enhanced War Machines 3]
!#UN:P39/0;  !#VRv425:S0;    !#IF:V429/0; !#VRv436:S255; [Disabled Hero Specialization Boost]
!#UN:P187/0;                            [Disable Hero Renaming]
!#UN:P23/0;                             [Disable Sorcery Script]
!#UN:P51/0;
!#VRv7185:S0;                           [Disable Enhanced Commanders]

!#SN:W^Double_Cast_Mod^/1;              [Set Mod Active]

!#MA:M146/4;                            [Ballista Dam Low 4]
!#MA:E146/6;                            [Ballista Dam High 6]
*#MA:C146/6/2500;                       [Ballista Cost 2500]

!#MA:P147/150;                          [First Aid Tent HP 150]
!#MA:C147/6/1000;                       [First Aid Tent Cost 1000]

!#MA:P148/150;                          [Ammo Cart HP 150]
!#MA:C148/6/1000;                       [Ammo Cart Cost 1000]

!#UN:C7785525/2/37008;                  [Disable Succubus Charming]
!#UN:C7788148/4/195;                    [Disable Temple Guardian Mana Reg] bug free???]
!#UN:C7788157/4/195;                    [Disable Temple Guardian Mana Reg]
!#UN:C7772712/2/37008;                  [Disable Brute Gold Bonus]

!#SN:L^era.dll^/?y1 Ay1/^ReadStrFromIni^/?y2;
!#SN:Ey2/1/^Tactics^/^Player settings^/^Advanced Classes.ini^/?z1;
!#VRv2:Vz1;

!#SN:W^Tactics_enabled^/v2;

!#UN:V?y1/?y2;                          [Check ERA version]
!#SN:T^AC_Misc.ATTENTION GRANDPA^/?z2;
!#IF&y2<3200:M^%Z2^;                    [Updated to version 3.2]

!#VRz-2:S^ACM Update 1.05^;             [User-defined section of WoG.ini file ("ACM Update 1.0X")]
!#UN:N6/-1/1/-2;                        [Check if ACM Update 1.0X Message has already been displayed]
!#VRz-1:H2;                             [Set Flag 2 to True if z-1 isn't empty: Flag 2]
!#SN:T^AC_Misc.First_Time^/?s^Text^;
!#IF&-2:Q1/21/134/1^%S(Text)^;
!#VRz-1&-2:S^message shown^;            ["message shown"]
!#UN&-2:N5/-1/1/-2;                     [Write data to WoG.ini to show that Ctrl Message has already been displayed]



; ==================================================================================================

!#DC(SKILL_MASTER)      = 4;
!#DC(SKILL_GRANDMASTER) = 5;

!#DC(HL_DISABLE_SKILL)     = -1;
!#DC(HL_DONT_CHANGE_SKILL) = -2;
!#DC(HL_USE_ALL_DEFAULTS)  = -3;

!#DC(HL_NUM_MAIN_CLASSES) = 3;
!#DC(HL_NO_CLASS)         = 0;
!#DC(HL_FIRST_CLASS)      = 1;

!#DC(HL_CLASS_WARRIOR)    = 1;
!#DC(HL_CLASS_MAGE)       = 2;
!#DC(HL_CLASS_ADVENTURER) = 4;
!#DC(HL_CLASS_HUNTER)     = 5;
!#DC(HL_CLASS_BATTLEMAGE) = 3;
!#DC(HL_CLASS_DRUID)      = 6;

!#DC(HL_WARRIOR_CLASS_IND)    = 0;
!#DC(HL_MAGE_CLASS_IND)       = 1;
!#DC(HL_ADVENTURER_CLASS_IND) = 2;

!#FU(NewIntArray):P(NUM_SECONDARY_SKILLS)/0/?i^acm_SecSkillsBackup^/(M_STORED);

!?FU(acm_GetRandomSkillToUpgrade);
; Returns random non-grandmaster secondary skill with at least specified level or (NO_SKILL) in case of failure.
!#VA(hero:x);
!#VA(minSkillLevel:x);
!#VA(result:x);
!#VA(excludeSkill:x); Optional. Specify skill to exclude from alternatives.

!#VA(skills[28]:y);
!!VR(numAlts:y):S0;
!!VR(result):S(NO_SKILL);

!!FU:A?(numArgs:y);
!!VR(excludeSkill)&(numArgs)<(@excludeSkill):S(NO_SKILL);

!!re i/0/(SEC_SKILL_LAST);
  !!HE(hero):Si/?(skillLevel:y);

  !!if&(skillLevel)>(SKILL_NOT_LEARNED)/i<>(excludeSkill);
    !!VR(isMaster:y):S(FALSE);
    !!VR(isGrandmaster:y):S(FALSE);
    !!FU(H3_Mod_Check_Skill_Level)&(skillLevel)>=(SKILL_EXPERT):P(hero)/?(isMaster:y)/?(isGrandmaster:y)/i;
    !!VR(skillLevel):+(isMaster) +(isGrandmaster);

    !!if&(skillLevel)>=(minSkillLevel)/(skillLevel)<(SKILL_GRANDMASTER);
      !!VR(skills[numAlts]):Si;
      !!VR(numAlts):+1;
    !!en;
  !!en;
!!en;

!!FU&(numAlts)<=0:E;
!!VR(randomInd:y):R0/1/(numAlts) -1;
!!VR(result):S(skills[randomInd]);

!?FU(acm_CountNumUniqueSkillsLearned);
!#VA(hero:x);
!#VA(result:x);

!!VR(result):S0;

!!re i/0/(SEC_SKILL_LAST);
  !!HE(hero):Si/?(skillLevel:y);
  !!VR(result)&(skillLevel)>(SKILL_NOT_LEARNED):+1;
!!en;

!?FU(acm_GetSecSkillLevel);
!#VA(hero:x);
!#VA(skill:x);
!#VA(result:x);

!!HE(hero):S(skill)/?(result);

!!if&(result)>=(SKILL_EXPERT);
  !!FU(H3_Mod_Check_Skill_Level):P(hero)/?(isMaster:y)/?(isGrandmaster:y)/(skill);
  !!VR(result)&(isMaster)<>(FALSE):S(SKILL_MASTER);
  !!VR(result)&(isGrandmaster)<>(FALSE):S(SKILL_GRANDMASTER);
!!en;

!?FU(acm_BackupAndPrepareSecSkills);
!#VA(hero:x);

!!re i/0/(SEC_SKILL_LAST);
  !!FU(acm_GetSecSkillLevel):P(hero)/i/?(skillLevel:y);
  !!SN:Vi^acm_SecSkillsBackup^/i/(skillLevel);
  !!HE(hero)&(skillLevel)>=(SKILL_EXPERT)/(skillLevel)<(SKILL_GRANDMASTER):Si/(SKILL_ADVANCED);
!!en;

!?FU(acm_SetSecSkillLevel);
!#VA(hero:x);
!#VA(skill:x);
!#VA(level:x);

!!VR(level):F(SKILL_NOT_LEARNED)/(SKILL_GRANDMASTER);
!!VR(nativeLevel:y):S(level) F(SKILL_NOT_LEARNED)/(SKILL_EXPERT);
!!HE(hero):S(skill)/(nativeLevel);
!!FU(H3_Mod_Set_Skill_ExtraLevel)&(level)=(SKILL_MASTER):P(hero)/(TRUE)/(FALSE)/(skill);
!!FU(H3_Mod_Set_Skill_ExtraLevel)&(level)=(SKILL_GRANDMASTER):P(hero)/(TRUE)/(TRUE)/(skill);

!?FU(acm_GetHeroClass);
!#VA(hero:x);   hero ID
!#VA(result:x); one of HL_CLASS_XXX constants or HL_NO_CLASS

!!VR(result):S(HL_NO_CLASS);

!!VR(isWarrior:y):Si^Master_Warrior_Hero%(hero)^;
!!VR(isMage:y):Si^Master_Mage_Hero%(hero)^;
!!VR(isAdventurer:y):Si^Master_Adventurer_Hero%(hero)^;

!!VR(result)&(isWarrior)=(TRUE):S(HL_CLASS_WARRIOR);
!!VR(result)&(isMage)=(TRUE):S(HL_CLASS_MAGE);
!!VR(result)&(isAdventurer)=(TRUE):S(HL_CLASS_ADVENTURER);
!!VR(result)&(isWarrior)=(TRUE)/(isMage)=(TRUE):S(HL_CLASS_BATTLEMAGE);
!!VR(result)&(isWarrior)=(TRUE)/(isAdventurer)=(TRUE):S(HL_CLASS_HUNTER);
!!VR(result)&(isMage)=(TRUE)/(isAdventurer)=(TRUE):S(HL_CLASS_DRUID);

; ==================================================================================================



*** Post-Instruction trigger ***
!?PI;
!!FU(ACM_Game_start_Options):P;         [Show additional options at game start. Will be replaced by Dialogue]

!!DO(AC_Function_129)/0/155/1:P;        [Reset Magic Arrow damage increase for all Heroes when Map Starts]
!!DO(AC_Function_73)/0/69/1:P;          [Save Spell Points Costs at Map Start]


********************************************************************************
!?FU(OnGameEnter);                      [At gamestart]

!!VRv576:&-9;                           [Remove two secret skill option from WoG by removing 4th bit set on variable 576]

!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y10; [Check for Third Upgrade Mod and disable hook if present to prevent zero Exp bug because Amethyst hooks at the same spot]
!!if&y10=0;
  !!SN:L^EraPlugins\erm_hooker.era^/?y1;
  !!FU&y1=0:E;
  !!SN:Ay1/^SetHook^/?y2;
  !!SN:Ey2/1/5128574/(Necro_ChangePower_2);
!!en;

!!FU(Set_SS_Skill_Name_and_Text):P;     [Set Secondary Skill Descriptions and Names]

!!UN:C6548196/4/1022739087;             [SecSkills specPower 3% thanks to Igrik for providing code]

!!UN:C7785525/2/37008;                  [Disable Succubus Charming]
!!UN:C7788148/4/195;                    [Disable Temple Guardian Mana Reg] bug free???]
!!UN:C7788157/4/195;                    [Disable Temple Guardian Mana Reg]
!!UN:C7772712/2/37008;                  [Disable Brute Gold Bonus]

; Magic Wand (id 141) thanks to Igrik :)
!!UN:C7661053/4/255;                    [disable effects of magic wand by changeing ID from 141 to 255]
; Gate Key (id 160)
!!UN:C7381428/4/255 C7381572/4/255 C7381619/4/255;
; Monster's Power (id 143)
!!UN:C7736062/4/255;
; Gold Tower Arrow (id 142)
!!UN:C7718799/4/255 C7718828/4/255 C7734120/4/255;

!!UN:C4605318/1/6;                      [change Moral and set to max six]
!!UN:C4605344/1/6;
!!UN:C4605354/1/33;                     [Moral divisor set to 33  means 3% per point of Moral]
!!UN:C4605324/1/-10;
!!UN:C4605331/1/-10;
!!UN:C4605854/1/10;

!!UN:C5129872/1/233 C5129873/4/340;     [Disable the standart Eagel Eye reaction]

!!UN:C7779070/1/144;                    [Fix commander cast from Hawaiing, so that the correct amount of casts are displayed for commander in combat]
!!UN:C7779071/2/37008;                  [Fix commander cast from Hawaiing]

Enable Artefact to appear on the map
!#UN:A141/0 A141/3/8;                   [Magic Wand]
!#UN:A142/0 A142/3/4;                   [Gold Tower Arrow]
!#UN:A143/0 A143/3/8;                   [Monster's Power]
!#UN:A160/0 A160/3/8;                   [Gate Key]

!?FU(Necro_ChangePower_2);
!!SN:X?y1;
!!VRy2:Sy1 +8;  !!UN:Cy2/4/?y3;
!!VRy4:Sy3 -4;  !!UN:Cy4/4/?y5;
!!SN:X?y9 Xy5 X?e5 Xy9;
!!VRe5::2;                              [divide necromancy by 2, including Artifacts and Necro Amplifier]
!!SN:X?y9 Xe5 X?y5 Xy9;
!!UN:Cy4/4/y5;


********************************************************************************
!?CM2;                                  [Show Description in Hero Screen Trigger when left click on Hero Portrait]

!!CM:F?y1 I?y2 S?y3;
!!if&y1=0/y2=45/y3=12;                 [When clicked on Hero Portrait]

  !!SN:W^Adept_Level_Global_Value^/?y90;
  !!SN:W^Expert_Level_Global_Value^/?y91;
  !!SN:W^Master_Level_Global_Value^/?y92;
  !!SN:W^Grandmaster_Level_Global_Value^/?y93;

  !!HE-1:N?y1;
  !!FU(acm_RecalcClassPoints):Py1/?y10/?y20/?y30/(TRUE);

  !!SN&y10>=y93:T^AC_Misc.Grandmaster^/?z6; !!SN&y10<y93:T^AC_Misc.Master^/?z6; !!SN&y10<y92:T^AC_Misc.Expert^/?z6; !!SN&y10<y91:T^AC_Misc.Adept^/?z6;
  !!SN&y20>=y93:T^AC_Misc.Grandmaster^/?z7; !!SN&y20<y93:T^AC_Misc.Master^/?z7; !!SN&y20<y92:T^AC_Misc.Expert^/?z7; !!SN&y20<y91:T^AC_Misc.Adept^/?z7;
  !!SN&y30>=y93:T^AC_Misc.Grandmaster^/?z8; !!SN&y30<y93:T^AC_Misc.Master^/?z8; !!SN&y30<y92:T^AC_Misc.Expert^/?z8; !!SN&y30<y91:T^AC_Misc.Adept^/?z8;

  !!CM:R0;
  !!SN:T^AC_Misc.Warrior^/?z3;
  !!SN:T^AC_Misc.Mage^/?z4;
  !!SN:T^AC_Misc.Adventurer^/?z5;

  !!SN:T^AC_Misc.Bonus Table 2^/?s^Bonus Table 2^;
  *!IF:M^%S(Bonus Table 2)^;

  !!DL270:N^Class_Table.txt^;             [parse dialogue]
  !!SN:T^AC_Misc.Bonus Table 20^/?z20 Iz20/?z20;
  !!SN:T^AC_Misc.Bonus Table 21^/?z21 Iz21/?z21;
  !!SN:T^AC_Misc.Bonus Table 22^/?z22 Iz22/?z22;
  !!SN:T^AC_Misc.Bonus Table 4^/?z10;
  !!SN:T^AC_Misc.Bonus Table 5^/?z11;
  !!SN:T^AC_Misc.Bonus Table 6^/?z12;

  !!SN:T^AC_Misc.Bonus Table 8^/?z13;
  !!SN:T^AC_Misc.Bonus Table 9^/?z14;
  !!SN:T^AC_Misc.Bonus Table 10^/?z15;
  !!SN:T^AC_Misc.Bonus Table 11^/?z16;

  *!SN:T^AC_Misc.Bonus Table 40^/?z40; *!DL270:A40/3/z40/1;
  !!SN:T^AC_Misc.Bonus Table 41^/?z41 T^AC_Misc.Bonus Table 51^/?z51; !!DL270:A41/3/z41/1 A51/3/z51/1;
  !!SN:T^AC_Misc.Bonus Table 42^/?z42 T^AC_Misc.Bonus Table 52^/?z52; !!DL270:A42/3/z42/1 A52/3/z52/1;
  !!SN:T^AC_Misc.Bonus Table 43^/?z43 T^AC_Misc.Bonus Table 53^/?z53; !!DL270:A43/3/z43/1 A53/3/z53/1;
  !!SN:T^AC_Misc.Bonus Table 44^/?z44 T^AC_Misc.Bonus Table 54^/?z54; !!DL270:A44/3/z44/1 A54/3/z54/1;
  !!SN:T^AC_Misc.Bonus Table 45^/?z45 T^AC_Misc.Bonus Table 55^/?z55; !!DL270:A45/3/z45/1 A55/3/z55/1;
  !!SN:T^AC_Misc.Bonus Table 46^/?z46 T^AC_Misc.Bonus Table 56^/?z56; !!DL270:A46/3/z46/1 A56/3/z56/1;
  !!SN:T^AC_Misc.Bonus Table 47^/?z47 T^AC_Misc.Bonus Table 57^/?z57; !!DL270:A47/3/z47/1 A57/3/z57/1;
  !!SN:T^AC_Misc.Bonus Table 48^/?z48 T^AC_Misc.Bonus Table 58^/?z58; !!DL270:A48/3/z48/1 A58/3/z58/1;
  !!SN:T^AC_Misc.Bonus Table 49^/?z49 T^AC_Misc.Bonus Table 59^/?z59; !!DL270:A49/3/z49/1 A59/3/z59/1;
  !!SN:T^AC_Misc.Bonus Table 50^/?z50 T^AC_Misc.Bonus Table 60^/?z60; !!DL270:A50/3/z50/1 A60/3/z60/1;

  *!SN:T^AC_Misc.Bonus Table 70^/?z70; *!DL270:A70/3/z70/1;
  !!SN:T^AC_Misc.Bonus Table 71^/?z71 T^AC_Misc.Bonus Table 81^/?z81; !!DL270:A71/3/z71/1 A81/3/z81/1;
  !!SN:T^AC_Misc.Bonus Table 72^/?z72 T^AC_Misc.Bonus Table 82^/?z82; !!DL270:A72/3/z72/1 A82/3/z82/1;
  !!SN:T^AC_Misc.Bonus Table 73^/?z73 T^AC_Misc.Bonus Table 83^/?z83; !!DL270:A73/3/z73/1 A83/3/z83/1;
  !!SN:T^AC_Misc.Bonus Table 74^/?z74 T^AC_Misc.Bonus Table 84^/?z84; !!DL270:A74/3/z74/1 A84/3/z84/1;
  !!SN:T^AC_Misc.Bonus Table 75^/?z75 T^AC_Misc.Bonus Table 85^/?z85; !!DL270:A75/3/z75/1 A85/3/z85/1;
  !!SN:T^AC_Misc.Bonus Table 76^/?z76 T^AC_Misc.Bonus Table 86^/?z86; !!DL270:A76/3/z76/1 A86/3/z86/1;
  !!SN:T^AC_Misc.Bonus Table 77^/?z77 T^AC_Misc.Bonus Table 87^/?z87; !!DL270:A77/3/z77/1 A87/3/z87/1;
  !!SN:T^AC_Misc.Bonus Table 78^/?z78 T^AC_Misc.Bonus Table 88^/?z88; !!DL270:A78/3/z78/1 A88/3/z88/1;
  !!SN:T^AC_Misc.Bonus Table 79^/?z79 T^AC_Misc.Bonus Table 89^/?z89; !!DL270:A79/3/z79/1 A89/3/z89/1;

  *!SN:T^AC_Misc.Bonus Table 90^/?z90; *!DL270:A90/3/z90/1;
  !!SN:T^AC_Misc.Bonus Table 91^/?z91 T^AC_Misc.Bonus Table 101^/?z101; !!DL270:A91/3/z91/1 A101/3/z101/1;
  !!SN:T^AC_Misc.Bonus Table 92^/?z92 T^AC_Misc.Bonus Table 102^/?z102; !!DL270:A92/3/z92/1 A102/3/z102/1;
  !!SN:T^AC_Misc.Bonus Table 93^/?z93 T^AC_Misc.Bonus Table 103^/?z103; !!DL270:A93/3/z93/1 A103/3/z103/1;
  !!SN:T^AC_Misc.Bonus Table 94^/?z94 T^AC_Misc.Bonus Table 104^/?z104; !!DL270:A94/3/z94/1 A104/3/z104/1;
  !!SN:T^AC_Misc.Bonus Table 95^/?z95 T^AC_Misc.Bonus Table 105^/?z105; !!DL270:A95/3/z95/1 A105/3/z105/1;
  !!SN:T^AC_Misc.Bonus Table 96^/?z96 T^AC_Misc.Bonus Table 106^/?z106; !!DL270:A96/3/z96/1 A106/3/z106/1;
  !!SN:T^AC_Misc.Bonus Table 97^/?z97 T^AC_Misc.Bonus Table 107^/?z107; !!DL270:A97/3/z97/1 A107/3/z107/1;
  !!SN:T^AC_Misc.Bonus Table 98^/?z98 T^AC_Misc.Bonus Table 108^/?z108; !!DL270:A98/3/z98/1 A108/3/z108/1;
  !!SN:T^AC_Misc.Bonus Table 99^/?z99 T^AC_Misc.Bonus Table 109^/?z109; !!DL270:A99/3/z99/1 A109/3/z109/1;

  !!SN:T^AC_Misc.Bonus Table 61^/?z61 T^AC_Misc.Bonus Table 62^/?z62;
  !!DL270:A61/3/z50/1 A62/3/z61/1 A63/3/z50/1 A64/3/z62/1;;

  !!SN:T^AC_Misc.Bonus Table 3^/?z23; !!DL270:A20/3/z23/1; [Class Experience and class point table]
  !!SN:T^AC_Misc.Warrior^/?z24; !!DL270:A11/3/z24/1;
  !!SN:T^AC_Misc.Mage^/?z25; !!DL270:A12/3/z25/1;
  !!SN:T^AC_Misc.Adventurer^/?z26; !!DL270:A13/3/z26/1;
  !!SN:T^AC_Misc.Druid^/?z27; !!DL270:A15/3/z27/1;
  !!SN:T^AC_Misc.Hunter^/?z28; !!DL270:A14/3/z28/1;
  !!SN:T^AC_Misc.Battlemage^/?z29; !!DL270:A16/3/z29/1;
  !!DL270:A22/3/z20/1;
  !!DL270:A23/3/z21/1;
  !!DL270:A24/3/z22/1;
  !!DL270:A4/3/z10/1;
  !!DL270:A5/3/z11/1;
  !!DL270:A6/3/z12/1;

  !!DL270:A8/3/z13/1;
  !!DL270:A9/3/z14/1;
  !!DL270:A10/3/z15/1;
  !!DL270:A21/3/z16/1;

  !!DL270:S;
!!en;

!?DL&v998=270/v999>=11/v999<=31/v1000=14;[right click on the three pictures to show text for upgrade and description]

  !!SN:W^Master_Level_Global_Value^/?y92;
  !!SN:W^Grandmaster_Level_Global_Value^/?y93;
  !!SN|v999=11/v999=26:T^AC_Misc.Warrior Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93; [set text for 1st]
  !!SN|v999=12/v999=27:T^AC_Misc.Mages Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=13/v999=28:T^AC_Misc.Adventurer Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=14/v999=29:T^AC_Misc.Hunter Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=15/v999=30:T^AC_Misc.Druid Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!SN|v999=16/v999=31:T^AC_Misc.Battlemage Table^/?s^Text^/^Master^/y92/^Grandmaster^/y93;
  !!IF|v999=11/v999=12/v999=13/v999=14/v999=15/v999=16/v999=26/v999=27/v999=28/v999=29/v999=30/v999=31:M0/4/^%S(Text)^;

Close Dialouge
!?DL&v998=270/v999=30722/v1000=13;
!!DL:C1;


!?FU(ACM_Game_start_Options);

!!FU(difm_LoadOptionsFromIni):P;        [Try to load options from ini]

!!SN:F^PluginExists^/^10sskills^;       [Check for 10 SSkill Plugin]
!!if&v1=1;
  !!SN:W^Adept_Level_Global_Value^/20;
  !!SN:W^Expert_Level_Global_Value^/30;
  !!SN:W^Master_Level_Global_Value^/45;
  !!SN:W^Grandmaster_Level_Global_Value^/72; [Set Global Values for Class Here eg to reach Grandmaster or Master]
  !!SN:W^Global_Skill_Limit^/10;        [Here comes the number of skills you intend to play with, usually 8 or 10]
  !!SN:W^Play_with_10_Skills^/1;        [If active set option true]
!!en;

!!UN:R7/1/0;
!!UN:R5/1/0;                            [change mouse pointer]

!!DL271:N^GameOp.txt^;                  [parse dialogue]

!!DL271:A8/4/v1/1;                      [Set checkbox for 10 SS if plugin is active]

!!VRz1:S^Opt_1.pcx^; !!DL271:A1/11/z1/1;
!!VRz2:S^Opt_2.pcx^; !!DL271:A2/11/z2/1;
!!VRz3:S^Opt_3.pcx^; !!DL271:A3/11/z3/1;
!!VRz4:S^Opt_4.pcx^; !!DL271:A4/11/z4/1;
!!VRz5:S^Opt_5.pcx^; !!DL271:A5/11/z5/1;
!!VRz6:S^Opt_6.pcx^; !!DL271:A6/11/z6/1;

!!SN:T^AC_Misc.GameOpt_0^/?z7; !!DL271:A13/3/z7/1;
!!SN:T^AC_Misc.GameOpt_1^/?z8; !!DL271:A14/3/z8/1;
!!SN:T^AC_Misc.GameOpt_2^/?z9; !!DL271:A15/3/z9/1;
!!SN:T^AC_Misc.GameOpt_3^/?z10; !!DL271:A16/3/z10/1;
!!SN:T^AC_Misc.GameOpt_4^/?z11; !!DL271:A17/3/z11/1;
!!SN:T^AC_Misc.GameOpt_5^/?z12; !!DL271:A18/3/z12/1;
!!SN:T^AC_Misc.GameOpt_Text^/?z13; !!DL271:A20/3/z13/1;

!!SN:T^AC_Misc.GameOpt_Hint_0^/?z40; !!DL271:H1/40;
!!SN:T^AC_Misc.GameOpt_Hint_1^/?z41; !!DL271:H2/41;
!!SN:T^AC_Misc.GameOpt_Hint_2^/?z42; !!DL271:H3/42;
!!SN:T^AC_Misc.GameOpt_Hint_3^/?z43; !!DL271:H4/43;
!!SN:T^AC_Misc.GameOpt_Hint_4^/?z44; !!DL271:H5/44;
!!SN:T^AC_Misc.GameOpt_Hint_5^/?z45; !!DL271:H6/45;
!!SN:T^AC_Misc.GameOpt_Hint_6^/?z46; !!DL271:H30722/46;

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
*!SN:W^Play_with_10_Skills^/?y2;
!!SN:W^Easier_Class_option^/?y3;
!!SN:W^Classic_Skin_Mod^/?y4;
!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y10; [Check for Third Upgrade Mod]
!!SN&y10=1:W^Alternative_Necromancy_Mod^/0;
!!SN:W^Alternative_Necromancy_Mod^/?y5;
!!SN:W^Spell_Duration_Mod^/?y6;
!!DL271:A7/4/y1/1;
*!DL271:A8/4/y2/1;
!!DL271:A9/4/y3/1;
!!DL271:A10/4/y4/1;
!!DL271:A11/4/y5/1;
!!DL271:A12/4/y6/1;                     [switch def cardre to 0 or 1]

!!DL271:S;                              [Show Dialogue]

!!FU(difm_SaveOptionsToIni):P;

!?DL&v998=271/v999>=1/v999<=6/v1000=14; [right click on the three pictures to show text for upgrade and description]

!!SN|v999=1:T^AC_Misc.Play_Spell_Trainer^/?s^Text^; [set text for 1st]
*!SN|v999=2:W^Master_Level_Global_Value^/?y30;
*!SN|v999=2:W^Grandmaster_Level_Global_Value^/?y40; [Get Global Values for Class Here eg to reach Grandmaster or Master]
!!SN|v999=2:T^AC_Misc.Play_10_skills^/?s^Text^/^Master^/45/^Grandmaster^/72; [Show Dialogue if Player activated the 10 skills option]
!!SN|v999=3:T^AC_Misc.Play_Easier_Class^/?s^Text^;
!!SN|v999=4:T^AC_Misc.Play_Classic_Skin^/?s^Text^;
!!SN|v999=5:T^AC_Misc.Play_Necro_Balancing^/?s^Text^;
!!SN|v999=6:T^AC_Misc.Play_Spell_Duration^/?s^Text^;
!!IF:M0/4/^%S(Text)^;


!?DL&v998=271/v999>=7/v999<=12/v1000=13;[LMB on the options icons ]
!!VRz1:S^Button.wav^;
!!SN:Pz1;                               [Play Sound]

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
*!SN:W^Play_with_10_Skills^/?y2;
!!SN:W^Easier_Class_option^/?y3;
!!SN:W^Classic_Skin_Mod^/?y4;
!!SN:W^Alternative_Necromancy_Mod^/?y5;
!!SN:W^Spell_Duration_Mod^/?y6;
*!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y10; [Check for Third Upgrade Mod]

!!SN&v999=7/y1=0:W^Spell_Trainer_Mod^/1;[activate 1st]
!!SN&v999=7/y1=1:W^Spell_Trainer_Mod^/0;[deactivate first]
*!SN&v999=8/y2=0:W^Play_with_10_Skills^/1;
*!SN&v999=8/y2=1:W^Play_with_10_Skills^/0;
!!SN&v999=9/y3=0:W^Easier_Class_option^/1;
!!SN&v999=9/y3=1:W^Easier_Class_option^/0;
!!SN&v999=10/y4=0:W^Classic_Skin_Mod^/1;
!!SN&v999=10/y4=1:W^Classic_Skin_Mod^/0;
*!SN&v999=11/y5=0/y10=0:W^Alternative_Necromancy_Mod^/1;
*!SN&v999=11/y5=1/y10=0:W^Alternative_Necromancy_Mod^/0;
!!SN&v999=11/y5=0:W^Alternative_Necromancy_Mod^/1;
!!SN&v999=11/y5=1:W^Alternative_Necromancy_Mod^/0;
!!SN&v999=12/y6=0:W^Spell_Duration_Mod^/1;
!!SN&v999=12/y6=1:W^Spell_Duration_Mod^/0;

!!SN:W^Spell_Trainer_Mod^/?y1;
*!SN:W^Play_with_10_Skills^/?y2;
!!SN:W^Easier_Class_option^/?y3;
!!SN:W^Classic_Skin_Mod^/?y4;           [Check Status of options]
!!SN:W^Alternative_Necromancy_Mod^/?y5;
!!SN:W^Spell_Duration_Mod^/?y6;
!!DL271:A7/4/y1/1;
*!DL271:A8/4/y2/1;
!!DL271:A9/4/y3/1;
!!DL271:A10/4/y4/1;
!!DL271:A11/4/y5/1;
!!DL271:A12/4/y6/1;                     [switch def cardre to 0 or 1]


Close Dialouge
!?DL&v998=271/v999=30722/v1000=13;
!!DL:C1;

!?CM2;                                  [Show Bonus list in Hero Screen Trigger when left click on Attack/Def/SP/Knowledge Icons + ALT LMB]
!!CM:F?y1 I?y2;
!!FU|y1<>512:E;
!!SN:L^user32.dll^/?y1 Ay1/^GetKeyState^/?y2 Ey2/1/17;
!!VRy3:Sv1&65535;

!!SN:W^Adept_Level_Global_Value^/?y90;
!!SN:W^Expert_Level_Global_Value^/?y91;
!!SN:W^Master_Level_Global_Value^/?y92;
!!SN:W^Grandmaster_Level_Global_Value^/?y93;

!!CM:F?y1 I?y2;
!!if&y3>=32768;
!!if&y2=50;
!!SN:T^AC_Misc.Hunter Table^/?z2;
!!IF:M^%Z2^;
!!CM:R0;
!!en;

!!if&y2=51;
!!SN:T^AC_Misc.Druid Table^/?z2;
!!IF:M^%Z2^;
!!CM:R0;
!!en;

!!if&y2=52;
!!SN:T^AC_Misc.Battlemage Table^/?z2;
!!IF:M^%Z2^;
!!CM:R0;
!!en;
!!en;

**********
!!if&y3<32768;
!!if&y2=50;
!!SN:T^AC_Misc.Warrior Table^/?z2/^Master^/y92/^Grandmaster^/y93;
!!IF:M^%Z2^;
!!CM:R0;
!!en;

!!if&y2=51;
!!SN:T^AC_Misc.Adventurer Table^/?z2/^Master^/y92/^Grandmaster^/y93;
!!IF:M^%Z2^;
!!CM:R0;
!!en;

!!if&y2=52;
!!SN:T^AC_Misc.Mages Table^/?z2/^Master^/y92/^Grandmaster^/y93;
!!IF:M^%Z2^;
!!CM:R0;
!!en;
!!en;


********************************************************************************
When clicking on Kingdom Overview Icon at Adventure Map
This needs to be done to prevent an unkown crash with Kingdom Overview

!?CM5&1000;
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!if&v3=0/v4=3;                        [if left click and kingdom overview icon are clicked]
  !!CM:R0;                              [Disable]
  !!OW:C?y1;
  !!re i/0/6;                          [loop all player res]
    !!VRy2:S10+i; !!VRy3:S20+i;
    !!OW:Ry1/i/?yy2;                    [get players res]
    !!SN&i^timerWeekDay^=1:W^Day_7_Player_%Y1_Res_%Vi^/?yy3; [save them Monday]
    !!SN&i^timerWeekDay^=2:W^Day_1_Player_%Y1_Res_%Vi^/?yy3; [save them]
    !!SN&i^timerWeekDay^=3:W^Day_2_Player_%Y1_Res_%Vi^/?yy3; [save them]
    !!SN&i^timerWeekDay^=4:W^Day_3_Player_%Y1_Res_%Vi^/?yy3; [save them]
    !!SN&i^timerWeekDay^=5:W^Day_4_Player_%Y1_Res_%Vi^/?yy3; [save them]
    !!SN&i^timerWeekDay^=6:W^Day_5_Player_%Y1_Res_%Vi^/?yy3; [save them]
    !!SN&i^timerWeekDay^=7:W^Day_6_Player_%Y1_Res_%Vi^/?yy3; [save them Sunday]
  !!en;
  !!VRy40:Sy10-y20; !!VRy41:Sy11-y21; !!VRy42:Sy12-y22; !!VRy43:Sy13-y23; !!VRy44:Sy14-y24; !!VRy45:Sy15-y25; !!VRy46:Sy16-y26;
  !!SN:T^AC_Misc.No_Kingdom_Overview^/?z1; !!SN:Iz1/?z1; [Interpolate String]
  !!IF:M0/4/^%Z1^;                      [show Text]
!!en;

!?FU(OnEveryDay);                       [On every day for every player]
!!OW:C?y1 I-1/?y3;                      [Get current player and if AI]
!!VRy30:Si^timerWeekDay^;
!!re i/0/7;                            [loop all player res]
!!OW:Ry1/i/?y2;                         [get players res]
  !!SN:W^Day_%Y30_Player_%Y1_Res_%Vi^/y2;[save them Monday]
!!en;

********************************************************************************


                   Level Up Section


***************************Level Up Section*************************************
**Check for changed Class Points after visiting certain objects that can change secondary skills

!$OB6&1000;                             [Pandory Box]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]

!$OB26&1000;                            [Event]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]

!$OB81&1000;                            [Scholar]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]

!$OB83&1000;                            [Quest Hut]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]

!$OB104&1000;                           [University]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]

!$OB113&1000;                           [Witch Hut]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]

!$OB98/8&1000;                          [Conflux]
!!HE-1:N?y1;
!!FU(acm_ShowClassPromotionDlgIfMarked):Py1;          [Call Level Up Function]


********************************************************************************
!?FU(Check_SS_SKILLS);
!!HEx1:Sx16/?y1;
!!VRx2:S0;
!!VRx2|y1=1/y1=2:S1;
!!VRx16|y1=1/y1=2:S27;                  [If Skill at Basic or Advanced found exit Loop]

********************************************************************************
!?FU(acm_RecalcClassPoints);
!#VA(hero:x);
!#VA(warriorPoints:x);    OUT
!#VA(magePoints:x);       OUT
!#VA(adventurerPoints:x); OUT
!#VA(returnRealPoints:x); Optional. Return real class points for display purposes only. Default: false.
                        ; Usually we have to return fake points, satisfying certain constraints for compatibility with mod legacy code

; Backup original classes to be able to track changes
!!VR(prevWasMasterWarrior:y):Si^Master_Warrior_Hero%(hero)^;
!!VR(prevWasMasterMage:y):Si^Master_Mage_Hero%(hero)^;
!!VR(prevWasMasterAdventurer:y):Si^Master_Adventurer_Hero%(hero)^;
!!VR(prevWasGrandmasterWarrior:y):Si^Grandmaster_Warrior_Hero%(hero)^;
!!VR(prevWasGrandmasterMage:y):Si^Grandmaster_Mage_Hero%(hero)^;
!!VR(prevWasGrandmasterAdventurer:y):Si^Grandmaster_Adventurer_Hero%(hero)^;

; Call original function for compatibility reasons, exit if it's called for display only
!!FU(Calc_Class_Points_Original):P(hero)/(NULL)/?(warriorPoints)/?(magePoints)/?(adventurerPoints);

; Copy class points to list to operate them in loops
!#VA(classPoints[HL_NUM_MAIN_CLASSES]:y);
!!VR(classPoints[HL_WARRIOR_CLASS_IND]):S(warriorPoints);
!!VR(classPoints[HL_MAGE_CLASS_IND]):S(magePoints);
!!VR(classPoints[HL_ADVENTURER_CLASS_IND]):S(adventurerPoints);

; Desired class can be selected by player to force upgrading only that class points and ignore non-revevant skills
!!VR(chosenClass:y):Si^acm_chosenClass_%(hero)^;

!!if&(chosenClass)<>(HL_NO_CLASS);
  ; Desired class is set, nullify all non-relevant class points
  !!VR(testClass:y):S(HL_FIRST_CLASS);

  !!re i/0/(HL_NUM_MAIN_CLASSES)/1/-1;
    ; If tested class is the desired class or is a part of desired multiclass, multiplier will be 1, 0 otherwise
    !!VR(classPointsMultiplier:y):S(chosenClass) &(testClass) F0/1;
    !!VR(classPoints[i]):*(classPointsMultiplier);
    !!VR(testClass):Sd<<1;
  !!en;
!!el;
  ; Desired class is not set, leave two highest points classes and nullify the third
  ; This is global mod constaints: 3 main classes are not supported. Multiclasses are formed by max 2 main classes
  !!VR(weakestClassIndex:y):S-1;
  !!VR(weakestClassPoints:y):S(INT_MAX);

  ; Determine class with lowest points
  !!re i/0/(HL_NUM_MAIN_CLASSES)/1/-1;
    !!if&(classPoints[i])<(weakestClassPoints);
      !!VR(weakestClassIndex):Si;
      !!VR(weakestClassPoints):S(classPoints[i]);
    !!en;
  !!en;

  ; Nullify weakest class points
  !!VR(classPoints[weakestClassIndex]):S0;
!!en; else

; Re-evaluate global class variables
!!VR(masterClassRequiredPoints:y):Si^Master_Level_Global_Value^;
!!VR(grandmasterClassRequiredPoints:y):Si^Grandmaster_Level_Global_Value^;

!!VRi^Master_Warrior_Hero%(hero)^:S(FALSE);
!!VRi^Master_Mage_Hero%(hero)^:S(FALSE);
!!VRi^Master_Adventurer_Hero%(hero)^:S(FALSE);
!!VRi^Grandmaster_Warrior_Hero%(hero)^:S(FALSE);
!!VRi^Grandmaster_Mage_Hero%(hero)^:S(FALSE);
!!VRi^Grandmaster_Adventurer_Hero%(hero)^:S(FALSE);

!!if&(classPoints[HL_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[HL_MAGE_CLASS_IND])>=(masterClassRequiredPoints);
  !!VRi^Master_Warrior_Hero%(hero)^:S(TRUE);
  !!VRi^Master_Mage_Hero%(hero)^:S(TRUE);
!!el&(classPoints[HL_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[HL_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints);
  !!VRi^Master_Warrior_Hero%(hero)^:S(TRUE);
  !!VRi^Master_Adventurer_Hero%(hero)^:S(TRUE);
!!el&(classPoints[HL_MAGE_CLASS_IND])>=(masterClassRequiredPoints)/(classPoints[HL_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints);
  !!VRi^Master_Mage_Hero%(hero)^:S(TRUE);
  !!VRi^Master_Adventurer_Hero%(hero)^:S(TRUE);
!!el;
  !!VRi^Master_Warrior_Hero%(hero)^&(classPoints[HL_WARRIOR_CLASS_IND])>=(masterClassRequiredPoints):S(TRUE);
  !!VRi^Master_Mage_Hero%(hero)^&(classPoints[HL_MAGE_CLASS_IND])>=(masterClassRequiredPoints):S(TRUE);
  !!VRi^Master_Adventurer_Hero%(hero)^&(classPoints[HL_ADVENTURER_CLASS_IND])>=(masterClassRequiredPoints):S(TRUE);
  !!VRi^Grandmaster_Warrior_Hero%(hero)^&(classPoints[HL_WARRIOR_CLASS_IND])>=(grandmasterClassRequiredPoints):S(TRUE);
  !!VRi^Grandmaster_Mage_Hero%(hero)^&(classPoints[HL_MAGE_CLASS_IND])>=(grandmasterClassRequiredPoints):S(TRUE);
  !!VRi^Grandmaster_Adventurer_Hero%(hero)^&(classPoints[HL_ADVENTURER_CLASS_IND])>=(grandmasterClassRequiredPoints):S(TRUE);
!!en;

; Return updated class points
!!if&(returnRealPoints)=(FALSE);
  !!VR(warriorPoints):S(classPoints[HL_WARRIOR_CLASS_IND]);
  !!VR(magePoints):S(classPoints[HL_MAGE_CLASS_IND]);
  !!VR(adventurerPoints):S(classPoints[HL_ADVENTURER_CLASS_IND]);
!!en;

; Mark hero as "promoted" if any main class is changed
!!if|i^Master_Warrior_Hero%(hero)^<>(prevWasMasterWarrior)/
     i^Master_Mage_Hero%(hero)^<>(prevWasMasterMage)/
     i^Master_Adventurer_Hero%(hero)^<>(prevWasMasterAdventurer)/
     i^Grandmaster_Warrior_Hero%(hero)^<>(prevWasGrandmasterWarrior)/
     i^Grandmaster_Mage_Hero%(hero)^<>(prevWasGrandmasterMage)/
     i^Grandmaster_Adventurer_Hero%(hero)^<>(prevWasGrandmasterAdventurer);
  !!VRi^acm_promotedClassMark_%(hero)^:S(TRUE);
!!en;

!?FU(Calc_Class_Points_Original);                [Calculate class points function]
*!IF:M^Now runs calc class points fkt %X1 und x2 is %X2^;

!!HEx1:B2/?y2;
!!VRy3:Sy2 %2;
*!VRy10&y3=1:-5;     warrior
*!VRy20&y3=0:-5;     mage
*!VRy30:+10;         adventurer

!!SN:W^Number_Of_Hero_Skills^/0;

!!VRy10:S0; !!VRy20:S0; !!VRy30:S0;

!!HEx1:S0/?y1;                          [Pathfinding]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+7;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Pathfinding_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S1/?y1;                          [Archery]
!!VRy10&y1>0:+7;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Archery_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S2/?y1;                          [Logistics]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Logistics_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S3/?y1;                          [Scouting]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+8;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Scouting_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S4/?y1;                          [Diplomacy]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Diplomacy_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S5/?y1;                          [Nobility]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+7;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Nobility_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S6/?y1;                          [Leadership]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Leadership_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S7/?y1;                          [Wisdom]
!!VRy10&y1>0:+1;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Wisdom_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S8/?y1;                          [Mysticism]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Mysticism_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S9/?y1;                          [Luck]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+4;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Luck_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S10/?y1;                         [Ballistics]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Ballistics_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S11/?y1;                         [Eagle Eye]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Eagle Eye_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S12/?y1;                         [Necromancy]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+4;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1; [Neutral Skills]

!!HEx1:S13/?y1;                         [Estates]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Estates_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S14/?y1;                         [Fire Magic]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Fire Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S15/?y1;                         [Air Magic]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Air Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S16/?y1;                         [Water Magic]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+6;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Water Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S17/?y1;                         [Earth Magic]
!!VRy10&y1>0:+1;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Earth Magic_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S18/?y1;                         [Scholar]
!!VRy10&y1>0:+3;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Scholar_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S19/?y1;                         [Tactics/Warfare]
!!VRy10&y1>0:+7;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Tactics_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S20/?y1;                         [Artillery]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Artillery_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S21/?y1;                         [Learning]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+3;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Learning_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]

!!HEx1:S22/?y1;                         [Offense]
!!VRy10&y1>0:+8;                        [warrior]
!!VRy20&y1>0:+1;                        [mage]
!!VRy30&y1>0:+1;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Offense_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S23/?y1;                         [Armorer]
!!VRy10&y1>0:+7;                        [warrior]
!!VRy20&y1>0:+1;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Armorer_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S24/?y1;                         [Intelligence]
!!VRy10&y1>0:+4;                        [warrior]
!!VRy20&y1>0:+7;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Intelligence_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S25/?y1;                         [Sorcery]
!!VRy10&y1>0:+1;                        [warrior]
!!VRy20&y1>0:+8;                        [mage]
!!VRy30&y1>0:+2;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Sorcery_0_Hero%X1^/?y1; !!VRy20&y1=1:+2; [mage]

!!HEx1:S26/?y1;                         [Resistance]
!!VRy10&y1>0:+6;                        [warrior]
!!VRy20&y1>0:+4;                        [mage]
!!VRy30&y1>0:+3;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_Resistance_0_Hero%X1^/?y1; !!VRy10&y1=1:+2; [warrior]

!!HEx1:S27/?y1;                         [First Aid]
!!VRy10&y1>0:+2;                        [warrior]
!!VRy20&y1>0:+2;                        [mage]
!!VRy30&y1>0:+6;                        [adventurer]
!!SN&y1>0:W^Number_Of_Hero_Skills^/d+1;
!!SN:W^H3_First Aid_0_Hero%X1^/?y1; !!VRy30&y1=1:+2; [adventurer]



***************************************
**Special Hero Starting Conditions**
***************************************

!!VRy10&x1=4:-7; !!VRy30&x1=4:+7;       [Lord Haart Starts with +7 A -7 W Points]
!!VRy10&x1=9:+5; !!VRy30&x1=9:-5;       [Adela Starts with +5 W -5 A Points]

!!VRy10&x1=35:+6; !!VRy20&x1=35:-4;     [Neela +6 W -4 M Point]

!!VRy10&x1=59:+6; !!VRy20&x1=59:-4;     [Olema +6 W -4 M Point]
!!VRy10&x1=61:+6; !!VRy20&x1=61:-4;     [Ash +6 W -4 M Point]

!!VRy10&x1=69:+2; !!VRy20&x1=69:-4; !!VRy30&x1=69:+2; [Isra +2 W -4 M +2 A Point]
!!VRy10&x1=70:+2; !!VRy20&x1=70:-4; !!VRy30&x1=70:+2; [Clavius +2 W -4 M +2 A Point]
!!VRy10&x1=77:+6; !!VRy20&x1=77:-4;     [Xsi +6 W -4 M Point]
!!VRy10&x1=78:+2; !!VRy20&x1=78:-4; !!VRy30&x1=78:+2; [Vidomina +2 W -4 M +2 A Point]
!!VRy10&x1=79:+2; !!VRy20&x1=79:-4; !!VRy30&x1=79:+2; [Nagash +2 W -4 M +2 A Point]

!!VRy10&x1=95:+6; !!VRy20&x1=95:-4;     [Darkstorn +6 W -4 M Point]

!!VRy10&x1=107:+1; !!VRy20&x1=107:+1;   [Terek +1 W +1 M Point]
!!VRy10&x1=108:+1; !!VRy20&x1=108:+1;   [Zubin +1 W +1 M Point]

!!VRy10&x1=120:+6; !!VRy20&x1=120:-4;   [Mirlanda +6 W -4 M Point]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
  !!VRy10&x1=137:+6; !!VRy20&x1=137:-4; [Brissa +6 W -4 M Point]
  !!VRy10&x1=139:+6; !!VRy20&x1=139:-4; [Labetha +6 W -4 M Point]
!!en;

*!VRy30&x1=129:-5;                      [Thunar Starts with -5 A Points]
*!VRy20&x1=129:+5;                      [Thunar Starts with +5 M Points]
*!VRy10&x1=129:-5;                      [Thunar Starts with -5 W Points]
!!SN:W^Easier_Class_option^/?y80;       [If option active you get +5 to all class points between level 20 and 30]
!!if&y80=1;
  !!HEx1:E?y81/?y82/1;
  !!VRy10&y82>=20:+1; !!VRy10&y82>=22:+1; !!VRy10&y82>=25:+1; !!VRy10&y82>=27:+1; !!VRy10&y82>=30:+1;
  !!VRy20&y82>=20:+1; !!VRy20&y82>=22:+1; !!VRy20&y82>=25:+1; !!VRy20&y82>=27:+1; !!VRy20&y82>=30:+1;
  !!VRy30&y82>=20:+1; !!VRy30&y82>=22:+1; !!VRy30&y82>=25:+1; !!VRy30&y82>=27:+1; !!VRy30&y82>=30:+1;
!!en;

!!FU(Count_Set_Pieces_2):Px1/0/0/?y90/?y91/?y92; [Check for class Sets]
!!VRy10&y91=3:+5;                       [+5 Warrior Class Points]
!!VRy20&y90=3:+5;                       [+5 Mage Class Points]
!!VRy30&y92=3:+5;                       [+5 Adventurer Class Points]

!!HEx1:A2/49/?y50/?y51;                 [49 Badge of Courage]
!!VRy10&y51=1:+1;                       [+1 Warrior Class Points]
!!VRy20&y51=1:+1;                       [+1 Mage Class Points]
!!VRy30&y51=1:+1;                       [+1 Adventurer Class Points]
****************************************

!!VRx3:Sy10;
!!VRx4:Sy20;
!!VRx5:Sy30;

!!SN:W^Expert_Level_Global_Value^/?y11;
!!SN:W^Master_Level_Global_Value^/?y21;
!!SN:W^Grandmaster_Level_Global_Value^/?y31; [Check Global Values for Class Here eg to reach Grandmaster or Master]

!!SN&y10<y11:W^Expert_Warrior_Hero%X1^/0;    !!SN&y10<y21:W^Master_Warrior_Hero%X1^/0;    !!SN&y10<y31:W^Grandmaster_Warrior_Hero%X1^/0; [Drop out of Class if Skill is removed and not enough class points]
!!SN&y20<y11:W^Expert_Mage_Hero%X1^/0;       !!SN&y20<y21:W^Master_Mage_Hero%X1^/0;       !!SN&y20<y31:W^Grandmaster_Mage_Hero%X1^/0;
!!SN&y30<y11:W^Expert_Adventurer_Hero%X1^/0; !!SN&y30<y21:W^Master_Adventurer_Hero%X1^/0; !!SN&y30<y31:W^Grandmaster_Adventurer_Hero%X1^/0;

***********************Skill Description Section********************************

!?FU(OnPreHeroScreen);
!!SN:X?y1;
!!FU(acm_RecalcClassPoints):Py1;            [Calculate class points]
!!DO(AC_Function_23)/0/27/1:Py1;        [Call this function to delete Master and Grandmaster Level if Hero no longer knows this skill]
!!DO(AC_Set_SS_Description)/0/27/1:Py1; [Set new Skill descriptions]
!!DO(AC_Set_SS_Names)/0/27/1:Py1;       [Set new Skill names]


!?FU(OnCloseHeroScreen);
!!FU(Set_SS_Skill_Name_and_Text):P;              [Reset Skill Descriptions to show correct name in in Which Huts and Stuff]
!!HE-1:N?(hero:y);                               [Give Advanced Level if enough points when closing Hero Screen]
!!FU(acm_ShowClassPromotionDlgIfMarked):P(hero); [Call Level Up Function]


!$OB63/51;                              [Post visit Trigger Market of Time]
!!HE-1:N?y1;
!!FU(acm_RecalcClassPoints):Py1;            [Call Calculation Function to delete Master/Grandmaster Rank if not enough Class Points]


!?FU(AC_Set_SS_Names);
!!HEx1:Sx16/?y1;

!!if&y1>0;
!!FU(H3_Mod_Check_Skill_Level):Px1/?y2/?y3/x16;

!!FU7701&x16=0/y1=1/y2=0/y3=0:P0/0/0/199200; [B                        [Pathfinding]
!!FU7701&x16=0/y1=2/y2=0/y3=0:P0/0/0/199300; [A]
!!FU7701&x16=0/y1=3/y2=0/y3=0:P0/0/0/199400; [E]
!!FU7701&x16=0/y1=3/y2=1/y3=0:P0/0/0/199500; [M]
!!FU7701&x16=0/y1=3/y2=1/y3=1:P0/0/0/199600; [GM]

!!FU7701&x16=1/y1=1/y2=0/y3=0:P0/1/0/199201; [B                        [Archery]
!!FU7701&x16=1/y1=2/y2=0/y3=0:P0/1/0/199301; [A]
!!FU7701&x16=1/y1=3/y2=0/y3=0:P0/1/0/199401; [E]
!!FU7701&x16=1/y1=3/y2=1/y3=0:P0/1/0/199501; [M]
!!FU7701&x16=1/y1=3/y2=1/y3=1:P0/1/0/199601; [GM]

!!FU7701&x16=2/y1=1/y2=0/y3=0:P0/2/0/199202; [B                        [Logistics]
!!FU7701&x16=2/y1=2/y2=0/y3=0:P0/2/0/199302; [A]
!!FU7701&x16=2/y1=3/y2=0/y3=0:P0/2/0/199402; [E]
!!FU7701&x16=2/y1=3/y2=1/y3=0:P0/2/0/199502; [M]
!!FU7701&x16=2/y1=3/y2=1/y3=1:P0/2/0/199602; [GM]

!!FU7701&x16=3/y1=1/y2=0/y3=0:P0/3/0/199203; [B                        [Scouting]
!!FU7701&x16=3/y1=2/y2=0/y3=0:P0/3/0/199303; [A]
!!FU7701&x16=3/y1=3/y2=0/y3=0:P0/3/0/199403; [E]
!!FU7701&x16=3/y1=3/y2=1/y3=0:P0/3/0/199503; [M]
!!FU7701&x16=3/y1=3/y2=1/y3=1:P0/3/0/199603; [GM]

!!FU7701&x16=4/y1=1/y2=0/y3=0:P0/4/0/199204; [B                        [Diplomacy]
!!FU7701&x16=4/y1=2/y2=0/y3=0:P0/4/0/199304; [A]
!!FU7701&x16=4/y1=3/y2=0/y3=0:P0/4/0/199404; [E]
!!FU7701&x16=4/y1=3/y2=1/y3=0:P0/4/0/199504; [M]
!!FU7701&x16=4/y1=3/y2=1/y3=1:P0/4/0/199604; [GM]

!!FU7701&x16=5/y1=1/y2=0/y3=0:P0/5/0/199205; [B                        [Nobility/Navigation]
!!FU7701&x16=5/y1=2/y2=0/y3=0:P0/5/0/199305; [A]
!!FU7701&x16=5/y1=3/y2=0/y3=0:P0/5/0/199405; [E]
!!FU7701&x16=5/y1=3/y2=1/y3=0:P0/5/0/199505; [M]
!!FU7701&x16=5/y1=3/y2=1/y3=1:P0/5/0/199605; [GM]

!!FU7701&x16=6/y1=1/y2=0/y3=0:P0/6/0/199206; [B                        [Leadership]
!!FU7701&x16=6/y1=2/y2=0/y3=0:P0/6/0/199306; [A]
!!FU7701&x16=6/y1=3/y2=0/y3=0:P0/6/0/199406; [E]
!!FU7701&x16=6/y1=3/y2=1/y3=0:P0/6/0/199506; [M]
!!FU7701&x16=6/y1=3/y2=1/y3=1:P0/6/0/199606; [GM]

!!FU7701&x16=7/y1=1/y2=0/y3=0:P0/7/0/199207; [B                        [Wisdom]
!!FU7701&x16=7/y1=2/y2=0/y3=0:P0/7/0/199307; [A]
!!FU7701&x16=7/y1=3/y2=0/y3=0:P0/7/0/199407; [E]
!!FU7701&x16=7/y1=3/y2=1/y3=0:P0/7/0/199507; [M]
!!FU7701&x16=7/y1=3/y2=1/y3=1:P0/7/0/199607; [GM]

!!FU7701&x16=8/y1=1/y2=0/y3=0:P0/8/0/199208; [B                        [Mysticism]
!!FU7701&x16=8/y1=2/y2=0/y3=0:P0/8/0/199308; [A]
!!FU7701&x16=8/y1=3/y2=0/y3=0:P0/8/0/199408; [E]
!!FU7701&x16=8/y1=3/y2=1/y3=0:P0/8/0/199508; [M]
!!FU7701&x16=8/y1=3/y2=1/y3=1:P0/8/0/199608; [GM]

!!FU7701&x16=9/y1=1/y2=0/y3=0:P0/9/0/199209; [B                        [Luck]
!!FU7701&x16=9/y1=2/y2=0/y3=0:P0/9/0/199309; [A]
!!FU7701&x16=9/y1=3/y2=0/y3=0:P0/9/0/199409; [E]
!!FU7701&x16=9/y1=3/y2=1/y3=0:P0/9/0/199509; [M]
!!FU7701&x16=9/y1=3/y2=1/y3=1:P0/9/0/199609; [GM]

!!FU7701&x16=10/y1=1/y2=0/y3=0:P0/10/0/199210; [B                        [Ballistics]
!!FU7701&x16=10/y1=2/y2=0/y3=0:P0/10/0/199310; [A]
!!FU7701&x16=10/y1=3/y2=0/y3=0:P0/10/0/199410; [E]
!!FU7701&x16=10/y1=3/y2=1/y3=0:P0/10/0/199510; [M]
!!FU7701&x16=10/y1=3/y2=1/y3=1:P0/10/0/199610; [GM]

!!FU7701&x16=11/y1=1/y2=0/y3=0:P0/11/0/199211; [B                        [Eagle Eye]
!!FU7701&x16=11/y1=2/y2=0/y3=0:P0/11/0/199311; [A]
!!FU7701&x16=11/y1=3/y2=0/y3=0:P0/11/0/199411; [E]
!!FU7701&x16=11/y1=3/y2=1/y3=0:P0/11/0/199511; [M]
!!FU7701&x16=11/y1=3/y2=1/y3=1:P0/11/0/199611; [GM]

!!FU7701&x16=12/y1=1/y2=0/y3=0:P0/12/0/199212; [B                        [Necromancy]
!!FU7701&x16=12/y1=2/y2=0/y3=0:P0/12/0/199312; [A]
!!FU7701&x16=12/y1=3/y2=0/y3=0:P0/12/0/199412; [E]
!!FU7701&x16=12/y1=3/y2=1/y3=0:P0/12/0/199512; [M]
!!FU7701&x16=12/y1=3/y2=1/y3=1:P0/12/0/199612; [GM]

!!FU7701&x16=13/y1=1/y2=0/y3=0:P0/13/0/199213; [B                        [Estates]
!!FU7701&x16=13/y1=2/y2=0/y3=0:P0/13/0/199313; [A]
!!FU7701&x16=13/y1=3/y2=0/y3=0:P0/13/0/199413; [E]
!!FU7701&x16=13/y1=3/y2=1/y3=0:P0/13/0/199513; [M]
!!FU7701&x16=13/y1=3/y2=1/y3=1:P0/13/0/199613; [GM]

!!FU7701&x16=14/y1=1/y2=0/y3=0:P0/14/0/199214; [B                        [Fire Magic]
!!FU7701&x16=14/y1=2/y2=0/y3=0:P0/14/0/199314; [A]
!!FU7701&x16=14/y1=3/y2=0/y3=0:P0/14/0/199414; [E]
!!FU7701&x16=14/y1=3/y2=1/y3=0:P0/14/0/199514; [M]
!!FU7701&x16=14/y1=3/y2=1/y3=1:P0/14/0/199614; [GM]

!!FU7701&x16=15/y1=1/y2=0/y3=0:P0/15/0/199215; [B                        [Air Magic]
!!FU7701&x16=15/y1=2/y2=0/y3=0:P0/15/0/199315; [A]
!!FU7701&x16=15/y1=3/y2=0/y3=0:P0/15/0/199415; [E]
!!FU7701&x16=15/y1=3/y2=1/y3=0:P0/15/0/199515; [M]
!!FU7701&x16=15/y1=3/y2=1/y3=1:P0/15/0/199615; [GM]

!!FU7701&x16=16/y1=1/y2=0/y3=0:P0/16/0/199216; [B                        [Water Magic]
!!FU7701&x16=16/y1=2/y2=0/y3=0:P0/16/0/199316; [A]
!!FU7701&x16=16/y1=3/y2=0/y3=0:P0/16/0/199416; [E]
!!FU7701&x16=16/y1=3/y2=1/y3=0:P0/16/0/199516; [M]
!!FU7701&x16=16/y1=3/y2=1/y3=1:P0/16/0/199616; [GM]

!!FU7701&x16=17/y1=1/y2=0/y3=0:P0/17/0/199217; [B                        [Earth Magic]
!!FU7701&x16=17/y1=2/y2=0/y3=0:P0/17/0/199317; [A]
!!FU7701&x16=17/y1=3/y2=0/y3=0:P0/17/0/199417; [E]
!!FU7701&x16=17/y1=3/y2=1/y3=0:P0/17/0/199517; [M]
!!FU7701&x16=17/y1=3/y2=1/y3=1:P0/17/0/199617; [GM]

!!FU7701&x16=18/y1=1/y2=0/y3=0:P0/18/0/199218; [B                        [Scholar]
!!FU7701&x16=18/y1=2/y2=0/y3=0:P0/18/0/199318; [A]
!!FU7701&x16=18/y1=3/y2=0/y3=0:P0/18/0/199418; [E]
!!FU7701&x16=18/y1=3/y2=1/y3=0:P0/18/0/199518; [M]
!!FU7701&x16=18/y1=3/y2=1/y3=1:P0/18/0/199618; [GM]

!!FU7701&x16=19/y1=1/y2=0/y3=0:P0/19/0/199219; [B                        [Warfare]
!!FU7701&x16=19/y1=2/y2=0/y3=0:P0/19/0/199319; [A]
!!FU7701&x16=19/y1=3/y2=0/y3=0:P0/19/0/199419; [E]
!!FU7701&x16=19/y1=3/y2=1/y3=0:P0/19/0/199519; [M]
!!FU7701&x16=19/y1=3/y2=1/y3=1:P0/19/0/199619; [GM]

!!FU7701&x16=20/y1=1/y2=0/y3=0:P0/20/0/199220; [B                        [Artillery]
!!FU7701&x16=20/y1=2/y2=0/y3=0:P0/20/0/199320; [A]
!!FU7701&x16=20/y1=3/y2=0/y3=0:P0/20/0/199420; [E]
!!FU7701&x16=20/y1=3/y2=1/y3=0:P0/20/0/199520; [M]
!!FU7701&x16=20/y1=3/y2=1/y3=1:P0/20/0/199620; [GM]

!!FU7701&x16=21/y1=1/y2=0/y3=0:P0/21/0/199221; [B                        [Learning]
!!FU7701&x16=21/y1=2/y2=0/y3=0:P0/21/0/199321; [A]
!!FU7701&x16=21/y1=3/y2=0/y3=0:P0/21/0/199421; [E]
!!FU7701&x16=21/y1=3/y2=1/y3=0:P0/21/0/199521; [M]
!!FU7701&x16=21/y1=3/y2=1/y3=1:P0/21/0/199621; [GM]

!!FU7701&x16=22/y1=1/y2=0/y3=0:P0/22/0/199222; [B                        [Offense]
!!FU7701&x16=22/y1=2/y2=0/y3=0:P0/22/0/199322; [A]
!!FU7701&x16=22/y1=3/y2=0/y3=0:P0/22/0/199422; [E]
!!FU7701&x16=22/y1=3/y2=1/y3=0:P0/22/0/199522; [M]
!!FU7701&x16=22/y1=3/y2=1/y3=1:P0/22/0/199622; [GM]

!!FU7701&x16=23/y1=1/y2=0/y3=0:P0/23/0/199223; [B                        [Armorer]
!!FU7701&x16=23/y1=2/y2=0/y3=0:P0/23/0/199323; [A]
!!FU7701&x16=23/y1=3/y2=0/y3=0:P0/23/0/199423; [E]
!!FU7701&x16=23/y1=3/y2=1/y3=0:P0/23/0/199523; [M]
!!FU7701&x16=23/y1=3/y2=1/y3=1:P0/23/0/199623; [GM]

!!FU7701&x16=24/y1=1/y2=0/y3=0:P0/24/0/199224; [B                        [Intelligence]
!!FU7701&x16=24/y1=2/y2=0/y3=0:P0/24/0/199324; [A]
!!FU7701&x16=24/y1=3/y2=0/y3=0:P0/24/0/199424; [E]
!!FU7701&x16=24/y1=3/y2=1/y3=0:P0/24/0/199524; [M]
!!FU7701&x16=24/y1=3/y2=1/y3=1:P0/24/0/199624; [GM]

!!FU7701&x16=25/y1=1/y2=0/y3=0:P0/25/0/199225; [B                        [Sorcery]
!!FU7701&x16=25/y1=2/y2=0/y3=0:P0/25/0/199325; [A]
!!FU7701&x16=25/y1=3/y2=0/y3=0:P0/25/0/199425; [E]
!!FU7701&x16=25/y1=3/y2=1/y3=0:P0/25/0/199525; [M]
!!FU7701&x16=25/y1=3/y2=1/y3=1:P0/25/0/199625; [GM]

!!FU7701&x16=26/y1=1/y2=0/y3=0:P0/26/0/199226; [B                        [Resistance]
!!FU7701&x16=26/y1=2/y2=0/y3=0:P0/26/0/199326; [A]
!!FU7701&x16=26/y1=3/y2=0/y3=0:P0/26/0/199426; [E]
!!FU7701&x16=26/y1=3/y2=1/y3=0:P0/26/0/199526; [M]
!!FU7701&x16=26/y1=3/y2=1/y3=1:P0/26/0/199626; [GM]

!!FU7701&x16=27/y1=1/y2=0/y3=0:P0/27/0/199227; [B                        [First Aid]
!!FU7701&x16=27/y1=2/y2=0/y3=0:P0/27/0/199327; [A]
!!FU7701&x16=27/y1=3/y2=0/y3=0:P0/27/0/199427; [E]
!!FU7701&x16=27/y1=3/y2=1/y3=0:P0/27/0/199527; [M]
!!FU7701&x16=27/y1=3/y2=1/y3=1:P0/27/0/199627; [GM]
!!en;


********************************************************************************
!?FU(H3_Mod_Check_Skill_Level);
x1 - hero id, x2 - return master rank, x3 - return GM rank, x4 - skill id
!!VRx2:S0; !!VRx3:S0;
!!SN&x4=0:W^H3_Pathfinding_0_Hero%X1^/?y1;
!!SN&x4=0:W^H3_Pathfinding_1_Hero%X1^/?y2;
!!SN&x4=1:W^H3_Archery_0_Hero%X1^/?y1;
!!SN&x4=1:W^H3_Archery_1_Hero%X1^/?y2;
!!SN&x4=2:W^H3_Logistics_0_Hero%X1^/?y1;
!!SN&x4=2:W^H3_Logistics_1_Hero%X1^/?y2;
!!SN&x4=3:W^H3_Scouting_0_Hero%X1^/?y1;
!!SN&x4=3:W^H3_Scouting_1_Hero%X1^/?y2;
!!SN&x4=4:W^H3_Diplomacy_0_Hero%X1^/?y1;
!!SN&x4=4:W^H3_Diplomacy_1_Hero%X1^/?y2;
!!SN&x4=5:W^H3_Nobility_0_Hero%X1^/?y1;
!!SN&x4=5:W^H3_Nobility_1_Hero%X1^/?y2;
!!SN&x4=6:W^H3_Leadership_0_Hero%X1^/?y1;
!!SN&x4=6:W^H3_Leadership_1_Hero%X1^/?y2;
!!SN&x4=7:W^H3_Wisdom_0_Hero%X1^/?y1;
!!SN&x4=7:W^H3_Wisdom_1_Hero%X1^/?y2;
!!SN&x4=8:W^H3_Mysticism_0_Hero%X1^/?y1;
!!SN&x4=8:W^H3_Mysticism_1_Hero%X1^/?y2;
!!SN&x4=9:W^H3_Luck_0_Hero%X1^/?y1;
!!SN&x4=9:W^H3_Luck_1_Hero%X1^/?y2;
!!SN&x4=10:W^H3_Ballistics_0_Hero%X1^/?y1;
!!SN&x4=10:W^H3_Ballistics_1_Hero%X1^/?y2;
!!SN&x4=11:W^H3_Eagle Eye_0_Hero%X1^/?y1;
!!SN&x4=11:W^H3_Eagle Eye_1_Hero%X1^/?y2;
!!SN&x4=12:W^H3_Necromancy_0_Hero%X1^/?y1;
!!SN&x4=12:W^H3_Necromancy_1_Hero%X1^/?y2;
!!SN&x4=13:W^H3_Estates_0_Hero%X1^/?y1;
!!SN&x4=13:W^H3_Estates_1_Hero%X1^/?y2;
!!SN&x4=14:W^H3_Fire Magic_0_Hero%X1^/?y1;
!!SN&x4=14:W^H3_Fire Magic_1_Hero%X1^/?y2;
!!SN&x4=15:W^H3_Air Magic_0_Hero%X1^/?y1;
!!SN&x4=15:W^H3_Air Magic_1_Hero%X1^/?y2;
!!SN&x4=16:W^H3_Water Magic_0_Hero%X1^/?y1;
!!SN&x4=16:W^H3_Water Magic_1_Hero%X1^/?y2;
!!SN&x4=17:W^H3_Earth Magic_0_Hero%X1^/?y1;
!!SN&x4=17:W^H3_Earth Magic_1_Hero%X1^/?y2;
!!SN&x4=18:W^H3_Scholar_0_Hero%X1^/?y1;
!!SN&x4=18:W^H3_Scholar_1_Hero%X1^/?y2;
!!SN&x4=19:W^H3_Tactics_0_Hero%X1^/?y1;
!!SN&x4=19:W^H3_Tactics_1_Hero%X1^/?y2;
!!SN&x4=20:W^H3_Artillery_0_Hero%X1^/?y1;
!!SN&x4=20:W^H3_Artillery_1_Hero%X1^/?y2;
!!SN&x4=21:W^H3_Learning_0_Hero%X1^/?y1;
!!SN&x4=21:W^H3_Learning_1_Hero%X1^/?y2;
!!SN&x4=22:W^H3_Offense_0_Hero%X1^/?y1;
!!SN&x4=22:W^H3_Offense_1_Hero%X1^/?y2;
!!SN&x4=23:W^H3_Armorer_0_Hero%X1^/?y1;
!!SN&x4=23:W^H3_Armorer_1_Hero%X1^/?y2;
!!SN&x4=24:W^H3_Intelligence_0_Hero%X1^/?y1;
!!SN&x4=24:W^H3_Intelligence_1_Hero%X1^/?y2;
!!SN&x4=25:W^H3_Sorcery_0_Hero%X1^/?y1;
!!SN&x4=25:W^H3_Sorcery_1_Hero%X1^/?y2;
!!SN&x4=26:W^H3_Resistance_0_Hero%X1^/?y1;
!!SN&x4=26:W^H3_Resistance_1_Hero%X1^/?y2;
!!SN&x4=27:W^H3_First Aid_0_Hero%X1^/?y1;
!!SN&x4=27:W^H3_First Aid_1_Hero%X1^/?y2;

!!VRx2&y1=1:S1;                         [Master Yes]
!!VRx3&y2=1:S1;                         [Grandmaster Yes]

!?FU(H3_Mod_Set_Skill_ExtraLevel);
x1 - hero id, x2 - master rank, x3 - GM rank, x4 - skill id
!!SN&x4=0:W^H3_Pathfinding_0_Hero%X1^/x2;
!!SN&x4=0:W^H3_Pathfinding_1_Hero%X1^/x3;
!!SN&x4=1:W^H3_Archery_0_Hero%X1^/x2;
!!SN&x4=1:W^H3_Archery_1_Hero%X1^/x3;
!!SN&x4=2:W^H3_Logistics_0_Hero%X1^/x2;
!!SN&x4=2:W^H3_Logistics_1_Hero%X1^/x3;
!!SN&x4=3:W^H3_Scouting_0_Hero%X1^/x2;
!!SN&x4=3:W^H3_Scouting_1_Hero%X1^/x3;
!!SN&x4=4:W^H3_Diplomacy_0_Hero%X1^/x2;
!!SN&x4=4:W^H3_Diplomacy_1_Hero%X1^/x3;
!!SN&x4=5:W^H3_Nobility_0_Hero%X1^/x2;
!!SN&x4=5:W^H3_Nobility_1_Hero%X1^/x3;
!!SN&x4=6:W^H3_Leadership_0_Hero%X1^/x2;
!!SN&x4=6:W^H3_Leadership_1_Hero%X1^/x3;
!!SN&x4=7:W^H3_Wisdom_0_Hero%X1^/x2;
!!SN&x4=7:W^H3_Wisdom_1_Hero%X1^/x3;
!!SN&x4=8:W^H3_Mysticism_0_Hero%X1^/x2;
!!SN&x4=8:W^H3_Mysticism_1_Hero%X1^/x3;
!!SN&x4=9:W^H3_Luck_0_Hero%X1^/x2;
!!SN&x4=9:W^H3_Luck_1_Hero%X1^/x3;
!!SN&x4=10:W^H3_Ballistics_0_Hero%X1^/x2;
!!SN&x4=10:W^H3_Ballistics_1_Hero%X1^/x3;
!!SN&x4=11:W^H3_Eagle Eye_0_Hero%X1^/x2;
!!SN&x4=11:W^H3_Eagle Eye_1_Hero%X1^/x3;
!!SN&x4=12:W^H3_Necromancy_0_Hero%X1^/x2;
!!SN&x4=12:W^H3_Necromancy_1_Hero%X1^/x3;
!!SN&x4=13:W^H3_Estates_0_Hero%X1^/x2;
!!SN&x4=13:W^H3_Estates_1_Hero%X1^/x3;
!!SN&x4=14:W^H3_Fire Magic_0_Hero%X1^/x2;
!!SN&x4=14:W^H3_Fire Magic_1_Hero%X1^/x3;
!!SN&x4=15:W^H3_Air Magic_0_Hero%X1^/x2;
!!SN&x4=15:W^H3_Air Magic_1_Hero%X1^/x3;
!!SN&x4=16:W^H3_Water Magic_0_Hero%X1^/x2;
!!SN&x4=16:W^H3_Water Magic_1_Hero%X1^/x3;
!!SN&x4=17:W^H3_Earth Magic_0_Hero%X1^/x2;
!!SN&x4=17:W^H3_Earth Magic_1_Hero%X1^/x3;
!!SN&x4=18:W^H3_Scholar_0_Hero%X1^/x2;
!!SN&x4=18:W^H3_Scholar_1_Hero%X1^/x3;
!!SN&x4=19:W^H3_Tactics_0_Hero%X1^/x2;
!!SN&x4=19:W^H3_Tactics_1_Hero%X1^/x3;
!!SN&x4=20:W^H3_Artillery_0_Hero%X1^/x2;
!!SN&x4=20:W^H3_Artillery_1_Hero%X1^/x3;
!!SN&x4=21:W^H3_Learning_0_Hero%X1^/x2;
!!SN&x4=21:W^H3_Learning_1_Hero%X1^/x3;
!!SN&x4=22:W^H3_Offense_0_Hero%X1^/x2;
!!SN&x4=22:W^H3_Offense_1_Hero%X1^/x3;
!!SN&x4=23:W^H3_Armorer_0_Hero%X1^/x2;
!!SN&x4=23:W^H3_Armorer_1_Hero%X1^/x3;
!!SN&x4=24:W^H3_Intelligence_0_Hero%X1^/x2;
!!SN&x4=24:W^H3_Intelligence_1_Hero%X1^/x3;
!!SN&x4=25:W^H3_Sorcery_0_Hero%X1^/x2;
!!SN&x4=25:W^H3_Sorcery_1_Hero%X1^/x3;
!!SN&x4=26:W^H3_Resistance_0_Hero%X1^/x2;
!!SN&x4=26:W^H3_Resistance_1_Hero%X1^/x3;
!!SN&x4=27:W^H3_First Aid_0_Hero%X1^/x2;
!!SN&x4=27:W^H3_First Aid_1_Hero%X1^/x3;

********************************************************************************
!?FU(AC_Set_SS_Description);
!!HEx1:Sx16/?y1;

!!if&y1>0;
!!FU(H3_Mod_Check_Skill_Level):Px1/?y2/?y3/x16;

!!FU7701&x16=0/y1=3:P0/0/3/189502;      [Pathfinding]
!!FU7701&x16=0/y1=3/y2=1/y3=0:P0/0/3/189701;
!!FU7701&x16=0/y1=3/y3=1/y2=1:P0/0/3/189702;

!!FU7701&x16=1/y1=3:P0/1/3/189505;      [Archery]
!!FU7701&x16=1/y1=3/y2=1/y3=0:P0/1/3/189704;
!!FU7701&x16=1/y1=3/y3=1/y2=1:P0/1/3/189705;

!!FU7701&x16=2/y1=3:P0/2/3/189508;      [Logistics]
!!FU7701&x16=2/y1=3/y2=1/y3=0:P0/2/3/189707;
!!FU7701&x16=2/y1=3/y3=1/y2=1:P0/2/3/189708;

!!FU7701&x16=3/y1=3:P0/3/3/189511;      [Scouting]
!!FU7701&x16=3/y1=3/y2=1/y3=0:P0/3/3/189710;
!!FU7701&x16=3/y1=3/y3=1/y2=1:P0/3/3/189711;

!!FU7701&x16=4/y1=3:P0/4/3/189514;      [Diplomacy]
!!FU7701&x16=4/y1=3/y2=1/y3=0:P0/4/3/189713;
!!FU7701&x16=4/y1=3/y3=1/y2=1:P0/4/3/189714;

!!FU7701&x16=5/y1=3:P0/5/3/189517;      [Nobility]
!!FU7701&x16=5/y1=3/y2=1/y3=0:P0/5/3/189716;
!!FU7701&x16=5/y1=3/y3=1/y2=1:P0/5/3/189717;

!!FU7701&x16=6/y1=3:P0/6/3/189520;      [Leadership]
!!FU7701&x16=6/y1=3/y2=1/y3=0:P0/6/3/189719;
!!FU7701&x16=6/y1=3/y3=1/y2=1:P0/6/3/189720;

!!FU7701&x16=7/y1=3:P0/7/3/189523;      [Wisdom]
!!FU7701&x16=7/y1=3/y2=1/y3=0:P0/7/3/189722;
!!FU7701&x16=7/y1=3/y3=1/y2=1:P0/7/3/189723;

!!FU7701&x16=8/y1=3:P0/8/3/189526;      [Mysticism]
!!FU7701&x16=8/y1=3/y2=1/y3=0:P0/8/3/189725;
!!FU7701&x16=8/y1=3/y3=1/y2=1:P0/8/3/189726;

!!FU7701&x16=9/y1=3:P0/9/3/189529;      [Luck]
!!FU7701&x16=9/y1=3/y2=1/y3=0:P0/9/3/189728;
!!FU7701&x16=9/y1=3/y3=1/y2=1:P0/9/3/189729;

!!FU7701&x16=10/y1=3:P0/10/3/189532;    [Ballistics]
!!FU7701&x16=10/y1=3/y2=1/y3=0:P0/10/3/189731;
!!FU7701&x16=10/y1=3/y3=1/y2=1:P0/10/3/189732;

!!FU7701&x16=11/y1=3:P0/11/3/189535;    [Eagle Eye]
!!FU7701&x16=11/y1=3/y2=1/y3=0:P0/11/3/189734;
!!FU7701&x16=11/y1=3/y3=1/y2=1:P0/11/3/189735;

!!FU7701&x16=12/y1=3:P0/12/3/189538;    [Necromancy]
!!FU7701&x16=12/y1=3/y2=1/y3=0:P0/12/3/189737;
!!FU7701&x16=12/y1=3/y3=1/y2=1:P0/12/3/189738;

!!FU7701&x16=13/y1=3:P0/13/3/189541;    [Estates]
!!FU7701&x16=13/y1=3/y2=1/y3=0:P0/13/3/189740;
!!FU7701&x16=13/y1=3/y3=1/y2=1:P0/13/3/189741;

!!FU7701&x16=14/y1=3:P0/14/3/189544;    [Fire Magic]
!!FU7701&x16=14/y1=3/y2=1/y3=0:P0/14/3/189743;
!!FU7701&x16=14/y1=3/y3=1/y2=1:P0/14/3/189744;

!!FU7701&x16=15/y1=3:P0/15/3/189547;    [Air Magic]
!!FU7701&x16=15/y1=3/y2=1/y3=0:P0/15/3/189746;
!!FU7701&x16=15/y1=3/y3=1/y2=1:P0/15/3/189747;

!!FU7701&x16=16/y1=3:P0/16/3/189550;    [Water Magic]
!!FU7701&x16=16/y1=3/y2=1/y3=0:P0/16/3/189749;
!!FU7701&x16=16/y1=3/y3=1/y2=1:P0/16/3/189750;

!!FU7701&x16=17/y1=3:P0/17/3/189553;    [Earth Magic]
!!FU7701&x16=17/y1=3/y2=1/y3=0:P0/17/3/189752;
!!FU7701&x16=17/y1=3/y3=1/y2=1:P0/17/3/189753;

!!FU7701&x16=18/y1=3:P0/18/3/189556;    [Scholar]
!!FU7701&x16=18/y1=3/y2=1/y3=0:P0/18/3/189755;
!!FU7701&x16=18/y1=3/y3=1/y2=1:P0/18/3/189756;

!!FU7701&x16=19/y1=3:P0/19/3/189559;    [Tactics]
!!FU7701&x16=19/y1=3/y2=1/y3=0:P0/19/3/189758;
!!FU7701&x16=19/y1=3/y3=1/y2=1:P0/19/3/189759;

!!FU7701&x16=20/y1=3:P0/20/3/189562;    [Artillery]
!!FU7701&x16=20/y1=3/y2=1/y3=0:P0/20/3/189761;
!!FU7701&x16=20/y1=3/y3=1/y2=1:P0/20/3/189762;

!!FU7701&x16=21/y1=3:P0/21/3/189565;    [Learning]
!!FU7701&x16=21/y1=3/y2=1/y3=0:P0/21/3/189764;
!!FU7701&x16=21/y1=3/y3=1/y2=1:P0/21/3/189765;

!!FU7701&x16=22/y1=3:P0/22/3/189568;    [Offense]
!!FU7701&x16=22/y1=3/y2=1/y3=0:P0/22/3/189767;
!!FU7701&x16=22/y1=3/y3=1/y2=1:P0/22/3/189768;

!!FU7701&x16=23/y1=3:P0/23/3/189571;    [Armorer]
!!FU7701&x16=23/y1=3/y2=1/y3=0:P0/23/3/189770;
!!FU7701&x16=23/y1=3/y3=1/y2=1:P0/23/3/189771;

*!IF&x16=24:M^Skill Loop %Y2 and %Y3 and y1 %Y1^;
!!FU7701&x16=24/y1=3:P0/24/3/189574;    [Intelligence]
!!FU7701&x16=24/y1=3/y2=1/y3=0:P0/24/3/189773;
!!FU7701&x16=24/y1=3/y3=1/y2=1:P0/24/3/189774;

!!FU7701&x16=25/y1=3:P0/25/3/189577;    [Sorcery]
!!FU7701&x16=25/y1=3/y2=1/y3=0:P0/25/3/189776;
!!FU7701&x16=25/y1=3/y3=1/y2=1:P0/25/3/189777;

!!FU7701&x16=26/y1=3:P0/26/3/189580;    [Resistance]
!!FU7701&x16=26/y1=3/y2=1/y3=0:P0/26/3/189779;
!!FU7701&x16=26/y1=3/y3=1/y2=1:P0/26/3/189780;

!!FU7701&x16=27/y1=3:P0/27/3/189583;    [First Aid]
!!FU7701&x16=27/y1=3/y2=1/y3=0:P0/27/3/189784;
!!FU7701&x16=27/y1=3/y3=1/y2=1:P0/27/3/189785;
!!en;
********************************************************************************
!?FU(H3_Mod_Skill_Loop10);
!!VRx16:Sx2;
!!HEx1:Sx16/?y1;

!!if&y1>0;
!!FU(H3_Mod_Check_Skill_Level):Px1/?y2/?y3/x16;

!!FU7701&x16=0/y1=3/y2=0/y3=0:P0/0/3/189701; [Pathfinding]
!!FU7701&x16=0/y1=3/y2=1/y3=0:P0/0/3/189702;

!!FU7701&x16=1/y1=3/y2=0/y3=0:P0/1/3/189704; [Archery]
!!FU7701&x16=1/y1=3/y2=1/y3=0:P0/1/3/189705;

!!FU7701&x16=2/y1=3/y2=0/y3=0:P0/2/3/189707; [Logistics]
!!FU7701&x16=2/y1=3/y2=1/y3=0:P0/2/3/189708;

!!FU7701&x16=3/y1=3/y2=0/y3=0:P0/3/3/189710; [Scouting]
!!FU7701&x16=3/y1=3/y2=1/y3=0:P0/3/3/189711;

!!FU7701&x16=4/y1=3/y2=0/y3=0:P0/4/3/189713; [Diplomacy]
!!FU7701&x16=4/y1=3/y2=1/y3=0:P0/4/3/189714;

!!FU7701&x16=5/y1=3/y2=0/y3=0:P0/5/3/189716; [Nobility]
!!FU7701&x16=5/y1=3/y2=1/y3=0:P0/5/3/189717;

!!FU7701&x16=6/y1=3/y2=0/y3=0:P0/6/3/189719; [Leadership]
!!FU7701&x16=6/y1=3/y2=1/y3=0:P0/6/3/189720;

!!FU7701&x16=7/y1=3/y2=0/y3=0:P0/7/3/189722; [Wisdom]
!!FU7701&x16=7/y1=3/y2=1/y3=0:P0/7/3/189723;

!!FU7701&x16=8/y1=3/y2=0/y3=0:P0/8/3/189725; [Mysticism]
!!FU7701&x16=8/y1=3/y2=1/y3=0:P0/8/3/189726;

!!FU7701&x16=9/y1=3/y2=0/y3=0:P0/9/3/189728; [Luck]
!!FU7701&x16=9/y1=3/y2=1/y3=0:P0/9/3/189729;

!!FU7701&x16=10/y1=3/y2=0/y3=0:P0/10/3/189731; [Ballistics]
!!FU7701&x16=10/y1=3/y2=1/y3=0:P0/10/3/189732;

!!FU7701&x16=11/y1=3/y2=0/y3=0:P0/11/3/189734; [Eagle Eye]
!!FU7701&x16=11/y1=3/y2=1/y3=0:P0/11/3/189735;

!!FU7701&x16=12/y1=3/y2=0/y3=0:P0/12/3/189737; [Necromancy]
!!FU7701&x16=12/y1=3/y2=1/y3=0:P0/12/3/189738;

!!FU7701&x16=13/y1=3/y2=0/y3=0:P0/13/3/189740; [Estates]
!!FU7701&x16=13/y1=3/y2=1/y3=0:P0/13/3/189741;

!!FU7701&x16=14/y1=3/y2=0/y3=0:P0/14/3/189743; [Fire Magic]
!!FU7701&x16=14/y1=3/y2=1/y3=0:P0/14/3/189744;

!!FU7701&x16=15/y1=3/y2=0/y3=0:P0/15/3/189746; [Air Magic]
!!FU7701&x16=15/y1=3/y2=1/y3=0:P0/15/3/189747;

!!FU7701&x16=16/y1=3/y2=0/y3=0:P0/16/3/189749; [Water Magic]
!!FU7701&x16=16/y1=3/y2=1/y3=0:P0/16/3/189750;

!!FU7701&x16=17/y1=3/y2=0/y3=0:P0/17/3/189752; [Earth Magic]
!!FU7701&x16=17/y1=3/y2=1/y3=0:P0/17/3/189753;

!!FU7701&x16=18/y1=3/y2=0/y3=0:P0/18/3/189755; [Scholar]
!!FU7701&x16=18/y1=3/y2=1/y3=0:P0/18/3/189756;

!!FU7701&x16=19/y1=3/y2=0/y3=0:P0/19/3/189758; [Tactics]
!!FU7701&x16=19/y1=3/y2=1/y3=0:P0/19/3/189759;

!!FU7701&x16=20/y1=3/y2=0/y3=0:P0/20/3/189761; [Artillery]
!!FU7701&x16=20/y1=3/y2=1/y3=0:P0/20/3/189762;

!!FU7701&x16=21/y1=3/y2=0/y3=0:P0/21/3/189764; [Learning]
!!FU7701&x16=21/y1=3/y2=1/y3=0:P0/21/3/189765;

!!FU7701&x16=22/y1=3/y2=0/y3=0:P0/22/3/189767; [Offense]
!!FU7701&x16=22/y1=3/y2=1/y3=0:P0/22/3/189768;

!!FU7701&x16=23/y1=3/y2=0/y3=0:P0/23/3/189770; [Armorer]
!!FU7701&x16=23/y1=3/y2=1/y3=0:P0/23/3/189771;

!!FU7701&x16=24/y1=3/y2=0/y3=0:P0/24/3/189773; [Intelligence]
!!FU7701&x16=24/y1=3/y2=1/y3=0:P0/24/3/189774;

!!FU7701&x16=25/y1=3/y2=0/y3=0:P0/25/3/189776; [Sorcery]
!!FU7701&x16=25/y1=3/y2=1/y3=0:P0/25/3/189777;

!!FU7701&x16=26/y1=3/y2=0/y3=0:P0/26/3/189779; [Resistance]
!!FU7701&x16=26/y1=3/y2=1/y3=0:P0/26/3/189780;

!!FU7701&x16=27/y1=3/y2=0/y3=0:P0/27/3/189784; [First Aid]
!!FU7701&x16=27/y1=3/y2=1/y3=0:P0/27/3/189785;
!!en;


********************************************************************************
!?FU(Set_SS_Skill_Name_and_Text);       [At gamestart]

!!FU7701:P0/0/1/189500;                 [Pathfinding]
!!FU7701:P0/0/2/189501;
!!FU7701:P0/0/3/189502;

!!FU7701:P0/1/1/189503;                 [Archery]
!!FU7701:P0/1/2/189504;
!!FU7701:P0/1/3/189505;

!!FU7701:P0/2/1/189506;                 [Logistics]
!!FU7701:P0/2/2/189507;
!!FU7701:P0/2/3/189508;

!!FU7701:P0/3/1/189509;                 [Scouting]
!!FU7701:P0/3/2/189510;
!!FU7701:P0/3/3/189511;

!!FU7701:P0/4/1/189512;                 [Diplomacy]
!!FU7701:P0/4/2/189513;
!!FU7701:P0/4/3/189514;

!!FU7701:P0/5/1/189515;                 [Nobility]
!!FU7701:P0/5/2/189516;
!!FU7701:P0/5/3/189517;

!!FU7701:P0/6/1/189518;                 [Leadership]
!!FU7701:P0/6/2/189519;
!!FU7701:P0/6/3/189520;

!!FU7701:P0/7/1/189521;                 [Wisdom]
!!FU7701:P0/7/2/189522;
!!FU7701:P0/7/3/189523;

!!FU7701:P0/8/1/189524;                 [Mysticism]
!!FU7701:P0/8/2/189525;
!!FU7701:P0/8/3/189526;

!!FU7701:P0/9/1/189527;                 [Luck]
!!FU7701:P0/9/2/189528;
!!FU7701:P0/9/3/189529;

!!FU7701:P0/10/1/189530;                [Ballistics]
!!FU7701:P0/10/2/189531;
!!FU7701:P0/10/3/189532;

!!FU7701:P0/11/1/189533;                [Eagle Eye]
!!FU7701:P0/11/2/189534;
!!FU7701:P0/11/3/189535;

!!FU7701:P0/12/1/189536;                [Necromancy]
!!FU7701:P0/12/2/189537;
!!FU7701:P0/12/3/189538;

!!FU7701:P0/13/1/189539;                [Estates]
!!FU7701:P0/13/2/189540;
!!FU7701:P0/13/3/189541;

!!FU7701:P0/14/1/189542;                [Fire Magic]
!!FU7701:P0/14/2/189543;
!!FU7701:P0/14/3/189544;

!!FU7701:P0/15/1/189545;                [Air Magic]
!!FU7701:P0/15/2/189546;
!!FU7701:P0/15/3/189547;

!!FU7701:P0/16/1/189548;                [Water Magic]
!!FU7701:P0/16/2/189549;
!!FU7701:P0/16/3/189550;

!!FU7701:P0/17/1/189551;                [Earth Magic]
!!FU7701:P0/17/2/189552;
!!FU7701:P0/17/3/189553;

!!FU7701:P0/18/1/189554;                [Scholar]
!!FU7701:P0/18/2/189555;
!!FU7701:P0/18/3/189556;

!!FU7701:P0/19/1/189557;                [Tactics]
!!FU7701:P0/19/2/189558;
!!FU7701:P0/19/3/189559;

!!FU7701:P0/20/1/189560;                [Artillery]
!!FU7701:P0/20/2/189561;
!!FU7701:P0/20/3/189562;

!!FU7701:P0/21/1/189563;                [Learning]
!!FU7701:P0/21/2/189564;
!!FU7701:P0/21/3/189565;

!!FU7701:P0/22/1/189566;                [Offense]
!!FU7701:P0/22/2/189567;
!!FU7701:P0/22/3/189568;

!!FU7701:P0/23/1/189569;                [Armorer]
!!FU7701:P0/23/2/189570;
!!FU7701:P0/23/3/189571;

!!FU7701:P0/24/1/189572;                [Intelligence]
!!FU7701:P0/24/2/189573;
!!FU7701:P0/24/3/189574;

!!FU7701:P0/25/1/189575;                [Sorcery]
!!FU7701:P0/25/2/189576;
!!FU7701:P0/25/3/189577;

!!FU7701:P0/26/1/189578;                [Resistance]
!!FU7701:P0/26/2/189579;
!!FU7701:P0/26/3/189580;

!!FU7701:P0/27/1/189581;                [First Aid]
!!FU7701:P0/27/2/189582;
!!FU7701:P0/27/3/189583;

!!FU7701:P0/0/0/199100;
!!FU7701:P0/1/0/199101;
!!FU7701:P0/2/0/199102;
!!FU7701:P0/3/0/199103;
!!FU7701:P0/4/0/199104;
!!FU7701:P0/5/0/199105;
!!FU7701:P0/6/0/199106;
!!FU7701:P0/7/0/199107;
!!FU7701:P0/8/0/199108;
!!FU7701:P0/9/0/199109;
!!FU7701:P0/10/0/199110;
!!FU7701:P0/11/0/199111;
!!FU7701:P0/12/0/199112;
!!FU7701:P0/13/0/199113;
!!FU7701:P0/14/0/199114;
!!FU7701:P0/15/0/199115;
!!FU7701:P0/16/0/199116;
!!FU7701:P0/17/0/199117;
!!FU7701:P0/18/0/199118;
!!FU7701:P0/19/0/199119;
!!FU7701:P0/20/0/199120;
!!FU7701:P0/21/0/199121;
!!FU7701:P0/22/0/199122;
!!FU7701:P0/23/0/199123;
!!FU7701:P0/24/0/199124;
!!FU7701:P0/25/0/199125;
!!FU7701:P0/26/0/199126;
!!FU7701:P0/27/0/199127;

********************************************************************************

!?FU(OnHeroGainLevel);
!!HE(CURRENT_HERO):N?(hero:y);
!!FU(acm_AdjustLevelUpPrimarySkills):P(hero); [Adjust Primary Skills for different classes]
!!FU(Set_SS_Skill_Name_and_Text)&(ERM_FLAG_IS_HUMAN):P;                                    [Reset Skill Descriptions to show correct name in level up Screen]
!!FU(H3_Mod_Level_Up_Routine):P(hero);                                                     [Determine Skills to level Up to Master/GM]

!?FU(OnAfterHeroGainLevel);
!#VA(hero:x);
!!FU(acm_RestoreSecSkillsAndApplyDetectedUpgrades):P(hero);
!!FU(acm_ShowClassPromotionDlgIfMarked):P(hero); [Call Level Up Function]

!?FU(OnGameEnter);
!!SN:W^Game_Start_Value^/10; [Activate First Click on Adventure Map activates Dialouge  [Works only after game start]

!?FU(acm_RestoreSecSkillsAndApplyDetectedUpgrades);
!#VA(hero:x);

!!re i/0/(SEC_SKILL_LAST);
  !!FU(acm_GetSecSkillLevel):P(hero)/i/?(skillLevel:y);
  !!SN:Vi^acm_SecSkillsBackup^/i/?(prevSkillLevel:y);

  !!if&(skillLevel)>=(prevSkillLevel)/(prevSkillLevel)>=(SKILL_EXPERT)/(prevSkillLevel)<(SKILL_GRANDMASTER);
    !!VR(newSkillLevel:y):S(prevSkillLevel) +1;
    !!FU(acm_SetSecSkillLevel):P(hero)/i/(newSkillLevel);
  !!el;
    !!HE(hero):Si/?(nativeSkillLevel:y);
    !!FU(acm_SetSecSkillLevel)&(nativeSkillLevel)<(prevSkillLevel):P(hero)/i/(prevSkillLevel);
  !!en;
!!en;

!?FU(H3_Mod_Level_Up_Routine);
!#VA(hero:x);

!!re i/0/(SEC_SKILL_LAST);
  !!FU(H3_Mod_Skill_Loop10):P(hero)/i;
!!en;

!!FU(acm_BackupAndPrepareSecSkills):P(hero);
!!FU(acm_RecalcClassPoints):P(hero)/?(warriorPoints:y)/?(magePoints:y)/?(adventurerPoints:y);

!?FU(H3_Mod_Assign_Level_UP);

*!IF:M^Now Assign runs with x2 %X2 and x4 %X4  and x1 %X1^;

!!SN&x2=0/x4=0:W^H3_Pathfinding_0_Hero%X1^/1;
!!SN&x2=1/x4=0:W^H3_Pathfinding_1_Hero%X1^/1;
!!SN&x2=0/x4=1:W^H3_Archery_0_Hero%X1^/1;
!!SN&x2=1/x4=1:W^H3_Archery_1_Hero%X1^/1;
!!SN&x2=0/x4=2:W^H3_Logistics_0_Hero%X1^/1;
!!SN&x2=1/x4=2:W^H3_Logistics_1_Hero%X1^/1;
!!SN&x2=0/x4=3:W^H3_Scouting_0_Hero%X1^/1;
!!SN&x2=1/x4=3:W^H3_Scouting_1_Hero%X1^/1;
!!SN&x2=0/x4=4:W^H3_Diplomacy_0_Hero%X1^/1;
!!SN&x2=1/x4=4:W^H3_Diplomacy_1_Hero%X1^/1;
!!SN&x2=0/x4=5:W^H3_Nobility_0_Hero%X1^/1;
!!SN&x2=1/x4=5:W^H3_Nobility_1_Hero%X1^/1;
!!SN&x2=0/x4=6:W^H3_Leadership_0_Hero%X1^/1;
!!SN&x2=1/x4=6:W^H3_Leadership_1_Hero%X1^/1;
!!SN&x2=0/x4=7:W^H3_Wisdom_0_Hero%X1^/1;
!!SN&x2=1/x4=7:W^H3_Wisdom_1_Hero%X1^/1;
!!SN&x2=0/x4=8:W^H3_Mysticism_0_Hero%X1^/1;
!!SN&x2=1/x4=8:W^H3_Mysticism_1_Hero%X1^/1;
!!SN&x2=0/x4=9:W^H3_Luck_0_Hero%X1^/1;
!!SN&x2=1/x4=9:W^H3_Luck_1_Hero%X1^/1;
!!SN&x2=0/x4=10:W^H3_Ballistics_0_Hero%X1^/1;
!!SN&x2=1/x4=10:W^H3_Ballistics_1_Hero%X1^/1;
!!SN&x2=0/x4=11:W^H3_Eagle Eye_0_Hero%X1^/1;
!!SN&x2=1/x4=11:W^H3_Eagle Eye_1_Hero%X1^/1;
!!SN&x2=0/x4=12:W^H3_Necromancy_0_Hero%X1^/1;
!!SN&x2=1/x4=12:W^H3_Necromancy_1_Hero%X1^/1;
!!SN&x2=0/x4=13:W^H3_Estates_0_Hero%X1^/1;
!!SN&x2=1/x4=13:W^H3_Estates_1_Hero%X1^/1;
!!SN&x2=0/x4=14:W^H3_Fire Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=14:W^H3_Fire Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=15:W^H3_Air Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=15:W^H3_Air Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=16:W^H3_Water Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=16:W^H3_Water Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=17:W^H3_Earth Magic_0_Hero%X1^/1;
!!SN&x2=1/x4=17:W^H3_Earth Magic_1_Hero%X1^/1;
!!SN&x2=0/x4=18:W^H3_Scholar_0_Hero%X1^/1;
!!SN&x2=1/x4=18:W^H3_Scholar_1_Hero%X1^/1;
!!SN&x2=0/x4=19:W^H3_Tactics_0_Hero%X1^/1;
!!SN&x2=1/x4=19:W^H3_Tactics_1_Hero%X1^/1;
!!SN&x2=0/x4=20:W^H3_Artillery_0_Hero%X1^/1;
!!SN&x2=1/x4=20:W^H3_Artillery_1_Hero%X1^/1;
!!SN&x2=0/x4=21:W^H3_Learning_0_Hero%X1^/1;
!!SN&x2=1/x4=21:W^H3_Learning_1_Hero%X1^/1;
!!SN&x2=0/x4=22:W^H3_Offense_0_Hero%X1^/1;
!!SN&x2=1/x4=22:W^H3_Offense_1_Hero%X1^/1;
!!SN&x2=0/x4=23:W^H3_Armorer_0_Hero%X1^/1;
!!SN&x2=1/x4=23:W^H3_Armorer_1_Hero%X1^/1;
!!SN&x2=0/x4=24:W^H3_Intelligence_0_Hero%X1^/1;
!!SN&x2=1/x4=24:W^H3_Intelligence_1_Hero%X1^/1;
!!SN&x2=0/x4=25:W^H3_Sorcery_0_Hero%X1^/1;
!!SN&x2=1/x4=25:W^H3_Sorcery_1_Hero%X1^/1;
!!SN&x2=0/x4=26:W^H3_Resistance_0_Hero%X1^/1;
!!SN&x2=1/x4=26:W^H3_Resistance_1_Hero%X1^/1;
!!SN&x2=0/x4=27:W^H3_First Aid_0_Hero%X1^/1;
!!SN&x2=1/x4=27:W^H3_First Aid_1_Hero%X1^/1;

********************************************************************************
!?FU(AC_Function_23);

!!HEx1:Sx16/?y1;
!!FU&y1>0:E;
!!SN&x16=0:W^H3_Pathfinding_0_Hero%X1^/0;
!!SN&x16=0:W^H3_Pathfinding_1_Hero%X1^/0;
!!SN&x16=1:W^H3_Archery_0_Hero%X1^/0;
!!SN&x16=1:W^H3_Archery_1_Hero%X1^/0;
!!SN&x16=2:W^H3_Logistics_0_Hero%X1^/0;
!!SN&x16=2:W^H3_Logistics_1_Hero%X1^/0;
!!SN&x16=3:W^H3_Scouting_0_Hero%X1^/0;
!!SN&x16=3:W^H3_Scouting_1_Hero%X1^/0;
!!SN&x16=4:W^H3_Diplomacy_0_Hero%X1^/0;
!!SN&x16=4:W^H3_Diplomacy_1_Hero%X1^/0;
!!SN&x16=5:W^H3_Nobility_0_Hero%X1^/0;
!!SN&x16=5:W^H3_Nobility_1_Hero%X1^/0;
!!SN&x16=6:W^H3_Leadership_0_Hero%X1^/0;
!!SN&x16=6:W^H3_Leadership_1_Hero%X1^/0;
!!SN&x16=7:W^H3_Wisdom_0_Hero%X1^/0;
!!SN&x16=7:W^H3_Wisdom_1_Hero%X1^/0;
!!SN&x16=8:W^H3_Mysticism_0_Hero%X1^/0;
!!SN&x16=8:W^H3_Mysticism_1_Hero%X1^/0;
!!SN&x16=9:W^H3_Luck_0_Hero%X1^/0;
!!SN&x16=9:W^H3_Luck_1_Hero%X1^/0;
!!SN&x16=10:W^H3_Ballistics_0_Hero%X1^/0;
!!SN&x16=10:W^H3_Ballistics_1_Hero%X1^/0;
!!SN&x16=11:W^H3_Eagle Eye_0_Hero%X1^/0;
!!SN&x16=11:W^H3_Eagle Eye_1_Hero%X1^/0;
!!SN&x16=12:W^H3_Necromancy_0_Hero%X1^/0;
!!SN&x16=12:W^H3_Necromancy_1_Hero%X1^/0;
!!SN&x16=13:W^H3_Estates_0_Hero%X1^/0;
!!SN&x16=13:W^H3_Estates_1_Hero%X1^/0;
!!SN&x16=14:W^H3_Fire Magic_0_Hero%X1^/0;
!!SN&x16=14:W^H3_Fire Magic_1_Hero%X1^/0;
!!SN&x16=15:W^H3_Air Magic_0_Hero%X1^/0;
!!SN&x16=15:W^H3_Air Magic_1_Hero%X1^/0;
!!SN&x16=16:W^H3_Water Magic_0_Hero%X1^/0;
!!SN&x16=16:W^H3_Water Magic_1_Hero%X1^/0;
!!SN&x16=17:W^H3_Earth Magic_0_Hero%X1^/0;
!!SN&x16=17:W^H3_Earth Magic_1_Hero%X1^/0;
!!SN&x16=18:W^H3_Scholar_0_Hero%X1^/0;
!!SN&x16=18:W^H3_Scholar_1_Hero%X1^/0;
!!SN&x16=19:W^H3_Tactics_0_Hero%X1^/0;
!!SN&x16=19:W^H3_Tactics_1_Hero%X1^/0;
!!SN&x16=20:W^H3_Artillery_0_Hero%X1^/0;
!!SN&x16=20:W^H3_Artillery_1_Hero%X1^/0;
!!SN&x16=21:W^H3_Learning_0_Hero%X1^/0;
!!SN&x16=21:W^H3_Learning_1_Hero%X1^/0;
!!SN&x16=22:W^H3_Offense_0_Hero%X1^/0;
!!SN&x16=22:W^H3_Offense_1_Hero%X1^/0;
!!SN&x16=23:W^H3_Armorer_0_Hero%X1^/0;
!!SN&x16=23:W^H3_Armorer_1_Hero%X1^/0;
!!SN&x16=24:W^H3_Intelligence_0_Hero%X1^/0;
!!SN&x16=24:W^H3_Intelligence_1_Hero%X1^/0;
!!SN&x16=25:W^H3_Sorcery_0_Hero%X1^/0;
!!SN&x16=25:W^H3_Sorcery_1_Hero%X1^/0;
!!SN&x16=26:W^H3_Resistance_0_Hero%X1^/0;
!!SN&x16=26:W^H3_Resistance_1_Hero%X1^/0;
!!SN&x16=27:W^H3_First Aid_0_Hero%X1^/0;
!!SN&x16=27:W^H3_First Aid_1_Hero%X1^/0;

************************Adjust Primary Skills when level up*********************
Fixes the Primary skill level up for Mage Class after level 10. Now they keep higher chance to gain Spell Power and Knowledge
!?FU(acm_AdjustLevelUpPrimarySkills);

!!FU(Valid_Adventurer_Hero):Px1/?y60;   [Call Function to Check if Adventurer Hero]
!!FU&y60=1:E;                           [Not for those Magic Heroes because they are Adventurer]

!!HEx1:E?y10/?y11/1;                    [Get Level]
!!FU&y11<15:E;                          [Exit if level is smaller then 15]
!!HEx1:B2/?y2;                          [Get Class]
!!VRy3:Sy2 %2;
!!if&y3=1;                             [If Mage class]
  !!HL:S?y1/?y50/?y50;                  [Get Primary Skill in y1 and dont change the Secondary Skills]
  !!VRy5:S0T2;                          [Coin Flip 33% to change]
  !!VRy6:S2T1;                          [Flip for Spell Power or Knowledge]
  !!VRy1&y1=0/y5=1:Sy6;                 [If Attack change with 50% chance to Spell Power or Knowledge]
  !!VRy1&y1=1/y5=1:Sy6;                 [If Defense change with 50% chance to Spell Power or Knowledge]
  !!VRy10:S0T3;
  !!VRy1&y6=3/y10=3:S2;                 [If Knowledge was rolled there is a 25% chance that Knowledge gets converted to Spell Power]
  !!HL:Sy1/?y50/?y50;                   [Get Primary Skill in y1 and dont change the Secondary Skills]
!!en;

****************** ADVANCED LEVELS MASTER DIALOGUE *****************************

!?FU(acm_ShowClassPromotionDlgIfMarked);
!#VA(hero:x);
!!FU(acm_ShowClassPromotionDlg)&i^acm_promotedClassMark_%(hero)^<>(FALSE):P(hero);

!?FU(acm_ShowClassPromotionDlg)&(ERM_FLAG_IS_HUMAN);  [DL must be embedded in function otherwise give errors]
!#VA(hero:x);

!!VRi^acm_promotedClassMark_%(hero)^:S(FALSE);

!!HEx1:O?y1;                            [Checke Hero Owner]
!!OW:Iy1/?y1;                           [AI/Human        1 : AI        0 : Human]
!!FU&y1=1:E;                            [Exit if AI or player Killed]

!!DL266:N^adv_clas.txt^;                [parse dialogue]
!!HEx1:B2/?y2 R2/?y99 B0/?z4;           [class? / sex?]
!!SN:T^AC_Misc.New Level^/?z-1 Iz-1/?z-1;
!!DL266:A1/3/z-1/1;                     [update text for hero name]
!!SN:T^AC_Misc.Bonus_Level^/?z-2;
!!DL266:A2/3/z-2/1;                     [update text for hero name]

!!FU(acm_RecalcClassPoints):Px1/?y10/?y20/?y30; [Return value for class points from current hero]

!!SN:W^Adept_Level_Global_Value^/?y90;
!!SN:W^Expert_Level_Global_Value^/?y91;
!!SN:W^Master_Level_Global_Value^/?y92; [Read out global values for Master rank]
!!SN:W^Grandmaster_Level_Global_Value^/?y93; [Read out global values for GM rank]

!!VRy70:S0;
*Decide which Class has highest points*
!!VRy70&y10>y20/y10>y30:S1;  [Warrior]
!!VRy70&y20>y10/y20>y30:S2;  [Mage]
!!VRy70&y30>y20/y30>y10:S3;  [Adventurer]
!!VRy70&y20>=y92/y30>=y92:S6;  [Druid]
!!VRy70&y10>=y92/y20>=y92:S5;  [Battlemage]
!!VRy70&y10>=y92/y30>=y92:S4;  [Hunter]

!!SN&y10>y20/y10>y30:T^AC_Misc.Warrior^/?z-7; [Warrior and Mage]
!!SN&y20>y10/y20>y30:T^AC_Misc.Mage^/?z-7; [Mage and Adventurer]
!!SN&y30>y20/y30>y10:T^AC_Misc.Adventurer^/?z-7; [Adventurer and Warrior]

!!SN&y10>=y92/y20>=y92:T^AC_Misc.Battlemage^/?z-7; [Warrior and Mage, Battlemage]
!!SN&y20>=y92/y30>=y92:T^AC_Misc.Druid^/?z-7; [Mage and Adventurer, Druid]
!!SN&y10>=y92/y30>=y92:T^AC_Misc.Hunter^/?z-7; [Adventurer and Warrior, Hunter]

!!SN|y10>=y90/y20>=y90/y30>=y90:T^AC_Misc.Adept^/?z9; [Get correct level tag]
!!SN|y10>=y91/y20>=y91/y30>=y91:T^AC_Misc.Expert^/?z9;
!!SN|y10>=y92/y20>=y92/y30>=y92:T^AC_Misc.Master^/?z9;
!!SN|y10>=y93/y20>=y93/y30>=y93:T^AC_Misc.Grandmaster^/?z9;

!!VRz9|y70=4/y70=5/y70=6:S^^;           [for Hybrid class delete Master/Grandmaster tag]
!!VRz-5:S^%Z9 %Z-7^;                    [set z-7 to combination of rank and class]

!!DL266:A4/3/z-5/1;                     [show correct level name]

* set advanced levels picture
!!HEx1:B2/?y2  R2/?y99;                 [class?]
!!VRz-4&y99=0:S^m^; !!VRz-4&y99=1:S^w^; [Set for female or male]

* set advanced level skills and pictures
!!SN:W^Classic_Skin_Mod^/?y50;          [Check if Skin Option activated]

!!if&y70=1/y10>=y92/y10<y93;           [For Master Warrior]
!!VRy95:S1;                             [Set to Master Training I 1]
!!VRy96:S36;                            [Set to Critical Hit I 36]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL266:A50/11/z-7/1;                   [Show picture number 50]
!!DL266:A51/11/z-8/1;                   [Show picture number 51]
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MWarrior%Y25%Z-4.pcx^;        [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189586;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Warrior_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Warrior_Skill_2^/?z21;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
!!en;
!!en;

!!if&y70=1/y10>=y93;                   [For Grandmaster Warrior]
!!VRy95:S5;                             [Set to Master Training II 1 (Elite Soldier)]
!!VRy96:S80;                            [Set to Critical Hit II 80]
!!VRy97:S44;                            [Set to Endure Pain 44]
!!VRy98:S52;                            [Set to Commanders 52]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMWarrior%Y25%Z-4.pcx^;       [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189587;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Warrior_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Warrior_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Warrior_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Warrior_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=2/y20>=y92/y20<y93;           [For Master Mage]
!!VRy95:S53;                            [Set to Master Power 53 (Extra Cast I)]
!!VRy96:S70;                            [Set to Elemental Resistance 70]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MMage%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189589;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Mage_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Mage_Skill_2^/?z21;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
!!en;
!!en;

!!if&y70=2/y20>=y93;                   [For GrandMaster Mage]
!!VRy95:S56;                            [Set to Spell Braiding 53 (Extra Cast II)]
!!VRy96:S70;                            [Set to Elemental Resistance 70]
!!VRy97:S47;                            [Set to Arkane Prophet 47]
!!VRy98:S55;                            [Set to Channeling 24]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMMage%Y25%Z-4.pcx^;          [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189590;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Mage_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Mage_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Mage_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Mage_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=3/y30>=y92/y30<y93;           [For Master Adventurer]
!!VRy95:S50;                            [Set to War Path I 50]
!!VRy96:S58;                            [Set to Horsemaster 58 (Lord)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MAdv%Y25%Z-4.pcx^;            [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189592;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Adv_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Adv_Skill_2^/?z21;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
!!en;
!!en;

!!if&y70=3/y30>=y93;                   [For GrandMaster Adventurer]
!!VRy95:S81;                            [Set to War Path II 50]
!!VRy96:S11;                            [Set to Benediction 2 (Landlord)]
!!VRy97:S49;                            [Set to Strength in Numbers 49]
!!VRy98:S43;                            [Set to Coordinated Attack 43]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMAdv%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189593;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Adv_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Adv_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Adv_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Adv_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=4;                            [For Hunter]
!!VRy95:S1;                             [Set to Master Training I 1]
!!VRy96:S50;                            [Set to War Path 50]
!!VRy97:S100;                           [Set to Rapid Shot 100]
!!VRy98:S21;                            [Set to Irresistable Magic 21 (Magic Block)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^Hunter%Y25%Z-4.pcx^;          [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189596;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Hunter_Skill_1^/?z20;
  !!SN:T^AC_Misc.Hunter_Skill_2^/?z21;
  !!SN:T^AC_Misc.Hunter_Skill_3^/?z22;
  !!SN:T^AC_Misc.Hunter_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=5;                            [For Battlemage]
!!VRy95:S53;                            [Set to Master Power 53]
!!VRy96:S1;                             [Set to Master Training 1]
!!VRy97:S75;                            [Set to Precast 75]
!!VRy98:S37;                            [Set to Intimidation (Warcry)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]^;
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^BM%Y25%Z-4.pcx^;              [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189595;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Battlemage_Skill_1^/?z20;
  !!SN:T^AC_Misc.Battlemage_Skill_2^/?z21;
  !!SN:T^AC_Misc.Battlemage_Skill_3^/?z22;
  !!SN:T^AC_Misc.Battlemage_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!if&y70=6;                            [For Druid]
!!VRy95:S53;                            [Set to Master Power 53]
!!VRy96:S63;                            [Set to Herbalism 63 (Natrual Healer)]
!!VRy97:S68;                            [Set to Ethereal 68 (Stone/Hard Skin)]
!!VRy98:S61;                            [Set to Concentration 61 (replaces War Path)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL266:A50/11/z-7/1;
!!DL266:A51/11/z-8/1;
!!DL266:A52/11/z-9/1;
!!DL266:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^Druid%Y25%Z-4.pcx^;           [level pcx name]
!!DL266:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189597;
!!DL266:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Druid_Skill_1^/?z20;
  !!SN:T^AC_Misc.Druid_Skill_2^/?z21;
  !!SN:T^AC_Misc.Druid_Skill_3^/?z22;
  !!SN:T^AC_Misc.Druid_Skill_4^/?z23;
  !!DL266:A60/3/z20/1;
  !!DL266:A61/3/z21/1;
  !!DL266:A62/3/z22/1;
  !!DL266:A63/3/z23/1;
!!en;
!!en;

!!VRz-3&x1=152:S^Roland.pcx^;           [Special Heroes get Special Pictures]
!!VRz-3&x1=146:S^Catherine.pcx^;        [Special Heroes get Special Pictures]
!!VRz-3&x1=74:S^Sandro.pcx^;            [Special Heroes get Special Pictures]
!!DL266|x1=152/x1=146/x1=74:A19/11/z-3/1;[show big picture]

!!VRz-9:S^ULTIMATEARTIFACT.wav^;
!!SN:Pz-9;                              [play quest sound before showing dialogue]
!!DL266:S;                              [show dialogue]

Close Dialouge
!?DL&v998=266/v999=30722/v1000=13;
!!DL:C1;


!#VRy1:S1T9; !#VRy2:S1T5;               [Set Random Class Picture on Map start]
!#SN:W^Master_Picture^/y1;
!#SN:W^Grandmaster_Picture^/y2;

--------------------------------------------------------------------------------
************************* HERO SCREEN CLICK DIALOGUE ***************
!?CM2;                                  [hero screen click]
!!CM:F?y1 I?y2 S?y3;
!!if&y1=512/y2=45/y3=14;               [When clicked on Hero Portrait]

!!HE-1:N?y1;
!!FU(acm_RecalcClassPoints):Py1/?y10/?y20/?y30; [Return value for class points from current hero]

!!SN:W^Adept_Level_Global_Value^/?y90;
!!SN:W^Expert_Level_Global_Value^/?y91;
!!SN:W^Master_Level_Global_Value^/?y92; [Read out global values for Master rank]
!!SN:W^Grandmaster_Level_Global_Value^/?y93; [Read out global values for GM rank]

!!SN&y10<y92/y20<y92/y30<y92:T^AC_Misc.No_advance^/?z1;
!!IF&y10<y92/y20<y92/y30<y92:M1/z1;
!!CM&y10<y92/y20<y92/y30<y92:R0;
!!FU&y10<y92/y20<y92/y30<y92:E;         [If no requirements met Exit Fkt]
!!CM:R0;

* PREPARE ADVANCED LEVELS DIALOGUE
!!DL667:N^Her_Scre.txt^;
!!HEy1:B0/?z-1;                         [name of hero]
!!HEy1:Ed/?y5;                          [level of hero]
!!HEy1:B2/?y2 N?y3 O?y14;               [class of hero  / hero number /owner]

* set class name for level text box

!!SN&y2=0:T^AC_Misc.Class_Knight^/?z-7;
!!SN&y2=1:T^AC_Misc.Class_Cleric^/?z-7;
!!SN&y2=2:T^AC_Misc.Class_Ranger^/?z-7;
!!SN&y2=3:T^AC_Misc.Class_Druid^/?z-7;
!!SN&y2=4:T^AC_Misc.Class_Alchemist^/?z-7;
!!SN&y2=5:T^AC_Misc.Class_Wizard^/?z-7;

!!SN&y2=6:T^AC_Misc.Class_Demoniac^/?z-7;
!!SN&y2=7:T^AC_Misc.Class_Heretic^/?z-7;
!!SN&y2=8:T^AC_Misc.Class_Death Knight^/?z-7;
!!SN&y2=9:T^AC_Misc.Class_Necromancer^/?z-7;
!!SN&y2=10:T^AC_Misc.Class_Warlock^/?z-7;
!!SN&y2=11:T^AC_Misc.Class_Overlord^/?z-7;

!!SN&y2=12:T^AC_Misc.Class_Barbarian^/?z-7;
!!SN&y2=13:T^AC_Misc.Class_Battle Mage^/?z-7;
!!SN&y2=14:T^AC_Misc.Class_Beastmaster^/?z-7;
!!SN&y2=15:T^AC_Misc.Class_Witch^/?z-7;
!!SN&y2=16:T^AC_Misc.Class_Planeswalker^/?z-7;
!!SN&y2=17:T^AC_Misc.Class_Elementalist^/?z-7;

!!SN:T^AC_Misc.HS_Level^/?z-2 Iz-2/?z-2;

!!DO(Set_pcx_small)/1/1/1:P1/y3;        [loop through all heroes and set the pcx portrait text [LARGE portrait]
!!DO(Set_pcx_small)/1/8/1:P2/-1;        [loop through all heroes and set the pcx portrait text [SMALL portrait]

!!HEy1:F?y9/?y11/?y12/?y13;             [hero primary skills?]
!!VRz6:S^%Y9^;                          [PS text string]
!!VRz7:S^%Y11^;                         [PS text string]
!!VRz8:S^%Y12^;                         [PS text string]
!!VRz9:S^%Y13^;                         [PS text string]

* set units defs & textfields for creature numbers
!!DO(Set_defs1)/0/6/1:P;

*set textboxes in dialogue
!!DL667:A1/3/z-1/1;                     [set hero name text box]
!!DL667:A2/3/z-2/1;                     [set level text box]

!!DL667:A54/3/z6/1;                     [set attack primary skills text box]
!!DL667:A4/3/z7/1;                      [set defense primary skills text box]
!!DL667:A55/3/z8/1;                     [set spell power primary skills text box]
!!DL667:A57/3/z9/1;                     [set knowledge primary skills text box]

!!SN:T^AC_Misc.Attack1^/?z2;
!!SN:T^AC_Misc.Defense^/?z3;
!!SN:T^AC_Misc.Power^/?z4;
!!SN:T^AC_Misc.Knowledge^/?z5;

!!DL667:A88/3/z2/1;                     [set attack primary skills text box]
!!DL667:A43/3/z3/1;                     [set defense primary skills text box]
!!DL667:A44/3/z4/1;                     [set spell power primary skills text box]
!!DL667:A49/3/z5/1;                     [set knowledge primary skills text box]

!!DL667:A24/4/y14/1;                    [set flag def cadre according to player color]

!!VRy70:S0;
*Decide which Class has highest points*
!!VRy70&y10>y20/y10>y30:S1;             [Warrior]
!!VRy70&y20>y10/y20>y30:S2;             [Mage]
!!VRy70&y30>y20/y30>y10:S3;             [Adventurer]
!!VRy70&y20>=y92/y30>=y92:S6;           [Druid]
!!VRy70&y10>=y92/y20>=y92:S5;           [Battlemage]
!!VRy70&y10>=y92/y30>=y92:S4;           [Hunter]

!!SN&y10>y20/y10>y30:T^AC_Misc.Warrior^/?z-7; [Warrior and Mage]
!!SN&y20>y10/y20>y30:T^AC_Misc.Mage^/?z-7; [Mage and Adventurer]
!!SN&y30>y20/y30>y10:T^AC_Misc.Adventurer^/?z-7; [Adventurer and Warrior]

!!SN&y10>=y92/y20>=y92:T^AC_Misc.Battlemage^/?z-7; [Warrior and Mage, Battlemage]
!!SN&y20>=y92/y30>=y92:T^AC_Misc.Druid^/?z-7; [Mage and Adventurer, Druid]
!!SN&y10>=y92/y30>=y92:T^AC_Misc.Hunter^/?z-7; [Adventurer and Warrior, Hunter]

!!SN|y10>=y90/y20>=y90/y30>=y90:T^AC_Misc.Adept^/?z9; [Get correct level tag]
!!SN|y10>=y91/y20>=y91/y30>=y91:T^AC_Misc.Expert^/?z9;
!!SN|y10>=y92/y20>=y92/y30>=y92:T^AC_Misc.Master^/?z9;
!!SN|y10>=y93/y20>=y93/y30>=y93:T^AC_Misc.Grandmaster^/?z9;

!!VRz9|y70=4/y70=5/y70=6:S^^;           [for Hybrid class delete Master/Grandmaster tag]
!!VRz-5:S^%Z9 %Z-7^;                    [set z-7 to combination of rank and class]
!!DL667:A20/3/z-5/1;                    [show correct level name]

* set advanced levels picture
!!HEy1:B2/?y2  R2/?y99;                 [class?]
!!VRz-4&y99=0:S^m^; !!VRz-4&y99=1:S^w^; [Set for female or male]

!!SN&y10>=y93:T^AC_Misc.Grandmaster^/?z6; !!SN&y10<y93:T^AC_Misc.Master^/?z6; !!SN&y10<y92:T^AC_Misc.Expert^/?z6; !!SN&y10<y91:T^AC_Misc.Adept^/?z6;
!!SN&y20>=y93:T^AC_Misc.Grandmaster^/?z7; !!SN&y20<y93:T^AC_Misc.Master^/?z7; !!SN&y20<y92:T^AC_Misc.Expert^/?z7; !!SN&y20<y91:T^AC_Misc.Adept^/?z7;
!!SN&y30>=y93:T^AC_Misc.Grandmaster^/?z8; !!SN&y30<y93:T^AC_Misc.Master^/?z8; !!SN&y30<y92:T^AC_Misc.Expert^/?z8; !!SN&y30<y91:T^AC_Misc.Adept^/?z8;
!!SN:T^AC_Misc.Warrior^/?z3;
!!SN:T^AC_Misc.Mage^/?z4;
!!SN:T^AC_Misc.Adventurer^/?z5;

!!FU(acm_RecalcClassPoints):Py1/?m/?n/?p/(TRUE);
!!VRz-6:S^%Z6 {~r}%Z3 %m{~}
%Z7 {~DodgerBlue}%Z4 %n{~}
%Z8 {~LimeGreen}%Z5 %p{~}^;
!!DL667:A33/3/z-6/1;                    [show class points under big picture]

!!VRz-4&y99=0:S^m^; !!VRz-4&y99=1:S^w^; [Set for female or male]

* set advanced level skills and pictures
!!SN:W^Classic_Skin_Mod^/?y50;          [Check if Skin Option activated]

!!if&y70=1/y10>=y92/y10<y93;           [For Master Warrior]
!!VRy95:S1;                             [Set to Master Training I 1]
!!VRy96:S36;                            [Set to Critical Hit I 36]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL667:A50/11/z-7/1;                   [Show picture number 50]
!!DL667:A51/11/z-8/1;                   [Show picture number 51]
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MWarrior%Y25%Z-4.pcx^;        [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189586;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Warrior_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Warrior_Skill_2^/?z21;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
!!en;
!!en;

!!if&y70=1/y10>=y93;                   [For Grandmaster Warrior]
!!VRy95:S5;                             [Set to Master Training II 1 (Elite Soldier)]
!!VRy96:S80;                            [Set to Critical Hit II 80]
!!VRy97:S44;                            [Set to Endure Pain 44]
!!VRy98:S52;                            [Set to Commanders 52]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!DL667:A52/11/z-9/1;
!!DL667:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMWarrior%Y25%Z-4.pcx^;       [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189587;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Warrior_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Warrior_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Warrior_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Warrior_Skill_4^/?z23;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
  !!DL667:A62/3/z22/1;
  !!DL667:A63/3/z23/1;
!!en;
!!en;

!!if&y70=2/y20>=y92/y20<y93;           [For Master Mage]
!!VRy95:S53;                            [Set to Master Power 53 (Extra Cast I)]
!!VRy96:S70;                            [Set to Elemental Resistance 70]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MMage%Y25%Z-4.pcx^;           [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189589;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Mage_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Mage_Skill_2^/?z21;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
!!en;
!!en;

!!if&y70=2/y20>=y93;                   [For GrandMaster Mage]
!!VRy95:S56;                            [Set to Spell Braiding 53 (Extra Cast II)]
!!VRy96:S70;                            [Set to Elemental Resistance 70]
!!VRy97:S47;                            [Set to Arkane Prophet 47]
!!VRy98:S55;                            [Set to Channeling 24]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!DL667:A52/11/z-9/1;
!!DL667:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMMage%Y25%Z-4.pcx^;          [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189590;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Mage_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Mage_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Mage_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Mage_Skill_4^/?z23;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
  !!DL667:A62/3/z22/1;
  !!DL667:A63/3/z23/1;
!!en;
!!en;

!!if&y70=3/y30>=y92/y30<y93;           [For Master Adventurer]
!!VRy95:S50;                            [Set to War Path I 50]
!!VRy96:S58;                            [Set to Horsemaster 58 (Lord)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!SN:W^Master_Picture^/?y25;
!!VRz-3:S^MAdv%Y25%Z-4.pcx^;            [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189592;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.M_Adv_Skill_1^/?z20;
  !!SN:T^AC_Misc.M_Adv_Skill_2^/?z21;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
!!en;
!!en;

!!if&y70=3/y30>=y93;                   [For GrandMaster Adventurer]
!!VRy95:S81;                            [Set to War Path II 50]
!!VRy96:S11;                            [Set to Benediction 2 (Landlord)]
!!VRy97:S49;                            [Set to Strength in Numbers 49]
!!VRy98:S43;                            [Set to Coordinated Attack 43]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!DL667:A52/11/z-9/1;
!!DL667:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^GMAdv%Y25%Z-4.pcx^;           [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189593;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.GM_Adv_Skill_1^/?z20;
  !!SN:T^AC_Misc.GM_Adv_Skill_2^/?z21;
  !!SN:T^AC_Misc.GM_Adv_Skill_3^/?z22;
  !!SN:T^AC_Misc.GM_Adv_Skill_4^/?z23;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
  !!DL667:A62/3/z22/1;
  !!DL667:A63/3/z23/1;
!!en;
!!en;

!!if&y70=4;                            [For Hunter]
!!VRy95:S1;                             [Set to Master Training I 1]
!!VRy96:S50;                            [Set to War Path 50]
!!VRy97:S100;                           [Set to Rapid Shot 100]
!!VRy98:S21;                            [Set to Irresistable Magic 21 (Magic Block)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!DL667:A52/11/z-9/1;
!!DL667:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^Hunter%Y25%Z-4.pcx^;          [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189596;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Hunter_Skill_1^/?z20;
  !!SN:T^AC_Misc.Hunter_Skill_2^/?z21;
  !!SN:T^AC_Misc.Hunter_Skill_3^/?z22;
  !!SN:T^AC_Misc.Hunter_Skill_4^/?z23;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
  !!DL667:A62/3/z22/1;
  !!DL667:A63/3/z23/1;
!!en;
!!en;

!!if&y70=5;                            [For Battlemage]
!!VRy95:S53;                            [Set to Master Power 53]
!!VRy96:S1;                             [Set to Master Training 1]
!!VRy97:S75;                            [Set to Precast 75]
!!VRy98:S37;                            [Set to Intimidation (Warcry)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]^;
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!DL667:A52/11/z-9/1;
!!DL667:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^BM%Y25%Z-4.pcx^;              [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189595;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Battlemage_Skill_1^/?z20;
  !!SN:T^AC_Misc.Battlemage_Skill_2^/?z21;
  !!SN:T^AC_Misc.Battlemage_Skill_3^/?z22;
  !!SN:T^AC_Misc.Battlemage_Skill_4^/?z23;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
  !!DL667:A62/3/z22/1;
  !!DL667:A63/3/z23/1;
!!en;
!!en;

!!if&y70=6;                            [For Druid]
!!VRy95:S53;                            [Set to Master Power 53]
!!VRy96:S63;                            [Set to Herbalism 63 (Natrual Healer)]
!!VRy97:S68;                            [Set to Ethereal 68 (Stone/Hard Skin)]
!!VRy98:S61;                            [Set to Concentration 61 (replaces War Path)]
!!VRz-7:S^skill%Y95.pcx^; !!VRz-7&y50=1:S^skill%Y95C.pcx^; [Set z-7 to correct name]
!!VRz-8:S^skill%Y96.pcx^; !!VRz-8&y50=1:S^skill%Y96C.pcx^; [Set z-8 to correct name]
!!VRz-9:S^skill%Y97.pcx^; !!VRz-9&y50=1:S^skill%Y97C.pcx^; [Set z-9 to correct name]
!!VRz-10:S^skill%Y98.pcx^; !!VRz-10&y50=1:S^skill%Y98C.pcx^; [Set z-10 to correct name]
!!DL667:A50/11/z-7/1;
!!DL667:A51/11/z-8/1;
!!DL667:A52/11/z-9/1;
!!DL667:A53/11/z-10/1;
!!SN:W^Grandmaster_Picture^/?y25;
!!VRz-3:S^Druid%Y25%Z-4.pcx^;           [level pcx name]
!!DL667:A19/11/z-3/1;                   [show big picture]
!!VRz-5:Sz189597;
!!DL667:A3/3/z-5/1;                     [show correct skill text what can be leveled]
!!if&y50=0;
  !!SN:T^AC_Misc.Druid_Skill_1^/?z20;
  !!SN:T^AC_Misc.Druid_Skill_2^/?z21;
  !!SN:T^AC_Misc.Druid_Skill_3^/?z22;
  !!SN:T^AC_Misc.Druid_Skill_4^/?z23;
  !!DL667:A60/3/z20/1;
  !!DL667:A61/3/z21/1;
  !!DL667:A62/3/z22/1;
  !!DL667:A63/3/z23/1;
!!en;
!!en;

!!VRz-3&y1=152:S^Roland.pcx^;           [Special Heroes get Special Pictures]
!!VRz-3&y1=146:S^Catherine.pcx^;        [Special Heroes get Special Pictures]
!!VRz-3&y1=74:S^Sandro.pcx^;            [Special Heroes get Special Pictures]
!!DL667|y1=152/y1=146/y1=74:A19/11/z-3/1;[show big picture]

!!UN:R3/-1;                             [redraw hero screen]
!!DL667:S;                              [show dialogue]
!!UN:R3/-1;                             [redraw hero screen]
!!en;

**** CLICK ON CANCEL BUTTON [FLAG], DO NOTHING
!?DL&v998=667/v999=32/v1000=13;
!!DL:C1;                                [end dialogue immedietly]


--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
********  SHOW RIGHT CLICK INFORMATION WHEN CLICKED ON SKILL AND CLASS PICTURE *********
!?DL&v1000=14;
!!if|v998=667/v998=266;
!!if|v999=50/v999=51/v999=52/v999=53/v999=19;
!!VRz-6:S^^;                            [clear]
* set-up skill text description
*
!!HE-1:N?y1;
!!FU(acm_RecalcClassPoints):Py1/?y10/?y20/?y30; [Return value for class points from current hero]

!!SN:W^Adept_Level_Global_Value^/?y90;
!!SN:W^Expert_Level_Global_Value^/?y91;
!!SN:W^Master_Level_Global_Value^/?y92; [Read out global values for Master rank]
!!SN:W^Grandmaster_Level_Global_Value^/?y93; [Read out global values for GM rank]

!!FU&y10<y92/y20<y92/y30<y92:E;         [If no requirements met Exit Fkt]

!!VRy70:S0;
*Decide which Class has highest points*
!!VRy70&y10>y20/y10>y30:S1;             [Warrior]
!!VRy70&y20>y10/y20>y30:S2;             [Mage]
!!VRy70&y30>y20/y30>y10:S3;             [Adventurer]
!!VRy70&y20>=y92/y30>=y92:S6;           [Druid]
!!VRy70&y10>=y92/y20>=y92:S5;           [Battlemage]
!!VRy70&y10>=y92/y30>=y92:S4;           [Hunter]

* set advanced level skills and pictures

!!if&y70=1/y10>=y92/y10<y93;           [For Master Warrior]
!!SN&v999=50:T^AC_Misc.Master_Training^/?z-6; [Get Description of first Bonus]
!!IF&v999=50:M1/4/^%Z-6^;               [Show Description of first Bonus when RClick]
!!SN&v999=51:T^AC_Misc.Critical_Hit_1^/?z-6; [Get Description of second Bonus]
!!IF&v999=51:M1/4/^%Z-6^;               [Show Description of second Bonus when RClick]
!!SN&v999=19:T^AC_Misc.Warrior_Description^/?z-6; [Get Description of Class]
!!IF&v999=19:M1/4/^%Z-6^;               [Show Description of Class when RClick]
!!en;

!!if&y70=1/y10>=y93;                   [For Grandmaster Warrior]
!!SN&v999=50:T^AC_Misc.Elite_Soldier^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Critical_Hit_2^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=52:T^AC_Misc.Endure_Retaliation^/?z-6;
!!IF&v999=52:M1/4/^%Z-6^;
!!SN&v999=53:T^AC_Misc.Commander_1^/?z-6;
!!IF&v999=53:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Warrior_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=2/y20>=y92/y20<y93;           [For Master Mage]
!!SN&v999=50:T^AC_Misc.Extra_Cast_1^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Elemental_Resistance_1^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Mage_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=2/y20>=y93;                   [For GrandMaster Mage]
!!SN&v999=50:T^AC_Misc.Extra_Cast_2^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Elemental_Resistance_1^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=52:T^AC_Misc.Arkane_Prophet^/?z-6;
!!IF&v999=52:M1/4/^%Z-6^;
!!SN&v999=53:T^AC_Misc.Channeling^/?z-6;
!!IF&v999=53:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Mage_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=3/y30>=y92/y30<y93;           [For Master Adventurer]
!!SN&v999=50:T^AC_Misc.Plunder_1^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Horsemaster^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Adventurer_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=3/y30>=y93;                   [For GrandMaster Adventurer]
!!SN&v999=50:T^AC_Misc.Plunder_2^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Landlord_1^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=52:T^AC_Misc.Strength_Numbers^/?z-6;
!!IF&v999=52:M1/4/^%Z-6^;
!!SN&v999=53:T^AC_Misc.Coordinated_Attack^/?z-6;
!!IF&v999=53:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Adventurer_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=4;                            [For Hunter]
!!SN&v999=50:T^AC_Misc.Master_Training^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Plunder_1^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=52:T^AC_Misc.First_Shot^/?z-6;
!!IF&v999=52:M1/4/^%Z-6^;
!!SN&v999=53:T^AC_Misc.Magic_Block^/?z-6;
!!IF&v999=53:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Hunter_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=5;                            [For Battlemage]
!!SN&v999=50:T^AC_Misc.Extra_Cast_1^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Master_Training^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=52:T^AC_Misc.Precast^/?z-6;
!!IF&v999=52:M1/4/^%Z-6^;
!!SN&v999=53:T^AC_Misc.Intimidation^/?z-6;
!!IF&v999=53:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Battlemage_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!if&y70=6;                            [For Druid]
!!SN&v999=50:T^AC_Misc.Extra_Cast_1^/?z-6;
!!IF&v999=50:M1/4/^%Z-6^;
!!SN&v999=51:T^AC_Misc.Natural_Healer^/?z-6;
!!IF&v999=51:M1/4/^%Z-6^;
!!SN&v999=52:T^AC_Misc.Natural_Resistance^/?z-6;
!!IF&v999=52:M1/4/^%Z-6^;
!!SN&v999=53:T^AC_Misc.Concentration^/?z-6;
!!IF&v999=53:M1/4/^%Z-6^;
!!SN&v999=19:T^AC_Misc.Druid_Description^/?z-6;
!!IF&v999=19:M1/4/^%Z-6^;
!!en;

!!en;
!!en;

--------------------------------------------------------------------------------
* STACK PICTURES & TEXT STRINGS SET-UP FOR DIALOGUE

!?FU(Set_defs1);
!!VRy-21:S0;
!!VRy-20:S0;
!!VRy-22:S0;
!!VRv1:S0;
!!HE-1:C0/x16/?y-20/?y-21;              [slot 1]
!!VRv1:Sy-21;
!!VRz-9:S^^;
!!VRz-9&v1>0:S^%Y-21^;
!!VRy-22:S2 +y-20;
!!VRy-22&v1=0:S1;
!!VRy-23:S34 +x16; !!VRy-24:S12 +x16;
!!DL667:Ay-23/3/z-9/1;                  [set def and textbox for slot 1-7]
!!DL667:Ay-24/4/y-22/1;

* for summoning dialogue
*!VRy-23&x1=1:S10 +x16; *!VRy-24&x1=1:S2 +x16;
*!DL672&x1=1:Ay-23/3/z-9/1;             [set def and textbox for slot 1-7]
*!DL672&x1=1:Ay-24/4/y-22/1;

* for dark ritual dialogue
*!VRy-23&x1=2:S10 +x16; *!VRy-24&x1=2:S2 +x16;
*!DL540&x1=2:Ay-23/3/z-9/1;             [set def and textbox for slot 1-7]
*!DL540&x1=2:Ay-24/4/y-22/1;

!!FU&x1<>1:E;

--------------------------------------------------------------------------------
* SMALL/LARGE HERO PICTURE TEXT STRINGS SET-UP FOR DIALOGUE
!?FU(Set_pcx_small);
!!VRy-4:S0; !!VRz-3:S^^;  !!VRz-4:S^^;  !!VRz-5:S^^; !!VRz-6:S^^;
* set small hero portraits on the left
!!OW&x16=1:O-1/d/?y-21/d/d/d/d/d/d/d/d; [1st hero number]
!!OW&x16=2:O-1/d/d/?y-21/d/d/d/d/d/d/d; [2nd hero number]
!!OW&x16=3:O-1/d/d/d/?y-21/d/d/d/d/d/d; [3rd hero number]
!!OW&x16=4:O-1/d/d/d/d/?y-21/d/d/d/d/d; [4th hero number]
!!OW&x16=5:O-1/d/d/d/d/d/?y-21/d/d/d/d; [5th hero number]
!!OW&x16=6:O-1/d/d/d/d/d/d/?y-21/d/d/d; [6th hero number]
!!OW&x16=7:O-1/d/d/d/d/d/d/d/?y-21/d/d; [7th hero number]
!!OW&x16=8:O-1/d/d/d/d/d/d/d/d/?y-21/d; [8th hero number]

!!HEx2&x2<>-1:B2/?y-2;
!!HEy-21&x2=-1:B2/?y-2;                 [class of hero]

!!VRy-4&x2=-1:Sy-21 :10;                [see how many 0 must be in text string]
!!VRy-4&x2<>-1:Sx2 :10;                 [see how many 0 must be in text string]

*say hero class and fill variable for picture display
!!VRz-3&y-2=0:S^KN^;                    [knight]
!!VRz-3&y-2=1:S^CL^;                    [cleric]
!!VRz-3&y-2=2:S^RN^;                    [ranger]
!!VRz-3&y-2=3:S^DR^;                    [druid]
!!VRz-3&y-2=4:S^AL^;                    [alchemist]
!!VRz-3&y-2=5:S^WZ^;                    [alchemist]
!!VRz-3&y-2=6:S^HR^;                    [demoniac]
!!VRz-3&y-2=7:S^DM^;                    [heretic]
!!VRz-3&y-2=8:S^DK^;                    [death knight]
!!VRz-3&y-2=9:S^NC^;                    [necromancer]
!!VRz-3&y-2=10:S^OV^;                   [overlord]
!!VRz-3&y-2=11:S^WL^;                   [warlock]
!!VRz-3&y-2=12:S^BR^;                   [barbarian]
!!VRz-3&y-2=13:S^BM^;                   [battlemage]
!!VRz-3&y-2=14:S^BS^;                   [beastmaster]
!!VRz-3&y-2=15:S^WH^;                   [witch]
!!VRz-3&y-2=16:S^PL^;                   [planeswalker]
!!VRz-3&y-2=17:S^EL^;                   [elementalist]

!!VRz-10&x1=1:S^L^;  !!VRz-10&x1=2:S^S^;[distinguish between small and large hero .pcx picture]

!!VRz-4&y-4=0:S^HP^+^%Z-10^+^00^;       [set text string according to hero numbering]
!!VRz-4&y-4>=1/y-4<=9:S^HP^+^%Z-10^+^0^;
!!VRz-4&y-4>=10:S^HP%Z-10^;
!!VRz-5:S^.pcx^;

!!VRz-6&x2=-1:S^%Z-4%Y-21%Z-3%Z-5^;     [complete hero picture text string [small]
!!VRz-6&x2<>-1:S^%Z-4%X2%Z-3%Z-5^;      [large]

* setup text for extraordinary heroes - planeswalker/elementalist/special heroes like sir mullich, which all have strabge texts
!!VRz-6&x2=128:S^HPL000PL.pcx^;   !!VRz-6&x2=135:S^HPL007PL.pcx^;   !!VRz-6&x2=149:S^HPL005SH.pcx^;   !!VRz-6&x2=143:S^HPL007EL.pcx^;
!!VRz-6&x2=129:S^HPL001PL.pcx^;   !!VRz-6&x2=136:S^HPL000EL.pcx^;   !!VRz-6&x2=150:S^HPL006SH.pcx^;   !!VRz-6&x2=152:S^HPL009SH.pcx^; [Roland]
!!VRz-6&x2=130:S^HPL002PL.pcx^;   !!VRz-6&x2=137:S^HPL001EL.pcx^;   !!VRz-6&x2=144:S^HPL130KN.pcx^;   !!VRz-6&x2=146:S^HPL128QC.pcx^; [146 Catherine]
!!VRz-6&x2=131:S^HPL003PL.pcx^;   !!VRz-6&x2=138:S^HPL002EL.pcx^;   !!VRz-6&x2=153:S^HPL008SH.pcx^;   !!VRz-6&x2=155:S^HPL131Dm.pcx^; [155 Xeron]
!!VRz-6&x2=132:S^HPL004PL.pcx^;   !!VRz-6&x2=139:S^HPL003EL.pcx^;   !!VRz-6&x2=142:S^HPL006EL.pcx^;   !!VRz-6&x2=154:S^HPL001SH.pcx^; [154 Boragus]
!!VRz-6&x2=133:S^HPL005PL.pcx^;   !!VRz-6&x2=140:S^HPL004EL.pcx^;   !!VRz-6&x2=147:S^HPL003SH.pcx^;   !!VRz-6&x2=145:S^HPL000SH.pcx^; [145 Adrienne]
!!VRz-6&x2=134:S^HPL006PL.pcx^;   !!VRz-6&x2=141:S^HPL005EL.pcx^;   !!VRz-6&x2=148:S^HPL004SH.pcx^;   !!VRz-6&x2=151:S^HPL007SH.pcx^; [151 Mutare]

!!VRz-6&y-21=128/x2=-1:S^HPS000PL.pcx^;   !!VRz-6&y-21=135/x2=-1:S^HPS007PL.pcx^;   !!VRz-6&y-21=149/x2=-1:S^HPS005SH.pcx^;   !!VRz-6&y-21=143/x2=-1:S^HPS007EL.pcx^;
!!VRz-6&y-21=129/x2=-1:S^HPS001PL.pcx^;   !!VRz-6&y-21=136/x2=-1:S^HPS000EL.pcx^;   !!VRz-6&y-21=150/x2=-1:S^HPS006SH.pcx^;   !!VRz-6&y-21=152/x2=-1:S^HPS009SH.pcx^; [Roland]
!!VRz-6&y-21=130/x2=-1:S^HPS002PL.pcx^;   !!VRz-6&y-21=137/x2=-1:S^HPS001EL.pcx^;   !!VRz-6&y-21=144/x2=-1:S^HPS130KN.pcx^;   !!VRz-6&y-21=146/x2=-1:S^HPS128QC.pcx^; [146 Catherine]
!!VRz-6&y-21=131/x2=-1:S^HPS003PL.pcx^;   !!VRz-6&y-21=138/x2=-1:S^HPS002EL.pcx^;   !!VRz-6&y-21=153/x2=-1:S^HPS008SH.pcx^;   !!VRz-6&y-21=155/x2=-1:S^HPS131Dm.pcx^; [155 Xeron]
!!VRz-6&y-21=132/x2=-1:S^HPS004PL.pcx^;   !!VRz-6&y-21=139/x2=-1:S^HPS003EL.pcx^;   !!VRz-6&y-21=142/x2=-1:S^HPS006EL.pcx^;   !!VRz-6&y-21=154/x2=-1:S^HPS001SH.pcx^; [154 Boragus]
!!VRz-6&y-21=133/x2=-1:S^HPS005PL.pcx^;   !!VRz-6&y-21=140/x2=-1:S^HPS004EL.pcx^;   !!VRz-6&y-21=147/x2=-1:S^HPS003SH.pcx^;   !!VRz-6&y-21=145/x2=-1:S^HPS000SH.pcx^; [145 Adrienne]
!!VRz-6&y-21=134/x2=-1:S^HPS006PL.pcx^;   !!VRz-6&y-21=141/x2=-1:S^HPS005EL.pcx^;   !!VRz-6&y-21=148/x2=-1:S^HPS004SH.pcx^;   !!VRz-6&y-21=151/x2=-1:S^HPS007SH.pcx^; [151 Mutare]

*!IF:M^Hero is %X2 and %Z-6^;
*!IF:M^%Z-6^;
*!FU(ACM.GetHeroPortrait)&x1=1/x2>=0/x2<156:Py-21/1/z3; Test
*!IF:M^%Z3^;
*!VRz-6&x1=1/x2>=0/x2<156:Sz3;

!!DL667&x1=1/x2<>-1:A0/11/z-6/1;        [set LARGE hero picture .pcx]

!!DL358&x1=1/x2<>-1/x3=5:A1/11/z-6/1;   [set large portrait for vectoring dialogue]
!!DL359&x1=1/x2<>-1/x3=6:A1/11/z-6/1;   [set large portrait for vectoring dialogue]

!!DL416&x1=1/x2<>-1/x3=7:A0/11/z-6/1;   [set hero portraits for SQUIRE dialogue]

!!DL416&x1=1/x2<>-1/x3=8:A1/11/z-6/1;   [hero portraits for squire dialogue]
!!DL416&x1=1/x2<>-1/x3=9:A2/11/z-6/1;
!!DL416&x1=1/x2<>-1/x3=10:A3/11/z-6/1;
!!DL416&x1=1/x2<>-1/x3=11:A4/11/z-6/1;
!!DL416&x1=1/x2<>-1/x3=12:A5/11/z-6/1;
!!DL416&x1=1/x2<>-1/x3=13:A6/11/z-6/1;
!!DL416&x1=1/x2<>-1/x3=14:A7/11/z-6/1;
!!DL417&x1=1/x2<>-1/x3=15:A1/11/z-6/1;
!!DL418&x1=1/x2<>-1/x3=16:A1/11/z-6/1;
!!DL418&x1=1/x2<>-1/x3=17:A4/11/z-6/1;

!!DL667&x1=2/x16=1:A23/11/z-6/1;         [set SMALL hero picture (1st hero)]
!!DL667&x1=2/x16=2/y-21<>-1:A25/11/z-6/1;[set SMALL hero picture (2nd hero)]
!!DL667&x1=2/x16=3/y-21<>-1:A26/11/z-6/1;[set SMALL hero picture (3rd hero)]
!!DL667&x1=2/x16=4/y-21<>-1:A27/11/z-6/1;[set SMALL hero picture (4th hero)]
!!DL667&x1=2/x16=5/y-21<>-1:A28/11/z-6/1;[set SMALL hero picture (5th hero)]
!!DL667&x1=2/x16=6/y-21<>-1:A29/11/z-6/1;[set SMALL hero picture (6th hero)]
!!DL667&x1=2/x16=7/y-21<>-1:A30/11/z-6/1;[set SMALL hero picture (7th hero)]
!!DL667&x1=2/x16=8/y-21<>-1:A31/11/z-6/1;[set SMALL hero picture (8th hero)]
******************END ADVANCED LEVELS MASTER DIALOGUE *****************************



                Improved Secondary Skill Section



********************************************************************************
** Initialization Code

!?PI;
**Global Skill Balancing**

!!FU(SetSecSkillPercent):P2/1/15;       [SS Werte skill Setzten                        [Set Skillvalue to 15% for Basic Logistics]
!!FU(SetSecSkillPercent):P2/2/20;       [SS Werte skill Setzten                        [Set Skillvalue to 20% for Advanced Logistics]
!!FU(SetSecSkillPercent):P2/3/25;       [SS Werte skill Setzten                        [Set Skillvalue to 25% for Expert Logistics]

!!FU(SetSecSkillPercent):P5/1/1;        [SS Werte skill Setzten                         [Set Skillvalue to 1% for Basic Navigation]
!!FU(SetSecSkillPercent):P5/2/1;        [SS Werte skill Setzten                         [Set Skillvalue to 1% for Advanced Navigation]
!!FU(SetSecSkillPercent):P5/3/1;        [SS Werte skill Setzten                         [Set Skillvalue to 1% for Expert Navigation]

!!FU(SetSecSkillPercent):P11/1/50;      [SS Werte skill Setzten                       [Set Skillvalue to 50% for Basic Eagle Eye]
!!FU(SetSecSkillPercent):P11/2/65;      [SS Werte skill Setzten                       [Set Skillvalue to 65% for Advanced Eagle Eye]
!!FU(SetSecSkillPercent):P11/3/75;      [SS Werte skill Setzten                       [Set Skillvalue to 75% for Expert Eagle Eye]

!!FU(SetSecSkillPercent):P21/1/20;      [SS Werte skill Setzten                       [Set Skillvalue to 20% for Basic Learning]
!!FU(SetSecSkillPercent):P21/2/30;      [SS Werte skill Setzten                       [Set Skillvalue to 30% for Advanced Learning]
!!FU(SetSecSkillPercent):P21/3/40;      [SS Werte skill Setzten                       [Set Skillvalue to 40% for Expert Learning]

!!FU(SetSecSkillPercent):P8/1/0;        [SS Werte skill Setzten                         [Set Skillvalue to 0% for Basic Mystic]
!!FU(SetSecSkillPercent):P8/2/0;        [SS Werte skill Setzten                         [Set Skillvalue to 0% for Advanced Mystic]
!!FU(SetSecSkillPercent):P8/3/0;        [SS Werte skill Setzten                         [Set Skillvalue to 0% for Expert Mystic]

*Remember all Necro value is devided by two, so its actually 5/10/15%*
*!FU(SetSecSkillPercent):P12/1/10;      [SS Werte skill Setzten                       [Set Skillvalue to 5% for Basic Necromancy]
*!FU(SetSecSkillPercent):P12/2/20;      [SS Werte skill Setzten                       [Set Skillvalue to 10% for Advanced Necromancy]
*!FU(SetSecSkillPercent):P12/3/30;      [SS Werte skill Setzten                       [Set Skillvalue to 15% for Expert Necromancy]

!!FU(SetSecSkillPercent):P25/1/10;      [SS Werte skill Setzten                       [Set Skillvalue to 10% for Basic Sorcery]
!!FU(SetSecSkillPercent):P25/2/20;      [SS Werte skill Setzten                       [Set Skillvalue to 20% for Advanced Sorcery]
!!FU(SetSecSkillPercent):P25/3/30;      [SS Werte skill Setzten                       [Set Skillvalue to 30% for Expert Sorcery]

!!FU(SetSecSkillPercent):P26/1/10;      [SS Werte skill Setzten                       [Set Skillvalue to 10% for Basic Resistance]
!!FU(SetSecSkillPercent):P26/2/15;      [SS Werte skill Setzten                       [Set Skillvalue to 15% for Advanced Resistance]
!!FU(SetSecSkillPercent):P26/3/20;      [SS Werte skill Setzten                       [Set Skillvalue to 20% for Expert Resistance]

*!SN:W^H3_Hero%X1_Crit_Chance^/0;
*!SN:W^H3_Hero%X1_Crit_Damage^/0;


************************Reset Variables Section*********************************
!?FU(OnAfterBattleUniversal);

!!SN:W^Leadership_Current_battle_round^/-1;
!!SN:W^Leadership_Stack_had_Moral^/-1;

!?FU(OnBattleRegeneratePhase);          [Reset Attacking Stacks Function]

!!SN:W^Leadership_Attacking_Stack^/-1;
*!SN:W^H3_Attacking_Stack^/-1;
!!SN:W^Brute_Attacking_Stack^/-1;
!!SN:W^Temple_G_Attacking_Stack^/-1;
!!SN:W^Paladin_Attacking_Stack^/-1;
!!SN:W^Shaman_Attacking_Stack^/-1;
!!SN:W^Shaman1_Attacking_Stack^/-1;
!!SN:W^Holiness_Attacking_Stack^/-1;
!!SN:W^Warrior_Crit_Attacking_Stack^/-1;
!!SN:W^Will_Attacking_Stack^/-1;
!!SN:W^Cherry_Attacking_Stack^/-1;
!!SN:W^Blackshard_Attacking_Stack^/-1;
!!SN:W^Flail_Attacking_Stack^/-1;
!!SN:W^Tongue_Attacking_Stack^/-1;
!!SN:W^DragonSet_Attacking_Stack^/-1;
!!SN:W^Oger_Attacking_Stack^/-1;


!?BF;

!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!SN&y88>=0:W^Master_Mage_Hero%Y88^/?y4;
!!SN&y89>=0:W^Master_Mage_Hero%Y89^/?y5;

!!SN&y88>=0:W^Grandmaster_Mage_Hero%Y88^/?y6;
!!SN&y89>=0:W^Grandmaster_Mage_Hero%Y89^/?y7;

!!SN&y4=1:W^Master_Mage_Extra_Cast_att^/1; [Set Extra Cast Att Variable to 1]
!!SN&y5=1:W^Master_Mage_Extra_Cast_def^/1; [Set Extra Cast Def Variable to 1]

!!SN&y6=1:W^Master_Mage_Extra_Cast_att^/0; [Disable Extra cast if already Grandmaster]
!!SN&y7=1:W^Master_Mage_Extra_Cast_def^/0; [Disable Extra cast if already Grandmaster]


********************************************************************************



                       MASTER/GRANDMASTER SKILLS



********************************************************************************


************************Pathfinding*********************************************
*+1 Speed in first Battle Round (Master) and bonus movement on all terrain (Grandmaster)
!?FU(OnCombatRound)&v997=0;

!!SN:W^Pathfinding_Speed_Bonus1^/?y1;
!!FU&y1=1:E;
!!SN:W^Pathfinding_Speed_Bonus1^/1;     [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48;                         [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/0/20/1&y10>0:P1/y50;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48;                         [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/21/41/1&y10>0:P1/y50;


!?FU(OnCombatRound)&v997=1;

!!SN:W^Pathfinding_Speed_Bonus2^/?y1;
!!FU&y1=1:E;
!!SN:W^Pathfinding_Speed_Bonus2^/1;     [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48*-1;                      [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/0/20/1&y10>0:P2/y50;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S0/?y10;                         [Checke ob der Held Pathfinding hat und Speichere in y10]

!!VRy48:S0;                             [Initialise to zero]
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:15+1;
!!en;
!!VRy50:S1+y48*-1;                      [Speed Bonus]

!!SN:W^H3_Pathfinding_0_Hero%Y1^/?y11;  [Checke ob der Held Master Pathfinding hat und Speichere in y11]
!!DO(AC_Function_2)/21/41/1&y10>0:P2/y50;

!?FU(OnBeforeBattleUniversal);          [At Battle End]
!!SN:W^Pathfinding_Speed_Bonus1^/0;     [Reset]
!!SN:W^Pathfinding_Speed_Bonus2^/0;     [Reset]

!?FU(AC_Function_2);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
!!BMx16&x1=1:Sdx2;
*!VRx2&x1=2:*-1;
!!BMx16&x1=2:Sdx2;


!?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1;
!!FU:E;                                 [Disabled]
!!DO(AC_Function_3)/0/155/1:P;          [loop through heroes]

!?FU(AC_Function_3);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S0/?y10;                        [Checke ob der Held Pathfinding hat und Speichere in y10]
!!FU&y10<3:E;
!!SN:W^H3_Pathfinding_0_Hero%X16^/?y11; [Checke ob der Held Grandmaster Pathfinding hat und Speichere in y11]
!!SN:W^H3_Pathfinding_1_Hero%X16^/?y12; [Checke ob der Held Grandmaster Pathfinding hat und Speichere in y11]

!!HEx16&y10=3/y11=1:Wd100/1;            [Add little Bonus Movement 5%]
!!HEx16&y10=3/y12=1:Wd100/1;            [Add little Bonus Movement 5%]

!!HEx16:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEx16:E?y46/?y47/1;                   [Check hero Level]
!!VRy48:Sy47*10;
!!HEx16:Wdy48/1;                        [Add little Bonus Movement dependant on Level]
!!en;

*Pathfinding Master and Grandmaster Bonus reduces penalty for carriying slow troops in army.

Creature speed   Base movement

3                 1500
4                 1560
5                 1630
6                 1700
7                 1760
8                 1830
9                 1900 Base Movement is 1900 Points
10                1960
11 or more        2000

!?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1;
!!DO(AC_Function_135)/0/155/1:P;

!?FU(AC_Function_135);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S0/?y10;                        [Checke ob der Held Pathfinding hat und Speichere in y10]
!!SN:W^H3_Pathfinding_0_Hero%X16^/?y11; [Checke ob der Held Grandmaster Pathfinding hat und Speichere in y11]
!!SN:W^H3_Pathfinding_1_Hero%X16^/?y12; [Checke ob der Held Grandmaster Pathfinding hat und Speichere in y11]
!!FU|y10=0/y11=0:E;                     [Exit if not at least Master Pathfinding]

!!HEx16:C0/0/?y2/?y32; !!MA&y32<>0:Sy2/?y22; [Check Creatures in Hero Army]
!!HEx16:C0/1/?y3/?y33; !!MA&y33<>0:Sy3/?y23; [Get Speed of First Creature]
!!HEx16:C0/2/?y4/?y34; !!MA&y34<>0:Sy4/?y24;
!!HEx16:C0/3/?y5/?y35; !!MA&y35<>0:Sy5/?y25;
!!HEx16:C0/4/?y6/?y36; !!MA&y36<>0:Sy6/?y26;
!!HEx16:C0/5/?y7/?y37; !!MA&y37<>0:Sy7/?y27;
!!HEx16:C0/6/?y8/?y38; !!MA&y38<>0:Sy8/?y28;

!!VRy21:S0;
!!if&y11=1/y12=0;
!!VRy21|y28=8/y27=8/y26=8/y25=8/y24=8/y23=8/y22=8:S30;  [+30 Movement Penalty if lowest speed is 8]
!!VRy21|y28=7/y27=7/y26=7/y25=7/y24=7/y23=7/y22=7:S75;  [+75 Movement Penalty if lowest speed is 7]
!!VRy21|y28=6/y27=6/y26=6/y25=6/y24=6/y23=6/y22=6:S100; [+100 Movement Penalty if lowest speed is 6]
!!VRy21|y28=5/y27=5/y26=5/y25=5/y24=5/y23=5/y22=5:S130; [+130 Movement Penalty if lowest speed is 5]
!!VRy21|y28=4/y27=4/y26=4/y25=4/y24=4/y23=4/y22=4:S165; [+165 Movement Penalty if lowest speed is 4]
!!VRy21|y28=3/y27=3/y26=3/y25=3/y24=3/y23=3/y22=3:S200; [+200 Movement Penalty if lowest speed is 3]
!!en;

!!if&y11=1/y12=1;
!!VRy21|y28=8/y27=8/y26=8/y25=8/y24=8/y23=8/y22=8:S30; [-170 Movement Penalty if lowest speed is 8]
!!VRy21|y28=7/y27=7/y26=7/y25=7/y24=7/y23=7/y22=7:S75; [-240 Movement Penalty if lowest speed is 7]
!!VRy21|y28=6/y27=6/y26=6/y25=6/y24=6/y23=6/y22=6:S100; [-300 Movement Penalty if lowest speed is 6]
!!VRy21|y28=5/y27=5/y26=5/y25=5/y24=5/y23=5/y22=5:S130; [-370 Movement Penalty if lowest speed is 5]
!!VRy21|y28=4/y27=4/y26=4/y25=4/y24=4/y23=4/y22=4:S165; [-440 Movement Penalty if lowest speed is 4]
!!VRy21|y28=3/y27=3/y26=3/y25=3/y24=3/y23=3/y22=3:S200; [-500 Movement Penalty if lowest speed is 3]
!!VRy21:*2;                             [Eliminates Penalty completly]
!!en;
!!HEx16:Wdy21/1; Add Bonus Movement


!?CM5;                                  [Left Click on Adventure Screen to change pathfinding value]
!!CM:S?v3; !!FU&v3<>12:E;

!!OW:C?y1;                              [Get current player]
!!OW:Ay1/?y1;                           [Get active Hero]
!!FU&y1=-1:E;                           [Exit if none]
!!HEy1:S0/?y10;                         [Get pathfinding skill]

**Set all to normal expert value (100 means no penalty)
!!FU(PathfindingValues):P3/3/100;       [Snow]
!!FU(PathfindingValues):P4/3/100;       [Swamp]
!!FU(PathfindingValues):P5/3/100;       [Rough]
!!FU(PathfindingValues):P7/3/100;       [Lava]

!!FU&y10<3:E;                           [Exit if not at least expert]

** if pathfinding specialists decrease movement on these terrains by 1 point per 2 levels
!!HEy1:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y22=0/y21=0;                      [if Pathfinding]
!!HEy1:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:2;                         [5 + Half level of Hero]
!!VRy5:S95-y48;
!!FU(PathfindingValues):P3/3/y5;        [Snow]
!!FU(PathfindingValues):P4/3/y5;        [Swamp]
!!FU(PathfindingValues):P5/3/y5;        [Rough]
!!FU(PathfindingValues):P7/3/y5;        [Lava]
!!en;

; Cost of terrain movement with Pathfinding skill
!?FU(PathfindingValues);
; x1 - terrain , x2 - skill level, x3 - cost of movement in points
!!FU|x1<0/x1>12/x2<0/x2>3/x3<0:E;
!!VRx1:*16; !!VRx2:*4; !!VRy1:S6546704 +x1 +x2; !!UN:Cy1/4/x3;

00    Dirt
01    Sand
02    Grass
03    Snow
04    Swamp
05    Rough
06    Underground
07    Lava
08    Water
09    Rock
10 - dirt road,
11 - gravel road,
12 - cobblestone road)

************************Archery*************************************************
**Master Archery increases the damage done by range attacking creatures by 65% and eliminates obstacle penalty.
**Grandmaster Archery increases the damage done by range attacking creatures by 75% and eliminates range and obstacle penalty.
** See below for Code



************************Logistics***********************************************
*+1 Speed in first Battle Round at Master +1 Speed in Combat at Grandmaster

!?FU(OnBeforeBattleUniversal);          [At Battle End]

!!SN:W^Logistics_Speed_Bonus1^/0;       [Reset]
!!SN:W^Logistics_Speed_Bonus2^/0;       [Reset]


*?BR&v997=0;
!?FU(OnCombatRound)&v997=0;

!!SN:W^Logistics_Speed_Bonus1^/?y1;
!!FU&y1=1:E;
!!SN:W^Logistics_Speed_Bonus1^/1;       [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!DO(AC_Function_4)/0/20/1&y10=3/y11=1:P1;
*!SN:W^H3_Logistics_1_Hero%Y1^/?y11;    [Checke ob der Held Grandmaster Logistics hat und Speichere in y11]
*!DO(AC_Function_4)/0/20/1&y10=3/y11=1:P1;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!DO(AC_Function_4)/21/41/1&y10=3/y11=1:P1;
*!SN:W^H3_Logistics_1_Hero%Y1^/?y11;    [Checke ob der Held Grandmaster Logistics hat und Speichere in y11]
*!DO(AC_Function_4)/21/41/1&y10=3/y11=1:P1;

*?BR&v997=1;
!?FU(OnCombatRound)&v997=1;

!!SN:W^Logistics_Speed_Bonus2^/?y1;
!!FU&y1=1:E;
!!SN:W^Logistics_Speed_Bonus2^/1;       [To run only once]

!!BH0:N?y1;                             [Attacker]
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!SN:W^H3_Logistics_1_Hero%Y1^/?y12;    [Checke ob der Held Master Logistics hat und Speichere in y12]
!!DO(AC_Function_4)/0/20/1&y10=3/y11=1/y12=0:P2;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S2/?y10;                         [Checke ob der Held Logistics hat und Speichere in y10]
!!SN:W^H3_Logistics_0_Hero%Y1^/?y11;    [Checke ob der Held Master Logistics hat und Speichere in y11]
!!SN:W^H3_Logistics_1_Hero%Y1^/?y12;    [Checke ob der Held Master Logistics hat und Speichere in y12]
!!DO(AC_Function_4)/21/41/1&y10=3/y11=1/y12=0:P2;

!?FU(AC_Function_4);
!!BMx16:T?y1;
!!BMx16:N?y2;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
!!if&y2>0;
!!BMx16&x1=1:Sd1;
*!BMx16&x1=2:S?y4;
*!VRy4&y4>=1/x1=2:-1;
*!BMx16&x1=2/y4>=1:Sy4;
!!BMx16&x1=2:Sd-1;
!!en;


!?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1;
!!DO(AC_Function_5)/0/155/1:P;          [loop thru heroes]

!?FU(AC_Function_5);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S2/?y10;                        [Checke ob der Held Logistics hat und Speichere in y10]
!!FU&y10<3:E;
!!SN:W^H3_Logistics_0_Hero%X16^/?y11;   [Checke ob der Held Master Logistics hat und Speichere in y11]
!!SN:W^H3_Logistics_1_Hero%X16^/?y12;   [Checke ob der Held Grandmaster Logistics hat und Speichere in y11]
!!HEx16&y10=3/y11=1:Wd100/1;            [Add little Bonus Movement corresponds to +30% in total]
!!HEx16&y10=3/y12=1:Wd150/1;            [Add little Bonus Movement corresponds to +35% in total]


!?HM-1&1000;                            [More Movement on Water]
!!FU:E;                                 [Disabled for now]
!!HE-1:N?y1 O?y2 S2/?y3;                [get #, owner of  and scouting skill]
!!FU&y3=0:E;                            [exit if not logistics]
!!OW:C?y4;                              [get current player]
!!FU&y2<>y4:E;                          [exit if not current player's hero]
!!OW:Iy4/?y88;
!!FU&y88=1:E;                           [Exit if AI]
!!TRv998/v999/v1000:T?y10/d/d/d/d/d/d/d;[v998,v999,v1000 = x,y and level of the point of destination.]
*!IF:L^%V998 %V999 %V1000  und Land Type is %Y10^;

************************Scouting************************************************
**Master Scouting Master Scouting allows your hero to see 7 squares further into the shroud. **Also, your hero is able to discover hidden treasures and other stuff.
**Grandmaster Scouting **Grandmaster Scouting allows your hero to see 8 squares further into the shroud. Also, your hero is able to discover hidden treasures and other stuff.
*Chance for Random encounter
*[Reveal Extra 2 Radius at Week Start]

!?FU(OnEveryDay)&i^timerIsAi^=0/i^timerOnce^=1/i^timerDay^>1/i^timerWeekDay^=1; [Trigger each monday [Reveal Extra 2 Radius at Week Start]
!!DO(AC_Function_6)/0/155/1:P;          [loop through heroes]

!?FU(AC_Function_6);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:S3/?y10;                        [Checke ob der Held Scouting hat und Speichere in y10]
!!SN:W^H3_Scouting_1_Hero%X16^/?y12;    [Checke ob der Held Grandmaster Scouting hat und Speichere in y11]
*!OW:C?y3; (Check current player)
*!FU&y2<>y3:E; (Abort if not the same)

!!if&y10=3/y12=1;                      [Check current player, Abort if not the same]
  !!HEx16:P?y20/?y21/?y22;              [get hero x/y/level]
  !!HEx16:O?y2;
  !!UN:Sy20/y21/y22/y2/12;              [Reveal 2 Extra Radius with GrandMaster Scouting at Week Start]
  !!UN:R1;                              [redraw screen]
!!en;

**Hint: With Expert Scouting the radius is 8


** start of movement trigger
!?HM-1&1000;                            [continue if scouting is enabled]

!!HE-1:N?y1 O?y2 S3/?y3;                [get #, owner of  and scouting skill]
!!FU(Count_Set_Pieces_2)&y1>=0/y1<=155/y2>=0:Py1/0/0/0/0/?y90; [Count class Set Pieces function X6]
!!HEy1&y1>=0:A2/101/0/?y91;             [101 Pendant of Second Sight]
!!VRy3&y90>=2/y3=0:S1;                  [Activate Scouting Bonus if Adventurer Class Set equipped]
!!VRy3&y91=1/y3=0:S1;                   [Activate Scouting Bonus if Pendant of Second Sight]
!!FU&y3=0:E;                            [exit if not Scouting]
!!OW:C?y4;                              [get current player]
!!FU&y2<>y4:E;                          [exit if not current player's hero]
!!OW:Iy4/?y88;
!!FU&y88=1:E;                           [Exit if AI]

!!HEy1:X?y21/?y22/?y23/?y24/?y25/?y26/?y27; [Check Hero Speciality]
!!VRy50:S0; !!VRy50&y21=0/y22=3:S1;     [Set y50 to 1 if special]

!!SN:W^H3_Scouting_0_Hero%Y1^/?y11;     [Checke ob der Held Master Scouting hat und Speichere in y11]
!!SN:W^H3_Scouting_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Scouting hat und Speichere in y12]

!!HEy1:E?y15/?y16/1;                    [Get Hero Level]
!!VRy17:Sy16:10+1;                      [+1 Scouting Radius per 10 hero levels]
!!VRy10:S5;
!!VRy10&y3=1:+1;                        [Basic +1]
!!VRy10&y3=2:+1;                        [Advanced +1]
!!VRy10&y3=3:+1;                        [Expert +1]
!!VRy10&y3=3/y11=1/y12=0:+1;            [Reveal 1 Extra Radius with Master Scouting]
!!VRy10&y3=3/y11=1/y12=1:+1;            [Reveal 2 Extra Radius with GrandMaster Scouting]
*!VRy10&y21=0/y22=3:+y17;               [Reveal  Extra Radius with Specialist Scouting]
!!UN:Sv998/v999/v1000/y2/y10;           [Reveal total]

!!VRy5:S0;
!!VRy30&y3=1:S925;                      [Basic]
!!VRy30&y3=2:S875;                      [Advanced]
!!VRy30&y3=3:S825;                      [Expert]
!!VRy30&y3=3/y11=1/y12=0:S800;          [Master]
!!VRy30&y3=3/y11=1/y12=1:S750;          [Grandmaster]
!!VRy30&y21=0/y22=3:-100;               [Increased chance for Scouting Specialists ~0,5% higher]
!!VRy30&y90>=2:-100;                    [If Adventurer Class Set increases chance ~0,5% higher]
!!VRy30&y91=1:-75;                      [Pendant of Second Sight increases chance ~0,5% higher]

!!VRy5&y3=1:Ty30;                       [set random roll to 3.0% (14/470)]
!!VRy5&y3=2:Ty30;                       [set random roll to 3.2% (14/430)]
!!VRy5&y3=3:Ty30;                       [set random roll to 3.5% (14/400)]

!!VRy60:S0T1;                           [Random Coinflip Generator]
!!VRy5&y5=15/y60=0:S5;                  [Only 50% chance to get an artifact]
!!VRy5&y5=16/y60=0:S5;                  [Only 50% chance to get an spell]

*!VRy5:S5; ** TEST**

!!FU(Improved_Scouting_Bonus)&y1>=0/y1<=155/y3>=0/y5<=17:Py1/y3/y2/y5/y50; [do scouting function - and pass Hero Number/Scouting SkillLevel/Owner/RandomRoll/Specialist status y50]
** end of movement trigger


!?FU(Improved_Scouting_Bonus);
** function for scouting    x1=hero number   x2=scouting  x3=Hero Owner  x4=Encouter  x5=Specialist

!!HEx1:B0/?z700;                        [get hero's name]
!!HEx1:R2/?y1;                          [get hero's sex]
!!VRz701&y1=0:Sz199130;
!!VRz701&y1=1:Sz199131;
!!VRz702&y1=0:Sz199132;
!!VRz702&y1=1:Sz199133;
!!VRz703&y1=0:Sz199134;
!!VRz703&y1=1:Sz199135;
!!HEx1:P?y80/?y81/?y82;                 [get hero's position]
!!VRy3:S11 +x2;                         [set scouting picture]


!!if&x4=1;
!!VRy1:S10R10;
!!VRy1&x5=1:+5;
!!IF:Q2/20/y3/35/y1/1/z199136;          [1= 20 Spell Points]
!!HEx1:Idy1/1;                          [give 20 spell points] changed]
!!en;

!!if&x4=2;
!!HEx1:E?y5/?y6/1;                      [get hero's level]
!!VRy60:S1Ty6*200+500R1000;
!!VRy60&x5=1:+1000;
!!IF:Q2/20/y3/6/y60/1/z199137;          [2= Gold]
!!OW:Rx3/6/dy60;                        [give gold]
!!en;

!!if&x4=3;                             [3=  small resources]
!!VRy61:S0T5;                           [random resource 0 to 5]
!!VRy60:S1T3;                           [random quantity 1 to 3]
!!VRy60&x5=1:+2;
!!VRy60&y61=0:*3:2;                     [double for wood]
!!VRy60&y61=2:*3:2;                     [double for ore]
!!IF:Q2/20/y3/s/y60/1/z199138;
!!OW:Rx3/y61/dy60;                      [give the resources]
!!en;

!!if&x4=4;
!!VRy61:S0T5;                           [random resource 0 to 5]
!!VRy60:S3T5;                           [random quantity 4 to 6]
!!VRy60&x5=1:+2;
!!VRy60&y61=0:*3:2;                     [double for wood]
!!VRy60&y61=2:*3:2;                     [double for ore]
!!IF:Q2/20/y3/y61/y60/1/z199139;        [4= large resources]
!!OW:Rx3/y61/dy60;                      [give resources]
!!en;

!!if|x4=5/x4=17;
!!FU(pick_a_monster):P?y4;              [call function (pick_a_monster) to pick monster]   5= pick monster  give hero]
!!VRy1:S0T2;
  !!if&y1=2;
    !!HEx1:B2/?y1;                      [Get faction]
    !!VRy4|y1=0/y1=1:S0R13;             [Castle]
    !!VRy4|y1=2/y1=3:S14R13;
    !!VRy4|y1=4/y1=5:S28R13;
    !!VRy4|y1=6/y1=7:S42R13;
    !!VRy4|y1=8/y1=9:S56R13;
    !!VRy4|y1=10/y1=11:S70R13;
    !!VRy4|y1=12/y1=13:S84R13;
    !!VRy4|y1=14/y1=15:S97R13;
    !!VRy4|y1=16/y1=17:S112R13;         [Conflux]
    !!VRy4|y4=122/y4=124:S127;
    !!VRy6:S0T6;                        [Generate random slot]
    !!HEx1:C0/y6/?y40/?y5;              [Check creature slot]
    !!VRy4&y40>=0/y5>0:Sy40;            [Change monster to one of the hereos army]
    !!if|y4=-1/y5=0;
      !!VRy6:S0T6;                      [Generate random slot]
      !!HEx1:C0/y6/?y40/?y5;            [Check creature slot]
      !!VRy4&y40>=0/y5>0:Sy40;          [Change monster to one of the hereos army]
    !!en;
  !!en;

!!VRy1:S0T2;
!!VRy4&x1=48/y1=1:S46;                  [HS1]
!!VRy4&x1=48/y1=2:S47;
!!VRy2:S84R13;
!!VRy4&x1=109/y1=1:Sy2;                 [HS2]
!!VRy4&x1=109/y1=2:Sy2;

!!MA:Gy4/?y60;                          [get 1 weeks production]
!!VRy60:Sy60 R2;                        [**]
!!MA:Ly4/?y5;                           [Get Level of Monster]
!!if&i^timerDay^<25;
!!VRy4|y4=132/y4=133/y4=134/y4=135:S137;[OP Dragons cannot be found in first 14 days and are set to Sharpshooters instead]
!!en;
!!VRy4&y5=6/i^timerDay^<20:S137;        [Level 7 creatures cannot be found in first two weeks gets changes to Sharpshooters]
!!VRy4&y5=5/i^timerDay^<8:S138;         [Level 6 creatures cannot be found in first week gets changes to Halflings]

!!UN:N3/z704/y4/0;                      [refresh get monster name]
!!UN:N3/z705/y4/1;                      [refresh get monsters name]
!!IF&y60=1:Q2/20/y3/1/z199140;
!!IF&y60>1:Q2/20/y3/1/z199141;
!!HEx1&1000:Cy4/y60/-1/0/-1/0/-1/0/-1/0/-1/0/-1/0; [give creatures]
!!en;

!!if&x4=6;
!!IF:Q2/20/y3/14/1/1/z199142;           [6= +1moral]
!!HEx1:R0/d1;                           [+1 morale]
!!en;

!!if&x4=7;
!!IF:Q2/20/y3/11/1/1/z199143;           [7=+1luck]
!!HEx1:R1/d1;                           [+1 luck]
!!en;

!!if&x4=8;
!!HEx1:E?y5/?y6/1;                      [get hero's level]
!!VRy60:Sy6*150R500;                    [(level + 0-20) x 50]
!!VRy60&x5=1:Sy60R1000;                 [Specialist]
!!VRy60&y6>15:*2; !!VRy60&y6>22:*2; !!VRy60&y6>42:*2; !!VRy60&y6>50:*2; [Increase Exp with level so it doesnt get useless]
!!IF:Q2/20/y3/17/y60/1/z199144;         [8= experience]
!!HEx1:Edy60;                           [give experience]
!!en;

!!if&x4=9;
!!IF:Q2/20/y3/22/21/1/z199145;          [9= increase movement]
!!HEx1:Wd400/1;                         [increase movement]
!!en;

!!if&x4=10;
!!IF:Q2/20/y3/24/21/1/z199146;
!!VRy60:S3 *x2 +10;                     [area]                            10= reveal area]
!!VRy60&x5=1:+3;
!!UN:Sy80/y81/y82/x3/y60;               [reveal area]
!!en;

!!if|x4=11/x4=12/x4=13;
!!FU(pick_a_monster):P?y4;              [call function (pick_a_monster) to pick monster]      12 = fight monsters]
!!MA:Hy4/?y60;                          [get AdvMapH]
!!HEx1:E?y90/?y91/1;
!!HEx1:F?y92/?y93/?y94/?y95;
!!VRy78:Sy4;
!!VRy78:%14;

!!VRy45&y78<15:S1T1;
!!VRy45&y78<12:S2T1;
!!VRy45&y78<10:S3T2;
!!VRy45&y78<5:S6T2;

*!IF:M^Wert von y78 is%Y78 und Wert von x45 is%x45 und Monsternummer is %Vs^;
!!VRy5:Sy91 *y92 *y45;                  [Level*Attack from Hero]
!!VRy5::2;                              [Halve number of creatures to fight]
!!VRy5&y5<50:S25R50;
!!VRy47:Sy5;
!!IF:Q2/20/y3/21/y4/2/z199147;
!!SN&2:W^Scouting_Fight_Trigger^/1;
!!SN&-2:W^Scouting_Fight_Trigger^/0;
!!HEx1&2:Ty80/y81/y82/y4/y5;            [fight monsters]
!!UN:R1;
!!en;

!!if&x4=14;                            [14=  Give Mithril]
!!UN:P36/?v1;                           [Check if Mithril script is enabled: v1]
!!FU&v1=0:E;                            [Exit if Mithril is not enabled]
!!VRy61:S7;                             [random resource 6 to 7]
!!VRy60:S1;                             [random quantity 1 to 1]
!!VRy60&x5=1:+1;
!!IF:Q2/20/y3/y61/y60/1/z199149;
!!OW:Rx3/y61/dy60;                      [give the resources]
!!en;

!!if&x4=15;                            [15=  Give Artifact]
!!VRy1:S0T2;
!!UN|y1=0/y1=1:J6/2/?y2;                [get a random Treasure artifact  2/3 chance]
!!UN&y1=2:J6/4/?y2;                     [get a random Minor artifact  1/3 chance]
!!IF:Q2/20/y3/8/y2/1/z199150;
!!HEx1:Ay2;                             [Give Artifact]
!!en;

!!if&x4=16;                            [16=  Teach Spell]
  !!HEx1:A2/0/d/?y15;                   [Check for Spell Book]
  !!FU&y15=0:E;                         [Exit if no Spell Book]
  !!FU$spell$:P1/4/0/0/1/1/6/7/8/9;     [Function to generate a random level 1-4 spell which skips banned spells]
  !!HEx1:S7/?y14;                       [7 Wisdom]
  !!SSy-99:L?y5;                        [Spell Level]
  !!if&y-99>=0/y-99<=69;               [Valid Spell]
    !!FU&y5=5/y14<3:E;                  [Exit if Wisdom level not high enough]
    !!FU&y5=4/y14<2:E;
    !!FU&y5=3/y14<1:E;
    !!IF:Q2/20/y3/9/y-99/1/z199151;
    !!HEx1:My-99/1;                     [Give Spell]
  !!en;
!!en;

!!UN:R1;                                [redraw hero screen]


!?FU(OnAfterBattleUniversal)&1000;

!!SN:W^Scouting_Fight_Trigger^/?y1;
!!SN:W^Scouting_Fight_Trigger^/0;       [Reset Trigger]
!!FU&y1<>1:E;

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU&y1<0:E;                            [Exit if no Hero]
!!HEy1:O?y2;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y3;       [Check Owner Before Fight]

!!FU&y2<>y3:E;                          [Prevent to give Bonus if retreat]
!!FU&y2=-1:E;

!!VRy96:S1T4;
20% chance to gain nothing
!!SN&y96=2:T^AC_Misc.Scout_Attack1^/?z-9 Iz-9/?z-9;
!!SN&y96=3:T^AC_Misc.Scout_Defense1^/?z-9 Iz-9/?z-9;
!!SN&y96=4:T^AC_Misc.Scout_SP1^/?z-9 Iz-9/?z-9;
!!SN&y96=5:T^AC_Misc.Scout_Knowledge1^/?z-9 Iz-9/?z-9;

!!IF&y96=2:Q2/31/1/1^%Z-9^;
!!HEy1&y96=2:Fd1/d/d/d;
!!IF&y96=3:Q2/32/1/1^%Z-9^;
!!HEy1&y96=3:Fd/d1/d/d;
!!IF&y96=4:Q2/33/1/1^%Z-9^;
!!HEy1&y96=4:Fd/d/d1/d;
!!IF&y96=5:Q2/34/1/1^%Z-9^;
!!HEy1&y96=5:Fd/d/d/d1;

!!UN:R1;                                [redraw hero screen]
!!SN:W^Scouting_Fight_Trigger^/0;


** function to pick a monster
!?FU(pick_a_monster);

!!VRy1:S0T144;                           [random 0 to 144]
!!VRy1&y1=122:S136;
!!VRy1&y1=124:S134;
!!VRy1&y1=126:S137;
!!VRy1&y1=128:S139;
!!UN:N3/z704/y1/0;                       [get monster name]
!!UN:N3/z705/y1/1;                       [get monsters name]
!!VRx1:Sy1;



***************************Diplomacy********************************************
*Chance to increase Stack Size of Hero after every fight*
!?FU(OnGameEnter)&i^timerDay^=1;        [At gamestart]

!!UN:U54/-1/?y2;
!!VRv1:S-1;
!!DO(ACM_Monster_Agression)/1/y2/1:P;       [Loop through all monsters on the map]

!?FU(ACM_Monster_Agression);

!!VRv1&x16=1:S-1;
!!UN:U54/-1/-1/1;
!!MOv1/v2/v3:R?y1/1;                    [Get the Agression for all Monsters]
!!FU&y1=0:E;                            [Exit]
!!MOv1/v2/v3:R10/1;                     [Set all Monster to never Join at Map Start]

!?OB54;                                 [When visiting a Monster]
!!FU:E;                                 [Disabled]
!!MO998:R?y1/1;
!!FU&y1=0:E;                            [If set to always join exit function]
!!MO998:R10/1;                          [Set aggression level to max, so basically Diplomacy is disabled]


!?FU(OnAfterBattleUniversal)&1000;      [After Combat]

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU&y1<0:E;

!!HEy1:O?y25;                           [Check hero owner]
!!OW:C?y26;                             [Check current player]
!!FU&y25<>y26:E;                        [Abort if not the same]
!!SN:W^Hero_Attacker_Owner0^/?y2;       [Check Owner Before Fight]
!!FU|y25<>y2/y25=-1:E;                  [Exit if not the same as before fight]

!!HEy1:S4/?y10;                         [Check Diplomacy]
!!FU&y10=0:E;                           [Exit if not]

!!SN:W^H3_Diplomacy_0_Hero%Y1^/?y11;    [Checke ob der Held Master Diplomacy hat und Speichere in y11]
!!SN:W^H3_Diplomacy_1_Hero%Y1^/?y12;    [Checke ob der Held Grandmaster Diplomacy hat und Speichere in y12]

!!VRy4&y10=1:S20; !!VRy4&y10=2:S24; !!VRy4&y10=3:S28; !!VRy4&y10=3/y11=1/y12=0:S32; !!VRy4&y10=3/y11=1/y12=1:S35; [Chance to join]

!!HEy1:A2/66/?y49/?y66;
!!HEy1:A2/67/?y49/?y67; !!VRy4&y67=1:+10;[67 Diplomat's Ring    +10% chance to attract]
!!HEy1:A2/68/?y49/?y68;

!!VRy4&y66=1/y67=1/y68=1:+10;           [Double Bonus if complete Set (+20%)]

!!HEy1:X?y61/?y62/?y63/?y64/?y65/?y56/?y57; [Check Hero Diplo Speciality]
!!if&y61=0/y62=4;                      [if Diplomacy]
  !!HEy1:E?y46/?y47/1;                  [Check hero Level]
  !!VRy48:Sy47:4+1;                     [Chance to attract]
  !!VRy49:Sy47:10+1;                    [Number of creatures]
  !!VRy50:Sy47:2+1;                     [Reduced hiring costs]
  !!VRy4:+y48;                          [Add chance to attract if Diplo Speciality]
!!en;

66    Statesman's Medal         Reduces Hiring Cost by -15%
67    Diplomat's Ring           Chance to attract +10%
68    Ambassador's Sash         Creature Numbers +2%
And Set doubles all bonuses

!!VRy21:S0T100;
!!FU&y21>y4:E;                          [Exit if y4 smaller random R100 Roll]

!!SN:W^H3_Diplomacy_Creature^/-1;
!!SN:W^H3_Diplomacy_Creature_Anzahl^/-1;

!!SN:W^H3_Diplomacy_0_Hero%Y1^/?y11;
!!SN:W^H3_Diplomacy_1_Hero%Y1^/?y12;

!!VRy90:S0;
[:loop50]; loop is label name inside current trigger
!!VRy90:+1;
!!VRy20:S0T6;
!!FU(H3_Diplomacy_Growth)&y10>0:Py1/y10/y20;
!!FU&y90=100:E;                         [Exit complete Function if no Creature can be found]
!!SN:W^H3_Diplomacy_Creature^/?y5;
!!SN:W^H3_Diplomacy_Creature_Anzahl^/?y6;
!!SN|y5=-1/y6=-1:G[loop50];
******

!!VRy40:S6;
!!VRy40&y68=1:+2;                       [+2% growth if Ambassador's Sash]
!!VRy40&y66=1/y67=1/y68=1:+2;           [+2% growth if complete set]
!!VRy40&y61=0/y62=4:+y49;               [+y49% growth if specialist]

******
!!UN:N3/2/y5/1;                         [Get Monster Name in z1]
!!MA:Cy5/6/?y22;
!!VRy23:S2Ty40+100;                     [Range 2% til y40% for amount of joiners]
!!VRy3:Sy6*y23:100-y6;                  [Calculate y23% of Creatures]
!!VRy3&y3=0:S1;

!!MA:Ly5/?y70;
!!VRy3&y70<=4/y3<=1:S2T2;               [If Monster level 5 and below 2 set to 2-4]
!!VRy3&y70<=3/y3<=2:S3T3;               [If Monster level 3 and 4 and below 4 set to 3-6]
!!VRy3&y70<=1/y3<=5:S5T5;               [If Monster level 1 and 2 and below 6 set to 5-10]

!!VRy22:*y3;                            [Total Hiring Costs]
!!VRy22:*150:100;                       [Increase costs by 50%]
!!VRy80:S100;
!!VRy80&y22>0/y61=0/y62=4:-y50;         [Reduce hiring cost by speciality]
!!VRy80&y22>0/y66=1:-15;                [Reduce hiring cost by artifact (15%)]
!!VRy80&y22>0/y66=1/y67=1/y68=1:-15;    [Reduce hiring cost by artifact -(15%) if set complete]
!!VRy22:*y80:100;                       [Calc new costs]
!!VRy22&y22<1:S1;                       [So costs can never be negative]

*!IF:M^
Chance  is %Y3
Chance to attract is %Y4
Chance to growth is %Y23
*Reduced cost is %Y80^;

!!SN:T^AC_Misc.Diplomacy 1^/?z4/^gold^/y22/^value^/y3;
!!SN:Iz4/?z4;
!!IF:Q2/21/y5/2/z4;

!!if&2;
!!OW:Ry25/6/?y27;
!!VRy28:Sy22*-1;
!!OW&y22<y27:Ry25/6/dy28;
!!HEy1&y22<y27:C0/y20/d/dy3/0/0;        [Add creatures to Hero Army]
!!UN&y22<y27:R1;

!!SN:T^AC_Misc.Diplomacy 2^/?z4 Iz4/?z4;
!!IF&y22>y27:M^%Z4^;
!!OW&y22>y27:Ry25/6/d1500;
!!UN&y22>y27:R2;
!!en;


!?FU(H3_Diplomacy_Growth);

!!HEx1:C0/x3/?y1/?y2;
!!FU|y2<2/y1<0:E;                       [Exit if stack only 1 or no creature found]
!!SN:W^H3_Diplomacy_Creature^/y1;       [Checke ob der Held Master Diplomacy hat und Speichere in y11]
!!SN:W^H3_Diplomacy_Creature_Anzahl^/y2;[Checke ob der Held Master Diplomacy hat und Speichere in y11]


***************************Navigation*******************************************
*+1 to all primary skills at Bas Adv  when in battle
*+2 to all primary skills at expert  when in battle
*+2 Master
*+3 GM

!?BF&1000;                              [Combat Start]

!!FU:E;                                 [Disabled and Replaced with Nobility]
!!BA:H0/?y1;                            [Attacker]
!!HEy1:S5/?y3;                          [Navigation]
!!SN:W^H3_Navigation_0_Hero%Y1^/?y11;   [Checke ob der Held Master Navigation hat und Speichere in y11]
!!SN:W^H3_Navigation_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Navigation hat und Speichere in y12]
!!VRy4&y3=1:S1; !!VRy4&y3=2:S1; !!VRy4&y3=3:S2; !!VRy4&y3=3/y11=1:S2; !!VRy4&y3=3/y12=1:S3;
!!DO(AC_Function_7)/0/20/1&y3>0:Py4;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;                            [Exit if no Navigation]
!!HEy4:S5/?y3;                          [Navigation]

!!SN:W^H3_Navigation_0_Hero%Y4^/?y11;   [Checke ob der Held Master Navigation hat und Speichere in y11]
!!SN:W^H3_Navigation_1_Hero%Y4^/?y12;   [Checke ob der Held Grandmaster Navigation hat und Speichere in y12]

!!VRy4&y3=1:S1; !!VRy4&y3=2:S1; !!VRy4&y3=3:S2; !!VRy4&y3=3/y11=1:S2; !!VRy4&y3=3/y12=1:S3;
!!DO(AC_Function_7)/21/41/1&y3>0:Py4;

!?FU(AC_Function_7);                    [increase Units Stats]

!!BMx16:Adx1;
!!BMx16:Ddx1;


*-------------------------------Leadership------------------------------------------*
*Master Leadership +4 Morale, GrandMaster +5 Morale
**Deal Extra damage in the Current Battle Round if Stack Had Moral
!?MF1;                                  [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Leadership_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Leadership_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:S6/?y81;                        [Checke current hero Leadership hat]
!!SN:W^H3_Leadership_0_Hero%Y99^/?y11;  [Checke ob der Held Master Leadership hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y99^/?y12;  [Checke ob der Held Grandmaster Leadership hat und Speichere in y12]
!!FU|y81<3/y11=0:E;                     [Exit if not Expert Leadership]

!!SN:W^Leadership_Current_battle_round^/?y3;
!!SN:W^Leadership_Stack_had_Moral^/?y51;

!!if&y3=v997/y1=y51;
!!MF:F?y6;
!!VRy7&y11=1/y12=0:Sy6 *110:100;        [10% Extra Damage]
!!VRy7&y11=1/y12=1:Sy6 *125:100;        [25% Extra Damage]
!!MF:Fy7;
!!VRy8:Sy7 -y6;

!!BA:Q?f;
!!SN&y11=1/y12=0:T^AC_Misc.Leadership 1^/?z-1/^damage^/y8;
!!SN&y11=1/y12=1:T^AC_Misc.Leadership 2^/?z-1/^damage^/y8;
!!MM&f=0:Sz-1;
!!SN:W^Leadership_Current_battle_round^/-1;
!!SN:W^Leadership_Stack_had_Moral^/-1;
!!en;
!!en;
!!en;

!?BG0;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;

!!if&y2=y40;                           [so it only works for attacking not defending]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:S6/?y81;                        [Checke current hero Leadership hat]
!!SN:W^H3_Leadership_0_Hero%Y99^/?y11;  [Checke ob der Held Master Leadership hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y99^/?y12;  [Checke ob der Held Grandmaster Leadership hat und Speichere in y11]
!!FU|y81<3/y11=0:E;

!!BMy1:F?i;                             [read flags]
!!VRi:&16777216;                        [just look at moral bit]
!!SN&i>0:W^Leadership_Stack_had_Moral^/y1; [Save stack number]
!!SN&i>0:W^Leadership_Current_battle_round^/v997; [Save current battle round]
!!en;




**************************Wisdom************************************************
* Crit chance for spells equal heroes level
**Master Wisdom allows your hero to learn fifth level spells. Damage spells cast by your hero have a 15% chance to do +50% damage.

!?MR1&1000;                             [Magic Res Trigger for Crit]
!!FU:E;                                 [Disabled and replaced by Critical Sorcery Mod]
!!SN:W^Critical_Sorcery_Mod^/?y1;       [Critical Sorcery Mod Active]
!!FU&y1=1:E;                            [Exit if Critical Sorcery Mod Active]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit if Quick combat]

!!BG:Q?y4;
!!BA:Hy4/?y4;
!!FU&y4<=0:E;                           [Exit if no Hero]

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere 1 in y2]
!!FU&y2<=9|y2>69:E;
!!MR:F?y3;                              [Speichere DMG in y3]
!!FU&y3<=0:E;

!!BG:H?y4;                              [Number of a hero owner (-1=no hero)   in y4]
!!HEy4:S7/?y6;                          [Checke ob der Held  Weisheit hat und Speichere in y6]
!!HEy4:S18/?y7;                         [Checke ob der Held Scholar hat und Speichere in y6]

*!FU&y6=0:E;
!!SN:W^H3_Wisdom_0_Hero%Y4^/?y30;       [Checke ob der Held Master Leadership hat und Speichere in y30]
!!SN:W^H3_Wisdom_1_Hero%Y4^/?y31;       [Checke ob der Held Grandmaster Leadership hat und Speichere in y31]
*Basic       : +6%  Crit Chance +10% Crit Damage
*Advanced    : +8%  Crit Chance +15% Crit Damage
*Expert      : +10% Crit Chance +20% Crit Damage
*Master      : +15% Crit Chance +25% Crit Damage
*Grandmaster : +20% Crit Chance +30% Crit Damage
!!SN:W^H3_Scholar_0_Hero%Y4^/?y32;      [Checke ob der Held Master Leadership hat und Speichere in y32]
!!SN:W^H3_Scholar_1_Hero%Y4^/?y33;      [Checke ob der Held Grandmaster Leadership hat und Speichere in y33]
!!SN:W^H3_Hero%Y4_Crit_Chance^/?y34;
!!SN:W^H3_Hero%Y4_Crit_Damage^/?y35;

!!MR:N?y5;                              [Creature which took magic damage]
!!BG:Q?y13;
!!BMy5:I?y12;

!!if&y13<>y12;                         [Own Units Cannot be Hit Critical]
!!if&y5>=0/y5<=41;
!!HEy4:E?y15/?y16/1;                    [Checke das Level vom Helden und Speichern in y16]

!!VRy9:S0T99;                           [y9 chance to crit (0..99)]

!!SN:W^H3_Hero%Y4_Crit_Chance^/?y50;
!!SN:W^H3_Hero%Y4_Crit_Damage^/?y51;

!!VRy16:S0;
!!VRy16&y30=1:+15;                      [15% Chance with Master]
!!VRy16&y31=1:+15;                      [30% Chance with GrandMaster]

!!VRy16&y7=1:+6;                        [15% Chance with Master]
!!VRy16&y7=2:+8;                        [15% Chance with Master]
!!VRy16&y32=0/y33=0/y7=3:+10;           [15% Chance with Master]
!!VRy16&y32=1/y33=0/y7=3:+15;           [30% Chance with GrandMaster]
!!VRy16&y32=1/y33=1/y7=3:+20;           [30% Chance with GrandMaster]

!!if&y9<y16;
!!VRy99:S100;

!!VRy99:+50;                            [Normaler Crit wenn LvL kleiner als Random Wert ist]
!!VRy99:+y51;                           [Global Modifier]

!!VRy99&y7=1:+10;                       [15% Chance with Master]
!!VRy99&y7=2:+15;                       [15% Chance with Master]
!!VRy99&y32=0/y33=0/y7=3:+20;           [15% Chance with Master]
!!VRy99&y32=1/y33=0/y7=3:+25;           [30% Chance with GrandMaster]
!!VRy99&y32=1/y33=1/y7=3:+30;           [30% Chance with GrandMaster]

!!if|y2=24/y2=25/y2=26;                [Death Ripple, Destroy Undead and Armageddon get only half crit damage with Scholar or Artifacts]
!!VRy99:-25;
!!en;

!!VRy3:*y99:100;

!!MR:Fy3;                               [apply new damage]
!!BMy5:V82;                             [show crit animation]
!!en;
!!en;
!!en;


**************************Mysticism*********************************************
**Master Adds 15 Points
**GrandMaster Adds 25 Points per Round

*Handels all Spell Point Regeneration aswell*

!?FU(OnEveryDay)&i^timerOnce^=1/i^timerIsAi^=0;
!!DO(AC_Function_8)/0/155/1:P;          [loop thru heroes]

!?FU(AC_Function_8);
*** Spell Point bonus ***
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]

!!HEx16:S8/?y1;                         [(Check level of Mysticism)]
*!FU&y1=0:E; (Abort if none)

!!SN:W^H3_Mysticism_0_Hero%X16^/?y11;   [Checke ob der Held Master Mysticism hat und Speichere in y11]
!!SN:W^H3_Mysticism_1_Hero%X16^/?y12;   [Checke ob der Held Grandmaster Mysticism hat und Speichere in y12]
!!SN:W^H3_Intelligence_0_Hero%X16^/?y21;[Checke ob der Held Master Mysticism hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X16^/?y22;[Checke ob der Held Grandmaster Mysticism hat und Speichere in y12]

!!FU(Intelligence_Set_Spell_Points)&x16>=0/x16<=155:Px16/0/?y5/1; [Return Max possible spell points for left Hero]

!!HEx16:I?y7/1;                         [get current spell points]

**Set regen Rate**
!!VRy8:S0;
!!VRy8&y1=1:S6;                         [Basic]
!!VRy8&y1=2:S10;                        [Advanced]
!!VRy8&y1=3/y11=0/y12=0:S15;            [Expert]
!!VRy8&y1=3/y11=1/y12=0:S20;            [Master Mysticism]
!!VRy8&y1=3/y11=1/y12=1:S30;            [Grandmaster Mysticism]

!!HEx16:A2/73/?y70/?y72;                [73 Charm of Mana]
!!VRy8&y72=1:+3;
!!HEx16:A2/74/?y70/?y72;                [74 Talisman of Mana]
!!VRy8&y72=1:+4;
!!HEx16:A2/75/?y70/?y72;                [75 Mystic Orb of Mana]
!!VRy8&y72=1:+5;
!!HEx16:A2/138/?y70/?y72;               [138 Wizard's Well]
!!VRy8&y72=1:+999;

**Add regen if Specialists
!!HEx16:X?y50/?y51/?y60/?y60/?y60/?y60/?y60; [Check Hero Speciality]
!!HEx16:E?y52/?y53/1;                   [Get Level of Hero]
!!VRy54:Sy53:2;
!!VRy8&y50=0/y51=8:+y54;                [Add Spell Points for Mysticism Specialists  Dont know why they need -1?]
*!IF:M^Current Spell Points %Y7 Add %Y8 and Speciality gives %Y54^;
**

!!VRy9:Sy8;
!!VRy8:+y7;                             [add current spell points]
!!VRy9&y8>y5:Sy5 -y7;                   [if under normal max now, but over after, set to normal after]
!!VRy9&y7>=y5|y8<0:S0;                  [if result is normal max, or negative, set to zero]
!!HEx16:Idy9/1;                         [Add hero spell points  Changed]


************************Luck****************************************************
**Chance for Bonus Luck before Battles
**Changed how Luck works, now 5 is max, after that damage increases, also negative Luck up to -5
Taken from Algor Era Scripts
** M/GM Luck gives +4/5 Luck
*?HM-1;
*!HE-1:R1/?y9;
*!HE-1:Ed/70/1;
*!IF:L^current Luck is %Y9^;
*!HE127:X0/10; Luck

!?FU(OnHeroScreenMouseClick);           [Luck click]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>117/v6<>512/v5=13:E;           [If not Luck Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y1;                            [Get current hero # 9 Luck]
!!FU(Get_Luck_Moral):Py1/9/?y10;
!!HEy1:R1/?y9;
!!VRy10:+y9;                            [plus temporarily modifier]
!!SN:W^H3_Luck_0_Hero%Y1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%Y1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
!!VRy10&y11=1:-1;                       [compensate temporarily modifier to display correct value]
!!VRy10&y12=1:-1;                       [compensate temporarily modifier to display correct value]
!!VRy5&y10<=5:S150;                     [50% damage with Luck up to 5]
!!VRy8:Sy10-5;
!!VRy5&y8>0:S10*y8+150;
!!HEy1:S9/?y3;
!!VRy20&y3=0:S0; !!VRy20&y3=1:S10; !!VRy20&y3=2:S15; !!VRy20&y3=3/y11=0/y12=0:S20; !!VRy20&y3=3/y11=1/y12=0:S25; !!VRy20&y3=3/y11=1/y12=1:S30; [Increase +10-30% Luck damage per Skill]
!!VRy5:+y20;
!!HEy1:X?y23/?y24/?y25/?y25/?y25/?y25/?y25; [Check Hero Speciality]
!!if&y23=0/y24=9;                      [If Luck Specialists]
  !!HEy1:E?y47/?y48/1;                  [Get Hero Level]
  !!VRy5:+10+y48;                       [Add 10 plus 1 percent per level Luck damage]
!!en;
!!VRy6&y10=0:S0; !!VRy6|y10=1/y10=-1:S4; !!VRy6|y10=2/y10=-2:S7; !!VRy6|y10=3/y10=-3:S10; !!VRy6|y10=4/y10=-4:S12; !!VRy6|y10>=5/y10<=-5:S15; [Set Luck Strike Chance]
!!FU(Count_Set_Pieces):Py1/0/0/0/0/?y95;[Check for The Adventures Fidelity]
!!if&y95=4;
!!VRy6&y10=6:S16; !!VRy6&y10=7:S17; !!VRy6&y10=8:S18; !!VRy6&y10=9:S19; !!VRy6&y10=10:S20; !!VRy6&y10=11:S21; !!VRy6&y10=12:S22; !!VRy6&y10=13:S23; !!VRy6&y10=14:S24; !!VRy6&y10>=15:S25; [Set Luck Strike Chance]
!!en;
!!VRy7:Sy10;                            [Set luck]
*!IF:M^Current Luck is %Y10 and Temp is %Y9  and y7 is %Y7^;
!!SN&y10>0:T^AC_Misc.Luck_Positive^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!SN&y10=0:T^AC_Misc.Luck_Neutral^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!SN&y10<0:T^AC_Misc.Luck_Negative^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!IF&y10>0:Q1/11/0/4/z2;                [show description for Hero Speciality when right click]
!!IF&y10=0:Q1/12/0/4/z2;                [show description for Hero Speciality when right click]
!!IF&y10<0:Q1/13/0/4/z2;                [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;

!?FU(OnHeroScreenMouseClick);           [Morale Icon click]

!!FU:E;                                 [Disable Morale]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>116/v6<>512/v5=13:E;           [If not Luck Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y1;                            [Get current hero]
!!FU(Get_Luck_Moral):Py1/6/?y10;
!!HEy1:R0/?y9;
!!VRy10:+y9;                            [plus temporarily modifier]
!!VRy5&y10<=6:S100;                     [100% damage with Morale up to 6]
!!VRy8:Sy10-6;
!!VRy5&y8>0:S10*y8+150;
!!VRy6:S3*y10;                          [3% chance per point of Morale]
!!VRy7:Sy10;                            [Set Morale]

!!SN&y10>0:T^AC_Misc.Morale_Positive^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!SN&y10=0:T^AC_Misc.Morale_Neutral^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!SN&y10<0:T^AC_Misc.Morale_Negative^/?z2/^damage^/y5/^chance^/y6/^value^/y7;
!!IF&y10>0:Q1/14/0/4/z2;                [show description for Hero Speciality when right click]
!!IF&y10=0:Q1/15/0/4/z2;                [show description for Hero Speciality when right click]
!!IF&y10<0:Q1/16/0/4/z2;                [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;

!?FU(Get_Luck_Moral);
*x1=Hero Number, x2=Luck9 or Moral6, x3=Returns value
!!VRy10:S0; !!VRy11:S0; !!VRy12:S0; !!VRy13:S0; !!VRy14:S0; !!VRy15:S0; !!VRy16:S0; !!VRy17:S0; !!VRy18:S0; !!VRy19:S0; !!VRy20:S0;

!!if&x2=9;
  !!VRx3:S0;
  !!HEx1:S9/?y10;
  !!SN:W^H3_Luck_0_Hero%X1^/?y11;       [Checke ob der Held Master Luck hat und Speichere in y11]
  !!SN:W^H3_Luck_1_Hero%X1^/?y12;       [Checke ob der Held Grandmaster Luck hat und Speichere in y12]

  !!HEx1:A2/45/?y13/?y14;
  !!HEx1:A2/46/?y13/?y15;
  !!HEx1:A2/47/?y13/?y16;
  !!HEx1:A2/48/?y13/?y17;
  !!HEx1:A2/108/?y13/?y18;

  *check for Spirit Guardian that gives +2 Luck
  !!UN:U98/-1/?y2;                      [Get the Number of total Towns on the map in y2]
  !!VRv1:S-1;                           [Search Index]
  !!re i/1/y2;
    !!UN:U98/-1/-1/1;                   [Get Coordinates of Town]
    !!OBv1/v2/v3:U?y3;                  [Get Subtype]
    !!OBv1/v2/v3:T?y4;                  [Get Type ID]
    !!CAv1/v2/v3&y4=98/y3=1:O?y6;
    !!CAv1/v2/v3&y4=98/y3=1:B3/26;
    !!HEx1:O?y7;
    !!VRy20:S0;
    !!VRy20&y4=98/y3=1/1/y6=y7:S2;
    !!if&y4=98/y3=1/1/y6=y7;
     !!br;                             [Stop searching]
    !!en;
  !!en;

  *!IF:M^Total%X3
   %Y10 %Y11 %Y12 %Y14 %Y15 %Y16 %Y17 %Y18 %Y20^;

  !!VRx3:+y10+y11+y12+y14+y15+y16+y17+y18+y18+y18+y20;
!!en;


!!if&x2=6;
  !!VRx3:S0;
  !!HEx1:S6/?y10;
  !!SN:W^H3_Leadership_0_Hero%Y1^/?y11;   [Checke ob der Held Master Moral hat und Speichere in y11]
  !!SN:W^H3_Leadership_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Moral hat und Speichere in y12]

  !!HEx1:A2/45/?y13/?y14;
  !!HEx1:A2/49/?y13/?y15;
  !!HEx1:A2/50/?y13/?y16;
  !!HEx1:A2/51/?y13/?y17;
  !!HEx1:A2/108/?y13/?y18;
  !!VRx3:+y10+y11+y12+y14+y15+y16+y17+y18+y18+y18;
!!en;


!?FU(OnAfterBattleUniversal);
*Master/Grandmaser Luck/Morale gives +4/5

!!BA:H0/?y1;
!!if&y1>=0/y1<=155;
!!SN:W^H3_Luck_0_Hero%Y1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%Y1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
!!HEy1&y11=1:R1/d1;                     [+1 Luck]
!!HEy1&y12=1:R1/d1;                     [+1 Luck]

!!SN:W^H3_Leadership_0_Hero%Y1^/?y11;   [Checke ob der Held Master Moral hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Moral hat und Speichere in y12]
!!HEy1&y11=1:R0/d1;                     [+1 Moral]
!!HEy1&y12=1:R0/d1;                     [+1 Moral]
!!en;

!!BA:H1/?y1;
!!if&y1>=0/y1<=155;
!!SN:W^H3_Luck_0_Hero%Y1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%Y1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
!!HEy1&y11=1:R1/d1;                     [+1 Luck]
!!HEy1&y12=1:R1/d1;                     [+1 Luck]

!!SN:W^H3_Leadership_0_Hero%Y1^/?y11;   [Checke ob der Held Master Moral hat und Speichere in y11]
!!SN:W^H3_Leadership_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Moral hat und Speichere in y12]
!!HEy1&y11=1:R0/d1;                     [+1 Moral]
!!HEy1&y12=1:R0/d1;                     [+1 Moral]
!!en;


 ***************************************************************************************************
* y71 y72 y76 y77 y82 y97 (97VarPrep.erm共用)
* SN:W^Att_Luck_Type^/0;
* SN:W^Ret_Luck_Type^/0;
* SN:W^ATT_LUCK_BONUS_FACTOR^/0;
* SN:W^RET_LUCK_BONUS_FACTOR^/0;
*     0 not active, + good luck, - bad luck
* +/- 1 shoot animation pending
* +/- 2 melee animation pending
* +/- 3 done animation

!#SN:W^X_Luck2_On^/1;

*==============================================================================*

*==============================================================================*
*?FU(BG0_Luck2);
!?BG0;

!!SN:W^Att_Luck_Type^/0;
!!SN:W^Ret_Luck_Type^/0;
!!SN:W^ATT_LUCK_BONUS_FACTOR^/0;
!!SN:W^RET_LUCK_BONUS_FACTOR^/0;

!!BG:A?y71 N?y72 E?y82;
!!BMy72:N?y76 T?y77;

!!FU|y71<6/y71>7:E;
!!FU|y76<1/y77<0:E;
!!FU|y77=145/y77=147/y77=148/y77=149:E; [Exit for Warmachines]

*!IF&y82<0:M^Error: luck BG0 ActionType=%y71 ActionStack=%y72 (TargetStack=%y82)<0^;
!!FU&y82<0:E;

!!BMy72:G213/?y2/?t;
!!BMy82:G213/?y3/?t;

!!FU&y2=0/y3=0:E;

!!BMy72:G213/0/?t;
!!BMy82:G213/0/?t;

!!VRy12:S0T999;
!!VRy13:S0T999;

!!SN:W^ATT_LUCK_BONUS_FACTOR^/150;
!!SN:W^RET_LUCK_BONUS_FACTOR^/150;
!!VRy22:Sy2*50;
!!VRy23:Sy3*50;
!!VRy22&y2<0:*-1;
!!VRy23&y3<0:*-1;

!!if&i^Advanced_Classes_Mod_Active^>0;
!!FU(Calc_ACM_Luck_Prob_And_Factor):Py72/y2/?y22/?i^ATT_LUCK_BONUS_FACTOR^;
!!FU(Calc_ACM_Luck_Prob_And_Factor):Py82/y3/?y23/?i^RET_LUCK_BONUS_FACTOR^;
!!en;

!!if&y2>0/y12<y22;                     [Case_Attack_Good_Luck]
    !!if&y71=6;
        !!SN:W^Att_Luck_Type^/2;
    !!el&y71=7;
        !!FU(Show_Good_Luck):Py72;
        !!SN:W^Att_Luck_Type^/3;
    !!en;
!!el&y2<0/y12<y22;                     [Case_Attack_Bad_Luck]
    !!if&y71=6;
        !!SN:W^Att_Luck_Type^/-2;
    !!el&y71=7;
        !!FU(Show_Bad_Luck):Py72;
        !!SN:W^Att_Luck_Type^/-3;
    !!en;
!!en;

!!if&y3>0/y13<y23;                     [Case_Retaliation_Good_Luck]
!!SN&y71=6:W^Ret_Luck_Type^/2;
!!SN&y71=7:W^Ret_Luck_Type^/1;
!!el&y3<0/y13<y23;                     [Case_Retaliation_Bad_Luck]
!!SN&y71=6:W^Ret_Luck_Type^/-2;
!!SN&y71=7:W^Ret_Luck_Type^/-1;
!!en;


!?MF1;
!!UN:C42149568/4/?y20;
!!FU|y20=4458589/y20=4460149/y20=4460621/y20=4461137/y20=4610404/y20=4627096/y20=5902442:E;

!!SN:W^Att_Luck_Type^/?y10;
!!SN:W^Ret_Luck_Type^/?y11;
!!FU&y10=0/y11=0:E;

!!BG:N?y72 E?y82;
!!MF:N?y97;

!!if&y97<>y72;                         [Case_Attack]
!!if&y10=2;                            [good strike pending animation]
  !!FU(Show_Good_Luck):Py72;
  !!VRy10:S3;
!!en;
!!if&y10=3;                            [good luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1:*i^ATT_LUCK_BONUS_FACTOR^ :100;
  !!VRy2:*i^ATT_LUCK_BONUS_FACTOR^ :100;
  !!MF:Dy1 Fy2;
!!en;

!!if&y10=-2;                           [bad strike pending animation]
  !!FU(Show_Bad_Luck):Py72;
  !!VRy10:S-3;
!!en;
!!if&y10=-3;                           [bad luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1::2;
  !!VRy2::2;
  !!VRy1&y1<1:S1;
  !!VRy2&y2<1:S1;
  !!MF:Dy1 Fy2;
!!en;
!!en;

!!if&y97=y72;                          [Case_Retaliation]
!!if&y11=2;                            [good strike pending animation]
  !!FU(Show_Good_Luck):Py82;
  !!VRy10:S-3;
!!en;
!!if&y11=3;                            [good luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1:*i^RET_LUCK_BONUS_FACTOR^ :100;
  !!VRy2:*i^RET_LUCK_BONUS_FACTOR^ :100;
  !!MF:Dy1 Fy2;
!!en;

!!if&y11=-2;                           [bad strike pending animation]
  !!FU(Show_Bad_Luck):Py82;
  !!VRy11:S-3;
!!en;
!!if&y11=-3;                           [bad luck done animation]
  !!MF:D?y1 F?y2;
  !!VRy1::2;
  !!VRy2::2;
  !!VRy1&y1<1:S1;
  !!VRy2&y2<1:S1;
  !!MF:Dy1 Fy2;
!!en;
!!en;

!?FU(Calc_ACM_Luck_Prob_And_Factor);

!!BMx1:I?y1;!!BHy1:N?y40;
!!VRy2:Sx2;

*Calc Prob
!!VRy5:S0;
!!VRy5|y2=1/y2=-1:S40; !!VRy5|y2=2/y2=-2:S70; !!VRy5|y2=3/y2=-3:S100; !!VRy5|y2=4/y2=-4:S125; !!VRy5|y2>=5/y2<=-5:S150;
!!FU(Count_Set_Pieces):Py40/0/0/0/0/?y95;[Check for The Adventures Fidelity, removes the Luck cap and allows endless scaling]
!!if&y95=4;
!!VRy5&y2=6:S160; !!VRy5&y2=7:S170; !!VRy5&y2=8:S180; !!VRy5&y2=9:S190; !!VRy5&y2=10:S200; !!VRy5&y2=11:S210; !!VRy5&y2=12:S220; !!VRy5&y2=13:S230; !!VRy5&y2=14:S240; !!VRy5&y2>=15:S250; [Set Luck Strike Chance]
!!en;
!!VRx3:Sy5;

*Calc Factor
!!VRy10:S0;
!!if&y2>0;
  !!VRy10&y2<=5:S150;                   [50% damage with Luck up to 5]
  !!VRy10&y2=6:S160; !!VRy10&y2=7:S170; !!VRy10&y2=8:S180; !!VRy10&y2=9:S190; !!VRy10&y2>=10:S200;

  !!if&y40>=0/y40<=155;
    !!HEy40:S9/?y3;
    !!SN:W^H3_Luck_0_Hero%Y40^/?y11;    [Checke ob der Held Master Luck hat und Speichere in y11]
    !!SN:W^H3_Luck_1_Hero%Y40^/?y12;    [Checke ob der Held Grandmaster Luck hat und Speichere in y12]
    !!VRy20&y3=0:S0; !!VRy20&y3=1:S10; !!VRy20&y3=2:S15; !!VRy20&y3=3/y11=0/y12=0:S20; !!VRy20&y3=3/y11=1/y12=0:S25; !!VRy20&y3=3/y11=1/y12=1:S30; [Increase +10% Luck damage per Skill of Luck]
    !!VRy10:+y20;
    !!HEy40:X?y23/?y24/?y25/?y25/?y25/?y25/?y25; [Check Hero Speciality]
    !!if&y23=0/y24=9;                  [If Luck Specialists]
      !!HEy40:E?y47/?y48/1;             [Get Hero Level]
      !!VRy10:+10+y48;                  [Add 10 plus 1 percent per level Luck damage]
    !!en;
  !!en;
!!en;
!!VRx4:Sy10;


!?FU(Show_Good_Luck);
!!BA:Q?f;
!!FU&f=1:E;
!!VRz1:S^GOODLUCK^;
!!SN:Pz1;
!!BMx1:V18 T?y7;
!!UN:N3/2/y7/1;
!!SN:T^AC_Misc.Goodluck^/?z3;
!!BU:Mz3;

!?FU(Show_Bad_Luck);
!!BA:Q?f;
!!FU&f=1:E;
!!VRz1:S^Misfort^;
!!SN:Pz1;
!!BMx1:V48 T?y7;
!!UN:N3/2/y7/1;
!!SN:T^AC_Misc.Badluck^/?z3;
!!BU:Mz3;


***************
!?FU(OnBeforeBattleUniversal);          [Combat Start]

!!BA:H0/?y1;
!!FU(Improved_Luck_Bonus0):Py1/1;

!!BA:H1/?y2;                            [Defending Hero]
!!FU(Improved_Luck_Bonus0)&y2>=0:Py2/2;


!?FU(Improved_Luck_Bonus0);

!!HEx1:S9/?y33;                         [Check for Luck Skill]
!!HEx1:E?y39/?y40/1;                    [Check Hero Level]

!!SN:W^H3_Luck_0_Hero%X1^/?y11;         [Checke ob der Held Master Luck hat und Speichere in y11]
!!SN:W^H3_Luck_1_Hero%X1^/?y12;         [Checke ob der Held Grandmaster Luck hat und Speichere in y12]


!!if&y33>0;
!!VRy10&y33=1:S1T25;                    [Basic]
!!VRy10&y33=2:S1T22;                    [Advanced]
!!VRy10&y33=3/y11=0/y12=0:S1T20;        [Expert]
!!VRy10&y33=3/y11=1/y12=0:S1T17;        [Master]
!!VRy10&y33=3/y11=1/y12=1:S1T15;        [GrandMaster]

!!FU&y10>2:E;                           [Exit Chance is ca 10% for a Bonus]

!!VRy11&y10=1:S1T3;  !!SN&y10=1:T^AC_Misc.Scout_Attack^/?z-1;
!!VRy11&y10=2:S1T3;  !!SN&y10=2:T^AC_Misc.Scout_Defense^/?z-1;
!!VRy11&y10=3:S3T4;  !!SN&y10=3:T^AC_Misc.Scout_Health^/?z-1;
!!VRy11&y10=4:S1T1;  !!SN&y10=4:T^AC_Misc.Scout_Speed^/?z-1;

!!VRy40&y10=1|y10=2::10;                [Divide Hero level trough 10 to get more bonus with higher level]
!!VRy40&y10=3::7;
!!VRy40&y10=4::20;                      [Reduce for Speed]
!!VRy11:+y40;


!!HEx1:B0/?z-10;                        [get hero name]
!!HEx1:O?y88;
!!OW:Iy88/?y89;                         [Check for AI Player so it only humans see the message]

!!SN:T^AC_Misc.Luck Bonus^/?z4 Iz4/?z4;
!!IF&1000/y89=0:M^%Z4^;

!!SN&x2=1:W^Prepare_For_Battle_Att^/y10;[Activate Battle Flag Attacker]
!!SN&x2=2:W^Prepare_For_Battle_Def^/y10;[Activate Battle Flag Defender]
!!SN:W^Prepare_For_Battle_Bonus^/y11;   [Save Bonus]
!!en;


!?BF;                                   [Combat Start]

!!SN:W^Prepare_For_Battle_Att^/?y80;
!!DO(AC_Function_9)/0/20/1&y80>0:Py80;

!!SN:W^Prepare_For_Battle_Def^/?y80;
!!DO(AC_Function_9)/21/41/1&y80>0:Py80;

!!SN:W^Prepare_For_Battle_Att^/0;
!!SN:W^Prepare_For_Battle_Def^/0;
!!SN:W^Prepare_For_Battle_Bonus^/0;


!?FU(AC_Function_9);                    [increase Units Stats]

!!SN:W^Prepare_For_Battle_Bonus^/?y10;

!!if&x1=1;                             [Attack]
!!BMx16:Ady10;
!!en;

!!if&x1=2;                             [Defense]
!!BMx16:Ddy10;
!!en;

!!if&x1=3;                             [Health]
!!VRy10:+100;
!!BMx16:H?y1;
!!BMx16:N?y20;                          [Hit Points of stack: y2]
!!FU&y20=0:E;                           [Exit if zero health]
!!VRy2:Sy1*y10:100;
!!VRy2&y2=y1:+1;                        [Min +1HP for low level troops]
!!BMx16:Hy2;
!!en;

!!if&x1=4;                             [Speed]
!!BMx16:Sdy10;
!!en;


************************Ballistics**********************************************
*Doubles the HP of all War Machines and increases the damage of Ranged Attacks in a Siege
*+4 Attack in a Siege
*+6 Attack Master
*+8 Attack GM

!?BF;                                   [Combat Start]

!!BA:S?y1;
!!BA:H0/?y2;                            [Attacker]
!!HEy2:S10/?y3;                         [Ballistics]

!!SN:W^H3_Ballistics_0_Hero%Y2^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!SN:W^H3_Ballistics_1_Hero%Y2^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]

!!VRy10&y3=1:S2; !!VRy10&y3=2:S3; !!VRy10&y3=3/y11=0/y12=0:S4; !!VRy10&y3=3/y11=1/y12=0:S6; !!VRy10&y3=3/y11=1/y12=1:S8;

!!DO(AC_Function_10)/0/20/1&y3>0:Py10/y1;[Pass Attack Bonus and Siege state]

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:S10/?y3;                         [Ballistics]

!!SN:W^H3_Ballistics_0_Hero%Y4^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!SN:W^H3_Ballistics_1_Hero%Y4^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]

!!VRy10&y3=1:S2; !!VRy10&y3=2:S3; !!VRy10&y3=3/y11=0/y12=0:S4; !!VRy10&y3=3/y11=1/y12=0:S6; !!VRy10&y3=3/y11=1/y12=1:S8;
!!DO(AC_Function_10)/21/41/1&y3>0:Py10/y1;

!?FU(AC_Function_10);                   [increase Units Stats]
!!BMx16:T?y1;
!!if|y1=145/y1=146/y1=147/y1=148;
  !!BMx16:H?y2;
  !!BMx16:N?y20;                        [Creature Number y20]
  !!if&y20>0;
    !!VRy2&x1=2:*3:2;                   [50%HP for Basic]
    !!VRy2&x1=3:*4:3;                   [75%HP for A]
    !!VRy2&x1=4:*2;                     [100%HP for E]
    !!VRy2&x1=6:*5:2;                   [150%HP for Master]
    !!VRy2&x1=8:*3;                     [200%HP for Grandmaster]
    !!BMx16:Hy2;
  !!en;
!!en;
!!BMx16&x2=1:Adx1;                      [Give Attack to Monsters]

!!BMx16:F?i;                            [Give damage to Shooters]
!!VRi:&4;                               [Check for Shooter]
!!if&i>0;
  !!BMx16|x1=2/x1=3:U2/d1;              [1 Max Damage every fight]
  !!BMx16|x1=4/x1=6:U2/d2;              [2 Max Damage at Expert every fight]
  !!BMx16&x1=8:U2/d3;                   [3 Max Damage at GM every fight]
!!en;

!?FU(OnBattleRegeneratePhase);

!!FU:E;                                 [Disabled until better Solution found]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1;
!!BMy1:I?y2;
!!UN:C7734719/4/171;                    [Restore (mon=171) No Obstacle Penalty]
!!UN:C7724390/4/171;                    [Restore (mon=171) No Range Penalty]
!!BA:Hy2/?y2;                           [Attacker]
!!FU&y2<0:E;
!!HEy2:S10/?y3;                         [Ballistics]
!!SN:W^H3_Ballistics_0_Hero%Y2^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!FU|y3<3/y11=0:E;                      [Exit if no Ballistics]
!!SN:W^H3_Ballistics_1_Hero%Y2^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]

!!BMy1:T?y2;
!!BMy1:F?i;
!!VRi:&4;
!!if&i>0/y12=1;                        [if Shooter and Grandmaster Ballistics]
!!UN:C7734719/4/y2;                     [No Obstacle Penalty]
!!UN:C7724390/4/y2;                     [No Range Penalty]
!!en;

!!if&i>0/y12=0;                        [if no Shooter Restore]
!!UN:C7734719/4/171;                    [Restore (mon=171) No Obstacle Penalty]
!!UN:C7724390/4/171;                    [Restore (mon=171) No Range Penalty]
!!en;



************************Eagle Eye***********************************************
**Learn spell up to 5th level directly in combat and gain 1 Spell Power when learning spells**

Vision of the Eagle: If the skill is granted by the Set and not the actual skill, you gain only percentage of the complete set but the chance to learn
!?BG0&1000;

!!SN:W^Eagle_Eye_Spell_0^/0;
!!BG:A?y1;                              [Aktion in y1 Must be Hero Cast]
!!FU&y1<>1:E;                           [Exit if not Hero cast]
!!BG:Q?y1;                              [Get Battle Side]
!!VRy1:-1*-1;
!!BA:Hy1/?y99;                          [Get Hero]
!!FU&y99=-2:E;                          [Exit if no Hero]
!!HEy99:S11/?y10;                       [11 Eagle Eye]
!!FU(Count_Set_Pieces_2):Py99/0/0/0/0/0/?y20; [Count Vision of the Eagle Set Pieces]
!!FU&y10=0/y20<3:E;                     [If set is complete and hero has no EE skill give basic Eagle Eye Skill]
!!SN:W^H3_Eagle Eye_0_Hero%Y99^/?y11;
!!SN:W^H3_Eagle Eye_1_Hero%Y99^/?y12;
!!VRy40:S0;
!!VRy40&y10=1:S50; !!VRy40&y10=2:S65; !!VRy40&y10=3/y11=0/y12=0:S75; !!VRy40&y10=3/y11=1/y12=0:S85; !!VRy40&y10=3/y11=1/y12=1:S100; [Set Eagle Eye chance]
!!HEy99:A2/63/?y29/?y30; !!VRy40&y30=1:+15; [Bird of Perception]
!!HEy99:A2/64/?y29/?y30; !!VRy40&y30=1:+20; [Stoic Watchman]
!!HEy99:A2/65/?y29/?y30; !!VRy40&y30=1:+25; [Emblem of Cognizance]
!!VRy50:S0T100;                         [Create random number]

!!FU&y50>y40:E;                         [Exit if roll fails]
!!HEy99:S7/?y14;                        [7 Wisdom]
!!BG:S?y4;                              [Spell Number]
!!if&y4>=10/y4<=69;                    [Valid Spell]
  !!SSy4:L?y5;                          [Spell Level]
  !!FU&y5=5/y14<3:E;                    [Exit if Wisdom level not high enough]
  !!FU&y5=4/y14<2:E;
  !!FU&y5=3/y14<1:E;
  !!HEy99:My4/?y7;                      [Check if Hero already knows the spell]
  !!SN:W^Hero%Y99_Spell%Y4_Specialists^/?y8; [Check saved spells before battle]
  !!if&y7=0/y8=0;                      [If Hero doesnt know the spell and also not currently just unlearned]
    !!HEy99:My4/1;                      [Give Hero the new spell]
    !!SN:W^Hero%Y99_Spell%Y4_Specialists^/1; [Fix for Sorcery or Elemental Specialists]
    !!SN:W^Eagle_Eye_Spell_0^/y4;
  !!en;
!!en;


!?BG1&1000;                             [After Battle Action Trigger for Eagle Eye]

!!SN:W^Eagle_Eye_Spell_0^/?y1;          [Exit if flag is zero]
!!FU&y1=0:E;
!!BG:Q?y2;
!!VRy2:-1*-1;                           [Get opposing hero]
!!BHy2:N?y2;
!!FU&y2<0:E;                            [Exit if no Hero]
!!HEy2:B0/?z1;                          [get hero's name]

!!HEy2:O?y3;                            [Checke Hero Owner]
!!FU&y3=-1:E;                           [Exit if no owner]
!!OW:Iy3/?y3;                           [AI/Human]
!!FU&y3=1:E;                            [Exit if Human or player Killed to prevent Eagle Eye Message]

!!HEy2:S11/?y50;                        [11 Eagle Eye]
!!FU(Count_Set_Pieces_2):Py2/0/0/0/0/0/?y20; [Count Vision of the Eagle Set Pieces]
!!VRy40:S1;                             [1 SP]
!!VRy40&y20=3/y50>0:S2;                 [2 SP with full set]
!!VRy40&y20=3/y50=0:S1;                 [Give only 1 SP with only set equipped]
!!SN:T^AC_Misc.Eagle_Eye_Spell^/?z3/^value^/y40; !!SN:Iz3/?z3;
!!IF:Q1/9/y1/1/z3;                      [Show spell learning screen for hero]
!!HEy2:Fd/d/?y1/d;                      [Check Hero Spell Power]
!!HEy2&y1<99:Fd/d/dy40/d;               [Gain +1 Spell Power for every successfull EE proc]


******************
!?FU(OnBeforeBattleUniversal);          [Continue trigger if eagle eye is enabled]
**Magic Artillery
* +100% damage at Master
* +200% damage at Grandmaster
* +500% for EE set
** start of battle-start trigger


** eagle eye
!!BA:H0/?y1;                            [get attacking hero #]
!!HEy1:S11/?y8;                         [check EE]
!!BA:H1/?y10;                           [get defending hero #]
!!HEy10&y10>=0:A2/65/?y22/?y23;         [Check defender for Emblem of Cognizance, this prevents the damage from EE]
!!FU(Magic_Artillery_Shoot1)&y8>0/y23=0:P1/y1; [shoot something - attacker if defender does not have artifact]

!!BA:H1/?y1;                            [get defending hero #]
!!FU&y1<0:E;
!!HEy1:S11/?y8;                         [see if defending hero has Eagle Eye]
!!BA:H0/?y10;                           [get defending hero #]
!!HEy10&y10>=0:A2/65/?y22/?y23;         [Check defender for Emblem of Cognizance, this prevents the damage from EE]
!!FU(Magic_Artillery_Shoot1)&y8>0/y23=0:P2/y1; [shoot something - defender if attacker does not have artifact]


** function to handle Magic Artillery, skill level y1
!?FU(Magic_Artillery_Shoot1);

!!HEx2:A2/5/?y7/?y8 A2/63/?y20/?y21 A2/64/?y22/?y23 A2/65/?y24/?y25 E?y3/?y4/1 S11/?y1 F?y9/?y10/?y11/?y12; [check for Ammo Cart, Watchman, Emblem, Bird, get hero's level, eagle eye level, heroes spell power]

!!SN:W^H3_Eagle Eye_0_Hero%X2^/?y31;    [Checke ob der Held Master Eagle Eye hat und Speichere in y11]
!!SN:W^H3_Eagle Eye_1_Hero%X2^/?y32;    [Checke ob der Held Grandmaster Eagle Eye hat und Speichere in y12]

!!VRy5:S1;                              [set multiplier to 1]
!!VRy5&y31=1:+1;                        [Damage Boost at Master]
!!VRy5&y32=1:+1;                        [Damage Boost at GrandMaster]
!!VRy5&y8>0:+1;                         [ammo cart bonus]
!!VRy5&y25>0:+1;                        [Emblem bonus]
!!VRy5&y23>0:+1;                        [Watchman bonus]
!!VRy5&y21>0:+1;                        [Bird bonus]
!!VRy5&y21>0/y23>0/y25>0:+2;            [Complete Eagle Eye set adds additional +200% Bonus]
!!VRy5&y1>0:+y1;                        [Eagle eye skill lvl bonus]

!!VRy11:*4;                             [Spell Power times four]

!!VRy3:S1T49 +y11 *y5;                  [Magic_Artillery damage: (1-50 + spell power*5) x bonus multiplier]
!!VRy2:S0T6;                            [random slot # to start search from]
!!SN:W^First_Aid_Heal_Slot^/7;          [7 = slot not found]
!!DO(AC_Function_11)/0/6/1:Px1/y2/y3/x2;[shoot next slot with >= 2 monsters]
** end of function

** function to check one stack for monsters to shoot
!?FU(AC_Function_11);                   [x1=slot#   x2=slot    x3=damage  x4=Hero]

!!HEx4:B0/?z1;                          [get hero's name]
!!VRy4:Sx2 %7;                          [get an actual slot number]
!!BA&x1=1:M1/y4/?y5/?y6;                [get y5 type and y6 qty in slot of defender]
!!BA&x1=2:M0/y4/?y5/?y6;                [get y5 type and y6 qty in slot of attacker]
!!IF:V2/0;                              [assume not shooting this stack]
!!SN:W^First_Aid_Heal_Slot^/?y50;       [7 = slot not found]
!!IF&y50=7/y6>1:V2/1;                   [shoot if haven't yet and more than 1 monster]
!!VRy50&2:Sy4;                          [note we found a slot]
!!MA&y5>-1:Py5/?y7;                     [get hit points of monster type y5]
!!VRx3&2/y7>0::y7;                      [divide damage by hit points per monster to get monsters killed]
!!VRx3&2/x3>y6:Sy6;                     [never kill entire stack]
!!VRx3&2/x3=y6:-1;                      [broken into two lines since it didn't work as one]
!!VRy6&2/x3>0:-x3;                      [kill some monsters]
!!BA&2/x1=1/x3>0:M1/y4/?y5/y6;          [store the new monster qty for defender]
!!BA&2/x1=2/x3>0:M0/y4/?y5/y6;          [store the new monster qty for attacker]
!!VRy1&2/x3>0:Sx3 *y7;                  [monsters x hit points]
!!SN&1000/2/x3>1:T^AC_Misc.Magic Artillery 1^/?z4 Iz4/?z4;
!!IF&1000/2/x3>1:Q2/21/y5/1^%Z4^;

!!SN&1000/2/x3=1:T^AC_Misc.Magic Artillery 2^/?z4 Iz4/?z4;
!!IF&1000/2/x3=1:Q2/21/y5/1^%Z4^;
!!HEx4&2/x3>0:Edx3;                     [give experience]
!!VRx16&2/x3>0:S6;                      [Exit if killed]
!!VRx2:+1;                              [next slot]


***************************Necromancy*******************************************
**Master Ressurects 17%
**Grandmaster Ressurects 20%
** And Nekropolis Creature Specialists get little chance to ressurect their creature after battle
!?FU(OnHeroScreenMouseClick);

!!SN:W^Alternative_Necromancy_Mod^/?y1; [Check for Necromancy Option]
!!FU&y1=0:E;

!!HE-1:N?y1;                            [Get current Hero]
!!HEy1:S12/?y2;                         [Check Necromancy Skill]
!!FU&y2=0:E;

!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v6<>512/v5<>14:E;                  [If not Necromancy Icon Clicked Exit]

!!if|v3=512/v3=0;                      [if right or left click]
  !!if|v4=79/v4=80/v4=81/v4=82/v4=83/v4=84/v4=85/v4=86/v4=501/v4=504;
    !!VRv4:-78;                         [To hit correct Secondary Skill ID]
    !!FU|v4<0/v4>8:E;
    !!HEy1:Sv4/?y5/1;
    !!FU&y5<>12:E;                      [Exit if no Necromancy]

    !!SN:T^AC_Misc.Necromancy_Text^/?z1;[set text in header]
    !!SN:T^AC_Misc.Necromancy_Creature_1^/?z2; [56] Skeletons]
    !!SN:T^AC_Misc.Necromancy_Creature_3^/?z3; [58] Walking Dead]
    !!SN:T^AC_Misc.Necromancy_Creature_5^/?z4; [60] Wight]
    !!SN:T^AC_Misc.Necromancy_Creature_15^/?z5; [62] Vampires]
    !!SN:T^AC_Misc.Necromancy_Creature_16^/?z6; [64] Liches]
    !!SN:T^AC_Misc.Necromancy_Creature_17^/?z7; [66  Black Knight]

    !!IF:G1/3/0/1/2/3/4/5/6/7/0/0/0/0/0/;[Show Choice Dialouge]
    !!SN&v3=1:W^H3_Necromancy_Choice_%Y1^/56;
    !!SN&v3=2:W^H3_Necromancy_Choice_%Y1^/58;
    !!SN&v3=4:W^H3_Necromancy_Choice_%Y1^/60;
    !!SN&v3=8:W^H3_Necromancy_Choice_%Y1^/62;
    !!SN&v3=16:W^H3_Necromancy_Choice_%Y1^/64;
    !!SN&v3=32:W^H3_Necromancy_Choice_%Y1^/66;
    !!CM:R0;                            [Disable standard reaction]
  !!en;
!!en;


!?FU(OnBeforeBattleUniversal);

!!BA:H0/?y1;                            [Attacker]
!!HEy1:O?y2;                            [Check hero owner]
!!OW:C?y3;                              [Check current player]
!!FU&y2<>y3:E;                          [Abort if not the same]

!!HEy1:S12/?y10;                        [Check for Necromancy]
!!SN:W^H3_Necromancy_0_Hero%Y1^/?y11;   [Checke ob der Held Master Necromancy hat und Speichere in y11]
!!SN:W^H3_Necromancy_1_Hero%Y1^/?y12;   [Checke ob der Held Grandmaster Necromancy hat und Speichere in y12]

*!SN:W^H3_Necromancy_0_Hero%Y1^/1;   Test
*!SN:W^H3_Necromancy_1_Hero%Y1^/1;

!!FU(SetSecSkillPercent):P12/3/30;      [Set Skillvalue to 15% for Expert Necromancy]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P12/3/34;      [Set Skillvalue to 17% for Master Necromancy]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P12/3/40;      [Set Skillvalue to 20% for Grandmaster Necromancy]

!!UN:C5127994/4/56;                     [Always set to skeletons before every fight]
!!HEy1:C0/0/?y21/?y32;                  [Check Heros army slot 1]
!!HEy1:C0/1/?y31/?y33;
!!HEy1:C0/2/?y41/?y34;
!!HEy1:C0/3/?y51/?y35;
!!HEy1:C0/4/?y61/?y36;
!!HEy1:C0/5/?y71/?y37;
!!HEy1:C0/6/?y81/?y38;

!!UN|y21=57/y31=57/y41=57/y51=57/y61=57/y71=57/y81=57:C5127994/4/57; [Set to Skeleton Warriors if Hero has them in the Army]
!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
!!if&y99=1;
  !!UN|y21=220/y31=220/y41=220/y51=220/y61=220/y71=220/y81=220:C5127994/4/220; [Set to Skeleton Knights if Hero has them in the Army]
!!en;
Till here Normal Necromancy
***************************
!!SN:W^Alternative_Necromancy_Mod^/?y99;[Check for Necromancy Option]
!!FU&y99=0:E;

!!UN:C5127994/4/56;                     [Always set to skeletons before every fight]
!!HEy1:C0/0/?y21/?y32;                  [Check Heros army slot 1]
!!HEy1:C0/1/?y31/?y33;
!!HEy1:C0/2/?y41/?y34;
!!HEy1:C0/3/?y51/?y35;
!!HEy1:C0/4/?y61/?y36;
!!HEy1:C0/5/?y71/?y37;
!!HEy1:C0/6/?y81/?y38;

!!SN:W^H3_Necromancy_Choice_%Y1^/?y50;
!!if&y50>=0/y50<221;
  !!UN&y10=3/y50=58:C5127994/4/58;      [Set to Walking Dead if Expert]
  !!UN&y10=3/y11=1/y50=60:C5127994/4/60;[Set to Wight if Master]
  !!UN&y10=3/y11=1/y12=1/y50=62:C5127994/4/62; [Set to Vampire if GrandMaster]
  !!UN&y10=3/y11=1/y12=1/y50=64:C5127994/4/64; [Set to Lich if GrandMaster]
  !!UN&y10=3/y11=1/y12=1/y50=66:C5127994/4/66; [Set to Black Knights if GrandMaster]

  !!FU(SetSecSkillPercent)&y10=3/y50=58:P12/3/20; [Set Skillvalue to 10% for Zombies]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y50=60:P12/3/14; [Set Skillvalue to 7% for Wights]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=62:P12/3/4; [Set Skillvalue to 2% for Vampires]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=64:P12/3/4; [Set Skillvalue to 2% for Liches]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1/y50=66:P12/3/2; [Set Skillvalue to 1% for Black Knights]
!!en;

!!if|y50=56/y50=0;
  !!UN|y21=57/y31=57/y41=57/y51=57/y61=57/y71=57/y81=57:C5127994/4/57; [Set to Skeleton Warriors if Hero has them in the Army]

  !!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  !!if&y99=1;
    !!UN|y21=220/y31=220/y41=220/y51=220/y61=220/y71=220/y81=220:C5127994/4/220; [Set to Skeleton Knights if Hero has them in the Army]
  !!en;
!!en;

!!if&y10=3/y50=58;
  !!UN|y21=59/y31=59/y41=59/y51=59/y61=59/y71=59/y81=59:C5127994/4/59; [Set to Zombies if Hero has them in the Army]

  !!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  !!if&y99=1;
    !!UN|y21=141/y31=141/y41=141/y51=141/y61=141/y71=141/y81=141:C5127994/4/141; [Set to Mummies if Hero has them in the Army]
  !!en;
!!en;

!!if&y10=3/y11=1/y50=60;
  !!UN|y21=61/y31=61/y41=61/y51=61/y61=61/y71=61/y81=61:C5127994/4/61; [Set to Wraith if Hero has them in the Army]

  !!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  !!if&y99=1;
    !!UN|y21=261/y31=261/y41=261/y51=261/y61=261/y71=261/y81=261:C5127994/4/261; [Set to Spectres if Hero has them in the Army]
  !!en;
!!en;

!!if&y10=3/y11=1/y12=1/y50=62;
  !!UN|y21=63/y31=63/y41=63/y51=63/y61=63/y71=63/y81=63:C5127994/4/63; [Set to Vampire Lords if Hero has them in the Army]

  !!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  !!if&y99=1;
    !!UN|y21=221/y31=221/y41=221/y51=221/y61=221/y71=221/y81=221:C5127994/4/221; [Set to Nepharatus if Hero has them in the Army]
  !!en;
!!en;

!!if&y10=3/y11=1/y12=1/y50=64;
  !!UN|y21=65/y31=65/y41=65/y51=65/y61=65/y71=65/y81=65:C5127994/4/65; [Set to Power Lich if Hero has them in the Army]

  !!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  !!if&y99=1;
    !!UN|y21=222/y31=222/y41=222/y51=222/y61=222/y71=222/y81=222:C5127994/4/222; [Set to Ancient Lich if Hero has them in the Army]
  !!en;
!!en;

!!if&y10=3/y11=1/y12=1/y50=66;
  !!UN|y21=67/y31=67/y41=67/y51=67/y61=67/y71=67/y81=67:C5127994/4/67; [Set to Dread Knight if Hero has them in the Army]

  !!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
  !!if&y99=1;
    !!UN|y21=223/y31=223/y41=223/y51=223/y61=223/y71=223/y81=223:C5127994/4/223; [Set to Bad Ass Dread Knights if Hero has them in the Army]
  !!en;
!!en;

!!FU:E;
!!VRy20:S0T100;
!!UN&y1=68/y20<5:C5127994/4/67;         [For Tamika change to Dread Knights with 10% chance]
!!UN&y1=67/y20<5:C5127994/4/61;         [For Charna change to Wraith with 10% chance]
!!UN&y1=66/y20<5:C5127994/4/65;         [For Moandor change to Power Liches with 10% chance]
!!UN&y1=65/y20<5:C5127994/4/63;         [For Vokial change to Vampire Lords with 10% chance]
!!UN&y1=64/y20<5:C5127994/4/59;         [For Straker change to Zombies with 10% chance]
!!UN&y1=150/y20<10:C5127994/4/67;       [For Lord Haart change to Dread Knights with 33% chance]
!!UN&y1=78/y20<3:C5127994/4/154;        [For Vidomina change to ******** with 4% chance]


***************************Estates**********************************************
**Increases the Gold amount to plus 2000 at Grandmaster and increases the reward from resources piles
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerIsAi^=0;
!!DO(AC_Function_12)/0/155/1:P;         [loop thru heroes]

!?FU(AC_Function_12);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]

!!HEx16:S13/?y3;                        [(Check level of Estates)]
!!FU&y3=0:E;                            [(Abort if none)]

!!SN:W^H3_Estates_0_Hero%X16^/?y11;     [Checke ob der Held Master Estates hat und Speichere in y11]
!!SN:W^H3_Estates_1_Hero%X16^/?y12;     [Checke ob der Held Grandmaster Estates hat und Speichere in y12]

!!VRy10&y3=1:S125; !!VRy10&y3=2:S250; !!VRy10&y3=3/y11=0/y12=0:S250; !!VRy10&y3=3/y11=1/y12=0:S500; !!VRy10&y3=3/y11=1/y12=1:S1500; [Calc bonus gold]
!!OW:Ry1/6/dy10;                        [Add gold to current player]
!!UN:R2;                                [Redraw Screen to show ne value of gold]

!?FU(OnAfterBattleUniversal)&1000;

!!BA:H0/?y1;                            [Attacker]
!!HEy1:S13/?y11;                        [Check Estates]
!!if&y11>0;
!!HEy1:O?y3;                            [get owner of this hero]
!!HEy1:E?y6/?y7/1;                      [get level of this hero]

!!SN:W^H3_Estates_0_Hero%Y1^/?y12;      [Checke ob der Held Master Estates hat und Speichere in y11]
!!SN:W^H3_Estates_1_Hero%Y1^/?y13;      [Checke ob der Held Grandmaster Estates hat und Speichere in y12]

!!VRy7&y11=1::10;                       [Basic]
!!VRy7&y11=2::10;                       [Advanced]
!!VRy7&y11=3/y12=0/y13=0::10 +1;        [Expert]
!!VRy7&y11=3/y12=1/y13=0::10 +2;        [Master]
!!VRy7&y11=3/y12=1/y13=1::10 +3;        [Grandmaster]

!!VRy10:S0T8;
!!VRy10&y10=7:S6;                       [~11% Increased chance to get Gold after Combat   (22% in total)]
!!FU&y10=8:E;                           [Small chance to find nothing]

!!UN:P36/?v1;                           [Check if Mithril script is enabled: v1]
!!VRy30:S0T100;
!!VRy10&y30<4/v1=1:S7;                  [<4% chance to change to Mithril]
!!VRy11&y10=7/v1=1:S1;                  [Set to 1]

!!VRy11&y10<6/y11=1:S1 +y7;
!!VRy11&y10=6/y11=1:Sy7*250+R300;

!!VRy11&y10<6/y11=2:S1T1 +y7;
!!VRy11&y10=6/y11=2:Sy7*250+R400;

!!VRy11&y10<6/y11=3:S0T2 +y7;
!!VRy11&y10=6/y11=3:Sy7*250+R250;

!!OW:Ry3/y10/dy11;

!!HEy1:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Estates Bonus^/?z-9;

!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/y10/y11/1/z-9;             [If Bonus Show Picture]
!!UN:R2;
!!en;



*********************Fire Air Water Earth Magic*********************************
!?MR1;                                  [*Magical Combat Improvements*]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;
!!FU&y2<=9|y2>69:E;

!!BG:Q?y1;
!!BHy1:N?y99;                           [Current Hero Number]
!!FU&y99<0:E;

!!MR:F?y14;
!!FU&y14=0:E;
!!BG:S?y19;                             [y19 now contains spell number]

!!if&y1=999;                           [Test Disabled]
  !!FU(MSR_Determine_Spell_Type)&y19>=10/y19<=69:Py19/?y20/?y21/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow; y20 holds spell level; y21 type]

  !!SN:W^H3_Fire Magic_0_Hero%Y99^/?y10;[Fire Magic Bonus handling]
  !!SN:W^H3_Fire Magic_1_Hero%Y99^/?y11;
  !!HEy99:S14/?y3;
  !!VRy14&y22=4/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=4/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  !!SN:W^H3_Air Magic_0_Hero%Y99^/?y10;   [Air Magic Bonus handling]
  !!SN:W^H3_Air Magic_1_Hero%Y99^/?y11;
  !!HEy99:S15/?y3;
  !!VRy14&y22=1/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=1/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  !!SN:W^H3_Water Magic_0_Hero%Y99^/?y10; [Water Magic Bonus handling]
  !!SN:W^H3_Water Magic_1_Hero%Y99^/?y11;
  !!HEy99:S16/?y3;
  !!VRy14&y22=8/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=8/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  !!SN:W^H3_Earth Magic_0_Hero%Y99^/?y10; [Earth Magic Bonus handling]
  !!SN:W^H3_Earth Magic_1_Hero%Y99^/?y11;
  !!HEy99:S17/?y3;
  !!VRy14&y22=2/y3=3/y10=1/y11=0:*110:100;[+10% Damage]
  !!VRy14&y22=2/y3=3/y10=1/y11=1:*125:100;[+25% Damage]

  **Intelligence Spell Damage Section**                                           [Intelligence Bonus handling]
  !!HEy99:S24/?y3;
  !!if&y3=100;                           [Disabled for now]
  !!SN:W^H3_Intelligence_0_Hero%Y99^/?y10;
  !!SN:W^H3_Intelligence_1_Hero%Y99^/?y11;

  !!HEy99:I?y4/1;
  !!VRy4&y3=1::5;                         [Basic       Add 20% of SP]
  !!VRy4&y3=2::3;                         [Advanced    Add 33% of SP]
  !!VRy4&y3=3/y10=0/y11=0::2;             [Expert      Add 50% of SP]
  !!VRy4&y3=3/y10=1/y11=0::4*3;           [Master      Add 75% of SP]
  !!VRy4&y3=3/y10=1/y11=1:Sy4;            [Grandmaster Add 100% of SP]

  !!VRy14:Sy14 +y4;                       [Add Current Spell Points to Magic Damage]
  !!en;
!!en;
**Mysticism and Intelligence Specialists Section
!!SN:W^Specialists_SP_Damage_increase^/?y1; [Save Spell Number]
!!if&y1=1;
  !!SN:W^Specialists_SP_Damage_spell_bonus^/?y5;
  !!VRy14:*y5:100;                       [Add Specialist Spell Damage]
  *!SN:W^Specialists_SP_Damage_increase^/0;
  !!MR:Fy14;
!!en;

*************************Resistance*********************************************
!?MR1;                                  [*Magical Combat Improvements*]
*reduces spell and crit magic damage*

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;
!!FU&y2<=9|y2>69:E;

!!BG:Q?y1;
!!VRy1:-1 *-1;
!!BA:Hy1/?y99;
!!FU&y99<0:E;

!!HEy99:S26/?y3;
!!SN:W^H3_Resistance_0_Hero%Y99^/?y10;
!!SN:W^H3_Resistance_1_Hero%Y99^/?y11;

!!MR:F?y6;
!!if&y3>0/y6>0;                        [Resistance bonus handling]
  !!VRy4:S1;
  !!VRy4&y3=1:*10 *y6 :100;             [10% Damage Red   at Basic]
  !!VRy4&y3=2:*15 *y6 :100;             [15% Damage Red   at Advanced]
  !!VRy4&y3=3/y10=0/y11=0:*20 *y6 :100; [20% Damage Red   at Expert]
  !!VRy4&y3=3/y10=1/y11=0:*25 *y6 :100; [25% Damage Red   at Master]
  !!VRy4&y3=3/y10=1/y11=1:*30 *y6 :100; [30% Damage Red   at Grandmaster]
  !!VRy6:Sy6 -y4;
  !!MR&y6>0:Fy6;                        [Apply reduced damage]
!!en;


************************Warfare (Tactics)***************************************
*+1 Speed in first Battle Round at Expert +3Att/Def
*+2 Speed in Combat at Grandmaster +4Att/Def +1max dmg

!?BF;

!!BH0:N?y1;                             [Attacker]
!!HEy1:S19/?y3;                         [Checke ob der Held Tactics hat und Speichere in y10]

!!SN:W^Tactics_enabled^/?y99;
!!HEy1&y3>0/y99=0:R4/0;                 [remove attackers tactics]

!!SN:W^H3_Tactics_0_Hero%Y1^/?y11;      [Checke ob der Held Master Tactics hat und Speichere in y11]
!!SN:W^H3_Tactics_1_Hero%Y1^/?y12;      [Checke ob der Held Grandmaster Tactics hat und Speichere in y12]

!!VRy9&y3=1:S1;                         [y9 sets Attack and Defense]
!!VRy9&y3=2:S1;
!!VRy9&y3=3:S2;
!!VRy9&y3=3/y11=1/y12=0:S3;
!!VRy9&y3=3/y11=1/y12=1:S4;

!!VRy10&y3=1:S0;
!!VRy10&y3=2:S1;                        [y10 Sets Speed ]
!!VRy10&y3=3:S1;
!!VRy10&y3=3/y11=1/y12=0:S2;
!!VRy10&y3=3/y11=1/y12=1:S2;

!!VRy13&y3=3/y11=1/y12=1:S1;            [y13 sets damage +1 max Damage]

!!if&y3>0;

!!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active

!!if&y79=0;
!!if|y1=131/y1=118;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;

!!if&y79=1;
!!if|y1=131;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;

!!en;

!!DO(AC_Function_13)/0/20/1&y3>0:Py9/y10/y13;


!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;

!!HEy1:S19/?y3;                         [Checke ob der Held Tactics hat und Speichere in y10]
!!SN:W^Tactics_enabled^/?y99;
!!HEy1&y3>0/y99=0:R4/0;                 [remove defenders tactics]
!!SN:W^H3_Tactics_0_Hero%Y1^/?y11;      [Checke ob der Held Master Tactics hat und Speichere in y11]
!!SN:W^H3_Tactics_1_Hero%Y1^/?y12;      [Checke ob der Held Grandmaster Tactics hat und Speichere in y12]

!!VRy9&y3=1:S1;                         [y9 Sets Speed y10 sets Attack and Defense]
!!VRy9&y3=2:S1;
!!VRy9&y3=3:S2;
!!VRy9&y3=3/y11=1/y12=0:S3;
!!VRy9&y3=3/y11=1/y12=1:S4;

!!VRy10&y3=1:S0;
!!VRy10&y3=2:S1;                        [y10 Sets Speed ]
!!VRy10&y3=3:S1;
!!VRy10&y3=3/y11=1/y12=0:S2;
!!VRy10&y3=3/y11=1/y12=1:S2;

!!VRy13&y3=3/y11=1/y12=1:S1;            [y13 sets damage +1 max Damage]

!!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active

!!if&y79=0;
!!if&y3>0;
!!if|y1=131/y1=118;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;
!!en;

!!if&y79=1;
!!if&y3>0;
!!if|y1=131;
!!HEy1:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!en;
!!en;
!!en;

!!DO(AC_Function_13)/21/41/1&y3>0:Py9/y10/y13;

!?FU(AC_Function_13);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:Sdx2;                           [Speed]
!!BMx16:Adx1;                           [Attack]
!!BMx16:Ddx1;                           [Defense]
!!BMx16&x3=1:U2/d1;                     [Max Damage]


************************Artillery***********************************************
*Shoots enemy before combat

!?FU(OnBeforeBattleUniversal);          [Continue trigger if any skills are enabled]

** artillery
!!BA:H0/?v7020;                         [get attacking hero #]
!!BA:H1/?y10;                           [get defending hero #]
!!HEy10&y10>=0:A2/65/?y22/?y23;         [Check defender for Emblem of Cognizance, this prevents the damage from Artillery]
!!HEv7020&v7020>-1:A2/4/?y7/?y8 S20/?y9;[see if attacking hero has a Ballista and SS]
!!FU(Artillery_Bonus0)&y8>0/v7020>-1/y9>0/y23=0:P1; [shoot something - attacker]

!!BA:H1/?v7020;                         [get defending hero #]
!!BA:H0/?y10;                           [get attacking hero #]
!!HEy10&y10>=0:A2/65/?y22/?y23;         [Check defender for Emblem of Cognizance, this prevents the damage from Artillery]
!!HEv7020&v7020>-1:A2/4/?y7/?y8 S20/?y9;[see if defending hero has a Ballista and SS]
!!FU(Artillery_Bonus0)&y8>0/v7020>-1/y9>0/y23=0:P2; [shoot something - defender]


** function to handle artillery, hero v7020, skill level y1
!?FU(Artillery_Bonus0);

!!HEv7020:A2/5/?y7/?y8 E?y3/?y4/1 S20/?y1 F?y14/?y15/?y16/?y17; [check for Ammo Cart, get hero's level, artillery level, Attack from Hero]

!!VRy5:S1;                              [set multiplier to 1]
!!SN:W^H3_Artillery_0_Hero%V7020^/?y11; [Checke ob der Held Master Artillery hat und Speichere in y11]
!!SN:W^H3_Artillery_1_Hero%V7020^/?y12; [Checke ob der Held Grandmaster Artillery hat und Speichere in y12]

!!VRy5&y11=1:+1;                        [Master bonus]
!!VRy5&y12=1:+1;                        [Grandmaster bonus]
!!VRy5&y8>0:+1;                         [ammo cart bonus]
!!VRy5&y1>0:+y1;                        [artillery bonus]
!!VRy9:*3;                              [attack bonus]
!!VRy4:*2;                              [Hero Level times 2]
!!VRy5|v7020=6/v7020=97/v7020=54/v7020=81/v7020=36:+1; [if Artillery Specialist Hero]

!!VRy3:S1T49 +y4 +y9 *y5;               [Artillery damage: (1-50 + hero level*2+ hero attack*3) x bonus multiplier]

!!VRy2:S0T6;                            [random slot # to start search from]
!!SN:W^First_Aid_Heal_Slot^/7;          [7 = slot not found]
!!DO(AC_Function_14)/0/6/1:Px1/y2/y3;   [shoot next slot with >= 2 monsters]
** end of function


** function to check one stack for monsters to shoot
!?FU(AC_Function_14);                   [x1=slot#   x2=slot    x3=damage]

!!HEv7020:B0/?z1;                       [get hero's name]
!!VRy4:Sx2 %7;                          [get an actual slot number]
!!BA&x1=1:M1/y4/?y5/?y6;                [get y5 type and y6 qty in slot of defender]
!!BA&x1=2:M0/y4/?y5/?y6;                [get y5 type and y6 qty in slot of attacker]
!!IF:V2/0;                              [assume not shooting this stack]
!!SN:W^First_Aid_Heal_Slot^/?y50;       [7 = slot not found]
!!IF&y50=7/y6>1:V2/1;                   [shoot if haven't yet and more than 1 monster]
!!VRy50&2:Sy4;                          [note we found a slot]
!!MA&y5>-1:Py5/?y7;                     [get hit points of monster type y5]
!!VRx3&2/y7>0::y7;                      [divide damage by hit points per monster to get monsters killed]
!!VRx3&2/x3>y6:Sy6;                     [never kill entire stack]
!!VRx3&2/x3=y6:-1;                      [broken into two lines since it didn't work as one]
!!VRy6&2/x3>0:-x3;                      [kill some monsters]
!!BA&2/x1=1/x3>0:M1/y4/?y5/y6;          [store the new monster qty for defender]
!!BA&2/x1=2/x3>0:M0/y4/?y5/y6;          [store the new monster qty for attacker]
!!VRy1&2/x3>0:Sx3 *y7;                  [monsters x hit points]

!!SN&1000/2/x3>1:T^AC_Misc.Artillery 2^/?z4 Iz4/?z4;
!!IF&1000/2/x3>1:Q2/21/y5/1/z4;

!!SN&1000/2/x3=1:T^AC_Misc.Artillery 1^/?z4 Iz4/?z4;
!!IF&1000/2/x3=1:Q2/21/y5/1/z4;
!!HEv7020&2/x3>0:Edx3;                  [give experience]
!!VRx16&2/x3>0:S6;                      [Exit if killed]
!!VRx2:+1;                              [next slot]
** end of function

!?BF;
!!BA:H0/?y2;                            [Attacker]
!!HEy2:S10/?y3;                         [Ballistics]
!!SN:W^H3_Ballistics_0_Hero%Y2^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!SN:W^H3_Ballistics_1_Hero%Y2^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]
!!VRy10&y3=1:S50; !!VRy10&y3=2:S100; !!VRy10&y3=3/y11=0/y12=0:S150; !!VRy10&y3=3/y11=1/y12=0:S250; !!VRy10&y3=3/y11=1/y12=1:S500;
!!DO(AC_Function_29)/0/20/1&y3>0:Py10;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:S10/?y3;                         [Ballistics]
!!SN:W^H3_Ballistics_0_Hero%Y4^/?y11;   [Checke ob der Held Master Ballistics hat und Speichere in y11]
!!SN:W^H3_Ballistics_1_Hero%Y4^/?y12;   [Checke ob der Held Grandmaster Ballistics hat und Speichere in y12]
!!VRy10&y3=1:S50; !!VRy10&y3=2:S100; !!VRy10&y3=3/y11=0/y12=0:S150; !!VRy10&y3=3/y11=1/y12=0:S250; !!VRy10&y3=3/y11=1/y12=1:S500;
!!DO(AC_Function_29)/21/41/1&y3>0:Py10;

!?FU(AC_Function_29);                   [increase Units Stats]
!!BMx16:T?y1;
!!if&y1=146;
!!BMx16:N?y20;                          [Creature Number y20]
!!FU&y20=0:E;                           [Exit if zero]
!!BMx16:Hdx1;                           [Add fix HP to Ballista]
!!en;



******************Artillery gets additional shots*******************************
*function to give extra attacks/shots to creatures
!?BG0;                                  [Trigger to handle extra shoots and additional strikes]

!!SN:W^007.AttackA.Times^/0;            [reset flag](or reset it at BG1)]
!!SN:W^007.ShootA.Times^/0;             [reset flag](or reset it at BG1)]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1 N?y2 E?y3;
!!BMy2:T?y4;

* Master and Grandmaster Artillery
!!if&y4=146/y1=7;                        [If Ballista and a Ranged Attack]
  !!BMy2:I?y5;
  !!BA:Hy5/?y6;                           [Current Hero]
  !!FU&y6<0:E;                            [Exit if none]
  !!HEy6:S20/?y10;                        [Check for Artillery]
  !!SN:W^H3_Artillery_0_Hero%Y6^/?y71;    [Checke ob der Held Master Artillery hat und Speichere in y71]
  !!SN:W^H3_Artillery_1_Hero%Y6^/?y72;    [Checke ob der Held Grandmaster Artillery hat und Speichere in y72]
  !!HEy6:X?y81/?y82/?y83/?y84/?y85/?y86/?y87 A2/142/d/?y8; [Check Hero Speciality and hero has a 142 Gold Tower Arrow]
  !!SN&y10=3/y71=1:W^007.ShootA.Times^/d1;[Add 1 shot for Master]
  !!SN&y10=3/y72=1:W^007.ShootA.Times^/d1;[Add 1 shot for Grandmaster]
  !!SN&y8=1:W^007.ShootA.Times^/d1;[Add 1 shot for Gold Tower Arrow]

  * Artillery Specialists
  6 Christian 54 Pyre 81 Arlach 97 Gurnisson
  !!if|y6=6/y6=97/y6=54/y6=81;
    !!HEy6:E?y86/?y87/1;
    !!SN:W^007.ShootA.Times^/d1;            [Add 1 Artillery Specialist]
    !!SN&y87>=20:W^007.ShootA.Times^/d1;    [Add 1 Artillery Specialist above level 20]
    !!SN&y87>=40:W^007.ShootA.Times^/d1;    [Add 1 Artillery Specialist above level 40]
  !!en;

  *Ballista Upgrade at Blacksmith can give +1 Shot
  !!SN:W^Ballista_Add_Shots_%Y6^/?y11;
  !!SN&y11=1:W^007.ShootA.Times^/d1;     [Add 1 Artillery Shot for Upgrade]
!!en;

* Commander Specialists can get chance for extra Strike
36 Torosar
!!if&y4>=174/y4<=191;                  [If Commander and A melee Attack]
  !!if|y1=6/y1=7;                        [If melee or Shoot]
  !!BMy2:I?y5;
  !!BA:Hy5/?y6;                           [Current Hero]
  !!FU&y6<0:E;                            [Exit if none]

  !!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active

  !!if&y79=0;
    !!if|y6=36/y6=105/y6=128;              [Pasis, Vey, Torosar]
    !!VRy50:S0T2;
    !!SN&y50=2/y1=6:W^007.AttackA.Times^/d1;[add one strike if success]
    !!SN&y50=2/y1=7:W^007.ShootA.Times^/d1; [add one strike if success]
    !!en;
  !!en;

  !!if&y79=1;
    !!if|y6=36/y6=105;              [Pasis, Vey, Torosar]
    !!VRy50:S0T2;
    !!SN&y50=2/y1=6:W^007.AttackA.Times^/d1;[add one strike if success]
    !!SN&y50=2/y1=7:W^007.ShootA.Times^/d1; [add one strike if success]
    !!en;
  !!en;

  !!en;
!!en;

*Archdevil Set Suite
!!BMy2:I?y5;                            [Get Side and Type]
!!BA:Hy5/?y6;                           [Current Hero]
!!if&y6>=0/y6<=155; if valid hero
  !!FU|y6<0/y4=147/y4=148/y4=149/y4=145:E;[Exit if no Hero or Warmachine]
  !!FU(Count_Set_Pieces):Py6/0/0/0/0/0/0/0/0/0/0/0/?y94; [Count Set Pieces Archdevil Set Suite]
  !!if&y94=5;
    !!VRy50:S0T3;                           [25% chance for extra Strike]
    !!SN&y50=3/y1=6:W^007.AttackA.Times^/d1;[add one strike if success]
    !!SN&y50=3/y1=7:W^007.ShootA.Times^/d1; [add one strike if success]
  !!en;
!!en;


********************HOOK_CODE******************************
!?FU(OnBeforeBattleUniversal);
!!SN:L^EraPlugins\erm_hooker.era^/?y1 Ay1/^SetHook^/?y2;
!!SN:Ey2/1/7381311/(AC_Function_130);   [hook at <after metee_attack>]
!!SN:Ey2/1/4456346/(AC_Function_131);   [hook at <after shoot>]
!?FU(OnAfterBattleUniversal);
!!SN:L^EraPlugins\erm_hooker.era^/?y1 Ay1/^UnsetHook^/?y2;
!!SN:Ey2/1/7381311;
!!SN:Ey2/1/4456346;


!?FU(AC_Function_131);                  [extra_shoot]
!!SN:X?y1/1;                            [edi]
!!SN:W^007.ShootA.Times^/?y30;
!!SN:W^007.ShootA.Times^/0;
!!FU&y30<1:E;
!!VRy2:Sy1+4;                           [esi]
!!UN:Cy2/4/?y10;                        [A_STACK]
!!VRy3:Sy1+16;                          [ebx]
!!UN:Cy3/4/?y20;                        [D_STACK]
!!VRy11:Sy10+52;                        [8#]
!!VRy12:Sy10+76;
!!VRy13:Sy10+656;
!!VRy14:Sy10+688;
!!VRy15:Sy10+704;
!!VRy16:Sy10+216;
!!VRy21:Sy20+52;
!!VRy22:Sy20+76;
!!UN:Cy11/4/?y31;                       [BM:T]16#]
!!UN:Cy12/4/?y32;                       [BM:N]
!!UN:Cy13/4/?y33;                       [BM:G62]
!!UN:Cy14/4/?y34;                       [BM:G70]
!!UN:Cy15/4/?y35;                       [BM:G74]
!!UN:Cy16/4/?y36;                       [BM:U3]
!!UN:Cy21/4/?y41;                       [BM:T]
!!UN:Cy22/4/?y42;                       [BM:N]
!!FU|y31<0/y32<1/y41<0/y42<1/y33>0/y34>0/y35>0/y36<1:E;
!!SN:E4453920/2/y10/y20;
!!VRy30:-1;
!!SN&y30>0:G16;


!?FU(AC_Function_130);                  [extra_metee_attack]
!!SN:X?y1/1;                            [edi]
!!SN:W^007.AttackA.Times^/?y30;
!!SN:W^007.AttackA.Times^/0;
!!FU&y30<1:E;
!!UN:Cy1/4/?y10;                        [y10=A_STACK]
!!VRy2:Sy1+8;
!!UN:Cy2/4/?y3;                         [y3=ebp]
!!VRy4:Sy3+8;                           [ebp+8]
!!UN:Cy4/4/?y5;                         [y5=[ebp+08]
!!VRy6:Sy1+4;
!!UN:Cy6/4/?y20;                        [y20=D_STACK]10#]
!!VRy11:Sy10+52;                        [11#]
!!VRy12:Sy10+76;
!!VRy13:Sy10+656;
!!VRy14:Sy10+688;
!!VRy15:Sy10+704;
!!VRy21:Sy20+52;
!!VRy22:Sy20+76;
!!UN:Cy11/4/?y31;                       [18#]
!!UN:Cy12/4/?y32;
!!UN:Cy13/4/?y33;
!!UN:Cy14/4/?y34;
!!UN:Cy15/4/?y35;
!!UN:Cy21/4/?y41;
!!UN:Cy22/4/?y42;
!!FU|y31<0/y32<1/y41<0/y42<1/y33>0/y34>0/y35>0:E;
!!SN:E4461360/2/y10/y20/y5;
!!VRy30:-1;
!!SN&y30>0:G18;



************************Learning************************************************
** Primary Skill Bonus at level Up  100% Success At Grandmaster Level +100% XP Gain

!?HL-1;                                 [Level up trigger for learning]

!!FU:E;                                 [Replaced by new mechanic see code below]
!!HE-1:N?y1;
!!HEy1:S21/?y3;                         [get Learning level]
!!FU&y3<0:E;

!!SN:W^H3_Learning_0_Hero%Y1^/?y11;     [Checke ob der Held Master Learning hat und Speichere in y11]
!!SN:W^H3_Learning_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Learning hat und Speichere in y12]

!!VRy2&y3=0:S0;
!!VRy2&y3=1:S25;                        [convert bonus to percentage - 20, 35, 50]
!!VRy2&y3=2:S30;
!!VRy2&y3=3:S35;
!!VRy2&y3=3/y11=1/y12=0:S40;
!!VRy2&y3=3/y11=1/y12=1:S50;

!!VRy3:S0T100;                          [roll percentile dice...]
!!FU(AC_Function_24)&y1>=0/y1<=155/y3<y2:Py1/0; [handle learning bonus]

**Second Chance for Learning Specialists
!!VRy3:S0T250;                          [roll percentile dice...]
!!HEy1:X?y23/?y24/?y25/?y26/?y27/?y28/?y29; [Check Hero Speciality]
!!FU(AC_Function_24)&y1>=0/y1<=155/y3<y2/y23=0/y24=21:Py1/1; [handle learning bonus for Learning Specialists]
** End of level up trigger for learning

!?FU(AC_Function_24);                   [Function to give learning bonus to hero -1]

!!HEx1:S21/?y40;                        [get Learning level]
!!FU&y40=0:E;
!!if&y40>0;
!!VRy1:S0T3;                            [random primary skill]
!!VRy2:S31 +y1;                         [picture of skill]
!!HEx1&y1=0:Fd1/d/d/d;                  [give appropriate bonus]
!!HEx1&y1=1:Fd/d1/d/d;
!!HEx1&y1=2:Fd/d/d1/d;
!!HEx1&y1=3:Fd/d/d/d1;
!!HEx1:B0/?z-10;                        [get hero name]

!!SN&x2=0:T^AC_Misc.Learning 1^/?z-9;
!!SN&x2=1:T^AC_Misc.Learning 2^/?z-9;

!!HEx1:O?y3;                            [get owner of this hero]
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]

!!SN:W^Game_Start_Value^/?y10;          [Message Works only after game start]
!!IF&y5=1/1000/y10=10:Q2/y2/1/1/z-9;
!!en;


***Learning Taken from Algors Archievement mod******************
!?OB51;  !!FU(AC_Function_133):P3;      [51  Mercenary Camp]
!?OB23;  !!FU(AC_Function_133):P1;      [23  Marletto Tower]
!?OB61;  !!FU(AC_Function_133):P4;      [61 Star Axis]
!?OB32;  !!FU(AC_Function_133):P2;      [32 Garden of Revelation]
!?OB47;  !!FU(AC_Function_133):P8;      [47 School of Magic]
!?OB107; !!FU(AC_Function_133):P9;      [107  School of War]
!?OB4;   !!FU(AC_Function_133):P7;      [4  Arena]
!?OB41;  !!FU(AC_Function_133):P6;      [41 Library of Enlightenment]


!?FU(AC_Function_133);
!!HE-1:Vx1/?y1; !!SN:W^AC_Learning_Var^/y1; [save objects of this type visited by the hero]

!$OB51;  !!FU(AC_Function_132):P3;
!$OB23;  !!FU(AC_Function_132):P1;
!$OB61;  !!FU(AC_Function_132):P4;
!$OB32;  !!FU(AC_Function_132):P2;
!$OB47;  !!FU(AC_Function_132):P8;
!$OB107; !!FU(AC_Function_132):P9;
!$OB4;   !!FU(AC_Function_132):P7;
!$OB41;  !!FU(AC_Function_132):P6;


!?FU(AC_Function_132);

!!HE-1:Vx1/?y1; !!SN:W^AC_Learning_Var^/?y2; [getting objects of this type visited by the hero]
!!FU&y1=y2:E;                           [Exit if not the same]
!!HE-1:N?y77 B0/?z1 O?y4; !!FU&y4<0:E;  [Exit if no owner]
!!OW:C?y4 Iy4/?y5;                      [get if AI or Human]

!!HEy77:S21/?y3;                        [21  Learning]
!!FU&y3=0:E;
!!SN:W^H3_Learning_0_Hero%Y77^/?y11;    [Checke ob der Held Master Learning hat und Speichere in y11]
!!SN:W^H3_Learning_1_Hero%Y77^/?y12;    [Checke ob der Held Grandmaster Learning hat und Speichere in y12]

!!VRy2&y3=0:S0;
!!VRy2&y3=1:S25;                        [convert bonus to percentage - 20, 35, 50]
!!VRy2&y3=2:S28;
!!VRy2&y3=3:S33;
!!VRy2&y3=3/y11=1/y12=0:S35;
!!VRy2&y3=3/y11=1/y12=1:S40;

!!VRy1:S0T100;                          [calc chance]
!!HEy77:X?y23/?y24/?y25/?y26/?y27/?y28/?y29; [Check Hero Speciality]
!!VRy2&y23=0/y24=21:+15;                [+15% increased chance for learning specialist]

!!if&y1<y2;
  !!VRy1:S31 R3;
  !!VRy1|x1=1:S32; !!VRy1|x1=2:S34; !!VRy1|x1=3:S31; !!VRy1|x1=4:S33; !!VRy1|x1=7/x1=9:S31R1; !!VRy1|x1=8:S33R1;
  !!HEy77&y1=31:Fd1/d/d/d;
  !!HEy77&y1=32:Fd/d1/d/d;
  !!HEy77&y1=33:Fd/d/d1/d;
  !!HEy77&y1=34:Fd/d/d/d1;
    !!if&y5=0;
      !!SN:T^AC_Misc.Learning 3^/?z2/^HeroName^/z1;
      !!IF:Q1/y1/1/1/2;
    !!en;
!!en;


!?HM-1;                                 [Trigger for Hero Movement]
**Set Learning Level for Master and Grandmaster

!!HE-1:N?y1;
!!HEy1:S21/?y10;                        [get Learning level]
!!FU&y10<3:E;

!!SN:W^H3_Learning_0_Hero%Y1^/?y11;     [Checke ob der Held Master Learning hat und Speichere in y11]
!!SN:W^H3_Learning_1_Hero%Y1^/?y12;     [Checke ob der Held Grandmaster Learning hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=0/y12=0:P21/3/40; [SS Werte skill Setzten     [Set Skillvalue to 40% for Expert Learning]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P21/3/60; [SS Werte skill Setzten     [Set Skillvalue to 60% for Master Learning]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P21/3/75; [SS Werte skill Setzten     [Set Skillvalue to 75% for Grandmaster Learning]


************************First Aid **********************************************
*Heal after Combat and +HP of Creatures*

!?FU(OnBeforeBattleUniversal)&1000;     [Continue trigger if any skills are enabled]

** first aid
!!VRv7040:C0/0/0/0/0/0/0;               [no creatures to resurrect after battle attacker]
!!VRv7047:C0/0/0/0/0/0/0;               [no creatures to resurrect after battle defender]
!!BA:M0/0/?y1/?v7040;                   [save qty in each of attacking hero's slots for after battle]
!!BA:M0/1/?y1/?v7041;                   [to determine qty lost for first aid skill]
!!BA:M0/2/?y1/?v7042;
!!BA:M0/3/?y1/?v7043;
!!BA:M0/4/?y1/?v7044;
!!BA:M0/5/?y1/?v7045;
!!BA:M0/6/?y1/?v7046;
!!BA:M1/0/?y1/?v7047;                   [save qty in each of defending hero's slots for after battle]
!!BA:M1/1/?y1/?v7048;                   [to determine qty lost for first aid skill]
!!BA:M1/2/?y1/?v7049;
!!BA:M1/3/?y1/?v7050;
!!BA:M1/4/?y1/?v7051;
!!BA:M1/5/?y1/?v7052;
!!BA:M1/6/?y1/?v7053;


** start of battle end trigger
!?FU(OnAfterBattleUniversal)&1000;      [Continue trigger if any skills are enabled]
** first aid
!!BA:H0/?v7020;                         [get attacking hero #]
!!HEv7020&v7020>-1:O?v7021;             [get attacking hero's owner]

!!if&v7020>=0/v7021>=0;
  !!HEv7020:A2/6/?y7/?y8 S27/?y9;         [see if attacking hero has a First Aid Tent and SS]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0:P1/0; [handle first aid tent for attacker]

  !!HEv7020:E?y47/?y48/1;                 [Check hero Level]
  !!HEv7020:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality First Aid]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0/y21=0/y22=27/y48>=20:P1/0; [handle first aid tent for attacker, heal one additional time of First Aid Specialists if hero level 20]

  !!SN:W^Master_Mage_Hero%V7020^/?y11;
  !!SN:W^Master_Adventurer_Hero%V7020^/?y12;
  !!FU(Improved_FirstAid_Bonus)&y11=1/y12=1:P1/1; [handle first aid tent for attacker do second time if Druid, no tent required]
!!en;

!!BA:H1/?v7020;                         [get defending hero #]
!!FU&v7020<0:E;                         [Exit if no defending Hero]
!!HEv7020:O?v7021;                      [get defending hero's owner]
!!if&v7020>=0/v7021>=0;
  !!HEv7020:A2/6/?y7/?y8 S27/?y9;         [see if defending hero has a First Aid Tent and SS]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0:P2/0; [handle first aid tent for defender]

  !!HEv7020:E?y47/?y48/1;                 [Check hero Level]
  !!HEv7020:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality First Aid]
  !!FU(Improved_FirstAid_Bonus)&y8>0/y9>0/y21=0/y22=27/y48>=20:P2/0; [handle first aid tent for attacker, heal one additional time of First Aid Specialists if hero level 20]

  !!SN:W^Master_Mage_Hero%V7020^/?y11;
  !!SN:W^Master_Adventurer_Hero%V7020^/?y12;
  !!FU(Improved_FirstAid_Bonus)&y11=1/y12=1:P2/1; [handle first aid tent for defender do second time if Druid, no tent required]
!!en;

** function to handle first aid tent
!?FU(Improved_FirstAid_Bonus);          [y1= HP   y2=slot y9= first aid]

!!HEv7020:A2/5/?y7/?y8 E?y3/?y4/1 S27/?y9; [check for Ammo Cart, get hero's level, first aid level]
!!VRy9&x2=1:S3;                         [For Druids Set as Expert First Aid]

!!SN:W^H3_First Aid_0_Hero%V7020^/?y11; [Checke ob der Held Master Offense hat und Speichere in y11]
!!SN:W^H3_First Aid_1_Hero%V7020^/?y12; [Checke ob der Held Grandmaster Offense hat und Speichere in y12]

!!VRy5:S1;                              [set multiplier to 1]
!!VRy5&y8>0:+1;                         [ammo cart bonus]
!!VRy5:+y9;                             [first aid bonus]
!!VRy4:*2;                              [Hero Level*3]
!!VRy5&y11=1:+1;                        [Master Bonus]
!!VRy5&y12=1:+1;                        [Grandmaster Bonus]
!!HEv7020:X?y21/?y22/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality First Aid]
!!VRy5&y21=0/y22=27:+1;                 [+1 Modifier if First Aid Specialist]

!!VRy1:S5T35+y4*y5;                     [first aid tent heal: (5-40 + hero level*2) x bonus multiplier]

!!VRy2:S0T6;                            [random slot # to start search from]
!!SN:W^First_Aid_Heal_Slot^/7;          [7 = slot not found]
!!DO(AC_Function_15)/0/6/1:Px1/y1/y2/x2;[heal next slot with >= 1 monster killed, x2 holds if Druid Heal 1-Yes 0-No]
** end of function

** function to find slot where at least 1 cr was lost
!?FU(AC_Function_15);                   [x1=filter x2=hp healed  x3=slot]

!!VRy4:Sx3 %7;                          [get an actual slot number]
!!BA&x1=1:M0/y4/?y5/?y6;                [get y5 type and y6 qty in slot y3 :attacker]
!!BA&x1=2:M1/y4/?y5/?y6;                [get y5 type and y6 qty in slot y3 :defender]
!!VRy1&x1=1:S7040 +y4;                  [get variable # of previous qty :attacker]
!!VRy1&x1=2:S7047 +y4;                  [get variable # of previous qty :defender]
!!VRy7:Svy1;                            [get previous qty]
!!VRy7:-y6;                             [subtract current qty to get qty lost]
!!SN:W^First_Aid_Heal_Slot^/?y50;       [7 = slot not found]
!!FU(Improved_FirstAid_Bonus2)&y50=7/y7>0/y6>0:Px1/x2/x3/y4/y5/y6/y7/x4; [try to heal stack if some lost but some left x4 holds if Druid Heal 1-Yes 0-No]
!!VRx3:+1;                              [next slot]
** end of function

** function to heal a stack
!?FU(Improved_FirstAid_Bonus2);

!!HEv7020:B0/?z1;                       [get hero's name]
!!MA:Px5/?y8;                           [get hit points of monster x5 into y8]
!!FU|x5<0/y8<1:E;                       [exit if invalid value]
!!VRy5:Sx2;                             [# of hit points to heal]
!!VRy5::y8;                             [divided by monster hit points, rounded down, equals # to save]
!!VRy5&y5>x7:Sx7;                       [can't save more than qty that died]
!!BA&x1=1/y5>0:M0/x4/?x5/dy5;           [restore y5 creatures attacker]
!!BA&x1=2/y5>0:M1/x4/?x5/dy5;           [restore y5 creatures defender]

!!SN&1000/y5=1/x8=0:T^AC_Misc.First Aid 1^/?z-9 Iz-9/?z-9;
!!SN&1000/y5>1/x8=0:T^AC_Misc.First Aid 2^/?z-9 Iz-9/?z-9;

!!SN&1000/y5=1/x8=1:T^AC_Misc.First Aid 3^/?z-9 Iz-9/?z-9;
!!SN&1000/y5>1/x8=1:T^AC_Misc.First Aid 3^/?z-9 Iz-9/?z-9;

!!IF&1000/y5=1:Q2/21/x5/1/z-9;
!!IF&1000/y5>1:Q2/21/x5/1/z-9;
!!UN:R1;                                [redraw screen to show revived creatures]
!!SN&y5>0:W^First_Aid_Heal_Slot^/x4;    [note that we healed a stack if we did]


** end of function

**Health Bonus
!?BF;
*Give health to units based on First Aid Skill level

!!BH0:N?y1;                             [Attacker]
!!HEy1:S27/?y3;                         [Check for First Aid]

!!SN:W^H3_First Aid_0_Hero%Y1^/?y11;    [Checke ob der Held Master Tactics hat und Speichere in y11]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y12;    [Checke ob der Held Grandmaster Tactics hat und Speichere in y12]

!!VRy10&y3=1:S1;
!!VRy10&y3=2:S2;                        [y9 Sets Speed y10 sets Attack and Defense]
!!VRy10&y3=3:S3;
!!VRy10&y3=3/y11=1/y12=0:S4;
!!VRy10&y3=3/y11=1/y12=1:S5;

!!DO(AC_Function_16)/0/20/1&y3>0:Py10;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:S27/?y3;                         [Check for First Aid]
!!FU&y3=0:E;                            [Exit if no Hero]

!!SN:W^H3_First Aid_0_Hero%Y1^/?y11;    [Checke ob der Held Master First Aid hat und Speichere in y11]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y12;    [Checke ob der Held Grandmaster First Aid hat und Speichere in y12]

!!VRy10&y3=1:S1;
!!VRy10&y3=2:S2;                        [y9 Sets Speed y10 sets Attack and Defense]
!!VRy10&y3=3:S3;
!!VRy10&y3=3/y11=1/y12=0:S4;
!!VRy10&y3=3/y11=1/y12=1:S5;

!!DO(AC_Function_16)/21/41/1&y3>0:Py10;

!?FU(AC_Function_16);

!!VRy10&x1=1:S102;                      [2% at basic]
!!VRy10&x1=2:S104;                      [4% at advanced]
!!VRy10&x1=3:S106;                      [6% at expert]
!!VRy10&x1=4:S108;                      [8% at master]
!!VRy10&x1=5:S110;                      [10% at grandmaster]

!!BMx16:H?y1;
!!BMx16:N?y20;                          [Creature Number y20]
!!BMx16:T?y21;                          [Creature Number y20]
!!FU|y20=0/y21=145/y21=146/y21=147/y21=148/y21=149:E; [Exit if zero or Warmachines]
!!VRy2:Sy1*y10:100;
!!VRy2&y2=y1:+1;                        [Min +1HP for low level troops]
!!BMx16:Hy2;

*-------------------------------First Aid Tent---------------------------------*
*Heal in and during Comabt*

!?FU(OnBattleRegeneratePhase);
** First Aid Tent Mod**
**When First Aid Tents turn decrease HP of unit that has already lost some stacks by 1 to avoid First Aid tent skipping turn
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!BMy1:T?y3;                            [Get Creature Number]
!!DO(AC_Function_26)/0/21/1&y3=147/y2=0:P; [Left Side and First Aid Tent]
!!DO(AC_Function_26)/21/41/1&y3=147/y2=1:P; [Right Side and First Aid Tent]


!?FU(AC_Function_26);
!!BMx16:N?y1 H?y2 L?y3 B?y4;
!!BMx16:F?y5;
!!VRy5:&12582912;                       [Check for Clone Spell]
!!FU&y5>0:E;                            [Exit if Clone because they cannot be healed]
!!if&y3=0/y1<>y4;
!!BMx16:L1;                             [Only Reduce HP of creatures that has lost some units and is not full HP and are not cloned]
!!en;

!?FU(OnBeforeBattleUniversal);
!!SN:W^Improved_Tent^/-1;
!?FU(OnAfterBattleUniversal);
!!SN:W^Improved_Tent^/-1;


!?BG0;
*First Aid Tent Turn, get clicked target
!!BG:H?y1;
!!FU&y1=-1:E;
!!SN:W^Tent_Herbalism_%Y1^/?y20;
!!HEy1:S27/?y2;                         [Checke ob der First Aid hat]

!!BG:A?y5 E?y3 N?y4;
!!BMy4:T?y4;
!!SN&y5=11/y4=147/y2>0:W^Improved_Tent^/y3; [Sets Healed Target to Improved Tent if First Aid Skill]

!!if&y5=11/y4=147/y3>=0/y3<=42/y20=1;  [If action is Heal and Valid Target and Upgrade Bought]
    !!FU(AC_ResetSpellFromStack):Py3/42;[42 Curse]
    !!FU(AC_ResetSpellFromStack):Py3/52;[52 My3sfortune]
    !!FU(AC_ResetSpellFromStack):Py3/45;[45 Weakness]
    !!FU(AC_ResetSpellFromStack):Py3/54;[54 Slow]
    !!FU(AC_ResetSpellFromStack):Py3/50;[50 Sorrow]
    !!FU(AC_ResetSpellFromStack):Py3/52;[52 My3sfortune]
    !!FU(AC_ResetSpellFromStack):Py3/62;[62 Bly3nd]
    !!FU(AC_ResetSpellFromStack):Py3/59;[59 Berserk]
    !!FU(AC_ResetSpellFromStack):Py3/60;[60 Hypnoty3ze]
    !!FU(AC_ResetSpellFromStack):Py3/61;[61 Forgetfulness]
    !!FU(AC_ResetSpellFromStack):Py3/70;[Stone]
    !!FU(AC_ResetSpellFromStack):Py3/71;[Poy3son]
    !!FU(AC_ResetSpellFromStack):Py3/72;[By3nd]
    !!FU(AC_ResetSpellFromStack):Py3/73;[Dy3sease]
    !!FU(AC_ResetSpellFromStack):Py3/74;[Paralyze]
    !!FU(AC_ResetSpellFromStack):Py3/75;[Age]
!!en;


!?FU(OnBattleRegeneratePhase);

!!SN:W^Improved_Tent^/?y1;
!!FU&y1=-1:E;
!!SN:W^Improved_Tent^/-1;
!!BA:Q?y2;
!!FU&y2=1:E;                            [Exit in Quick Combat]
!!BMy1:I?y2 I?y4;
!!BA:Hy2/?y2;                           [Attacker]
!!FU&y2<0:E;
!!HEy2:S27/?y3;                         [Checke ob der First Aid hat]
!!FU&y3=0:E;

!!SN&y4=0:W^Tent_Capacity_Att^/?y5;
!!SN&y4=1:W^Tent_Capacity_Def^/?y5;
!!SN&y4=0/y5<0:W^Tent_Capacity_Att^/0;
!!SN&y4=1/y5<0:W^Tent_Capacity_Def^/0;
!!VRy5&y5<0:S0;

!!FU(AC_Function_35)&y5>0:Py1/y3/y5;    [The function only runs if enough Heal capacity is left]
!!SN:W^Improved_Tent^/-1;

!!SN:W^Tent_Number_Att^/?y2;            [Set new heal capacity for Tent]
!!if&y2>=0/y2<=20/y4=0;
!!SN:W^Tent_Capacity_Att^/?y10;
!!BMy2:U1/y10 U2/y10;                   [Set Tent damage]
!!en;

!!SN:W^Tent_Number_Def^/?y2;
!!if&y2>=21/y2<=41/y4=1;
!!SN:W^Tent_Capacity_Def^/?y10;
!!BMy2:U1/y10 U2/y10;                   [Set Tent damage]
!!en;

!!FU&y5=0:E;
!!BA:Q?f;
!!BU&f=0:R;


!?FU(AC_Function_35);                   [*Restore HP of Healed creatures*]

!!BMx1:N?y1 H?y2 L?y3 B?y4;

!!FU&y4=0:E;
!!FU&y2=0:E;
!!FU&y1=y4/y3=0:E;

!!BMx1:I?y60;                           [Acting Side Monster]
!!BA:Hy60/?y61;                         [Current Hero]
!!SN:W^H3_First Aid_0_Hero%Y61^/?y71;   [Checke ob der Held Master First Aid hat und Speichere in y71]
!!SN:W^H3_First Aid_1_Hero%Y61^/?y72;   [Checke ob der Held Grandmaster First Aid hat und Speichere in y72]
!!HEy61:X?y81/?y82/?y83/?y84/?y85/?y86/?y87; [Check Hero Speciality]
!!HEy61:E?y73/?y74/1;
!!VRy75:Sy74*10;                        [10 times the Hero Level additional heal]

!!VRy10&x2=1:S30 +y75;                  [Set Heal for Basic]
!!VRy10&x2=2:S50 +y75;                  [Set Heal for Advanced]
!!VRy10&x2=3/y71=0/y72=0:S75 +y75;      [Set Heal for Expert]
!!VRy10&x2=3/y71=1/y72=0:S150 +y75;     [Set Heal for Master]
!!VRy10&x2=3/y71=1/y72=1:S250 +y75;     [Set Heal for Grandmaster]

!!VRy76&y81=0/y82=27:S110+y74;          [Specialists have increased Heal 110%+HLvL%]
!!VRy10&y81=0/y82=27:*y76:100;          [multiply heal with 110 + Hero Level]

!!CO-1:D?y40;                           [Check if Commander of Hero is still alive]
!!CO-1:T?y41;                           [Check if Commander Type]
!!if&y40=0/y41=1;                      [If Commander alive and is a Hierophant]
  !!CO-1:X2/?y42;                       [Get Commander Level]
  !!VRy43:Sy42*10;                      [Multiply level of Commander with 10]
  !!VRy10:+y43;                         [Add level*10 HP to heal for the First Aid Tent]
!!en;

!!VRy10::2; !!VRy10:Sy10Ry10;           [Divide Heal trough 2 and Set range to half + R(half)]

!!SN:W^Tent_Improved_%Y61^/?y70;
!!if&y70=1;                            [If WM upgrade bought]
  !!VRy10:*125:100;                     [Increase Heal Amount by 25%]
!!en;

*!VRy10:S1000; Test

!!SN&f=0:T^AC_Misc.Battle Heal^/?z2/^Heal^/y10;
!!BU&f=0:Mz2;

!!VRy20:Sy10*-1;
!!SN&y60=0:W^Tent_Capacity_Att^/dy20;
!!SN&y60=1:W^Tent_Capacity_Def^/dy20;
!!SN&y60=0:W^Tent_Capacity_Att^/?y21;
!!SN&y60=1:W^Tent_Capacity_Def^/?y21;
!!SN&y60=0/y21<=0:W^Tent_Capacity_Att^/0;
!!SN&y60=1/y21<=0:W^Tent_Capacity_Def^/0;

!!VRy12:Sy10 %y2;                       [Divide Amount of Heal durch HP]
!!VRy15:Sy3;                            [Set to lost life]
!!VRy15:Sy15-y12;                       [Lost life - difference from Heal]
!!VRy16:Sy15;
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;                          [Calc correct rest life]
!!VRy16:*-1;
!!VRy17:Sy2;
!!VRy17:-y16;
!!VRy16:Sy17;
!!VRy11:+1;                             [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy40:Sy6-1;
!!VRy16&y6>y4:S0;                       [Fix for Commander, Set lost life to zero if could heal more than 1 stack above maximum]
!!VRy6&y6>=y4:Sy4;                      [Set Number Cannot be more than before fight]

!!SN:W^Tent_Overheal_%Y61^/?y80;        [Overheal gives chance to additional raise troops when you heal them, over the current limit]
!!BMx1:N?y8 B?y9 T?y10 H?y17 G4/?y18/?y19; [Check Monster Parameters and for Disguise]

!!BMx1:Ny6 Ly16;                        [Set Number and apply rest life]

*!IF:L^y8 is %Y8 and y9 is %Y9 und y80 is %Y80 Disguse %Y18 und %Y19^;

!!if&y80=1/y8<y9/y19=0;                [If below number as before fight, no Henchman and no Commander]
!!if|y10<174/y10>191;
  !!MA:Ly10/?y11;                       [Get Monster Level]
  !!VRy13:S0; !!VRy13&y11=0:S6; !!VRy13&y11=1:S5; !!VRy13&y11=2:S4; !!VRy13&y11=3:S3; !!VRy13&y11=4:S2; !!VRy13&y11=5:S1; !!VRy13&y11=6:S1; [Number of possible revices based on creature level]
  !!VRy15:S0T99;
  !!VRy16&y11=0:S80; !!VRy16&y11=1:S75; !!VRy16&y11=2:S70; !!VRy16&y11=3:S65; !!VRy16&y11=4:S63; !!VRy16&y11=5:S58; !!VRy16&y11=6:S35; [Chance for Overheal to work in percent]

  !!SN&y60=0:W^Tent_Capacity_Att^/?y21; [Get current Heal capacity]
  !!SN&y60=1:W^Tent_Capacity_Def^/?y21;
  !!if&y16>y15/y21>0;                  [If roll successfull and still heal capacity left]
    !!BMx1:Ndy13 Bdy13;                 [Add One Extra Creature if already full and roll is successfull]
    !!VRy20:Sy13*y17+100*-1;            [Get total HP over overheald creatures +100HP as Heal Capacity]
    !!SN&y60=0:W^Tent_Capacity_Att^/dy20;[Substract Resurrected Amount from current capacity]
    !!SN&y60=1:W^Tent_Capacity_Def^/dy20;
    !!SN&y60=0:W^Tent_Capacity_Att^/?y21;
    !!SN&y60=1:W^Tent_Capacity_Def^/?y21;
    !!SN&y60=0/y21<=0:W^Tent_Capacity_Att^/0; [If below zero set zero]
    !!SN&y60=1/y21<=0:W^Tent_Capacity_Def^/0;
    *!IF:M^%Y8 %Y9 %Y10 Number:%Y13 Chance:%Y16 Roll:%Y15
    New Capacity is %Y21 and deduceted amount is %Y20^;
!!en;
!!en;

!!SN:W^Tent_Gold_Gain_%Y61^/?y1;
!!SN&y1=1/y60=0:W^Total_Healed_Amount_Att^/dy10; [Save value for attacker]
!!SN&y1=1/y60=1:W^Total_Healed_Amount_Def^/dy10; [Save value for defender]

*!IF:M^Heal is %Y10
Number at Battle Start is%Y1
Rest Life is%Y3
and Battle Start is%Y4
Set Number %Y6 and
Number of Possible Revives is %Y11
Rest Life is%Y16
and creature is %X1^;

*?HM-1; Test
*!HE-1:N?y61;
*!SN:W^Tent_Overheal_%Y61^/1; Test

!?FU(OnAfterBattleUniversal);

!!BA:O?y1/?y20;                         [Check both Owners after Battle]
!!SN:W^Hero_Attacker_Owner0^/?y10;      [check saved owner]
!!if&y1=y10;                           [run if the same]
!!BA:H0/?y2;                            [get battle hero]
!!HEy2:A2/6/?y5/?y6;                    [check 6  First Aid Tent]
!!SN:W^Tent_Gold_Gain_%Y2^/?y3;         [check upgarde]
!!SN:W^Total_Healed_Amount_Att^/?y4;    [check healed amount]
!!VRy4:*3;                              [3 times the amount heal in gold]
!!OW&y6=1/y3=1/y4>0:Ry1/6/dy4;          [Give gold to player if He has First Aid Tent and Upgrade Bought]
!!en;

!!BA:H1/?y2;                            [Defender]
!!FU|y2<0/y20<0:E;
!!SN:W^Hero_Defender_Owner0^/?y30;
!!if&y20=y30;
!!HEy2:A2/6/?y5/?y6;                    [6  First Aid Tent]
!!SN:W^Tent_Gold_Gain_%Y2^/?y3;
!!SN:W^Total_Healed_Amount_Def^/?y4;    [check healed amount]
!!VRy4:*3;                              [3 times the amount heal in gold]
!!OW&y6=1/y3=1/y4>0:Ry20/6/dy4;         [Give gold to player if He has First Aid Tent and Upgrade Bought]
!!en;


!?BF;

!!SN:W^Total_Healed_Amount_Att^/0;      [Reset value before any fight]
!!SN:W^Total_Healed_Amount_Def^/0;
!!SN:W^Tent_Number_Att^/-1;
!!SN:W^Tent_Number_Def^/-1;
!!SN:W^Tent_Capacity_Att^/0;
!!SN:W^Tent_Capacity_Def^/0;
!!SN:W^Army_Att^/1;
!!SN:W^Army_Def^/1;

!!DO(AC_Function_27)/0/41/1:P2;

!!BA:H0/?y1;                            [Attacker Hero]
!!HEy1:S27/?y3;                         [Checke ob der First Aid hat]
!!SN:W^H3_First Aid_0_Hero%Y1^/?y30;    [Checke ob der Held Master First Aid hat und Speichere in y30]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y31;    [Checke ob der Held Grandmaster First Aid hat und Speichere in y31]
!!VRy5:S0;
!!VRy5&y3=1:S100; !!VRy5&y3=2:S200; !!VRy5&y3=3/y30=0/y31=0:S300; !!VRy5&y3=3/y30=1/y31=0:S500; !!VRy5&y3=3/y30=1/y31=1:S1000;

!!SN:W^Army_Att^/?y10;
!!SN:W^Tent_Number_Att^/?y2;
!!if&y2>=0/y2<=20;
!!VRy10::50 +y5;                        [Take 2% of total army strength + bonus based on First Aid level]
!!SN:W^Tent_Capacity_Upgrade_%Y1^/?y11; [For Blacksmith Upgrade at +500 capacity to heal]
!!VRy10&y11=1:+500;
!!SN:W^Tent_Capacity_Att^/y10;
!!BMy2:U1/y10 U2/y10;                   [Set Tent damage]
!!en;

!!BA:H1/?y1;                            [Defender Hero]
!!if&y1>0;
!!HEy1:S27/?y3;                         [Checke ob der First Aid hat]
!!SN:W^H3_First Aid_0_Hero%Y1^/?y30;    [Checke ob der Held Master First Aid hat und Speichere in y30]
!!SN:W^H3_First Aid_1_Hero%Y1^/?y31;    [Checke ob der Held Grandmaster First Aid hat und Speichere in y31]
!!VRy5:S0;
!!VRy5&y3=1:S100; !!VRy5&y3=2:S200; !!VRy5&y3=3/y30=0/y31=0:S300; !!VRy5&y3=3/y30=1/y31=0:S500; !!VRy5&y3=3/y30=1/y31=1:S1000;

!!SN:W^Army_Def^/?y10;
!!SN:W^Tent_Number_Def^/?y2;
!!if&y2>=21/y2<=41;
!!VRy10::50 +y5;                        [Take 2% of total army strength + bonus based on First Aid level]
!!SN:W^Tent_Capacity_Upgrade_%Y1^/?y11; [For Blacksmith Upgrade at +500 capacity to heal]
!!VRy10&y11=1:+500;
!!SN:W^Tent_Capacity_Def^/y10;
!!BMy2:U1/y10 U2/y10;                   [Set Tent damage]
!!en;
!!en;


!?FU(AC_Function_27);                   [increase Units Stats]
!!BMx16:T?y1 N?y2 H?y3;
!!if&x1=2;
!!BMx16|y1=146/y1=147/y1=148:N1 B1;     [Set all Warmachines to 1]
!!SN&x16<=20/y1=147:W^Tent_Number_Att^/x16;
!!SN&x16>20/y1=147:W^Tent_Number_Def^/x16;
!!en;

!!FU|y1=146/y1=147/y1=148/y1=149:E;     [Dont count Warmachines to total army strength]
!!if&y2>0;                             [calc total Army Strength]
!!VRy10:Sy2*y3;
!!SN&x16<=20:W^Army_Att^/dy10;
!!SN&x16>=21:W^Army_Def^/dy10;
!!SN&x16<=20:W^Army_Att^/?y11;
!!en;


!?MM0;
*Fix for showing zero damage when tents turn on right click
!!MM:D?y1;
!!if&y1>=0/y1<=186;
!!BU:Ey1/?y2;
!!BMy2&y2>=0/y2<=41:T?y3;
!!FU&y3<>147:E;
!!BMy2:I?y4;
!!SN&y4=0:W^Tent_Capacity_Att^/?y5;
!!SN&y4=1:W^Tent_Capacity_Def^/?y5;
!!BMy2&y4=0:U1/y5 U2/y5;
!!BMy2&y4=1:U1/y5 U2/y5;
!!en;


!?FU(AC_AC_ResetSpellFromStack);
; x1 - stack id
; x2 - spell id
!!UN:C6919200/4/?y10;
!!VRy1:Sx1 *1352 +21708 +y10;
!!SN:E4473392/2/y1/x2;

**************************Scholar***********************************************
**Restores 3,4,5,7,10 Spell Points when heroes meets once per day and hero

Before the interaction of the hero with the hero
!?FU77010&1000;
!!SN:X?y1/?y2;                          [the number of the initiator hero, the number of the target hero.]

!!HEy1:O?y5;
!!HEy2:O?y6;
!!FU&y5<>y6:E;                          [Exit if heroes not from the same player]

!!VRy60:Si^timerDay^;
!!SN:W^H3_Scholar_H1%Y1_H2%Y2^/?y10;
!!FU&y10=y60:E;                         [Exit if they have already met today]
!!SN:W^H3_Scholar_H1%Y2_H2%Y1^/?y10;
!!FU&y10=y60:E;                         [Exit if they have already met today]

!!HEy1:S18/?y5;
!!HEy2:S18/?y6;
!!FU&y5=0/y6=0:E;                       [Exit if no hero has Scholar]

!!SN:W^H3_Scholar_0_Hero%Y1^/?y11;      [Checke ob der Held Master Scholar hat und Speichere in y11]
!!SN:W^H3_Scholar_1_Hero%Y1^/?y12;      [Checke ob der Held Grandmaster Scholar hat und Speichere in y12]
!!SN:W^H3_Scholar_0_Hero%Y2^/?y13;      [Checke ob der Held Master Scholar hat und Speichere in y11]
!!SN:W^H3_Scholar_1_Hero%Y2^/?y14;      [Checke ob der Held Grandmaster Scholar hat und Speichere in y12]

!!VRy7:S0;                              [Determine highest Scholar Level]
!!VRy7&y5=1:S3; !!VRy7&y5=2:S4; !!VRy7&y5=3:S5; !!VRy7&y11=1:S7; !!VRy7&y12=1:S10;
!!VRy7&y6=1/y7<3:S3; !!VRy7&y6=2/y7<4:S4; !!VRy7&y6=3/y7<5:S5; !!VRy7&y13=1/y7<7:S7; !!VRy7&y14=1/y7<10:S10;

!!HEy1:X?y40/?y41/?y42/?y43/?y44/?y45/?y46; [Scholar Specialist Handling + HeroLvl:5+1 extra SP regeneration]
!!HEy1&y40=0/y41=18:E?y47/?y48/1;       [Check hero Level]
!!VRy48&y40=0/y41=18::5+1;
!!VRy7&y40=0/y41=18:+y48;
!!HEy2:X?y40/?y41/?y42/?y43/?y44/?y45/?y46;
!!HEy2&y40=0/y41=18:E?y47/?y48/1;
!!VRy48&y40=0/y41=18::5+1;
!!VRy7&y40=0/y41=18:+y48;

!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py1/0/?y30/1; [Return Max possible spell points for left Hero]
*!IF:M^Left %Y1 and Right %Y2 and recovered Mana is %Y7 and Max SP are %Y30^;
!!HEy1:I?y8/1;
!!VRy30&y8>y30:Sy8;                     [If Mana is already over Max just set to same value again]
!!VRy8:+y7;                             [Add SP to reg to current Mana]
!!HEy1&y8<=y30:Idy7/1;
!!HEy1&y8>=y30:Iy30/1;

!!FU(Intelligence_Set_Spell_Points)&y2>=0/y2<=155:Py2/0/?y30/1;
!!HEy2:I?y8/1;
!!VRy30&y8>y30:Sy8;                     [If Mana is already over Max just set to same value again]
!!VRy8:+y7;
!!HEy2&y8<=y30:Idy7/1;
!!HEy2&y8>=y30:Iy30/1;

!!SN:W^H3_Scholar_H1%Y1_H2%Y2^/y60;     [Set Flag so it can only happen once]
!!SN:W^H3_Scholar_H1%Y2_H2%Y1^/y60;

******************Sorcery Offense Armorer Archery*******************************
[Set Secondary Skill Percents]
!?FU(OnOpenHeroScreen);                 [Open Hero Screen Trigger  to Adjust Sorcery Spell Damage when clicked on Book]
!!HE-1:N?y1;
!!FU(Switch_Secondary_Skill_Level)&y1>=0/y1<=155:Py1/y1; [Pass Hero Number]

**Set Correct Values for New Offense for Attacking and Retaliation
!?FU(OnCombatRound)&v997=0;             [On First visible combat round]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:Q?y1;                              [Get current attacking side]
!!BA:Hy1/?y2;                           [Get current hero]
!!VRy1:-1 *-1;                          [Get opposing hero]
!!BA:Hy1/?y3;
!!FU(Switch_Secondary_Skill_Level)&y2>=0/y2<=155:Py2/y3; [Pass Hero Number]

!?FU(OnBattleRegeneratePhase);          [Set Secondary Skill Percents in Battle]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1/?y2/0;                        [get who moves]
!!VRy2:Sy1:21;                          [get side]
!!BHy2:N?y1;                            [get owner of current side]
!!VRy2:-1 *-1;
!!BHy2:N?y3;                            [get owner of other side]
!!FU(Switch_Secondary_Skill_Level)&y1>=0/y1<=155:Py1/y3; [Pass Hero Number]

!?FU7773;                               [afer stack attack]
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:Q?y1;
!!VRy1:-1 *-1;
!!BA:Hy1/?y2;
!!VRy1:-1 *-1;
!!BA:Hy1/?y3;
!!FU(Switch_Secondary_Skill_Level)&y2>=0/y2<=155:Py2/y3; [Pass Hero Number]
!!FU(Switch_Secondary_Skill_Level)&y2=-2:Py3/y3; [Pass Hero Number in case no enemy hero]


!?FU(Switch_Secondary_Skill_Level);

!!HEx1:S1/?y10;                         [Check for Archery]
!!SN:W^H3_Archery_0_Hero%X1^/?y11;      [Checke ob der Held Master Archery hat und Speichere in y11]
!!SN:W^H3_Archery_1_Hero%X1^/?y12;      [Checke ob der Held Grandmaster Archery hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P1/3/65; [SS Werte skill Setzten      [Set Skillvalue to 65% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P1/3/75; [SS Werte skill Setzten      [Set Skillvalue to 75% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P1/3/50; [SS Werte skill Setzten            [Set back to normal Expert value 50% if no improvement]

*!if&x2>=0/x2<=155; Game values are ignored, calculation happens in EE script
  *!HEx2:S11/?y10;                        [Check for Eagle Eye]
  *!SN:W^H3_Eagle Eye_0_Hero%X2^/?y11;    [Checke ob der Held Master Eagle Eye hat und Speichere in y11]
  *!SN:W^H3_Eagle Eye_1_Hero%X2^/?y12;    [Checke ob der Held Grandmaster Eagle Eye hat und Speichere in y12]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P11/3/85; [SS Werte skill Setzten     [Set Skillvalue to 85% for Master]
  *!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P11/3/100; [SS Werte skill Setzten    [Set Skillvalue to 100% for GrandMaster]
  *!FU(SetSecSkillPercent)&y11=0/y12=0:P11/3/75; [SS Werte skill Setzten           [Set back to normal Expert value 75% if no improvement]
*!en;

!!HEx1:S22/?y10;                        [Check for Offense]
!!SN:W^H3_Offense_0_Hero%X1^/?y11;      [Checke ob der Held Master Offense hat und Speichere in y11]
!!SN:W^H3_Offense_1_Hero%X1^/?y12;      [Checke ob der Held Grandmaster Offense hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P22/3/35; [SS Werte skill Setzten     [Set Skillvalue to 35% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P22/3/40; [SS Werte skill Setzten     [Set Skillvalue to 40% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P22/3/30; [SS Werte skill Setzten           [Set back to normal Expert value 30% if no improvement]

!!if&x2>=0/x2<=155;
  !!HEx2:S23/?y10;                        [Check for Armorer]
  !!SN:W^H3_Armorer_0_Hero%X2^/?y11;      [Checke ob der Held Master Armorer hat und Speichere in y11]
  !!SN:W^H3_Armorer_1_Hero%X2^/?y12;      [Checke ob der Held Grandmaster Armorer hat und Speichere in y12]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P23/3/20; [SS Werte skill Setzten     [Set Skillvalue to 20% for Master]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P23/3/25; [SS Werte skill Setzten     [Set Skillvalue to 25% for GrandMaster]
  !!FU(SetSecSkillPercent)&y11=0/y12=0:P23/3/15; [SS Werte skill Setzten           [Set back to normal Expert value 15% if no improvement]
!!en;

!!HEx1:S25/?y10;                        [Check for Sorcery]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y11;      [Checke ob der Held Master Sorcery hat und Speichere in y11]
!!SN:W^H3_Sorcery_1_Hero%X1^/?y12;      [Checke ob der Held Grandmaster Sorcery hat und Speichere in y12]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P25/3/40; [SS Werte skill Setzten     [Set Skillvalue to 40% for Master]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P25/3/50; [SS Werte skill Setzten     [Set Skillvalue to 50% for GrandMaster]
!!FU(SetSecSkillPercent)&y11=0/y12=0:P25/3/30; [SS Werte skill Setzten           [Set back to normal Expert value 30% if no improvement]

!!if&x2>=0/x2<=155;
  !!HEx2:S26/?y10;                        [Check for Resistance]
  !!SN:W^H3_Resistance_0_Hero%X2^/?y11;   [Checke ob der Held Master Resistance hat und Speichere in y11]
  !!SN:W^H3_Resistance_1_Hero%X2^/?y12;   [Checke ob der Held Grandmaster Resistance hat und Speichere in y12]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P26/3/25; [SS Werte skill Setzten     [Set Skillvalue to 25% for Master]
  !!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P26/3/30; [SS Werte skill Setzten     [Set Skillvalue to 30% for GrandMaster]
  !!FU(SetSecSkillPercent)&y11=0/y12=0:P26/3/20; [SS Werte skill Setzten           [Set back to normal Expert value 20% if no improvement]
!!en;


**************************Intelligence******************************************
**Increase max Spell Points to 150% at GM and regenerates Heroes Mana when in Towns*

!?FU(OnEveryDay)&i^timerIsAi^=0;
!!UN:U98/-1/?y1;                        [Get tower coordinates to y1]
!!DO(AC_Function_17)/1/y1/1&y1>0:P;     [Loop all Towns]

!?FU(AC_Function_17);
!!UN:U98/-1/x16/1;                      [Get the index of the tower coordinates to x16]
!!CA1:G?y10;                            [Mage Guilt Built]
!!FU&y10=0:E;
!!VRy20:Si^timerWeek^;                        [Put Current Week in Y20]

!!CA1:H0/?y2;                           [Check the garrison hero number]
!!if&y2>=0;
  !!CA1:T?y50;
  !!VRy51:S0;
  !!CA1&y50=5:B3/1;                     [Special Building Built]
  !!SN:W^Mana_Vortex_Hero%Y2_Week_%Y20^/?y3; [So it only works once per Week]
  !!VRy51&-1/y50=5/y3=1:S0;             [Set to zero if no Mana Vortex]
  !!VRy51&1/y50=5/y3=0:S1;
  !!FU(Intelligence_Set_Spell_Points)&y2>=0/y2<=155:Py2/y51/0/0; [If y51=1 Means Double Spell Points and x4=0 means Set]
  !!SN&y3=0:W^Mana_Vortex_Hero%Y2_Week_%Y20^/1;
!!en;

!!CA1:H1/?y2;                           [Check the garrison hero number]
!!FU&y2=-1:E;                           [Exit if no Hero]
!!CA1&y2>=0:T?y50;
!!VRy51:S0;
!!CA1&y50=5/y2>=0:B3/1;                 [Special Building Built]
!!SN:W^Mana_Vortex_Hero%Y2_Week_%Y20^/?y3; [So it only works once per Week]
!!VRy51&-1/y50=5/y3=1:S0;
!!VRy51&1/y50=5/y3=0:S1;
!!FU(Intelligence_Set_Spell_Points)&y2>=0/y2<=155:Py2/y51/0/0; [If y51=1 Means Double Spell Points and x4=0 means Set]
!!SN&y3=0:W^Mana_Vortex_Hero%Y2_Week_%Y20^/1;


!?FU(Intelligence_Set_Spell_Points);
x1=Hero Id,  x2=1 double Spell Points   x3=Returns Max Spell Points   x4=1 to only check and not set SP 0 means Set

!!HEx1:S24/?y6;                         [(Get Intelligence level)]
!!HEx1:E?y47/?y48/1;                    [(Get Hero level)]
!!VRy5:S0;

!!HEx1:F?y33/?y34/?y35/?y5;             [(get knowledge of hero)]
!!VRy7:Sy5*10;                          [(multiply with 10 and save for later :) )]
!!VRy5:*10;                             [(multiply with 10)]

!!SN:W^H3_Intelligence_0_Hero%X1^/?y11; [Checke ob der Held Master Intelligence hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y12; [Checke ob der Held Grandmaster Intelligence hat und Speichere in y12]

!!VRy5&y6=3/y11=1/y12=1:*5:2;           [(150% if Grandmaster Intelligence is present)]
!!VRy5&y6=3/y11=1/y12=0:*9:4;           [(125% if Master Intelligence is present)]
!!VRy5&y6=3/y11=0/y12=0:*2;             [(100% if Expert Intelligence is present)]
!!VRy5&y6=2:*3:2;                       [(50% if Advanced Intelligence is present)]
!!VRy5&y6=1:*5:4;                       [(25% if Basic Intelligence is present)]

!!HEx1:X?y50/?y51/d/d/d/d/d;            [Check Hero Speciality]
!!if&y50=0/y51=24;                     [Handle Intelligence Specialists]
!!FU(Skill_Value_Database):Px1/24/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]
!!VRy8&y6=3/y11=1/y12=1:S150;
!!VRy8&y6=3/y11=1/y12=0:S125;
!!VRy8&y6=3/y11=0/y12=0:S100;
!!VRy8&y6=2:S50;
!!VRy8&y6=1:S25;
!!VRy8:+y71+100;                        [Add Level Increase +Intelligence percents and than multiply the value with base Spell Points]
!!VRy5:Sy7*y8:100;                      [Calc Increases Spell Points Value]
!!en;

!!VRy5&x2=1:*2;
!!HEx1:I?y6/1;                          [(Check Hero Spell Points)]

!!VRx3:Sy5;                             [Set Max possible Spell Points to return in x3]
!!HEx1&y5>y6/x4=0:Iy5/1;                [(Set hero spell points to Max only if smaller than current SP)]


!?FU(OnOpenHeroScreen);                 [Open Hero Screen to Show Correct Max Spell Points]
!!HE-1:N?y1;
!!FU(Hero_Intelligence_Loop)&y1>=0/y1<=155:Py1;


!?FU(OnCloseHeroScreen);
!!FU(SetSecSkillPercent):P24/3/100;     [SS Werte skill Setzten]


!?FU(Hero_Intelligence_Loop);
!!HEx1:S24/?y10;                        [Check for Intelligence]
!!FU&y10<3:E;
!!SN:W^H3_Intelligence_0_Hero%X1^/?y11; [Checke ob der Held Master Intelligence hat und Speichere in y11]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y12; [Checke ob der Held Grandmaster Intelligence hat und Speichere in y12]

!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=0:P24/3/125; [SS Werte skill Setzten]
!!FU(SetSecSkillPercent)&y10=3/y11=1/y12=1:P24/3/150; [SS Werte skill Setzten]
!!FU(SetSecSkillPercent)&y10=3/y11=0/y12=0:P24/3/100; [SS Werte skill Setzten]

!?OB49&1000;                            [Visit Magic Well]

!!HE-1:N?y1;
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py1/0;

!$OB48&1000;                            [Visit Magic Spring]

!!HE-1:N?y1;
!!VRy2:Si^timerWeek^;
!!SN:W^Magic_Spring_Hero%Y1_Week_%Y2^/?y3; [So it only works once per Week]
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155/y3=0:Py1/1; [If x2=1 Means Double Spell Points Once a Week]
!!SN&y3=0:W^Magic_Spring_Hero%Y1_Week_%Y2^/1;


**************************Nobility**********************************************
**Once a Week if a Hero with Nobility visits a Castle additional Creatures can he hired
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>0/i^timerWeekDay^=1/i^timerIsAi^=0;

!!DO(AC_Function_18)/0/155/1:P;

!?HM-1;
!!HE-1:N?y1;
!!SN:W^H3_Nobility_Hero%Y1_Active^/?y2;
!!SN&y2=2:W^H3_Nobility_Hero%Y1_Active^/1;

!?FU(AC_Function_18);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!SN:W^H3_Nobility_Hero%X16_Active^/1;

!?CM1&1000;                             [Town Screen Trigger]
!!CA-1:H1/?y5;                          [town Visitor]
!!FU(Hero_Nobility_Loop)&y5>=0/y5<=155:Py5; [Jump to Nobility Function]
!!CA-1:H0/?y5;                          [town garrison]
!!FU(Hero_Nobility_Loop)&y5>=0/y5<=155:Py5; [Jump to Nobility Function]

!?FU(Hero_Nobility_Loop);

!!SN:W^H3_Nobility_Hero%X1_Active^/?y1;
!!FU&y1=0:E;                            [Exit so it only happens once per week]

!!HEx1:S5/?y10;                         [Check for Nobility]
!!FU&y10=0:E;                           [Exit if no Nobility]

!!if&y1=2;
!!CM:I?y2 F?y3;
!!if&y3=512;
!!VRy1|y2=7/y2=8/y2=9:S1;               [Fort Citadel Castle]
!!SN&y1=1:W^H3_Nobility_Hero%X1_Active^/1;
!!FU&y1=2:E;
!!en;
!!en;

!!FU&y1<>1:E;

!!SN:W^H3_Nobility_0_Hero%X1^/?y11;     [Checke ob der Held Master Nobility hat und Speichere in y11]
!!SN:W^H3_Nobility_1_Hero%X1^/?y12;     [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]

*Level 1*                      *Level 2*                      *Level 3*                      *Level 4*                     *Level 5*                     *Level 6*                     *Level 7*
!!VRy21&y10=1:S6;              !!VRy22&y10=1:S4;              !!VRy23&y10=1:S3;              !!VRy24&y10=1:S2;             !!VRy25&y10=1:S1;             !!VRy26&y10=1:S0;             !!VRy27&y10=1:S0; [Basic]
!!VRy21&y10=2:S9;              !!VRy22&y10=2:S5;              !!VRy23&y10=2:S4;              !!VRy24&y10=2:S3;             !!VRy25&y10=2:S2;             !!VRy26&y10=2:S1;             !!VRy27&y10=2:S0; [Advanced]
!!VRy21&y10=3/y11=0/y12=0:S14; !!VRy22&y10=3/y11=0/y12=0:S6;  !!VRy23&y10=3/y11=0/y12=0:S5;  !!VRy24&y10=3/y11=0/y12=0:S4; !!VRy25&y10=3/y11=0/y12=0:S3; !!VRy26&y10=3/y11=0/y12=0:S2; !!VRy27&y10=3/y11=0/y12=0:S1; [Expert]
!!VRy21&y10=3/y11=1/y12=0:S20; !!VRy22&y10=3/y11=1/y12=0:S10; !!VRy23&y10=3/y11=1/y12=0:S6;  !!VRy24&y10=3/y11=1/y12=0:S5; !!VRy25&y10=3/y11=1/y12=0:S4; !!VRy26&y10=3/y11=1/y12=0:S3; !!VRy27&y10=3/y11=1/y12=0:S1; [Master]
!!VRy21&y10=3/y11=1/y12=1:S25; !!VRy22&y10=3/y11=1/y12=1:S15; !!VRy23&y10=3/y11=1/y12=1:S10; !!VRy24&y10=3/y11=1/y12=1:S8; !!VRy25&y10=3/y11=1/y12=1:S6; !!VRy26&y10=3/y11=1/y12=1:S4; !!VRy27&y10=3/y11=1/y12=1:S2; [Grandmaster]
**Y21 bis Y27  is level 1 til 7


!!HEx1:X?y40/?y41/?y42/?y43/?y44/?y45/?y46; [Check Hero Speciality]
!!if&y40=0/y41=5;                      [If Nobility Specialist]
!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:*3 +100;                        [3% extra Growth per Hero Level]
!!VRy21:*y48:100; !!VRy22:*y48:100; !!VRy23:*y48:100; !!VRy24:*y48:100; !!VRy25:*y48:100; !!VRy26:*y48:100; !!VRy27:*y48:100;
!!en;

!!HEx1:A2/66/?y49/?y66;
!!HEx1:A2/67/?y49/?y67;
!!HEx1:A2/68/?y49/?y68;
!!VRy33&y66=1/y67=1/y68=1:S1;           [Double Bonus if complete Set]

!!if&y68=1;                            [If Ambassador's Sash equipped]
!!VRy21:+6; !!VRy22:+5; !!VRy23:+4; !!VRy24:+3; !!VRy25:+2; !!VRy26:+1; !!VRy27:+0;
!!if&y33=1;                            [If complete Set]
!!VRy21:+6; !!VRy22:+5; !!VRy23:+4; !!VRy24:+3; !!VRy25:+2; !!VRy26:+1; !!VRy27:+1;
!!en;
!!en;

!!VRy1:S1;
[:loopTownDwellings]
!!VRy2:S20 +y1;                         [Set town dwelling vars]
!!VRy3:S30 +y1;                         [y31-y37 will contain info about whether corresponding town dwelling is built, upgraded or not]
!!VRy4:S37 -1 +y1;
!!VRy5:S30 -1 +y1;
!!VRyy3:S-1;
!!CA-1:B3/y4;
!!VRyy3&1:S1;
!!CA-1&-1:B3/y5;
!!VRyy3&1/yy3<>1:S0;                    [0 for unupgraded, 1 for upgraded, -1 means dwelling not built]
!!VRyy2&yy3=-1:S0;                      [no dwelling - no creatures]

!!VRy4:S40 +y1;                         [prepare vars for showing monsters]
!!VRy5:S50 +y1;
!!VRyy4:S-1;
!!VRyy5:S-1;

!!VRy1:+1;
!!SN&y1<8:G[loopTownDwellings];

!!VRy1:S0;                              [loop iteration]
!!VRy6:S0;                              [number of non-zero monster]
!!CA-1:T?y7;                            [get type of current town]
[:showMonstersAmount]
!!VRy2:S21 +y1;
!!VRy3:S31 +y1;
!!VRy4:S41 +y6;                         [y41-y47 will contain amount and type of monsters to display]
!!VRy5:S51 +y6;                         [y51-y57 will contain either 21 or -1. 21 is monster picture message type for IF:N]
!!UN&yy2<>0:Ty7/y1/yy3/?y8;             [get monster type of #y1 dwelling]
!!VRyy4&yy2<>0:S65536 *yy2 +y8;
!!VRyy5&yy2<>0:S21;

!!VRy6&yy2<>0:+1;
!!VRy1:+1;
!!SN&y1<7:G[showMonstersAmount];
!!VRy1:Sy6;                             [we will save number of non-zero monster, as we need it later for nobility fail message]
!!HEx1:B0/?z-1;

!!SN&y6=0:T^AC_Misc.Nobility Town Fail^/?z2 Iz2/?z2;
!!IF&y6=0:Mz2;
!!SN&y6=0:W^H3_Nobility_Hero%X1_Active^/2;
!!FU&y6=0:E;                            [exit if no creatures to add]

!!SN&y6<>0:T^AC_Misc.Nobility Town^/?z2 Iz2/?z2;
!!IF&y6<>0:Ny51/y41/y52/y42/y53/y43/y54/y44/y55/y45/y56/y46/y57/y47;
!!IF&y6<>0:N2/z2/?y2;

!!SN&y2=0:W^H3_Nobility_Hero%X1_Active^/2;
!!FU&y2=0:E;                            [Exit if press no]

!!SN:W^H3_Nobility_Hero%X1_Active^/0;

!!VRy1:S1;
[:loopTownDwellingsAddCreatures]
!!VRy2:S20 +y1;
!!VRy3:S30 +y1;
!!VRy4:S0+y1-1;
!!CA-1&yy3=1:M1/y4/d0/dyy2;              [Upg dwelling #y1]
!!CA-1&yy3=0:M1/y4/dyy2/d0;              [Non-upg dwelling #y1]
!!VRy1:+1;
!!SN&y1<8:G[loopTownDwellingsAddCreatures];

!!SN:D;                                 [Added SN:D command. It's used to redraw hero, heroes meeting, adventure map and town screens.]

********************************************************************************

                       CLASS BONUS HANDLING

Master Warrior         : 15% max Damage
Grandmaster Warrior    : Half Damage for Retaliation, Critical Strike I

Master Mage            : 1 extra cast
Grandmaster Mage       : 1 extra cast per battle round, Transfer Spells to next combat

Master Adventurer      : Bonus movement after every fight
Grandmaster Adventurer : Gets Adv. Offense/Armorer/Archery, +3% creature growth per Week

Battlemage             : Deals Magic Damage proir to Battle, Warcry Spell, 15% max Damage, 1 extra Cast

Hunter                 : First Shot Ability, Magic Block, Bonus Movement after every fight, 10% max Damage Bonus

Druid                  : Heals two squads after combat, Flat Damage Block, 1 extra Cast, Bonus Movement after every fight

***************************Master Warrior***************************************
*Increase Damage by 15% in Combat* for Master and +20% for Grandmaster

!?BF;                                   [Combat Start]

!!BA:H0/?y1;                            [Attacker]
!!SN:W^Master_Warrior_Hero%Y1^/?y4;
!!SN:W^Grandmaster_Warrior_Hero%Y1^/?y7;
!!SN:W^Master_Mage_Hero%Y1^/?y5;        [Battlemages cannot get this bonus]
!!SN:W^Master_Adventurer_Hero%Y1^/?y6;
!!FU(Count_Set_Pieces_2):Py1/0/0/0/?y90;   [Count Warrior Set Pieces function X5]          [Count Set Pieces function]
!!VRy10:S100;                           [Normal Damage]
!!VRy10&y4=1:S115;                      [+15% damage increase for Master Warrior]
!!VRy10&y7=1:S120;                      [+20% damage increase for Grandmaster Warrior]
!!VRy10&y6=1/y4=1:S110;                 [10% damage increase for Hunter]
!!VRy10&y5=1/y4=1:S110;                 [10% damage increase for Battlemages]
!!VRy10&y90>=2:+5;                      [+5% damage increase for Warrior Set]
!!DO(AC_Function_19)/0/20/1&y10>100:Py10;

!!BA:H1/?y2;                            [Defender]
!!FU&y2<0:E;                            [Exit if no Hero]
!!SN:W^Master_Warrior_Hero%Y2^/?y4;
!!SN:W^Grandmaster_Warrior_Hero%Y2^/?y7;
!!SN:W^Master_Mage_Hero%Y2^/?y5;        [Battlemages cannot get this bonus]
!!SN:W^Master_Adventurer_Hero%Y2^/?y6;
!!FU(Count_Set_Pieces_2):Py2/0/0/0/?y90;   [Count Warrior Set Pieces function X5]          [Count Set Pieces function]
!!VRy10:S100;                           [Normal Damage]
!!VRy10&y4=1:S115;                      [+15% damage increase for Master Warrior]
!!VRy10&y7=1:S120;                      [+20% damage increase for Grandmaster Warrior]
!!VRy10&y6=1/y4=1:S110;                 [10% damage increase for Hunter]
!!VRy10&y5=1/y4=1:S110;                 [10% damage increase for Battlemages]
!!VRy10&y90>=2:+5;                      [+5% damage increase for Warrior Set]
!!DO(AC_Function_19)/21/41/1&y10>100:Py10;

!?FU(AC_Function_19);                   [increase Units Stats]

!!BMx16:U2/?y1;                         [Get Max Damage]
!!FU&y1<=0:E;                           [Exit if no Damage]
!!VRy2:Sy1*x1:100;                      [Increase Damage by 10% or at least +1]
!!VRy2&y1=y2:+1;
!!BMx16:U2/y2;                          [Set Max Damage]

************************Grandmaster Warriors************************************
*Retaliations do only 50% damage* *20% chance for more damage with Critical Strike*

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;          [Only run when melee or strikes all round]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>6:E;                           [Exit if not melee attack]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!if&y4=y1;
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^Grandmaster_Warrior_Hero%Y99^/?y2;
*!IF:M^Hero Number is %Y99 y1 is %Y1 and y4 is %Y4 and GM W is %Y2^;
!!FU&y2=0:E;

!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy6:2;                          [Only Half damage]
!!MF:Fy10;

!!BA:Q?f;
!!VRz-1&1000:S^CRUSDFND.wav^;           [find block sound]
!!SN&1000/f=0:Pz-1;                     [play block sound]

!!SN&1000:T^AC_Misc.Damage Avoid^/?z-1/^damage1^/y10;
!!BU&1000/f=0:Mz-1;
!!en;
!!en;


**************************************Critical Hit**************************************************
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=6;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!SN:W^Warrior_Crit_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Warrior_Crit_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!SN:W^Master_Warrior_Hero%Y99^/?y3;
!!SN:W^Grandmaster_Warrior_Hero%Y99^/?y2;
!!SN:W^Master_Mage_Hero%Y99^/?y41;
!!SN:W^Master_Adventurer_Hero%Y99^/?y42;

!!VRy20:S0T100;                         [Generate Random value]
!!VRy20&y3=1:+10;                       [+10% Crit chance with Master Warrior]
!!VRy20&y2=1:+10;                       [+20% Crit chance with Grandmaster Warrior]
!!VRy20&y41=1/y3=1:-10;                 [No additional crit chance for Hybrid classes]
!!VRy20&y42=1/y3=1:-10;                 [No additional crit chance for Hybrid classes]
!!FU(Count_Set_Pieces_2):Py99/0/0/0/?y90;[Count Set Pieces function X5]   [Count Set Pieces function]
!!SN&y90=3:W^Warrior_Set_Count_Hero%Y99^/?y30; [+1%  if Battle won with Set equipped and value smaller Hero Level]
!!VRy30&y90=3::3;
!!VRy20&y90=3:+y30;                     [plus value/3 to add crit chance if warrior set complete]

!!HEy99:A2/48/?y30/?y81;
!!VRy20&y81=1:+3;                       [Wenn der Ladybird of Luck getragen wird plus +3% Crit Chance]
!!HEy99:A2/46/?y30/?y81;
!!VRy20&y81=1:+3;                       [Wenn der 46 Clover of Fortune getragen wird plus +3% Crit Chance]
!!FU(Count_Set_Pieces):Py99/0/0/0/0/?y81;[Check for The Adventures Fidelity]
!!VRy20&y81>=3:+5;                      [Wenn der The Adventures Fidelity getragen wird plus +5% physical Crit Chance]

!!if&y20>100;                          [20% chance for critical hit]
!!MF:F?y6;                              [damage dealt]

!!VRy7:S120;
!!VRy7&y90=3:+y30;                      [If Set complete add +1% crit damage per 3 levels]
!!VRy10:Sy6*y7:100;                     [If crit deal Bonus Damage]
!!MF:Fy10;
!!VRy11:Sy10-y6;                        [Total Bonus Damage]

!!BA:Q?f;
!!VRz-1&1000:S^SLAYER.wav^;             [find block sound]
!!SN&1000/f=0:Pz-1;                     [play block sound]

!!SN&1000:T^AC_Misc.Critical Hit^/?z-1/^damage2^/y11;
!!BU&1000/f=0:Mz-1;
!!en;
!!en;
!!en;


***********************************
*Grandmaster Warriors Buff Commander and Henchmens by +20%

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]

!!BA:H0/?y1;
!!SN:W^Grandmaster_Warrior_Hero%Y1^/?y2;[Attacker]

!!if&y2=1;
  !!re i/0/10;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    !!if&y3>=174/y3<=182|y4=20;        [If Commander or Henchmen found for Attacker]
    !!VRy10:S120;                       [Coefficient for parameter increase  20%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!SN:W^Grandmaster_Warrior_Hero%Y1^/?y2;[Defender]

!!if&y2=1;
  !!re i/21/31;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    !!if&y3>=183/y3<=191|y4=30;        [If Commander or Henchmen found for Defender]
    !!VRy10:S120;                       [Coefficient for parameter increase 20%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


***************************Master Mage******************************************
*1 extra cast per combat*

!?BG1;                                  [1 extra cast per combat for Master Mages]

!!BG:Q?y1;                              [Fix for Double Cast]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!SN&y1=0:W^Master_Mage_Hero%Y88^/?y4;
!!SN&y1=0:W^Grandmaster_Mage_Hero%Y88^/?y5;

!!SN&y1=1:W^Master_Mage_Hero%Y89^/?y4;
!!SN&y1=1:W^Grandmaster_Mage_Hero%Y89^/?y5;


!!if&y4=1/y5=0;                        [Only Runs when Master Mage and not Grandmaster]
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y2;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!BA:Q?f;
!!VRz-1&1000:S^FORTUNE^;
!!SN&1000/f=0:Pz-1;
!!SN&1000:T^AC_Misc.Master Mage Extra Cast^/?z-1;
!!BU&1000/f=0:Mz-1;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/0;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/0;
!!en;


************************Grandmaster Mages***************************************
*1 extra cast per battle round*

!?BR;

!!BA:H0/?y20;                           [check attacker]
!!if&y20>=0;
!!SN:W^Grandmaster_Mage_Hero%Y20^/?y10;
!!SN&y10=1:W^Double_Cast_Attacker^/1;
!!en;

!!BA:H1/?y21;                           [check defender]
!!if&y21>=0;
!!SN:W^Grandmaster_Mage_Hero%Y21^/?y11;
!!SN&y11=1:W^Double_Cast_Defender^/1;
!!en;


!?BG1;                                  [1 extra cast per battle round]

!!BG:S?y11;                             [y11 now contains spell number]
!!FU|y11<10/y11>69:E;

!!BG:Q?y1;                              [Current attacking side]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!SN&y88>=0/y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y89>=0/y1=1:W^Double_Cast_Defender^/?y4;
!!FU&y4=0:E;

!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;                              [Renable Spellbook]

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!SN&1000:T^AC_Misc.Grandmaster Mage Extra Cast^/?z-1;
!!BA:Q?f;
!!BU&1000/f=0:Mz-1;
!!VRz1&f=0/1000:S^FORTUNE^;
!!SN&f=0/1000:Pz1;
!!SN&y88>=0/y1=0:W^Double_Cast_Attacker^/0;
!!SN&y89>=0/y1=1:W^Double_Cast_Defender^/0;


!?FU(OnAfterBattleUniversal);           [Reset after Combat]
!!SN:W^Double_Cast_Attacker^/0;
!!SN:W^Double_Cast_Defender^/0;
!!SN:W^Master_Mage_Extra_Cast_att^/0;
!!SN:W^Master_Mage_Extra_Cast_def^/0;




********************************************************************************
** start of battle-start trigger
!?FU(OnBeforeBattleUniversal)&1000;     [Continue trigger if Mysticism is enabled]

!!BA:H0/?y1;                            [get attacking hero #]
!!SN:W^Grandmaster_Mage_Hero%Y1^/?y11;
!!FU(Mage_Skill_Fkt_1)&y11=1:Py1/1;     [wenn mysticism beim angreifer vorhanden dann reiche x1=10 an function (Mystik_Skill_Fkt_0) weiter]

!!BA:H1/?y2;                            [get defending hero #]
!!FU&y2=-2:E;                           [Exit if no defending Hero]
!!SN:W^Grandmaster_Mage_Hero%Y2^/?y11;
!!FU(Mage_Skill_Fkt_1)&y11=1:Py2/2;     [wenn mysticism beim angreifer vorhanden dann reiche x1=10 an function (Mystik_Skill_Fkt_0) weiter]

!?FU(Mage_Skill_Fkt_1);
!!HEx1:A2/73/?y2/?y3 A2/74/?y4/?y5 A2/75/?y6/?y7 S8/?y8 A2/138/?y30/?y31; [check for Charm of Mana, Talisman of Mana, Mystic Orb of Mana, Mysticism skill level, Wizards Well]
!!VRy8:S3;                              [40%  50%  60%  chance je nach Mysticism skill level]   Changes always set to 3]
!!VRy8&y3=1:+1;                         [Charm of Mana Bonus  10% Bonus]
!!VRy8&y5=1:+2;                         [Talisman of Mana Bonus  20% Bonus]
!!VRy8&y31=1:+3;                        [Wizards Well Bonus  +30% Chance]

!!VRy10:S0T10;                          [do coin flip for stronger spell in combat]

!!FU&y10>y8:E;                          [exit the function  if random value is bigger than 3]

!!HEx1:B0/?z1;                          [get hero's name]
!!VRy20:S15 R8;                         [choose Spell which will deal more dmg]

!!SN&1000:T^AC_Misc.Arkane Prophet^/?z2 Iz2/?z2;
!!IF&1000:Q2/9/y20/1/z2;
!!SN&x2=1:W^Mage_Spell_Enhancement_0^/y20; [Save for Attacker]
!!SN&x2=2:W^Mage_Spell_Enhancement_1^/y20; [Save for Defender]

********************************************************************************
!?MR1&1000;                             [Arkane_Prophet]

!!BG:Q?y1;                              [Get acting side]
!!SN&y1=0:W^Mage_Spell_Enhancement_0^/?y20; [Save for Attacker]
!!SN&y1=1:W^Mage_Spell_Enhancement_1^/?y20; [Save for Defender]
!!FU&y20=0:E;

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;                           [Exit if no Hero cast]
!!MR:F?y14;                             [Speichere DMG in y3]
!!BG:H?y4;                              [Number of a hero owner (-1=no hero)   in y4]
!!FU&y4=-1:E;
!!BG:S?y11;                             [Falls Aktion ein Cast ist dann Speichere Spellnummer in y2]
!!FU&y11<>y20:E;                        [Exit if not choosen spell]
!!HEy4:A2/75/?y6/?y7 A2/138/?y30/?y31;  [check for  Mystic Orb of Mana and Wizards Well]

!!VRy15:S110 R90;                       [Roll for 10 til 100% damage increase]
!!VRy15&y7=1:+40;                       [check for  Mystic Orb of Mana  if yes increase damage +40%]
!!VRy15&y31=1:+40;                      [check for  Wizards Well  if yes increase damage +40%]
!!VRy14:*y15:100;                       [spell dmg + 1 bis 130% wenn v1159 gleich dem gecasteten spell ist]
!!MR:Fy14;                              [neuen  spell dmg setzen mit y14]


!?FU(OnAfterBattleUniversal);
!!SN:W^Mage_Spell_Enhancement_0^/0;     [Reset for Attacker]
!!SN:W^Mage_Spell_Enhancement_1^/0;     [Reset for Defender]


*************************Elemental Resistance*******************************************************
*Mages get a Natural_Resistance against elemental spells -20% damage from spells
!?MR1;                                  [*Magical Combat Improvements*]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;
!!FU&y2<=9|y2>69:E;
!!BG:Q?y1;
!!VRy1:-1 *-1;
!!BA:Hy1/?y99;
!!FU&y99<0:E;
!!SN:W^Master_Mage_Hero%Y99^/?y11;
!!SN:W^Master_Adventurer_Hero%Y99^/?y12;
!!SN:W^Master_Warrior_Hero%Y99^/?y13;

!!MR:F?y6;
!!if&y6>0/y11=1/y12=0/y13=0;           [Resistance bonus handling, run only for Mages and not for Battlemages or Druids]
  !!VRy6:*80:100;
  !!MR&y6>0:Fy6;                        [Apply Reduced damage]
!!en;


*************************Pierce Resistance*******************************************************
*Mages pierce 15% of Dwarv type resistance GM pierce 25%
That breakes immunities and allows to apply spells to creatures that are usually immune.

!?MR2&1000;                             [Magic Resistance Trigger]

!!MR:N?y1;                              [Get Creature Number]
!!BMy1:I?y2;                            [Get Creature Side]
!!VRy2:-1*-1;                           [Invert Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y4;                           [Get Hero Number of creature side]
!!FU&y4<0:E;
!!SN:W^Master_Mage_Hero%Y4^/?y11;
!!SN:W^Grandmaster_Mage_Hero%Y4^/?y12;
!!FU|y50<>y4/y11=0:E;                   [Exit for beneficial spells, meaning same hero]
!!MR:F?y5;                              [Get temporarily MR of Creature]
!!VRy5&y11=1/y12=0:-15; !!VRy5&y11=1/y12=1:-25;!!VRy5&y5<0:S0; [Reduce by Master 15% and 25% for GM]
!!MR:Fy5;                               [Apply decreased resistance chance to that stack temporarily]


************************Master Adventurer***************************************
**Plunder Ability No movement cost for picking fights resources and other stuff
**Druids no longer get the ability

!?HM-1;                                 [Hero Movement]
!!HE-1:N?y1; !!FU&y1<0:E;
!!SN:W^Master_Adventurer_Hero%Y1^/?y2;
!!SN:W^Master_Mage_Hero%Y1^/?y3;
!!if&y2=1/y3=0;
!!HEy1:W?y4/1;
!!SN:W^Hero%Y1_Movement^/y4;
!!en;

!?CM5;                                  [When Map Clicked for fix with pickung up Resources]
!!CM:S?v3; !!FU&v3<>12:E;

!!OW:C?y1;                              [Get current player]
!!OW:Ay1/?y1;                           [Get active Hero]
!!FU&y1=-1:E;                           [Exit if none]

!!FU&y1<0/y1>=155:E;
!!SN:W^Master_Adventurer_Hero%Y1^/?y2;
!!SN:W^Master_Mage_Hero%Y1^/?y3;
!!if&y2=1/y3=0;
!!HEy1:W?y4/1;
!!SN:W^Hero%Y1_Movement^/y4;
!!en;

!?OB5;                                  [5 Artifact]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB12;                                 [12 Campfire]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB53;                                 [53 Mine]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB54;                                 [54 Monster]
!!HE-1:N?y1;
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y2; [Only works for Grandmaster]
!!FU(Plunder_Ability)&y1>=0/y1<=155/y2=1:Py1;

!?OB79;                                 [79 Resource]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB101;                                [101 Treasure Chest]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?OB16;                                 [16 Creature Bank]
!!HE-1:N?y1;
!!FU(Plunder_Ability)&y1>=0/y1<=155:Py1;

!?FU(Plunder_Ability);
!!SN:W^Master_Adventurer_Hero%X1^/?y2;
!!SN:W^Master_Mage_Hero%X1^/?y3;

*!VRy1:S0T99; *!FU&y1>50:E;             [Works only in 50% of all cases. Yes big nerf lol.]

!!if&y2=1/y3=0;
  !!HEx1:W?y5/1;                        [Check current movement]
  !!SN:W^Hero%X1_Movement^/?y4;         [Check saved movement from last move]
  !!VRy6:Sy4-y5;
  !!HEx1&y4>y5/y6<150:Wy4/1;            [Restore movement from last move only if it is bigger than current]
  !!if&y6>=150;
    !!VRy6::2; !!VRy4:-y6;
    !!HEx1&y4>y5:Wy4/1;                 [Restore movement from last move only if it is bigger than current]
  !!en;
!!en;


!?FU(OnAfterBattleUniversal)&1000;      [At Battle End]

!!FU:E;                                 [Disabled for now]
!!HE-1:N?y1;                            [Hero Number]
!!FU&y1<0:E;                            [exit if no active hero]

!!HEy1:O?y9;                            [get owner of this hero]
!!FU&y9=-1:E;                           [Exit if no Owner]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!SN:W^Master_Adventurer_Hero%Y1^/?y2;

!!if&y2=1/y5=y9;
!!VRy3:S200;
!!HEy1:Wdy3/1;                          [give calculated free Movement Points]
!!IF&1000:M^{~Green}Master Adventurer Bonus{~}

You find a shortcut out of the battlefield (+%Y3 movement points)^;
!!en;

*******************Master and Grandmaster Adventurer****************************
*Taking Cities gives Gold at Master level
*Taking Cities at Grandmaster Level immiditaly increases the number of creatures to hire in that city

!?OB98&1000;

!!CA998:O?y1;
!!if&y1<0;                             [If Neutral Town]
!!HE-1:N?y1;
!!HEy1:O?y2;
!!SN:W^Master_Adventurer_Hero%Y1^/?y20;
!!SN:W^Master_Warrior_Hero%Y1^/?y21;
!!SN:W^Master_Mage_Hero%Y1^/?y22;
!!if&y20=1/y21=0/y22=0;                [If Master Adventurer and not Hybrid Class]
!!CA998:H0/?y3 H1/?y4 M2/0/?y5/d M2/1/?y6/d M2/2/?y7/d M2/3/?y8/d M2/4/?y9/d M2/5/?y10/d M2/6/?y11/d;
!!FU(Town_Plunder)&y3=-1/y4=-1/y5=-1/y6=-1/y7=-1/y8=-1/y9=-1/y10=-1/y11=-1:Py1/y2/v998/v999/v1000;
!!en;
!!en;

!!CA998:O?y1;
!!FU&y1<0:E;                            [If Town under controll]
!!HE-1:O?y2;
!!OW:Ty1/?y3 Ty2/?y4;
!!FU&y3=y4:E;
!!HE-1:N?y1;
!!SN:W^Master_Adventurer_Hero%Y1^/?y20;
!!SN:W^Master_Warrior_Hero%Y1^/?y21;
!!SN:W^Master_Mage_Hero%Y1^/?y22;
!!if&y20=1/y21=0/y22=0;                [If Master Adventurer and not Hybrid Class]
!!CA998:H0/?y3 H1/?y4 M2/0/?y5/d M2/1/?y6/d M2/2/?y7/d M2/3/?y8/d M2/4/?y9/d M2/5/?y10/d M2/6/?y11/d;
!!FU(Town_Plunder)&y3=-1/y4=-1/y5=-1/y6=-1/y7=-1/y8=-1/y9=-1/y10=-1/y11=-1:Py1/y2/v998/v999/v1000;
!!en;


!?FU(OnAfterBattleUniversal)&1000;

!!BA:H0/?y1;
!!SN:W^Master_Adventurer_Hero%Y1^/?y20;
!!SN:W^Master_Warrior_Hero%Y1^/?y21;
!!SN:W^Master_Mage_Hero%Y1^/?y22;
!!if&y20=1/y21=0/y22=0;                [If Master Adventurer and not Hybrid Class]
!!BA:S?y80;
!!FU&y80=0:E;                           [Exit if no Siege]
!!HEy1:O?y2;
!!BA:P?y11/?y12/?y13;
!!TRy11/y12/y13:E?y4;
!!FU&y4=1:E;
!!OBy11/y12/y13:T?y3;
!!FU&y3<>98:E;
!!FU(Town_Plunder)&y2>=0/y1>=0:Py1/y2/y11/y12/y13; [if the attacking hero is alive, the city was not neutral and fell, we transfer resources]
!!en;

!?FU(Town_Plunder);
x1=Hero Number
x2=Hero Owner
x3-x5=Town Coordinates
!!SN:W^Grandmaster_Adventurer_Hero%X1^/?y20;
!!VRy15:S8000;                          [Set Golf Bonus for Master Adventurer]
!!VRy15&y20=1:S15000;                   [Set Golf Bonus for Grandmaster Adventurer]
!!SN:T^AC_Misc.Town_Plunder^/?z1/^gold^/y15;
!!IF:M1/z1;
!!OW:Rx2/6/dy15;

*Level 1*                      *Level 2*                      *Level 3*                      *Level 4*                     *Level 5*                     *Level 6*                     *Level 7*
!!VRy21:S40; !!VRy22:S30; !!VRy23:S25; !!VRy24:S20; !!VRy25:S15; !!VRy26:S10; !!VRy27:S2; [Master]

!!if&y20=1;                            [if Grandmaster]
!!VRy21:S80; !!VRy22:S40; !!VRy23:S35; !!VRy24:S30; !!VRy25:S25; !!VRy26:S15; !!VRy27:S4; [Grandmaster]
!!en;
**Y21 bis Y27  is level 1 til 7

!!CAx3/x4/x5:B3/37;                     [Upg dwelling 1]
!!CAx3/x4/x5&1:M1/0/d0/dy21;
!!CAx3/x4/x5&-1:B3/30;                  [dwelling 1]
!!CAx3/x4/x5&1:M1/0/dy21/d0;

!!CAx3/x4/x5:B3/38;                     [Upg dwelling 2]
!!CAx3/x4/x5&1:M1/1/d0/dy22;
!!CAx3/x4/x5&-1:B3/31;                  [dwelling 2]
!!CAx3/x4/x5&1:M1/1/dy22/d0;

!!CAx3/x4/x5:B3/39;                     [Upg dwelling 3]
!!CAx3/x4/x5&1:M1/2/d0/dy23;
!!CAx3/x4/x5&-1:B3/32;                  [dwelling 3]
!!CAx3/x4/x5&1:M1/2/dy23/d0;

!!CAx3/x4/x5:B3/40;                     [Upg dwelling 4]
!!CAx3/x4/x5&1:M1/3/d0/dy24;
!!CAx3/x4/x5&-1:B3/33;                  [dwelling 4]
!!CAx3/x4/x5&1:M1/3/dy24/d0;

!!CAx3/x4/x5:B3/41;                     [Upg dwelling 5]
!!CAx3/x4/x5&1:M1/4/d0/dy25;
!!CAx3/x4/x5&-1:B3/34;                  [dwelling 5]
!!CAx3/x4/x5&1:M1/4/dy25/d0;

!!CAx3/x4/x5:B3/42;                     [Upg dwelling 6]
!!CAx3/x4/x5&1:M1/5/d0/dy26;
!!CAx3/x4/x5&-1:B3/35;                  [dwelling 6]
!!CAx3/x4/x5&1:M1/5/dy26/d0;

!!CAx3/x4/x5:B3/43;                     [Upg  dwelling 7]
!!CAx3/x4/x5&1:M1/6/d0/dy27;
!!CAx3/x4/x5&-1:B3/36;                  [dwelling 7]
!!CAx3/x4/x5&1:M1/6/dy27/d0;

!!SN:D;                                 [Added SN:D command. It's used to redraw hero, heroes meeting, adventure map and town screens.]


************************Grandmaster Adventurer**********************************
*+3% Creature Growth per Week*

!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0;
!!OW:C?y1;
!!DO(AC_Function_20)/0/155/1:Py1;


!?FU(AC_Function_20);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!SN:W^Master_Adventurer_Hero%X16^/?y10;
!!SN:W^Grandmaster_Adventurer_Hero%X16^/?y11;
!!DO(AC_Function_21)/0/6/1&y10=1/y11=1:Px16/3; [Pass Hero and Skilllevel]

!?FU(AC_Function_21);
!!HEx1:C0/x16/?y1/?y2;
!!FU|y2<1/y1<0:E;                       [Exit if no creature in slot]
!!FU(Count_Set_Pieces_2):Px1/0/0/0/0/?y92; [Check for  Sets]
!!SN&y92=3:W^Adventurer_Set_Count_Hero%X1^/?y10;
!!MA:Ly1/?y20;                          [get monster level]
!!VRy10&y92=3::20;                      [+1% per 20 hero Levels]
!!VRy11:S103;                           [3%Growth  at Grandmaster]
!!VRy11&y92=3:+y10;                     [+ Set Bonus if equipped]
!!VRy3:Sy2 *y11 :100 -y2;

*set max cap to limit growth*
!!VRy21:S25; !!VRy22:S15; !!VRy23:S10; !!VRy24:S8; !!VRy25:S6; !!VRy26:S4; !!VRy27:S1;

!!if&y10=1;                            [With 1% set bonus]
!!VRy21:S30; !!VRy22:S20; !!VRy23:S14; !!VRy24:S11; !!VRy25:S8; !!VRy26:S6; !!VRy27:S1;
!!en;

!!if&y10=2;                            [With 2% set bonus]
!!VRy21:S40; !!VRy22:S25; !!VRy23:S18; !!VRy24:S14; !!VRy25:S10; !!VRy26:S8; !!VRy27:S2;
!!en;

!!if&y10=3;                            [With 3% set bonus]
!!VRy21:S50; !!VRy22:S30; !!VRy23:S21; !!VRy24:S17; !!VRy25:S12; !!VRy26:S10; !!VRy27:S2;
!!en;

!!if&y10=4;                            [With 4% set bonus]
!!VRy21:S60; !!VRy22:S35; !!VRy23:S25; !!VRy24:S20; !!VRy25:S15; !!VRy26:S12; !!VRy27:S3;
!!en;

!!if&y10=5;                            [With 5% set bonus]
!!VRy21:S70; !!VRy22:S40; !!VRy23:S30; !!VRy24:S25; !!VRy25:S20; !!VRy26:S15; !!VRy27:S4;
!!en;

!!VRy3&y20=0/y3>y21:Sy21;               [For level 1]
!!VRy3&y20=1/y3>y22:Sy22;               [For level 2]
!!VRy3&y20=2/y3>y23:Sy23;               [For level 3]
!!VRy3&y20=3/y3>y24:Sy24;               [For level 4]
!!VRy3&y20=4/y3>y25:Sy25;               [For level 5]
!!VRy3&y20=5/y3>y26:Sy26;               [For level 6]
!!VRy3&y20=6/y3>y27:Sy27;               [For level 7]
!!HEx1:C0/x16/d/dy3/0/0;                [Add Monsters to army]


!?BF&1000;                              [Combat Start]

!!FU:E;
!!BA:H0/?y1;                            [Attacker]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y12 S22/?y13 S23/?y14;
!!SN&y12<=2:W^Att_Grandmaster_Adventurer_Archery^/y12; !!HEy1&y12<=2:S1/2;
!!SN&y13<=2:W^Att_Grandmaster_Adventurer_Offense^/y13; !!HEy1&y13<=2:S22/2;
!!SN&y14<=2:W^Att_Grandmaster_Adventurer_Armorer^/y14; !!HEy1&y14<=2:S23/2;
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;                            [Exit if no Hero]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y12 S22/?y13 S23/?y14;
!!SN&y12<=2:W^Def_Grandmaster_Adventurer_Archery^/y12; !!HEy1&y12<=2:S1/2;
!!SN&y13<=2:W^Def_Grandmaster_Adventurer_Offense^/y13; !!HEy1&y13<=2:S22/2;
!!SN&y14<=2:W^Def_Grandmaster_Adventurer_Armorer^/y14; !!HEy1&y14<=2:S23/2;
!!en;


!?BG1&1000;                             [After Combat Restore orignal Skills]

!!FU:E;
!!BU:C?y1;                              [Check if combat has ended this round]
!!FU&y1=0:E;

!!BA:H0/?y1;                            [Attacker]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y22 S22/?y33 S23/?y44;
!!SN:W^Att_Grandmaster_Adventurer_Archery^/?y12; !!HEy1&y22<=2:S1/y12;
!!SN:W^Att_Grandmaster_Adventurer_Offense^/?y13; !!HEy1&y33<=2:S22/y13;
!!SN:W^Att_Grandmaster_Adventurer_Armorer^/?y14; !!HEy1&y44<=2:S23/y14;
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;                            [Exit if no Hero]
!!SN:W^Grandmaster_Adventurer_Hero%Y1^/?y11;
!!if&y11=1;
!!HEy1:S1/?y12 S22/?y13 S23/?y14;
!!SN&y12<=2:W^Def_Grandmaster_Adventurer_Archery^/y12; !!HEy1&y12<=2:S1/2;
!!SN&y13<=2:W^Def_Grandmaster_Adventurer_Offense^/y13; !!HEy1&y13<=2:S22/2;
!!SN&y14<=2:W^Def_Grandmaster_Adventurer_Armorer^/y14; !!HEy1&y14<=2:S23/2;
!!en;

**********************************************
*Coordinated Attacks provide +1 true damage for each unit in the stack only melee attacks*

!?MF1;                                  [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Coordinated_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Coordinated_Attacking_Stack^/y4;

!!BMy1:I?y98;

!!BA:Hy98/?y99;
!!FU&y99<0:E;
!!SN:W^Grandmaster_Adventurer_Hero%Y99^/?y12;
!!FU&y12=0:E;

!!BMy1:N?y6;                            [how many monsters in attacking stack?]
!!FU&y6=1:E;                            [With only 1 stack there is no coordination]
!!MF:F?y4;
!!VRy5:Sy4+y6;
!!MF:Fy5;                               [deal new updated damage]

!!BA:Q?f;
!!SN:T^AC_Misc.Coordinated_Damage^/?z-1/^damage^/y6;
!!BU&f=0:Mz-1;
!!en;



*********************************Battlemage*************************************
**Precast ability* Cast a random damage spell from your book at the enemy at combat start
**Warcry at the beginning of battle reduces enemy HP by some %

!?FU(OnBattleRegeneratePhase);

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!SN&y2=0:W^Battlemage_Precast_0^/?y6;
!!SN&y2=1:W^Battlemage_Precast_1^/?y6;
!!FU&y6=1:E;
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!SN:W^Master_Warrior_Hero%Y4^/?y9;
!!SN:W^Master_Mage_Hero%Y4^/?y10;
!!FU|y9=0/y10=0:E;                      [Exit if no Battlemage]
!!HEy4:A2/0/?y15/?y14;
!!FU&y14=0:E;                           [Exit if no Spellbook]
!!HEy4:I?y30/1;                         [Get Spell Points]
!!BA:Q?f;                               [Check for Quick Battle]

!!VRy99:S50;
[:find_spell]
!!VRy11:S15R8;
!!VRy11&y11=26:S17;                     [If Armageddon Set Lightning Strike]
!!VRy11&y11=19:S21;                     [If Chain Lightning Set Fireball]
!!VRy11&y11=20:S16;                     [If Frost Ring Set Ice Bolt]
!!HEy4:My11/?y12;
!!VRy99:-1;
!!SN&y12=0/y99>0:G[find_spell];         [Loop until a spell found]
!!FU&y99=0:E;                           [Exit if the Hero knows no Spell]

!!VRy50:S0;
[:find_target]
!!VRy50:+1;
!!VRy10:S21R6;
!!BMy10:P?y5;
!!BMy10:N?y6;
!!BMy10:T?y7;
!!FU&y50=100:E;                         [Exit if no valid Target can be found]
!!SN|y6=0/y7=145/y7=146/y7=147/y7=148/y7=149:G[find_target]; [Loop]
*!SN&1000/f=0:T^AC_Misc.Precast ability^/?z2;
*!IF&1000/f=0:L^%Z2^;
!!BHy2:Cy11/y5/3/1;                     [Cast Spell at Target]
!!BHy2:M0;                              [Reenable Spell Book after cast]

!!SN&y2=0:W^Battlemage_Precast_0^/1;
!!SN&y2=1:W^Battlemage_Precast_1^/1;
!!HEy4:Iy30/1;                          [Reset Spell Points]


!?FU(OnAfterBattleUniversal);
!!SN:W^Battlemage_Precast_0^/0;
!!SN:W^Battlemage_Precast_1^/0;

!?MR1;
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]
!!BG:Q?y2;                              [Event parameter]
!!SN&y2=0:W^Battlemage_Precast_0^/?y6;
!!SN&y2=1:W^Battlemage_Precast_1^/?y6;
!!FU&y6=1:E;
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!SN:W^Master_Warrior_Hero%Y4^/?y9;
!!SN:W^Master_Mage_Hero%Y4^/?y10;
!!FU|y9=0/y10=0:E;                      [Exit if no Battlemage]
!!MR:F?y10;
!!VRy10:*3;                             [Tripple Damage from Precast]
!!MR:Fy10;


!?BF;                                   [Warcry]
!!BA:H0/?y4;                            [Attacker]
!!SN:W^Master_Warrior_Hero%Y4^/?y9;
!!SN:W^Master_Mage_Hero%Y4^/?y10;
*!VRy11:S90R5;                          [Reduce HP by -5-10%]
*!VRy12:S100-90;

!!BA:Q?f;
!!DO(AC_Function_38)/21/41/1&y9=1/y10=1:P90; [Run if Battlemage]
!!HEy4&y9=1/y10=1:B0/?z-10;             [get hero name]
!!SN&y9=1/y10=1/1000/f=0:T^AC_Misc.Warcry ability^/?z2 Iz2/?z2;
*!IF&y9=1/y10=1/1000/f=0:L^%Z2^;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!SN:W^Master_Warrior_Hero%Y4^/?y9;
!!SN:W^Master_Mage_Hero%Y4^/?y10;
*!VRy11:S90R5;                          [Reduce HP by -5-10%]
*!VRy12:S100-90;                        [Reduce HP by 10%]

!!DO(AC_Function_38)/0/20/1&y9=1/y10=1:P90; [Run if Battlemage]
!!HEy4&y9=1/y10=1:B0/?z-10;             [get hero name]
!!SN&y9=1/y10=1/1000/f=0:T^AC_Misc.Warcry ability^/?z2 Iz2/?z2;
*!IF&y9=1/y10=1/1000/f=0:L^%Z2^;

!?FU(AC_Function_38);                   [decrease Units Stats]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
!!BMx16:N?y20;                          [Creature Number y20]
!!FU&y20=0:E;                           [Exit if zero]
!!BMx16:H?y2;                           [Get HP]
!!VRy2:*x1:100;                         [Reduce HP]
!!BMx16&y2>0:Hy2;                       [Set new HP]


*********************************Hunter*****************************************
**First Shoot   and 100% MR,c in the First Round**

*?FU(OnCombatRound)&v997=0;
!?BF;

!!SN:W^Hunter_Speed_Bonus1^/?y1;
!!FU&y1=1:E;
!!SN:W^Hunter_Speed_Bonus1^/1;          [To run only once]

!!BA:Q?f;
!!BH0:N?y1;                             [Attacker]
!!BH1:N?y2;                             [Defender]
!!VRy11:S0;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!VRy11&y9=1/y10=1:S1;
!!HEy1&y9=1/y10=1:B0/?z-10;             [get hero name]
!!SN&y11=1/1000:T^AC_Misc.First Shot^/?z-1;
*!IF&y11=1/1000/f=0:Lz-1;
!!DO(AC_Function_22)/0/20/1&y11=1:P1;
*!BH1&y11=1/y2>=0:M1;                   [Disable Cast in First Battle Round for Defender]
*!BU&y11=1:R; Redraw Battlefield Grid

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!VRy11:S0;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!VRy11&y9=1/y10=1:S1;
!!HEy1&y9=1/y10=1:B0/?z-10;             [get hero name]
!!SN&y11=1/1000:T^AC_Misc.First Shot^/?z-1;
*!IF&y11=1/1000/f=0:Lz-1;
!!DO(AC_Function_22)/21/41/1&y11=1:P1;
*!BH0&y11=1:M1;                         [Disable Cast in First Battle Round for Attacker]
*!BU&y11=1:R; Redraw Battlefield Grid

!?FU(OnCombatRound)&v997=1;

!!SN:W^Hunter_Speed_Bonus2^/?y1;
!!FU&y1=1:E;
!!SN:W^Hunter_Speed_Bonus2^/1;          [To run only once]

!!BH0:N?y1;                             [Attacker]
!!VRy11:S0;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!VRy11&y9=1/y10=1:S1;
!!DO(AC_Function_22)/0/20/1&y11=1:P2;

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!VRy11:S0;
!!SN:W^Master_Warrior_Hero%Y1^/?y9;
!!SN:W^Master_Adventurer_Hero%Y1^/?y10;
!!VRy11&y9=1/y10=1:S1;
!!DO(AC_Function_22)/21/41/1&y11=1:P2;

!?FU(OnBeforeBattleUniversal);          [At Battle End]
!!SN:W^Hunter_Speed_Bonus1^/0;          [Reset]
!!SN:W^Hunter_Speed_Bonus2^/0;          [Reset]

!?FU(AC_Function_22);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E;
!!BMx16:F?i;                            [Give Pepp to Shooters]
!!VRi:&4;                               [Check for Shooter]
!!BMx16&x1=1/i>0:Sd50;
!!BMx16&x1=2/i>0:Sd-50;

Hunter gets 100% MR in first Battle Round
!?MR2&1000/y1<>y1;                      [DISABLEDagic Resistance Trigger]

!!if&v997=0;                           [Only in First Battleround]
  !!MR:N?y1;                            [Get Creature Number]
  !!BMy1:I?y2;                          [Get Creature Side]
  !!BG:H?y50;                           [Get Casting Hero]
  !!BA:Hy2/?y4;                         [Get Hero Number of creature side]
  !!FU&y4<0:E;
  !!SN:W^Master_Warrior_Hero%Y4^/?y11;
  !!SN:W^Master_Adventurer_Hero%Y4^/?y12;
  !!FU|y50=y4/y11=0/y12=0:E;            [Exit for beneficial spells, meaning same hero or no Hunter]
  !!MR:F100;                            [Make temporarily immune]
!!en;

*********************************Druid*****************************************
**Flat Damage Block 4*Hero Level, Heal Squad look in First Aid Section

!?MF1;                                  [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;                        [Attack or Shoot]

!!MF:N?y4;                              [damage receiving stack]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]
!!SN:W^Master_Mage_Hero%Y99^/?y9;
!!SN:W^Master_Adventurer_Hero%Y99^/?y10;
!!FU|y9=0/y10=0:E;                      [Exit if not Expert Druid]
!!HEy99:E?y20/?y21/1;

!!MF:F?y6;                              [Damage Dealt]
!!VRy8:Sy21*4;                          [Shield Strength 4*Hero Level]

!!BA:Q?f;
!!if&y8>=y6;
!!VRz-1&1000:S^CRUSDFND.wav^;           [find block sound]
!!SN&1000/f=0:Pz-1;                     [play block sound]
!!MF:E0;
!!MF:F0;
!!en;

!!if&y6>y8;                            [do if damage is bigger than shield]
!!VRy7:Sy6-y8;
*!VRz-1&1000:S^CRUSDFND.wav^;           [find block sound]
*!SN&1000/f=0:Pz-1;                     [play block sound]
!!MF:Fy7;
!!en;

!!en;
!!en;

*********************************Druid*****************************************
Druid can transfer spells (buffs) on his troops to the next combat

!?PI;
!!DO(Remember_Spells_Fkt_0)/0/155/1:P;  [Set all Hero Vars to -1 at game start]


!?FU(OnAfterBattleUniversal)&1000;

!!BH0:N?y10;                            [Save Attacking Hero]
*!HEy10&y10>=0:S18/?y15;                                                        [Check for Scholar]
!!SN:W^Master_Mage_Hero%Y10^/?y40;
!!SN:W^Master_Adventurer_Hero%Y10^/?y41;
!!VRy15&y40=1/y41=1:S1;
!!HEy10:O?y30;                          [Check Side]
!!SN:W^RememberSpells_Attacker_Owner_Start^/?y31;
!!if&y30=y31/y15>0;
!!DO(Remember_Spells_Fkt_1)/0/8/1:Py10/1;[Save for Attacker Side]
!!SN:W^Hero%Y10_Number_Saved_Side0^/y10;[Activator/Save Hero Numer]
!!en;


!!BH1:N?y11;                            [Save Defending Hero]
!!FU&y11<0:E;                           [Exit if none]
*!HEy11&y11>=0:S18/?y16;                                                        [Check for Scholar]
!!SN:W^Master_Mage_Hero%Y11^/?y40;
!!SN:W^Master_Adventurer_Hero%Y11^/?y41;
!!VRy16&y40=1/y41=1:S1;
!!HEy11:O?y34;
!!SN:W^RememberSpells_Defender_Owner_Start^/?y32;
!!if&y34=y32/y16>0;
!!DO(Remember_Spells_Fkt_1)/21/29/1:Py11/2; [Save for Defender Side]
!!SN:W^Hero%Y11_Number_Saved_Side1^/y11;[Activator/Save Hero Numer]
!!en;

********************************************************************************
!?FU(Remember_Spells_Fkt_1);

!!VRx16&x2=1:S0T7;                      [Chose Random Stack Attacker]
!!VRx16&x2=2:S21R7;                     [Chose Random Stack Defender]
!!SN:W^Creature_Numerator1^/?y20;
!!VRx16&x2=1/y20=x16:S0T7;              [Reroll if same number Attacker]
!!VRx16&x2=2/y20=x16:S21R7;             [Reroll if same number Defender]
!!SN:W^Creature_Numerator1^/x16;
!!SN:W^Remember_Spells_Counter0^/?y5;
!!VRy5:+1;
!!SN&y5=1:W^Creature_Stack_Choice1^/x16;
!!SN&y5=2:W^Creature_Stack_Choice2^/x16;
!!SN&y5=3:W^Creature_Stack_Choice3^/x16;[Stop if three Stacks were choosen]
*!IF:M^x16 is %X16 and y5 is %Y5^;
!!VRx16&y5=3/x2=1:S8;
!!VRx16&y5=3/x2=2:S29;
!!DO(Remember_Spells_Fkt_2)/27/58/1:Px1;[Run Loop throug all Spells with heronumber]
!!SN:W^Remember_Spells_Counter0^/y5;

********************************************************************************
!?FU(Remember_Spells_Fkt_2);

!!SN:W^Creature_Numerator1^/?y3;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54; [Skip beneficial spells]
!!if&y3>=0/y3<=41;
!!BMy3:Gx16/?y1/?y2;                    [check for active spells Duration Y1 and Power Y2 and Type Y3]
!!BMy3:T?y4;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/y1; [Save in Var]
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/y2; [Save in Var]
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/y4; [Save in Var]
!!en;
!!en;

********************************************************************************
**Battle Start Handling**
!?BF&1000;

!!BU:T?y99;                             [Check battle has tactics phase]
!!VRy99&y99=1:S2;
!!VRy99&y99=0:S1;

!!SN:W^Remember_Spells_Counter0^/0;     [Set Counter to zero]

!!BH0:N?y10;
!!HEy10:O?y30;
!!SN:W^RememberSpells_Attacker_Owner_Start^/y30;
!!BH1:N?y11;
!!HEy11&y11>=0:O?y31;
!!SN&y11>=0:W^RememberSpells_Defender_Owner_Start^/y31;

!!SN:W^Hero%Y10_Number_Saved_Side0^/?y1;
!!if&y1>=0;
*!HEy10&y10>=0:S18/?y12;
!!SN:W^Master_Mage_Hero%Y10^/?y40;
!!SN:W^Master_Adventurer_Hero%Y10^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/0/8/1&y1=y10:Py1/1/y12/y99; [Buff Attacker]
*!IF:M^Davor Links Applied Attacker hopefully Hero Number %Y1^;
!!SN:W^Hero%Y10_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y10_Number_Saved_Side1^/-1;
!!en;

!!SN:W^Hero%Y10_Number_Saved_Side1^/?y1;
!!if&y1>=0;
*!HEy10&y10>=0:S18/?y12;
!!SN:W^Master_Mage_Hero%Y10^/?y40;
!!SN:W^Master_Adventurer_Hero%Y10^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/0/8/1&y1=y10:Py1/2/y12/y99; [Buff Attacker]
*!IF:M^Davor Rechts Applied Attacker hopefully Hero Number %Y1^;
!!SN:W^Hero%Y10_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y10_Number_Saved_Side1^/-1;
!!en;

!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side0^/?y1;
!!if&y1>=0;
*!HEy11&y11>=0:S18/?y12;
!!SN:W^Master_Mage_Hero%Y11^/?y40;
!!SN:W^Master_Adventurer_Hero%Y11^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/21/29/1&y1=y11:Py1/3/y12/y99; [Buff Defender]
*!IF:M^Davor Links Applied Defender hopefully Hero Number %Y1^;
!!SN:W^Hero%Y11_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y11_Number_Saved_Side1^/-1;
!!en;

!!SN&y11>=0:W^Hero%Y11_Number_Saved_Side1^/?y1;
!!if&y1>=0;
*!HEy11&y11>=0:S18/?y12;
!!SN:W^Master_Mage_Hero%Y11^/?y40;
!!SN:W^Master_Adventurer_Hero%Y11^/?y41;
!!VRy12&y40=1/y41=1:S3;
!!DO(Remember_Spells_Fkt_3)/21/29/1&y1=y11:Py1/4/y12/y99; [Buff Defender]
*!IF:M^Davor Rechts Applied Defender hopefully Hero Number %Y1^;
!!SN:W^Hero%Y11_Number_Saved_Side0^/-1;
!!SN:W^Hero%Y11_Number_Saved_Side1^/-1;
!!en;


**Choose the correct hero and side**
!?FU(Remember_Spells_Fkt_3);

!!if&x2=1;
!!SN:W^Creature_Numerator1^/x16;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/1/x3/x4;
!!en;

!!if&x2=2;
!!VRy1:Sx16;
!!VRy1:+21;
!!SN:W^Creature_Numerator1^/y1;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/2/x3/x4;
!!en;

!!if&x2=4;
!!SN:W^Creature_Numerator1^/x16;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/3/x3/x4;
!!en;

!!if&x2=3;
!!VRy1:Sx16;
!!VRy1:-21;
!!SN:W^Creature_Numerator1^/y1;
!!DO(Remember_Spells_Fkt_4)/27/58/1:Px1/4/x3/x4;
!!en;


!?FU(Remember_Spells_Fkt_4);

!!if&x2=1;                             [Attacker 1]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!BMy3:N?y20;                           [Check Number]
!!BMy3:T?y21;                           [Check crreature Type]
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!if&y20>0/y4=y21/y1>0/y1<100;         [Meet right conditions Buff duration must be smaller than 100]
!!SN:W^Creature_Stack_Choice1^/?y10;
!!SN:W^Creature_Stack_Choice2^/?y11;
!!SN:W^Creature_Stack_Choice3^/?y12;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;                  [Play prayer sound if at least one stack transferd buffs]
!!SN:Pz-1;
*!IF:M^Now Spell %X16 and Monster %Y3 and Duration %Y1^;
!!en;
!!en;
!!en;
!!en;
!!en;

!!if&x2=2;                             [Attacker 2]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!VRy3:-21;
!!BMy3:N?y20;
!!BMy3:T?y21;
!!if&y20>0/y4=y21/y1>0/y1<100;
!!SN:W^Creature_Stack_Choice1^/?y10; !!VRy10:-21;
!!SN:W^Creature_Stack_Choice2^/?y11; !!VRy11:-21;
!!SN:W^Creature_Stack_Choice3^/?y12; !!VRy12:-21;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;
!!SN:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;

!!if&x2=3;                             [Defender 1]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!BMy3:N?y20;
!!BMy3:T?y21;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!if&y20>0/y4=y21/y1>0/y1<100;
!!SN:W^Creature_Stack_Choice1^/?y10;
!!SN:W^Creature_Stack_Choice2^/?y11;
!!SN:W^Creature_Stack_Choice3^/?y12;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;
!!SN:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;

!!if&x2=4;                             [Defender 2]
!!SN:W^Creature_Numerator1^/?y3;
!!if&y3>=0/y3<=41;
!!if&x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Duration^/?y1;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Power^/?y2;
!!SN:W^Hero%X1_Monster%Y3_Spell%X16_Type^/?y4;
!!VRy3:+21;
!!BMy3:N?y20;
!!BMy3:T?y21;
!!if&y20>0/y4=y21/y1>0/y1<100;
!!SN:W^Creature_Stack_Choice1^/?y10; !!VRy10:+21;
!!SN:W^Creature_Stack_Choice2^/?y11; !!VRy11:+21;
!!SN:W^Creature_Stack_Choice3^/?y12; !!VRy12:+21;
!!if|y3=y10/y3=y11/y3=y12;
!!BMy3:Mx16/x4/y2;                      [Apply spells]
!!VRz-1:S^PRAYER.wav^;
!!SN:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;


!?FU(Remember_Spells_Fkt_0);
!!SN:W^Hero%X16_Number_Saved_Side0^/-1;
!!SN:W^Hero%X16_Number_Saved_Side1^/-1;



********************************************************************************


                      Starting Commander/Heroes changes Section


********************************************************************************
!?PI;
*!DO(AC_Function_25)/0/155/1:P;         [loop through heroes]
Disabled because it confuses people

!?FU(AC_Function_25);

!!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active
!!if&y79=0;
!!if|x16=127/x16=8/x16=106/x16=123/x16=4/x16=122/x16=6/x16=54/x16=65/x16=81/x16=130;
;Tiva
;Rion, Dessa, Verdish
;Lord Haart, Voy
;Christian, Torosar, Pyre, Vokial, Arlach, Gerwulf, Pasis, Ignissa

!!VRy11|x16=127:S0;                     [Commander Paladin]
!!VRy11|x16=8/x16=106/x16=123:S1;       [Commander Hierophant]
!!VRy11|x16=4/x16=122:S5;               [Commander Brute]
!!VRy11|x16=6/x16=36/x16=54/x16=65/x16=81/x16=130:S6; [Commander Ogre Leader]

!!COx16:E0;                             [Remove Commander]
!!COx16:Ty11;                           [Set new Commander type]
!!COx16:E1;                             [Enable Commander]
!!COx16:D0;                             [Alive Commander]
!!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79; Check for Zulu Mod Active
!!if&y79=1;
!!if|x16=127/x16=8/x16=106/x16=123/x16=4/x16=122/x16=6/x16=54/x16=65/x16=81;
;Tiva
;Rion, Dessa, Verdish
;Lord Haart, Voy
;Christian, Torosar, Pyre, Vokial, Arlach, Gerwulf, Pasis, Ignissa

!!VRy11|x16=127:S0;                     [Commander Paladin]
!!VRy11|x16=8/x16=106/x16=123:S1;       [Commander Hierophant]
!!VRy11|x16=4/x16=122:S5;               [Commander Brute]
!!VRy11|x16=6/x16=36/x16=54/x16=65/x16=81/x16=130:S6; [Commander Ogre Leader]

!!COx16:E0;                             [Remove Commander]
!!COx16:Ty11;                           [Set new Commander type]
!!COx16:E1;                             [Enable Commander]
!!COx16:D0;                             [Alive Commander]
!!en;
!!en;


********************************************************************************

Change Heroes Speciali Descriptions

********************************************************************************
!?CM2&1000;                             [Show Correct Info for Wisdom Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!HEy6:B0/?z-1;
!!if&y12=7/y11=0;                      [if Wisdom]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:*1;                             [3% extra Growth per Hero Level]

!!SN:T^AC_Misc.Wisdom Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/26/4/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Scholar Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=18/y11=0;                     [if Scholar]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48::5+1;

!!SN:T^AC_Misc.Scholar Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/59/4/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Pathfinding Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=0/y11=0;                      [if Pathfinding]
!!HEy6:E?y46/?y48/1;                    [Check hero Level]
!!VRy49:Sy48:2 +5;
!!VRy47:Sy48:15+1;

!!SN:T^AC_Misc.Pathfinding Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/3/4/z2;                      [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Learning Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=21/y11=0;                     [if Learning]

!!HEy6:R2/?y75;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]

!!FU(Skill_Value_Database):Py6/y12/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]

!!SN&y75=0:T^AC_Misc.his^/?z-5;
!!SN&y75=1:T^AC_Misc.her^/?z-5;

!!SN:T^AC_Misc.Learning Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/68/4/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Crit Damage Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=57/y11=3;                     [if Crit Damage]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]

!!SN:T^AC_Misc.Crit Damage Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/9/57/4/z2;                      [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Firebird Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]

!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y6=130;                           [if Firebird/Ignissa]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]
!!VRy47:*2;

!!SN:T^AC_Misc.Firebird Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/21/130/4/z2;                    [show description for Hero Speciality when right click]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for First Aid Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]

!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=27/y11=0;                     [if First Aid]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]
!!VRy47:*1+10;
!!VRy48:Sy47:15+1;                      [HP increase]

!!SN:T^AC_Misc.First Aid Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/86/4/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Estate Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:B0/?z-1;
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=13/y11=0;                     [if Estates]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]

!!FU(Skill_Value_Database):Py6/y12/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10 extra resources per day]
!!SN:T^AC_Misc.Estates Specialist^/?z2; !!SN:Iz2/?z2;

!!IF:Q1/20/44/4/z2;                     [show description for Hero Speciality when right click]
!!CM:R0;                                [disable standard reaction]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Diplomacy Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=4/y11=0;                      [if Diplomacy]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y46/?y47/1;                    [Check hero Level]
!!VRy48:Sy47:5+1;
!!VRy49:Sy47:10+1;
!!VRy50:Sy47:2+1;
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Diplomacy Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/17/4/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;



!?CM2&1000;                             [Show Correct Info for Nobility Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!if&y12=5/y11=0;                      [if Nobility]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:*3;                             [3% extra Growth per Hero Level]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Nobility Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/20/4/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Artillery Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!FU&y6=118:E;                          [Gerwulf is now Warfare Specialist]
!!if|y6=6/y6=97/y6=54/y6=81/y6=118;    [if Artillery]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy48:Sy48:20+1;                      [Extra Shots]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Artillery Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/65/4/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Warfare Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!if|y6=131/y6=118;                    [if Warfare]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Warfare Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/62/4/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=1;
!!if|y6=131;                           [if Warfare]
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y40/?y41/1;                    [If Hero Lacus/Gerwulf or Warfare Specialist]
!!VRy42:Sy41:7;                         [Every 7 hero Levels]
!!VRy9:+y42;
!!VRy13&y41>=10:+1;                     [+1 Damage at Level 10]
!!VRy10&y41>=20:+1;                     [+1 Speed at Level 20]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Warfare Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/20/62/4/z2;                     [show description for Hero Speciality when right click]
!!en;
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Summon Earth Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!if&y6=129;                           [if 129 Thunar]
!!CM:R0;                                [disable standard reaction]
!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Summoning Earth Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/9/67/4/z2;                      [show description for Hero Speciality when right click]
!!en;

!!if&y6=25;                            [if 25 Uland]
!!CM:R0;                                [disable standard reaction]

!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Cure Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/9/37/4/z2;                      [show description for Hero Speciality when right click]
!!en;

!!if&y6=40;                            [if 40 Astral]
!!CM:R0;                                [disable standard reaction]

!!HEy6:B0/?z-1;

!!SN:T^AC_Misc.Hypnotize Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:Q1/9/60/4/z2;                      [show description for Hero Speciality when right click]
!!en;
!!en;

!?BG0&1000;

!!BG:H?y1;                              [Current attacking side]
!!BG:A?y2;
!!BG:S?y3;                              [y2 now contains spell number]
!!SN&y1=129/y2=1/y3=67:W^Thunar_Has_Cast_Summon^/1;

!?FU(OnAfterBattleUniversal)&1000;
!!HE129:O?y1;
!!SN&y1=-1:W^Thunar_Has_Cast_Summon^/0;
!!FU&y1=-1:E;                           [Exit if Thunar died in that fight]
!!SN:W^Thunar_Has_Cast_Summon^/?y1;
!!if&y1=1;
!!SN:W^Thunar_Has_Cast_Summon^/0;
!!HE129:F?y10/?y11/?y12/?y13;
!!VRy5:Sy12:7+R2+1;
!!HE129&1000:C2/113/y5/1;               [Add creatures to Hero Army]
!!UN&1000:R1;
!!en;

!?CM2&1000;                             [Show Correct Info for ordanary Secondary Skill Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>0:E;
!!if|y12=1/y12=2/y12=3/y12=6/y12=9/y12=10/y12=12/y12=22/y12=23/y12=24/y12=26; [Exceptions for heroes who have other specialities]
!!CM:R0;                                [disable standard reaction]

!!SN&y12=1:T^AC_Misc.Archery^/?z-3;
!!SN&y12=2:T^AC_Misc.Logistics^/?z-3;
!!SN&y12=3:T^AC_Misc.Scouting^/?z-3;
!!SN&y12=6:T^AC_Misc.Leadership^/?z-3;
!!SN&y12=9:T^AC_Misc.Luck^/?z-3;
!!SN&y12=10:T^AC_Misc.Ballistics^/?z-3;
!!SN&y12=12:T^AC_Misc.Necromancy^/?z-3;
!!SN&y12=13:T^AC_Misc.Estates^/?z-3;
!!SN&y12=19:T^AC_Misc.Warfare^/?z-3;
!!SN&y12=22:T^AC_Misc.Offense^/?z-3;
!!SN&y12=23:T^AC_Misc.Armorer^/?z-3;
!!SN&y12=24:T^AC_Misc.Intelligence^/?z-3;
!!SN&y12=26:T^AC_Misc.Resistance^/?z-3;

!!HEy6:R2/?y75;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]

!!FU(Skill_Value_Database):Py6/y12/y48/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]

!!SN&y75=0:T^AC_Misc.his^/?z-5;
!!SN&y75=1:T^AC_Misc.her^/?z-5;

!!SN:T^AC_Misc.Specialist 1^/?z2;       [The rest]

!!SN&y12=3:T^AC_Misc.Specialist 2^/?z2; [Scouting]

!!SN&y12=24:T^AC_Misc.Specialist 3^/?z2;[Intelligence]

!!VRy49:Sy48+10;
!!SN&y6=127:T^AC_Misc.Luck_Specialists^/?z2;[Luck]

!!SN:Iz2/?z2;
!!IF:M1/4/z2;
!!en;
!!en;


!?CM2&1000;                             [Show Correct Info for Gold Secondary Skill Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!if|y6=15/y6=47/y6=143/y6=18/y6=52;   [Caitlin, Aine, Grindan, Jenova, Octavia,]
!!CM:R0;                               [disable standard reaction]

!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy50:Sy48:10+1;
!!SN:T^AC_Misc.Economy Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:M1/4/z2;
!!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=1;
!!if|y6=15/y6=47/y6=18/y6=52;      [Caitlin, Aine, Grindan, Jenova, Octavia,]
!!CM:R0;                                [disable standard reaction]
!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!VRy50:Sy48:10+1;
!!SN:T^AC_Misc.Economy Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:M1/4/z2;
!!en;
!!en;

!!en;


!?CM2&1000;                             [Show Correct Info for Commander Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>3:E;                          [Changed to spell to prevent default bonus to these creatures]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!if|y6=36/y6=105/y6=128;
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!VRy50:Sy48:10+1;                      [+1 Speed per 10 level]
!!VRy51:Sy48*2 +3;                      [+2% Damage per Level]
!!VRy52:Sy48+9;                         [+1% per Health per Level +9%]
!!SN:T^AC_Misc.Commander Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:M1/4/z2;
!!en;
!!en;

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=1;
!!if|y6=36/y6=105;
!!CM:R0;                                [disable standard reaction]
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!VRy50:Sy48:10+1;                      [+1 Speed per 10 level]
!!VRy51:Sy48*2 +3;                      [+2% Damage per Level]
!!VRy52:Sy48+9;                         [+1% per Health per Level +9%]
!!SN:T^AC_Misc.Commander Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:M1/4/z2;
!!en;
!!en;

!!en;


!?CM2&1000;                             [Show Correct Info for Creature Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!HEy6:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>1:E;
!!FU|y12=130/y12=146:E;                 [Exceptions for heroes who have other specialities]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!FU|y6=36/y6=48/y6=105/y6=128:E;       [Exceptions for heroes who have other specialities]
!!en;

!!if&y79=1;
!!FU|y6=36/y6=48/y6=105:E;              [Exceptions for heroes who have other specialities]
!!en;

!!CM:R0;                                [disable standard reaction]
!!HEy6:R2/?y70;
!!HEy6:B0/?z-1;
!!HEy6:E?y47/?y48/1;                    [Check hero Level]
!!SN&y70=0:T^AC_Misc.his^/?z-5;
!!SN&y70=1:T^AC_Misc.her^/?z-5;

!!FU(Set_Creature_Upgrades_0):Py12/y6/?y16/?y17;

!!UN:N3/z-3/y12/1;                      [Normal Creature]
!!UN:N3/z-4/y16/1;                      [First Upgrade]
!!UN:N3/z-6/y17/1;                      [Second Upgrade]

!!MA:Ly12/?y14;                         [Get creature level]
!!VRy60&y14=0:S16; !!VRy60&y14=1:S15; !!VRy60&y14=2:S13; !!VRy60&y14=3:S12; !!VRy60&y14=4:S10; !!VRy60&y14=5:S7; !!VRy60&y14=6:S5;
!!VRy14:+1;
!!VRy50:Sy48:7+1;                       [7 Attack and Defense per Level]
!!VRy51:Sy48:y60;                       [Damage per Level based on creature level]
!!VRy52:Sy48+9;                         [+1% per Health per Level +9%]

!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y1; [Check for Third Upgrade Mod]
!!SN&y1=0:T^AC_Misc.Creature Specialist_0^/?z1/^level^/y14/^attack^/y50/^damage^/y51/^health^/y52; !!SN:Iz1/?z1; [Change text if Necessary]
!!SN&y1=1:T^AC_Misc.Creature Specialist_1^/?z1/^level^/y14/^attack^/y50/^damage^/y51/^health^/y52; !!SN:Iz1/?z1; [Change Text if TUM is active]
!!IF:M1/4/z1;
*!IF:M1/4/^%S(Text)^;
!!en;

*Extension Heroes improved Specialists Description
!?CM2&1000;                             [Show Correct Info for Artillery Specialists]
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]
!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!if|y6=144/y6=147/y6=148/y6=151/y6=153;[if extension hero]
!!CM:R0;                                [disable standard reaction]
!!HEy6:B0/?z-1;
!!SN&y6=144:T^AC_Misc.SirMullich_Specialist^/?z2; !!SN:Iz2/?z2;
!!SN&y6=147:T^AC_Misc.Dracon_Specialist^/?z2; !!SN:Iz2/?z2;
!!SN&y6=148:T^AC_Misc.Gelu_Specialist^/?z2; !!SN:Iz2/?z2;
!!SN|y6=151/y6=153:T^AC_Misc.Mutare_Specialist^/?z2; !!SN:Iz2/?z2;
!!IF:M1/4/z2;                           [show description for Hero Speciality when right click]
!!en;
!!en;
********************************************************************************




***********************Creature Specialists Buff in combat**********************

!?BF;

!!BH0:N?y1;                             [Attacker]
!!FU(AC_Function_31)&y1>=0/y1<=155:Py1/1;

!!BH1:N?y1;                             [Defender]
!!FU(AC_Function_31)&y1>=0/y1<=155:Py1/2;

!?FU(AC_Function_31);
!!HEx1:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
!!FU&y11<>1:E;                          [Exit if no Creature Specialist]
!!FU|y12=130/y12=146/y12>=174:E;        [Exceptions for heroes who have other specialities] Firebirds, Ballista and Commanders]

!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!MA:Ly12/?y14;
!!VRy60&y14=0:S16; !!VRy60&y14=1:S15; !!VRy60&y14=2:S13; !!VRy60&y14=3:S12; !!VRy60&y14=4:S10; !!VRy60&y14=5:S7; !!VRy60&y14=6:S5;

!!FU(Set_Creature_Upgrades_0):Py12/x1/?y13/?y14;

!!VRy50:Sy48:7+1;                       [Attack and Defense per 7 Level]
!!VRy51:Sy48:y60;                       [Damage per Level]
!!VRy52:Sy48+9 +100;                    [+1% per Health per Level +9%]
!!DO(AC_Function_30)/0/20/1&x2=1:Py12/y13/y50/y52/y51/y14; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!DO(AC_Function_30)/21/41/1&x2=2:Py12/y13/y50/y52/y51/y14; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]


!?FU(AC_Function_30);

!!BMx16:T?y1;

!!if|y1=x1/y1=x2/y1=x6;                [If Special Creature or Upgraded Creature is found increase stats]
!!BMx16:Adx3;                           [Attack]
!!BMx16:Ddx3;                           [Defense]
!!BMx16:H?y2; !!VRy2:*x4:100;           [Get Health]
!!BMx16:Hy2;
!!BMx16:U1/dx5 U2/dx5;                  [Min+Max Damage]
!!en;

********************************************************************************
!?FU(Set_Creature_Upgrades_0);
x1=Creature, x2=Hero Number, x3 Returns first upgrade, x4 Returns second upgrade

!!VRx3:Sx1+1;                           [Normal Upgraded Version]

*--Table for Third Upgrade Mod
Need to expand and edit here for every faction
!!VRx4&x1=0:S197;                       [Pikemen to Templar] *Castle*]
!!VRx4&x1=2:S198;                       [Archer to Templar] *Castle*]
!!VRx4&x1=4:S199;                       [Griffin to Templar] *Castle*]
!!VRx4&x1=6:S291;                       [Swordsman to Templar] *Castle*]
!!VRx4&x1=8:S169;                       [Monk to Templar] *Castle*]
!!VRx4&x1=10:S201;                      [Cavalier to Templar] *Castle*]
!!VRx4&x1=12:S202;                      [Angel to Templar] *Castle*]

!!VRx4&x1=14:S192;                      [*Rampart*]
!!VRx4&x1=16:S203;                      [*Rampart*]
!!VRx4&x1=18:S256;                      [*Rampart*]
!!VRx4&x1=20:S204;                      [*Rampart*]
!!VRx4&x1=22:S205;                      [*Rampart*]
!!VRx4&x1=24:S206;                      [*Rampart*]
!!VRx4&x1=26:S207;                      [*Rampart*]

!!VRx4&x1=28:S255;                      [*Tower*]
!!VRx4&x1=30:S208;                      [*Tower*]
!!VRx4&x1=32:S209;                      [*Tower*]
!!VRx4&x1=34:S257;                      [*Tower*]
!!VRx4&x1=36:S210;                      [*Tower*]
!!VRx4&x1=38:S211;                      [*Tower*]
!!VRx4&x1=40:S212;                      [*Tower*]

!!VRx4&x1=42:S213;                      [*Inferno*]
!!VRx4&x1=44:S214;                      [*Inferno*]
!!VRx4&x1=46:S215;                      [*Inferno*]
!!VRx4&x1=48:S216;                      [*Inferno*]
!!VRx4&x1=50:S217;                      [*Inferno*]
!!VRx4&x1=52:S218;                      [*Inferno*]
!!VRx4&x1=54:S219;                      [*Inferno*]

!!VRx4&x1=56:S220;                      [*Nekro*]
!!VRx4&x1=58:S141;                      [*Nekro*]
!!VRx4&x1=60:S159;                      [*Nekro*]
!!VRx4&x1=62:S221;                      [*Nekro*]
!!VRx4&x1=64:S222;                      [*Nekro*]
!!VRx4&x1=66:S223;                      [*Nekro*]
!!VRx4&x1=68:S224;                      [*Nekro*]

!!VRx4&x1=70:S225;                      [*Dungeon*]
!!VRx4&x1=72:S227;                      [*Dungeon*]
!!VRx4&x1=74:S226;                      [*Dungeon*]
!!VRx4&x1=76:S228;                      [*Dungeon*]
!!VRx4&x1=78:S229;                      [*Dungeon*]
!!VRx4&x1=80:S230;                      [*Dungeon*]
!!VRx4&x1=82:S231;                      [*Dungeon*]

!!VRx4&x1=84:S232;                      [*Stronghold*]
!!VRx4&x1=86:S233;                      [*Stronghold*]
!!VRx4&x1=88:S234;                      [*Stronghold*]
!!VRx4&x1=90:S235;                      [*Stronghold*]
!!VRx4&x1=92:S236;                      [*Stronghold*]
!!VRx4&x1=94:S237;                      [*Stronghold*]
!!VRx4&x1=96:S238;                      [*Stronghold*]

!!VRx4&x1=98:S239;                      [*Fortres*]
!!VRx4&x1=100:S240;                     [*Fortres*]
!!VRx4&x1=104:S241;                     [*Fortres*]
!!VRx4&x1=106:S242;                     [*Fortres*]
!!VRx4&x1=102:S244;                     [*Fortres*]
!!VRx4&x1=108:S243;                     [*Fortres*]
!!VRx4&x1=110:S245;                     [*Fortres*]

!!VRx4&x1=118:S246;                     [*Conflux*]
!!VRx4&x1=112:S247;                     [*Conflux*]
!!VRx4&x1=115:S248;                     [*Conflux*]
!!VRx4&x1=114:S249;                     [*Conflux*]
!!VRx4&x1=113:S250;                     [*Conflux*]
!!VRx4&x1=120:S251;                     [*Conflux*]
!!VRx4&x1=130:S252;                     [*Conflux*]

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
*--Fix for Confluxers
!!VRx3|x2=133/x2=129:S125;              [Erdamon or Thunar Magma Element]
!!VRx3|x2=134/x2=130:S129;              [Fiur or Ignissa]
!!VRx3|x2=135/x2=131:S123;              [Kalt or Lacus]
!!VRx3|x2=128/x2=132:S121;              [Pasis or Monere]
!!VRx3|x2=141/x2=129:S127;              [Aenian]

!!VRx4|x2=133/x2=129:S250;              [Erdamon  Mineral Element]
!!VRx4|x2=134/x2=130:S249;              [Fiur]
!!VRx4|x2=135/x2=131:S248;              [Kalt]
!!VRx4|x2=128/x2=132:S251;              [Pasis or Monere]
!!VRx4|x2=141/x2=129:S247;              [Aenian]
*--
!!en;


*******************Buff Commanders Firebirds Ballistas**************************
!?BF;

!!BH0:N?y1;                             [Attacker]
!!FU(AC_Function_32)&y1>=0/y1<=155:Py1/1;

!!BH1:N?y1;                             [Defender]
!!FU(AC_Function_32)&y1>=0/y1<=155:Py1/2;

!?FU(AC_Function_32);
!!HEx1:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]

!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!MA:Ly12/?y14;

!!if&y12=146/y11=1;                    [If Ballista]
!!VRy51:Sy48:8;                         [1 Damage per 8 Level  Ballista]
!!VRy13:S999;                           [Upgraded Version]
!!DO(AC_Function_30)/0/20/1&x2=1:Py12/y13/0/100/y51; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!DO(AC_Function_30)/21/41/1&x2=2:Py12/y13/0/100/y51; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!en;

!!SN:W^Zulu_Mod_On^/?y79;
!!if&y79=0;
!!if|x1=36/x1=105/x1=128;              [If any Commander]
!!VRy51:Sy48 +109;                      [10%+ 1% HP per Level]
!!VRy52:Sy48*2 +103;                    [2% Damage per Level]
!!VRy53:Sy48:10+1;                      [+1 Speed for 10 Heroes Levels]
!!VRy13:S999;                           [Upgraded Version]
!!DO(AC_Function_33)/0/20/1&x2=1:Py12/y13/y53/y51/y52; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!DO(AC_Function_33)/21/41/1&x2=2:Py12/y13/y53/y51/y52; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!en;

!!if&x1=130;                           [If Firebird or Phoenix]
!!VRy12:S130;
!!VRy51:Sy48*2;                         [2 HP per Level]
!!VRy13:Sy12+1;                         [Upgraded Version]
!!DO(AC_Function_34)/0/20/1&x2=1:Py12/y13/0/y51/0; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!DO(AC_Function_34)/21/41/1&x2=2:Py12/y13/0/y51/0; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!en;
!!en;

!!if&y79=1;
!!if|x1=36/x1=105;                     [If any Commander]
!!VRy51:Sy48 +109;                      [10%+ 1% HP per Level]
!!VRy52:Sy48*2 +103;                    [2% Damage per Level]
!!VRy53:Sy48:10+1;                      [+1 Speed for 10 Heroes Levels]
!!VRy13:S999;                           [Upgraded Version]
!!DO(AC_Function_33)/0/20/1&x2=1:Py12/y13/y53/y51/y52; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!DO(AC_Function_33)/21/41/1&x2=2:Py12/y13/y53/y51/y52; [Pass Creature, Upgraded Creature, Att/Def, Health and Damage]
!!en;
!!en;


!?FU(AC_Function_33);

!!BMx16:T?y1;
!!if&y1>=174/y1<=191;                  [If Special Creature or Upgraded Creature is found increase stats]
!!BMx16:H?y2; !!VRy2:*x4:100;           [Get Health]
!!BMx16:Hy2;                            [Set Health]
!!BMx16:U1/?y3 U2/?y4; !!VRy3:*x5:100; !!VRy4:*x5:100;
!!BMx16:U1/y3 U2/y4;                    [Min+Max Damage]
!!BMx16:Sdx3;                           [add Speed]
!!en;

!?FU(AC_Function_34);

!!BMx16:T?y1;
!!if|y1=x1/y1=x2;                      [If Special Creature or Upgraded Creature is found increase stats]
!!BMx16:Hdx4;                           [Set Health]
!!en;

********************************************************************************
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0; [Trigger each monday]
!!SN:W^Zulu_Mod_On^/?y79;
!!FU&y79=1:E;
!!FU(AC_Function_47):P130;              [pass 130 Ignissa +1 Firebird per Week]


!?FU(AC_Function_47);
!!HEx1:O?y2;                            [Check hero owner]
!!OW:C?y3;                              [Check current player]
!!FU&y2<>y3:E;                          [Abort if not the same]
!!HEx1:C2/130/1/1;                      [give 1 Firebird to Ignissa]

*!HEx1&i^timerDay^=1:C0/0/118/10;       [Change starting Army of Ignissa to pixis]
*!HEx1&i^timerDay^=1:C0/1/-1/-1;


********************************************************************************
**Gold and Estate Specialists give + random resources daily
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerIsAi^=0; [Trigger each day]
Caitlin, Aine, Grindan, Jenova, Octavia, (Damacon removed), Sephinroth

!!VRy10:S0T5;

!!HE15:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE15:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE47:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE47:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE143:O?y1;                           [Checke Hero Owner]
!!if&y1>=0;
!!HE143:E?y47/?y48/1;                   [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE18:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE18:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE52:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE52:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE84:O?y1;                            [Checke Hero Owner]
!!if&y1>=100;                          [Disabled and Made Medusa Specialist]
!!HE84:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!HE94:O?y1;                            [Checke Hero Owner]
!!if&y1>=0;
!!HE94:E?y47/?y48/1;                    [Check Hero Level]
!!VRy50:Sy48:10+1;                      [Give +1 +Level/10]
!!OW:Ry1/y10/dy50;                      [Add random resource to player]
!!en;

!!UN:R2;                                [Redraw Screen to show ne value of gold]


***************************Nekropolis Soul Eater********************************
!?BG0;                                  [Killed enemies get reanimated as Skeletons/Warriors during combat]

!!BG:A?y1;
!!if|y1=6/y1=7;                        [If Shoot ir Melee]
!!SN:W^Commander_Aktion^/y1;            [Save if Melee6 or Shooting7]
!!BG:H?y5;
!!FU&y5<0:E;                            [Exit if no Hero]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=178/y2=187;                    [if Soul Eater]
!!COy5:X2/?y30;                         [Get Commander Level]
!!BG:E?y3;                              [Destination Poistion]
!!FU&y3=-1:E;                           [Exit if no Monster there]
!!BMy1:H?y4;                            [Current Hit Points of Soul Eater]
!!BMy3:N?y5;                            [Number of Attacked Stack]
!!BMy3:H?y6;                            [Health of Attacked Stack]
!!SN:W^Soul_Eater_Target^/y3;
!!SN:W^Soul_Eater_Target_Stacksize^/y5;
!!SN:W^Soul_Eater_Stack^/y1;
!!en;
!!en;

!?BG1;                                  [Killed enemies get reanimated as Skeletons during combat]

!!SN:W^Soul_Eater_Target^/?y3;          [Readout Var]
!!SN:W^Soul_Eater_Stack^/?y4;
!!SN:W^Soul_Eater_Target_Stacksize^/?y5;
!!SN:W^Soul_Eater_Target^/-1;           [Reset Var]
!!SN:W^Soul_Eater_Target_Stacksize^/-1;
!!SN:W^Soul_Eater_Stack^/-1;
!!FU|y3<0/y5<1/y4=-1:E;

!!BMy4:N?y4;
!!FU&y4=0:E;
!!BMy3:N?y6;                            [Current Number of Monster]
!!BMy3:B?y7;                            [Number of Monster at Battle Start]

!!VRy8:Sy5-y6;                          [Get Killed Monsters in that Attack]
!!FU&y8=0:E;                            [Exit if no Kill]
!!VRy8::5;                              [Revive 20%]
!!SN:W^Commander_Aktion^/?y30;          [Check if Melee or Shooting]
!!VRy8&y30=7/y8>0::2;                   [Half effect if it was shooting]
!!VRy8&y8=0:S1;                         [Revive mind one if there was a kill]

!!VRy90:S0;

!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y99; [Check for Third Upgrade Mod]
!!if&y99=1;                            [If Third Upgrade Mod is enabled also check for Skeleton Knights]
  [:loop2];
  !!VRy10:S0T7;
  !!BMy10:T?y11;
  !!BMy10:N?y12;
  !!VRy90:+1;
  !!VRy11&y90=40:S220;                   [Terminate Loop if no Skeleton Warrior 57 found]
  !!VRy12&y90=40:S1;
  !!SN|y11<>220/y12=0:G[loop2];         [Loop until Skeleton Knight found]

  !!if&y90=40/y11=220;                    [If no Skeleton Knight found look for Skeletons 57]
  !!VRy90:S0;
    [:loop];
    !!VRy10:S0T7;
    !!BMy10:T?y11;
    !!BMy10:N?y12;
    !!VRy90:+1;
    !!VRy11&y90=40:S57;                     [Terminate Loop if no Skeleton Warrior 57 found]
    !!VRy12&y90=40:S1;
    !!SN|y11<>57/y12=0:G[loop];             [Loop until Skeleton Warrior found]
  !!en;

  !!if&y90=40/y11=57;                    [If no Skeleton Warrior found look for Skeletons 56]
    !!VRy91:S0;
    [:loop1];
    !!VRy10:S0T7;
    !!BMy10:T?y11;
    !!BMy10:N?y12;
    !!VRy91:+1;
    !!FU&y91=40:E;                          [Exit complete Function if no Valid Creature can be found]
    !!SN|y11<>56/y12=0:G[loop1];            [Loop until Skeleton found]
  !!en;

  !!if|y11=56/y11=57/y11=220;
    !!VRz-1&f=0:S^ANIMDEAD^;
    !!SN&f=0:Pz-1;
    !!BMy10:Ndy8 Bdy8;
    !!BMy10&f=0/1000:V4;
  !!en;
  !!FU:E;
!!en;

[:loop];
!!VRy10:S0T7;
!!BMy10:T?y11;
!!BMy10:N?y12;
!!VRy90:+1;
!!VRy11&y90=40:S57;                     [Terminate Loop if no Skeleton Warrior 57 found]
!!VRy12&y90=40:S1;
!!SN|y11<>57/y12=0:G[loop];             [Loop until Skeleton Warrior found]

!!if&y90=40/y11=57;                    [If no Skeleton Warrior found look for Skeletons 56]
  !!VRy91:S0;
  [:loop1];
  !!VRy10:S0T7;
  !!BMy10:T?y11;
  !!BMy10:N?y12;
  !!VRy91:+1;
  !!FU&y91=40:E;                          [Exit complete Function if no Valid Creature can be found]
  !!SN|y11<>56/y12=0:G[loop1];            [Loop until Skeleton found]
!!en;

!!if|y11=56/y11=57;
  !!VRz-1&f=0:S^ANIMDEAD^;
  !!SN&f=0:Pz-1;
  !!BMy10:Ndy8 Bdy8;
  !!BMy10&f=0/1000:V4;
!!en;


***************************Hierophant and Ogre Leader***************************
!?BF;                                   [Increases HP of First Aid Tent or Ballista by +10 per Level]

!!BA:H0/?y1;                            [Attacker]
!!COy1:D?y10;                           [Get Commander Alive]
!!COy1:T?y11;                           [Get Commander Type]
!!if&y10=0;                            [If Alive]
!!COy1:X2/?y12;                         [Get Commander Level]
!!VRy13:Sy12*10;                        [10*Commander Level to HP]
!!VRy14:Sy12:6;                         [Commander Level/6 to Min+Max Damage]
!!DO(AC_Function_39)/0/10/1&y11=1:P147/y13; [Hierophant pass 147 for First Aid Tent and Commander Level]
!!DO(AC_Function_39)/0/10/1&y11=6:P146/y13/y14; [Ogre Leader pass 146 for Ballista and Commander Level]
!!en;

!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!COy1:D?y10;                           [Get Commander Alive]
!!COy1:T?y11;                           [Get Commander Type]
!!if&y10=0;                            [If Alive ]
!!COy1:X2/?y12;                         [Get Commander Level]
!!VRy13:Sy12*10;                        [10*Commander Level to HP]
!!VRy14:Sy12:6;                         [Commander Level/6 to Min+Max Damage]
!!DO(AC_Function_39)/21/31/1&y11=1:P147/y13; [Hierophant pass 147 for First Aid Tent and Commander Level]
!!DO(AC_Function_39)/21/31/1&y11=6:P146/y13/y14; [Ogre Leader pass 146 for Ballista and Commander Level]
!!en;


!?FU(AC_Function_39);                   [increase Units Stats]

!!BMx16:T?y1;
!!if&y1=x1;
!!BMx16:N?y2;                           [Creature Number y20]
!!FU&y2=0:E;                            [Exit if zero]
!!BMx16:Hdx2;                           [Add fix HP to Ballista or First Aid Tent]
!!BMx16&x1=146:U1/dx3 U2/dx3;           [Min+Max Damage add only for Ballista]
!!en;

***************************Hierophantr***************************
!?BG0;                                  [Hierophant Shield Cast will block 1 time damage fixed amount]

!!BG:A?y1;
!!FU&y1<>10:E;                          [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;
!!if|y2=175/y2=184;                    [if Hierophant]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;
!!BG:H?y5;                              [Get Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!COy5:X2/?y6;                          [Get Commander Level]
!!COy5:S4/?y7;                          [Get Magic Level of Commander]
!!SN:W^Hierophantr_Shield_Cast%Y4^/y4;
!!en;
!!en;

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Shield_Attacking_Stack^/y4;

!!SN:W^Hierophantr_Shield_Cast%Y4^/?y3; [Check if Spell was actually cast by Hero]
!!FU&y3=-1:E;
!!FU&y4<>y3:E;                          [Exit if this creature was not blessed with Hierophant Shield Cast]

!!BMy4:G27/?y13/?y14;                   [check for Shield Duration]
!!FU&y13=0:E;                           [Exit if no Shield or no more Shield Blocks left]

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/y4;

!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;

!!COy99:X2/?y60;                        [Get Commander Level]
!!COy99:S4/?y70;                        [Get Magic Level of Commander]
!!VRy71:Sy70*y60*2;
!!VRy10:S50+y71;                        [calculate shield value]

!!BA:Q?f;

!!MF:F?y8;                              [damage dealt]

.!!if&y8>y10;                          [do if damage is bigger than shield]
!!VRy12:Sy6-y10;
!!VRy9:Sy8-y10;

!!VRz-1:S^CRUSDFND.wav^;                [find block sound]
!!SN&f=0:Pz-1;                          [play block sound]
!!MF:Fy9;

!!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y10;
!!BU:Mz-1;
.!!en;

.!!if&y8<=y10;                         [do if damage is smaller than shield]
!!VRy12:Sy6-y10;

!!VRz-1:S^CRUSDFND.wav^;                [find block sound]
!!SN&f=0:Pz-1;                          [play block sound]
!!VRy9:Sy8;
!!MF:E0;
!!MF:F0;

!!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y8;
!!BU:Mz-1;
.!!en;

!!SN:W^Hierophantr_Shield_Cast%Y4^/-1;
!!en;

!?FU(OnBeforeBattleUniversal);

!!re y1/0/41;
!!SN:W^Hierophantr_Shield_Cast%Y1^/-1;
!!en;


***************************Oger Leader***************************
!?BG0;                                  [Oger Leader casting Bloodlust will add fixed amount of damage to attacks]

!!BG:A?y1;
!!FU&y1<>10:E;                          [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;
!!if|y2=180/y2=189;                    [if Oger]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;
!!BG:H?y5;                              [Get Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!COy5:X2/?y6;                          [Get Commander Level]
!!COy5:S4/?y7;                          [Get Magic Level of Commander]
!!SN:W^Oger_Leader_Cast%Y4^/y4;
!!en;
!!en;

!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;          [Only run when melee or strikes around damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Oger_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Oger_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Oger_Leader_Cast%Y1^/?y3;

!!FU&y3=-1:E;
!!FU&y3<>y1:E;                          [Exit if this creature was not blessed with Hierophant Shield Cast]

!!BMy1:G43/?y13/?y14;                   [check for Bloodlust Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;

!!MF:F?y4;                              [original damage]
!!COy99:X2/?y60;                        [Get Commander Level]
!!COy99:S4/?y70;                        [Get Magic Level of Commander]
!!VRy71:Sy70*y60*3;
!!VRy23:S50+y71;                        [calculate shield value 50 plus Clvl*MLvL*3]
!!VRy6:Sy23;
!!VRy5:Sy6+y4;
!!MF:Fy5;                               [deal new updated damage]

!!SN:T^AC_Misc.Oger_Damage^/?z-1/^damage^/y6;
!!BU:Mz-1;
!!SN:W^Oger_Leader_Cast%Y1^/-1;
!!en;

!?FU(OnBeforeBattleUniversal);

!!re y1/0/41;
!!SN:W^Oger_Leader_Cast%Y1^/-1;
!!en;


***************************Succubus charming************************************
!?BG0;                                  [Charms enemies in combat by casting hypno when attacking]

!!BG:A?y1;
!!FU&y1<>6:E;                           [Exit if not Melee Attack]
!!BG:H?y5;
!!FU&y5<0:E;                            [Exit if no Hero]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=177/y2=186;                    [if Succubus]
!!COy5:X2/?y30;                         [Get Commander Level]
!!BG:E?y3;                              [Destination Poistion]
!!FU&y3=-1:E;                           [Exit if no Monster there]
!!BMy3:F?y10;                           [Get Monster Flag]
!!VRy10:&1024;                          [1024 Mind Spell Immunity]
!!FU&y10>0:E;                           [Exit if creature is Mind Immune]
!!BMy3:G34/?y11/?y12;                   [34 Anti-Magic]
!!FU|y11>0/y12>0:E;                     [Exit if Anti Magic]
!!BMy1:H?y4;                            [Current Hit Points of Succubus]
!!BMy3:N?y5;                            [Number of Attacked Stack]
!!BMy3:H?y6;                            [Health of Attacked Stack]
!!VRy7:Sy5*y6;                          [Get total life of attacked Stack]
!!VRy31:Sy30*75;
!!VRy4:+y31;                            [Succubus life +75*Level times the hit points of Succubus]
!!BMy3&y7<y4:M60/2/3;                   [If value is lower apply hypno to stack]
!!en;



***************************Temple Guardian**************************************
!?MF1;                                  [Regs +2(+3 ....) Mana with every Attack for the Hero]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;
!!BG:H?y5;
*!FU&y5<0:E;      [Exit if no Hero]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Temple_G_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Temple_G_Attacking_Stack^/y4;
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=176/y2=185;                    [if Temple Guardian]
!!COy5:X2/?y30;                         [Get Commander Level]
!!VRy31&y30<20:S2; !!VRy31&y30>=20:S3; !!VRy31&y30>=35:S4; !!VRy31&y30>=50:S6; [Increase reward with level 20 and 35 and 50]
!!BG:E?y3;                              [Destination Poistion]
!!FU&y3=-1:E;                           [Exit if no Monster there]
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py5/0/?y32/1; [Return Number of Max Possible Spell Points for the Hero]
!!HEy5:I?y33/1;                         [Give extra Mana Per Attack to hero]
!!VRy35:Sy33+y31;                       [Value of current spell points + the ones from attacks]
!!HEy5&y32>y35:Idy31/1;                 [Give extra Mana Per Attack to hero]
!!HEy5&y35>=y32:Iy33/1;                 [Set Spell Points to Max if value would be greater after adding]
!!FU&y35>=y32:E;                        [Exit to prevent showing Message if no Spell Points were added]
!!BA:Q?f;

!!SN&1000/f=0:T^AC_Misc.Temple Guardian^/?z1/^points^/y31;
!!BU&1000/f=0:Mz1;
!!en;
!!en;
!!en;


***************************Brute************************************************
!?MF1;                                  [Gives Physical Damage dealt in Gold after Combat]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage    4456676]

!!BG:A?y1;
!!if|y1=6/y1=7;
!!SN:W^Commander_Aktion^/y1;            [Save if Melee6 or Shooting7]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Brute_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Brute_Attacking_Stack^/y4;
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=179/y2=188;                    [if Brute]
!!BG:H?y5;                              [Get Hero]
!!HEy5&y5>=0:O?y56;                     [Get Hero Color]
!!OW:Iy56/?y57;                         [Get if AI or Human}]
!!SN&y57=0:W^Message_Flag^/1;           [Set Flag if Human Player]
!!COy5:X2/?y30;                         [Get Commander Level]
!!BG:E?y3;                              [Destination Poistion]
!!FU&y3=-1:E;                           [Exit if no Monster there]
!!BMy4:N?y5;                            [Number of Attacked Stack]
!!BMy4:H?y6;                            [Health of Attacked Stack]
!!VRy7:Sy5*y6;                          [Get total life of attacked Stack]
!!MF:F?y10;                             [damage dealt]
!!SN:W^Commander_Aktion^/?y50;          [Check if Melee or Shooting]
!!VRy10&y50=7::2;                       [Half effect if shooting]
!!SN&y7>=y10:W^Brute_Gold^/dy10;        [If damage is smaller than complete HP of stack add to generated Gold]
!!SN&y10>=y7:W^Brute_Gold^/dy7;         [If damage dealt is higher than full stack just add HP of full stack left]
!!SN:W^Brute_Gold^/?y11;
*!VRy31:Sy30*2+98;    [100% at level 1 200% at level 50]
*!VRy11:*y31:100;     [Increase Gold gain by 2% for each commander level]
!!BA:Q?f;

!!SN&1000/f=0:T^AC_Misc.Brute^/?z1/^gold^/y11;
!!BU&1000/f=0:Mz1;
!!en;
!!en;
!!en;

!?MR1;                                  [Gives Magical Damage dealt in Gold after Combat]

!!BG:A?y1;
!!FU&y1<>10:E;
!!BG:N?y1;                              [Current Stack]
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=179/y2=188;                    [if Brute]
!!BG:H?y5;                              [Get Hero]
!!HEy5&y5>=0:O?y56;                     [Get Hero Color]
!!OW:Iy56/?y57;                         [Get if AI or Human}]
!!SN&y57=0:W^Message_Flag^/1;           [Set Flag if Human Player]
*!COy5:X2/?y30;   [Get Commander Level]
!!BG:E?y3;                              [Destination Poistion Monster Stack]
!!FU&y3=-1:E;                           [Exit if no Monster there]
!!BMy3:N?y9;                            [Number of Attacked Stack]
!!BMy3:H?y6;                            [Health of Attacked Stack]
!!VRy7:Sy9*y6;                          [Get total life of attacked Stack]
!!COy5:S4/?y8;                          [Get Magic Level of Commander]
!!VRy20:S60; !!VRy20&y8=1:S60; !!VRy20&y8=2:S120; !!VRy20&y8=3:S200; !!VRy20&y8=4:S300; !!VRy20&y8=5:S500;

!!HEy5:S25/?y30;
!!SN:W^H3_Sorcery_0_Hero%Y50^/?y31;
!!SN:W^H3_Sorcery_1_Hero%Y50^/?y32;
!!VRy33:S100; !!VRy33&y30=1:S110; !!VRy33&y30=2:S120; !!VRy33&y30=3/y31=0/y32=0:S130; !!VRy33&y30=3/y31=1/y32=0:S140; !!VRy33&y30=3/y31=1/y32=1:S150; [Add Sorcery Damage +10%-50%]
!!VRy20:*y33:100;                       [Calc new Spell Damage]
*!VRy20&y10<y60::2;    [If Hero has not enough Mana cast deals only 50% damage

!!SN&y7>=y20:W^Brute_Gold^/dy20;        [If damage is smaller than complete HP of stack add to generated Gold]
!!SN&y20>=y7:W^Brute_Gold^/dy7;         [If damage dealt is higher than full stack just add HP of full stack left]
!!SN:W^Brute_Gold^/?y11;
*!VRy31:Sy30:20;
*!VRy31&y31=0:S1;
*!VRy11:*y31;     [Increase Gold gain after level 20 for each 20 Commander levels]
!!BA:Q?f;
!!SN&1000/f=0:T^AC_Misc.Brute^/?z1/^gold^/y11;
!!BU&1000/f=0:Mz1;
!!en;


!?FU(OnAfterBattleUniversal);

!!BA:H0/?y1;                            [Attacker Hero Number]
!!SN:W^Brute_Gold^/?y2;                 [If Alive]
!!FU|y1<0/y2=0:E;
!!HEy1:O?y25;                           [(Check hero owner)]
!!OW:C?y26;                             [(Check current player)]
!!FU&y25<>y26:E;                        [(Abort if not the same)]
!!CO-1:D?y4;                            [Check if Commander of Hero is still alive]
!!FU&y4=1:E;                            [Exit if hes not]
!!if&y4=0;                             [If commander alive]
!!CO-1:X2/?y30;                         [Get Commander Level]
*!VRy31:Sy30*2+98;  [100% at level 1 200% at level 50]
*!VRy2:*y31:100;    [Increase Gold gain by 2% for each commander level]
!!SN&1000:T^AC_Misc.Gained Gold^/?z1/^gold^/y2;
!!SN:W^Message_Flag^/?y20;              [Set Flag if Human Player]
!!IF&1000/y20=1:M^%Z1^;                 [Display text to humans and if value is bigger zero]
!!OW:Ry25/6/dy2;                        [Add gold to current player]
!!UN:R2;                                [Redraw Screen to show new value of gold]
!!en;

!?FU(OnBeforeBattleUniversal);
!!SN:W^Message_Flag^/0;                 [Set Flag if Human Player]


***************************Paladin**********************************************
!?BG0;                                  [Paladin Cure cast can gives chance to Resurrect. Chance to fail for higher creature levels.]

!!BG:A?y1;
!!FU&y1<>10:E;                          [Exit if No Creature Cast]
!!BG:N?y1;                              [Attacking Stack Commander]
!!BMy1:T?y2;
!!if|y2=174/y2=183;                    [if Paladin]
!!BG:S?y2 E?y4;                         [Spell and Destination Poistion]
!!FU&y4=-1:E;                           [Exit if no Monster there]
!!if&y2=-1/y4>=0/y4<=41;
!!BG:H?y5;                              [Get Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!COy5:X2/?y6;                          [Get Commander Level]
!!COy5:S4/?y7;                          [Get Magic Level of Commander]
!!BMy4:N?y8 B?y9;                       [Get Monster Number current and Battle Start]
!!FU&y8>=y9:E;
!!BMy4:T?y10;
!!MA:Ly10/?y11;                         [Get Monster Level]
!!VRy13:S0; !!VRy13&y11=0:S7; !!VRy13&y11=1:S6; !!VRy13&y11=2:S5; !!VRy13&y11=3:S4; !!VRy13&y11=4:S3; !!VRy13&y11=5:S2; !!VRy13&y11=6:S1; [Number of possible revices based on creature level]
!!VRy15:S0T99;
!!VRy16&y11=0:S90; !!VRy16&y11=1:S87; !!VRy16&y11=2:S85; !!VRy16&y11=3:S83; !!VRy16&y11=4:S80; !!VRy16&y11=5:S70; !!VRy16&y11=6:S50; [Number of possible revices based on creature level]
!!FU&y15>y16:E;                         [Exit if Roll not successfull ]
!!VRy12:Sy8+y13;                        [Add number to current number]
!!VRy12&y12>=y9:Sy9;                    [Cannot grow more than to begin of the fight]
!!BMy4:Ny12;
!!en;
!!en;


!?MF1;                                  [Gives Damage dealt in Experience to Hero after Combat]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;
!!SN:W^Commander_Aktion^/y1;            [Save if Melee6 or Shooting7]
!!BG:H?y5;
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Paladin_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Paladin_Attacking_Stack^/y4;
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=174/y2=183;                    [if Paladin]
!!BG:H?y5;                              [Get Hero]
!!HEy5&y5>=0:O?y56;                     [Get Hero Color]
!!OW:Iy56/?y57;                         [Get if AI or Human}]
!!SN&y57=0:W^Message_Flag^/1;           [Set Flag if Human Player]
!!COy5:X2/?y30;                         [Get Commander Level]
!!BG:E?y3;                              [Destination Poistion]
!!FU&y3=-1:E;                           [Exit if no Monster there]
!!BMy4:N?y5;                            [Number of Attacked Stack]
!!BMy4:H?y6;                            [Health of Attacked Stack]
!!VRy7:Sy5*y6;                          [Get total life of attacked Stack]
!!MF:F?y10;                             [damage dealt]
!!SN:W^Commander_Aktion^/?y50;          [Check if Melee or Shooting]
!!VRy10&y50=7::2;                       [Half effect if shooting]
!!SN&y7>=y10:W^Paladin_Experience^/dy10;[If damage is smaller than complete HP of stack add to generated Experience]
!!SN&y10>=y7:W^Paladin_Experience^/dy7; [If damage dealt is higher than full stack just add HP of full stack left]
!!SN:W^Paladin_Experience^/?y11;
!!VRy31:Sy30*5+200;                     [Increase Experience gain with 5% for each Commander level +100%]
!!VRy11:*y31:100;                       [Calc new value]
!!BA:Q?f;
!!SN&1000/f=0:T^AC_Misc.Paladin 2^/?z1/^Experience^/y11;
!!BU&1000/f=0:Mz1;
!!en;
!!en;
!!en;

!?FU(OnAfterBattleUniversal);
!!BA:H0/?y1;                            [Attacker Hero Number]
!!SN:W^Paladin_Experience^/?y2;         [If Alive]
!!FU|y1<0/y2=0:E;
!!HEy1:O?y25;                           [(Check hero owner)]
!!OW:C?y26;                             [(Check current player)]
!!FU&y25<>y26:E;                        [(Abort if not the same)]
!!CO-1:D?y4;                            [Check if Commander of Hero is still alive]
!!FU&y4=1:E;                            [Exit if hes not]
!!if&y4=0;                             [If commander alive]
!!CO-1:X2/?y30;                         [Get Commander Level]
!!VRy31:Sy30*5+200;                     [Increase Experience gain with 5% for each Commander level +100%]
!!VRy2:*y31:100;                        [Calc new value]
!!SN&1000:T^AC_Misc.Paladin^/?z1/^Experience^/y2;
!!SN:W^Message_Flag^/?y20;              [Set Flag if Human Player]
!!IF&1000/y20=1:M^%Z1^;                 [Display text to humans and if value is bigger zero]
!!HEy1:Edy2;                            [Add Experience to current player]
!!en;

***************************Shaman***********************************************
*Chance for Crushing Blow! Will Reduce Att/Def or Speed if successful hit of lvl 7 and 8
!?MF1&1000;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=6|y1=7;                        [Attack or Shoot]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shaman_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Shaman_Attacking_Stack^/y4;
!!if&y4>=0/y4<=41;
!!BA:Q?f;
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=181/y2=190;                    [if Shaman]
!!BG:H?y5;
!!COy5:X2/?y31;                         [Get Commander Level]
!!BG:E?y3;                              [Destination Poistion]
!!FU&y3=-1:E;                           [Exit if no Monster there]

!!VRy10:S0T99;
!!VRy11:Sy31+50;                        [Chance for Crushing Blow is level +50%]
!!if&y10<y11;
!!BMy4&1000/f=0:V14;
!!VRy30:S0T6;
!!VRy40:S2; !!VRy40&y31>=10:S3; !!VRy40&y31>=25:S4; !!VRy40&y31>=30:S4; !!VRy40&y31>=40:S5; !!VRy40&y31>=55:S6; !!VRy40:*-1; [+1 increased reduction per 10 level]
!!VRy41:S1; !!VRy41&y31>=20:S2; !!VRy41&y31>=55:S3; !!VRy41:*-1;
!!BMy4|y30=0/y30=3/y30=4/y30=6:Ady40;   [Attack -x]
!!BMy4|y30=1/y30=3/y30=5/y30=6:Ddy40;   [Defense -x]
!!BMy4|y30=2/y30=4/y30=5/y30=6:Sdy41;   [Speed -x]

!!BMy4:A?y20; !!VRy20&y20<=1:S1; !!BMy4:Ay20;
!!BMy4:D?y21; !!VRy21&y21<=1:S1; !!BMy4:Dy21;
!!BMy4:S?y22; !!VRy22&y22<=1:S2; !!BMy4:Sy22;

!!VRz-1&1000:S^DWRFDFND^;
!!SN&1000/f=0:Pz-1;
!!en;
!!en;
!!en;
!!en;
!!en;


*--------------Astral Spirit----Shaman Damage absorb --------------------------*
* gain 1 to max damage when killing complete stack max 3 times per combat-Shaman*
* gain 5 to max healt when killing complete stack max 3 times per combat-Spirit*

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage or Strikes all enemys around]

!!BG:A?y1;                              [Aktion in y1]
!!if&y1=6|y1=7;                        [Attack or Shoot]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shaman1_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Shaman1_Attacking_Stack^/y4;

!!BMy1:T?y2;                            [Creature Type]
!!FU|y2<180/y2>191:E;                   [Exit if no Commander]
!!MF:F?y3;
!!FU&y3=0:E;                            [Exit if Zero damage]
!!BG:H?y10;
!!BMy4:N?y5 H?y6 L?y7;                  [Get Number and Life of attacked Stack and lost Hitpoints]
!!VRy5:*y6-y7;                          [Get total Life of attacked stack]
!!FU&y5>y3:E;                           [Exit if not enough damage was dealt]

*!IF:L^HP of Attacked Stack is %Y5 and damage is %Y3  and shaman stack number is %Y1 and %Y4^;
!!if|y2=181/y2=190;                    [if Shaman]
!!SN:W^Shaman_Damage_Round_Counter^/?y11;
!!FU&y11>=3:E;                          [Exit so increase cannot happen more than 3 times per combat]
!!BMy1:U2/d1;
!!BA:Q?f;
!!VRz1&f=0:S^MAGCHDRN^;
!!SN&f=0:Pz1;
!!SN:W^Shaman_Damage_Counter%Y10^/d1;
!!SN:W^Shaman_Damage_Round_Counter^/d1;
!!en;

!!if|y2=182/y2=191;                    [191 Astral Spirit (defender) ]
!!SN:W^Spirit_Damage_Round_Counter^/?y11;
!!FU&y11>=3:E;                          [Exit so increase cannot happen more than 3 times per combat]
!!BMy1:Hd5;
!!BA:Q?f;
!!VRz1&f=0:S^MAGCHDRN^;
!!SN&f=0:Pz1;
!!SN:W^Spirit_Damage_Counter%Y10^/d1;
!!SN:W^Spirit_Damage_Round_Counter^/d1;
!!en;

!!en;
!!en;


!?FU(OnCombatRound)&v997=0;
*Reduce casts of all Commanders by -1 so with no Magic Skill they cannot cast
*Apply Shaman and Astral Spirit combat buff
!!DO(Shaman_Damage)/0/41/1:P;           [loop through Stacks]

!!SN:W^Spirit_Damage_Round_Counter^/0;  [Reset Round Counter]
!!SN:W^Shaman_Damage_Round_Counter^/0;


!?FU(Shaman_Damage);
!!BMx16:T?y1;                           [Creature Type]
!!BMx16:I?y2;                           [Side Index]
!!BHy2:N?y10;                           [Hero Number]
!!BMx16:N?y20;
!!FU&y20=0:E;

!!if|y1=181/y1=190;                    [if Shaman]
!!SN:W^This_Is_Replay_Battle^/?y30;
!!SN:W^Shaman_Damage_Round_Counter^/?y31;
!!SN&y30=1:W^Shaman_Damage_Counter%Y10^/d-y31;
!!SN:W^Shaman_Damage_Counter%Y10^/?y5;
!!BMx16&y5>0:U2/dy5;
!!en;

!!if|y1=182/y1=191;                    [Astral Spirit]
!!SN:W^This_Is_Replay_Battle^/?y30;
!!SN:W^Spirit_Damage_Round_Counter^/?y31;
!!SN&y30=1:W^Spirit_Damage_Counter%Y10^/d-y31;
!!SN:W^Spirit_Damage_Counter%Y10^/?y5;
!!VRy5:*5;
!!BMx16&y5>0:Hdy5;
!!en;

!!if&y1>173/y1<193;
!!BMx16:E?y10;
!!VRy10&y10>0:-1;
!!BMx16:Ey10;
!!en;


*************
*Astral Spirit*
!?MR1&1000;
*casting with commander costs the Hero 2+1*Spell Point for each rank of Magic

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>10:E;                          [Exit if no cast]

!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2;                            [Creature Type]
!!if|y2=176/y2=185/y2=179/y2=188;      [if Temple Guardian Attacker/Defender or Brute Attacker/Defender]
!!BG:H?y50;
!!FU&y50<0:E;                           [Exit if no Hero]
!!COy50:S4/?y60;                        [Get Magic Level of Commander]
!!HEy50:I?y10/1;                        [Get Hero Spell Points]
!!COy50:X2/?y40;                        [Get Commander Level]

!!VRy20:S60; !!VRy20&y60=1:S60; !!VRy20&y60=2:S120; !!VRy20&y60=3:S200; !!VRy20&y60=4:S300; !!VRy20&y60=5:S500;

!!VRy60:+2;
!!HEy50:S25/?y30;
!!SN:W^H3_Sorcery_0_Hero%Y50^/?y31;
!!SN:W^H3_Sorcery_1_Hero%Y50^/?y32;
!!VRy33:S100; !!VRy33&y30=1:S110; !!VRy33&y30=2:S120; !!VRy33&y30=3/y31=0/y32=0:S130; !!VRy33&y30=3/y31=1/y32=0:S140; !!VRy33&y30=3/y31=1/y32=1:S150; [Add Sorcery Damage +10%-50%]
!!VRy20:*y33:100;                       [Calc new Spell Damage]

!!MR:S?y2;
!!FU(H3_Calc_Normal_Spell_Damage):Py50/?y99/?y98/1/y2/0; [Pass Hero Number and Give Back Damage in y99 and Extra Damage Option and Spell Number]
!!VRy20:*y99:100;

!!VRy20&y10<y60::2;                     [If Hero has not enough Mana cast deals only 50% damage]

************
!!BG:Q?y4;
!!BA:Hy4/?y4;
!!FU&y4<=0:E;                           [Exit if no Hero]
!!BG:Q?y30;
!!VRy30:-1 *-1;
!!BA:Hy30/?y31;                         [Enemy Hero for resistance Calculation]
!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere 1 in y2]
!!FU|y2=15/y2=17:E;
!!FU&y20<=0:E;
!!MR:N?y5;                              [return Creature number which took magic damage]
!!BG:Q?y13;
!!BMy5:I?y12;
!!if&y13<>y12;
!!if&y5>=0/y5<=41;
!!FU(H3_Calc_Crit_Chance_and_Damage):Py4/?y16/?y99/1/y31/y2/y5; [(Pass Hero Number/Returns Crit chance/Crit damage/Battle State/Enemy Hero/Spell/Target)]
!!VRy9:S0T99;                           [y9 chance to crit (0..99)]
!!if&y9<y16;
!!VRy20:*y99:100;
*!IF:M^Returened Crit Chance %Y16 and Damage %Y99  and Random Roll %Y9 and Spell Damage y3 is %Y3^;
!!MR:Fy20;                              [apply new damage]
!!BA:Q?f;
!!BMy5&f=0:V82;                         [show crit animation]
!!en;
!!en;
!!en;
*********
*!IF:M^y20 is %Y20 and level is %Y40 and %Y41^;
!!MR&y9>=y16:Fy20;                      [Apply new damage only if not enough spell points]
!!VRy60:*-1;                            [Negative]
!!HEy50:Idy60/1;                        [Reduce Spell Points for every level of Magic from Commander +2]
!!HEy50:I?y11/1;                        [Check Spell Points again]
!!HEy50&y11<=0:I0/1;                    [Set Spell Points to zero if negative]
!!en;


********************************************************************************
!?FU(OnBeforeBattleUniversal);          [Set new Spells to cast for Commander]
!!UN:C7783293/1/37;                     [Paladin Cure]
!!UN:C7783311/1/27;                     [Hierophant Shield]
!!UN:C7783329/1/17;                     [Temple Guardian Lightning Strike]
!!UN:C7783347/1/29;                     [Succubus Fire Shield]
!!UN:C7783365/1/39;                     [Soul Eater Animate Dead]
!!UN:C7783383/1/15;                     [Brute Magic Arrow]
!!UN:C7783401/1/43;                     [Ogre Leader Bloodlust]
!!UN:C7783539/1/53;                     [Shaman Haste]
!!SN:W^Zulu_Mod_On^/?y79;
!!UN&y79=0:C7783554/1/69;               [Astral Spirit Summon Air Elements]

**Disable Death Stare from Commanders
!!VRv7080:C-1/-1/-1/-1/-1/-1/-1/-1/-1/-1;[initialize variables]
!!BA:H0/?v7083;                         [get hero (commander) number - attacker]
!!BA:H1/?v7085;                         [get hero (commander) number - defender]
!!COv7083&v7083>-1:B0/?y1 T?v7088;      [check skill bits, get type - attacker]
!!COv7085&v7085>-1:B0/?y2 T?v7089;      [check skill bits, get type - defender]
!!VRv7084&v7083>-1:Sy1 &4096;           [check death stare bit - attacker]
!!VRv7086&v7085>-1:Sy2 &4096;           [check death stare bit - defender]
!!COv7083&v7083>-1/v7084=4096:B1/12/0;  [remove death stare - attacker]
!!COv7085&v7085>-1/v7086=4096:B1/12/0;  [remove death stare - defender]

!!SN:W^Brute_Gold^/0;
!!SN:W^Paladin_Experience^/0;

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]
!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y10; [Check for Third Upgrade Mod]
!!FU&y10=0:E;
!!re i/0/41;
  !!BMi:T?y1;                           [Creature Type]
  !!BMi|y1=176/y1=185:U4/17;            [if Temple Guardian Attacker/Defender set to Lightning]
  !!BMi|y1=179/y1=188:U4/15;            [if Brute Attacker/Defender set to Magic Arrow]
  !!BMi|y1=180/y1=189:U4/43;            [if Oger Leader Attacker/Defender set to Bloodlust]
  !!BMi|y1=182/y1=191:U4/69;            [if Astral Spirit Attacker/Defender set to Summon Air]
!!en;

** pre-action trigger **
!?BG0&-998;                             [continue if enabled]

!!BG:N?v7080 A?v7081 E?v7082;           [get current stack, action type, destination stack]
!!BMv7082&v7082>-1:R?v7087;             [get retaliations of target creature stack]
!!BMv7080&v7080>-1:T?v7092;             [get type of current creature stack]
** end of pre-action trigger **

** post-action trigger **
!?BG1&-998;                             [continue if enabled]

!!BMv7080&v7080>-1:T?y3 I?y4;           [get acting monster type and side]
!!BMv7082&v7082>-1:F?y7 P?y8;           [get target's flags, position]
!!VRy10&y3>=174/y3<=191/v7081>=6/v7081<=7/v7084=4096/y4=0:S0T99; [random roll - attacker]
!!VRy11&y3>=174/y3<=191/v7081>=6/v7081<=7/v7086=4096/y4=1:S0T99; [random roll - defender]
!!FU7073&y3>=174/y3<=191/v7081>=6/v7081<=7/v7084=4096/y4=0/y10<50:Py7/y8; [50% cast poison if commander with death stare attacked or shot - attacker]
!!FU7073&y3>=174/y3<=191/v7081>=6/v7081<=7/v7086=4096/y4=1/y11<50:Py7/y8; [50% cast poison if commander with death stare attacked or shot - defender]

**  retaliation attack
!!BMv7082&v7082>-1:T?y3 I?y4 P?y5;      [get target monster type, side, position]
!!BU&v7082>-1:Ey5/?y6;                  [check if target is still alive]

!!BMv7080&v7080>-1:F?y9;                [get flags of attacking creature stack]
!!VRy9&v7080>-1:&65536;                 [check for no retaliation]

!!BMv7080&v7080>-1:F?y7 P?y8;           [get acting creature's flags, position]
!!VRy10&y3>=174/y3<=191/v7081=6/v7084=4096/v7087>0/y4=0/y6>-1/y9=0:S0T99; [random roll - attacker]
!!VRy11&y3>=174/y3<=191/v7081=6/v7086=4096/v7087>0/y4=1/y6>-1/y9=0:S0T99; [random roll - defender]
!!FU7073&y3>=174/y3<=191/v7081=6/v7084=4096/v7087>0/y4=0/y10<50/y6>-1/y9=0:Py7/y8; [50% cast poison if commander with death stare retaliates - attacker]
!!FU7073&y3>=174/y3<=191/v7081=6/v7086=4096/v7087>0/y4=1/y11<50/y6>-1/y9=0:Py7/y8; [50% cast poison if commander with death stare retaliates - defender]

!!BU:C?y1;                              [check for end of battle]
!!COv7083&v7083>-1/v7084=4096/y1=1:B1/12/1; [restore death stare - attacker]
!!COv7085&v7085>-1/v7086=4096/y1=1:B1/12/1; [restore death stare - defender]

** end of post-action trigger **
!?FU7073;
!!VRx1:&16;                             [just check alive bit]
!!BG:N?y1;                              [get current stack #]
!!BMy1&x1=16:C71/x2/1/3/1;              [if target is alive have current stack cast poison]
** end of function **


**Fix for Casting Commanders**
For Brute, Temple Guardian  and Astral Spirit
!?FU(OnBattleRegeneratePhase);
*!FU:E;                                 [Disbaled and replaced by switching actions.erm from xericsin]

!!SN:W^Temple_Guarding_Event^/-1;
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!SN:X?y1;                              [Event parameter]
!!BMy1:T?y2;                            [Acting Monster Type]
!!BMy1:I?y3;                            [Acting Monster Side]
!!SN|y2=176/y2=185/y2=179/y2=188/y2=182/y2=191:W^Temple_Guarding_Event^/y1;

!?CM4&1000;
*!FU:E;                                 [Disbaled and replaced by switching actions.erm from xericsin]

!!CM:F?y1 I?y2;
!!FU|y1<>512/y2<>2010:E;                [Exit if not rightclick on defend Icon]
!!SN:W^Temple_Guarding_Event^/?y3;
!!FU&y3=-1:E;
!!BMy3:T?y4;                            [Acting Monster Type]
!!if|y4=176/y4=185/y4=179/y4=188/y4=182/y4=191;

!!SN:W^Event_Counter^/?y10;
!!VRy10:%2;

!!if&y10=1;
!!SN:W^Temple_Guarding_Casts^/?y11;
!!BMy3:Ey11;                            [Restore Spells]
!!SN:T^AC_Misc.Spellcasting_Restored^/?z-2;
!!IF&y11>0:M^%Z-2^;
!!SN:W^Event_Counter^/d1;
!!en;

!!if&y10=0;
!!BMy3:E?y5;                            [Save Spells to cast]
!!BMy3:E0;                              [Set Spells to cast to zero]
!!SN:W^Temple_Guarding_Casts^/y5;
!!SN:W^Event_Counter^/d1;
!!en;
!!en;

!?FU(OnBeforeBattleUniversal);
*!FU:E;                                 [Disbaled and replaced by switching actions.erm from xericsin]
!!SN:W^Event_Counter^/0;
!!SN:W^Temple_Guarding_Casts^/0;
**end for casting fix**


***************************************
!?FU(Skill_Value_Database);
*x1=Hero Number,
*x2=Skill
*x3=Hero Level
*x4=Returned Value
!!HEx1:Sx2/?y10;                        [Check for Basic-Expert Skill Level]
!!FU(H3_Mod_Check_Skill_Level):Px1/?y11/?y12/x2; [Check for M/GM Skill Level]

*!IF:M^y10 is %Y10 y11 is%Y11 y12 is%Y12  x2 is%X2^;
*Archery
!!if&x2=1;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S25; !!VRy20&y10=3/y11=0/y12=0:S50; !!VRy20&y10=3/y11=1/y12=0:S65; !!VRy20&y10=3/y11=1/y12=1:S75;
!!en;

*Logistics
!!if&x2=2;
!!VRy20&y10=1:S15; !!VRy20&y10=2:S20; !!VRy20&y10=3/y11=0/y12=0:S25; !!VRy20&y10=3/y11=1/y12=0:S30; !!VRy20&y10=3/y11=1/y12=1:S35;
!!en;

*Necromancy
!!if&x2=12;
!!VRy20&y10=1:S5; !!VRy20&y10=2:S10; !!VRy20&y10=3/y11=0/y12=0:S15; !!VRy20&y10=3/y11=1/y12=0:S17; !!VRy20&y10=3/y11=1/y12=1:S20;
!!en;

*Estates
!!if&x2=13;
!!VRy20&y10=1:S250; !!VRy20&y10=2:S500; !!VRy20&y10=3/y11=0/y12=0:S750; !!VRy20&y10=3/y11=1/y12=0:S1000; !!VRy20&y10=3/y11=1/y12=1:S2000;
!!en;

*Learning
!!if&x2=21;
!!VRy20&y10=1:S20; !!VRy20&y10=2:S30; !!VRy20&y10=3/y11=0/y12=0:S40; !!VRy20&y10=3/y11=1/y12=0:S60; !!VRy20&y10=3/y11=1/y12=1:S75;
!!en;

*Offense
!!if&x2=22;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S20; !!VRy20&y10=3/y11=0/y12=0:S30; !!VRy20&y10=3/y11=1/y12=0:S35; !!VRy20&y10=3/y11=1/y12=1:S40;
!!en;

*Armorer
!!if&x2=23;
!!VRy20&y10=1:S5; !!VRy20&y10=2:S10; !!VRy20&y10=3/y11=0/y12=0:S15; !!VRy20&y10=3/y11=1/y12=0:S20; !!VRy20&y10=3/y11=1/y12=1:S25;
!!en;

*Intelligence
!!if&x2=24;
!!VRy20&y10=1:S25; !!VRy20&y10=2:S50; !!VRy20&y10=3/y11=0/y12=0:S100; !!VRy20&y10=3/y11=1/y12=0:S125; !!VRy20&y10=3/y11=1/y12=1:S150;
!!en;

*Sorcery
!!if&x2=25;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S20; !!VRy20&y10=3/y11=0/y12=0:S30; !!VRy20&y10=3/y11=1/y12=0:S40; !!VRy20&y10=3/y11=1/y12=1:S50;
!!en;

*Resistance
!!if&x2=26;
!!VRy20&y10=1:S10; !!VRy20&y10=2:S15; !!VRy20&y10=3/y11=0/y12=0:S20; !!VRy20&y10=3/y11=1/y12=0:S25; !!VRy20&y10=3/y11=1/y12=1:S30;
!!en;

!!VRx4:Sx3*3*y20:100;


********************************************************************************

!?FU(SetSecSkillPercent);               [SS Werte skill Setzten]
; x1 is a skill, x2 is a level (0..3), x3 is a value in objects, for example, 8
!!FU|x1<1/x1=5/x1=7/x1=10/x1>26:E; !!FU&x1>13/x1<21:E; !!FU|x2<0/x2>3:E;
!!VRy1&x1=1:S6547944;  !!VRy1&x1=2:S6548072;  !!VRy1&x1=3:S6547928;  !!VRy1&x1=4:S6548024;
!!VRy1&x1=6:S6547880;  !!VRy1&x1=8:S6547912;  !!VRy1&x1=9:S6547864;  !!VRy1&x1=11:S6548008;
!!VRy1&x1=12:S6547896; !!VRy1&x1=13:S6547992; !!VRy1&x1=21:S6548056; !!VRy1&x1=22:S6547960;
!!VRy1&x1=23:S6547976; !!VRy1&x1=24:S6548104; !!VRy1&x1=25:S6548088; !!VRy1&x1=26:S6548040;
!!VRx2:*4; !!VRy1:+x2; !!VRe1:Sx3:100; !!SN:X?y2 Xe1 X?y3 Xy2; !!UN:Cy1/4/y3;

********************************************************************************

!?PI;
!!FU(ClearSimultaneousAnimationsVars):P;

!?FU(ClearSimultaneousAnimationsVars);
!!SN:W^SimulAnim0^/0;
!!SN:W^SimulAnim1^/0;
!!SN:W^SimulAnim2^/0;
!!SN:W^SimulAnim3^/0;
!!SN:W^SimulAnim4^/0;
!!SN:W^SimulAnim5^/0;
!!SN:W^SimulAnim6^/0;
!!SN:W^SimulAnim7^/0;
!!SN:W^SimulAnim8^/0;
!!SN:W^SimulAnim9^/0;
!!SN:W^SimulAnim10^/0;
!!SN:W^SimulAnim11^/0;
!!SN:W^SimulAnim12^/0;
!!SN:W^SimulAnim13^/0;
!!SN:W^SimulAnim14^/0;
!!SN:W^SimulAnim15^/0;
!!SN:W^SimulAnim16^/0;
!!SN:W^SimulAnim17^/0;
!!SN:W^SimulAnim18^/0;
!!SN:W^SimulAnim19^/0;
!!SN:W^SimulAnim20^/0;                  [not used]
!!SN:W^SimulAnim21^/0;
!!SN:W^SimulAnim22^/0;
!!SN:W^SimulAnim23^/0;
!!SN:W^SimulAnim24^/0;
!!SN:W^SimulAnim25^/0;
!!SN:W^SimulAnim26^/0;
!!SN:W^SimulAnim27^/0;
!!SN:W^SimulAnim28^/0;
!!SN:W^SimulAnim29^/0;
!!SN:W^SimulAnim30^/0;
!!SN:W^SimulAnim31^/0;
!!SN:W^SimulAnim32^/0;
!!SN:W^SimulAnim33^/0;
!!SN:W^SimulAnim34^/0;
!!SN:W^SimulAnim35^/0;
!!SN:W^SimulAnim36^/0;
!!SN:W^SimulAnim37^/0;
!!SN:W^SimulAnim38^/0;
!!SN:W^SimulAnim39^/0;
!!SN:W^SimulAnim40^/0;
!!SN:W^SimulAnim41^/0;                  [not used]

!?FU(SimultaneousAnimations);
SimulAnim# are vars that tell which stack need to show animations. 0-19 for attacker, 21-40 for defender.
x1 animation ID, x2 damage animations for stacks, x3 0 if dead stack don't need to have animations, 1 if vice versa, x4 1 if reset vars.

The way this works is y20-29 will be variable that manage animations on stacks. When y20 has 1, 256, 65536 or S16777216 (256^0, 256^1, 256^2, 256^3), stacks number 0, 1, 2 or 3
will have animations played. y21 will manage animations for stacks 4, 5, 6, 7; etc. until y24 that manages 16, 17, 18, 19 stack ids. Then, y25-29 manage defender stacks
animations, y25 is for 21, 22, 23, 24 etc. y20 then is passed, along with y21-29 variables, to some function that does something, need to ask author of original finding, not me.
Some animations, like projectiles (Lightning Bolt, Disrupting ray) and Armageddon don't work properly.

!!VRy31:S1;                             [first stack in y20-29 vars]
!!VRy32:S256;                           [second stack in y20-29 vars]
!!VRy33:S65536;                         [third stack in y20-29 vars]
!!VRy34:S16777216;                      [fourth stack in y20-29 vars]
**first argument - main battle struct
!!UN:C6919200/4/?y10;
**second argument - pointer to fourty byte array: one byte for array. Let's take y20-y29 for it. y20-y24 attacker (0-19), y25-y29 defender (21-40)
!!VRy1:S0;
[:loopSimultaneousAnimations]; loop is label name inside current function
!!VRy1&y1=20:+1;
!!SN&y1=20:G[loopSimultaneousAnimations];[skip stack 20]

!!VRy2:Sy1;
!!VRy2&y1>=20:-1;                       [since stack number 20 does not exist, all 21-40 are moved to 20-39 so when we divide by 4 we'll get correct y25-y29 variables]
!!VRy3:Sy2 %4;
!!VRy2::4 +20;                          [get y20-29 var number]
!!VRyy2&y3=0:S0;                        [null y20-29 variables before loop. When y3=0 when we first encounter corresponding y20-y29 variable.]
!!VRy3:+31;
!!VRy5:Syy3;                            [get stack number for y20-29 vars]

!!BMy1:P?y3;
!!FU|y3<0/y3>186:E;
!!BU:Ey3/?y3;                           [-1 if stack is dead or not present at position]
!!SN:W^SimulAnim%Y1^/?y4;
!!VRy4&y3=-1/x3=0:S-1;
!!VRyy2&y4=1:Syy2 +y5;                  [set y20-y29 variables if it's animations are set.]

!!VRy1:+1;
!!SN&y1<41:G[loopSimultaneousAnimations];[loop all stacks]
**third argument - animation ID (5 - antimagic)
**fourth argument - is damage animation required (0 - no, 1 - yes)
!!SN:E5925584/2/y10/?y20/x1/x2;
!!FU(ClearSimultaneousAnimationsVars)&x4=1:P;


********************************************************************************

********************************************************************************

                          Adventurer Leveling

This script sets the chance for Adventurer Heroes to gain Secondary Skills and Primary Skill Points
Author: Alf :)
********************************************************************************
!?FU(OnHeroGainLevel);

!!SN:W^Game_Start_Value^/?y2;           [So it only runs after the map has started]
!!FU&y2<>10:E;

!!HE-1:N?y1;
!!FU(Valid_Adventurer_Hero):Py1/?y60;   [Call Function to Check if Adventurer Hero]
!!FU&y60<>1:E;

!!HL:S?y50/?y2/?y3;                     [Get primary stat, left and right skill numbers. Naturally, if upgrade for a skill is suggested, it will be in left skill.]
 There're multiple situations which can occur during leveling. y2=-2 or y3=-2 means, that both left and right skills are not set by others or this scripts.
If either of them is >-2, this script will not change that.
 We get these situations:
 y2=-2, y3=-2.
 y2>-2, y3=-2.
 y2=-2, y3>-2.
In first case all skills are not set, in second case only left, usually upgrade, skill is changed. Vicer versa for third case.
 Then it all depends on number of upgraded and not upgraded to the expert rank skills. If hero has at least 8 skills (Global_Skill_Limit), no new skills
will be proposed, hence script only changes attributes. If all hero's skills are upgraded to max (expert), then both skills will be new,
else only right skill will be new. If right or left skills are set, script doesn't change them.

!!if|y2=-2/y3=-2;                      [If right or left is not set, which corresponds to them being set by another script.]
!!SN:W^Global_Skill_Limit^/?y9;         [Number of skill limit for heroes.]
!!VRy4&y2>-2:S0;
!!VRy4&y2=-2:S1;
!!VRy5&y3>-2:S0;
!!VRy5&y3=-2:S1;
!!FU(GetHeroSkillsNumbers):Py1/?y7/?y8; [y2 is number of hero skills, y3 is number of skills with less than Expert rank.]


!!if&y7<y9;                            [Skill limit is not reached]
!!if&y4=1/y5=1/y8=0;                   [If both skills proposed will be basic rank.]
!!FU(AdventurerHeroGenerateSkill):Py1/?y2; [First generate one skill with adventurer chances.]
!!HEy1:Sy2/1;                           [Set this skill to 1 temporarily and let the function roll next skill assuming previous skill is learned.]
!!FU(AdventurerHeroGenerateSkill):Py1/?y3; [Second skill generation]
!!HEy1:Sy2/0;                           [Return first skill to not learned state.]
!!en;

!!if&y8>0/y5=1;                        [If there're unupgraded skills and right is not set. Left skill is left alone, change only right.]
!!FU(AdventurerHeroGenerateSkill):Py1/?y3; [Generate skill with adventurer chances.]
!!en;
!!if&y8=0/y4=1/y5=0;                   [If right skill is set, left is not and no unupgraded skills. Right skill is left alone, change only left.]
!!FU(AdventurerHeroGenerateSkill):Py1/?y2; [Generate skill with adventurer chances.]
!!en;
!!HL&y8=0/y4=1:S0/y2/y3;                [If both skills were not set and all skills are expert or none rank.]
!!HL|y8>0/y4=0:S0/?y2/y3;               [If either there's an unupgraded skill or left skill is set]
!!HL|y8>0/y4=0:S0/y2/y3;                [Copy left skill state and set right.]
!!en;

!!en;
!!FU(AdventurerHeroGenerateStat):Py1/?y6;[All that's left is to generate primary skill i.e. stat.]
!!HL:Sy6/?y2/?y3;
!!HL:Sy6/y2/y3;                         [Copy left and right skill just to set primary skill.]


!?FU(GetHeroSkillsNumbers);
Calculates how many skills hero learned and how many skills are not upgraded to expert.
x1 - hero id; x2 - return number of skills; x3 - return amount of non expert rank skills.
!!VRy1:S0;                              [Skill id from 0 to 27]
!!VRx2:S0;
!!VRx3:S0;
[:loopGetHeroSkillsNumbers]; loop is label name inside current function
!!HEx1&y1<28:Sy1/?y4;
!!VRx2&y1<28/y4>0:+1;
!!VRx3&y1<28/y4<>3/y4<>0:+1;
!!VRy1:+1;
!!SN&y1<28:G[loopGetHeroSkillsNumbers]; [Loop all skill IDs]

!?FU(AdventurerHeroGenerateSkill);
Generates id of the skill that current adventurer hero will learn, using custom table for adventurer heroes.
x1 - hero id; x2 - return generated skill.
*!IF:M^hero id %X1^;
!!FU(GetOverallSkillChance):Px1/?y1;
*!IF:M^hero %X1 chance %Y1^;
!!VRy1:-1;                              [Decrease chance since R random from 0 to y1, which gives y1+1 numbers.]
*!IF:M^hero %X1 chance after decr %Y1^;
!!VRy2:S0Ty1;
*!IF:M^random %Y2^;
!!FU(DetermineSkillByChance):Px1/y2/?x2;

!?FU(GetOverallSkillChance);
Calculates sum of chances of available to learn skills.
x1 - hero id; x2 - return sum of skill chances.
!!VRx2:S0;
!!VRy1:S0;                              [Skill id from 0 to 27]
[:loopGetOverallSkillChance]; loop is label name inside current function
!!HEx1&y1<28:Sy1/?y4;
!!VRy3:Sx1:16;                          [Town id for current hero]
!!SN&y4=0:W^AdventurerTown_%Y3_Skill_%Y1_Chance^/?y2;
!!VRx2&y4=0:+y2;
!!VRy1:+1;
!!SN&y1<28:G[loopGetOverallSkillChance];[Loop all skill IDs and sum chances for skills that hero doesn't have.]
*!IF:M^hero %X1 town %Y3^;

!?FU(DetermineSkillByChance);
Determines what skill adventurer will get with current random roll.
x1 - hero id; x2 - random number; x3 - return id of skill that corresponds to that chance.
!!VRy1:S0;                              [Skill id from 0 to 27]
*!IF:M^hero %X1 rand %X2^;
[:loopDetermineSkillByChance]; loop is label name inside current function
!!HEx1&y1<28:Sy1/?y4;
!!VRy3:Sx1:16;                          [Town id for current hero]
!!SN&y4=0:W^AdventurerTown_%Y3_Skill_%Y1_Chance^/?y2; [Only for skills that hero doesn't have]
!!VRx2&y4=0:-y2;
!!VRy1:+1;
!!SN&y1<28/x2>=0:G[loopDetermineSkillByChance]; [Loop all skill IDs, decrease random number until it's negative, which means we have found skill that corresponds to that number.]
!!VRx3&x2<0:Sy1 -1;                     [Decrease by 1 since last loop increased this skill id by 1. Only if random is negative.]
*!IF:M^hero %X1 rand %X2 skl %X3^;

!?FU(AdventurerHeroGenerateStat);
x1 - hero id, x2 - return generated stat.
!!VRy1:S0T99;
!!VRy6:Sx1:16;
!!SN:W^AdventurerTown_%Y6_Stat_0_Chance^/?y2;
!!SN:W^AdventurerTown_%Y6_Stat_1_Chance^/?y3;
!!SN:W^AdventurerTown_%Y6_Stat_2_Chance^/?y4;
!!SN:W^AdventurerTown_%Y6_Stat_3_Chance^/?y5;

!!VRy1:-y2;
!!VRx2&y1<0:S0;
!!FU&y1<0:E;

!!VRy1:-y3;
!!VRx2&y1<0:S1;
!!FU&y1<0:E;

!!VRy1:-y4;
!!VRx2&y1<0:S2;
!!FU&y1<0:E;

!!VRy1:-y5;
!!VRx2&y1<0:S3;
!!FU&y1<0:E;


!?FU(Valid_Adventurer_Hero);
x1=Hero ID, x2 returns yes(1) or no (0)
!!VRy1:S0;                              [List of all Adventurer Heroes]
!!VRy1|x1=3/x1=8/x1=15:S1;              [Sylvia, Rion, Caithlyn]
!!VRy1|x1=23/x1=27/x1=29:S1;            [Kyrre, Gem, Melodia]
!!VRy1|x1=43/x1=47:S1;                  [Daremyth, Ain]
!!VRy1|x1=48/x1=60:S1;                  [Fiona, Calid]
!!VRy1|x1=69/x1=70/x1=78/x1=79:S1;      [Isra, Clavius, Vidomina, Nagash]
!!VRy1|x1=84/x1=85/x1=91/x1=94:S1;      [Damacon, Gunnar, Jeddite, Sephinroth]
!!VRy1|x1=106/x1=109:S1;                [Dessa, Gundula]
!!VRy1|x1=122/x1=123/x1=124:S1;         [Voy, Verdish, Merist]
!!VRy1|x1=142/x1=143:S1;                [Gelare, Grindan]
!!VRx2:Sy1;                             [Returns yes or no in x2]


!?PI;
  This are instructions that set chances to get primary and secondary skills for new class of heroes - adventurers. Do not change them recklessly (you can).

Castle's Lords
!!SN:W^AdventurerTown_0_Skill_0_Chance^/2; [Pathfinding]
!!SN:W^AdventurerTown_0_Skill_1_Chance^/2; [Archery]
!!SN:W^AdventurerTown_0_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_0_Skill_3_Chance^/6; [Scouting]
!!SN:W^AdventurerTown_0_Skill_4_Chance^/10; [Diplomacy]
!!SN:W^AdventurerTown_0_Skill_5_Chance^/10; [Nobility (Navigation)]
!!SN:W^AdventurerTown_0_Skill_6_Chance^/6; [Leadership]
!!SN:W^AdventurerTown_0_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_0_Skill_8_Chance^/2; [Mysticism]
!!SN:W^AdventurerTown_0_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_0_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_0_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_0_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_0_Skill_13_Chance^/6; [Estates]
!!SN:W^AdventurerTown_0_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_0_Skill_15_Chance^/3; [Air Magic]
!!SN:W^AdventurerTown_0_Skill_16_Chance^/3; [Water Magic]
!!SN:W^AdventurerTown_0_Skill_17_Chance^/2; [Earth Magic]
!!SN:W^AdventurerTown_0_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_0_Skill_19_Chance^/4; [Tactics]
!!SN:W^AdventurerTown_0_Skill_20_Chance^/4; [Artillery]
!!SN:W^AdventurerTown_0_Skill_21_Chance^/6; [Learning]
!!SN:W^AdventurerTown_0_Skill_22_Chance^/3; [Offence]
!!SN:W^AdventurerTown_0_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_0_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_0_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_0_Skill_26_Chance^/3; [Resistance]
!!SN:W^AdventurerTown_0_Skill_27_Chance^/6; [First Aid]
!!SN:W^AdventurerTown_0_Stat_0_Chance^/30;
!!SN:W^AdventurerTown_0_Stat_1_Chance^/30;
!!SN:W^AdventurerTown_0_Stat_2_Chance^/20;
!!SN:W^AdventurerTown_0_Stat_3_Chance^/20;

Rampart's Forest Guardians
!!SN:W^AdventurerTown_1_Skill_0_Chance^/3; [Pathfinding]
!!SN:W^AdventurerTown_1_Skill_1_Chance^/5; [Archery]
!!SN:W^AdventurerTown_1_Skill_2_Chance^/9; [Logistics]
!!SN:W^AdventurerTown_1_Skill_3_Chance^/10; [Scouting]
!!SN:W^AdventurerTown_1_Skill_4_Chance^/8; [Diplomacy]
!!SN:W^AdventurerTown_1_Skill_5_Chance^/5; [Nobility (Navigation)]
!!SN:W^AdventurerTown_1_Skill_6_Chance^/2; [Leadership]
!!SN:W^AdventurerTown_1_Skill_7_Chance^/3; [Wisdom]
!!SN:W^AdventurerTown_1_Skill_8_Chance^/4; [Mysticism]
!!SN:W^AdventurerTown_1_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_1_Skill_10_Chance^/3; [Ballistics]
!!SN:W^AdventurerTown_1_Skill_11_Chance^/7; [Eagle Eye]
!!SN:W^AdventurerTown_1_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_1_Skill_13_Chance^/4; [Estates]
!!SN:W^AdventurerTown_1_Skill_14_Chance^/1; [Fire Magic]
!!SN:W^AdventurerTown_1_Skill_15_Chance^/2; [Air Magic]
!!SN:W^AdventurerTown_1_Skill_16_Chance^/3; [Water Magic]
!!SN:W^AdventurerTown_1_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_1_Skill_18_Chance^/3; [Scholar]
!!SN:W^AdventurerTown_1_Skill_19_Chance^/4; [Tactics]
!!SN:W^AdventurerTown_1_Skill_20_Chance^/1; [Artillery]
!!SN:W^AdventurerTown_1_Skill_21_Chance^/6; [Learning]
!!SN:W^AdventurerTown_1_Skill_22_Chance^/3; [Offence]
!!SN:W^AdventurerTown_1_Skill_23_Chance^/5; [Armorer]
!!SN:W^AdventurerTown_1_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_1_Skill_25_Chance^/1; [Sorcery]
!!SN:W^AdventurerTown_1_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_1_Skill_27_Chance^/8; [First Aid]
!!SN:W^AdventurerTown_1_Stat_0_Chance^/25;
!!SN:W^AdventurerTown_1_Stat_1_Chance^/35;
!!SN:W^AdventurerTown_1_Stat_2_Chance^/15;
!!SN:W^AdventurerTown_1_Stat_3_Chance^/25;

Tower's Tundra Nomads
!!SN:W^AdventurerTown_2_Skill_0_Chance^/8; [Pathfinding]
!!SN:W^AdventurerTown_2_Skill_1_Chance^/4; [Archery]
!!SN:W^AdventurerTown_2_Skill_2_Chance^/7; [Logistics]
!!SN:W^AdventurerTown_2_Skill_3_Chance^/3; [Scouting]
!!SN:W^AdventurerTown_2_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_2_Skill_5_Chance^/6; [Nobility (Navigation)]
!!SN:W^AdventurerTown_2_Skill_6_Chance^/2; [Leadership]
!!SN:W^AdventurerTown_2_Skill_7_Chance^/5; [Wisdom]
!!SN:W^AdventurerTown_2_Skill_8_Chance^/4; [Mysticism]
!!SN:W^AdventurerTown_2_Skill_9_Chance^/1; [Luck]
!!SN:W^AdventurerTown_2_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_2_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_2_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_2_Skill_13_Chance^/6; [Estates]
!!SN:W^AdventurerTown_2_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_2_Skill_15_Chance^/5; [Air Magic]
!!SN:W^AdventurerTown_2_Skill_16_Chance^/4; [Water Magic]
!!SN:W^AdventurerTown_2_Skill_17_Chance^/2; [Earth Magic]
!!SN:W^AdventurerTown_2_Skill_18_Chance^/3; [Scholar]
!!SN:W^AdventurerTown_2_Skill_19_Chance^/1; [Tactics]
!!SN:W^AdventurerTown_2_Skill_20_Chance^/1; [Artillery]
!!SN:W^AdventurerTown_2_Skill_21_Chance^/8; [Learning]
!!SN:W^AdventurerTown_2_Skill_22_Chance^/2; [Offence]
!!SN:W^AdventurerTown_2_Skill_23_Chance^/2; [Armorer]
!!SN:W^AdventurerTown_2_Skill_24_Chance^/6; [Intelligence]
!!SN:W^AdventurerTown_2_Skill_25_Chance^/5; [Sorcery]
!!SN:W^AdventurerTown_2_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_2_Skill_27_Chance^/5; [First Aid]
!!SN:W^AdventurerTown_2_Stat_0_Chance^/20;
!!SN:W^AdventurerTown_2_Stat_1_Chance^/15;
!!SN:W^AdventurerTown_2_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_2_Stat_3_Chance^/35;

Inferno's Demon Breeders
!!SN:W^AdventurerTown_3_Skill_0_Chance^/5; [Pathfinding]
!!SN:W^AdventurerTown_3_Skill_1_Chance^/2; [Archery]
!!SN:W^AdventurerTown_3_Skill_2_Chance^/8; [Logistics]
!!SN:W^AdventurerTown_3_Skill_3_Chance^/9; [Scouting]
!!SN:W^AdventurerTown_3_Skill_4_Chance^/10; [Diplomacy]
!!SN:W^AdventurerTown_3_Skill_5_Chance^/7; [Nobility (Navigation)]
!!SN:W^AdventurerTown_3_Skill_6_Chance^/5; [Leadership]
!!SN:W^AdventurerTown_3_Skill_7_Chance^/3; [Wisdom]
!!SN:W^AdventurerTown_3_Skill_8_Chance^/2; [Mysticism]
!!SN:W^AdventurerTown_3_Skill_9_Chance^/1; [Luck]
!!SN:W^AdventurerTown_3_Skill_10_Chance^/6; [Ballistics]
!!SN:W^AdventurerTown_3_Skill_11_Chance^/4; [Eagle Eye]
!!SN:W^AdventurerTown_3_Skill_12_Chance^/2; [Necromancy]
!!SN:W^AdventurerTown_3_Skill_13_Chance^/5; [Estates]
!!SN:W^AdventurerTown_3_Skill_14_Chance^/4; [Fire Magic]
!!SN:W^AdventurerTown_3_Skill_15_Chance^/1; [Air Magic]
!!SN:W^AdventurerTown_3_Skill_16_Chance^/1; [Water Magic]
!!SN:W^AdventurerTown_3_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_3_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_3_Skill_19_Chance^/5; [Tactics]
!!SN:W^AdventurerTown_3_Skill_20_Chance^/4; [Artillery]
!!SN:W^AdventurerTown_3_Skill_21_Chance^/5; [Learning]
!!SN:W^AdventurerTown_3_Skill_22_Chance^/6; [Offence]
!!SN:W^AdventurerTown_3_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_3_Skill_24_Chance^/1; [Intelligence]
!!SN:W^AdventurerTown_3_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_3_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_3_Skill_27_Chance^/2; [First Aid]
!!SN:W^AdventurerTown_3_Stat_0_Chance^/30;
!!SN:W^AdventurerTown_3_Stat_1_Chance^/20;
!!SN:W^AdventurerTown_3_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_3_Stat_3_Chance^/20;

Necropolis's Shadow Stalkers
!!SN:W^AdventurerTown_4_Skill_0_Chance^/3; [Pathfinding]
!!SN:W^AdventurerTown_4_Skill_1_Chance^/4; [Archery]
!!SN:W^AdventurerTown_4_Skill_2_Chance^/10; [Logistics]
!!SN:W^AdventurerTown_4_Skill_3_Chance^/7; [Scouting]
!!SN:W^AdventurerTown_4_Skill_4_Chance^/7; [Diplomacy]
!!SN:W^AdventurerTown_4_Skill_5_Chance^/5; [Nobility (Navigation)]
!!SN:W^AdventurerTown_4_Skill_6_Chance^/0; [Leadership]
!!SN:W^AdventurerTown_4_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_4_Skill_8_Chance^/4; [Mysticism]
!!SN:W^AdventurerTown_4_Skill_9_Chance^/6; [Luck]
!!SN:W^AdventurerTown_4_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_4_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_4_Skill_12_Chance^/8; [Necromancy]
!!SN:W^AdventurerTown_4_Skill_13_Chance^/3; [Estates]
!!SN:W^AdventurerTown_4_Skill_14_Chance^/1; [Fire Magic]
!!SN:W^AdventurerTown_4_Skill_15_Chance^/2; [Air Magic]
!!SN:W^AdventurerTown_4_Skill_16_Chance^/1; [Water Magic]
!!SN:W^AdventurerTown_4_Skill_17_Chance^/5; [Earth Magic]
!!SN:W^AdventurerTown_4_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_4_Skill_19_Chance^/2; [Tactics]
!!SN:W^AdventurerTown_4_Skill_20_Chance^/2; [Artillery]
!!SN:W^AdventurerTown_4_Skill_21_Chance^/4; [Learning]
!!SN:W^AdventurerTown_4_Skill_22_Chance^/10; [Offence]
!!SN:W^AdventurerTown_4_Skill_23_Chance^/0; [Armorer]
!!SN:W^AdventurerTown_4_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_4_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_4_Skill_26_Chance^/1; [Resistance]
!!SN:W^AdventurerTown_4_Skill_27_Chance^/8; [First Aid]
!!SN:W^AdventurerTown_4_Stat_0_Chance^/50;
!!SN:W^AdventurerTown_4_Stat_1_Chance^/5;
!!SN:W^AdventurerTown_4_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_4_Stat_3_Chance^/15;

Dungeon's Dragon's Treasurers
!!SN:W^AdventurerTown_5_Skill_0_Chance^/4; [Pathfinding]
!!SN:W^AdventurerTown_5_Skill_1_Chance^/1; [Archery]
!!SN:W^AdventurerTown_5_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_5_Skill_3_Chance^/9; [Scouting]
!!SN:W^AdventurerTown_5_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_5_Skill_5_Chance^/6; [Nobility (Navigation)]
!!SN:W^AdventurerTown_5_Skill_6_Chance^/5; [Leadership]
!!SN:W^AdventurerTown_5_Skill_7_Chance^/5; [Wisdom]
!!SN:W^AdventurerTown_5_Skill_8_Chance^/2; [Mysticism]
!!SN:W^AdventurerTown_5_Skill_9_Chance^/2; [Luck]
!!SN:W^AdventurerTown_5_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_5_Skill_11_Chance^/6; [Eagle Eye]
!!SN:W^AdventurerTown_5_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_5_Skill_13_Chance^/10; [Estates]
!!SN:W^AdventurerTown_5_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_5_Skill_15_Chance^/4; [Air Magic]
!!SN:W^AdventurerTown_5_Skill_16_Chance^/2; [Water Magic]
!!SN:W^AdventurerTown_5_Skill_17_Chance^/4; [Earth Magic]
!!SN:W^AdventurerTown_5_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_5_Skill_19_Chance^/6; [Tactics]
!!SN:W^AdventurerTown_5_Skill_20_Chance^/4; [Artillery]
!!SN:W^AdventurerTown_5_Skill_21_Chance^/4; [Learning]
!!SN:W^AdventurerTown_5_Skill_22_Chance^/4; [Offence]
!!SN:W^AdventurerTown_5_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_5_Skill_24_Chance^/1; [Intelligence]
!!SN:W^AdventurerTown_5_Skill_25_Chance^/4; [Sorcery]
!!SN:W^AdventurerTown_5_Skill_26_Chance^/3; [Resistance]
!!SN:W^AdventurerTown_5_Skill_27_Chance^/3; [First Aid]
!!SN:W^AdventurerTown_5_Stat_0_Chance^/30;
!!SN:W^AdventurerTown_5_Stat_1_Chance^/30;
!!SN:W^AdventurerTown_5_Stat_2_Chance^/30;
!!SN:W^AdventurerTown_5_Stat_3_Chance^/10;

Stronghold's Wastelands Hunters
!!SN:W^AdventurerTown_6_Skill_0_Chance^/5; [Pathfinding]
!!SN:W^AdventurerTown_6_Skill_1_Chance^/5; [Archery]
!!SN:W^AdventurerTown_6_Skill_2_Chance^/10; [Logistics]
!!SN:W^AdventurerTown_6_Skill_3_Chance^/8; [Scouting]
!!SN:W^AdventurerTown_6_Skill_4_Chance^/3; [Diplomacy]
!!SN:W^AdventurerTown_6_Skill_5_Chance^/8; [Nobility (Navigation)]
!!SN:W^AdventurerTown_6_Skill_6_Chance^/5; [Leadership]
!!SN:W^AdventurerTown_6_Skill_7_Chance^/2; [Wisdom]
!!SN:W^AdventurerTown_6_Skill_8_Chance^/1; [Mysticism]
!!SN:W^AdventurerTown_6_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_6_Skill_10_Chance^/4; [Ballistics]
!!SN:W^AdventurerTown_6_Skill_11_Chance^/4; [Eagle Eye]
!!SN:W^AdventurerTown_6_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_6_Skill_13_Chance^/8; [Estates]
!!SN:W^AdventurerTown_6_Skill_14_Chance^/3; [Fire Magic]
!!SN:W^AdventurerTown_6_Skill_15_Chance^/3; [Air Magic]
!!SN:W^AdventurerTown_6_Skill_16_Chance^/1; [Water Magic]
!!SN:W^AdventurerTown_6_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_6_Skill_18_Chance^/1; [Scholar]
!!SN:W^AdventurerTown_6_Skill_19_Chance^/3; [Tactics]
!!SN:W^AdventurerTown_6_Skill_20_Chance^/6; [Artillery]
!!SN:W^AdventurerTown_6_Skill_21_Chance^/4; [Learning]
!!SN:W^AdventurerTown_6_Skill_22_Chance^/5; [Offence]
!!SN:W^AdventurerTown_6_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_6_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_6_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_6_Skill_26_Chance^/5; [Resistance]
!!SN:W^AdventurerTown_6_Skill_27_Chance^/4; [First Aid]
!!SN:W^AdventurerTown_6_Stat_0_Chance^/45;
!!SN:W^AdventurerTown_6_Stat_1_Chance^/25;
!!SN:W^AdventurerTown_6_Stat_2_Chance^/15;
!!SN:W^AdventurerTown_6_Stat_3_Chance^/15;

Fortress's Swamps Foragers
!!SN:W^AdventurerTown_7_Skill_0_Chance^/10; [Pathfinding]
!!SN:W^AdventurerTown_7_Skill_1_Chance^/1; [Archery]
!!SN:W^AdventurerTown_7_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_7_Skill_3_Chance^/7; [Scouting]
!!SN:W^AdventurerTown_7_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_7_Skill_5_Chance^/5; [Nobility (Navigation)]
!!SN:W^AdventurerTown_7_Skill_6_Chance^/3; [Leadership]
!!SN:W^AdventurerTown_7_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_7_Skill_8_Chance^/3; [Mysticism]
!!SN:W^AdventurerTown_7_Skill_9_Chance^/3; [Luck]
!!SN:W^AdventurerTown_7_Skill_10_Chance^/1; [Ballistics]
!!SN:W^AdventurerTown_7_Skill_11_Chance^/9; [Eagle Eye]
!!SN:W^AdventurerTown_7_Skill_12_Chance^/0; [Necromancy]
!!SN:W^AdventurerTown_7_Skill_13_Chance^/5; [Estates]
!!SN:W^AdventurerTown_7_Skill_14_Chance^/2; [Fire Magic]
!!SN:W^AdventurerTown_7_Skill_15_Chance^/2; [Air Magic]
!!SN:W^AdventurerTown_7_Skill_16_Chance^/5; [Water Magic]
!!SN:W^AdventurerTown_7_Skill_17_Chance^/3; [Earth Magic]
!!SN:W^AdventurerTown_7_Skill_18_Chance^/4; [Scholar]
!!SN:W^AdventurerTown_7_Skill_19_Chance^/2; [Tactics]
!!SN:W^AdventurerTown_7_Skill_20_Chance^/1; [Artillery]
!!SN:W^AdventurerTown_7_Skill_21_Chance^/6; [Learning]
!!SN:W^AdventurerTown_7_Skill_22_Chance^/4; [Offence]
!!SN:W^AdventurerTown_7_Skill_23_Chance^/5; [Armorer]
!!SN:W^AdventurerTown_7_Skill_24_Chance^/2; [Intelligence]
!!SN:W^AdventurerTown_7_Skill_25_Chance^/2; [Sorcery]
!!SN:W^AdventurerTown_7_Skill_26_Chance^/3; [Resistance]
!!SN:W^AdventurerTown_7_Skill_27_Chance^/8; [First Aid]
!!SN:W^AdventurerTown_7_Stat_0_Chance^/20;
!!SN:W^AdventurerTown_7_Stat_1_Chance^/35;
!!SN:W^AdventurerTown_7_Stat_2_Chance^/20;
!!SN:W^AdventurerTown_7_Stat_3_Chance^/25;

Conflux's Balancers
!!SN:W^AdventurerTown_8_Skill_0_Chance^/3; [Pathfinding]
!!SN:W^AdventurerTown_8_Skill_1_Chance^/3; [Archery]
!!SN:W^AdventurerTown_8_Skill_2_Chance^/6; [Logistics]
!!SN:W^AdventurerTown_8_Skill_3_Chance^/5; [Scouting]
!!SN:W^AdventurerTown_8_Skill_4_Chance^/6; [Diplomacy]
!!SN:W^AdventurerTown_8_Skill_5_Chance^/6; [Nobility (Navigation)]
!!SN:W^AdventurerTown_8_Skill_6_Chance^/2; [Leadership]
!!SN:W^AdventurerTown_8_Skill_7_Chance^/4; [Wisdom]
!!SN:W^AdventurerTown_8_Skill_8_Chance^/3; [Mysticism]
!!SN:W^AdventurerTown_8_Skill_9_Chance^/1; [Luck]
!!SN:W^AdventurerTown_8_Skill_10_Chance^/3; [Ballistics]
!!SN:W^AdventurerTown_8_Skill_11_Chance^/5; [Eagle Eye]
!!SN:W^AdventurerTown_8_Skill_12_Chance^/3; [Necromancy]
!!SN:W^AdventurerTown_8_Skill_13_Chance^/6; [Estates]
!!SN:W^AdventurerTown_8_Skill_14_Chance^/4; [Fire Magic]
!!SN:W^AdventurerTown_8_Skill_15_Chance^/4; [Air Magic]
!!SN:W^AdventurerTown_8_Skill_16_Chance^/4; [Water Magic]
!!SN:W^AdventurerTown_8_Skill_17_Chance^/4; [Earth Magic]
!!SN:W^AdventurerTown_8_Skill_18_Chance^/3; [Scholar]
!!SN:W^AdventurerTown_8_Skill_19_Chance^/1; [Tactics]
!!SN:W^AdventurerTown_8_Skill_20_Chance^/3; [Artillery]
!!SN:W^AdventurerTown_8_Skill_21_Chance^/9; [Learning]
!!SN:W^AdventurerTown_8_Skill_22_Chance^/4; [Offence]
!!SN:W^AdventurerTown_8_Skill_23_Chance^/4; [Armorer]
!!SN:W^AdventurerTown_8_Skill_24_Chance^/3; [Intelligence]
!!SN:W^AdventurerTown_8_Skill_25_Chance^/4; [Sorcery]
!!SN:W^AdventurerTown_8_Skill_26_Chance^/4; [Resistance]
!!SN:W^AdventurerTown_8_Skill_27_Chance^/5; [First Aid]
!!SN:W^AdventurerTown_8_Stat_0_Chance^/25;
!!SN:W^AdventurerTown_8_Stat_1_Chance^/25;
!!SN:W^AdventurerTown_8_Stat_2_Chance^/25;
!!SN:W^AdventurerTown_8_Stat_3_Chance^/25;



*?FU870520; !IF:M^for the replayable battle 870520^; [before each replayable battle]
*?FU870530; !IF:M^ after the replayed battle 870530^; [after each replayed battle]

*Fix Battle Plugin by igrik fix
Here all variables should be reset before a repeated fight
!?FU870520;
*?FU(OnBattleReplay);

*!BU:R;  Disabeld because it can lead to crash thx @xericsin
!!SN:W^This_Is_Replay_Battle^/1;
!!SN:W^Leadership_Current_battle_round^/-1;
!!SN:W^Leadership_Stack_had_Moral^/-1;
!!SN:W^Pathfinding_Speed_Bonus1^/0;     [Reset]
!!SN:W^Pathfinding_Speed_Bonus2^/0;     [Reset]
!!SN:W^Logistics_Speed_Bonus1^/0;       [Reset]
!!SN:W^Logistics_Speed_Bonus2^/0;       [Reset]
!!SN:W^Improved_Tent^/-1;
!!SN:W^Double_Cast_Attacker^/0;
!!SN:W^Double_Cast_Defender^/0;
!!SN:W^Master_Mage_Extra_Cast_att^/0;
!!SN:W^Master_Mage_Extra_Cast_def^/0;
!!SN:W^Brute_Gold^/0;
!!SN:W^Paladin_Experience^/0;
!!SN:W^Event_Counter^/0;
!!SN:W^Temple_Guarding_Casts^/0;
!!IF:V761/1;
!!SN:W^Creature Bank visit^/0;
!!SN:W^landmine_var^/0;                 [landmine variable]
!!SN:W^Bers_en^/0;                      [Reset vars before combat]
!!SN:W^Animate_Dead^/0;
!!SN:W^Stack_Number^/-1;
!!SN:W^Improved_Cure^/0;
!!SN:W^Incinerate^/0;                   [Reset Incinerate Damage]

!!re y1/0/41;
  !!SN:W^Ballista_Crippling_Target_%Y1^/0;[ReSet flag that creature has been targetet with ballista]
  !!SN:W^DisruptingRayCastsStack%Y1^/0;
  !!SN:W^DisRayStoneSkinRemoved%Y1^/0;
  !!SN:W^StoneSkinHitsStack%Y1^/0;
  !!SN:W^Burned_Stack_%Y1^/0;             [Reset afterwards]
  !!SN:W^Bless_Strike_Creature%Y1^/0;
  !!SN:W^Precision_Strike_Creature%Y1^/0;
!!en;

!!IF:V936/0;
!!SN:W^Week_Slow_Cast0^/0;              [So only works once per combat]
!!SN:W^Week_Slow_Cast1^/0;
!!SN:W^Week_Haste_Cast0^/0;             [So only works once per combat]
!!SN:W^Week_Haste_Cast1^/0;             [Quick Combat Flag]
!!SN:W^Mage_Spell_Enhancement_0^/0;     [Reset for Attacker]
!!SN:W^Mage_Spell_Enhancement_1^/0;     [Reset for Defender]
!!SN:W^Battlemage_Precast_0^/0;
!!SN:W^Battlemage_Precast_1^/0;
!!SN:W^Hunter_Speed_Bonus1^/0;          [Reset]
!!SN:W^Hunter_Speed_Bonus2^/0;          [Reset]
!!SN:W^Elemental_Set_att^/0;
!!SN:W^Elemental_Set_def^/0;
!!SN:W^Luck_Count_Att^/0;               [Luck Count Attacker reset]
!!SN:W^Luck_Count_Def^/0;               [Luck Count Defender reset]
!!SN:W^Speed_MonsterNumber^/-1;
!!SN:W^Attacker_Eagle_Eye_Spells^/0;    [Reset Spell Count]
!!SN:W^Defender_Eagle_Eye_Spells^/0;
!!VRv9287:S0; !!VRv9288:S0; !!VRv9276:S0; !!VRv9277:S0;
!!VRv9278:S0; !!VRv9279:S0; !!VRv9280:S0; !!VRv9281:S0;
!!VRv9282:S0; !!VRv9283:S0;
!!SN:W^shield_var1^/0; !!SN:W^shield_var2^/0; [shield variable]
!!SN:W^sacrifice_var^/0;                [Reset vars after combat]
!!SN:W^Sorrow_Cast0^/0; !!SN:W^Sorrow_Cast1^/0;
!!SN:W^Force_Field_Cast^/0;             [Set Flag to false after battle Force Field]
!!SN:W^Mirth_Cast0^/0; !!SN:W^Mirth_Cast1^/0;
!!SN:W^Slayer_Cast0^/0; !!SN:W^Slayer_Cast1^/0;
!!SN:W^Mirth_Current_battle_round^/-1;
!!SN:W^Mirth_Stack_had_Moral^/-1;
!!SN:W^Bloodlust_Cast0^/0; !!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Fortune_Cast0^/0; !!SN:W^Fortune_Cast1^/0;
!!SN:W^Prayer_Cast0^/0; !!SN:W^Prayer_Cast1^/0;
!!SN:W^Curse_Cast0^/0; !!SN:W^Curse_Cast1^/0;
!!SN:W^Weakness_Cast0^/0; !!SN:W^Weakness_Cast1^/0;
!!SN:W^Shield_Cast0^/0;   !!SN:W^Shield_Cast1^/0;
!!SN:W^Fire_Shield_Cast0^/0; !!SN:W^Fire_Shield_Cast1^/0;
!!SN:W^Slow_Cast0^/0; !!SN:W^Slow_Cast1^/0;
!!SN:W^Haste_Cast0^/0; !!SN:W^Haste_Cast1^/0;
!!SN:W^Bless_Cast0^/0; !!SN:W^Bless_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0; !!SN:W^Stoneskin_Cast1^/0;
!!SN:W^Counterstrike_Cast0^/0; !!SN:W^Counterstrike_Cast1^/0;
!!SN:W^Heal_Cast0^/0; !!SN:W^Heal_Cast1^/0;
!!SN:W^Improved_Cure^/0;
!!SN:W^Magic_Mirror_Cast0^/0; !!SN:W^Magic_Mirror_Cast1^/0;
!!SN:W^Air_Shield_Cast0^/0; !!SN:W^Air_Shield_Cast1^/0;
!!SN:W^Animate_Cast0^/0; !!SN:W^Animate_Cast1^/0;
!!SN:W^Improved_Magic_Arrow_Counter^/0;
!!SN:W^Fire_Protection_Cast_0^/0;
!!SN:W^Fire_Protection_Cast_1^/0;
!!SN:W^Water_Protection_Cast_0^/0;
!!SN:W^Water_Protection_Cast_1^/0;
!!SN:W^Earth_Protection_Cast_0^/0;
!!SN:W^Earth_Protection_Cast_1^/0;
!!SN:W^Air_Protection_Cast_0^/0;
!!SN:W^Air_Protection_Cast_1^/0;
!!SN:W^H3_Summon_Fire_0^/0;
!!SN:W^H3_Summon_Fire_1^/0;
!!SN:W^H3_Summon_Earth_0^/0;
!!SN:W^H3_Summon_Earth_1^/0;
!!SN:W^H3_Summon_Water_0^/0;
!!SN:W^H3_Summon_Water_1^/0;
!!SN:W^H3_Summon_Air_0^/0;
!!SN:W^H3_Summon_Air_1^/0;
!!DO(AC_Function_125)/0/41/1&1000:P10;       [Reset Position for Teleport]

!!SN:W^Magic_Week_Number^/?y99;
!!SN&y99=34:W^Magic_Week_34_att^/1;     [Extra Cast Variable Attacker Set 1]
!!SN&y99=34:W^Magic_Week_34_def^/1;     [Extra Cast Variable Defender Set 1]
!!SN&y99=41:W^Magic_Week_41_att^/2;     [Extra Cast Variable Attacker Set 2]
!!SN&y99=41:W^Magic_Week_41_def^/2;     [Extra Cast Variable Defender Set 2]

!!SN:W^Magic_Week_Spell_Element^/0;     [Extra Cast Variable Element Week Reset]
!!SN:W^Stoneskin_Cast00^/0;             [For whole Battle]
!!SN:W^Stoneskin_Cast11^/0;
!!SN:W^Message_Flag^/0;                 [Set Flag if Human Player]
!!SN:W^Summoned_Elemental_Perk^/0;

!!SN:W^Magic_Specialists_Att^/0;        [Reset extra Cast at Battle End]
!!SN:W^Magic_Specialists_Def^/0;
!!SN:W^Sorcery_Specialists_Cast_Counter^/0;
!!SN:W^Elemental_Specialists_Cast_Counter^/0;
!!SN:W^Magic_Specialists_Def_Spells_Saved^/0;
!!SN:W^Magic_Specialists_Att_Spells_Saved^/0;
!!DO(AC_Function_78)/0/25/1:P;          [Reset Cast Counter at Battle End]
!!SN:W^Summoned_Water_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/0;        [For Defender Side 1]

!!SN:W^WM_Maintain_Att_Bal^/0;  !!SN:W^WM_Maintain_Def_Bal^/0;
!!SN:W^WM_Maintain_Att_Ammo^/0; !!SN:W^WM_Maintain_Def_Ammo^/0;
!!SN:W^WM_Maintain_Att_Tent^/0; !!SN:W^WM_Maintain_Def_Tent^/0;
!!SN:W^Att_HP_Army_Value^/0;            [Reset Fight Value]


!?FU(OnBeforeBattleUniversal);
!!SN:W^This_Is_Replay_Battle^/0;
!!SN:W^Summoned_Water_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/0;        [For Defender Side 1]


********************************************************************************
** Critical Sorcery v.2.1, a mod by PerryR **
**V-Vars used:
**Z-Vars used:
**Function used:
**Flags used:

!#SN:W^Critical_Sorcery_Mod^/1;         [Critical Sorcery Mod Active]
!#TM51:S1/999/7/255;

*-------------------------------------------------------------------------------
!?MR1&1000;                             [Magic Res Trigger for Crit]

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:Q?y4;
!!BA:Hy4/?y4;
!!FU&y4<=0:E;                           [Exit if no Hero]

!!BG:Q?y30;
!!VRy30:-1 *-1;
!!BA:Hy30/?y31;                         [Enemy Hero for resistance Calculation]

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere 1 in y2]
!!FU&y2<=9|y2>69:E;

!!MR:F?y3;                              [Speichere DMG in y3]
!!FU&y3<=0:E;

!!MR:N?y5;                              [return Creature number which took magic damage]

!!BG:Q?y13;
!!BMy5:I?y12;

!!if&y13<>y12;
  !!if&y5>=0/y5<=41;

  !!FU(H3_Calc_Crit_Chance_and_Damage):Py4/?y16/?y99/1/y31/y2/y5; [(Pass Hero Number/Returns Crit chance/Crit damage/Battle State/Enemy Hero/Spell/Target)]

  !!VRy9:S0T99;                           [y9 chance to crit (0..99)]

  !!if&y9<y16;
    !!if|y2=24/y2=25/y2=26;                [Death Ripple, Destroy Undead and Armageddon get -25% crit damage]
      !!VRy99:-25;
    !!en;

    !!VRy3:*y99:100;
    *!IF:M^Returened Crit Chance %Y16 and Damage %Y99  and Random Roll %Y9 and Spell Damage y3 is %Y3^;
    !!MR:Fy3;                               [apply new damage]
    !!BA:Q?f;
    !!BMy5&f=0:V82;                         [show crit animation]
  !!en;
!!en;
!!en;

********************************************************************************
!?FU(H3_Calc_Normal_Spell_Damage);
x1=Hero Number, x2=Returns Damage, x3=Returns extra damage, x4=Battle or No Battle State, x5=Spell Number, x6=1 show only in Bonus Table
Pass Hero Number and Give Back Damage in y99 and Extra Damage Option and Spell Number

!!VRy99:S100;
!!HEx1:A2/124/?y10/?y11;
!!VRy99&y11=1:+15;                      [Wenn das Spellbinder's Hat getragen wird plus +15% Damage]

!!HEx1:A2/128/?y10/?y16;
!!VRy99&y16=1:+15;                      [Wenn das Armageddon's Blade getragen wird plus +15% Damage]

!!HEx1:A2/106/?y10/?y12;
!!VRy99&y12=1/x5=17:+25;                [Wenn das Pendant of Negativity getragen wird plus +25% Damage auf Lightning Strike und 20% Damage auf Chain Lightning]
!!VRy99&y12=1/x5=19:+20;

!!HEx1:A2/127/?y10/?y13;
!!VRy99&y13=1/x5=21:+35;                [Wenn das Vial of Dragon Blood getragen wird plus +35% Damage auf Fireball und 25% Damage auf Inferno]
!!VRy99&y13=1/x5=22:+25;

!!HEx1:A2/22/?y10/?y14;
!!VRy99&y14=1/x5=16:+30;                [Wenn das Crown of the Supreme Magi getragen wird plus +30% Damage auf Ice Bolt und 30% Damage auf Frost Ring]
!!VRy99&y14=1/x5=20:+30;

!!HEx1:A2/28/?y10/?y15;
!!VRy99&y15=1/x5=23:+30;                [Wenn das Tunic of the Cyclops King getragen wird plus +30% Damage auf Meteor Shower und 20% Damage auf Implosion]
!!VRy99&y15=1/x5=18:+20;

!!HEx1:A2/20/?y10/?y16;
!!VRy99&y16=1/x5=15:+25;                [Wenn der Skull Helmet getragen wird plus +25% Damage auf Magic Arrow]

!!HEx1:A2/26/?y10/?y17;
!!VRy99&y17=1/x5=15:+25;                [Wenn der Rib Cage getragen wird plus +25% Damage auf Magic Arrow]

!!FU(Count_Set_Pieces):Px1/?y90/?y91/?y92/?y93/?y94/?y95/?y96/0/0/0/0/?y33/?y34; [Count Set Pieces function]
!!VRy99&y90=6:+10;                      [If hero wears all 6 Dragon Set pieces + 10% Spell Damage]

!!VRy99&y33>=4/x5=21:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Fireball]
!!VRy99&y33>=4/x5=22:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Inferno]
!!VRy99&y33>=4/x5=26:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Armageddon]
!!VRy99&y33>=4/x5=13:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Firewall]
!!VRy99&y33>=4/x5=11:+20;               [If hero wears all 5 Archdevil Suite Set pieces + 20% Fire Spell Damage Landmine]

!!FU(Count_Set_Pieces_2):Px1/?y47;      [Count Set Pieces function]
!!VRy99&y47>=4/x5=23:+20;               [If hero wears all 4 Battle Mage War Dress Set pieces + 20% Earth Spell Damage Meteor Shower]
!!VRy99&y47>=4/x5=24:+20;               [If hero wears all 4 Battle Mage War Dress Set pieces + 20% Earth Spell Damage Death Ripple]
!!VRy99&y47>=4/x5=18:+20;               [If hero wears all 4 Battle Mage War Dress Set pieces + 20% Earth Spell Damage Implosion]

!!VRy99&y95=6:+20;                      [If hero wears all 6 Priest of the Light Set pieces + 20% Spell Damage]
!!VRy99&y95=6/x5=25:+50;                [If hero wears all 6 Priest of the Light Set pieces + 50% Spell Damage to Destroy Undead]

!!VRy99&y96=6:+20;                      [If hero wears all 6 Priest of the Dark Set pieces + 20% Spell Damage]
!!VRy99&y96=6/x5=24:+50;                [If hero wears all 6 Priest of the Dark Set pieces + 50% Spell Damage to Death Ripple]

!!VRy99&y34=6:+10;                      [If hero wears all 6 Angelic Alliance Set pieces + 10% Spell Damage]

!!VRy98:S0T99;
!!VRy99&y91=3/y98<25:+25;               [If hero wears 3/4 Elemental Unity pieces + 25%/+50% chance for extra Spell Damage]
!!VRy99&y91=4/y98<50:+25;

!!if&y94=4/x4=1;                       [The Adventures Fidelity Set is full]
  !!BG:Q?y2;
  !!SN&y2=0:W^Luck_Count_Att^/?y1;      [Luck Count Attacker +1]
  !!SN&y2=1:W^Luck_Count_Def^/?y1;      [Luck Count Attacker +1]
  !!VRy99:+y1;                          [+10% damage per Luck per battle]
!!en;

!!HEx1:A2/76/?y10/?y20;                 [Check for Collar of Conjuring]
!!VRy99&y20=1:+4;
!!HEx1:A2/77/?y10/?y21;                 [Check for Ring of Conjuring]
!!VRy99&y21=1:+6;
!!HEx1:A2/78/?y10/?y22;                 [Check for Cape of Conjuring]
!!VRy99&y22=1:+10;
!!HEx1:A2/139/?y10/?y18;                [Check for Cape of Conjuring]
!!VRy99&y18=1:+25;                      [+25% Spell damage for each 3 fights won]

!!SN&y18=1:W^Magi_Set_Count_Hero%X1^/?y19;
!!VRy19&y18=1::3;                       [1% Spell damage for each 3 fights won]
!!VRy99&y18=1:+y19;                     [+1% Spell Damage if Battle won with Ring equipped]

!!SN:W^Grandmaster_Mage_Hero%X1^/?y30;  [Gm Mage Channeling ability If Spell Points are abouve maximum increase damage by +15%]
!!if&y30=1;
  !!FU(Intelligence_Set_Spell_Points):Px1/0/?y31/1; [Return Number of Max Possible Spell Points in y31 for the Hero and only check not set]
  !!HEx1:I?y32/1;                       [Get Current Heroes Spell Points]
  !!VRy99&y32>=y31:+15;                 [Increase Spell damage by +15% condition is true]
!!en;

!!if&x6=0; Only Add when not clicking in Hero Screen
  !!HEx1:X?y23/?y24/?y25/?y25/?y25/?y25/?y25; [Check Hero Speciality for Elemental Specialists]
  !!FU(MSR_Determine_Spell_Type):Px5/0/0/?y22; [y22 Holds Spell School]  [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water]
  !!if&y23=0;
    !!VRy99&y24=14/y22=4:+15;             [Set Fire Spells to +15% Damage]
    !!VRy99&y24=15/y22=1:+15;             [Set Air Spells to +15% Damage]
    !!VRy99&y24=16/y22=8:+15;             [Set Water Spells to +15% Damage]
    !!VRy99&y24=17/y22=2:+15;             [Set Fire Spells to +15% Damage]
  !!en;


    !!SN:W^H3_Fire Magic_0_Hero%X1^/?y10;   [Fire Magic Bonus handling]
    !!SN:W^H3_Fire Magic_1_Hero%X1^/?y11;
    !!HEx1:S14/?y3;
    !!VRy99&y22=4/y3=3/y10=1/y11=0:+10;     [+10% Damage]
    !!VRy99&y22=4/y3=3/y10=1/y11=1:+25;     [+25% Damage]

    !!SN:W^H3_Air Magic_0_Hero%X1^/?y10;    [Air Magic Bonus handling]
    !!SN:W^H3_Air Magic_1_Hero%X1^/?y11;
    !!HEx1:S15/?y3;
    !!VRy99&y22=1/y3=3/y10=1/y11=0:+10;     [+10% Damage]
    !!VRy99&y22=1/y3=3/y10=1/y11=1:+25;     [+25% Damage]

    !!SN:W^H3_Water Magic_0_Hero%X1^/?y10;  [Water Magic Bonus handling]
    !!SN:W^H3_Water Magic_1_Hero%X1^/?y11;
    !!HEx1:S16/?y3;
    !!VRy99&y22=8/y3=3/y10=1/y11=0:+10;     [+10% Damage]
    !!VRy99&y22=8/y3=3/y10=1/y11=1:+25;     [+25% Damage]

    !!SN:W^H3_Earth Magic_0_Hero%X1^/?y10;  [Earth Magic Bonus handling]
    !!SN:W^H3_Earth Magic_1_Hero%X1^/?y11;
    !!HEx1:S17/?y3;
    !!VRy99&y22=2/y3=3/y10=1/y11=0:+10;     [+10% Damage]
    !!VRy99&y22=2/y3=3/y10=1/y11=1:+25;     [+25% Damage]
!!en;
******
Spell Trainer Damage Spells

!!SN:W^Spell_Trainer_Mod^/?y1; Check for Spell Trainer option
!!if&y1=1;
  !!SN:W^Damage_Spells_Increment^/?y2;
  !!SN:W^SpellTrainerHero%X1_Spell%X5^/?y10;
  !!VRy10:*y2;                          [Damage Spells Upgrades times Increment]
  !!VRy99:+y10;                         [Set increased damage]
  *!IF:M^Now Total %Y99 and y10 is %Y10 and spell is %X5^;
!!en;
******

!!VRx2:Sy99;                            [Return Damage increase in x2]
!!VRx3&y91>=3:S1;                       [Set Bonus Damage]


********************************************************************************
!?FU(H3_Calc_Crit_Chance_and_Damage);

!!VRy16:S0;                             [Initialize Crit Chance Y16 to Zero]
!!VRy99:S125;                           [Initialize Crit Damage Y99 to 125]

!!HEx1:S7/?y6;                          [Checke ob der Held Weisheit hat und Speichere in y20]
!!SN:W^H3_Wisdom_0_Hero%X1^/?y20;       [Checke ob der Held Master Leadership hat und Speichere in y21]
!!SN:W^H3_Wisdom_1_Hero%X1^/?y21;
!!VRy16&y6=3/y20=1/y21=0:+5; !!VRy16&y6=3/y20=1/y21=1:+10; [Wisdom Crit Chance]
!!VRy99&y6=3/y20=1/y21=0:+10; !!VRy99&y6=3/y20=1/y21=1:+20; [Wisdom Crit Damage]

!!HEx1:S8/?y6;                          [Checke ob der Held Mystik hat und Speichere in y20]
!!SN:W^H3_Mysticism_0_Hero%X1^/?y20;    [Checke ob der Held Master Mystik hat und Speichere in y21]
!!SN:W^H3_Mysticism_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+3; !!VRy16&y6=2/y20=0/y21=0:+4; !!VRy16&y6=3/y20=0/y21=0:+5; !!VRy16&y6=3/y20=1/y21=0:+7; !!VRy16&y6=3/y20=1/y21=1:+10; [Mysticism Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+6; !!VRy99&y6=2/y20=0/y21=0:+8; !!VRy99&y6=3/y20=0/y21=0:+10; !!VRy99&y6=3/y20=1/y21=0:+15; !!VRy99&y6=3/y20=1/y21=1:+20; [Mysticism Crit Damage]

!!HEx1:S18/?y6;                         [Checke ob der Held Scholar hat und Speichere in y20]
!!SN:W^H3_Scholar_0_Hero%X1^/?y20;      [Checke ob der Held Master Scholar hat und Speichere in y21]
!!SN:W^H3_Scholar_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+6; !!VRy16&y6=2/y20=0/y21=0:+8; !!VRy16&y6=3/y20=0/y21=0:+10; !!VRy16&y6=3/y20=1/y21=0:+15; !!VRy16&y6=3/y20=1/y21=1:+20; [Scholar Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+5; !!VRy99&y6=2/y20=0/y21=0:+10; !!VRy99&y6=3/y20=0/y21=0:+15; !!VRy99&y6=3/y20=1/y21=0:+20; !!VRy99&y6=3/y20=1/y21=1:+25; [Scholar Crit Damage]

!!HEx1:S24/?y6;                         [Checke ob der Held Intelligence hat und Speichere in y20]
!!SN:W^H3_Intelligence_0_Hero%X1^/?y20; [Checke ob der Held Master Intelligence hat und Speichere in y21]
!!SN:W^H3_Intelligence_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+1; !!VRy16&y6=2/y20=0/y21=0:+2; !!VRy16&y6=3/y20=0/y21=0:+3; !!VRy16&y6=3/y20=1/y21=0:+4; !!VRy16&y6=3/y20=1/y21=1:+5; [Intelligence Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+6; !!VRy99&y6=2/y20=0/y21=0:+8; !!VRy99&y6=3/y20=0/y21=0:+10; !!VRy99&y6=3/y20=1/y21=0:+15; !!VRy99&y6=3/y20=1/y21=1:+20; [Intelligence Crit Damage]

!!HEx1:S25/?y6;                         [Checke ob der Held Sorcery hat und Speichere in y20]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y20;      [Checke ob der Held Master Sorcery hat und Speichere in y21]
!!SN:W^H3_Sorcery_1_Hero%X1^/?y21;
!!VRy16&y6=1/y20=0/y21=0:+2; !!VRy16&y6=2/y20=0/y21=0:+4; !!VRy16&y6=3/y20=0/y21=0:+6; !!VRy16&y6=3/y20=1/y21=0:+8; !!VRy16&y6=3/y20=1/y21=1:+10; [Sorcery Crit Chance]
!!VRy99&y6=1/y20=0/y21=0:+5; !!VRy99&y6=2/y20=0/y21=0:+10; !!VRy99&y6=3/y20=0/y21=0:+15; !!VRy99&y6=3/y20=1/y21=0:+20; !!VRy99&y6=3/y20=1/y21=1:+25; [Sorcery Crit Damage]

!!if&x4=1/x5>=0;                       [Calc only when in Fight x4=1 and Valid Enemy Hero]
!!HEx5:S26/?y6;                         [Checke ob der Held Resistance hat und Speichere in y20]
!!SN:W^H3_Resistance_0_Hero%X5^/?y20;   [Checke ob der Held Master Resistance hat und Speichere in y21]
!!SN:W^H3_Resistance_1_Hero%X5^/?y21;
!!VRy99&y6=1/y20=0/y21=0:-10; !!VRy99&y6=2/y20=0/y21=0:-15; !!VRy99&y6=3/y20=0/y21=0:-20; !!VRy99&y6=3/y20=1/y21=0:-25; !!VRy99&y6=3/y20=1/y21=1:-30; [Resistance Crit Damage Reduce]
!!en;

!!HEx1:A2/170/?y10/?y19;
!!VRy16&y19=1:+10;                      [Wenn das Horn getragen wird plus +10% Crit Chance und +20% Crit Damage]

*!HEx1:A2/166/?y30/?y31;
*!VRy16&y31=1:+10;                      [Wenn das Necklace getragen wird plus +10% Crit Chance]

!!HEx1:A2/86/?y30/?y41;
!!VRy16&y41=1:+5;                       [Wenn das Tome of Fire Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/87/?y30/?y51;
!!VRy16&y51=1:+5;                       [Wenn das Tome of Air Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/88/?y30/?y61;
!!VRy16&y61=1:+5;                       [Wenn das Tome of Water Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/89/?y30/?y71;
!!VRy16&y71=1:+5;                       [Wenn das Tome of Earth Magic getragen wird plus +5% Crit Chance]

!!HEx1:A2/21/?y30/?y72;
!!VRy16&y72=1:+4;                       [Wenn der Helm of Chaos getragen wird plus +4% Crit Chance]

!!HEx1:A2/22/?y30/?y73;
!!VRy16&y73=1:+6;                       [Wenn der Crown of the Surpreme Magi Helm getragen wird plus +6% Crit Chance]

!!HEx1:A2/23/?y30/?y74;
!!VRy16&y74=1:+8;                       [Wenn der Hellstorm Helmet getragen wird plus +8% Crit Chance]

!!HEx1:A2/24/?y30/?y81;
!!VRy16&y81=1:+15;                      [Wenn der Thunder Helmet getragen wird plus +15% Crit Chance]

!!HEx1:A2/48/?y30/?y81;
!!VRy16&y81=1:+3;                       [Wenn der Ladybird of Luck getragen wird plus +3% Crit Chance]

!!HEx1:A2/46/?y30/?y81;
!!VRy16&y81=1:+3;                       [Wenn der 46 Clover of Fortune getragen wird plus +3% Crit Chance]

!!FU(Count_Set_Pieces):Px1/0/0/0/0/?y81;[Check for The Adventures Fidelity]
!!VRy16&y81>=3:+10;                     [Wenn der The Adventures Fidelity getragen wird plus +10% Crit Chance]

!!HEx1:A2/135/?y30/?y81;
!!VRy16&y81=1:+15;                      [Wenn der Titans Thunders getragen wird plus +15% Crit Chance]

!!HEx1:A2/30/?y30/?y91;                 [Wenn der Titan's Cuirass getragen wird plus +20% Crit Damage]

!!HEx1:A2/135/?y30/?y62;                [Wenn der Titans Thunders getragen wird plus +20% Crit Damage]

!!HEx1:A2/27/?y30/?y92;                 [Wenn der Scales of the Greater Basilisk getragen wird plus +5% Crit Damage]

!!HEx1:A2/28/?y30/?y93;                 [Wenn der Tunic of the Cyclops King getragen wird plus +10% Crit Damage]

!!HEx1:A2/29/?y30/?y94;                 [Wenn der Breastplate of Brimstone getragen wird plus +15% Crit Damage]

!!BMx7&x4=1/x7>=0/x7<=42:G19/?y14/?y15; [Check auf Electrik schock der Einheit]
!!VRy16&y14>0:+10;                      [Wenn das Ziel unter Electrik schock steht +10% Crit Chance]

!!SN:W^Magic_Week_Number^/?y95;         [Magic Week Var]
!!VRy16&y95=5:+15;                      [Wenn Magic Week =5 dann +15% Crit Chance]

!!FU(Count_Set_Pieces):Px1/?y90/?y96/?y40/?y41/?y42/?y43/?y44/0/0/0/0/0/?y46; [Count Set Pieces function]
!!VRy16&y90>=4:+10;                     [If hero wears 3 Dragon Set pieces + 10% Crit Chance]

!!VRy16&y43>=4:+5;                      [If hero wears 4 Priest of the Light Set pieces + 5% Crit Chance]

!!VRy16&y46>=4:+5;                      [If hero wears 4 Angelic Alliance Set pieces + 5% Crit Chance]

!!FU(Count_Set_Pieces_2):Px1/0/0/?y82;  [Check for  Sets]
!!if&y82=3;
  !!SN:W^Mage_Set_Count_Hero%X1^/?y83;
  !!VRy83::3;
  !!VRy84:Sy83;                         [Fight divided through 3 then add as crit chance]
  !!VRy16:+y84;                         [Add Crit chance based on bonus from Set if equipped ratio 1:3]
!!en;

!!if&x4=1;                             [Calc only when in Fight x4=1]
!!BG:Q?y13;
!!VRy13:-1 *-1;
!!BA:Hy13/?y13;                         [Check for valid enemy Hero]
!!FU(Count_Set_Pieces)&y13>=0:Py13/0/0/0/0/0/0/0/0/?y45; [Count Resistance Set Pieces]

!!VRy16&y45>=1:-5;                      [If hero wears 1 Resistance Set pieces - 5% Crit Chance]
!!VRy16&y45>=2:-5;                      [If hero wears 2 Resistance Set pieces - 5% Crit Chance]
!!VRy16&y45=3:-5;                       [If hero wears 3 Resistance Set pieces - 15% Crit Chance]
!!en;


*!VRy99:+50;                            [Normaler Crit wenn LvL kleiner als Random Wert ist]
!!VRy99&y19=1:+20;                      [Crit mit Magic Horn +20%]
*!VRy99&y17>0:+30;                      [Crit mit Bildung +30%]
!!VRy99&y92=1:+5;                       [Crit mit Greater Basilisk +5%]
!!VRy99&y46>=4:+5;                      [Crit mit Angelic Alliance +5%]
!!VRy99&y93=1:+10;                      [Crit mit Tunic of the Cyclops King +10%]
!!VRy99&y94=1:+15;                      [Crit mit Breastplate of Brimstone +15%]
!!VRy99&y91=1:+20;                      [Crit mit Titan's Cuirass +20%]
!!VRy99&y62=1:+20;                      [Crit mit Titans Thunders +20%]
!!VRy99&y14>0:+20;                      [Crit mit Electric shock +20%]
!!VRy99&y95=6:+25;                      [Crit mit Magic Week +25%]
!!VRy99&y90>=5:+20;                     [Crit mit 5 Dragon Set Bonus +20%]
!!VRy99&y96>=2:+10;                     [Crit mit 2 Wizards Knowledge Bonus +10%]
!!VRy99&y43>=4:+10;                     [Crit mit 4 Priest of the Light Set Bonus +10%]
!!VRy99&y44>=4:+10;                     [Crit mit 4 Priest of the Light Set Bonus +10%]
!!VRy99&y82>=2:+10;                     [Crit mit 2 Mage Class Set Bonus +10%]
!!VRy99&y82=3:+y83;                     [Crit mit 3 Mage Class Set Bonus +Number of Won fights /3]
!!VRy99&y45>=1/x4=1:-5;                 [Crit mit 1 Resistance Set pieces - 5% Crit dmg]
!!VRy99&y45>=2/x4=1:-5;                 [Crit mit 2 Resistance Set pieces - 10% Crit dmg]
!!VRy99&y45=3/x4=1:-10;                 [Crit mit 3 Resistance Set pieces - 20% Crit dmg]

!!HEx1:X?y11/?y12/?y75/?y75/?y75/?y75/?y75; [Check Hero Speciality]
!!if&y12=7/y11=0;                      [if Wisdom Crit Chance]
!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!VRy16:+y48;                           [For Wisdom Specialists Add level to Crit Chance]
!!VRy16:*3:2;
!!VRy99:-100:2+100;
!!VRy99&y16>=100:+y16-100;              [Converts Crit chance above 100% to Crit damage]
*!VRy16&y16>=100:S100;
!!en;

!!if&y12=18/y11=0;                     [if Scholar]
!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!VRy99:+10;                            [For Scholar Specialists Add +10 to Crit Damage]
!!VRy16:+10;                            [For Scholar Specialists Add +10 to Crit Chance]
!!en;

!!if&y12=57/y11=3;                     [if Crit Damage]
!!HEx1:E?y47/?y48/1;                    [Check hero Level]
!!VRy99:+y48;                           [For Crit damage Specialists Add level to Crit Damage]
!!VRy99:-100*2+100;
!!VRy16::2;
!!en;

!!VRx2:Sy16;                            [Return Crit Chance in X2]
!!VRx3:Sy99;                            [Return Crit Damage in X3]

!?FU(H3_Calc_Vanilla_Bonus_Spell_Damage);
x1 - hero id, x2 - spell id, x3 - returns increased damage
!!FU(MSR_Determine_Spell_Type):Px2/0/0/?y1;
!!FU(GetSpellRank):Px1/x2/?y2;
!!HEx1:Fd/d/?y3/d;
!!SSx2:P?y4;
!!SSx2:Ey2/?y5;
!!VRx3:Sy3 *y4 +y5;                     [normal damage]

!!HEx1:S25/?y20;                        [check sorcery]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y21;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y22;
!!VRy6:S100; !!VRy6&y20=1:S110; !!VRy6&y20=2:S120; !!VRy6&y20=3/y21=0/y22=0:S130; !!VRy6&y20=3/y21=1/y22=0:S140; !!VRy6&y20=3/y21=1/y22=1:S150; [Add Sorcery Damage +10%-50%]
!!HEx1:X?y12/d/d/d/d/d/d;               [check sorc speciality or spell speciality]
!!if|y12=0/y12=3;
!!HEx1:X?y99/?y13/d/d/d/d/d;            [check sorc speciality or spell speciality]
!!HEx1:E?y99/?y14/1;
!!if&y12=0/y13=25;
  !!VRy14:*3 +100;
  !!VRy6:-100 *y14 :100 +100;
!!en;
!!if&y12=3/y13=x2/y13<>15/y13<>13;
  !!VRy14:*3 +100;
  !!VRx3: *y14 :100;
!!en;
!!if&y12=3/y13=13;
  !!VRx3: *2;
!!en;
!!if&y12=3/y13=15;
  !!VRx3: *3 /2;
!!en;
!!en;
!!VRx3: *y6 :100;                       [increase by sorcery]

!!HEx1:A2/79/d/?y7;                     [does hero wear Orb of Air]
!!HEx1:A2/80/d/?y8;                     [Earth]
!!HEx1:A2/81/d/?y9;                     [Fire]
!!HEx1:A2/82/d/?y10;                    [Water]
!!VRy11:S0;
!!if&y1=15;
!!VRy11:Sy7+y8+y9+y10;
!!el;
!!VRy11&y1=1:Sy7;
!!VRy11&y1=2:Sy8;
!!VRy11&y1=4:Sy9;
!!VRy11&y1=8:Sy10;
!!en;
!!VRx3&y11>0: *150 :100;                [increase by orbs]

********************************************************************************
!?FU(OnBeforeBattleUniversal)&1000;     [Combat Start]

!!BA:H0/?y1;
!!FU(Scouting_Set):Py1/1;

!!BA:H1/?y2;                            [Defending Hero]
!!FU(Scouting_Set)&y2>=0:Py2/2;


!?FU(Scouting_Set);

!!HEx1:A2/52/?y30/?y31;                 [Wenn das Spyglass getragen wird]
!!HEx1:A2/53/?y30/?y32;                 [Wenn das Speclum getragen wird]
!!HEx1:S3/?y33;                         [Check for Scouting]
!!HEx1:Ed/?y40/1;                       [Check Hero Level]

!!if&y31=1/y32=1/y33>0;

!!VRy10:S1T3;

!!VRy11&y10=1:S1T3;  !!SN&y10=1:T^AC_Misc.Scout_Attack^/?z-1;
!!VRy11&y10=2:S1T3;  !!SN&y10=2:T^AC_Misc.Scout_Defense^/?z-1;
!!VRy11&y10=3:S3T4;  !!SN&y10=3:T^AC_Misc.Scout_Health^/?z-1;
!!VRy11&y10=4:S1T1;  !!SN&y10=4:T^AC_Misc.Scout_Speed^/?z-1;

!!VRy40&y10=1|y10=2::10;                [Divide Hero level trough 10 to get more bonus with higher level]
!!VRy40&y10=3::7;
!!VRy40&y10=4::20;                      [Reduce for Speed]
!!VRy11:+y40;


!!HEx1:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Prepare for Battle^/?z2 Iz2/?z2;
!!IF:M^%Z2^;

!!SN&x2=1:W^Prepare_For_Battle_Att^/y10;[Activate Battle Flag Attacker]
!!SN&x2=2:W^Prepare_For_Battle_Def^/y10;[Activate Battle Flag Defender]
!!SN:W^Prepare_For_Battle_Bonus^/y11;   [Save Bonus]
!!en;


********************************************************************************
!?BF&1000;                              [Combat Start]

!!BH0:N?y1;                             [Attacking Hero]
!!FU(Count_Set_Pieces):Py1/?y90/?y91/?y92/?y93/0/0/0/0/0/0/0/?y94/?y95/?y96; [Count Set Pieces function]
!!VRy98&y92=3:S0T99; !!VRy92&y92=3/y98<50:S4; [50% chance with 3 set pieces]
!!SN&y92=4:W^Elemental_Set_att^/1;      [Extra Cast Attacker from Wizards Knowledge set 1]

!!HEy1:A2/135/?y30/?y31;                [Wenn der Titans Thunder getragen wird run function]
!!DO(AC_Function_58)/0/20/1&y31=1:P0/1;

!!DO(AC_Function_58)/0/20/1&y93=4:P0/4;  [Moral Set make Fearless and Give level 1 Units Champion Charge]

!!SN:W^Reworked_Magic_Specialists_Mod^/?y49; [Reworked_Magic_Specialists_Mod]
!!VRy49:S0;
!!if&y49=999;  Disabled                [*only run when Magic Specialists Mod is not active to prevent errors]
!!HEy1:S11/?y40;                        [Check for Eagle Eye Skill]
!!DO(AC_Function_61)/10/69/1&y40>0/y96=3:Py1/1; [Count Spells Before Combat Attacker Hero]
!!en;

!!if&y94=100;                          [Disabled (from =5 to 100)                                       [Archdevils Suite]
!!FU(AC_Function_55):P1/?y5;            [return a random stack]
!!BMy5:F?i;                             [read flags]
!!VRi:&32768;                           [just look at waiting bit]
!!VRy50&i>0:S1;
!!FU(AC_Function_58)&y50<>1:Py5/3;      [and give that Stack Double Strike with Stack Exp]
**Add missing check for double later
!!en;

!!if&y95>=5;                           [Angelic Alliance Set]
!!DO(AC_Function_59)/0/20/1&y95=5:P105/1;
!!DO(AC_Function_59)/0/20/1&y95=6:P120/2;
!!en;

!!SN:W^Prepare_For_Battle_Att^/?y80;    [Scouting Set]
!!DO(AC_Function_60)/0/20/1&y80>0:Py80;


!!BH1:N?y2;                             [Defending Hero]

!!if&y2>=0;
!!FU(Count_Set_Pieces):Py2/?y90/?y91/?y92/?y93/0/0/0/0/0/0/0/?y94/?y95/?y96; [Count Set Pieces function]
!!VRy98&y92=3:S0T99; !!VRy92&y92=3/y98<50:S4;
!!SN&y92=4:W^Elemental_Set_def^/1;      [Extra Cast Defender from Wizards Knowledge set 1]

!!HEy2:A2/135/?y30/?y32;                [Wenn der Titans Thunder getragen wird run function]
!!DO(AC_Function_58)/21/41/1&y32=1:P0/1;

!!DO(AC_Function_58)/21/41/1&y93=4:P0/4; [Moral Set make Fearless and Give level 1 Units Champion Charge]

!!if&y49=999;  Disabled                [*only run when Magic Specialists Mod is not active to prevent errors]
!!HEy2:S11/?y40;                        [Check for Eagle Eye Skill]
!!DO(AC_Function_61)/10/69/1&y40>0/y96=3:Py2/2; [Count Spells Before Combat Defender Hero]
!!SN:W^Defender_Eagle_Eye_Spells^/?y33;
!!en;

!!if&y94=100;                          [Disabled (from =5 to 100)                                       [Archdevils Suite]
!!FU(AC_Function_55):P0/?y5;            [return a random stack]
!!BMy5:F?i;                             [read flags]
!!VRi:&32768;                           [just look at waiting bit]
!!VRy50&i>0:S1;
*!IF:M^y50 is %Y50^;
!!FU(AC_Function_58)&y50<>1:Py5/3;      [and give that Stack Double Strike with Stack Exp]
**Add missing check for double later
!!en;

!!if&y95>=5;                           [Angelic Alliance Set]
!!DO(AC_Function_59)/21/41/1&y95=5:P105/1;
!!DO(AC_Function_59)/21/41/1&y95=6:P120/2;
!!en;

!!SN:W^Prepare_For_Battle_Def^/?y80;    [Scouting Set]
!!DO(AC_Function_60)/21/41/1&y80>0:Py80;

!!en;

!!BA:O?y10/?y20;                        [Check Owner before Battle]
!!SN:W^Hero_Attacker_Owner0^/y10;       [for Ring of the Magi Set Bonus]

!!BA:H1/?y4;
!!SN&y4<>-2:W^Hero_Defender_Owner0^/y20;

!!SN:W^Prepare_For_Battle_Att^/0;
!!SN:W^Prepare_For_Battle_Def^/0;
!!SN:W^Prepare_For_Battle_Bonus^/0;


********************************************************************************
!?BA53&1000;                            [Combat End]

!!SN:W^Elemental_Set_att^/0;
!!SN:W^Elemental_Set_def^/0;
!!SN:W^Luck_Count_Att^/0;               [Luck Count Attacker reset]
!!SN:W^Luck_Count_Def^/0;               [Luck Count Defender reset]
!!SN:W^Speed_MonsterNumber^/-1;
!!SN:W^Attacker_Eagle_Eye_Spells^/?y50; [Call Spell Count in Var]
!!SN:W^Defender_Eagle_Eye_Spells^/?y51;
!!SN:W^Attacker_Eagle_Eye_Spells^/0;    [Reset Spell Count]
!!SN:W^Defender_Eagle_Eye_Spells^/0;

!!BA:H0/?y1;                            [Attacking Hero]

!!SN:W^Reworked_Magic_Specialists_Mod^/?y49; [Reworked_Magic_Specialists_Mod]
!!VRy49:S0;
!!if&y49=0;                            [*only run when Magic Specialists Mod is not active to prevent errors]

!!FU(Count_Set_Pieces):Py1/0/0/0/0/0/0/0/0/0/0/0/0/0/?y96; [Count Set Pieces function]
!!HEy1:S11/?y40;                        [Check for Eagle Eye Skill]
!!if&y40>0/y96=999;                    [Disabled and replaced with better code]
****Eagle Eye Set Bonus Attacker
!!DO(AC_Function_61)/10/69/1:Py1/1;     [Count Spells After Combat Attacker Hero]
!!SN:W^Attacker_Eagle_Eye_Spells^/?y10;

!!if&y50<y10;
!!VRy10:-y50;
!!VRy10:S1;
!!HEy1&y10=1:Fd/d/d1/d;                 [give appropriate bonus]
!!HEy1&y10=2:Fd/d/d2/d;                 [give appropriate bonus]
!!HEy1&y10=3:Fd/d/d3/d;                 [give appropriate bonus]
!!HEy1&y10=4:Fd/d/d4/d;                 [give appropriate bonus]
!!HEy1&y10=5:Fd/d/d5/d;                 [give appropriate bonus]
!!HEy1&y10=6:Fd/d/d6/d;                 [give appropriate bonus]
!!HEy1&y10=7:Fd/d/d7/d;                 [give appropriate bonus]
!!HEy1:B0/?z-10;                        [get hero name]

!!SN:T^AC_Misc.Eagle Eye Set^/?z-9 Iz-9/?z-9;
!!HEy1:O?y3;                            [get owner of this hero]
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/33/y10/1/z-9;              [If Bonus Show Picture]
!!en;
!!en;
!!en;

!!BA:H1/?y2;                            [Defending Hero]
!!if&y2>=0;
!!SN:W^Reworked_Magic_Specialists_Mod^/?y49; [Reworked_Magic_Specialists_Mod]
!!VRy49:S0;
!!if&y49=0;                            [*only run when Magic Specialists Mod is not active to prevent errors]
!!HEy2:S11/?y41;
!!FU(Count_Set_Pieces):Py2/0/0/0/0/0/0/0/0/0/0/0/0/0/?y96; [Count Set Pieces function]
!!if&y41>0/y96=999;                    [Disabled and replaced with better code]
****Eagle Eye Set Bonus Defender
!!DO(AC_Function_61)/10/69/1:Py2/2;     [Count Spells Before Combat Defender Hero]
!!SN:W^Defender_Eagle_Eye_Spells^/?y11;
!!if&y51<y11;
!!VRy11:-y51;
!!VRy11:S1;
!!HEy2&y11=1:Fd/d/d1/d;                 [give appropriate bonus]
!!HEy2&y11=2:Fd/d/d2/d;                 [give appropriate bonus]
!!HEy2&y11=3:Fd/d/d3/d;                 [give appropriate bonus]
!!HEy2&y11=4:Fd/d/d4/d;                 [give appropriate bonus]
!!HEy2&y11=5:Fd/d/d5/d;                 [give appropriate bonus]
!!HEy2&y11=6:Fd/d/d6/d;                 [give appropriate bonus]
!!HEy2&y11=7:Fd/d/d7/d;                 [give appropriate bonus]
!!HEy2:B0/?z-10;                        [get hero name]

!!SN:T^AC_Misc.Eagle Eye Set^/?z-9 Iz-9/?z-9;
!!HEy2:O?y3;                            [get owner of this hero]
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/33/y11/1/z-9;              [If Bonus Show Picture]
!!en;
!!en;
!!en;
!!en;

!!SN:W^Attacker_Eagle_Eye_Spells^/0;    [Reset Spell Count]
!!SN:W^Defender_Eagle_Eye_Spells^/0;


****Ring of the Magi Set Bonus Attacker
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!HEy1:A2/139/?y10/?y11;                [Check for Ring of the Magi]
!!HEy1:E?y6/?y7/1;                      [get level of this hero]
!!SN&y11=1/y5=y9:W^Magi_Set_Count_Hero%Y1^/?y8; [Check Value Att]
!!SN&y11=1/y5=y9/y8<y7:W^Magi_Set_Count_Hero%Y1^/d+1; [+1% Spell Damage if Battle won with Ring equipped Att  New Capped at Hero Level]


****Cornucopia Set Bonus Attacker
!!HEy1:A2/140/?y10/?y11;                [Check for Cornucopia]
!!if&y11=1;                            [Give Set Bonus if equipped]
!!HEy1:O?y3;                            [get owner of this hero]
!!HEy1:E?y6/?y7/1;                      [get level of this hero]

!!VRy7::10 +1;
!!VRy10:S0T6;
!!VRy11&y10<6:S0T3 +y7;
!!VRy11&y10=6:Sy7*500+1000R1500;
!!OW:Ry3/y10/dy11;

!!HEy1:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Cornucopia Set^/?z-9 Iz-9/?z-9;
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/y10/y11/1/z-9;             [If Bonus Show Picture]
!!UN:R2;
!!en;


****Ring of the Magi Set Bonus Defender
!!BA:H1/?y4;
!!if&y4<>-2;
!!HEy4:A2/139/?y10/?y11;                [Check for Ring of the Magi Defender]
!!SN:W^Hero_Defender_Owner0^/?y20;
!!HEy4:E?y6/?y7/1;                      [get level of this hero]
!!SN&y11=1/y5=y9:W^Magi_Set_Count_Hero%Y4^/?y8; [Check Value Att]
!!SN&y11=1/y20=y2/y8<y7:W^Magi_Set_Count_Hero%Y4^/d+1; [+1% Spell Damage if Battle won with Ring equipped Def]


****Cornucopia Set Bonus Defender
!!HEy4:A2/140/?y10/?y11;                [Check for Cornucopia]
!!if&y11=1;                            [Give Set Bonus if equipped]
!!HEy4:O?y3;                            [get owner of this hero]
!!HEy4:E?y6/?y7/1;                      [get level of this hero]

!!VRy7::10 +1;
!!VRy10:S0T6;
!!VRy11&y10<6:S0T3 +y7;
!!VRy11&y10=6:Sy7*500+1000R1500;
!!OW:Ry3/y10/dy11;

!!HEy4:B0/?z-10;                        [get hero name]
!!SN:T^AC_Misc.Cornucopia Set^/?z-9 Iz-9/?z-9;
!!OW&y3<>-1:Iy3/?y4;                    [get AI (1) or human (0)]
!!VRy5:S0;                              [assume AI]
!!VRy5&y3<>-1/y4=0:S1;                  [human if has owner and that owner is human]
!!IF&y5=1:Q2/y10/y11/1/z-9;             [If Bonus Show Picture]
!!UN:R2;
!!en;
!!en;


********************************************************************************
!?FU(OnAfterBattleUniversal)&1000;      [at end of battle]
!!HE-1:N?y2;
!!FU&y2<0:E;                            [exit if no active hero]

!!HEy2:O?y1;                            [get owner of this hero]
!!FU&y1=-1:E;                           [Exit if no Owner]

!!HEy2:E?y3/?y4/1;
!!HEy2:B0/?z-10;
!!FU(Count_Set_Pieces):Py2/0/0/?y92;    [Count Set Pieces function for Books]

!!if&y92=4;
!!VRy3&y3>=15000000:S15000000;          [Fix for Var overflow]
!!VRy5:Sy3;
!!VRy5:*120:100 -y3;
!!VRy5::100 *5 +1000;

!!SN:T^AC_Misc.Elemental Set^/?z-9 Iz-9/?z-9;
!!IF:Q1/17/y5/1/z-9;
!!HEy2:Edy5;                            [Give Experience]
!!en;

!!FU(Count_Set_Pieces_2):Py2/?y93;      [Count Set Pieces function Battle Mage]
!!if&y93=5;

!!VRy10:S0T100;
!!if&y10<25;                           [25% Chance]
!!VRy5:S31R3;
!!SN:T^AC_Misc.Battle Mages Set^/?z-9 Iz-9/?z-9;
!!IF:Q1/y5/1/1/z-9;

!!HEy2&y5=31:Fd1/d/d/d;                 [give appropriate bonus]
!!HEy2&y5=32:Fd/d1/d/d;                 [give appropriate bonus]
!!HEy2&y5=33:Fd/d/d1/d;                 [give appropriate bonus]
!!HEy2&y5=34:Fd/d/d/d1;                 [give appropriate bonus]
!!en;
!!en;


******************[Improved Spell Handling Section]*****************************
!?BG0&1000;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;                            [Exit if AI]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere Spellnummer in y2]
!!FU&y2<=9|y2>69:E;

!!BG:H?y3;
!!if&y3>=0;

!!if&y2=38;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/?y95;   [Count Set Pieces function]
!!if&y95>=5;                           [If hero wears 5 Priest of the Light Set pieces + 50% Bonus to Resurrection]
!!SN:W^Spell_Change_Flag^/1;
!!SSy2:P?y5;
!!SN:W^Priest_Set_Bonus_Res^/y5;
!!VRy5:*3:2;                            [*+50% Bonus]
!!SSy2:Py5;
!!en;
!!en;

!!if&y2=39;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/?y96;  [Count Set Pieces function]
!!if&y96>=5;                           [If hero wears 5 Priest of the Dark Set pieces + 50% Bonus to Raise Dead]
!!SN:W^Spell_Change_Flag^/1;
!!SSy2:P?y5;
!!SN:W^Dark_Priest_Set_Bonus_Res^/y5;
!!VRy5:*3:2;                            [*+50% Bonus]
!!SSy2:Py5;
!!en;
!!en;

!!if&y2=36;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/?y97;[Count Set Pieces function]
!!if&y97=3;                            [If hero wears 3 Resistance Set pieces Set Mass Magic Mirror]
!!SN:W^Spell_Change_Flag^/1;
!!SSy2:F?i;
!!VRi:&-17;                             [remove single target flag]
!!VRi:|64;                              [0x00000040 - has mass version at expert level]
!!SSy2:Fi;
!!en;
!!en;

!!if&y2=48;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/0/?y97; [Count Set Pieces function]
!!if&y97>=5;                           [If hero wears 5 Angelic Allinace Set pieces + 50% Bonus to Prayer]
!!SN:W^Spell_Change_Flag^/1;
!!HEy3:S16/?y50;                        [Check Water Magic Level]
!!SSy2:Ey50/?y5;
!!SN:W^Angelic_Alliance_Bonus_Res^/y5;
!!VRy5:+2;                              [*+2 Bonus to Prayer]
!!SSy2:Ey50/y5;
!!en;
!!en;

!!if&y2=43;
!!FU(Count_Set_Pieces_2):P-1/?y47;      [Count Set Pieces function]
!!if&y47>=4;                           [If hero wears 4 Battle Mage War Dress Set pieces + 50% Bonus to Bloodlust]
!!SN:W^Spell_Change_Flag^/1;
!!HEy3:S14/?y50;                        [Check Fire Magic Level]
!!SSy2:Ey50/?y5;
!!SN:W^Battle_Mage_War_Bonus^/y5;
!!VRy5:+4;                              [+4 Bonus to Bloodlust]
!!SSy2:Ey50/y5;
!!en;
!!en;

!!en;


!?BG1&1000;

!!SN:W^Spell_Change_Flag^/?y1;
!!FU&y1=0:E;

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere Spellnummer in y2]
!!FU&y2<=9|y2>69:E;

!!BG:H?y3;
!!if&y3>=0;


!!if&y2=38;
!!SN:W^Spell_Change_Flag^/0;            [Reset Flag]
!!SN:W^Priest_Set_Bonus_Res^/?y5;
!!SSy2:P?y5;                            [Restore old Value]
!!VRy5::3*2;
!!SSy2:Py5;                             [Restore old Value]
!!en;

!!if&y2=39;
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Dark_Priest_Set_Bonus_Res^/?y5;
!!SSy2:P?y5;                            [Restore old Value]
!!VRy5::3*2;
!!SSy2:Py5;                             [Restore old Value]
!!en;

!!if&y2=36;
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Dark_Priest_Set_Bonus_Res^/?y5;
!!SSy2:F?i;
!!VRi:|17;                              [remove single target flag]
*!VRi:|64;  0x00000040 - has mass version at expert level
!!SSy2:Fi;
!!en;

!!if&y2=48;                            [*Prayer]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Angelic_Alliance_Bonus_Res^/?y5;
!!HEy3:S16/?y50;                        [Check Water Magic Level]
!!SSy2:Ey50/?y5;                        [Restore old Value]
!!VRy5:-2;                              [-2 to Prayer]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!if&y2=43;                            [*Bloodlust]
!!SN:W^Spell_Change_Flag^/0;
!!SN:W^Battle_Mage_War_Bonus^/?y5;
!!HEy3:S14/?y50;                        [Check Fire Magic Level]
!!SSy2:Ey50/?y5;                        [Restore old Value]
!!VRy5:-4;                              [-4 to Bloodlust]
!!SSy2:Ey50/y5;                         [Restore old Value]
!!en;

!!en;


********************************************************************************
[Start of battle trigger]
!?BF&1000;                              [Prebuff section, apply spells to creatures]
*!SN:W^Battle_Start_Set_Flag^/1;
!!BA:H0/?y98;
!!FU(Count_Set_Pieces):Py98/0/0/0/0/0/?y95/?y96/?y97/?y71/?y70; [Count Set Pieces function]
!!FU(Count_Set_Pieces_2):Py98/?y48;     [Count Set Pieces function]
!!DO(AC_Function_62)/0/20/1&y48=5:P;    [Pass ]
!!DO(AC_Function_48)/0/20/1&y95=6:P41/3/1; [Pass Bless if complete Priest of Light set equipped X1=Spell X2=Duration X3=Power]
!!DO(AC_Function_48)/21/41/1&y97=4:P71/50/1; [Pass Poison if complete Priest of Light set equipped]
!!DO(AC_Function_48)/21/41/1&y96=6:P42/50/1; [Pass Curse if complete Priest of Dark set equipped]
!!VRy50&y71=3:S30R3;
!!DO(AC_Function_48)/0/20/1&y71=3:Py50/50/1; [Pass Random Basic Protection if complete Resistance set equipped X1=Spell X2=Duration X3=Power]

!!if&y70=3;                            [Pegasus Harness Set]
!!SN:W^Speed_MonsterNumber^/0;
!!DO(AC_Function_49)/0/10/1:P;          [Function to recieve slowest unit in Army]
!!SN:W^Speed_MonsterNumber^/?y10;       [Monster Stack with slowest speed]
!!BMy10&y10>=0:S?y11;
!!VRy11:+5;                             [+5 Speed for slowest Unit]
!!BMy10&y10>=0:Sy11;
!!en;

!!BA:Q?f;
!!VRz-1&y97=4:S^POISON^;
!!SN&y97=4/f=0:Pz-1;                    [Play Poison Sound if not Quick Comabat]

!!BA:H1/?y99;
!!FU&y99<0:E;
!!FU(Count_Set_Pieces):Py99/0/0/0/0/0/?y95/?y96/?y97/?y98/?y75; [Count Set Pieces function]
!!DO(AC_Function_48)/21/41/1&y95=6:P41/3/1; [Pass Bless if complete Priest of Light set equipped X1=Spell X2=Duration X3=Power]
!!DO(AC_Function_48)/0/20/1&y96=6:P71/50/1; [Pass Curse if complete Priest of Dark set equipped]
!!DO(AC_Function_48)/21/41/1&y97=4:P42/50/1; [Pass Poison if complete Priest of Light set equipped]
!!VRy50&y98=3:S30R3;
!!DO(AC_Function_48)/21/41/1&y98=3:Py50/50/1; [Pass Random Basic Protection if complete Resistance set equipped X1=Spell X2=Duration X3=Power]

!!if&y75=3;                            [Pegasus Harness Set]
!!SN:W^Speed_MonsterNumber^/0;
!!DO(AC_Function_49)/21/31/1:P;         [Function to recieve slowest unit in Army]
!!SN:W^Speed_MonsterNumber^/?y10;       [Monster Stack with slowest speed]
!!BMy10&y10>=0:S?y11;
!!VRy11:+5;                             [+5 Speed for slowest Unit]
!!BMy10&y10>=0:Sy11;
!!en;


**********
!?FU(AC_Function_48);
!!BMx16:Mx1/x2/x3;                      [Apply Bonus Spell]

**********
!?FU(AC_Function_62);                   [Determine slowest unit fct for Pegasus Harness Set Piece]

!!BMx16:T?y30;
!!if&y30>=0/y30<=196;
!!BMx16:Hd5;
!!en;

**********
!?FU(AC_Function_49);                   [Determine slowest unit fct for Pegasus Harness Set Piece]
!!BMx16:S?y1;
!!BMx16:T?y30;
!!if&y30>=0/y30<=196;
!!VRy11:Sx16;

!!if&y1>1;
!!VRy2:S0;
!!SN:W^Speed_Monster%X16^/y1;

!!VRy11:-1;
!!SN&y11>=0:W^Speed_Monster%Y11^/?y2;
!!if&y1<=y2;
!!SN:W^Speed_MonsterNumber^/?y20;
!!BMy20:S?y1;
!!BMx16:S?y2;
!!SN&y2<y1:W^Speed_MonsterNumber^/x16;
!!en;
!!en;
!!en;


********************************************************************************


****************************Wizards Knowledge***************************************
!?BG1&1000;                             [1 extra cast per combat for Wizards Knowledge]

!!BG:Q?y1;                              [Fix for Double Cast]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;  [Current attacking side]
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

!!if&y4=0/y2=0/y3=0/y5=0/y7=0/y8=0;         [fix with Double Cast mod and Magic Week 34,41 37,38,39,40]
!!SN&y1=0:W^Elemental_Set_att^/?y2;
!!SN&y1=1:W^Elemental_Set_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!BA:Q?f;
!!VRz-1:S^LUCK^;
!!SN&1000/f=0:Pz-1;
!!SN:T^AC_Misc.Elemental Sets Extra^/?z-1;
*!VRz-1:S^{Elemental Set Bonus Extra Cast!}^;
!!BU&1000/f=0:Mz-1;
!!SN&y1=0:W^Elemental_Set_att^/0;
!!SN&y1=1:W^Elemental_Set_def^/0;
!!en;
********************************************************************************
*?BG1&1000;                                                                     [The Champion's Honor Set After Moral re-enable Spell Book]

*!BG:Q?y1;                                                                      [Current attacking side]
*!SN&y1=0:W^Moral_Count_Att^/?y2;
*!SN&y1=1:W^Moral_Count_Def^/?y2;
*!FU&y2=0:E;
*!BHy1:M?y3;
*!FU&y3=0:E;
*!BHy1:M0;
*!VRz1:S^GOODMRLE^;
*!SN:P1;
*!SN&y1=0:W^Moral_Count_Att^/0;
*!SN&y1=1:W^Moral_Count_Def^/0;

********************************************************************************
*?BR&1000;

*!SN:W^Moral_Count_Att^/0;                                                      [Moral Count Attacker reset]
*!SN:W^Moral_Count_Def^/0;                                                      [Moral Count Attacker reset]

********************************************************************************
!?BR&1000/v997<>-1;                     [Reduce Luck and Moral Wizard Set Bonus]
!!BA:Q?f;
!!FU&f=1:E;
!!FU(AC_Function_56):P;

!?BG1&1000;
!!BA:Q?f;
!!FU&f=1:E;
!!FU(AC_Function_56):P;

!?FU(AC_Function_56);

!!BH0:N?y1;                             [Attacker]
!!FU(Count_Set_Pieces):Py1/?y90/?y91/?y92/?y93/?y94; [Count Set Pieces function]

!!DO(AC_Function_50)/21/41/1&y93>=2:P;  [Moral Set]
!!DO(AC_Function_51)/21/41/1&y93>=3:P;

!!DO(AC_Function_51)/21/41/1&y94>=2:P;  [Luck Set]
!!DO(AC_Function_50)/21/41/1&y94>=3:P;

!!BH1:N?y2;                             [Defender]
!!FU&y2<0:E;
!!FU(Count_Set_Pieces):Py2/?y90/?y91/?y92/?y93/?y94; [Count Set Pieces function]

!!DO(AC_Function_50)/0/20/1&y93>=2:P;
!!DO(AC_Function_51)/0/20/1&y93>=3:P;

!!DO(AC_Function_51)/0/20/1&y94>=2:P;
!!DO(AC_Function_50)/0/20/1&y94>=3:P;

!?FU(AC_Function_51);
!!BMx16:F?y1 N?y3;                      [read flags]
!!VRy1:&16;                             [just look at alive]
!!FU|y1=0/y3<1:E;                       [Exit if no stack or has no morale Flag]
!!BMx16:G212/?y2/?t;                    [212 Moral]
!!VRy2:-1;                              [add negative morale to current morale]
!!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Morale]
!!VRy2&y2>=5:S5;                        [Cannot be more than +5 Morale]
!!BMx16:G212/y2/?t;                     [212 Moral]

!?FU(AC_Function_50);
!!BMx16:N?y3;                           [Get number]
!!FU&y3<1:E;                            [Exit if no stack or has no morale Flag]
!!BMx16:G213/?y2/?t;                    [213 Luck]
!!VRy2:-1;                              [add negative morale to current morale]
!!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Morale]
!!BMx16:G213/y2/?t;                     [213 Luck]


********************************************************************************
Show Bonus Table when clicking on Knowledge Icon in Hero Screen

!?CM2&1000;                             [Trigger for showing crit chance in hero screen]

!!CM:S?y1 T?y2 I?y3;
!!FU|y1<>14/y2<>512/y3<>53:E;           [When rightclick on Knowledge Icon show Bonus list]
!!CM:R0;

!!DL89:N^ACMList.txt^;

!!HE-1:N?y4;
!!FU(Calc_Magic_Strength):Py4/?y61;

!!FU(H3_Calc_Normal_Spell_Damage):Py4/?y98/?y97/0/0/1; [Pass Hero Number and Give Back Normal Damage in y98 and Extra Damage Option in y97]
*!IF:L^%Y97 %Y98^;
!!FU(H3_Calc_Crit_Chance_and_Damage):Py4/?y16/?y99/0; [IF 1 at the end it means to in fight 0 means only check]

!!VRy16&y16>=100:S100;                  [Cap Chance at 100%]

*--------------------------Normal Spell Damage Y98--------------------------------------

!!FU(Count_Set_Pieces_2):Py4/0/0/?y91/?y90/?y92; [Check for  Sets]

!!VRy13:S0;
!!VRy15:S0;
!!VRy14:S100;                           [Initialize to 100]

!!HEy4:A2/133/?y50/?y51;
!!VRy15&y51=1:S3;

!!SN&y90=3:W^Warrior_Set_Count_Hero%Y4^/?y10;
!!SN&y91=3:W^Mage_Set_Count_Hero%Y4^/?y11;
!!SN&y92=3:W^Adventurer_Set_Count_Hero%Y4^/?y12;

!!SN:W^Master_Warrior_Hero%Y4^/?y19;
!!SN:W^Master_Mage_Hero%Y4^/?y23;
!!SN:W^Master_Adventurer_Hero%Y4^/?y24;
!!SN:W^Grandmaster_Warrior_Hero%Y4^/?y20;
!!SN:W^Grandmaster_Mage_Hero%Y4^/?y21;
!!SN:W^Grandmaster_Adventurer_Hero%Y4^/?y22;

!!HEy4:A2/48/?y30/?y81;
!!VRy13&y81=1:+3;                       [Wenn der Ladybird of Luck getragen wird plus +3% Crit Chance]
!!HEy4:A2/46/?y30/?y81;
!!VRy13&y81=1:+3;                       [Wenn der 46 Clover of Fortune getragen wird plus +3% Crit Chance]
!!FU(Count_Set_Pieces):Py4/0/0/0/0/?y81;[Check for The Adventures Fidelity]
!!VRy13&y81>=3:+5;                      [Wenn der The Adventures Fidelity getragen wird plus +5% physical Crit Chance]

!!VRy10::3;                             [+1% physical crit chance per 3 levels]
!!VRy11::3;                             [+1% spell crit chance and damage per 3 levels]
!!VRy12::20;                            [+1% Growth per 20 level]

!!VRy13&y19=1:+10;                      [+10% chance for Critical Strike Master]
!!VRy13&y19=1/y23=1:-10;                [No additional crit chance for hybrid classes]
!!VRy13&y19=1/y24=1:-10;                [No additional crit chance for hybrid classes]
!!VRy13&y20=1:+10;                      [+10% chance for Critical Strike GrandMaster]
!!VRy14&y90=3:+y10;                     [+1% physical crit damage per 3 levels]
!!VRy14:+20;                            [+20% more damage]
!!VRy15&y22=1:+3;                       [+5% creature growth]

!!VRy13:+y10;                           [+Physical Crit Chance from Set]
!!VRy15:+y12;                           [+Creature Growth Chance from Set]
*!VRy16:+y11;                           [+Spell Crit Chance from Set already handeld before]

!!FU(Spell_Trainer_Calc):Py4/?y95/?y96;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]

!!SN:T^AC_Misc.Bonus Table 1^/?z1; !!SN:Iz1/?z1;
!!SN:T^AC_Misc.Spell_Upgrades^/?z2; !!SN:Iz2/?z2;

!!DL89:A1/3/z1/1;
!!DL89:A2/3/z2/1;
!!DL89:S1;                              [Show complete Dialogue number 89]


!?DL&v998=89/v999=30722/v1000=13;       [When clicking on the close Button]
!!DL:C1;

!?FU(OnBeforeBattleUniversal);
!!IF:V761/1;

!?FU(OnAfterBattleUniversal);
!!IF:V761/0;


********************************************************************************
*Dragon Set*
!?AE1|v998=39/v998=40/v998=41/v998=42/v998=43/v998=44; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92; [Count Set Pieces function]

!!VRy90:+1;
!!HE-1&y90=3:Fd0/d0/d3/d3;              [With 3 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y90=4:Fd2/d0/d0/d0;              [With 4 Set pieces Increase attack +2]
!!HE-1&y90=5:Fd0/d2/d0/d0;              [With 5 Set pieces Increase defense +2]
!!HE-1&y90=6:Fd2/d2/d2/d2;              [With 6 Set pieces Increase all +2]


!?AE0|v998=39/v998=40/v998=41/v998=42/v998=43/v998=44;; Unequip Artifact !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92; [Count Set Pieces function]

!!VRy90:-1;
!!HE-1&y90=2:Fd0/d0/d-3/d-3;            [Without 3 Set pieces decrease spell power -3 wisdom -3]
!!HE-1&y90=3:Fd-2/d0/d0/d0;             [With 4 Set pieces Increase attack -2]
!!HE-1&y90=4:Fd0/d-2/d0/d0;             [With 5 Set pieces Increase defense -2]
!!HE-1&y90=5:Fd-2/d-2/d-2/d-2;          [With 6 Set pieces decrease all -2]

*---------------------------------
*Priest of the Light Set*
!?AE1|v998=103/v998=13/v998=22/v998=25/v998=9/v998=98; Equip Artifact !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy95:+1;
!!HE-1&y95=3:Fd0/d0/d2/d2;              [With 3 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y95=4:Fd0/d0/d0/d0;              [With 4 Set pieces Increase attack +0]
!!HE-1&y95=5:Fd1/d1/d1/d1;              [With 5 Set pieces Increase primary +1]
!!HE-1&y95=6:Fd4/d4/d4/d4;              [With 6 Set pieces Increase all +4]


!?AE0|v998=103/v998=13/v998=22/v998=25/v998=9/v998=98;; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy95:-1;
!!HE-1&y95=2:Fd0/d0/d-2/d-2;            [Without 3 Set pieces decrease spell power -3 wisdom -3]
!!HE-1&y95=3:Fd0/d0/d0/d0;              [With 4 Set pieces Increase attack -0]
!!HE-1&y95=4:Fd-1/d-1/d-1/d-1;          [With 5 Set pieces Increase primary -1]
!!HE-1&y95=5:Fd-4/d-4/d-4/d-4;          [With 6 Set pieces decrease all -4]

*---------------------------------
*Priest of the Dark Set*
!?AE1|v998=104/v998=14/v998=20/v998=26/v998=8/v998=56; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy96:+1;
!!HE-1&y96=3:Fd0/d0/d2/d2;              [With 3 Set pieces Increase spell power +2 wisdom +2]
!!HE-1&y96=4:Fd2/d0/d0/d0;              [With 4 Set pieces Increase attack +2]
!!HE-1&y96=5:Fd1/d1/d1/d1;              [With 5 Set pieces Increase primary +1]
!!HE-1&y96=6:Fd4/d4/d4/d4;              [With 6 Set pieces Increase all +4]


!?AE0|v998=104/v998=14/v998=20/v998=26/v998=8/v998=56;; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94/?y95/?y96; [Count Set Pieces function]

!!VRy96:-1;
!!HE-1&y96=2:Fd0/d0/d-2/d-2;            [Without 3 Set pieces decrease spell power -2 wisdom -2]
!!HE-1&y96=3:Fd-2/d0/d0/d0;             [With 4 Set pieces Increase attack -2]
!!HE-1&y96=4:Fd-1/d-1/d-1/d-1;          [With 5 Set pieces Increase primary -1]
!!HE-1&y96=5:Fd-4/d-4/d-4/d-4;          [With 6 Set pieces decrease all -4]

*---------------------------------
*Books*
!?AE1|v998=86/v998=87/v998=88/v998=89; Equip Artifact     !!FU&761:E;

!!SN:W^Critical_Sorcery_Book_Fix^/?y1;  [*Necessary if played together with Magic Specialits Mod]
!!FU&y1=1:E;

!!HE-1:A2/86/?y30/?y10;
!!HE-1&v998=86/y10=1:A-86;

!!HE-1:A2/87/?y31/?y11;
!!HE-1&v998=87/y11=1:A-87;

!!HE-1:A2/88/?y32/?y12;
!!HE-1&v998=88/y12=1:A-88;

!!HE-1:A2/89/?y33/?y13;
!!HE-1&v998=89/y13=1:A-89;

!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy92:+1;


!!HE-1&y92=2/v998=86/y10=1/y30=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=86/y10=1/y30=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=86/y10=1/y30=2:Fd0/d0/d-5/d0;
!!HE-1&y92=2/v998=87/y11=1/y31=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=87/y11=1/y31=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=87/y11=1/y31=2:Fd0/d0/d-5/d0;
!!HE-1&y92=2/v998=88/y12=1/y32=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=88/y12=1/y32=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=88/y12=1/y32=2:Fd0/d0/d-5/d0;
!!HE-1&y92=2/v998=89/y13=1/y33=1:Fd0/d0/d-3/d-3;
!!HE-1&y92=3/v998=89/y13=1/y33=1:Fd0/d0/d-5/d0;
!!HE-1&y92=3/v998=89/y13=1/y33=2:Fd0/d0/d-5/d0;

!!HE-1&y92=2:Fd0/d0/d3/d3;              [With 2 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y92=3:Fd0/d0/d5/d0;              [With 3 Set pieces Increase power +5]

!!HE-1&v998=86/y10=1:A86;
!!HE-1&v998=87/y11=1:A87;
!!HE-1&v998=88/y12=1:A88;
!!HE-1&v998=89/y13=1:A89;

!!if&y92=4;
*!VRz1:S^raisedead^;
*!SN:Pz1;
!!en;

!?AE0|v998=86/v998=87/v998=88/v998=89; Unequip Artifact   !!FU&761:E;

!!SN:W^Critical_Sorcery_Book_Fix^/?y1;  [*Necessary if played together with Magic Specialits Mod]
!!FU&y1=1:E;

!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92;

!!VRy92:-1;
!!HE-1&y92=1:Fd0/d0/d-3/d-3;            [With 2 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y92=2:Fd0/d0/d-5/d0;             [With 3 Set pieces Increase power +5]


*---------------------------------
*Orbs*
!?AE1|v998=79/v998=80/v998=81/v998=82; Equip Artifact      !!FU&761:E;

!!HE-1:A2/79/?y30/?y10;
!!HE-1&v998=79/y10=1:A-79;

!!HE-1:A2/80/?y31/?y11;
!!HE-1&v998=80/y11=1:A-80;

!!HE-1:A2/81/?y32/?y12;
!!HE-1&v998=81/y12=1:A-81;

!!HE-1:A2/82/?y33/?y13;
!!HE-1&v998=82/y13=1:A-82;

!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy91:+1;

!!HE-1&y91=3/v998=79/y10=1/y30=1:Fd0/d0/d0/d-3;
!!HE-1&y91=4/v998=79/y10=1/y30=1:Fd0/d0/d-5/d0;
!!HE-1&y91=4/v998=79/y10=1/y30=2:Fd0/d0/d-5/d0;
!!HE-1&y91=3/v998=80/y11=1/y31=1:Fd0/d0/d0/d-3;
!!HE-1&y91=4/v998=80/y11=1/y31=1:Fd0/d0/d-5/d0;
!!HE-1&y91=4/v998=80/y11=1/y31=2:Fd0/d0/d-5/d0;
!!HE-1&y91=3/v998=81/y12=1/y32=1:Fd0/d0/d0/d-3;
!!HE-1&y91=4/v998=81/y12=1/y32=1:Fd0/d0/d-5/d0;
!!HE-1&y91=4/v998=81/y12=1/y32=2:Fd0/d0/d-5/d0;
!!HE-1&y91=3/v998=82/y13=1/y33=1:Fd0/d0/d0/d-3;
!!HE-1&y91=4/v998=82/y13=1/y33=1:Fd0/d0/d-5/d0;
!!HE-1&y91=4/v998=82/y13=1/y33=2:Fd0/d0/d-5/d0;

!!HE-1&y91=3:Fd0/d0/d0/d3;
!!HE-1&y91=4:Fd0/d0/d5/d0;

!!HE-1&v998=79/y10=1:A79;
!!HE-1&v998=80/y11=1:A80;
!!HE-1&v998=81/y12=1:A81;
!!HE-1&v998=82/y13=1:A82;

*!SN&y91=4:W^Set_Sound_Orbs^/?y1;
*!SN&y91=4:W^Set_Sound_Orbs^/1;
*!FU(Set_Complete_Sound)&y1=0/y91=4:P;
*!FU(Set_Complete_Sound)&y91=4:P;

!?AE0|v998=79/v998=80/v998=81/v998=82; Unequip Artifact     !!FU&761:E;

!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92;
!!VRy91:-1;

!!HE-1&y91=2:Fd0/d0/d0/d-3;
!!HE-1&y91=3:Fd0/d0/d-5/d0;

*---------------------------------
*Moral and Luck*
!?AE1&1000; Equip Artifact         !!FU&761:E;

!!if|v998=49/v998=50/v998=51;          [Moral]
!!HE-1:A2/49/?y30/?y10;
!!HE-1&v998=49/y10=1:A-49;

!!HE-1:A2/50/?y31/?y11;
!!HE-1&v998=50/y11=1:A-50;

!!HE-1:A2/51/?y32/?y12;
!!HE-1&v998=51/y12=1:A-51;

!!HE-1&v998=49/y10=1:A49;
!!HE-1&v998=50/y11=1:A50;
!!HE-1&v998=51/y12=1:A51;
!!en;


!!if|v998=45/v998=46/v998=47/v998=48;  [Luck]
!!HE-1:A2/45/?y33/?y10;
!!HE-1&v998=45/y10=1:A-45;

!!HE-1:A2/46/?y30/?y11;
!!HE-1&v998=46/y11=1:A-46;

!!HE-1:A2/47/?y31/?y12;
!!HE-1&v998=47/y12=1:A-47;

!!HE-1:A2/48/?y32/?y13;
!!HE-1&v998=48/y13=1:A-48;

!!HE-1&v998=45/y10=1:A45;
!!HE-1&v998=46/y11=1:A46;
!!HE-1&v998=47/y12=1:A47;
!!HE-1&v998=48/y13=1:A48;
!!en;


!!if|v998=63/v998=64/v998=65;          [Eagle Eye]
!!HE-1:A2/63/?y30/?y10;
!!HE-1&v998=63/y10=1:A-63;

!!HE-1:A2/64/?y31/?y11;
!!HE-1&v998=64/y11=1:A-64;

!!HE-1:A2/65/?y32/?y12;
!!HE-1&v998=65/y12=1:A-65;

!!HE-1&v998=63/y10=1:A63;
!!HE-1&v998=64/y11=1:A64;
!!HE-1&v998=65/y12=1:A65;
!!en;

!?AE1&v998=138; !!FU&761:E;            [Wizards Well]
!!HE-1:Fd/d/d5/d;

*!FU(Set_Complete_Sound):P;

!?AE0&v998=138;               !!FU&761:E;
!!HE-1:Fd/d/d-5/d;



*---------------------------------
*Basilisk Venom Set*
!?AE1|v998=10/v998=15/v998=19/v998=27; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X9]

!!VRy90:+1;
!!HE-1&y90=2:Fd0/d0/d0/d2;              [With 3 Set pieces Increase spell power +3 wisdom +3]
!!HE-1&y90=3:Fd1/d1/d1/d1;              [With 4 Set pieces Increase attack +2]

*!FU(Set_Complete_Sound)&y90=3:P;

!?AE0|v998=10/v998=15/v998=19/v998=27; Unequip Artifact     !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X9]

!!VRy90:-1;
!!HE-1&y90=1:Fd0/d0/d0/d-2;             [Without 3 Set pieces decrease spell power -3 wisdom -3]
!!HE-1&y90=2:Fd-1/d-1/d-1/d-1;          [With 4 Set pieces Increase attack -2]

*---------------------------------
*Titan's Thunder Set*
!?AE1&v998=135; Equip Artifact     !!FU&761:E;

!!HE-1:Fd3/d3/d2/d2;                    [With 4 Set pieces Increase 3 3 2 2]

!?AE0&v998=135; Unequip Artifact   !!FU&761:E;

!!HE-1:Fd-3/d-3/d-2/d-2;                [With 4 Set pieces Decrease 3 3 2 2]

*---------------------------------
*Archdevil Suite Set*
!?AE1|v998=11/v998=17/v998=23/v998=29/v998=101; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X13]

!!VRy90:+1;
!!HE-1&y90=3:Fd1/d1/d1/d1;              [With 3 Set pieces Increase primary +1]
!!HE-1&y90=4:Fd2/d2/d0/d0;              [With 4 Set pieces Increase attack +2 and defense +2]


!?AE0|v998=11/v998=17/v998=23/v998=29/v998=101; Unequip Artifact    !!FU&761:E;
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X13]

!!VRy90:-1;
!!HE-1&y90=2:Fd-1/d-1/d-1/d-1;          [With 3 Set pieces Increase primary -1]
!!HE-1&y90=3:Fd-2/d-2/d0/d0;            [With 4 Set pieces Increase attack -2]

*---------------------------------
*Angelic Alliance Set*
!?AE1|v998=31/v998=32/v998=33/v998=34/v998=35/v998=36; !!FU&761:E; [Equip Artifact]
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X14]

!!VRy90:+1;
!!HE-1&y90=6:Fd2/d2/d2/d2;              [With 6 Set pieces Increase all +2]
!!HE-1&y90=5:R0/d1;                     [Add +1 Moral]



!?AE0|v998=31/v998=32/v998=33/v998=34/v998=35/v998=36; !!FU&761:E; [Unequip Artifact]
!!FU(Count_Set_Pieces):P-1/0/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X14]

!!VRy90:-1;
!!HE-1&y90=5:Fd-2/d-2/d-2/d-2;          [With 6 Set pieces decrease all -2]
!!HE-1&y90=4:R0/d-1;                    [Reduce +1 Moral]

*---------------------------------
*Battle Mage War Dress Set*
!?AE1|v998=7/v998=16/v998=100/v998=28/v998=21; Equip Artifact  !!FU&761:E;
!!FU(Count_Set_Pieces_2):P-1/?y90;      [Count Set Pieces function X2]

!!VRy90:+1;
!!HE-1&y90=3:Fd2/d2/d/d;                [With 6 Set pieces Increase all +2]
!!HE-1&y90=5:Fd2/d2/d2/d2;

*!FU(Set_Complete_Sound)&y90=5:P;


!?AE0|v998=7/v998=16/v998=100/v998=28/v998=21;; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces_2):P-1/?y90;      [Count Set Pieces function X2]

!!VRy90:-1;
!!HE-1&y90=2:Fd-2/d-2/d/d;              [With 6 Set pieces decrease all -2]
!!HE-1&y90=4:Fd-2/d-2/d-2/d-2;

*---------------------------------
*Scouting Set*
!?AE1|v998=52/v998=53; Equip Artifact       !!FU&761:E;

!!HE-1:A2/52/?y30/?y10;
!!HE-1&v998=52/y10=1:A-52;

!!HE-1:A2/53/?y31/?y11;
!!HE-1&v998=53/y11=1:A-53;


!!FU(Count_Set_Pieces_2):P-1/0/?y90;     [Count Set Pieces function X3]
!!VRy90:+1;

!!HE-1&y90=2/v998=52/y10=1/y30=1:Fd-1/d-1/d-1/d-1;
!!HE-1&y90=2/v998=53/y11=1/y31=1:Fd-1/d-1/d-1/d-1;
!!HE-1&y90=2/v998=52/y10=1/y30=2:Fd-1/d-1/d-1/d-1;
!!HE-1&y90=2/v998=53/y11=1/y31=2:Fd-1/d-1/d-1/d-1;

!!HE-1&y90=2:Fd1/d1/d1/d1;              [With 2 Set pieces Increase all +1]

!!HE-1&v998=52/y10=1:A52;
!!HE-1&v998=53/y11=1:A53;

*!FU(Set_Complete_Sound)&y90=2:P;

!?AE0|v998=52/v998=53; Unequip Artifact   !!FU&761:E;
!!FU(Count_Set_Pieces_2):P-1/0/?y90;     [Count Set Pieces function X3]
!!VRy90:-1;

!!HE-1&y90=1:Fd-1/d-1/d-1/d-1;

********************************************************************************
!?SN&1000;                              [Sound Trigger for Moral and Luck]

!!SN:S?z-7;
!!VRz-9:S^goodluck.82m^;
*!VRz8:S^GoodMrle.wav^;

*!if&z7=z9|z7=z8;
!!if&z-7=z-9;
!!FU(Count_Set_Pieces):P-1/?y90/?y91/?y92/?y93/?y94;
!!FU&y94<>4:E;
!!BG:Q?y1;

!!SN&y1=0/y94=4:W^Luck_Count_Att^/d10;  [Luck Count Attacker +1]
!!SN&y1=1/y94=4:W^Luck_Count_Def^/d10;  [Luck Count Attacker +1]

!!SN&y1=0/y94=4:W^Luck_Count_Att^/?y2;  [Luck Count Attacker +1]
!!SN&y1=1/y94=4:W^Luck_Count_Def^/?y2;  [Luck Count Attacker +1]

!!BA:Q?f;
!!IF&1000/f=0:L^Total Spell Damage Bonus: %Y2^;
*!SN&y1=0/z7=z8/y93=4:W^Moral_Count_Att^/1;           [Moral Count Attacker 1]
*!SN&y1=1/z7=z8/y93=4:W^Moral_Count_Def^/1;           [Moral Count Attacker 1]
!!en;

********************************************************************************
!?FU(Count_Set_Pieces);                 [Count Set Pieces Fkt]
x1=hero number, x2-15 returns set pieces

!!HEx1:A2/41/?y30/?y10;                 [Dragonbone Greaves]
!!HEx1:A2/42/?y30/?y11;                 [Dragon Wing Tabard]
!!HEx1:A2/43/?y30/?y12;                 [Necklace of Dragonteeth]
!!HEx1:A2/44/?y30/?y13;                 [Crown of Dragontooth]
!!HEx1:A2/39/?y30/?y14;                 [Dragon Scale Shield]
!!HEx1:A2/40/?y30/?y15;                 [Dragon Scale Armor]
!!VRy20&y10=1:+1;
!!VRy20&y11=1:+1;
!!VRy20&y12=1:+1;
!!VRy20&y13=1:+1;
!!VRy20&y14=1:+1;
!!VRy20&y15=1:+1;

!!VRx2:Sy20;                            [x2 Dragon Set]
*------------------

!!HEx1:A2/79/?y31/?y10;                 [Orb of Firmament]
!!HEx1:A2/80/?y32/?y11;                 [Orb of Silt]
!!HEx1:A2/81/?y33/?y12;                 [Orb of Tempestous fire]
!!HEx1:A2/82/?y34/?y13;                 [Orb of Driving rain]
!!VRy21&y10=1:+1;
!!VRy21&y11=1:+1;
!!VRy21&y12=1:+1;
!!VRy21&y13=1:+1;

!!VRx3:Sy21;                            [x3 Elementel Unity Set]
*------------------

!!HEx1:A2/86/?y30/?y10;                 [Tome of Fire]
!!HEx1:A2/87/?y30/?y11;                 [Tome of Air]
!!HEx1:A2/88/?y30/?y12;                 [Tome of Water]
!!HEx1:A2/89/?y30/?y13;                 [Tome of Earth]
!!VRy22&y10=1:+1;
!!VRy22&y11=1:+1;
!!VRy22&y12=1:+1;
!!VRy22&y13=1:+1;

!!VRx4:Sy22;                            [x4 Wizards Knowledge Set]
*------------------

!!HEx1:A2/49/?y30/?y10;                 [Badge of Courage]
!!HEx1:A2/50/?y31/?y11;                 [Crest of Valor]
!!HEx1:A2/51/?y32/?y12;                 [Glyph of Gallantry]
!!HEx1:A2/108/?y33/?y13;                [Pendant of Courage]
!!VRy23&y10=1:+1;
!!VRy23&y11=1:+1;
!!VRy23&y12=1:+1;
!!VRy23&y13=1:+1;

!!VRx5:Sy23;                            [x5 The Champion's Honor Set]
*------------------

!!HEx1:A2/45/?y30/?y10;                 [Still Eye of the Dragon]
!!HEx1:A2/46/?y31/?y11;                 [Clover of Fortune]
!!HEx1:A2/47/?y32/?y12;                 [Cards of Prophecy]
!!HEx1:A2/48/?y33/?y13;                 [Ladybird of Luck]
!!VRy24&y10=1:+1;
!!VRy24&y11=1:+1;
!!VRy24&y12=1:+1;
!!VRy24&y13=1:+1;

!!VRx6:Sy24;                            [x6 Adventures Fidelity Set]
*------------------

!!HEx1:A2/103/?y30/?y10;                [Pendant Of Life]
!!HEx1:A2/13/?y30/?y11;                 [Shield of the Dwarven Lords]
!!HEx1:A2/22/?y30/?y12;                 [Crown of the Supreme Magi]
!!HEx1:A2/25/?y30/?y13;                 [Breastplate of Petrified Wood]
!!HEx1:A2/9/?y30/?y14;                  [Greater Gnoll's Flail]
!!HEx1:A2/98/?y30/?y15;                 [Boots of Speed]
!!VRy25&y10=1:+1;
!!VRy25&y11=1:+1;
!!VRy25&y12=1:+1;
!!VRy25&y13=1:+1;
!!VRy25&y14=1:+1;
!!VRy25&y15=1:+1;

!!VRx7:Sy25;                            [x7 Priest of the Light Set]
*------------------

!!HEx1:A2/104/?y30/?y10;                [Pendant Of Death]
!!HEx1:A2/14/?y30/?y11;                 [Shield of the Yawning Dead]
!!HEx1:A2/20/?y30/?y12;                 [Skull Helmet]
!!HEx1:A2/26/?y30/?y13;                 [Rib Cage]
!!HEx1:A2/8/?y30/?y14;                  [Blackshard of the Dead Knight]
!!HEx1:A2/56/?y30/?y15;                 [Dead Man's Boots]
!!VRy26&y10=1:+1;
!!VRy26&y11=1:+1;
!!VRy26&y12=1:+1;
!!VRy26&y13=1:+1;
!!VRy26&y14=1:+1;
!!VRy26&y15=1:+1;

!!VRx8:Sy26;                            [x8 Priest of the Dark Set]
*------------------

!!HEx1:A2/10/?y30/?y10;                 [Ogre's Club of Havoc]
!!HEx1:A2/15/?y30/?y11;                 [Buckler of the Gnoll King]
!!HEx1:A2/19/?y30/?y12;                 [Helm of the Alabaster Unicorn]
!!HEx1:A2/27/?y30/?y13;                 [Scales of the Greater Basilisk]

!!VRy27&y10=1:+1;
!!VRy27&y11=1:+1;
!!VRy27&y12=1:+1;
!!VRy27&y13=1:+1;

!!VRx9:Sy27;                            [x9 Venom Set]
*------------------

!!HEx1:A2/57/?y30/?y10;                 [Garniture of Interference]
!!HEx1:A2/58/?y30/?y11;                 [Surcoat of Counterpoise]
!!HEx1:A2/59/?y30/?y12;                 [Boots of Polarity]


!!VRy28&y10=1:+1;
!!VRy28&y11=1:+1;
!!VRy28&y12=1:+1;


!!VRx10:Sy28;                           [x10 Resistance Set]
*------------------

!!HEx1:A2/97/?y30/?y10;                 [Necklace of Swiftness]
!!HEx1:A2/69/?y30/?y11;                 [Ring of the Wayfarer]
!!HEx1:A2/99/?y30/?y12;                 [Cape of Velocity]


!!VRy29&y10=1:+1;
!!VRy29&y11=1:+1;
!!VRy29&y12=1:+1;


!!VRx11:Sy29;                           [x11 Pegasus Harness]
*------------------

!!HEx1:A2/12/?y30/?y10;                 [Titan's Gladius ]
!!HEx1:A2/18/?y30/?y11;                 [Sentinel's Shield ]
!!HEx1:A2/24/?y30/?y12;                 [Thunder Helmet ]
!!HEx1:A2/30/?y30/?y13;                 [Titan's Cuirass ]

!!VRy40&y10=1:+1;
!!VRy40&y11=1:+1;
!!VRy40&y12=1:+1;
!!VRy40&y13=1:+1;

!!VRx12:Sy40;                           [x12 Titans Thunder]
*------------------

!!HEx1:A2/11/?y30/?y10;                 [Sword of Hellfire]
!!HEx1:A2/17/?y30/?y11;                 [Shield of the Damned]
!!HEx1:A2/23/?y30/?y12;                 [Hellstorm Helmet]
!!HEx1:A2/29/?y30/?y13;                 [Breastplate of Brimstone]
!!HEx1:A2/101/?y30/?y14;                [Pendant of Second Sight]

!!VRy41&y10=1:+1;
!!VRy41&y11=1:+1;
!!VRy41&y12=1:+1;
!!VRy41&y13=1:+1;
!!VRy41&y14=1:+1;

!!VRx13:Sy41;                           [x13 Archdevils Suite Set]
*------------------

!!HEx1:A2/31/?y30/?y10;                 [Armor of Wonder]
!!HEx1:A2/32/?y30/?y11;                 [Sandals of the Saint]
!!HEx1:A2/33/?y30/?y12;                 [Celestial Necklace of Bliss]
!!HEx1:A2/34/?y30/?y13;                 [Lion's Shield of Courage]
!!HEx1:A2/35/?y30/?y14;                 [Sword of Judgement]
!!HEx1:A2/36/?y30/?y15;                 [Helm of Heavenly Enlightenment]
!!VRy42&y10=1:+1;
!!VRy42&y11=1:+1;
!!VRy42&y12=1:+1;
!!VRy42&y13=1:+1;
!!VRy42&y14=1:+1;
!!VRy42&y15=1:+1;

!!VRx14:Sy42;                           [x14 Angelic Alliance Set]
*------------------

!!HEx1:A2/63/?y30/?y10;                 [Garniture of Interference]
!!HEx1:A2/64/?y30/?y11;                 [Surcoat of Counterpoise]
!!HEx1:A2/65/?y30/?y12;                 [Boots of Polarity]


!!VRy43&y10=1:+1;
!!VRy43&y11=1:+1;
!!VRy43&y12=1:+1;


!!VRx15:Sy43;                           [x15 Resistance Set]
*------------------
!?FU(Count_Set_Pieces_2);               [Count Set Pieces]

!!HEx1:A2/7/?y30/?y10;                  [Axe]
!!HEx1:A2/16/?y30/?y11;                 [Ogre]
!!HEx1:A2/100/?y30/?y12;                [Pendant of Dispassion]
!!HEx1:A2/28/?y30/?y13;                 [Tunic of the Cyclops King]
!!HEx1:A2/21/?y30/?y14;                 [Helm of Chaos]

!!VRy42&y10=1:+1;
!!VRy42&y11=1:+1;
!!VRy42&y12=1:+1;
!!VRy42&y13=1:+1;
!!VRy42&y14=1:+1;

!!VRx2:Sy42;                            [x2 Battle Mage War Dress Set]

*------------------
!!HEx1:A2/52/?y30/?y10;                 [Speculum]
!!HEx1:A2/53/?y30/?y11;                 [Spyglass]

!!VRy43&y10=1:+1;
!!VRy43&y11=1:+1;

!!VRx3:Sy43;                            [x3 Scouting Set]

*------------------
!!HEx1:A2/163/?y30/?y10;                [Shield]
!!HEx1:A2/168/?y30/?y11;                [Surcoat]
!!HEx1:A2/165/?y30/?y12;                [Ring]

!!VRy44&y10=1:+1;
!!VRy44&y11=1:+1;
!!VRy44&y12=1:+1;

!!VRx4:Sy44;                            [x4 Warrior Set]

*------------------
!!HEx1:A2/161/?y30/?y10;                [Helmet]
!!HEx1:A2/162/?y30/?y11;                [Sword]
!!HEx1:A2/169/?y30/?y12;                [Boots]

!!VRy45&y10=1:+1;
!!VRy45&y11=1:+1;
!!VRy45&y12=1:+1;

!!VRx5:Sy45;                            [x5 Mage Set]

*------------------
!!HEx1:A2/164/?y30/?y10;                [Horned Ring]
!!HEx1:A2/166/?y30/?y11;                [Neck Broach]
!!HEx1:A2/167/?y30/?y12;                [Armor]

!!VRy46&y10=1:+1;
!!VRy46&y11=1:+1;
!!VRy46&y12=1:+1;

!!VRx6:Sy46;                            [x6 Adventurer Set]

*------------------
!!HEx1:A2/63/?y30/?y10;                 [Bird of Perception]
!!HEx1:A2/64/?y30/?y11;                 [Stoic Watchman]
!!HEx1:A2/65/?y30/?y12;                 [Emblem of Cognizance]

!!VRy47&y10=1:+1;
!!VRy47&y11=1:+1;
!!VRy47&y12=1:+1;

!!VRx7:Sy47;                            [x6 Eagle Eye Set Vision of the Eagle]


*--------------------------------------------------------------------Play Sound when Set completed-------------------------------------------------------------------------*
!?FU(Set_Complete_Sound)&1000;

!!FU:E;
!!SN:W^Set_Sound_Timer^/?y1;
!!SN:W^Play_Sound_Trigger^/?y2;
!!SN:W^Play_Sound_Trigger2^/?y3;
*!IF:M^y1 is %Y1 und y2 is %Y2^;
*!FU|y1=0/y2=0/y3=0:E;
*!VRz1:S^51heroism03.wav^;
!!VRz1:S^DF106c.wav^;
!!SN:Pz1;
*SN:W^Set_Sound_Timer^/0;  Deactivate Sound Trigger
*SN:W^Play_Sound_Trigger^/0;
*SN:W^Play_Sound_Trigger2^/0;

*?TL2;
*SN:W^Set_Sound_Timer^/1; Activate again after 2 seconds

*?AE1; Equip Artifact
*!IF:M^Equip v998 is%V998 und v999 is%V999^;
*SN:W^Play_Sound_Trigger^/1;

*?AE0; Unequip Artifact
*!IF:M^Unequip v998 is%V998 und v999 is%V999^;
*!SN:W^Play_Sound_Trigger^/0;

*?CM2&1000;
*CM:F?v3 I?v4 S?v5; where we click and click subtype
*FU&v5<>12:E;
*SN&v4<40|v4>45:W^Play_Sound_Trigger2^/1;
*SN&v4>=40/v4<=44:W^Play_Sound_Trigger2^/0;

*--------------------------------------------------------------------Give Bonus Extra Abilities----------------------------------------------------------------------------*
!?FU(AC_Function_58);                   [Function for giving extra abilities]

!!BMx16:T?y1;
!!VRy2:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy2:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA thx Sal]

!!if&y1>=0/y1<=144;

!!if&x2=1;                             [Titans Lightning Cast 25% Chance with Set]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/107/57/25/25/25/25/25/25/25/25/25/25/25; [Battle Monster]
!!en;

!!if&x2=3;                             [Double Strike with Set]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/68/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&x2=4;                             [Fearless with Moral Set]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/102/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]

!!MA:Ly1/?y5;
!!if&y5=0;                             [If Monster level 1 give Champion Charge]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/99/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;
!!en;
!!en;


************************Spell Count Eagle Eye***********************************
!?FU(AC_Function_61);

!!HEx1:Mx16/?y1;
!!SN&y1=1/x2=1:W^Attacker_Eagle_Eye_Spells^/d+1;
!!SN&y1=1/x2=2:W^Defender_Eagle_Eye_Spells^/d+1;


************************Archdevil Suite Pick Random Stack***********************
**FU(AC_Function_55):Px1/?y2;  /0/return a random enemy stack
!?FU(AC_Function_55);
**x1=current side(0-1)
**x2=random enemy stack
!!VRv8:C0/0/0;
!!DO(AC_Function_52)/21/41/1&x1=0:P-1;  [v8]
!!DO(AC_Function_52)/0/20/1&x1=1:P-1;
!!FU&v8<1:E;
!!VRy1:S1Tv8;
!!VRy1&y1>v8:Sv8;
!!DO(AC_Function_52)/21/41/1&x1=0:P-2/y1;[v9v10]
!!DO(AC_Function_52)/0/20/1&x1=1:P-2/y1;
!!FU&v10<0:E;
!!VRx2:Sv10;
!!VRv8:C0/0/0;

!?FU(AC_Function_52)&x1=-1;
!!BMx16:T?y10 N?y11;
!!FU&y10>144/y10<150:E;                 [exclude war machines]
!!FU|y10=124/y11<1:E;
!!VRv8:+1;

!?FU(AC_Function_52)&x1=-2;
!!BMx16:T?y10 N?y11;
!!FU&y10>144/y10<150:E;
!!FU|y10=124/y11<1:E;
!!FU&v9=x2:E;
!!VRv9:+1;
!!VRv10:Sx16;


************************Angelic Alliance Set Piece******************************
!?FU(AC_Function_59);                   [increase HP and Speed]

!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:H?y1;
!!VRy1:*x1:100;
!!BMx16:Hy1 Sdx2;

************************Scouting Set Piece**************************************
!?FU(AC_Function_60);                   [increase Units Stats]

!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]

!!SN:W^Prepare_For_Battle_Bonus^/?y10;

!!if&x1=1;                             [Attack]
!!BMx16:Ady10;
!!en;

!!if&x1=2;                             [Defense]
!!BMx16:Ddy10;
!!en;

!!if&x1=3;                             [Health]
!!VRy10:+100;
!!BMx16:H?y1;
!!VRy1:*y10:100;
!!BMx16:Hy1;
!!en;

!!if&x1=4;                             [Speed]
!!BMx16:Sdy10;
!!en;

************************Statue of Legion Set Piece******************************
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1;
!!OW:C?y1;
!!DO(AC_Function_53)/0/155/1:Py1;

!?FU(AC_Function_53);
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!HEx16:A2/133/?y30/?y10;               [Statue of Legion]
!!DO(AC_Function_54)/0/6/1&y10>0:Px16;

!?FU(AC_Function_54);
!!HEx1:C0/x16/?y1/?y2;
!!FU|y2<1/y1<0:E;
!!MA:Xy1/?y3;
!!VRy3:&16;
!!FU&y3=0:E;
!!VRy3:Sy2 *103 :100 -y2;
!!HEx1:C0/x16/d/dy3/0/0;


****************************************************************************************************



                     New Artifact and Sets Section




****************************************************************************************************

********************************************************************************
*Horn of Magic Energy
!?AE1&v998=170; Equip Artifact 170      !!FU&761:E;
!!HE-1:Fd0/d0/d3/d3;                    [Increase spell power +3 wisdom +3]

!?AE0&v998=170; Unequip Artifact 170    !!FU&761:E;
!!HE-1:Fd0/d0/d-3/d-3;                  [Decrease spell power -3 wisdom -3]

********************************************************************************
*Full Helmet of the commander
!?AE1&v998=161; Equip Artifact 161     !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;

!?AE0&v998=161; Unequip Artifact 161   !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;

*of the commanders artifacts* 161 Helmet, 163 Round Shield, 166 Necklace and combination sets
!?BF;
!!BA:H0/?y1 H1/?y2;
!!HEy1:A2/161/?y3/?y4 A2/163/?y3/?y5 A2/166/?y3/?y6;
!!FU(Count_Set_Pieces_2):Py1/0/0/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy51:S100; !!VRy51&y4=1:+20; !!VRy51&y5=1:+20; !!VRy51&y6=1:+20; !!VRy51&y90>=2:+20; !!VRy51&y91>=2:+20; !!VRy51&y92>=2:+20;
*!IF:M^y4 is%Y4 y5 is%Y5 y6 is%Y6 y90 is%Y90 y91 is%Y91 y92 is%Y92 aaaand y51 is%Y51^;
!!DO(AC_Function_33)/0/20/1&y51>100:P0/0/0/y51/y51; [Pass  Health and Damage]

!!FU&y2<0:E;
!!HEy2:A2/161/?y3/?y4 A2/163/?y3/?y5 A2/166/?y3/?y6;
!!FU(Count_Set_Pieces_2):Py2/0/0/?y90/?y91/?y92; [Count Set Pieces function]
!!VRy51:S100; !!VRy51&y4=1:+20; !!VRy51&y5=1:+20; !!VRy51&y6=1:+20; !!VRy51&y90>=2:+20; !!VRy51&y91>=2:+20; !!VRy51&y92>=2:+20;
!!DO(AC_Function_33)/21/41/1&y51>100:P0/0/0/y51/y51; [Pass  Health and Damage]





********************************************************************************
*Noble Ring of Quicksand 164
!?AE1&v998=164; Equip Artifact 164     !!FU&761:E;
!!HE-1:Fd1/d0/d1/d0;                    [Increase all primary skills by +1]

!?AE0&v998=164; Unequip Artifact 164    !!FU&761:E;
!!HE-1:Fd-1/d0/d-1/d0;                  [Decrease all primary skills by -1]


******************
*of Quicksand modifier
Boots of Quicksand 169
Noble Ring of Quicksand 164
Glittering Surcoat of Quicksand 168
!?BF;
!!BA:H0/?y1 H1/?y2;
!!HEy1:A2/164/?y3/?y4 A2/169/?y3/?y5 A2/168/?y3/?y6;
!!DO(AC_Function_64)/21/41/1&y4=1:P;
!!DO(AC_Function_64)/21/41/1&y5=1:P;
!!DO(AC_Function_64)/21/41/1&y6=1:P;

!!FU&y2<0:E;
!!HEy2:A2/164/?y3/?y4 A2/169/?y3/?y5 A2/168/?y3/?y6;
!!DO(AC_Function_64)/0/20/1&y4=1:P;
!!DO(AC_Function_64)/0/20/1&y5=1:P;
!!DO(AC_Function_64)/0/20/1&y6=1:P;

!?FU(AC_Function_64);
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:S?y1;
!!VRy2:Sy1-1;
!!VRy2&y2<1:S1;
!!BMx16:Sy2;

********************************************************************************
*Crystal Ring of Magic 165
!?AE1&v998=165; Equip Artifact 165     !!FU&761:E;
!!HE-1:Fd-1/d-1/d6/d0;

!?AE0&v998=165; Unequip Artifact 165    !!FU&761:E;
!!HE-1:Fd1/d1/d-6/d0;


********************************************************************************
*Boots of Quicksand 169
!?AE1&v998=169; Equip Artifact 169     !!FU&761:E;
!!HE-1:Fd1/d1/d0/d0;

!?AE0&v998=169; Unequip Artifact 169    !!FU&761:E;
!!HE-1:Fd-1/d-1/d0/d0;


********************************************************************************
*Precious Longsword 162 +1damage for all troops

!?AE1&v998=162; Equip artifact    !!FU&761:E;
!!HE-1:Fd7/d-2/d-2/d-2;

!?AE0&v998=162; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-7/d2/d2/d2;

!?BF;
!!BA:H0/?y1 H1/?y2;
!!HEy1:A2/162/?y3/?y4;
!!DO(AC_Function_13)/0/20/1&y4=1:P0/0/1;

!!FU&y2<0:E;
!!HEy2:A2/162/?y3/?y4;
!!DO(AC_Function_13)/21/41/1&y4=1:P0/0/1;

********************************************************************************
*Round Shield of the commander 163 +2 defense +50 flat damage block

!?AE1&v998=163; Equip artifact    !!FU&761:E;
!!HE-1:Fd0/d2/d0/d0;

!?AE0&v998=163; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd0/d-2/d0/d0;

!?MF1;                                  [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if|y1=6/y1=7;                        [Attack or Shoot]

!!MF:N?y4;                              [damage receiving stack]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]
!!HEy99:A2/163/?y3/?y4;
!!FU&y4=0:E;                            [Exit if no Shield equipped]
!!MF:F?y6;                              [Damage Dealt]
!!VRy8:S50;                             [Shield Strength 50]

!!if&y8>=y6;
!!MF:E0;
!!MF:F0;
!!en;

!!if&y6>y8;                            [do if damage is bigger than shield]
!!VRy7:Sy6-y8;
!!MF:Fy7;
!!en;
!!en;
!!en;

********************************************************************************
*Kings Necklace of the commander 166

!?AE1&v998=166; Equip artifact    !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;

!?AE0&v998=166; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;


********************************************************************************
*Glittering Surcoat of Quicksand 168    When equipped, this sparkling Surcoat reduces the speed of all enemies by 1 and gives you +1 Luck and Moral
!?AE1&v998=168; Equip Artifact 168    !!FU&761:E;
!!HE-1:R0/d1;                           [Add +1 Moral]
!!HE-1:R1/d1;                           [Add +1 Luck]

!?AE0&v998=168; Unequip Artifact 168      !!FU&761:E;
!!HE-1:R0/d-1;                          [Remove -1 Moral]
!!HE-1:R1/d-1;                          [Remove -1 Moral]

!?FU(OnAfterBattleUniversal);           [After any battle]
!!BA:H0/?y95;                           [Check who the left hero was]
!!BA:H1/?y96;                           [Check who the right hero was]
!!HEy95:A2/168/?y1/?y2;                 [Check if the left hero still has the Surcoat (he might have lost it in the battle)]
!!HEy96&y96>=0:A2/168/?y3/?y4;          [Do the same for the right hero, but only if it was a hero (and not just creatures)]
!!HEy95&y1>0:R0/d1 R1/d1;               [Give morale and Luck bonuses]
!!HEy96&y3>0/y96>=0:R0/d1 R1/d1;


********************************************************************************
*Royal Armor 167 +10% HP for all

!?AE1&v998=167; Equip artifact    !!FU&761:E;
!!HE-1:Fd-1/d-1/d-1/d-1;

!?AE0&v998=167; Unequip Artifact   !!FU&761:E;
!!HE-1:Fd1/d1/d1/d1;

!?BF;
!!BA:H0/?y98;
!!HEy98:A2/167/?y1/?y10;
!!DO(AC_Function_65)/0/20/1&y10=1:P;

!!BA:H1/?y99;
!!FU&y99<0:E;
!!HEy99:A2/167/?y1/?y10;
!!DO(AC_Function_65)/21/41/1&y10=1:P;

!?FU(AC_Function_65);                   [increase HP by 10%]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:H?y1;
!!VRy1:*110:100;
!!BMx16:Hy1;


********************************************************************************
*After every fight there is a 2% chance for class sets*
*Class Sets cannot be found by Hybrid Classes*
*Finding a class set requires >level 20
*There are certain ways to increase your chance of finding one*

!?FU(OnAfterBattleUniversal)&1000;
!!BA:H0/?y1;
!!HEy1:O?y2;                            [get owner ]
!!OW:C?y4;                              [get current player]
!!FU&y2<>y4:E;                          [exit if not current player's hero]
!!OW:Iy4/?y88;
!!FU&y88=1:E;                           [Exit if AI]
!!HEy1:E?y15/?y16/1;                    [Get Hero Level]

!!FU(Class_Artifacts_Reward)&y16>=20:Py1;[Run only if level 20 or higher]


!?FU(Class_Artifacts_Reward);
!!SN:W^Master_Warrior_Hero%X1^/?y10;
!!SN:W^Master_Mage_Hero%X1^/?y11;
!!SN:W^Master_Adventurer_Hero%X1^/?y12;

!!SN:W^Battle_Commander_On^/?y50;       [Check if Battle Commander was active]
!!SN:T^AC_Misc.Class Sets^/?z2;
!!HEx1:A2/47/?y59/?y60;                 [47 Cards of Prophecy +1]
!!FU(Count_Set_Pieces):Px1/0/0/0/0/?y95;[Check for The Adventures Fidelity]
*Set the class check to true so all sets can be found if full set is worn*

*Warrior
!!if&y10=1/y11=0/y12=0|y95=4;          [Run if only Warrior and no Hybrid Class]
!!SN:W^Grandmaster_Warrior_Hero%X1^/?y20;
!!VRy99:S0T99;                          [Random Roll]
!!VRy99&y20=1:+1;                       [Double Chance for Grandmaster Ranks]
!!VRy99&y50=1:+1;                       [Double Chance if Battle Commander was active]
!!VRy99&y60=1:+1;                       [Extra chance with 47 Cards of Prophecy]

!!SN:W^161_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/161/1/z2;                     [Show Message with Artifact]
!!HEx1:A161;                            [Give Artifact to Hero]
!!SN:W^161_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;                                 [Exit so only one artifact is given per battle]
!!en;

!!SN:W^162_Class_Artifact_Hero%X1^/?y30;
!!if&y99>=98/y30=0;
!!IF:Q2/8/162/1/z2;                     [Show Message with Artifact]
!!HEx1:A162;                            [Give Artifact to Hero]
!!SN:W^162_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;                                 [Exit so only one artifact is given per battle]
!!en;

!!SN:W^169_Class_Artifact_Hero%X1^/?y30;
!!if&y99>=98/y30=0;
!!IF:Q2/8/169/1/z2;                     [Show Message with Artifact]
!!HEx1:A169;                            [Give Artifact to Hero]
!!SN:W^169_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;                                 [Exit so only one artifact is given per battle]
!!en;
!!en;


*Mage
!!if&y10=0/y11=1/y12=0|y95=4;          [Run if only Mage and no Hybrid Class]
!!SN:W^Grandmaster_Mage_Hero%X1^/?y20;
!!VRy99:S0T99;                          [Random Roll]
!!VRy99&y20=1:+1;                       [Double Chance for Grandmaster Ranks]
!!VRy99&y50=1:+1;                       [Double Chance if Battle Commander was active]
!!VRy99&y60=1:+1;                       [Extra chance with 47 Cards of Prophecy]


!!SN:W^163_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/163/1/z2;                     [Show Message with Artifact]
!!HEx1:A163;                            [Give Artifact to Hero]
!!SN:W^163_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^168_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/168/1/z2;                     [Show Message with Artifact]
!!HEx1:A168;                            [Give Artifact to Hero]
!!SN:W^168_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^165_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/165/1/z2;                     [Show Message with Artifact]
!!HEx1:A165;                            [Give Artifact to Hero]
!!SN:W^165_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;
!!en;


*Adventurer
!!if&y10=0/y11=0/y12=1|y95=4;          [Run if only Adventurer and no Hybrid Class]
!!SN:W^Grandmaster_Adventurer_Hero%X1^/?y20;
!!VRy99:S0T99;                          [Random Roll]
!!VRy99&y20=1:+1;                       [Double Chance for Grandmaster Ranks]
!!VRy99&y50=1:+1;                       [Double Chance if Battle Commander was active]
!!VRy99&y60=1:+1;                       [Extra chance with 47 Cards of Prophecy]

!!SN:W^164_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/164/1/z2;                     [Show Message with Artifact]
!!HEx1:A164;                            [Give Artifact to Hero]
!!SN:W^164_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^166_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/166/1/z2;                     [Show Message with Artifact]
!!HEx1:A166;                            [Give Artifact to Hero]
!!SN:W^166_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;

!!SN:W^167_Class_Artifact_Hero%X1^/?y30;[Check if Artifact has already been given to that Hero]
!!if&y99>=98/y30=0;
!!IF:Q2/8/167/1/z2;                     [Show Message with Artifact]
!!HEx1:A167;                            [Give Artifact to Hero]
!!SN:W^167_Class_Artifact_Hero%X1^/1;   [Set flag to true if Artifact has already been given to that Hero]
!!FU:E;
!!en;
!!en;


*---------------------------------
!?AE1&1000;                             [Equip Artifact]
!!FU&761:E;
!!if|v998=161/v998=162/v998=169;       [*Warrior Set*]
!!FU(Count_Set_Pieces_2):P-1/0/0/0/?y90;   [Count Set Pieces function X5]          [Count Set Pieces function]
!!VRy90:+1;
!!HE-1&y90=3:Fd3/d3/d3/d3;
!!en;


!!if|v998=163/v998=168/v998=165;       [*Mage Set*]
!!FU(Count_Set_Pieces_2):P-1/0/0/?y90;    [Count Set Pieces function X4]          [Count Set Pieces function]
!!VRy90:+1;
!!HE-1&y90=3:Fd3/d3/d3/d3;
!!en;

!!if|v998=164/v998=166/v998=167;       [*Adventurer Set*]
!!FU(Count_Set_Pieces_2):P-1/0/0/0/0/?y90;  [Count Set Pieces function X6]          [Count Set Pieces function]
!!VRy90:+1;
!!HE-1&y90=3:Fd3/d3/d3/d3;
!!en;


!?AE0&1000;                             [Unequip Artifact]
!!FU&761:E;
!!if|v998=161/v998=162/v998=169;       [*Warrior Set*]
!!FU(Count_Set_Pieces_2):P-1/0/0/0/?y90;   [Count Set Pieces function X5]
!!VRy90:-1;
!!HE-1&y90=2:Fd-3/d-3/d-3/d-3;
!!en;


!!if|v998=163/v998=168/v998=165;       [*Mage Set*]
!!FU(Count_Set_Pieces_2):P-1/0/0/?y90;    [Count Set Pieces function X4]
!!VRy90:-1;
!!HE-1&y90=2:Fd-3/d-3/d-3/d-3;
!!en;

!!if|v998=164/v998=166/v998=167;       [*Adventurer Set*]
!!FU(Count_Set_Pieces_2):P-1/0/0/0/0/?y90;  [Count Set Pieces function X6]
!!VRy90:-1;
!!HE-1&y90=2:Fd-3/d-3/d-3/d-3;
!!en;
*---------------------------------

!?FU(OnAfterBattleUniversal)&1000;
*Increase Class Set counter
!!BA:H0/?y1;                            [Attacking Hero]
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!FU&y5<>y9:E;                          [Exit if Hero Owner Changed after Battle]
!!FU(Count_Set_Pieces_2):Py1/0/0/?y91/?y90/?y92; [Check for  Sets]

!!HEy1:E?y47/?y48/1;                    [Check hero Level]
!!SN&y90=3:W^Warrior_Set_Count_Hero%Y1^/?y10;
!!SN&y90=3/y10<y48:W^Warrior_Set_Count_Hero%Y1^/d+1; [+1%  if Battle won with Set equipped and value smaller Hero Level]

!!SN&y91=3:W^Mage_Set_Count_Hero%Y1^/?y11;
!!SN&y91=3/y11<y48:W^Mage_Set_Count_Hero%Y1^/d+1; [+1%  if Battle won with Set equipped]

!!SN&y92=3:W^Adventurer_Set_Count_Hero%Y1^/?y12;
!!SN&y92=3/y12<y48:W^Adventurer_Set_Count_Hero%Y1^/d+1; [+1%  if Battle won with Set equipped]


!?FU(OnAfterBattleUniversal)&1000;
*Ammo Cart provides +2 SP after every combat and 19 Helm of the Alabaster Unicorn also +2
!!BA:H0/?y1;                            [Attacking Hero]
!!HEy1:O?y9;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!FU&y5<>y9:E;                          [Exit if Hero Owner Changed after Battle]
!!HEy1:A2/5/?y3/?y2;                    [Check if the left hero has Ammo Cart]
!!HEy1:A2/19/?y3/?y4;                   [Check if the left hero has 19 Helm of the Alabaster Unicorn ]
!!FU&y2=0/y4=0:E;                       [Exit if no Ammo Cart and no Helm]
!!FU(Intelligence_Set_Spell_Points)&y1>=0/y1<=155:Py1/0/?y30/1; [Return Max possible spell points for left Hero]
!!HEy1:I?y8/1;
!!VRy9:Sy8;
!!SN:W^Ammo_Replensih_SP_%Y1^/?y11;
!!VRy8&y11=1:+2;                        [+2 Spell Points for Ammo Cart Upgrade]
!!HEy1&y8<y30/y11=1:Id2/1;
!!VRy8&y2=1:+2;                         [+2 Spell Points for Ammo Cart]
!!HEy1&y8<y30/y2=1:Id2/1;
!!VRy8&y4=1:+2;                         [+2 Spell Points for Helm]
!!HEy1&y8<y30/y4=1:Id2/1;
!!HEy1&y8>y30:Iy30/1;
!!HEy1&y9>y30:Iy9/1;


*******************************
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1; [Trigger each monday]
!!OW:C?y1;
!!DO(AC_Function_44)/0/155/1:Py1;       [Pendant of Total recall]

!?FU(AC_Function_44);
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!HEx16:A2/107/0/?y2;
!!HEx16:B0/?z-1;
!!SN&y2=1/1000:T^AC_Misc.Pendant_of_Recall^/?z-1;
!!IF&y2=1/1000:Q1/17/1000/1^%Z-1^;
!!HEx16&y2=1:Ed1000;                    [give 1000 experience each week]

*******************************
!?BF;                                   [Combat Start]
*Pendant of Dispassion increases damage by 1 of equipped
!!BA:H0/?y2;                            [Attacker]
!!HEy2:A2/100/0/?y3;                    [100 Pendant of Dispassion]
!!DO(AC_Function_41)/0/20/1&y3>0:P;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:A2/100/0/?y3;                    [100 Pendant of Dispassion]
!!DO(AC_Function_41)/21/41/1&y3>0:P;


!?FU(AC_Function_41);                   [increase Units Stats]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148:E;
!!BMx16:U1/d1;                          [1 Min Damage every fight]
!!BMx16:U2/d1;                          [1 Max Damage every fight]

*******************************
!?BF;                                   [Combat Start]
*103 Pendant of Life
*104 Pendant of Death   +1 Att/Def/Speed for Undead
!!BA:H0/?y2;                            [Attacker]
!!HEy2:A2/103/0/?y3 A2/104/0/?y4;
!!DO(AC_Function_42)/0/20/1&y3=1:P1;
!!DO(AC_Function_42)/0/20/1&y4=1:P2;

!!BA:H1/?y4;                            [Defender]
!!FU&y4<0:E;
!!HEy4:A2/103/0/?y3 A2/104/0/?y4;
!!DO(AC_Function_42)/21/41/1&y3=1:P1;
!!DO(AC_Function_42)/21/41/1&y4=1:P2;


!?FU(AC_Function_42);                   [increase Units Stats]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148:E;
!!if&x1=1;                             [Alive]
!!BMx16:F?i;
!!VRi:&16;                              [just look at alive bit]
!!BMx16&i>0:Hd2;
!!en;

!!if&x1=2;                             [Undead]
!!BMx16:F?i;
!!VRi:&262144;                          [just look at undead bit]
!!BMx16&i>0:Ad1;
!!BMx16&i>0:Dd1;
!!BMx16&i>0:Sd1;
!!en;

*******************************
Life Artifacts +2%, +4%, +6%
94 Ring of Vitality
95 Ring of Life
96 Vial of Lifeblood

!?BF;
!!BA:H0/?y98;
!!HEy98:A2/94/?y1/?y10 A2/95/?y1/?y11 A2/96/?y1/?y12;
!!VRy13:S100;
!!VRy13&y10=1:+2; !!VRy13&y11=1:+4; !!VRy13&y12=1:+6;
!!DO(AC_Function_66)/0/20/1&y13>0:Py13;

!!BA:H1/?y99;
!!FU&y99<0:E;
!!HEy99:A2/94/?y1/?y10 A2/95/?y1/?y11 A2/96/?y1/?y12;
!!VRy13:S100;
!!VRy13&y10=1:+2; !!VRy13&y11=1:+4; !!VRy13&y12=1:+6;
!!DO(AC_Function_66)/21/41/1&y13>100:Py13;

!?FU(AC_Function_66);                   [increase HP by]
!!BMx16:T?y1;
!!FU|y1=145/y1=146/y1=147/y1=148/y1=149:E; [Execlude Warmachines]
!!BMx16:F?i;
!!VRi:&16;                              [just look at alive bit] 262144]
!!if&i>0;
!!BMx16:H?y1;
!!VRy1:*x1:100;
!!BMx16:Hy1;
!!en;
*******************************

!?MF1;
* 102 Pendant of Holiness cast Curse with Attacks
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Holiness_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Holiness_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/102/0/?y81;                  [100 Pendant of Dispassion]
!!FU&y81=0:E;

!!VRy20:S0T99;                          [20% chance to cast curse on Attacks]
!!BMy4:F?i;
!!VRi:&262144;                          [just look at undead bit]
!!if&y20<20/1000/i=0;                  [Only apply if alive]
!!BA:Q?j;
!!BMy4:M42/2/3;
!!BMy4&j=0/1000:V40;                    [Show Curse Animation]
!!VRz-1&j=0/1000:S^CURSE^;
!!SN&j=0/1000:Pz-1;                     [Play Curse Sound if not Quick Comabat]
!!en;
!!en;
!!en;

!?MF1;
* 102 Pendant of Free Will  cast Hypnotize with Attacks
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Will_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Will_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/105/?y80/?y81;               [105 Pendant of Free Will]
!!FU&y81=0:E;

!!BG:A?y60;
!!VRy61:S130;
!!VRy61&y60=7:S180;                     [if shooting]
!!VRy20:S0Ty61;                         [5% chance to cast Hypnotize on melee Attacks and 3% at ranged attacks]
!!FU&y20>6:E;

!!BMy4:F?i;                             [Get Monster Flag]
!!VRi:&1024;                            [1024 Mind Spell Immunity]
!!FU&i>0:E;                             [Exit if creature is Mind Immune]

!!BA:Q?j;
!!BMy4:M60/1/3;
!!BMy4&j=0/1000:V21;                    [Show Hypnotize Animation]
!!VRz-1&j=0/1000:S^HYPNOTIZ^;
!!SN&j=0/1000:Pz-1;                     [Play Curse Sound if not Quick Comabat]
!!en;
!!en;

!?MF1;
*Bow of Elven Cherrywood increases any ranged damage by 4*Hero level damage points
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>7:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Cherry_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Cherry_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/60/?y80/?y81;                [60 Bow of Elven Cherrywood]
!!FU&y81=0:E;
!!HEy99:E?y7/?y8/1;
!!MF:F?y6;
!!VRy7:S4*y8+y6;
!!MF:Fy7;


!?MF1;                                  [*Physical Combat *]
*Armor of Wonders reduces any ranged damage by 20+2*HLvL points
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=7;                             [or Shoot]
  !!MF:N?y4;                              [damage receiving stack]
  !!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;                           [Exit if no Hero]
  !!BMy4:F?y78;                           [read flags]
  !!VRy78:&4194304;                       [just look summoned bit]
  !!FU&y78>0:E;                           [Exit if cloned or summoned]
  !!HEy99:A2/31/?y3/?y4;                  [31 Armor of Wonder]
  !!FU&y4=0:E;                            [Exit if no Shield equipped]
  !!MF:F?y6;                              [Damage Dealt]
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+20;                           [Armor Strength 20+2*Hero Level]
!!if&y8>=y6;
  !!MF:E0;
  !!MF:F0;
!!en;

!!if&y6>y8;                            [do if damage is bigger than shield]
  !!VRy7:Sy6-y8;
  !!MF:Fy7;
!!en;
!!en;

!?MF1;                                  [*Physical Combat *]
*25 Breastplate of Petrified Wood reduces any melee damage by 15+2*HLvL points
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [melee Damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6;                             [or melee]
  !!MF:N?y4;                              [damage receiving stack]
  !!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
  !!BA:Hy5/?y99;
  !!FU&y99<0:E;                           [Exit if no Hero]
  !!BMy4:F?i;                             [read flags]
  !!VRi:&4194304;                         [just look summoned bit]
  !!FU&i>0:E;                             [Exit if cloned or summoned]
  !!HEy99:A2/25/?y3/?y4;                  [25 Breastplate of Petrified Wood]
  !!FU&y4=0:E;                            [Exit if no Shield equipped]
  !!MF:F?y6;                              [Damage Dealt]
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+15;                           [Armor Strength 15+2*Hero Level]
!!if&y8>=y6;
  !!MF:E0;
  !!MF:F0;
!!en;

!!if&y6>y8;                            [do if damage is bigger than shield]
  !!VRy7:Sy6-y8;
  !!MF:Fy7;
!!en;
!!en;


!?MF1;
*Blackshard of the Dead Knight deals extra 25+2*HLvL to any living unit
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Blackshard_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Blackshard_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/8/?y80/?y81;                 [8 Blackshard of the Dead Knight]
!!FU&y81=0:E;
!!BMy4:F?i;                             [read flags]
!!VRi:&16;                              [just look alive bit]
!!if&i>0;                              [if alive]
  !!MF:F?y6;
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+25;                           [Extra Damage 25+2*Hero Level]
  !!VRy7:Sy6+y8;
  !!MF:Fy7;
!!en;


!?MF1;
*9 Greater Gnoll's Flail deals extra 30+2*HLvL damage to any undead unit
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Flail_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Flail_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99&y99>=0:A2/9/?y80/?y81;          [9 Greater Gnoll's Flail]
!!FU&y81=0:E;
!!BMy4:F?i;                             [read flags]
!!VRi:&262144;                          [just look undead bit]
!!if&i>0;                              [if undead]
  !!MF:F?y6;
  !!HEy99:E?y10/?y8/1;
  !!VRy8:*2+30;                           [Extra Damage 30+2*Hero Level]
  !!VRy7:Sy6+y8;
  !!MF:Fy7;
!!en;


!?MF1;
*38 Red Dragon Flame Tongue  deals fire damage to any unit with melee attacks
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!SN:W^Tongue_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Tongue_Attacking_Stack^/y4;

!!BMy4:T?y40;                           [Get Type in y40]
!!FU|y40=33/y40=52/y40=53/y40=82/y40=83/y40=114/y40=116/y40=117/y40=121/y40=125:E;
!!FU|y40=129/y40=130/y40=131/y40=155/y40=158/y40=164/y40=195:E;
!!BMy4:G31/?y41/?y42;                   [Get Fire Resistance]
!!FU&y41>0:E;                           [Exit if any Fire Resistance]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!HEy99:A2/38/?y80/?y81;                [38 Red Dragon Flame Tongue]
!!FU&y81=0:E;
!!HEy99:A2/81/?y10/?y16;                [81 Orb of Tempestuous Fire]
!!MF:F?y6;
!!VRy7:S25R100;                         [Add +25-125 fire damage]
!!VRy7&y16=1:*2;                        [Double Fire Damage with Orb]
!!VRy8:Sy7+y6;
!!MF:Fy8;
!!BA:Q?f;
!!SN&f=0/1000:T^AC_Misc.Red Dragon Flame^/?z2/^damage3^/y7;
!!BU&f=0/1000:Mz2;


!?MF1;
*Complete Dragon Set  burns enemies with melee attacks, burned enemies get damage over time
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!FU&y10<>4462398:E;                    [Melee Damage]

!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!BG:A?y1;
!!FU&y1<>6:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^DragonSet_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^DragonSet_Attacking_Stack^/y4;

!!BMy4:T?y40;                           [Get Type in y40]
!!FU|y40=33/y40=52/y40=53/y40=82/y40=83/y40=114/y40=116/y40=117/y40=121/y40=125:E;
!!FU|y40=129/y40=130/y40=131/y40=155/y40=158/y40=164/y40=195:E;
!!BMy4:G31/?y41/?y42;                   [Get Fire Resistance]
!!FU&y41>0/y42=3:E;                     [Exit if Expert Fire Resistance]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!FU(Count_Set_Pieces):Py99/?y90;       [Count Set Pieces function, check for Dragon Set]
!!FU&y90<>6:E;                          [Exit if Set is not complete (6)]

!!HEy99:A2/81/?y10/?y16;                [81 Orb of Tempestuous Fire]
!!MF:F?y6;
!!VRy7:Sy6*25:100;                      [Take 25% of damage dealt]
!!FU&y7=0:E;                            [Exit if not enough damage]
!!BMy4:M21/1/3;                         [apply incinerate to stack]
!!BMy4&y4=0:M21/2/3;                    [fix?]
!!SN:W^Burned_Stack_%Y4^/dy7;           [Add and Stack Damage to the Stack]


*********
*Increase Creature bank reward with Statesman's Medal
!?OB16&1000;                            [16 Creature Bank]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB24&1000;                            [24 Derelict Ship]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB25&1000;                            [25 Dragon Utopia]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB84&1000;                            [84 Crypt]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!?OB85&1000;                            [85 Shipwreck]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus1)&y1>=0/y1<=155:Py1;

!$OB16&1000;                            [16 Creature Bank]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB24&1000;                            [24 Derelict Ship]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB25&1000;                            [25 Dragon Utopia]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB84&1000;                            [84 Crypt]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;

!$OB85&1000;                            [85 Shipwreck]
!!HE-1:N?y1;
!!FU(Statesman_CB_Bonus2)&y1>=0/y1<=155:Py1;


!?FU(Statesman_CB_Bonus1);

!!SN:W^Creature Bank visit^/0;
!!SN:W^Creature Bank Reward^/0;
!!HEx1:A2/66/?y49/?y66;
!!SN&y66=1:W^Creature Bank visit^/1;
!!SN&y66=0:W^Creature Bank visit^/0;


!?FU(Statesman_CB_Bonus2);

!!HEx1:O?y3;
!!SN:W^Hero_Attacker_Owner0^/?y2;       [Check Owner Before Fight]
!!SN:W^Creature Bank Reward^/?y5;
!!FU|y3<>y2/y5<>1:E;                    [Exit if Hero has lost the Battle or didnt do a battle at all]

!!HEx1:E?y50/?y51/1; !!VRy52:Sy51*200;  [Get Hero Level]
!!HEx1:A2/66/?y49/?y66;
!!HEx1:A2/67/?y49/?y67;
!!HEx1:A2/68/?y49/?y68;
!!VRy69&y66=1/y67=1/y68=1:S1;           [Double Bonus if complete Set]

!!VRy20&y66=1:S1000+y52;                [1000+HeroLevel*200]
!!VRy20&y69=1:*2;                       [Double if set complete]
!!SN:T^AC_Misc.Statesman's Medal Bonus^/?z-9/^gold^y20;
!!IF:M1/z-9;

!!OW:Ry3/6/dy20;
!!SN:W^Creature Bank visit^/0;
!!SN:W^Creature Bank Reward^/0;

!?FU(OnBeforeBattleUniversal)&1000;
!!SN:W^Creature Bank visit^/?y1;
!!SN:W^Creature Bank visit^/0;
!!SN&y1=1:W^Creature Bank Reward^/1;


!?FU(Res_Artifact_Backpack);
!!OW:Hx1/1/x16; !!VRy21:Sv1;
!!HEy21:A2/109/?y30/?y40 A2/110/?y31/?y41 A2/111/?y32/?y42 A2/112/?y33/?y43 A2/113/?y34/?y44;
!!HEy21:A2/114/?y35/?y45 A2/115/?y36/?y46 A2/116/?y37/?y47 A2/117/?y38/?y48 A2/140/?y39/?y49;
!!VRy30:-y40; !!VRy30&y30<0:S0;  !!VRy31:-y41; !!VRy31&y31<0:S0;
!!VRy32:-y42; !!VRy32&y32<0:S0;  !!VRy33:-y43; !!VRy33&y33<0:S0;
!!VRy34:-y44; !!VRy34&y34<0:S0;  !!VRy35:-y45; !!VRy35&y35<0:S0;
!!VRy36:-y46; !!VRy36&y36<0:S0;  !!VRy37:-y47; !!VRy37&y37<0:S0;
!!VRy38:-y48; !!VRy38&y38<0:S0;  !!VRy39:-y49; !!VRy39&y39<0:S0;
!!VRy33:*2; !!VRy35:*2; !!VRy36:*1000; !!VRy37:*750; !!VRy38:*500; !!VRy39:*5;
!!VRv4:+y35; !!VRv6:+y33; !!VRv10:+y36 +y37 +y38;
!!VRv5:+y32 +y39; !!VRv7:+y34 +y39; !!VRv8:+y30 +y39; !!VRv9:+y31 +y39;

!?FU7768;                               [AddGoldForArt (c)igrik]
!!SN:X?y1/0;
!!VRy2:Sy1 +0; !!UN:Cy2/4/?y3;
!!VRy4:Sy1 +24;!!UN:Cy4/4/?y5;
!!VRy6:Sy1 +8; !!UN:Cy6/4/?y7;
!!VRy8:Sy7 -4;                          [!!UN:Cy8/4/?y9;]
!!VRy10:Sy7 +8;!!UN:Cy10/4/?y11;
!!OW:Hy11/1/0; !!VRy12:Sv1;
!!VRv4:C0/0/0/0/0/0/0;
!!DO(Res_Artifact_Backpack)/1/y12/1&y12>0:Py11;
!!VRy5:+v10;
!!UN:Cy2/4/0;
!!UN:Cy8/4/y5;
!!VRy9:Sy1 +32; !!UN:Cy9/4/5011269;

!?FU7769;                               [AddResForArt]
!!SN:X?y1;
!!VRy2:Sy1 +4;   !!UN:Cy2/4/?y3;
!!VRy2:Sy3 -268;                        [!!UN:Cy2/4/?y4;]
!!VRy6:Sy1 +8;   !!UN:Cy6/4/?y7;
!!VRy7:-4;       !!UN:Cy7/4/?y8;
!!OW:Hy8/1/0; !!VRy9:Sv1;
!!VRv4:C0/0/0/0/0/0/0;
!!DO(Res_Artifact_Backpack)/1/y9/1&y9>0:Py8;
!!VRy5:Sy3 -4;   !!UN:Cy5/4/dv4;
!!VRy5:Sy3;      !!UN:Cy5/4/dv5;
!!VRy5:Sy3 +4;   !!UN:Cy5/4/dv6;
!!VRy5:Sy3 +8;   !!UN:Cy5/4/dv7;
!!VRy5:Sy3 +12;  !!UN:Cy5/4/dv8;
!!VRy5:Sy3 +16;  !!UN:Cy5/4/dv9;


!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerIsAi^=0; [Trigger each monday]
Fix for Cart of Lumber and Cart of Ore give +2 in total
!!DO(AC_Function_40)/0/155/1:P;         [loop through heroes]

!?FU(AC_Function_40);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:A2/114/?y30/?y40;               [114 Inexhaustible Cart of Lumber]
!!HEx16:A2/112/?y30/?y41;               [112 Inexhaustible Cart of Ore]
!!FU&y40=0/y41=0:E;                     [Exit if none of these artifacts equipped]
!!OW&y40=1:Ry1/0/d1;                    [Add 1 Wood resource to player]
!!OW&y41=1:Ry1/2/d1;                    [Add 1 Ore resource to player]


********************************************************************************
*Luck reducing Artifacts

!?BR&v997<>-1;
!!FU(Reduce_Luck0):P;
!?BG1;
!!FU(Reduce_Luck0):P;
!?FU(Reduce_Luck0);
!!BA:H0/?y1 H1/?y2;

!!HEy1:A2/47/?y3/?y4;                   [Attacker Cards of Prophecy]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

*!HEy1:A2/21/?y3/?y4;      Attacker Helm of Chaos
*!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!HEy1:A2/14/?y3/?y4;                   [Attacker Shield of the Yawning Dead]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!HEy1:A2/63/?y3/?y4;                   [Attacker Bird of Perception]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!HEy1:A2/51/?y3/?y4;                   [Attacker Glyph of Gallantry]
!!DO(Reduce_Luck1)/21/41/1&y4>0:P4;

!!FU&y2<0:E;                            [Exit if no Defender Hero]
!!HEy2:A2/47/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

*!HEy2:A2/21/?y3/?y4;
*!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

!!HEy2:A2/14/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

!!HEy2:A2/64/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;

!!HEy2:A2/51/?y3/?y4;
!!DO(Reduce_Luck1)/0/20/1&y4>0:P4;


!?FU(Reduce_Luck1);
!!if&x1=4;
  !!BMx16:N?y3;                           [Get number]
  !!FU&y3<1:E;                            [Exit if no stack or has no morale Flag]
  !!BMx16:G213/?y2/?t;                    [213 Luck]
  !!VRy2:-1;                              [add negative morale to current morale]
  !!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Luck]
  !!BMx16:G213/y2/?t;                     [213 Luck]
!!en;

****************
*Surcoat of Counterpoise +2defense
!?AE1&v998=58; Equip Artifact  !!FU&761:E;

!!HE-1:Fd/d2/d/d;                       [58 Surcoat of Counterpoise +2 defense]

!?AE0&v998=58; Unequip Artifact   !!FU&761:E;

!!HE-1:Fd/d-2/d/d;                      [58 Surcoat of Counterpoise -2]


!?FU(OnAfterBattleUniversal)&1000;      [59 Boots of Polarity have a chance to give movement bonus after combat]

!!HE-1:N?y1;                            [Hero Number]
!!FU&y1<0:E;                            [exit if no active hero]

!!HEy1:O?y9;                            [get owner of this hero]
!!FU&y9=-1:E;                           [Exit if no Owner]
!!SN:W^Hero_Attacker_Owner0^/?y5;
!!VRy20:S0T99;
!!HEy1:A2/59/?y29/?y21;                 [Check for Boots]
!!if&y5=y9/y20<=21/y21=1;
!!VRy3:S250;
!!HEy1:Wdy3/1;                          [give calculated free Movement Points]
!!SN:T^AC_Misc.Polarity_Boots_Bonus^/?z2;
!!IF&1000:M^%Z2^;
!!en;


****************
*Increased effectiveness of Magic Resistance Artifacts all grant +5% more MR*
57  Garniture of Interference +10%MR
58  Surcoat of Counterpoise +15%MR
59  Boots of Polarity +20%MR
64  Stoic Watchman +10%MR

!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1 S?y7;                         [Get Creature Number and Spell Number]
!!BMy1:I?y2 T?y3 P?y4;                  [Get Creature Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y5;                           [Get Hero Number of creature side]
!!FU&y5<0:E;                            [Exit if no Hero]
!!FU&y50=y5:E;                          [Exit for beneficial spells, meaning same hero side as crature side]

!!VRy30:S0;
!!MR:F?y40;
!!HEy5:A2/57/?y29/?y21; !!VRy30&y21=1:+5;[Check for Garniture of Interference]
!!HEy5:A2/58/?y29/?y21; !!VRy30&y21=1:+5;[Check for Surcoat of Counterpoise]
!!HEy5:A2/59/?y29/?y21; !!VRy30&y21=1:+5;[Check for Boots of Polarity]
!!HEy5:A2/64/?y29/?y21; !!VRy30&y21=1:+10;[Check for Stoic Watchman]
!!VRy40:+y30;
!!VRy40&y40>100:S100;
!!MR:Fy40;                             [Apply increased resistance chance to that stack temporarily]


****************
*Crest of Valor increases stats of Henchman and Commander by +15%

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]

!!BA:H0/?y1;
!!HEy1:A2/50/?y3/?y2;                   [50  Crest of Valor Attacker]

!!if&y2=1;
  !!re i/0/10;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    !!if&y3>=174/y3<=182|y4=20;        [If Commander or Henchmen found for Attacker]
    !!VRy10:S115;                       [Coefficient for parameter increase +15%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!HEy1:A2/50/?y3/?y2;                   [50  Crest of Valor Defender]

!!if&y2=1;
  !!re i/21/31;
  !!BMi:T?y3 P?y4;                      [Get Creature Type and Position]
    !!if&y3>=183/y3<=191|y4=30;        [If Commander or Henchmen found for Defender]
    !!VRy10:S115;                       [Coefficient for parameter increase +15%]
    !!BMi:A?y5; !!VRy5:*y10:100; !!BMi:Ay5; [Set Attack]
    !!BMi:D?y5; !!VRy5:*y10:100; !!BMi:Dy5; [Set Defense]
    !!BMi:H?y5; !!VRy5:*y10:100; !!BMi:Hy5; [Set Health]
    !!BMi:U1/?y5 U2/?y6; !!VRy5:*y10:100; !!VRy6:*y10:100; !!BMi:U1/y5 U2/y6; [Set Min+Max Damage]
    !!BMi:S?y5; !!VRy5:*y10:100; !!BMi:Sy5; [add Speed]
    !!en;
  !!en;
!!en;


****************
*Glyph of Galantry gives a few creatures to your army every week, triggers for each player seperatly
!?FU(OnEveryDay)&i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0;
!!OW:C?y1;
!!DO(AC_Function_Glyph_of_Galantry0)/0/155/1:Py1;

!?FU(AC_Function_Glyph_of_Galantry0);
!!HEx16:O?y1;                           [Checke Hero Owner]
!!FU&y1=-1:E;                           [Exit if none]
!!HEx16:O?y1;
!!FU&y1<>x1:E;
!!HEx16:A2/51/?y3/?y2;                  [51  Glyph of Gallantry]
!!FU&y2=0:E;                            [Exit if Arti not equipped]
!!HEx16:B0/?z4;                         [get hero name]

!!re i/0/30;
  !!VRy98:S0T6;                         [Generate random slot]
  !!HEx16:C0/y98/?y1/?y2;               [Check Heroes army]
  !!if&y2>0/y1>=0;
  !!MA:Ly1/?y20;                        [get monster level]
  !!if&y20<6;                          [Does not work for level 7 creatures]
    !!VRy3:S1;
    !!VRy3&y20=0:S10R13;                [Set Number of creatures for 1 level]
    !!VRy3&y20=1:S7R10;                 [Set Number of creatures for 2 level]
    !!VRy3&y20=2:S5R8;                  [Set Number of creatures for 3 level]
    !!VRy3&y20=3:S3R6;                  [Set Number of creatures for 4 level]
    !!VRy3&y20=4:S2R4;                  [Set Number of creatures for 5 level]
    !!VRy3&y20=5:S1R2;                  [Set Number of creatures for 6 level]
    !!HEx16:C0/y98/d/dy3/0/0;           [Add Monsters to army]
    !!UN:N3/z3/y1/1;                    [Normal Creature]
    !!SN:T^AC_Warmachine.Glyph_of_Gal_Creatures^/?s^Text^/^crname^/z3/^heroname^/z4;
    !!IF&1000:M^%S(Text)^;              [Show text if already bought]
    !!br;                              [Exit loop if creatues was added]
  !!en;
  !!en;
!!en;


*****************
!?HL-1&1000;
The Champions Honor full set grants Warmachine Upgrades at level up with a 20%/50% chance
!!HE-1:N?y1;                            [Get Hero Number]
!!FU(Count_Set_Pieces)&y1>=0/y1<=155:Py1/0/0/0/?y93; [Count Set Pieces function, check for Champions Honor Set]
!!FU&y93<2:E;                           [Exit if not at least 2 set pieces]
!!VRy10:S0T100;
!!VRy20:S0;
!!VRy20&y93>=2:S20;                     [With 2 set pieces give a 20% chance]
!!VRy20&y93=4:S+30;                     [With 4 set pieces give a 50% chance]

!!if&y10<y20;                          [If roll is successful]
!!VRy2:S1R23;                           [Generate Random Number from 1-24]
  !!SN&y2=1:W^Ballista_Fireball_Attack_%Y1^/?y3; !!SN&y2=1/y3=0:W^Ballista_Fireball_Attack_%Y1^/1; !!SN&y2=1/y3=0:T^AC_Warmachine.Bal_Ench_1^/?z-1; !!SN&y2=1/y3=0:T^AC_Warmachine.Bal_Ench_1_Description^/?z2;
  !!SN&y2=2:W^Ballista_Magic_Arrow_%Y1^/?y3; !!SN&y2=2/y3=0:W^Ballista_Magic_Arrow_%Y1^/1; !!SN&y2=2/y3=0:T^AC_Warmachine.Bal_Ench_2^/?z-1; !!SN&y2=2/y3=0:T^AC_Warmachine.Bal_Ench_2_Description^/?z2;
  !!SN&y2=3:W^Ballista_Spell_Trigger_%Y1^/?y3; !!SN&y2=3/y3=0:W^Ballista_Spell_Trigger_%Y1^/1; !!SN&y2=3/y3=0:T^AC_Warmachine.Bal_Ench_3^/?z-1; !!SN&y2=3/y3=0:T^AC_Warmachine.Bal_Ench_3_Description^/?z2;
  !!SN&y2=4:W^Ammo_Booby_Trap_%Y1^/?y3; !!SN&y2=4/y3=0:W^Ammo_Booby_Trap_%Y1^/1; !!SN&y2=4/y3=0:T^AC_Warmachine.Cart_Ench_1^/?z-1; !!SN&y2=4/y3=0:T^AC_Warmachine.Cart_Ench_1_Description^/?z2;
  !!SN&y2=5:W^Ammo_Replensih_SP_%Y1^/?y3; !!SN&y2=5/y3=0:W^Ammo_Replensih_SP_%Y1^/1; !!SN&y2=5/y3=0:T^AC_Warmachine.Cart_Ench_2^/?z-1; !!SN&y2=5/y3=0:T^AC_Warmachine.Cart_Ench_2_Description^/?z2;
  !!SN&y2=6:W^Ammo_Burning_Arrow_%Y1^/?y3; !!SN&y2=6/y3=0:W^Ammo_Burning_Arrow_%Y1^/1; !!SN&y2=6/y3=0:T^AC_Warmachine.Cart_Ench_3^/?z-1; !!SN&y2=6/y3=0:T^AC_Warmachine.Cart_Ench_3_Description^/?z2;
  !!SN&y2=7:W^Tent_Herbalism_%Y1^/?y3; !!SN&y2=7/y3=0:W^Tent_Herbalism_%Y1^/1; !!SN&y2=7/y3=0:T^AC_Warmachine.Tent_Ench_1^/?z-1; !!SN&y2=7/y3=0:T^AC_Warmachine.Tent_Ench_1_Description^/?z2;
  !!SN&y2=8:W^Tent_Overheal_%Y1^/?y3; !!SN&y2=8/y3=0:W^Tent_Overheal_%Y1^/1; !!SN&y2=8/y3=0:T^AC_Warmachine.Tent_Ench_2^/?z-1; !!SN&y2=8/y3=0:T^AC_Warmachine.Tent_Ench_2_Description^/?z2;
  !!SN&y2=9:W^Tent_Life_Aura_%Y1^/?y3; !!SN&y2=9/y3=0:W^Tent_Life_Aura_%Y1^/1; !!SN&y2=9/y3=0:T^AC_Warmachine.Tent_Ench_3^/?z-1; !!SN&y2=9/y3=0:T^AC_Warmachine.Tent_Ench_3_Description^/?z2;
  !!SN&y2=10:W^WM_Shield_Ench_%Y1^/?y3; !!SN&y2=10/y3=0:W^WM_Shield_Ench_%Y1^/1; !!SN&y2=10/y3=0:T^AC_Warmachine.All_Ench_1^/?z-1; !!SN&y2=10/y3=0:T^AC_Warmachine.All_WM_Ench_1_Description^/?z2;
  !!SN&y2=11:W^WM_MR_Ench_%Y1^/?y3; !!SN&y2=11/y3=0:W^WM_MR_Ench_%Y1^/1; !!SN&y2=11/y3=0:T^AC_Warmachine.All_Ench_2^/?z-1; !!SN&y2=11/y3=0:T^AC_Warmachine.All_WM_Ench_2_Description^/?z2;
  !!SN&y2=12:W^WM_MR_Aura_%Y1^/?y3; !!SN&y2=12/y3=0:W^WM_MR_Aura_%Y1^/1; !!SN&y2=12/y3=0:T^AC_Warmachine.All_Ench_3^/?z-1; !!SN&y2=12/y3=0:T^AC_Warmachine.All_WM_Ench_3_Description^/?z2;
  !!SN&y2=13:W^Ballista_Morale_%Y1^/?y3; !!SN&y2=13/y3=0:W^Ballista_Morale_%Y1^/1; !!SN&y2=13/y3=0:T^AC_Warmachine.Bal_Upg_1^/?z-1; !!SN&y2=13/y3=0:T^AC_Warmachine.Bal_Upg_1_Description^/?z2;
  !!SN&y2=14:W^Ballista_Add_Shots_%Y1^/?y3; !!SN&y2=14/y3=0:W^Ballista_Add_Shots_%Y1^/1; !!SN&y2=14/y3=0:T^AC_Warmachine.Bal_Upg_2^/?z-1; !!SN&y2=14/y3=0:T^AC_Warmachine.Bal_Upg_2_Description^/?z2;
  !!SN&y2=15:W^Ballista_Crippling_%Y1^/?y3; !!SN&y2=15/y3=0:W^Ballista_Crippling_%Y1^/1; !!SN&y2=15/y3=0:T^AC_Warmachine.Bal_Upg_3^/?z-1; !!SN&y2=15/y3=0:T^AC_Warmachine.Bal_Upg_3_Description^/?z2;
  !!SN&y2=16:W^Ammo_Supply_%Y1^/?y3; !!SN&y2=16/y3=0:W^Ammo_Supply_%Y1^/1; !!SN&y2=16/y3=0:T^AC_Warmachine.Cart_Upg_1^/?z-1; !!SN&y2=16/y3=0:T^AC_Warmachine.Cart_Upg_1_Description^/?z2;
  !!SN&y2=17:W^Ammo_Goblin_%Y1^/?y3; !!SN&y2=17/y3=0:W^Ammo_Goblin_%Y1^/1; !!SN&y2=17/y3=0:T^AC_Warmachine.Cart_Upg_2^/?z-1; !!SN&y2=17/y3=0:T^AC_Warmachine.Cart_Upg_2_Description^/?z2;
  !!SN&y2=18:W^Ammo_Enhanced_Arrow_%Y1^/?y3; !!SN&y2=18/y3=0:W^Ammo_Enhanced_Arrow_%Y1^/1; !!SN&y2=18/y3=0:T^AC_Warmachine.Cart_Upg_3^/?z-1; !!SN&y2=18/y3=0:T^AC_Warmachine.Cart_Upg_3_Description^/?z2;
  !!SN&y2=19:W^Tent_Improved_%Y1^/?y3; !!SN&y2=19/y3=0:W^Tent_Improved_%Y1^/1; !!SN&y2=19/y3=0:T^AC_Warmachine.Tent_Upg_1^/?z-1; !!SN&y2=19/y3=0:T^AC_Warmachine.Tent_Upg_1_Description^/?z2;
  !!SN&y2=20:W^Tent_Capacity_Upgrade_%Y1^/?y3; !!SN&y2=20/y3=0:W^Tent_Capacity_Upgrade_%Y1^/1; !!SN&y2=20/y3=0:T^AC_Warmachine.Tent_Upg_2^/?z-1; !!SN&y2=20/y3=0:T^AC_Warmachine.Tent_Upg_2_Description^/?z2;
  !!SN&y2=21:W^Tent_Gold_Gain_%Y1^/?y3; !!SN&y2=21/y3=0:W^Tent_Gold_Gain_%Y1^/1; !!SN&y2=21/y3=0:T^AC_Warmachine.Tent_Upg_3^/?z-1; !!SN&y2=21/y3=0:T^AC_Warmachine.Tent_Upg_3_Description^/?z2;
  !!SN&y2=22:W^WM_Fortification_%Y1^/?y3; !!SN&y2=22/y3=0:W^WM_Fortification_%Y1^/1; !!SN&y2=22/y3=0:T^AC_Warmachine.All_Upg_1^/?z-1; !!SN&y2=22/y3=0:T^AC_Warmachine.All_WM_Upg_1_Description^/?z2;
  !!SN&y2=23:W^WM_Maintainability_%Y1^/?y3; !!SN&y2=23/y3=0:W^WM_Maintainability_%Y1^/1; !!SN&y2=23/y3=0:T^AC_Warmachine.All_Upg_2^/?z-1; !!SN&y2=23/y3=0:T^AC_Warmachine.All_WM_Upg_2_Description^/?z2;
  !!SN&y2=24:W^WM_Versatility_%Y1^/?y3; !!SN&y2=24/y3=0:W^WM_Versatility_%Y1^/1; !!SN&y2=24/y3=0:T^AC_Warmachine.All_Upg_3^/?z-1; !!SN&y2=24/y3=0:T^AC_Warmachine.All_WM_Upg_3_Description^/?z2;

  !!SN:Iz2/?z2;                         [Interpolate String]
  !!if&y3=0;                           [When the upgrade is unknown to the hero display the text]
    !!SN:T^AC_Warmachine.Champions_Honor_Set_WM^/?z3;
    !!IF:M^%Z3


    %Z2^;
  !!en;
!!en;

!!VRy10:S0T100;
!!VRy20:S0;
!!VRy20&y93>=3:S20;                     [With 3 set pieces give a 20% chance for extra Prim Skill]
!!if&y10<y20;                          [If roll is successful]
  !!VRy96:S1T3;
  !!SN:T^AC_Warmachine.Champions_Honor_Set_Skill^/?z21;
  !!IF&y96=1:Q2/31/1/1^%Z21^;
  !!HEy1&y96=1:Fd1/d/d/d;
  !!IF&y96=2:Q2/32/1/1^%Z21^;
  !!HEy1&y96=2:Fd/d1/d/d;
  !!IF&y96=3:Q2/33/1/1^%Z21^;
  !!HEy1&y96=3:Fd/d/d1/d;
  !!IF&y96=4:Q2/34/1/1^%Z21^;
  !!HEy1&y96=4:Fd/d/d/d1;
  !!UN:R1;                              [redraw hero screen]
!!en;


******************************End of Artefact Section***************************







********************************************************************************
*Set Artifact Descriptions at Map Start*
!?FU(OnGameEnter);

!!UN:P102/?y2;                          [Check for Artifact Boost]
!!UN:P71/?y3;                           [Check for Enhanced Artifacts]
!!SN:W^Spell_Trainer_Mod^/?y4;          [Spell Trainer Mod Active]
!!SN:W^Magic_Artillery_Mod^/?y5;        [Magic Artillery Mod Active]
!!SN:W^Mystik_Skill_Enhancement_Mod^/?y6;[Mystik_Skill_Enhancement Mod Active]
!!SN:W^Luck_Skill_Enhancement^/?y7;

!!VRy5:S1;                              [Activate Eagle Eye Description Magic Artillery]

*-------Books-------*
!!FU7701:P3/86/1/188108;                [Tome of Fire]
!!FU7701:P3/87/1/188109;                [Tome of Air]
!!FU7701:P3/88/1/188110;                [Tome of Water]
!!FU7701:P3/89/1/188111;                [Tome of Earth]
*-------Armor-------*
!!FU7701:P3/24/1/188165;                [Thunder Helmet]
!!FU7701:P3/30/1/188166;                [Titan's Cuirass]
!!FU7701:P3/18/1/188164;                [Sentinel's Shield]
!!FU7701:P3/12/1/188163;                [Titan's Gladius]
!!FU7701:P3/135/1/188167;               [Titan's Thunder]
*!FU7701:P3/23/1/179836;                [Hellstorm Helmet]
!!FU7701:P3/27/1/179837;                [Scales of the Greater Basilisk]
*!FU7701:P3/29/1/179839;                [Breastplate of Brimstone]
!!FU7701:P3/124/1/179841;               [Spellbinder's Hat]
!!FU7701:P3/106/1/179842;               [Pendant of Negativity]
!!FU7701:P3/127/1/179843;               [Vial of Dragon Blood]
!!FU7701:P3/128/1/179844;               [Armageddon's Blade]
!!FU7701:P3/41/1/179857;                [Dragonbone Greaves]
!!FU7701:P3/42/1/179858;                [Dragon Wing Tabard]
!!FU7701:P3/43/1/179859;                [Necklace of Dragonteeth]
!!FU7701:P3/44/1/179860;                [Crown of Dragontooth]
!!FU7701:P3/39/1/179861;                [Dragon Scale Shield]
!!FU7701:P3/40/1/179862;                [Dragon Scale Armor]
*-------Moral-------*
!!FU7701:P3/49/1/188112;                [Badge of Courage]
!!FU7701:P3/50/1/188113;                [Crest of Valor]
!!FU7701:P3/51/1/188114;                [Glyph of Gallantry]
!!FU7701:P3/108/1/188115;               [Pendant of Courage]
*-------Luck-------*
!!FU7701:P3/46/1/188116;                [Clover of Fortune]
!!FU7701:P3/47/1/188117;                [Cards of Prophecy]
!!FU7701:P3/48/1/188118;                [Ladybird of Luck]
!!FU7701:P3/45/1/188119;                [Still Eye of the Dragon]
*-------Venom Teeth Set-------*
!!FU7701:P3/10/1/188146;                [Ogre's Club of Havoc]
!!FU7701:P3/15/1/188144;                [Buckler of the Gnoll King]
!!FU7701:P3/19/1/188145;                [Helm of the Alabaster Unicorn]
*-------Orbs-------*
!!FU7701:P3/79/1/188104;                [orb of firmament]
!!FU7701:P3/80/1/188105;                [orb of silt]
!!FU7701:P3/81/1/188106;                [orb of tempestous fire]
!!FU7701:P3/82/1/188107;                [orb of driving rain]
*------Ring of Magi-----*
!!FU7701:P3/76/1/188120;                [Changed Var Numers         [collar of conjuring]
!!FU7701:P3/77/1/188121;                [ring of conjuring]
!!FU7701:P3/78/1/188122;                [cape of conjuring]
!!FU7701:P3/139/1/188123;               [ring of the magi]
*------Ring of Magi-----*
!!if&y4=1;                             [*Spell Trainer Enabled]
!!FU7701:P3/76/1/188204;                [collar of conjuring]
!!FU7701:P3/77/1/188205;                [ring of conjuring]
!!FU7701:P3/78/1/188206;                [cape of conjuring]
!!FU7701:P3/139/1/188207;               [ring of the magi]
!!en;
*-------Priest of the Light-----*
!!FU7701:P3/103/1/188140;               [Pendant of Life]
!!FU7701:P3/13/1/188141;                [Shield of the Dwarven Lords]
!!FU7701:P3/22/1/188130;                [Crown of the Supreme Magi]
!!FU7701:P3/25/1/188175;                [Breastplate of Petrified Wood]
!!FU7701:P3/9/1/188132;                 [Greater Gnoll's Flail]
!!FU7701:P3/98/1/188174;                [Boots of Speed]
*-------Priest of the Dark------*
!!FU7701:P3/104/1/188142;               [Pendant of Death]
!!FU7701:P3/14/1/188135;                [Shield of the Yawning Dead]
!!FU7701:P3/20/1/188136;                [Skull Helmet]
!!FU7701:P3/26/1/188137;                [Rib Cage]
!!FU7701:P3/8/1/188138;                 [Blackshard of the Dead Knight]
!!FU7701:P3/56/1/188139;                [Dead Man's Boots]
*-------Resistance Set-------*
!!FU7701:P3/57/1/188154;                [Garniture of Interference]
!!FU7701:P3/58/1/188155;                [Surcoat of Counterpoise]
!!FU7701:P3/59/1/188156;                [Boots of Polarity]
*-------Pegasus Harness-------*
!!FU7701:P3/69/1/188161;                [Necklace of Swiftness]
!!FU7701:P3/97/1/188160;                [Ring of the Wayfarer]
!!FU7701:P3/99/1/188162;                [Cape of Velocity]
*-------Vision of the Eagle----*
!!if&y5=0;                             [*Magic Artillery Disabled]
!!FU7701:P3/63/1/188148;                [Bird of Perception]
!!FU7701:P3/64/1/188149;                [Stoic Watchman]
!!FU7701:P3/65/1/188150;                [Emblem of Cognizance]
!!en;
*-------Vision of the Eagle----*
!!if&y5=1;                             [*Magic Artillery Enabled]
!!FU7701:P3/63/1/188194;                [Bird of Perception]
!!FU7701:P3/64/1/188195;                [Stoic Watchman]
!!FU7701:P3/65/1/188196;                [Emblem of Cognizance]
!!en;
*-------Archdevils Suite------*
!!FU7701:P3/11/1/188169;                [Sword of Hellfire]
!!FU7701:P3/17/1/188170;                [Shield of the Damned]
!!FU7701:P3/23/1/188171;                [Hellstorm Helmet]
!!FU7701:P3/29/1/188172;                [Breastplate of Brimstone]
!!FU7701:P3/101/1/188173;               [Pendant of Second Sight]
*-------Angelic Alliance------*
!!FU7701:P3/31/1/188131; !!UN:A31/5/-1; [Armor of Wonder]
!!FU7701:P3/32/1/188133; !!UN:A32/5/-1; [Sandals of the Saint]
!!FU7701:P3/33/1/188177; !!UN:A33/5/-1; [Celestial Necklace of Bliss]
!!FU7701:P3/34/1/188178; !!UN:A34/5/-1; [Lion's Shield of Courage]
!!FU7701:P3/35/1/188179; !!UN:A35/5/-1; [Sword of Judgement]
!!FU7701:P3/36/1/188180; !!UN:A36/5/-1; [Helm of Heavenly Enlightenment]
*-------Pegasus Harness-------*
!!FU7701:P3/60/1/188181;                [Bow of Elven Cherrywood]
!!FU7701:P3/61/1/188182;                [Bowstring of the Unicorn's Mane]
!!FU7701:P3/62/1/188183;                [Angel Feather Arrows]
!!FU7701:P3/137/1/188184;               [Bow of the Sharpshooter]
*-------Battle Mage War Dress-------*
!!FU7701:P3/7/1/188185;                 [Axe]
!!FU7701:P3/16/1/188186;                [Ogre]
!!FU7701:P3/100/1/188189;               [Pendant of Dispassion]
!!FU7701:P3/28/1/179838;                [Tunic of the Cyclops King]
!!FU7701:P3/21/1/179834;                [Helm of Chaos]
*-------Wizards Well-------*
!!FU7701:P3/73/1/188208;                [Charm of Mana]
!!FU7701:P3/74/1/188209;                [Talisman of Mana]
!!FU7701:P3/75/1/188210;                [Mystic Orb of Mana]
!!FU7701:P3/138/1/188211;               [Wizards Well]
*------Statue of Legion-----*
!!FU7701:P3/118/1/188224;               [Legs of Legion]
!!FU7701:P3/119/1/188225;               [Loins of Legion]
!!FU7701:P3/120/1/188226;               [Torso of Legion]
!!FU7701:P3/121/1/188227;               [Arms of Legion]
!!FU7701:P3/122/1/188228;               [Head of Legion]
!!FU7701:P3/133/1/188229;               [Statue of Legion]
*------Cornucopia-----*
!!FU7701:P3/109/1/188239;               [Everflowing Crystal Cloak]
!!FU7701:P3/110/1/188237;               [Ring of Infinite Gems]
!!FU7701:P3/111/1/188236;               [Everpouring Vial of Mercury]
!!FU7701:P3/113/1/188238;               [Eversmoking Ring of Sulfur]
!!FU7701:P3/140/1/188240;               [Cornucopia]
*------Ancient Spyglass-----*
!!FU7701:P3/53/1/188230;                [Spyglass]
!!FU7701:P3/52/1/188231;                [Speculum]
*-------Wizards Well-------*
!!if&y6=1;                             [**Mystik_Skill_Enhancement Mod active]
!!FU7701:P3/73/1/188212;                [Charm of Mana]
!!FU7701:P3/74/1/188213;                [Talisman of Mana]
!!FU7701:P3/75/1/188214;                [Mystic Orb of Mana]
!!FU7701:P3/138/1/188215;               [Wizards Well]
!!en;
*-------The Adventures Fidelity-------*
!!if&y7=1;                             [**Luck_Skill_Enhancement Mod active]
!!FU7701:P3/46/1/188216;                [Clover of Fortune]
!!FU7701:P3/47/1/188217;                [Cards of Prophecy]
!!FU7701:P3/48/1/188218;                [Ladybird of Luck]
!!FU7701:P3/106/1/188219;               [Pendant of Negativity]
!!en;
*-------Vestments of Authority-------*
!!FU7701:P3/66/1/188245;                [Statesman's Medal]
!!FU7701:P3/67/1/188246;                [Diplomat's Ring]
!!FU7701:P3/68/1/188247;                [Ambassador's Sash]
*-------Elexir of Life-------*
!!FU7701:P3/94/1/188241;                [Ring of Vitality]
!!FU7701:P3/95/1/188242;                [Ring of Life]
!!FU7701:P3/96/1/188243;                [Vial of Lifeblood]
!!FU7701:P3/131/1/188244;               [Elixir of Life]
*-------Class Sets-------*
!!FU7701:P3/161/1/188249;               [Royal Blank Helmet]
!!FU7701:P3/162/1/188250;               [Royal Blank Sword]
!!FU7701:P3/163/1/188251;               [Royal Blank Shield]
!!FU7701:P3/164/1/188252;               [Royal Blank Horned Ring]
!!FU7701:P3/165/1/188253;               [Royal Blank Gemmed Ring]
!!FU7701:P3/166/1/188254;               [Royal Blank Neck Broach]
!!FU7701:P3/167/1/188255;               [Royal Blank Armor]
!!FU7701:P3/168/1/188256;               [Royal Blank Surcoat]
!!FU7701:P3/169/1/188257;               [Royal Blank Boots]
!!FU7701:P3/170/1/188258;               [Royal Blank Horn]

*Names
!!FU7701:P3/161/0/188260;               [Royal Blank Helmet]
!!FU7701:P3/162/0/188261;               [Royal Blank Sword]
!!FU7701:P3/163/0/188262;               [Royal Blank Shield]
!!FU7701:P3/164/0/188263;               [Royal Blank Horned Ring]
!!FU7701:P3/165/0/188264;               [Royal Blank Gemmed Ring]
!!FU7701:P3/166/0/188265;               [Royal Blank Neck Broach]
!!FU7701:P3/167/0/188266;               [Royal Blank Armor]
!!FU7701:P3/168/0/188267;               [Royal Blank Surcoat]
!!FU7701:P3/169/0/188268;               [Royal Blank Boots]
*!FU7701:P3/170/0/188269;                            [Royal Blank Horn]
*------- Ammo Cart -------*
!!FU7701:P3/5/1/188259;                 [Ammo Cart]

!!FU7701:P3/105/1/188269;               [Pendant of Free Will]
!!FU7701:P3/102/1/188270;               [Pendant of Holiness]
!!FU7701:P3/107/1/188271;               [Pendant of Total Recall]

!!FU7701:P3/54/1/188272;                [Amulet of the Undertaker]
!!FU7701:P3/55/1/188273;                [Vampire's Cowl]
!!FU7701:P3/56/1/188274;                [Dead Man's Boots]
!!FU7701:P3/130/1/188275;               [Cloak of the Undead King]

!!FU7701:P3/38/1/188276;                [Red Dragon Flame Tongue]

!!FU7701:P3/115/1/188278;               [Endless Sack of Gold]
!!FU7701:P3/116/1/188279;               [Endless Bag of Gold]
!!FU7701:P3/117/1/188280;               [Endless Purse of Gold]
!!FU7701:P3/114/1/188281;               [Inexhaustible Cart of Ore]
!!FU7701:P3/112/1/188282;               [Inexhaustible Cart of Lumber]


!!if&y2=1;
*!IF:M^Artifact Boost enabled y2^;
!!FU7701:P3/56/1/188143;                [Dead Man's Boots]
*-------Resistance Set-------*
!!FU7701:P3/57/1/188157;                [Garniture of Interference]
!!FU7701:P3/58/1/188158;                [Surcoat of Counterpoise]
!!FU7701:P3/59/1/188159;                [Boots of Polarity]
*-------Vision of the Eagle----*
!!FU7701:P3/63/1/188151;                [Bird of Perception]
!!FU7701:P3/64/1/188152;                [Stoic Watchman]
!!FU7701:P3/65/1/188153;                [Emblem of Cognizance]
*-------Vestments of Authority-------*
!!FU7701:P3/66/1/188245;                [Statesman's Medal]
!!FU7701:P3/67/1/188246;                [Diplomat's Ring]
!!FU7701:P3/68/1/188247;                [Ambassador's Sash]
*-------Vision of the Eagle----*
!!if&y5=1;                             [*Magic Artillery Enabled]
!!FU7701:P3/63/1/188197;                [Bird of Perception]
!!FU7701:P3/64/1/188198;                [Stoic Watchman]
!!FU7701:P3/65/1/188199;                [Emblem of Cognizance]
!!en;
!!en;



!!if&y3=1;
*!IF:M^Enhanced Artifact enabled y3^;
*-------Orbs-------*
!!FU7701:P3/79/1/188100;                [orb of firmament]
!!FU7701:P3/80/1/188101;                [orb of silt]
!!FU7701:P3/81/1/188102;                [orb of tempestous fire]
!!FU7701:P3/82/1/188103;                [orb of driving rain]
*------Ring of Magi-----*
!!FU7701:P3/76/1/188120;                [collar of conjuring]
!!FU7701:P3/77/1/188121;                [ring of conjuring]
!!FU7701:P3/78/1/188122;                [cape of conjuring]
!!FU7701:P3/139/1/188123;               [ring of the magi]
*-------Vestments of Authority-------*
!!FU7701:P3/66/1/188245;                [Statesman's Medal]
!!FU7701:P3/67/1/188246;                [Diplomat's Ring]
!!FU7701:P3/68/1/188247;                [Ambassador's Sash]
*-------Elexir of Life-------*
!!FU7701:P3/94/1/188241;                [Ring of Vitality]
!!FU7701:P3/95/1/188242;                [Ring of Life]
!!FU7701:P3/96/1/188243;                [Vial of Lifeblood]
!!FU7701:P3/131/1/188244;               [Elixir of Life]
*------Ring of Magi-----*
!!if&y4=1;                             [*Spell Trainer Enabled]
!!FU7701:P3/76/1/188200;                [collar of conjuring]
!!FU7701:P3/77/1/188201;                [ring of conjuring]
!!FU7701:P3/78/1/188202;                [cape of conjuring]
!!FU7701:P3/139/1/188203;               [ring of the magi]
!!en;
*-------Priest of the Light-------*
!!FU7701:P3/13/1/188129;                [Shield of the Dwarven Lords]
!!FU7701:P3/19/1/188147;                [Helm of the Alabaster Unicorn]
!!FU7701:P3/104/1/188134;               [Pendant of Death]
!!FU7701:P3/103/1/188176;               [Pendant of Life]
!!en;


!!if&y3=1/y2=1;
*!IF:M^Enhanced Artifact & Artifact Boost enabled y3 + y2^;
!!FU7701:P3/103/1/188128;               [Pendant of Life]
!!FU7701:P3/104/1/188168;               [Pendant of Death]
!!FU7701:P3/56/1/188143;                [Dead Man's Boots]
!!en;

*WoG Artifacts description (1)
!!FU7701:P3/141/1/188283;               [141  Magic Wand]
!!FU7701:P3/142/1/188284;               [142  Gold Tower Arrow]
!!FU7701:P3/143/1/188285;               [143  Monster's Power]
!!FU7701:P3/160/1/188286;               [160  Gate Key]

*names (0)
!!FU7701:P3/141/0/188287;               [141  Magic Wand]
!!FU7701:P3/142/0/188288;               [142  Gold Tower Arrow]
!!FU7701:P3/143/0/188289;               [143  Monster's Power]
!!FU7701:P3/160/0/188290;               [160  Gate Key]
!!FU7701:P3/170/0/188291;               [170  Horn of Magic Energy]

********************************************************************************



                      Change Artifact Price and Class



********************************************************************************
Classes of Artifacts
1 No class
2 Treasure
4 Minor
8 Major
16 Relic and WoG


!?FU(Artifact_Cost_Increase);
!!UN:Ax16/1/d1000;

!#DO(Artifact_Cost_Increase)/0/170/1:P;


*******************
From Minor to Treasure
*******************

Inexhaustible Cart of Ore
!#UN:A112/3/2;

Inexhaustible Cart of Lumber
!#UN:A114/3/2;


*******************
From Treasure to Minor
*******************

49 Badge of Courage
!#UN:A49/3/4;

78 Cape of Conjuring
!#UN:A78/3/4;

97 Necklace of Swiftness
!#UN:A97/3/4;

103 Pendant of Life
!#UN:A103/3/4;


*******************
From Major to Minor
*******************

Ambassador's Sash
!#UN:A68/3/4;

Endless Bag of Gold
!#UN:A49/3/4;

Endless Purse of Gold
!#UN:A116/3/4;

Everflowing Crystal Cloak
!#UN:A109/3/4;

Everpouring Vial of Mercury
!#UN:A111/3/4;

Eversmoking Ring of Sulfur
!#UN:A113/3/4;

Ring of Infinite Gems
!#UN:A110/3/4;

Statesman's Medal
!#UN:A66/3/4;

Garniture of Interference
!#UN:A57/3/4;

Necklace of Ocean Guidance
!#UN:A71/3/4;


*******************
From Minor to Major
*******************

Crown of the Supreme Magi 22
!#UN:A22/3/8;

Red Dragon Flame Tongue 38
!#UN:A38/3/8;

Boots of Speed
!#UN:A98/3/8;

Gloves of Speed
!#UN:A70/3/8;


*******************
From Relic to Major
*******************

Boots of Polarity
!#UN:A59/3/8;

Endless Sack of Gold
!#UN:A115/3/8;

Sea Captain's Hat
!#UN:A123/3/8;


*******************
From Major to Relic
*******************

Pendant of Courage
!#UN:A108/3/16;

********************************************************************************
**V-Vars used: v9276,v9277,v9278,v9279,v9280,v9281,v9282,v9283,v9284,v9285,v9286-FREI ,v9287,v9288,v9290,v9390-v9410, v9441, v9442, v9443free, v9444, v9447, v9448, v9449
**Z-Vars used: z1, z-1, z796-z798
**Flags used: V890, V936


!#SN:W^Improved_Spells_Mod^/1;          [Improved_Spells_Mod Set to active]

!#UN:P22/0;                             [Disbale Monster Mutterings nonsense to get free z vars]
!#IF:V57/0;
!#UN:P58/0;                             [Disable Espionage nonsense to get free z vars]

!?FU(AC_ResetSpellFromStack);
; x1 - stack id
; x2 - spell id
!!UN:C6919200/4/?y10;
!!VRy1:Sx1 *1352 +21708 +y10;
!!SN:E4473392/2/y1/x2;

!?FU(OnGameEnter);                      [At gamestart]
;** Berserker radius at 0\1\2\3 fire magic rank. 0 - Set to 1 Hex, 1 set to 3 Hex
;** If you set the value to more than 2 there will be graphical bugs and will only work if you select the target explicitely
!!UN:C6562420/1/0;                      [None]
!!UN:C6562424/1/0;                      [Basic]
!!UN:C6562428/1/0;                      [Advanced 0 - Set to 1 Hex]
!!UN:C6562432/1/1;                      [Expert 1 - Set to 3 Hex]

*give damage flag to fire wall and land mines
!!SS13:F?y1;
!!VRy1:|512;
!!SS13:Fy1;
!!SS11:F?y1;
!!VRy1:|512;
!!SS11:Fy1;


!?FU(OnBeforeBattleUniversal)&1000;

!!SN:W^landmine_var^/0;                 [landmine variable]
!!SN:W^Bers_en^/0;                      [Reset vars before combat]
!!SN:W^Animate_Dead^/0;
!!SN:W^Stack_Number^/-1;
!!SN:W^Improved_Cure^/0;
!!SN:W^Incinerate^/0;                   [Reset Incinerate Damage]
!!VRy1:S0;
[:loopCombatStartVarsImprovedSpells];
!!SN:W^DisruptingRayCastsStack%Y1^/0;
!!SN:W^DisRayStoneSkinRemoved%Y1^/0;
!!SN:W^StoneSkinHitsStack%Y1^/0;
!!SN:W^Burned_Stack_%Y1^/0;             [Reset afterwards]
!!VRy1:+1;
!!SN&y1<42:G[loopCombatStartVarsImprovedSpells];
!!IF:V936/0;                            [Quick Combat Flag]
!!SN:W^Summoned_Elemental_Perk^/0;


!?FU(OnAfterBattleUniversal)&1000;      [Reset vars after combat]

!!VRv9287:S0; !!VRv9288:S0; !!VRv9276:S0; !!VRv9277:S0;
!!VRv9278:S0; !!VRv9279:S0; !!VRv9280:S0; !!VRv9281:S0;
!!VRv9282:S0; !!VRv9283:S0;

!!SN:W^shield_var1^/0; !!SN:W^shield_var2^/0; [shield variable]
!!SN:W^sacrifice_var^/0;                [Reset vars after combat]
!!SN:W^Sorrow_Cast0^/0; !!SN:W^Sorrow_Cast1^/0;
!!SN:W^Force_Field_Cast^/0;             [Set Flag to false after battle Force Field]
!!SN:W^Mirth_Cast0^/0; !!SN:W^Mirth_Cast1^/0;
!!SN:W^Slayer_Cast0^/0; !!SN:W^Slayer_Cast1^/0;
!!SN:W^Mirth_Current_battle_round^/-1;
!!SN:W^Mirth_Stack_had_Moral^/-1;
!!SN:W^Bloodlust_Cast0^/0; !!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Fortune_Cast0^/0; !!SN:W^Fortune_Cast1^/0;
!!SN:W^Prayer_Cast0^/0; !!SN:W^Prayer_Cast1^/0;
!!SN:W^Curse_Cast0^/0; !!SN:W^Curse_Cast1^/0;
!!SN:W^Weakness_Cast0^/0; !!SN:W^Weakness_Cast1^/0;
!!SN:W^Shield_Cast0^/0;   !!SN:W^Shield_Cast1^/0;
!!SN:W^Fire_Shield_Cast0^/0; !!SN:W^Fire_Shield_Cast1^/0;
!!SN:W^Slow_Cast0^/0; !!SN:W^Slow_Cast1^/0;
!!SN:W^Haste_Cast0^/0; !!SN:W^Haste_Cast1^/0;
!!SN:W^Bless_Cast0^/0; !!SN:W^Bless_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0; !!SN:W^Stoneskin_Cast1^/0;
!!SN:W^Stoneskin_Cast00^/0; !!SN:W^Stoneskin_Cast11^/0;
!!SN:W^Heal_Cast0^/0; !!SN:W^Heal_Cast1^/0;
!!SN:W^Improved_Cure^/0;
!!SN:W^Magic_Mirror_Cast0^/0; !!SN:W^Magic_Mirror_Cast1^/0;
!!SN:W^Air_Shield_Cast0^/0; !!SN:W^Air_Shield_Cast1^/0;
!!SN:W^Animate_Cast0^/0; !!SN:W^Animate_Cast1^/0;
!!SN:W^Improved_Magic_Arrow_Counter^/0;
!!SN:W^Fire_Protection_Cast_0^/0;
!!SN:W^Fire_Protection_Cast_1^/0;
!!SN:W^Water_Protection_Cast_0^/0;
!!SN:W^Water_Protection_Cast_1^/0;
!!SN:W^Earth_Protection_Cast_0^/0;
!!SN:W^Earth_Protection_Cast_1^/0;
!!SN:W^Air_Protection_Cast_0^/0;
!!SN:W^Air_Protection_Cast_1^/0;
!!SN:W^H3_Summon_Fire_0^/0;
!!SN:W^H3_Summon_Fire_1^/0;
!!SN:W^H3_Summon_Earth_0^/0;
!!SN:W^H3_Summon_Earth_1^/0;
!!SN:W^H3_Summon_Water_0^/0;
!!SN:W^H3_Summon_Water_1^/0;
!!SN:W^H3_Summon_Air_0^/0;
!!SN:W^H3_Summon_Air_1^/0;

!!DO(AC_Function_125)/0/41/1&1000:P10;       [Reset Position for Teleport]


!?BR&1000/-936;
!!DO(AC_Function_106)/0/41/1&v997>0:P;  [call function to take bonus]
!!DO(AC_Function_107)/0/41/1&v997=-1:P; [call function to remember HP for Force Field]

!!SN:W^Heal_Var1^/1;                    [Reset Heal_Var1 Variable]
!!SN:W^Heal_Var2^/1;                    [Reset Heal_Var2 Variable]
!!SN:W^Heal_Cast0^/0; !!SN:W^Heal_Cast1^/0;
!!SN:W^Bers_spread^/0;                  [Reset Bers_spread Variable]
!!SN:W^Slow_Cast0^/0; !!SN:W^Slow_Cast1^/0; [Reset Slow_Cast Variable]
!!SN:W^Haste_Cast0^/0; !!SN:W^Haste_Cast1^/0;
!!SN:W^Bless_Cast0^/0; !!SN:W^Bless_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0; !!SN:W^Stoneskin_Cast1^/0;
!!SN:W^Bloodlust_Cast0^/0; !!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Death_Ripple_Cast0^/0; !!SN:W^Death_Ripple_Cast1^/0; [Reset Death Ripple Cast]
!!SN:W^Destroy_Undead_Cast1^/0; !!SN:W^Destroy_Undead_Cast0^/0;

!?BR-1&v997>0;                          [At round End]
*!IF:M^Round %V997^;

!!SN:W^Fire_Protection_Cast_0^/?y1;     [Attacker Cast]
!!SN:W^Water_Protection_Cast_0^/?y2;
!!SN:W^Earth_Protection_Cast_0^/?y3;
!!SN:W^Air_Protection_Cast_0^/?y4;
!!DO(AC_Function_94)/0/20/1|y1>0/y2>0/y3>0/y4>0:P-10; [Only run if at least one Protection Spell was cast and pass attacking hero (-10)]

!!SN:W^Fire_Protection_Cast_1^/?y1;     [Defender Cast]
!!SN:W^Water_Protection_Cast_1^/?y2;
!!SN:W^Earth_Protection_Cast_1^/?y3;
!!SN:W^Air_Protection_Cast_1^/?y4;
!!DO(AC_Function_94)/21/41/1|y1>0/y2>0/y3>0/y4>0:P-20; [Only run if at least one Protection Spell was cast and pass defending hero (-20)]


!?FU(AC_Function_94);
!!BMx16:I?y1;
!!BA:Hy1/?y99;
!!FU&y99<0:E;
!!HEy99:Fd/d/?y86/d;

!!SN:W^H3_Air Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Air Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G30/?y2/?y3;
!!DO(AC_Function_95)/60/60/1&y2>0/y3=3/y11=1:Px16/30/y87; [If Protection from Air Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]

!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Fire Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G31/?y2/?y3;
!!DO(AC_Function_95)/42/62/1&y2>0/y3=3/y11=1:Px16/31/y87; [If Protection from Fire Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]

!!SN:W^H3_Water Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Water Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G32/?y2/?y3;
!!DO(AC_Function_95)/45/62/1&y2>0/y3=3/y11=1:Px16/32/y87; [If Protection from Water Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]

!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y11; !!SN:W^H3_Earth Magic_1_Hero%Y99^/?y12; !!VRy87:Sy86:2+10; !!VRy87&y12=1:+20; !!VRy87&y87>=75:S75;
!!BMx16:G33/?y2/?y3;
!!DO(AC_Function_95)/50/62/1&y2>0/y3=3/y11=1:Px16/33/y87; [If Protection from Earth Spell is applied at Expert run function to remove. Pass Creature Number, Element, chance to shake off]


!?FU(AC_Function_95);
!!VRy10:S0T99;

!!if&x16=60;                           [Air Spells (Hypno)]
!!BMx1&x2=30:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=30/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=30/y2>0/y10<x3:S^CURE^;
!!SN&x2=30/y2>0/y10<x3:Pz-1;
!!en;

!!if|x16=52/x16=42/x16=62/x16=59;      [Fire Spells]
!!BMx1&x2=31:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=31/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=31/y2>0/y10<x3:S^CURE^;
!!SN&x2=31/y2>0/y10<x3:Pz-1;
!!en;

!!if|x16=45/x16=61;                    [Water Spells]
!!BMx1&x2=32:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=32/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=32/y2>0/y10<x3:S^CURE^;
!!SN&x2=32/y2>0/y10<x3:Pz-1;
!!en;

!!if|x16=54/x16=50;                    [Earth Spells]
!!BMx1&x2=33:Gx16/?y2/?y3;              [Check for Spell]
!!BMx1&x2=33/y2>0/y10<x3:Gx16/1/?y33;   [Remove Spell]
!!VRz-1&x2=33/y2>0/y10<x3:S^CURE^;
!!SN&x2=33/y2>0/y10<x3:Pz-1;
!!en;


********************************************************************************
!?FU(OnBattleRegeneratePhase)&1000;     [Reset Attacking Stacks Function]

!!SN:W^Weakness_Attacking_Stack^/-1;
!!SN:W^Curse_Attacking_Stack^/-1;
!!SN:W^Fortune_Attacking_Stack^/-1;
!!SN:W^Misfortune_Attacking_Stack^/-1;
!!SN:W^Slayer_Attacking_Stack^/-1;
!!SN:W^Mirth_Attacking_Stack^/-1;
!!SN:W^Fire_Shield_Attacking_Stack^/-1;
!!SN:W^Prayer_Shield_Attacking_Stack^/-1;
!!SN:W^Sorrow_Shield_Attacking_Stack^/-1;
!!SN:W^Shield_Attacking_Stack^/-1;
!!SN:W^Prayer_Attacking_Stack^/-1;
!!SN:W^Sorrow_Attacking_Stack^/-1;
!!SN:W^Ray_Attacking_Stack^/-1;
!!SN:W^Stoneskin_Attacking_Stack^/-1;
!!SN:W^Summon_Attacking_Stack^/-1;
!!SN:W^Coordinated_Attacking_Stack^/-1;
!!SN:W^BlessSpell_Attacking_Stack^/-1;
!!SN:W^Counterstrike_Attacking_Stack^/-1;


********************************************************************************
!?BG0&1000/-936;

!!BG:Q?v9280;                           [Current attacking side]
!!BH0:N?v9281;                          [Attacking Hero]
!!BH1:N?v9282;                          [Defending Hero]
!!BG:H?v9283;                           [Current attacking hero]

!!BA:Q?y1;
!!IF&y1=1:V936/1;
!!FU&y1=1:E;

!!BG:H?v9447;                           [Determine if AI controlls Hero]
!!HEv9447:O?v9447;
!!OW:Iv9447/?v9447;

!!BG:A?y1;
!!FU&y1<>1|v9447=1:E;


!!SN:W^H3_Fire Magic_0_Hero%V9283^/?y11;[Fire Magic Bonus handling]
!!SN:W^H3_Air Magic_0_Hero%V9283^/?y12; [Air Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%V9283^/?y13;[Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%V9283^/?y14;[Earth Magic Bonus handling]

!!HEv9283:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Magien hat (deleted all y85 requirements)]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!if&y2=46/y84=3/y14=1;
!!VRv9290:S100;                         [Stoneskin]
!!en;

!!if&y2=41/y83=3/y13=1;
!!VRv9290:S101;                         [Blessing]
!!en;

!!if&y2=43/y81=3/y11=1;
!!VRv9290:S102;                         [Bloodlust]
!!en;

!!if&y2=44/y82=3/y12=1;
!!VRv9290:S103;                         [Precision]
!!en;

!!if&y2=53/y82=3/y12=1;
!!VRv9290:S104;
!!SN&v9280=0:W^Haste_Cast0^/?y1;
!!SN&v9280=1:W^Haste_Cast1^/?y1;        [Haste]
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call early for slow check]
!!en;

!!if&y2=54/y84=3/y14=1;
!!VRv9290:S105;                         [Slow]
!!SN&v9280=0:W^Slow_Cast0^/?y1;
!!SN&v9280=1:W^Slow_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call early for haste check]
!!en;

!!if&y2=37/y83=3/y13=1;
!!VRv9290:S106;                         [Heal]
!!en;

*!if&y2=27/y84=3/y10=1;
*!VRv9290:S107;                                                                 [Shield] replaced
*!en;

!!if&y2=28/y82=3/y12=1;
!!VRv9290:S108;                         [Air Shield]
!!en;

!!if&y2=36/y82=3/y12=1;
!!VRv9290:S109;                         [Anti Magic]
!!en;

!!if&y2=34/y84=3/y14=1;
*!VRv9290:S110;                         [Counterspell]
!!en;

!!if&y2=49/y83=3/y13=1;
!!VRv9290:S111;                         [Mirth]
!!SN&v9280=0:W^Mirth_Cast0^/1;
!!SN&v9280=1:W^Mirth_Cast1^/1;
!!en;

*!if&y2=51/y82=3/y10=1;
*!VRv9290:S112;                                                                 [Luck]
*!en;

!!if&y2=58/y82=3/y12=1;
!!VRv9290:S113;                         [Counterstrike]
!!en;

!!if&y2=55/y81=3/y11=1;
!!VRv9290:S114;                         [Slayer]
!!en;

!!if&y2=29/y81=3/y11=1;
!!VRv9290:S115;                         [Fire Shield]
!!en;

!!if&y2=56/y81=3/y11=1;
*!VRv9290:S116;                         [Frenzy]
!!en;

!!if&y2=31/y81=3/y11=1;
!!VRv9290:S117;                         [Protection from Fire]
!!SN&v9280=0:W^Fire_Protection_Cast_0^/1;
!!SN&v9280=1:W^Fire_Protection_Cast_1^/1;
!!en;

!!if&y2=32/y83=3/y13=1;
!!VRv9290:S118;                         [Protection from Water]
!!SN&v9280=0:W^Water_Protection_Cast_0^/1;
!!SN&v9280=1:W^Water_Protection_Cast_1^/1;
!!en;

!!if&y2=33/y84=3/y14=1;
!!VRv9290:S119;                         [Protection from Earth]
!!SN&v9280=0:W^Earth_Protection_Cast_0^/1;
!!SN&v9280=1:W^Earth_Protection_Cast_1^/1;
!!en;

!!if&y2=30/y82=3/y12=1;
!!VRv9290:S120;                         [Protection from Air]
!!SN&v9280=0:W^Air_Protection_Cast_0^/1;
!!SN&v9280=1:W^Air_Protection_Cast_1^/1;
!!en;

!!if&y2=66/y81=3/y11=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S121;                         [Fire Elemental]
!!en;

!!if&y2=67/y84=3/y14=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S122;                         [Earth Elemental]
!!en;

!!if&y2=68/y83=3/y13=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S123;                         [Water Elemental]
!!en;

!!if&y2=69/y82=3/y12=1;
!!VRv9287&v9280=0:S10;                  [for attacker]
!!VRv9288&v9280=1:S10;                  [for defender]
!!VRv9290:S124;                         [Air Elemental]
!!en;

!!if&y2=65/y83=3/y13=1;
!!VRv9290:S125;                         [Clone Spell]
!!en;

*!if&y2=51/y82=3/y12=1;
*!VRv9290:S126;                                                                 [Luck2]
*!en;

!!if&y2=38/y84=3/y14=1;
!!VRv9290:S127;                         [Ressurect]
!!en;

!!if&y2=48/y83=3/y13=1;
!!VRv9290:S128;                         [Prayer]
!!SN&v9280=0:W^Prayer_Cast0^/1;
!!SN&v9280=1:W^Prayer_Cast1^/1;
!!en;

!!if&y2=50/y84=3/y14=1;
!!VRv9290:S129;                         [Sorrow]
!!SN&v9280=0:W^Sorrow_Cast0^/1;
!!SN&v9280=1:W^Sorrow_Cast1^/1;
!!en;

!!if&y2=47/y82=3/y12=1;
!!VRv9290:S130;                         [Disrupting Ray]
!!en;

!!if&y2=11/y81=3/y11=1;
!!VRv9290:S131;                         [Landmine]
!!SN:W^landmine_var^/?y90;
!!VRy90:+1;
!!SN:W^landmine_var^/y90;
!!en;

!!if&y2=45/y83=3/y13=1;
!!VRv9290:S132;                         [Weakness]
!!SN&v9280=0:W^Weakness_Cast0^/1;
!!SN&v9280=1:W^Weakness_Cast1^/1;
!!en;

!!if&y2=42/y81=3/y11=1;
!!VRv9290:S133;                         [Curse]
!!SN&v9280=0:W^Curse_Cast0^/1;
!!SN&v9280=1:W^Curse_Cast1^/1;
!!en;

!!if&y2=61/y83=3/y13=1;
!!VRv9290:S134;                         [Forgetfulness]
!!en;

!!if&y2=27/y84=3/y14=1;
!!VRv9290:S135;                         [Shield 2]
!!SN&v9280=0:W^Shield_Cast0^/1;
!!SN&v9280=1:W^Shield_Cast1^/1;
!!en;

!!if&y2=62/y81=3/y11=1;
!!VRv9290:S136;                         [Blind]
!!en;

!!if&y2=52/y81=3/y11=1;
!!VRv9290:S137;                         [Misfortune]
!!SN&v9280=0:W^Misfortune_Cast0^/1;
!!SN&v9280=1:W^Misfortune_Cast1^/1;
!!en;

!!if&y2=51/y82=3/y12=1;
!!VRv9290:S138;                         [Fortune (Luck 3)]
!!SN&v9280=0:W^Fortune_Cast0^/1;
!!SN&v9280=1:W^Fortune_Cast1^/1;
!!en;

!!if&y2=24/y84=3/y14=1;
!!VRv9290:S139;                         [Death Ripple]
!!en;

!!if&y2=25/y82=3/y12=1;
!!VRv9290:S140;                         [Destroy Undead]
!!en;

!!if&y2=13/y81=3/y11=1;
!!VRv9290:S141;                         [Firewall]
!!en;

!!if&y2=35/y83=3/y13=1;
!!VRv9290:S142;                         [Dispel]. Also look at [call function for dispel]
!!en;

!!if&y2=40/y81=3/y11=1;
!!SN:W^sacrifice_var^/?y34;
!!VRv9290&y34=0:S143;                   [Sacrificed]
!!en;

!!if&y2=42;
*!DO(AC_Function_122)/0/41/1:P;         [curse call fkt bless check]
!!en;

!!if&y2=35;
!!DO(AC_Function_108)/0/41/1:P;         [call funtion for dispel]
!!en;

!!if&y2=37;                            [call funtion for heal]
!!SN&y83=3/y13=1:W^Improved_Cure^/1;
!!DO(AC_Function_121)/0/41/1:P;
!!en;

!!if&y2=12/y84=3/y14=1;
!!SN:W^Force_Field_Cast^/1;             [Set Flag to True isf cast is Force Field]
!!VRv9290:S144;                         [Force Field]
!!en;

!!if&y2=10/y84=3/y14=1;
!!VRv9290:S145;                         [Quicksand]
!!en;

!!if&y2=63/y83=3/y13=1;
!!VRv9290:S146;                         [Teleport]
!!DO(AC_Function_125)/0/41/1:P;
!!if&y81=3/y11=1;                      [Increase big ones amount by 1 if also Master Fire. @alf]
!!SN:W^landmine_var^/?y90;
!!VRy90:+1;
!!SN:W^landmine_var^/y90;
!!en;
!!en;

!!if&y2=14/y84=3/y14=1;
!!VRv9290:S147;                         [Earthquake]
!!en;

!!if&y2=64/y81=3/y11=1;
!!VRv9290:S148;                         [Remove Obstacle]
!!en;

!!if&y2=26/y81=3/y11=1;
!!VRv9290:S149;                         [Armageddon]
!!DO(AC_Function_97)/0/20/1&v9280=0:P;
!!DO(AC_Function_97)/21/41/1&v9280=1:P;
!!en;

!!if&y2=59/y81=3/y11=1;
!!VRv9290:S150;                         [Berserker]
!!SN:W^Bers_en^/1;
!!en;

!!if&y2=60/y82=3/y12=1;
!!VRv9290:S151;                         [Hypnotize]
*!SN:W^Bers_en^/1;
!!en;

!!if&y2=39/y84=3/y14=1;
!!VRv9290:S152;                         [Animate Dead]
!!DO(AC_Function_104)/0/41/1:P;
!!SN&v9280=0:W^Animate_Cast0^/?y1;
!!SN&v9280=1:W^Animate_Cast1^/?y1;
!!SN&y1=0:W^Animate_Dead^/1;
!!SN&v9280=0:W^Animate_Cast0^/1;        [So it only works once per combat]
!!SN&v9280=1:W^Animate_Cast1^/1;
!!en;

!!if&y2=15;
!!VRv9290|y11=1/y12=1/y13=1/y14=1:S153; [Magic Arrow]
!!en;

********************************************************************************
!?BG1&1000/-936;                        [run forest]
!!BG:H?v9447;                           [Determine if AI controlls Hero]
!!HEv9447:O?v9447;
!!OW:Iv9447/?v9447;

!!FU&v9447=1:E;

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;
!!BA:Q?f;

!!SN:W^H3_Fire Magic_0_Hero%V9283^/?y11;[Fire Magic Bonus handling]
!!SN:W^H3_Air Magic_0_Hero%V9283^/?y12; [Air Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%V9283^/?y13;[Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%V9283^/?y14;[Earth Magic Bonus handling]

!!if&v9290=100;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Pv9283/46/1/d/?y22;
!!VRz-1:S^You cast {improved Stone Skin}.
+%Y22 defense for this round.^;
*!BU&1000/f=0:Mz-1;
!!SN&v9280=0:W^Stoneskin_Cast0^/?y1;
!!SN&v9280=1:W^Stoneskin_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for Stoneskin]
!!SN&v9280=0:W^Stoneskin_Cast0^/1;      [Only for Battle Round]
!!SN&v9280=1:W^Stoneskin_Cast1^/1;
!!SN&v9280=0:W^Stoneskin_Cast00^/1;     [For whole Battle]
!!SN&v9280=1:W^Stoneskin_Cast11^/1;
!!en;


!!if&v9290=101;
  !!VRz1:S^You cast {improved Bless}.
  +2 damage for this round.^;
  *!BU&1000/f=0:Mz1;
  !!SN&v9280=0:W^Bless_Cast0^/?y1;
  !!SN&v9280=1:W^Bless_Cast1^/?y1;
  *!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for Bless]
  !!SN&v9280=0:W^Bless_Cast0^/1;
  !!SN&v9280=1:W^Bless_Cast1^/1;
    !!re i/0/20;
    !!SN&v9280=0:W^Bless_Strike_Creature%Vi^/1; Enable Bless Strike
    !!en;
    !!re i/21/41;
    !!SN&v9280=1:W^Bless_Strike_Creature%Vi^/1; Enable Bless Strike
    !!en;
!!en;


!!if&v9290=102;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>43:Pv9283/43/1/d/?y22;
!!VRz1:S^You cast {improved Bloodlust}.
+%Y22 attack for this round and attack for every enemy stack slain.^;
*!BU&1000/f=0:Mz1;
!!SN:W^Bloodlust_Cast%V9280^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for bloodlust]
!!SN:W^Bloodlust_Cast%V9280^/1;
!!en;


!!if&v9290=103;
!!VRz1:S^You cast {improved Precision}.
Shooters can shoot when adjacent this round.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for precision]
  !!re i/0/20;
  !!SN&v9280=0:W^Precision_Strike_Creature%Vi^/1; Enable Bless Strike
  !!en;
  !!re i/21/41;
  !!SN&v9280=1:W^Precision_Strike_Creature%Vi^/1; Enable Bless Strike
  !!en;
!!en;


!!if&v9290=104;
!!VRz1:S^You cast {improved Haste}.
+1 extra speed this round.^;
*!BU&1000/f=0:Mz1;
!!SN&v9280=0:W^Haste_Cast0^/?y1;
!!SN&v9280=1:W^Haste_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for Haste]
!!SN&v9280=0:W^Haste_Cast0^/1;
!!SN&v9280=1:W^Haste_Cast1^/1;

!!SN&v9280=1:W^Slow_Cast0^/0;
!!SN&v9280=0:W^Slow_Cast1^/0;
!!en;


!!if&v9290=105;
!!VRz1:S^You cast {improved Slow}.
-1 extra speed this round^;
*!BU&1000/f=0:Mz1;
!!SN&v9280=0:W^Slow_Cast0^/?y1;
!!SN&v9280=1:W^Slow_Cast1^/?y1;
!!DO(AC_Function_105)/0/41/1&y1=0:P;    [call funktion for slow]
!!SN&v9280=0:W^Slow_Cast0^/1;
!!SN&v9280=1:W^Slow_Cast1^/1;

!!SN&v9280=1:W^Haste_Cast0^/0;
!!SN&v9280=0:W^Haste_Cast1^/0;
!!en;


!!if&v9290=106;
!!VRz1:S^You cast {improved Cure}.
Heals over the maximum HP of your creatures, reviving them if possible.^;
*!BU&1000/f=0:Mz1;
!!if&v9280=0;
*!SN:W^Heal_Var1^/11;
*!SN:W^Heal_Cast0^/?y1;
*!DO(AC_Function_105)/0/20/1&y1=0:P;
*!SN:W^Heal_Cast0^/1;                                                           [call funktion for heal attacker]
!!en;
!!if&v9280=1;
*!SN:W^Heal_Var2^/11;
*!SN:W^Heal_Cast1^/?y1;
*!DO(AC_Function_105)/21/41/1&y1=0:P;
*!SN:W^Heal_Cast1^/1;                                                           [call funktion for heal defender]
!!en;
!!SN&v9280=1:W^Slow_Cast0^/0;
!!SN&v9280=0:W^Slow_Cast1^/0;
!!en;

!!if&v9290=107;
!!VRz1:S^You cast {improved Shield}.
Chance to block extra damage this round.^;
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_105)/0/41/1:P;         [call funktion for shield]
!!en;


!!if&v9290=108;
!!VRz1:S^You cast {improved Air Shield}.
Small chance to dodge ranged attacks.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for air shield]
!!SN&v9280=0:W^Air_Shield_Cast0^/1;
!!SN&v9280=1:W^Air_Shield_Cast1^/1;
!!en;

!!if&v9290=109;
!!VRz1:S^You cast {improved Magic Mirror}
Mirrors all spells to your enemies.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for magic mirror]
!!SN&v9280=0:W^Magic_Mirror_Cast0^/1;
!!SN&v9280=1:W^Magic_Mirror_Cast1^/1;
!!en;

!!if&v9290=110;
!!VRz1:S^You cast {improved Anti-Magic}.
Your creature gets dispel ability this round.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for counterspell]
!!en;

!!if&v9290=111;
!!VRz1:S^You cast {improved Mirth}.
Next attack deals extra damage if stack had positive morale.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for mirth] *changed from fly to bonus damage
!!en;

!!if&v9290=112;
!!VRz1:S^You cast {improved Luck}.
Your creatures get champion distance bonus this round.^;
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_105)/0/41/1:P;         [call funktion for luck]
!!en;

!!if&v9290=113;
!!VRz1:S^You cast {improved Counterstrike}.
Your creatures get no retaliation this round.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for counterstrike]
!!SN&v9280=0:W^Counterstrike_Cast0^/1;
!!SN&v9280=1:W^Counterstrike_Cast1^/1;
!!en;

!!if&v9290=114;
!!VRz1:S^You cast {improved Slayer}.
Chance for crushing blows against lvl 7 creatures.^;
*!BU&1000/f=0:Mz1;
!!SN&v9280=0:W^Slayer_Cast0^/1;         [call funktion for slayer]
!!SN&v9280=1:W^Slayer_Cast1^/1;
!!en;

!!if&v9290=115;
!!VRz1:S^You cast {improved Fire Shield}.
Chance to summon Fire Elementals when attacking the Fire Shield.^;
*!BU&1000/f=0:Mz1;
!!SN&v9280=0:W^Fire_Shield_Cast0^/1;
!!SN&v9280=1:W^Fire_Shield_Cast1^/1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for fire shield]
!!en;

!!if&v9290=116;
!!VRz1:S^You cast {improved Frenzy}.
Chance that your creature gets attack and return this round.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;         [call funktion for frenzy]
!!en;

!!if&v9290=117;
!!VRz1:S^You cast {improved Protection from Fire}.
Chance to cast Magic Arrow after attack.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Fire]
!!en;

!!if&v9290=118;
!!VRz1:S^You cast {improved Protection from Water}.
Chance to cast Magic Arrow after attack.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Water]
!!en;

!!if&v9290=119;
!!VRz1:S^You cast {improved Protection from Earth}.
Chance to cast Magic Arrow after attack.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Earth]
!!en;

!!if&v9290=120;
!!VRz1:S^You cast {improved Protection from Air}.
Chance to cast Magic Arrow after attack.^;
*!BU&1000/f=0:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Protection from Air]
!!en;

!!if&v9290=121;
!!VRz1:S^You cast {improved Summoning Fire Elementals}.
Your summoned fire elementals grow for 3 battleround.^;
*!BU&1000/f=0:Mz1;
!!VRv9276:S1;                           [call for Summon Fire]
!!SN&v9280=1:W^H3_Summon_Fire_0^/v997;
!!SN&v9280=0:W^H3_Summon_Fire_1^/v997;  [Save var with Current Battle Round]
!!en;

!!if&v9290=122;
!!VRz1:S^You cast {improved Summoning Earth Elementals}.
Your summoned earth elementals grow for 3 battleround.^;
*!BU&1000/f=0:Mz1;
!!VRv9277:S1;                           [call for Summon Earth]
!!SN&v9280=1:W^H3_Summon_Earth_0^/v997;
!!SN&v9280=0:W^H3_Summon_Earth_1^/v997; [Save var with Current Battle Round]
!!en;

!!if&v9290=123;
!!VRz1:S^You cast {improved Summoning Water Elementals}.
Your summoned water elementals grow for 3 battleround.^;
*!BU&1000/f=0:Mz1;
!!VRv9278:S1;                           [call for Summon Water]
!!SN&v9280=1:W^H3_Summon_Water_0^/v997;
!!SN&v9280=0:W^H3_Summon_Water_1^/v997; [Save var with Current Battle Round]
!!en;

!!if&v9290=124;
!!VRz1:S^You cast {improved Summoning Air Elementals}.
Your summoned air elementals grow for 3 battleround.^;
*!BU&1000/f=0:Mz1;
!!VRv9279:S1;                           [call for Summon Air]
!!SN&v9280=1:W^H3_Summon_Air_0^/v997;
!!SN&v9280=0:W^H3_Summon_Air_1^/v997;   [Save var with Current Battle Round]
!!en;

!!if&v9290=125;
!!VRz1:S^You cast {improved Clone}. ALL clones grow in numbers.^;
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_105)/0/41/1:P;         [call funktion for Clone]
!!en;

*!if&v9290=126;
*!VRz1:S^You cast {improved Luck}.
*Chance for Landmine.^;
*!BU:Mz1;
*!DO(AC_Function_105)/0/41/1:P;                                                             [call funktion for Luck2]
*!en;

!!if&v9290=127;
!!VRz1:S^You cast {improved Resurrection}.
Additional random buff for resurrected stack.^;                                 [call funktion for Resurrection]
*!BU&1000/f=0:Mz1;
!!BG:E?y12;
!!VRy28:S0T18;
!!VRy28&y28=0:S27; !!VRy28&y28=1:S28; !!VRy28&y28=2:S29; !!VRy28&y28=3:S30; !!VRy28&y28=4:S31; !!VRy28&y28=5:S32;
!!VRy28&y28=6:S33; !!VRy28&y28=7:S34; !!VRy28&y28=8:S36; !!VRy28&y28=9:S41; !!VRy28&y28=10:S43; !!VRy28&y28=11:S44;
!!VRy28&y28=12:S46; !!VRy28&y28=13:S48; !!VRy28&y28=14:S49; !!VRy28&y28=15:S51; !!VRy28&y28=16:S53; !!VRy28&y28=17:S55;
!!VRy28&y28=18:S58;
!!BMy12:My28/2/3;                       [apply buff when resurrection]
!!en;

!!if&v9290=128;
!!VRz1:S^You cast {improved Prayer}.
Additional holy damage against undead troops.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Prayer]
!!en;

!!if&v9290=129;
!!VRz1:S^You cast {improved Sorrow}.
Enemies deals less damage to bigger creatures.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Sorrow]
!!en;

!!if&v9290=130;
!!VRz1:S^You cast {improved Disrupting Ray}.
+2 additional damage for every stack attacking this stack.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Disrupting Ray]
!!BG:E?y12;
!!FU&y12=-1:E;
!!BMy12:G46/?y13/?y14;                  [Disrupting Ray removes Stone Skin and disables master bonus @alf]
!!FU(TakeStoneSkinBonusDisRay)&y13>0:Py3;
!!SN&y12<>-1:W^DisruptingRayCastsStack%Y12^/d+1;
!!FU(AC_ResetSpellFromStack):Py12/46;
!!en;

!!if&v9290=131;
!!VRz1:S^You cast {improved Landmine}.
Every creature stepping on a landmine loses speed, depending on monster level.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Landmine]
!!en;

!!if&v9290=132;
!!VRz1:S^You cast {improved Weakness}.
Enemies deals reduced damage for every battleround weakness lasts.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Weakness]
!!en;

!!if&v9290=133;
!!VRz1:S^You cast {improved Curse}.
Enemies deals reduced damage for every debuff affecting the stack.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Curse]
!!SN&v9280=1:W^Bless_Cast0^/0;
!!SN&v9280=0:W^Bless_Cast1^/0;
!!en;

!!if&v9290=134;
!!VRz1:S^You cast {improved Forgetfulness}.
Chance that shooters attack their neighbouring stack.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for Forgetfulness]
!!DO(AC_Function_113)/0/41/1:P;
!!en;

!!if&v9290=135;
!!VRz1:S^You cast {improved Shield}.
First stack in stack gets a damage absorbing shield.^;
*!BU&1000/f=0:Mz1;
!!SN:W^shield_var1^/?y1;
!!SN:W^shield_var2^/?y2;                [call funktion for Shield 2]
!!if&v9280=0/y1=0;
!!DO(AC_Function_105)/0/20/1:P;
!!SN:W^shield_var1^/10;
!!en;
!!if&v9280=1/y2=0;
!!DO(AC_Function_105)/21/41/1:P;
!!SN:W^shield_var2^/10;
!!en;
!!en;

!!if&v9290=136;
!!VRz1:S^You cast {improved Blind}.
Blind cannot be dispelled or cured for the current battle round.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for blind]
!!en;

!!if&v9290=137;
!!VRz1:S^You cast {improved Misfortune}.
Enemies has a chance to deal reduced damage with attacks.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for misfortune]
!!en;

!!if&v9290=138;
!!VRz1:S^You cast {improved Fortune}.
Chance to steal stat values from your enemies with attack.^;
*!BU&1000/f=0:Mz1;                                                                       [call funktion for fortune]
!!en;

!!if&v9290=139;
!!VRz1:S^You cast {improved Death Ripple}.
All living creatures lose 1 morale for the current battle round.^;
*!BU&1000/f=0:Mz1;
!!SN&v9280=1:W^Death_Ripple_Cast1^/1;   [Defender]
!!SN&v9280=0:W^Death_Ripple_Cast0^/1;   [Attacker]
!!en;

!!if&v9290=140;
!!VRz1:S^You cast {improved Destroy Undead}.
All living creatures get 1 morale for the current battle round.^;
*!BU&1000/f=0:Mz1;
!!SN&v9280=1:W^Destroy_Undead_Cast1^/1; [Defender]
!!SN&v9280=0:W^Destroy_Undead_Cast0^/1; [Attacker                               [call funktion for destroy undead]
!!en;

!!if&v9290=141;
!!VRz1:S^You cast {improved Firewall}.
If enemies pass more than once through your firewall they explode.^;            [call funktion for firewall]
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=142;
!!VRz1:S^You cast {improved Dispel}.
After dispel cast your buffs still last for the current battle round.^;         [call funktion for dispel]
!!SN:W^Slow_Cast0^/0;
!!SN:W^Slow_Cast1^/0;
!!SN:W^Bloodlust_Cast0^/0;
!!SN:W^Bloodlust_Cast1^/0;
!!SN:W^Bless_Cast0^/0;
!!SN:W^Bless_Cast1^/0;
!!SN:W^Haste_Cast0^/0;
!!SN:W^Haste_Cast1^/0;
!!SN:W^Stoneskin_Cast0^/0;
!!SN:W^Stoneskin_Cast1^/0;
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=143;
!!VRz1:S^You cast {improved Sacrifice}.
The sacrificed stack gets revived martyr.^;                                     [call funktion for sacrifice]
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_105)/0/41/1:P;
!!en;

!!if&v9290=144;
!!VRz1:S^You cast {improved Force Field}.
Creatures next to the Force Field have increased combat power.^;                [call funktion for Force Field]
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=145;
!!VRz1:S^You cast {improved Quicksand}.
Places one patch of quicksand in front of all your shooting troops.^;           [call funktion for Quicksand]
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_123)/0/20/1&v9280=0:P;
!!DO(AC_Function_123)/21/41/1&v9280=1:P;
!!en;

!!if&v9290=146;
!!VRz1:S^You cast {improved Teleport}.
Teleported creatures get surrounded with landmines.^;                           [call funktion for Teleport]
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_124)/0/41/1:P;
!!en;

!!if&v9290=147;
!!VRz1:S^You cast {improved Earthquake}.
Chance to stun enemy creatures. They also loose ammunition^;                    [call funktion for Earthquake]
*!BU&1000/f=0:Mz1;
!!DO(AC_Function_127)/21/41/1:P;
!!BU&1000/f=0:R;
!!en;

!!if&v9290=148;
!!VRz1:S^You cast {improved Remove Obstacle}.
Chance to cast again after the obstacle is removed^;                            [call funktion for Remove Obstacle]
*!BU&1000/f=0:Mz1;
!!FU(AC_Function_96):P;
!!en;

!!if&v9290=149;
!!VRz1:S^You cast {improved Armageddon}.
Your troops are resistant to fire and take less damage from Armageddon^;        [call funktion for Armageddon]
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=150;
!!VRz1:S^You cast {improved Berserk}.
After Berserk wears off, enemy creatures are exhausted^;                        [call funktion for Berserker]
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=151;
!!VRz1:S^You cast {improved Hypnotize}.
Hypnotized creatures have a chance to blind enemy creatures^;                   [call funktion for Hypnotize]
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=152;
!!VRz1:S^You cast {improved Animate Dead}.
Undead stacks heal and with next attack^;                                        [call funktion for Animate Dead]
!!DO(AC_Function_128)/0/41/1:P;
*!BU&1000/f=0:Mz1;
!!en;

!!if&v9290=153;
!!SN:W^Improved_Magic_Arrow_Counter^/?y20;
!!if&y20<2;
!!SN:W^Stack_Number^/?y50;
!!if&y50>=0/y50<=41;
!!BMy50:N?y51;
!!if&y51=0;
!!SN:W^Magic_Arrow_Hero%V9283^/?y10;    [refer to current casting hero]
!!FU|v9283<0/v9283>155:E;
!!HEv9283:E?y50/?y51/1;                 [Get level of Hero]
!!FU&y10>y51:E;                         [Exit if bigger hero level]
!!SN:T^AC_Misc.Arrow damage increase^/?z1;
!!BU&1000/f=0:Mz1;
!!VRz1:S^CLIMAX^;
!!SN&f=0:Pz1;
!!SN:W^Magic_Arrow_Hero%V9283^/d+1;     [when magic arrow was cast increase counter]
!!SN:W^Improved_Magic_Arrow_Counter^/d+1;
!!en;
!!SN:W^Stack_Number^/-1;
!!en;
!!en;
!!en;



!!VRv9290:S0;                           [Reset variable after cast]



********************************************************************************
*--------------------Destroy Undead --------------------------------*
!?BG1&1000;                             [Give Moral by One after every Action]

!!SN&v9280=1:W^Destroy_Undead_Cast1^/?y1;[Defender]
!!SN&v9280=0:W^Destroy_Undead_Cast0^/?y1;[Attacker                               [call funktion for destroy undead]
!!FU&y1=0:E;

!!DO(AC_Function_101)/0/20/1&v9280=0:P;
!!DO(AC_Function_101)/21/41/1&v9280=1:P;[call funktion for death ripple]

!?FU(AC_Function_101);
!!BMx16:F?y1 N?y3;                      [read flags]
!!VRy1:&16;                             [just look at alive]
!!FU|y1>0/y3<1:E;                       [Exit if no stack or has no morale Flag]
!!BMx16:G212/?y2/?t;                    [212 Moral]
!!VRy2:+1;                              [add positive morale to current morale]
!!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Morale]
!!VRy2&y2>=5:S5;                        [Cannot be more than +5 Morale]
!!BMx16:G212/y2/?t;                     [212 Moral]

********************************************************************************
*--------------------Death Ripple  --------------------------------*
!?BG1&1000;                             [Reduce Moral by One after every Action]

!!SN&v9280=0:W^Death_Ripple_Cast0^/?y1; [Attacker]
!!SN&v9280=1:W^Death_Ripple_Cast1^/?y1; [Defender]
!!FU&y1=0:E;

!!DO(AC_Function_109)/0/20/1&v9280=1:P;
!!DO(AC_Function_109)/21/41/1&v9280=0:P;[call funktion for death ripple]

!?FU(AC_Function_109);
!!BMx16:F?y1 N?y3;                      [read flags]
!!VRy1:&16;                             [just look at alive]
!!FU|y1=0/y3<1:E;                       [Exit if no stack or has no morale Flag]
!!BMx16:G212/?y2/?t;                    [212 Moral]
!!VRy2:-1;                              [add negative morale to current morale]
!!VRy2&y2<=-3:S-3;                      [Cannot be more than -3 Morale]
!!VRy2&y2>=5:S5;                        [Cannot be more than +5 Morale]
!!BMx16:G212/y2/?t;                     [212 Moral]


*-------------------------------Heal -----------------------------------------*
* Acts as little Resurrect
!?BG1&1000;

!!SN:W^Improved_Cure^/?y1;
!!FU&y1<>1:E;
!!HE-1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y86/d; [Checke ob der Held Sorcery und Magien hat  16 Water Magic 24 int]

!!BG:Q?y99;                             [Current attacking side]
!!BG:H?y2;
!!SN:W^H3_Water Magic_1_Hero%Y2^/?y87;  [Changed intelligence requirement to GM Water @Alf]
!!DO(AC_Function_110)/0/20/1&y99=0:Py87/y83/y86/y2;
!!DO(AC_Function_110)/21/41/1&y99=1:Py87/y83/y86/y2;

!!SN:W^Improved_Cure^/0;
!!BA:Q?f;
!!BU&f=0:R;


!?FU(AC_Function_110);

!!BMx16:N?y1 H?y2 L?y3 B?y4;
!!FU&y4=0:E;
!!FU&y2=0:E;
!!FU&y1=y4/y3=0:E;
!!BMx16:F?y5;
!!VRy5:&12582912;                       [Check for Clone Spell]
!!FU&y5>0:E;                            [Exit if Clone because they cannot be healed]
!!HEx4:X?y5/?y6/d/d/d/d/d;              [Check Hero Speciality]

!!SS37:P?y7;
!!SS37:Ex2/?y8;

!!VRy10&x2=3:S1 *x3 *y7 +y8;            [Set Cure for Expert @alf]
!!VRy10&x1>0:+100;                      [+100 HP with Intelligence] now GM Water @Alf]
!!VRy10&y5=3/y6=37:*2;                  [Cure specialists further doubles this bonus @Alf]

!!VRy12:Sy10 %y2;
!!VRy15:Sy3;
!!VRy15:Sy15-y12;
!!VRy16:Sy15;
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;
!!VRy16:*-1;
!!VRy17:Sy2;
!!VRy17:-y16;
!!VRy16:Sy17;
!!VRy11:+1;                             [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy16&y6>y4:S0;                       [Fix for Commander, Set lost life to zero if could heal more than 1 stack above maximum]
!!VRy6&y6>=y4:Sy4;                      [Set Number Cannot be more than before fight]

!!BMx16:Ny6 Ly16;                       [Set Number and apply rest life]


*-------------------------------blind -----------------------------------------*
*Withstands one Heal or Dispel try
!?BG1&1000/-936;                        [run forest]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!if&v9280=0;
!!SN:W^H3_Fire Magic_0_Hero%V9282^/?y11;[Fire Magic Bonus handling]
!!HEv9282:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!en;

!!if&v9280=1;
!!SN:W^H3_Fire Magic_0_Hero%V9281^/?y11;[Fire Magic Bonus handling]
!!HEv9281:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!en;

!!if&y2=35/y81=3/y11=1;
!!DO(AC_Function_111)/0/41/1:P;         [call funtion for cleanse]
!!en;

!!if&y2=37/y81=3/y11=1;
!!DO(AC_Function_111)/0/41/1:P;         [call funtion for heal]
!!en;


*-------------------------------dispel ----------------------------------------*
*lets you keep all buffs for current battle round
!?BG1&1000/v9447=0/-936;                [run forest]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<>35:E;                          [Exit if AIs turn]

!!BA:Hv9280/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!if&y2=35/y83=3/v9280=0/v9447=0/y13=1;
!!DO(AC_Function_116)/0/15/1:P;         [call funtion for cleanse]
!!BA:Q?f;
!!BU&f=0:R;
!!en;                                  [Run function to give back spells]

!!if&y2=35/y83=3/v9280=1/v9447=0/y13=1;
!!DO(AC_Function_116)/21/36/1:P;        [call funtion for cleanse]
!!BA:Q?f;
!!BU&f=0:R;
!!en;                                  [Run function to give back spells]


!?BG0&1000/v9447=0/-936;                [Extra Improved Dispel Trigger]

!!BG:A?y1;
!!FU&y1<>1:E;                           [Exit if no Hero cast]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<>35:E;                          [Exit if not cleanse]

!!BA:Hv9280/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!if&y2=35/y83=3/v9280=0/y13=1;
!!DO(AC_Function_115)/0/15/1:P;         [call funtion for cleanse]
!!en;                                  [Run function to remember spells]

!!if&y2=35/y83=3/v9280=1/y13=1;
!!DO(AC_Function_115)/21/36/1:P;        [call funtion for cleanse]
!!en;                                  [Run function to remember spells]


*-------------------------------sorrow ----------------------------------------*
*deals 4% less damage for every lvl difference between monsters
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Sorrow_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Sorrow_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Sorrow_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G50/?y13/?y14;                   [check for Sorrow Duration]
!!FU&y13=0:E;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y14; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Magien hat]
!!FU|y84<3/y14<>1:E;

!!BMy4:T?y4;                            [monter type? defending]
!!BMy1:T?y10;                           [monter type? attacking]
!!MA:Ly4/?y5 Ly10/?y11;                 [monster level of receiving stack and defending stack]
!!FU&y5<=y11:E;                         [continue only if defending stack is bigger than attacking stack]

!!VRy5:-y11 *5;                         [5% less damage per level difference]
!!MF:F?y6;                              [damage dealt]
!!VRy13:S100-y5;
!!VRy7:Sy6 *y13:100;                    [additional]
!!VRy8:Sy6 -y7;                         [reduced damage]
!!MF&y7>0:Fy7;                          [apply new damage]
!!SN:T^AC_Misc.Sorrow reduce^/?z-1/^damage^/y8;
!!BA:Q?f;
!!BU&f=0:Mz-1;                          [show message in log]
!!en;
!!en;

*-------------------------------disrupting ray --------------------------------*
*deals +2 damage per cast for every attacking stack against disrupting ray
!?MF1&1000/-936;                        [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Ray_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Ray_Attacking_Stack^/y4;

!!BMy4:G47/?y13/?y14;                   [check for disrupting ray]
!!FU&y13=0:E;

!!BMy1:I?y98;

!!BA:Hy98/?y99;
!!FU&y99<0:E;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Air Magic hat]
!!FU|y82<3/y12<>1:E;

!!SN:W^H3_Air Magic_1_Hero%Y99^/?y13;   [Air GM Magic Bonus handling]
!!SN:W^DisruptingRayCastsStack%Y4^/?y14;
!!BMy1:N?y6;                            [how many monsters in attacking stack?]

!!VRy3&y12=1/y13=0:Sy6 *y14 *1;         [total additional damage 1 per cast with Master]
!!VRy3&y12=1/y13=1:Sy6 *y14 *2;         [total additional damage 2 per cast with GM]
!!MF:F?y4;                              [original damage]
!!VRy5:Sy4 +y3;
!!MF:Fy5;                               [deal new updated damage]

!!BA:Q?f;
!!SN:T^AC_Misc.Ray Damage^/?z-1/^damage^/y3;
!!BU&f=0:Mz-1;
!!en;

*-------------------------------Stone Skin Special--------------------------------*
*stack gets 1 additional defence each 2 hits taken.
!?MF1&1000/-936;                        [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y1;
!!FU&y1>0:E;

!!MF:N?y4;                              [damage receiving stack]
!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!SN&y5=0:W^Stoneskin_Cast00^/?y1;
!!SN&y5=1:W^Stoneskin_Cast11^/?y1;
!!FU&y1=0:E;                            [Exit if Improves Stoneskin hasnt been cast]

!!BMy4:G46/?y13/?y14;                   [check for stoneskin]
!!FU&y13=0:E;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y14; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke ob der Held Sorcery und Magien hat]
!!FU|y84<3/y14<>1:E;

!!BA:Q?f;
!!SN:W^StoneSkinHitsStack%Y4^/d+1;
!!SN:W^StoneSkinHitsStack%Y4^/?y8;
!!VRy8:%2 *-1 +1;                       [If hits taken is even, then increase defence by 1]
!!BMy4:D?y9;
!!VRy9:+y8;
!!BMy4:Dy9;

!!VRz-1&f=0/y8=1:S^SHIELD^;
!!SN&f=0/y8=1:Pz-1;
!!BMy4&f=0/y8=1:V54;
!!en;

*-------------------------------prayer ----------------------------------------*
*deals additional holy damage against undead creatures, scales with SP of hero (max 25%)
!?MF1&1000/-936;                        [before stack takes physical damage]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Prayer_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Prayer_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Prayer_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G48/?y13/?y14;                   [check for Prayer Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Water Magic hat und Spellpower]
!!FU|y83<3/y13<>1:E;

!!SN:W^H3_Water Magic_1_Hero%Y99^/?y87; [Water Magic Bonus handling]
!!BMy4:F?y78;                           [read flags]
!!VRy78:&262144;                        [just look undead bit]
!!if&y78>0;
!!MF:F?y4;                              [original damage]
!!VRy23:Sy22 *2;                        [additional holy damage]
!!VRy23::5 +100;                        [2% more damage per 5SP]
!!VRy23&y87>0:+5;                       [+5% Bonus with GM]
!!VRy23&y23>=125:S125;                  [Limit to 25% Bonus damage]
!!VRy5:Sy4 *y23:100;
!!VRy6:Sy5-y4;
!!MF:Fy5;                               [deal new updated damage]

!!SN:T^AC_Misc.Prayer Damage^/?z-1/^damage^/y6;
!!BU:Mz-1;
!!en;
!!en;
!!en;

*-------------------------------Landmine --------------------------------------*
* if stepping on landmine creature loses 1-3 speed for rest of combat
!?MR1&1000/-936;                        [after stack takes magic damage]

!!MR:S?y4;                              [Spell Number]
!!FU&y4<>11:E;                          [Exit if not Landmine spell]

!!BG:A?y2;
!!if|y2=2/y2=6;                        [if walk or attack]
!!BG:N?y1;                              [active stack]
!!BG:Q?y3;                              [current attacking side]

!!if&y3=0;
!!SN:W^H3_Fire Magic_0_Hero%V9282^/?y11;[Fire Magic Bonus handling]
!!HEv9282&v9282>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!if&y3=1;
!!SN:W^H3_Fire Magic_0_Hero%V9281^/?y11;[Fire Magic Bonus handling]
!!HEv9281&v9281>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!BMy1:T?y10;                           [monter type? attacking]
!!MA:Ly10/?y11;                         [monster level of stack]
!!BMy1:S?y6;                            [save speed in y6]

!!VRy5&y11<=3:S1T1;                     [1-2 Monster til level 4]
!!VRy5&y11=4:S1T2;                      [1-3 Monster  level 5]
!!VRy5&y11>=5:S2T3;                     [2-5 Monster bigger level 5]

!!VRy6:-y5;
!!VRy6&y6=1:S2;                         [Cannot be less than 2 speed]
!!VRy6&y6=0:S2;
!!VRy6&y6=-1:S2;
!!VRy6&y6=-2:S2;
!!BMy1&y6>0:Sy6;                        [reduce speed by 3]

!!SN:T^AC_Misc.Landmine Damage^/?z-1/^damage^/y5;
!!BU:Mz-1;
!!en;

*-------------------------------Landmine 2-------------------------------------*
* deploys one big land mine which deals fatal damage to the stack. Damage is 1500 +10% +5% per 10SP of total Health from Stack
!?MR1&1000/-936;                        [after stack takes magic damage]

!!SN:W^landmine_var^/?y90;
!!FU&y90=0:E;

!!BG:A?y2;
!!if|y2=2/y2=6;                        [if walk or attack]

!!MR:S?y4;                              [Spell Number]
!!FU&y4<>11:E;                          [Exit if not Landmine spell]
!!BG:N?y1;                              [active stack]
!!BG:Q?y3;

!!if&y3=0;
!!SN:W^H3_Fire Magic_0_Hero%V9282^/?y11;[Fire Magic Bonus handling]
!!HEv9282&v9282>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!if&y3=1;
!!SN:W^H3_Fire Magic_0_Hero%V9281^/?y11;[Fire Magic Bonus handling]
!!HEv9281&v9281>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]
!!FU|y81<3/y11<>1:E;
!!en;

!!VRy10:S0T7;                           [1/8 chance for big landmine]

!!if&y10=0;
!!MR:F?y6;                              [damage dealt]
!!BMy1:N?y7;                            [get number of active stack]
!!BMy1:H?y8;                            [get Health Points from Stack]
!!VRy11:Sy22 :2 +10;                    [Calculate 10% +5% for 10 SP]
!!VRy9:Sy7 *y8;                         [calculate total HP from Stack]
!!VRy12:Sy9 *y11 :100 +1500 +y6;        [calculate prozentual damage from stacks HP] and add 1500+original damage]

!!VRz-1:S^ExplosionMine^;               [Play heavy explosion sound]
!!SN:Pz-1;
!!BMy1:V9;                              [show inferno animation]
!!MR:Fy12;                              [apply damage]

!!SN:T^AC_Misc.Landmine Damage 2^/?z-1;
!!BU:Mz-1;
!!VRy90:-1;
!!SN:W^landmine_var^/y90;               [Decrease big mines amount by 1 @alf]
!!en;
!!en;


*-------------------------------weakness --------------------------------------*
*creatures deal 4% less damage for every battleround after weakness was cast
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Weakness_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Weakness_Attacking_Stack^/y4;

!!SN:W^Weakness_Cast%Y2^/?y3;           [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G45/?y13/?y14;                   [check for Weakness Duration]
!!FU&y13=0:E;

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Weakness_Attacking_Stack^/y4;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y33; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und WaterMagien hat und Sp]
!!FU|y83<3/y33<>1:E;

!!VRy10:Sy22-y13;                       [calculate round after cast]
!!FU&y10=0:E;                           [exit if weakness was cast this round]

!!VRy10:S2;
!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy10 *-4 +100;                  [4% less damage per round difference]
!!VRy7:Sy6 *y10 :100;
!!VRy8:Sy6 -y7;
!!MF&y7>0:Fy7;                          [apply reduced damage]

!!SN:T^AC_Misc.Weakness Damage^/?z-1/^damage^/y8;
!!BU:Mz-1;                              [show message in log]
!!en;

*-------------------------------shield ----------------------------------------*
*first creature in stack gets a big shield which blocks physical and magic damage
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Shield_Attacking_Stack^/y4;

!!SN:W^Shield_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy4:G27/?y13/?y14;                   [check for Shield Duration]
!!SN:W^H3_Shield_0_Block_Stack_%Y4^/?y15;
!!FU|y13=0/y15<=0:E;                    [Exit if no Shield or no more Shield Blocks left]

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Shield_Attacking_Stack^/y4;

!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y11; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 F?y80/?y80/?y22/?y80 S24/?y87; [Checke ob der Held Sorcery und EarthMagien hat und Sp]
!!FU|y84<3/y11<>1:E;

*!BMy4:H?y6;                                                                    [Hit Points in defending stack]
*!BMy4:L?y7;                                                                    [Hit points lost by the next monster in the stack]
*!VRy11:Sy10 +y6 -y7;                                                           [HP of first stack in stack + shield]

!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y87; [Earth Magic Bonus handling]
!!VRy10&y87=0:Sy22 *10 +100;            [calculate shield value with Master Earth]
!!VRy10&y87=1:Sy22 *15 +150;            [calculate shield value with GM Earth]
!!BA:Q?f;

!!MF:F?y8;                              [damage dealt]

.!!if&y8>y10;                          [do if damage is bigger than shield]
!!VRy12:Sy6-y10;
!!VRy9:Sy8-y10;

!!VRz-1:S^CRUSDFND.wav^;                [find block sound]
!!SN&f=0:Pz-1;                          [play block sound]
!!MF:Fy9;

!!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y10;
!!BU:Mz-1;
.!!en;

.!!if&y8<=y10;                         [do if damage is smaller than shield]
!!VRy12:Sy6-y10;

!!VRz-1:S^CRUSDFND.wav^;                [find block sound]
!!SN&f=0:Pz-1;                          [play block sound]
!!VRy9:Sy8;
!!MF:E0;
!!MF:F0;

!!SN:T^AC_Misc.Shield block^/?z-1/^damage^/y8;
!!BU:Mz-1;
.!!en;

!!SN:W^H3_Shield_0_Block_Stack_%Y4^/d-1;
!!en;

!?MR0&1000/-936;

!!SN&v9280=0:W^Shield_Cast1^/?y1;
!!SN&v9280=1:W^Shield_Cast0^/?y1;
!!FU&y1<>1:E;

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!MR:S?y2;
!!FU&y2<=9|y2>69:E;

!!FU(AC_Function_112):P?y4;             [call fkt for magic dmg recieving stack]

!!if&y4>=0/y4<=41;
!!BMy4:G27/?y13/?y14;                   [check for shield duration]

!!SN:W^H3_Shield_1_Block_Stack_%Y4^/?y15;
!!FU|y13=0/y15<=0:E;

!!BMy4:F?y78;                           [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!FU&y78>0:E;                           [Exit if cloned or summoned]

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y11; [Earth Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und EarthMagien hat und Sp]
!!FU|y84<3/y11<>1:E;

*!BMy4:H?y6;                                                                    [Hit Points in defending stack]
*!BMy4:L?y7;                                                                    [Hit points lost by the next monster in the stack]
*!VRy11:Sy10 +y6 -y7;                                                           [HP of first stack in stack + shield]
!!BA:Q?f;

!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y87; [Earth Magic Bonus handling]
!!VRy10&y87=0:Sy22 *10 +100;            [calculate shield value with Master Earth]
!!VRy10&y87=1:Sy22 *15 +150;            [calculate shield value with GM Earth]

!!MR:F?y8;                              [damage dealt]
!!FU&y8<=0:E;

.!!if&y8>y10;                          [do if damage is bigger than shield]
!!VRy12:Sy6-y10;
!!VRy9:Sy8 -y10;

!!VRz-1&f=0:S^CRUSDFND.wav^;            [find block sound]
!!SN&f=0:Pz-1;                          [play block sound]
!!MR:Dy9;

!!SN:T^AC_Misc.Shield block 2^/?z-1/^damage^/y10;
!!BU:Mz-1;
.!!en;

.!!if&y8<=y10;                         [do if damage is smaller than shield]
!!VRy12:Sy6 -y10;

!!VRz-1&f=0:S^CRUSDFND.wav^;            [find block sound]
!!SN&f=0:Pz-1;                          [play block sound]
!!VRy9:Sy8;
!!VRy21:S0;
!!MR:Dy21;

!!SN:T^AC_Misc.Shield block 2^/?z-1/^damage^/y8;
!!BU:Mz-1;
.!!en;
!!en;

!!SN:W^H3_Shield_1_Block_Stack_%Y4^/d-1;

*-------------------------------curse -----------------------------------------*
*with Curse creature deals less damage for ever debuff applied
!?MF1&1000/-936;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Curse_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Curse_Attacking_Stack^/y4;

!!SN:W^Curse_Cast%Y2^/?y3;              [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G42/?y13/?y14;                   [check for Curse Duration]
!!FU&y13=0:E;

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Curse_Attacking_Stack^/y4;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
!!FU|y81<3/y11<>1:E;
!!BA:Q?f;

!!BMy1:G45/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G47/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G50/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G52/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G54/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G61/?y13/?y14; !!VRy11&y13>0:+1;
!!BMy1:G62/?y13/?y14; !!VRy11&y13>0:+1;

!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy11 *-5 +100;                  [5% less damage per debuff]
!!VRy7:Sy6 *y10 :100;
!!VRy8:Sy6 -y7;
!!MF:Fy7;                               [apply reduced damage]

!!SN:T^AC_Misc.Curse reduce^/?z-1/^damage^/y8;
!!BU&f=0:Mz-1;
!!en;


*-------------------------------misfortune -------------------------------------*
*creature have a chance to deal less damage. damage reduction is dependant on SP
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Misfortune_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Misfortune_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!VRy2:-1 *-1;

!!SN:W^Misfortune_Cast%Y2^/?y3;         [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G52/?y13/?y14;                   [check for Misfortune Duration]
!!FU&y13=0:E;

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
!!FU|y81<3/y11<>1:E;
!!BA:Q?f;

!!VRy20:S0T99;
!!if&y20<25;                           [chance is 25% to deal less damage]
!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y87;  [Fire Magic Bonus handling]
!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy22 :2 +20;                    [20% + 1% for 2SP less damage]
!!VRy10&y87>0:+5;                       [+ 5% for GM Fire]
!!VRy10&y10>=50/y87=0:S50;              [Cap at 50%] for Master Fire @Alf]
!!VRy10&y10>=60/y87=1:S60;              [Cap at 60% for GM Fire @Alf]

!!VRy7:Sy6 *y10 :100;
!!VRy8:Sy6 -y7;
!!MF:Fy8;                               [apply reduced damage]

!!VRz-1&f=0:S^MISFORT^;
!!SN&f=0:Pz-1;
!!BMy1&f=0:V48;

!!SN:T^AC_Misc.Misfortune Damage^/?z-1/^damage^/y10;
!!BU&f=0:Mz-1;
!!en;
!!en;

*-------------------------------fortune ---------------------------------------*
*chance to steal stats with every attack. You can steal attack, defense, damage and speed
!?MF1&1000/-936;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y7;
!!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for Warmachines]

!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Fortune_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Fortune_Attacking_Stack^/y4;

!!BMy4:T?y7;
!!FU|y7=145/y7=146/y7=147/y7=148/y7=149:E; [Exit for Warmachines]

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Fortune_Cast%Y2^/?y3;            [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G51/?y13/?y14;                   [check for Fortune Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Air Magien hat und Sp]
!!FU|y82<3/y12<>1:E;

!!SN:W^H3_Air Magic_1_Hero%Y99^/?y87;   [Air Magic Bonus handling]
!!VRy20:S0T99;
!!VRy22::2 +20;                         [Chance is 20% + 1% per 2SP]
!!VRy22&y87>0:+10;                      [+10% with GM Air]

!!if&y20<y22;                          [chance is  to steal with every attack]
!!BMy4:A?y11 D?y12 S?y13 U2/?y14 U1/?y16;

!!VRy15:S11 R3;
!!VRy11&y15=11:-5;                      [Attack]
!!VRy12&y15=12:-5;                      [Defense]
!!VRy13&y15=13:-2;                      [Speed]
!!VRy14&y15=14:-4; !!VRy16&y15=14:-4;   [Min and Max damage]

!!VRy11&y11<1:S1; !!VRy12&y12<1:S1; !!VRy13&y13<1:S1; !!VRy14&y14<1:S1; !!VRy16&y16<1:S1;

!!BMy4&y15=11:Ay11;
!!BMy4&y15=12:Dy12;
!!BMy4&y15=13:Sy13;
!!BMy4&y15=14:U2/y14;
!!BMy4&y15=14:U1/y16;

!!BMy1:A?y11 D?y12 S?y13 U2/?y14 U1/?y16;

!!VRy11&y15=11:+5;
!!VRy12&y15=12:+5;
!!VRy13&y15=13:+2;
!!VRy14&y15=14:+4; !!VRy16&y15=14:+4;

!!BMy1&y15=11:Ay11;
!!BMy1&y15=12:Dy12;
!!BMy1&y15=13:Sy13;
!!BMy1&y15=14:U2/y14;
!!BMy1&y15=14:U1/y16;

!!BA:Q?f;
!!VRz1&f=0:S^MAGCHDRN^;
!!SN&f=0:Pz1;

!!SN&y15=11:T^AC_Misc.Fortune Steal 1^/?z-1;
!!SN&y15=12:T^AC_Misc.Fortune Steal 2^/?z-1;
!!SN&y15=13:T^AC_Misc.Fortune Steal 3^/?z-1;
!!SN&y15=14:T^AC_Misc.Fortune Steal 4^/?z-1;
!!BU:Mz-1;
!!en;
!!en;
!!en;

*-------------------------------Firewall ---------------------------------------*
!?FU77012;

!!SN:X?y1/?y2/?y3/?y4/?y5/?y6/?y7/?y8/?y9; [Prevents animation]
!!SN&y9=1:W^Real_Attack_0^/0;

!?BG0;
!!SN:W^Real_Attack_0^/1;

!?BG1;
!!SN:W^Real_Attack_0^/0;

*Enemies pass more than once through your firewall they explode
!?MR1&1000/-936;

!!SN:W^Real_Attack_0^/?y1;              [Only trigger when real attack and not theoretical]
!!FU&y1=0:E;

!!BG:A?y2;
!!if|y2=2/y2=6;                        [if walk or attack]

!!MR:S?y2;                              [y2 now contains spell number]
!!FU&y2<>13:E;

!!BG:Q?y3;
!!SN&y3=0:W^H3_Fire Magic_0_Hero%V9282^/?y11; [Fire Magic Bonus handling]
!!HEv9282&y3=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]

!!SN&y3=1:W^H3_Fire Magic_0_Hero%V9281^/?y11; [Fire Magic Bonus handling]
!!HEv9281&y3=1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magic hat]

!!FU|y81<3/y11<>1:E;

!!FU(AC_Function_112):P?y4;             [call fkt for magic dmg recieving stack]
!!MR:N?y4;

!!if&y4>=0/y4<=41;

!!MR:F?y8;                              [damage dealt]
!!FU&y8<=0:E;

!!BG:A?y81;
!!if|y81=6/y81=2;

!!BG:N?y80;
!!FU&y4<>y80:E;

!!BMy4:G13/?y13/?y14;                   [Check for Firewall]
!!BA:Q?f;

!!if&y13>5/y8>10;
!!BMy4:M13/15/3;                        [Apply bigger Firewall]
!!VRy9:Sy8 *4;                          [quadruple damage]
!!BMy4&f=0:V9;
!!VRz1&f=0:S^FIREBALL^;
!!SN&f=0:Pz1;
!!en;

!!if&y13>0/y13<=5/y8>10;
!!BMy4:M13/15/3;                        [Apply Firewall]
!!VRy9:Sy8 *2;                          [double damage]
!!BMy4&f=0:V53;
!!VRz1&f=0:S^ExplosionMine^;
!!SN&f=0:Pz1;
!!en;

!!if&y13=0/y8>0;
!!BMy4:M13/5/3;                         [Apply Firewall]
!!VRy9:Sy8;
!!en;

!!MR:Fy9;
!!en;
!!en;
!!en;


*-------------------------------Bloodlust -------------------------------------*
*creature gets +3 attack for every stack slayed
!?BG0&1000/-936;

!!SN&v9280=0:W^Bloodlust_Cast0^/?y1;
!!SN&v9280=1:W^Bloodlust_Cast1^/?y1;
!!FU&y1<>1:E;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;
!!BG:A?y20;
!!FU&y20=7:E;                           [if shoot exit]

!!SN:W^Bloodlust_Var1^/?y10;
!!SN:W^Bloodlust_Var2^/?y11;

!!if&y2=y40;                           [so it only works for attacking not defending]
!!BMy1:G43/?y13/?y14;                   [check for bloodlust Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
!!FU|y81<3/y11<>1:E;

!!BG:D?y6;
!!BG:E?y7;
!!FU&y7=-1:E;
!!BU:Dy6/?y8;                           [-2 if there is alive stack at that position]
!!VRy10&y8<>-2:S0;
!!FU&y8<>-2:E;
!!VRy11:Sy1;
!!VRy10:Sy6;
!!SN:W^Bloodlust_Var1^/y10;
!!SN:W^Bloodlust_Var2^/y11;
!!en;


!?BG1&1000;

!!SN&v9280=0:W^Bloodlust_Cast0^/?y1;
!!SN&v9280=1:W^Bloodlust_Cast1^/?y1;
!!FU&y1<>1:E;

!!SN:W^Bloodlust_Var1^/?y1;
!!SN:W^Bloodlust_Var2^/?y2;
!!FU&y1=0:E;

!!BG:D?y6;
!!FU&y6<>y1:E;
!!BA:Q?f;

!!BU:Dy1/?y8;                           [-2 if there is alive stack at that position]
!!FU&y8<0:E;
!!BMy2:Ad3;
!!VRz1:S^BLOODLUS^;
!!SN&f=0:Pz1;
!!SN:W^Bloodlust_Var1^/0;               [Reset bloodlust vars]
!!SN:W^Bloodlust_Var2^/0;


*-------------------------------Force Field -----------------------------------*
*Creatures standing next to the Force Field drain magic energy from it, massively increasing their combat power

!?BG1&1000/-936;
!!SN:W^Force_Field_Cast^/?y1;
!!DO(AC_Function_100)/0/186/1&y1=1:P;   [Run Loop on Battlefield to check for Force Field and give Bonus]
!!DO(AC_Function_119)/0/41/1&y1=1:P;    [Run Loop on Battlefield to check for Force Field and take Bonus]
*!DO(AC_Function_119)/21/31/1&y1=1/v9280=1:P;                                               [Run Loop on Battlefield to check for Force Field and take Bonus]
*-------------------------------Berserk ---------------------------------------*
*When berserker wears off the attacking creature gets slowed

!?BG0&1000/-936;
!!SN:W^Bers_en^/?y1;
!!DO(AC_Function_98)/0/41/1&y1=1:P;     [Run only when Berserk was cast and y1=1]
!?BG1&1000/-936;
!!SN:W^Bers_en^/?y1;                    [Run only when Berserk was cast and y1=1]
!!DO(AC_Function_99)/0/41/1&y1=1:P;

*-------------------------------Hypnotize -------------------------------------*
*Hypnotized creatures have a chance to blind with attacks

!?MF1&1000/-936;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;

!!if&y2=y40;                           [so it only works for attacking not defending]
!!BMy1:G60/?y13/?y14;                   [check for Hypnotize Duration]
!!FU&y13=0:E;

!!MF:N?y4;                              [damage receiving stack]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!VRy5:S0;                              [Works only for attacker for now]
!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Air Magien hat und Sp]
!!FU|y82<3/y12<>1:E;
!!BA:Q?f;
!!SN:W^H3_Air Magic_1_Hero%Y99^/?y87;   [Air Magic Bonus handling]
!!VRy20:S0T99;
!!VRy22:+20;
!!VRy22&y87>0:+20;                      [+20% chance with GM Air]

.!!if&y20<=y22;                        [chance is 20(40 with GM Air)% +SP% to blind]
!!BG:E?y7;
!!FU&y7=-1:E;

!!BMy7:M62/2/3;                         [Apply Blind]


!!VRz1:S^BLIND^;
!!SN&f=0:Pz1;
!!BMy7&f=0:V6;                          [Show Blind Animation]
.!!en;
!!en;
!!en;

*-------------------------------Animate Dead ----------------------------------*
*After cast the next attack from this creature heals the creature

!?BG0&1000/-936;

!!SN:W^Animate_Dead^/?y1;
!!FU&y1=0:E;

!!VRv9449:C-1/-1/-1;
!!BG:N?y1 A?y2;
!!SN:W^Animate_Monster^/?y10;
!!FU&y1<>y10:E;
!!FU&y2<>6:E;
!!BG:E?y2;
!!BMy2:F?y3;
!!VRy4:Sy3 &16;                         [only works on living creatures]
!!FU&y4=0:E;
!!BMy2:N?y5 H?y6 L?y7;
!!VRy5:*y6 -y7;
!!VRv9449:Cy1/y2/y5;                    [y5 is der HP pool]


!?MF1&v9449>=0;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4462398:E;                    [Exit if no Melee Damage]

!!SN:W^Animate_Dead^/?y81;
!!FU&y81=0:E;                           [Exit if Animate Dead was not cast this fight]
!!MF:W?y80;
!!FU&y80>0:E;

!!BG:N?y1;                              [Attacking Stack]
!!BMy1:I?y1;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy1/?y99;
!!FU&y99<0:E;
!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y52; [Earth Magic Bonus handling]

!!MF:F?y10;                             [Damage dealt]
!!HEy99:Fd/d/?y22/d;

!!VRy22&y1>v9451/y52>0:+15;             [if you kill the entire stack you get 15% bonus to revive and you need GM Earth]
!!VRy10:*y22:100;                       [Heal only for %spell power from damage]

!!BMv9449:N?y1 H?y2 L?y3 B?y4;

!!if&y1=y4/y3=0;                       [If zero damage taken so far exit]
  !!VRv9449:C-1/-1/-1;
  !!FU:E;
!!en;

!!VRy10&y10>v9451:Sv9451;               [cannot revive more than HP is available]
!!VRy12:Sy10 %y2;                       [Rest damage HP]

!!VRy15:Sy3;
!!VRy15:Sy15-y12;
!!VRy16:Sy15;
!!VRy11:Sy10:y2;                        [Number of possible Revives]

!!if&y12>=y3;
!!VRy16:*-1;
!!VRy17:Sy2;
!!VRy17:-y16;
!!VRy16:Sy17;
!!VRy11:+1;                             [Add 1 creature for correct rest life]
!!en;

!!VRy6:Sy1+y11;                         [Total Number after attack]
!!VRy6&y6>=y4:Sy4;                      [Cannot be more than before fight]
!!VRy16&y6>=y4:S0;                      [Cannot be more than before fight]

!!BA:Q?f;
!!SN:T^AC_Misc.Animate leech^/?z1;
!!MM&f=0:Sz1;
!!VRz1:S^ANIMDEAD^;
!!SN&f=0:Pz1;
!!BMv9449:Ny6 Ly12;
!!BMv9449&f=0:V74;
*!BMv9450:F?y1;
*!VRy1:|813694976;
*!BMv9450:Fy1 E0 K1;
!!VRv9449:C-1/-1/-1;
!!SN:W^Animate_Dead^/0;

*-------------------------------Magic Arrow-------------------------------------*
* Magic Arrow becomes stronger for 10% if enemy squad is killed
!?MR1&1000/-936;                        [after stack takes magic damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!MR:S?y4;                              [Spell Number]
!!FU&y4<>15:E;                          [Exit if not Magic Arrow spell]

!!MR:F?y5;
!!FU&y5=0:E;                            [Exit if no damage]

!!BA:Hv9280/?y99;
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!SN:W^H3_Air Magic_0_Hero%Y99^/?y81;   [Water Magic Bonus handling]
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y82;  [Water Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y83; [Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y84; [Water Magic Bonus handling]

!!if|y81=1/y82=1/y83=1/y84=1;          [If any School at Master]
!!BG:E?y50;
!!if&y50>=0/y50<=41;
!!SN:W^Stack_Number^/y50;

!!SN:W^Magic_Arrow_Hero%Y99^/?y20;
!!MR:F?y10;                             [Get damage in y10]
!!VRy11:Sy20 *10 +100;                  [10% stronger with every use and squad killed]
!!VRy10:Sy10 *y11 :100;
!!MR:Fy10;                              [apply new damage]
!!en;
!!en;


*-------------------------------Mirth------------------------------------------*
* %SP bonus damage if stack had moral in this round
!?MF1&1000/-936;                        [*Physical Combat *]

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!if&y1=6|y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Mirth_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Mirth_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Mirth_Cast%Y2^/?y3;              [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G49/?y13/?y14;                   [check for Mirth Duration]
!!FU&y13=0:E;                           [Exit if no Mirth]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y33; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y83<3/y33<>1:E;                    [Exit if less than Master Water Magic]

!!SN:W^Mirth_Current_battle_round^/?y3;
!!SN:W^Mirth_Stack_had_Moral^/?y51;

!!if&y3=v997/y1=y51;
!!SN:W^H3_Water Magic_1_Hero%Y99^/?y87; [Water Magic Bonus handling]
!!VRy22::2 +100;                        [+1% damage per 2SP]
!!VRy22&y87>0:+10;                      [+10% extra damage with GM Water]
!!MF:F?y6;
!!VRy7:Sy6 *y22:100;
!!MF:Fy7;
!!VRy8:Sy7 -y6;

!!SN:T^AC_Misc.Mirth Damage^/?z-1/^damage^/y8;
!!MM:Sz-1;
!!SN:W^Mirth_Current_battle_round^/-1;
!!SN:W^Mirth_Stack_had_Moral^/-1;
!!en;
!!en;
!!en;

!?BG0&1000/-936;

!!BG:N?y1;                              [attacking stack]
!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!BG:Q?y40;

!!if&y2=y40;                           [so it only works for attacking not defending]
!!BMy1:G49/?y13/?y14;                   [check for Mirth Duration]
!!FU&y13=0:E;                           [Exit if no Mirth]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y33; [Water Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]
!!FU|y83<3/y33<>1:E;                    [Exit if less than Master Water magic]

!!BMy1:F?i;                             [read flags]
!!VRi:&16777216;                        [just look at moral bit]
!!SN&i>0:W^Mirth_Stack_had_Moral^/y1;   [Save stack number]
!!SN&i>0:W^Mirth_Current_battle_round^/v997; [Save current battle round]
!!en;

*-------------------------------Fire Shield------------------------------------*
*chance to summon fire element when hit with melee attack; chance is 10/20% + Spell Power/2%
!?MF1&1000/-936;

!!MF:W?y80;
!!FU&y80>0:E;

!!BG:A?y1;
!!FU&y1<>6:E;                           [Exit if no Melee Attack]

!!BG:N?y4;                              [Attacking Stack]
!!MF:N?y1;                              [damage receiving stack]
!!SN:W^Fire_Shield_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Fire_Shield_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Fire_Shield_Cast%Y2^/?y3;        [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G29/?y13/?y14;                   [check for Fire_Shield Duration]
!!FU&y13=0:E;                           [Exit if no Fire_Shield]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y81<3/y11<>1:E;

!!BMy1:T?y66;
!!FU&y66=114:E;

!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y87;  [Fire Magic Bonus handling]
!!VRy20:S0T99;
!!VRy23:Sy22:2 +10;                     [+10% + 1% per 2SP]
!!VRy23&y87>0:+10;                      [+10% with GM]
!!VRy23&y23>=50/y87=0:S50;              [Cap at 50%, 65% with GM @Alf]
!!VRy23&y23>=65/y87=1:S65;
!!if&y20<y23;                          [chance is dependant on Spell Power +20%]

!!BMy1:P?y1;

!!VRy6:S0;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;

!!if|y8<>-1/y9<>0;
!!VRy6:S1;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
!!VRy6:S2;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
!!VRy6:S3;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
!!VRy6:S4;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if|y8<>-1/y9<>0;
!!VRy6:S5;
!!FU(AC_Function_126):Py1/y6/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BU&y3>=0/y3<=186:Oy3/?y9;
!!en;

!!if&y8=-1/y9=0/y3>=0/y3<=186;
!!BU:S114/y22/y3/y2/-1/1;               [Summon Element]

!!BA:Q?f;
!!VRz1:S^SUMNELM^;
!!SN&f=0:Pz1;
!!en;
!!en;


*-------------------------------Slayer-------------------------------------*
*Chance for Crushing Blow! Will Reduce Att/Def or Speed if successful hit of lvl 7 and 8
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;                              [Aktion in y1]
!!if|y1=6/y1=7;
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^Slayer_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]

!!SN:W^Slayer_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Slayer_Cast%Y2^/?y3;             [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BMy1:G55/?y13/?y14;                   [check for Slayer Duration]
!!FU&y13=0:E;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87; [Checke ob der Held Sorcery und Fire Magien hat und Sp]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y81<3/y11<>1:E;

!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y87;  [Fire Magic Bonus handling]
!!VRy10:S0T99;
!!VRy11:Sy22 :2 +20;                    [Chance for Crushing Blow is SP/2 + 20%]
!!VRy11&y87>0:+10;                      [+10% chance with GM Fire]
!!if&y10<y11;

!!MF:N?y6;                              [Damage recieving stack]
!!if&y6>=0/y6<=41;
!!BMy6:T?y7;
!!MA:Ly7/?y8;
!!FU&y8<6:E;                            [Exit if no lvl 7 or higher]

!!BMy6&1000/f=0:V14;

!!VRy30:S0T6;
!!BMy6|y30=0/y30=3/y30=4/y30=6:Ad-5;    [Attack -5]
!!BMy6|y30=1/y30=3/y30=5/y30=6:Dd-5;    [Defense -5]
!!BMy6|y30=2/y30=4/y30=5/y30=6:Sd-3;    [Speed -3]

!!BMy6:A?y20; !!VRy20&y20<=1:S1; !!BMy6:Ay20;
!!BMy6:D?y21; !!VRy21&y21<=1:S1; !!BMy6:Dy21;
!!BMy6:S?y22; !!VRy22&y22<=1:S2; !!BMy6:Sy22;

!!BA:Q?f;
!!VRz-1&1000:S^DWRFDFND^;
!!SN&1000/f=0:Pz-1;
!!en;

!!en;
!!en;
!!en;

*-------------------------------Magic Mirror --------------------------------------*
!?BG0&1000/-936;                        [run forest]

!!SN&v9280=0:W^Magic_Mirror_Cast1^/?y1; [If Defender Casts Spell Check if Attacker has casted Magic Mirror in that Battle]
!!SN&v9280=1:W^Magic_Mirror_Cast0^/?y1;
!!FU&y1<>1:E;

!!BG:A?y1;
!!FU&y1<>1:E;

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!if|y2=42/y2=45/y2=50/y2=52/y2=54/y2=59/y2=61;

!!if&v9280=0;
!!SN:W^H3_Air Magic_0_Hero%V9282^/?y12; [Air Magic Bonus handling]
!!HEv9282:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d; [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!DO(AC_Function_102)/21/41/1&y82=3/y12=1:P; [No more Sorcery requirement! @Alf  [Count creatures that have magic mirror applied]
!!SN:W^Magic_Mirror_Counter^/?y10;
!!if&y10>0;
!!DO(AC_Function_103)/0/20/1:Py10/y22/y2/1;
!!SN:W^Magic_Mirror_Counter^/0;
!!en;
!!en;

!!if&v9280=1;
!!SN:W^H3_Air Magic_0_Hero%V9281^/?y12;                                         [Air Magic Bonus handling]
!!HEv9281:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d;            [Checke current hero Sorcery und Magien hat]
*!VRy85&y85><0/v7198=1:+4;
!!DO(AC_Function_102)/0/20/1&y82=3/y12=1:P;        No more Sorcery requirement! @Alf
!!SN:W^Magic_Mirror_Counter^/?y10;
!!if&y10>0;
!!DO(AC_Function_103)/21/41/1:Py10/y22/y2/2;
!!SN:W^Magic_Mirror_Counter^/0;
!!en;
!!en;
!!en;



*-------------------------------Air Shield --------------------------------------*
*Small chance to completly dodge the ranged Attack
!?MF1&1000/-936;

!!UN:C42149568/4/?y10;     Physical Damage
!!FU&y10<>4455011:E;       Shooting Damage

!!BG:A?y1;
!!FU&y1<>7:E;

!!MF:W?y80;
!!FU&y80>0:E;

!!MF:N?y4;                                                                      [damage receiving stack]

!!BMy4:G28/?y13/?y14;                                                           [check for Air Shield]
!!FU&y13=0:E;

!!BMy4:I?y5;                                                                    [Side index as for heroes (0:left, 1:right)]
!!SN:W^Air_Shield_Cast%Y5^/?y3;                                                 [Check if Spell was actually cast by Hero]
!!FU&y3<>1:E;

!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;                                           [Air Magic Bonus handling]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85 Fd/d/?y22/d S24/?y87;       [Checke ob der Held Sorcery und Air Magien hat und Sp]
!!FU|y82<3/y12<>1:E;
!!BA:Q?f;

!!SN:W^H3_Air Magic_1_Hero%Y99^/?y87;                                           [Air Magic Bonus handling]
!!VRy20:S0T99;
!!VRy22::10 +5;       [+SP/10% +5% chance to dodge]
!!VRy22&y87>0:+3;     [+3% chance with GM Air]

!!if&y20<=y22;                                                                 [chance is ]
!!VRz-1&1000:S^AIRSHELD^;
!!SN&1000/f=0:Pz-1;
!!MF:E0;                                                                        [apply reduced damage]
!!MF:F0;

!!SN:T^AC_Misc.Air Dodge^/?z-1;
!!BU&1000/f=0:Mz-1;                                                             [show message in log]
!!en;



*******************************offense spells handling**************************
!?BR&1000/v997>0/-936;
!!DO(AC_Function_68)/0/41/1:P;
!!SN:W^Incinerate^/0;                   [Reset Incinerate Damage]

!?MR1&1000/-936;

!!BG:A?y1;
!!FU&y1<>1:E;

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit in Auto Combat Status]

!!BG:Q?y1;
!!BA:Hy1/?y99;

!!FU&y99=-2:E;
!!HEy99:S24/?y57 S25/?y58;              [Checke ob der Held Intelligence und Sorcery hat]
*!VRy58&y58<>0/v7198=1:+4;
*!FU&y58=0:E;   No need for Sorcery (@Alf)

!!MR:F?y3;
!!FU&y3<=0:E;

!!BG:S?y9;                              [y9 now contains spell number]
!!FU&y9<=9|y9>69:E;

!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y57;  [Fire Magic Bonus handling]
!!VRy80&y9=21|y9=22:Sy3;                [Speichere Damage fьr Feuerschaden]
!!VRy80&y57=0/y9=21::3;
!!VRy80&y57=0/y9=22::3;                 [incinerate value 1/3 fire damage]
!!VRy80&y57=1/y9=21::2;
!!VRy80&y57=1/y9=22::2;                 [incinerate value 1/2 fire damage with GM Fire]
!!SN&y9=21|y9=22:W^Incinerate^/y80;


!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y11;  [Fire Magic Bonus handling]
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y12;   [Air Magic Bonus handling]
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y13; [Water Magic Bonus handling]
!!SN:W^H3_Earth Magic_0_Hero%Y99^/?y14; [Earth Magic Bonus handling]
!!HEy99:S14/?y51 S15/?y52 S16/?y53 S17/?y54 S18/?y55 S24/?y56 S25/?y58; [Checke ob der Held Scholar und Magien, 24 Intelligence 25 Sorcery]
*!VRy58&y58><0/v7198=1:+4;

!!MR:N?y1;

!!if&y1>=0/y1<=41;

**effect of ice spells
!!if&y9=16|y9=20;                      [Ice Bolt and Frost Ring]
!!if&y53=3/y13=1;
!!SN:W^H3_Water Magic_1_Hero%Y99^/?y56; [Earth Magic Bonus handling]
!!SN:T^AC_Misc.Ice Spells^/?z1;
!!BU&1000/f=0:Mz1;
!!BMy1:S?y10;                           [Save Current Speed in y10]
!!VRy10:-1;                             [speed decrease value =-1]
!!VRy10&y56=1:-1;                       [with GM Water value =-2]
!!VRy10&y10<=2:S2;                      [Cannot be slower than 2]
!!BMy1:Sy10;
!!en;
!!en;

**effect of earth spells
!!if&y9=18|y9=23;                      [Meteor Shower and Implosion]
!!if&y54=3/y14=1;
!!SN:W^H3_Earth Magic_1_Hero%Y99^/?y56; [Earth Magic Bonus handling]
!!SN:T^AC_Misc.Earth Spells^/?z1;
!!BU&1000/f=0:Mz1;
!!BMy1:D?y20;                           [Save Current Defence in y20]
!!VRy20:-2;                             [defence reduce value =-2]
!!VRy20&y56=1:-2;                       [with GM Earth value =-4]
!!VRy20&y20<=0:S0;
!!BMy1:Dy20;
!!en;
!!en;

**effect of fire spells
!!if&y9=21|y9=22;                      [Fireball and Inferno]
!!if&y51=3/y11=1;
!!SN:T^AC_Misc.Fire Spells^/?z1;
!!BU&1000/f=0:Mz1;
!!BMy1:M21/1/3;                         [apply incinerate to stack]
!!BMy1&y1=0:M21/2/3;                    [fix?]
!!en;
!!en;

**effect of electric spells
!!if|y9=17/y9=19/y9=57;                [Lightning Bolt and Chain Lightning or Titans Lightning Bolt]
!!if&y52=3/y12=1;
!!SN:T^AC_Misc.Lightning Spells^/?z1;
!!BU&1000/f=0:Mz1;
!!BMy1:M19/2/3;                         [apply electric shock to stack]
!!en;
!!en;

!!en;


!?FU(AC_Function_68);

!!SN&x16=0:W^IsIncinerateAnimation^/0;
!!BMx16:G21/?y12/?y13;

!!if&y12>0;
!!SN:W^IsIncinerateAnimation^/1;
!!SN:W^Incinerate^/?y1;
!!SN:W^Burned_Stack_%X16^/?y2;          [Get applied damage]
!!SN:W^Burned_Stack_%X16^/0;            [Reset afterwards]
!!VRy1:+y2;                             [Add damage from Dragon Stack]
!!SN:T^AC_Misc.Burn Damage^/?z1/^damage^/y1;
!!BU&1000/f=0:Mz1;

!!BMx16:N?y2;
!!BMx16:Ky1;                            [Strike Monster with half damage from previous fire spell]
!!BMx16:N?y3;
!!if&y3=0/y2>0;
!!BMx16:F?i;
!!VRi:|813694976;
!!BMx16:Fi K1;                          [set new modified bit]
!!en;

!!SN&1000/f=0:W^SimulAnim%X16^/1;       [Show animation]
!!en;

!!VRy1:S0;
!!SN&x16=41:W^IsIncinerateAnimation^/?y1;
!!FU(SimultaneousAnimations)&y1=1:P8/0/0/1;
!!BU&y1=1:R;



*--------------------------------------------------------------------Give Bonus---------------------------------------------------------------------------------*

!?FU(AC_Function_105);                  [Function to give Bonus in first round]

!!HEv9283:Fd/d/?y1/d S24/?y87;          [Save Spellpower aka aka Duration]
!!HEv9283:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!SN:W^Spell_Duration_Mod^/?y95;
!!SN&y95=1:W^Duration_Mod_Changed^/?y21;
!!FU(Calc_Spell_Duration)&y21=1/y95=1:Pv9283/-1/?y1;
*-------------------------------stoneskin--------------------------------------*
!!if&v9290=100;
!!BMx16:G46/?y10/?y11;                  [check for stoneskin]
!!BMx16:D?y12;                          [speichere Defense]
!!if&y1=y10;                           [if duration from stoneskin is spellpower spell was cast this round]
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Pv9283/46/1/d/?y22;
*!VRy12:+y22;                                                                   double defense in first round @alf
!!VRy12:+5;                             [double defense in first round @alf]
!!BMx16:Dy12;                           [set increased defense for creature]
!!VRv9390:S10;
!!en;
!!en;
*-------------------------------blessing---------------------------------------*
!!if&v9290=1010; Disabeld
!!BMx16:G41/?y20/?y11;                  [check for blessing]
!!BMx16:U2/?y22;                        [speichere max Damage]
.!!if&y1=y20;                          [if duration from blessing is spellpower spell was cast this round]
!!VRy22:+2;                             [+ 2 damage in first round]
!!BMx16:U2/y22;                         [set increased damage for creature]
!!VRv9391:S10;
.!!en;
!!en;
*-------------------------------bloodlust -------------------------------------*
!!if&v9290=102;
!!BMx16:G43/?y30/?y11;                  [check fьr bloodlust]
!!BMx16:A?y32;                          [speichere attack]
.!!if&y1=y30;                          [if duration from bloodlust is spellpower spell was cast this round]
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>43:Pv9283/43/1/d/?y22;
!!VRy32:+y22;                           [double attack in first round @alf]
!!BMx16:Ay32;                           [set increased attack for creature]
!!VRv9392:S10;
.!!en;
!!en;
*-------------------------------precision -------------------------------------*
!!if&v9290=1030; disabled
!!BMx16:G44/?y40/?y11;                  [check fьr precision]
*!BMx16:A?y42;                                                                  [speichere attack]
.!!if&y1=y40;                          [if duration from precision is spellpower spell was cast this round]
*!VRy42:+5;                                                                     [+ 5 attack in first round]
*!BMx16:Ay42;                                                                   [set increased attack for creature]
!!FU(AC_Function_114):Px16;
!!VRv9393:S10;
.!!en;
!!en;
*-------------------------------haste -----------------------------------------*
!!if&v9290=104;
!!BMx16:G53/?y50/?y11;                  [check fьr haste]
!!BMx16:G54/?y54/?y11;                  [check fьr slow if haste was cast]
!!BMx16:S?y52;                          [speichere speed]
!!BMx16:I?y53;                          [Side index as for heroes (0:left, 1:right)]

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

.!!if&y2=y54/v9280=y53;
*!IF:M^Haste1 F:33698^;
!!VRy52:+1;                             [fix fьr frьhes haste casten]
!!BMx16:Sy52;                           [set increased speed for creature]
!!VRv9394:S10;
.!!en;

.!!if&y1=y50;                          [if duration from haste is spellpower spell was cast this round]
*!IF:M^Haste2 F:33698^;
!!VRy52:+1;                             [+ 1 speed in first round]
!!BMx16:Sy52;                           [set increased speed for creature]
!!VRv9394:S10;
.!!en;
!!en;
*-------------------------------slow -----------------------------------------*
!!if&v9290=105;
!!BMx16:G54/?y60/?y11;                  [check fьr slow]
!!BMx16:G53/?y64/?y11;                  [check fьr haste]
!!BMx16:S?y62;                          [speichere speed]

!!if&x16<21;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

.!!if&y2=y64;
*!IF:M^1Slow F:33698^;
*!IF:M^Laufvariable %X16 Spellpower %Y2 Haste Dauer %Y64 Speed und Slow %Y60 von Creature %Y62 Y1 is%Y1 ^;
!!VRy62:-1;                             [fix fьr frьhes slow casten]
!!BMx16:Sy62;                           [set decreased speed for creature]
!!VRv9395:S10;
.!!en;

.!!if&y1=y60;                          [if duration from slow is spellpower spell was cast this round]
*!IF:M^2Slow F:33698^;
*!IF:M^Laufvariable %X16 Spellpower %Y2 Haste Dauer %Y64 Speed und Slow %Y60 von Creature %Y62 Y1 is%Y1 ^;
!!VRy62:-1;                             [- 1 speed in first round]
*!IF:M^Laufvariable %X16 Spellpower %Y2 Haste Dauer %Y64 Speed und Slow %Y60 von Creature %Y62 Y1 is%Y1 ^;
!!BMx16&y62>0:Sy62;                     [set reduced speed for creature]
!!VRv9395:S10;
.!!en;
!!en;
*-------------------------------heal ------------------------------------------*
!!if&v9290=106;
!!BMx16:H?y72;                          [speichere hit points]
!!VRy72:+10;                            [+10 hit points]
!!BMx16:Hy72;
!!VRv9396:S10;                          [set increased HP]
!!en;
*-------------------------------shield ----------------------------------------*
!!if&v9290=107;
!!BMx16:G27/?y80/?y11;                  [check for shield]
.!!if&y1=y80;
!!FU(AC_Function_114):Px16;
!!VRv9397:S10;
.!!en;
!!en;
*-------------------------------air shield ------------------------------------*
!!if&v9290=108;
!!BMx16:G28/?y90/?y11;                  [check for air shield]
.!!if&y1=y90;
!!FU(AC_Function_114):Px16;
!!VRv9398:S10;
.!!en;
!!en;
*-------------------------------magic mirror-----------------------------------*
!!if&v9290=109;
!!BMx16:G36/?y93/?y11;                  [check for magic mirror]
.!!if&y1=y93;
*!FU(AC_Function_114):Px16;   Disabled and Replaced
!!VRv9399:S10;
.!!en;
!!en;
*-------------------------------counterspell-----------------------------------*
!!if&v9290=11000; Disabled
!!BMx16:G34/?y94/?y11;                  [check for counterspell]
.!!if&y1=y94;
!!FU(AC_Function_114):Px16;
!!VRv9400:S10;
.!!en;
!!en;
*--------------------------------mirth-----------------------------------------*
!!if&v9290=111;
*!BMx16:G49/?y95/?y11;                                                          [check for mirth]
.!!if&y1=y95;
*!FU(AC_Function_114):Px16;
*!VRv9401:S10;
.!!en;
!!en;
*--------------------------------luck------------------------------------------*
!!if&v9290=112;
!!BMx16:G51/?y96/?y11;                  [check for luck]
.!!if&y1=y96;
!!FU(AC_Function_114):Px16;
!!VRv9402:S10;
.!!en;
!!en;
*--------------------------------counterstrike---------------------------------*
!!if&v9290=1130; Disabled
!!BMx16:G58/?y97/?y11;                  [check for counterstrike]
.!!if&y1=y97;
!!FU(AC_Function_114):Px16;
!!VRv9403:S10;
.!!en;
!!en;
*--------------------------------slayer----------------------------------------*
!!if&v9290=114;
!!BMx16:G55/?y98/?y11;                  [check for slayer]
.!!if&y1=y98;
!!FU(AC_Function_114):Px16;
!!VRv9404:S10;
.!!en;
!!en;
*--------------------------------fire shield-----------------------------------*
!!if&v9290=115;
*!BMx16:G29/?y99/?y11;                                                          [check for fire shield]
.!!if&y1=y99;
*!FU(AC_Function_114):Px16;
*!VRv9405:S10;
.!!en;
!!en;
*--------------------------------frenzy----------------------------------------*
!!if&v9290=1160; Disabled
!!BMx16:G56/?y81/?y11;                  [check for frenzy]
.!!if|y81=1/y81=2;
!!FU(AC_Function_114):Px16;
!!VRv9406:S10;
.!!en;
!!en;
*--------------------------------prot fire-------------------------------------*
!!if&v9290=117;
!!BMx16:G31/?y82/?y11;                  [check for prot. fire]
.!!if&y1=y82;
!!FU(AC_Function_114):Px16;
!!VRv9407:S10;
.!!en;
!!en;
*--------------------------------prot water-------------------------------------*
!!if&v9290=118;
!!BMx16:G32/?y83/?y11;                  [check for prot. water]
.!!if&y1=y83;
!!FU(AC_Function_114):Px16;
!!VRv9408:S10;
.!!en;
!!en;
*--------------------------------prot earth-------------------------------------*
!!if&v9290=119;
!!BMx16:G33/?y84/?y11;                  [check for prot. earth]
.!!if&y1=y84;
!!FU(AC_Function_114):Px16;
!!VRv9409:S10;
.!!en;
!!en;
*--------------------------------prot air-------------------------------------*
!!if&v9290=120;
!!BMx16:G30/?y85/?y11;                  [check for prot. air]
.!!if&y1=y85;
!!FU(AC_Function_114):Px16;
!!VRv9410:S10;
.!!en;
!!en;
*--------------------------------clone spell ----------------------------------*
!!if&v9290=125;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&8388608;                       [just look clone bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!SN:W^H3_Water Magic_1_Hero%V9283^/?y87;[Water Magic Bonus handling]
!!VRy59&y78>0/y59>0/y87=0:*125 +99 :100;[grow 25%], rounded up @Alf]
!!VRy59&y78>0/y59>0/y87=1:*135 +99 :100;[grow 35%   with GM], rounded up @Alf]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!en;
*--------------------------------luck------------------------------------------*
!!if&v9290=126;
!!BMx16:G51/?y96/?y11;                                                          [check for luck 2]
.!!if&y1=y96;
*!FU(AC_Function_114):Px16;
!!VRv9412:S10;
.!!en;
!!en;
*-------------------------------shield 2 --------------------------------------*
!!if&v9290=135;
!!BMx16:H?y73;                                                                  [speichere hit points]
!!VRy18:Sy1 *10 +100;                                                           [calculate shield value]
!!VRy73:+y18;
*!BMx16:Hy73;                                                                   [set shield]
!!VRv9413:S10;
!!en;
*--------------------------------death ripple ---------------------------------*
!!if&v9290=139;
!!BMx16:F?y78;                                                                  [read flags]
!!VRy78:&16;                                                                    [just look alive bit]
!!if&y78>0;
!!BMx16:M50/1/0;                                                                [Apply Basic Sorrow for 1 round]  ** Does NOT Work!
!!en;
!!en;
*--------------------------------destroy undead -------------------------------*
!!if&v9290=140;
!!BMx16:F?y78;                                                                  [read flags]
!!VRy78:&16;                                                                    [just look alive bit]
!!if&y78>0;
!!BMx16:M49/1/0;                                                                [Apply Basic SMirth for 1 round]
!!en;
!!en;
*-------------------------------sacrifice -------------------------------------*
!!if&v9290=143;
!!BMx16:F?y78;                                                                  [read flags]
!!VRy78:&268435456;                                                             [just look alive bit]
!!if&y78>0;
!!BMx16:B?y79;
!!BMx16:T?y80;
!!BMx16:P?y81;
!!BU:Sy80/1/y81/0/-1/1;                                                         [Summon martyr]

!!BU:Ey81/?y82;

!!BMy82:H?y83;
!!BMy82:U2/?y85;
!!VRy86:Sy85*y79;                                                               [calculate damage]
!!VRy84:Sy83*y79 :3;                                                            [calculate HP/3]
!!BMy82:Hy84;
!!BMy82:U2/y86;
!!BMy82:M40/10/3;
*!BMy82:M47/3/3;                                                                Disrupting Ray
!!BMy82:M53/3/3;
!!SN:W^sacrifice_var^/1;                                                        [Improved version can only be cast once per combat]
!!en;
!!en;

*--------------------------------------------------------------------Take Bonus---------------------------------------------------------------------------------*

!?FU(AC_Function_106);                  [Fix function for wrong duration from first creature and take away bonus after one round]

*!IF:M^Begin der neuen Runde^;
!!if&x16<21;
!!HEv9281:Fd/d/?y1/d S24/?y86;          [Save Spellpower aka aka Duration for attacker and Intelligence]
!!VRy49:Sy1:2;                          [Set to half SP for summon growth]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9281;
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y1/d S24/?y86;          [Save Spellpower aka aka Duration for defender and Intelligence]
!!VRy49:Sy1:2;                          [Set to half SP for summon growth]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9282;
!!en;
!!SN:W^Spell_Duration_Mod^/?y95;
!!FU(Calc_Spell_Duration)&y95=1:Py23/-1/?y1;

*-------------------------------stoneskin--------------------------------------*
!!if&v9390=10;
!!BMx16:G46/?y10/?y11;                  [check fьr stoneskin]
!!BMx16:D?y12;                          [speichere Defense]

.!!if&x16>0;                           []
!!VRy10:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy13:Sy1-1;                          [duration -1 says second round]
!!SN:W^DisRayStoneSkinRemoved%X16^/?y24;[check if stoneskin bonus was removes by disrupting ray already @alf]
.!!if&y13=y10/y24=0;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/46/1/d/?y22;
*!VRy12:-y22;                                                                   [reduce defense]
!!VRy12:-5;                             [reduce defense]
!!BMx16:Dy12;                           [apply original defense]
.!!en;
!!VRv9390&x16=41:S0;
!!en;

*-------------------------------blessing---------------------------------------*
!!if&v9391=1000;                       [Disabled]
!!BMx16:G41/?y20/?y11;                  [check fьr blessing]
!!BMx16:U2/?y22;                        [speichere max Damage]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy20:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy14:Sy1-1;                          [duration -1 says second round]
.!!if&y14=y20;
!!VRy22:-2;                             [reduce max damage]
!!BMx16:U2/y22;                         [apply original damage]
.!!en;
!!VRv9391&x16=41:S0;
!!en;

*-------------------------------bloodlust -------------------------------------*
!!if&v9392=10;
!!BMx16:G43/?y30/?y11;                  [check fьr bloodlust]
!!BMx16:A?y32;                          [speichere attack]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy30:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy15:Sy1-1;                          [duration -1 says second round]
.!!if&y15=y30;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>43:Py23/43/1/d/?y22;
!!VRy32:-y22;                           [increase max attack]
!!BMx16:Ay32;                           [apply original attack]
.!!en;
!!VRv9392&x16=41:S0;
!!en;

*-------------------------------precision -------------------------------------*
!!if&v9393=1000;                       [disabled]
!!BMx16:G44/?y40/?y11;                  [check fьr precision]
*!BMx16:A?y42;                                                                  [speichere attack]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy40:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

*!VRy16:Sy1-1;                                                                  [duration -1 says second round]
.!!if&y16=y40;
*!VRy42:-5;                                                                     [increase max attack]
*!BMx16:Ay42;                                                                   [apply original attack]
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9393&x16=41:S0;
!!en;

*-------------------------------haste -----------------------------------------*
!!if&v9394=10;
!!BMx16:G53/?y50/?y11;                  [check fьr haste]
!!BMx16:S?y52;                          [speichere speed]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy50:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;

!!VRy17:Sy1-1;                          [duration -1 says second round]
.!!if&y17=y50;
*!IF:M^Haste F:33699^;
!!VRy52:-1;                             [increase max speed]
!!BMx16:Sy52;                           [apply original speed]
.!!en;
!!VRv9394&x16=41:S0;
!!en;

*-------------------------------slow -----------------------------------------*
!!if&v9395=10;

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!BMx16:G54/?y60/?y11;                  [check fьr slow]
!!BMx16:S?y62;                          [speichere speed]

!!VRy60&x16=0/y11>0:+1;                 [fix for first creature]
!!VRy18:Sy2;                            [duration -1 says second round]
.!!if&y18=y60;
*!IF:M^%X16 Hallo Slow F:33699. Duration %Y60 ^;
!!VRy62:+1;                             [increase max speed]
!!BMx16:Sy62;                           [apply original speed]
.!!en;
!!VRv9395&x16=41:S0;
!!en;

*-------------------------------heal ------------------------------------------*
!!if&v9396=10;
!!SN:W^Heal_Var1^/?y99;
!!SN:W^Heal_Var2^/?y98;
!!VRx16&y98=11/y99<>11/x16=0:S21;
!!VRx16&y99=11/y98<>11/x16=21:S41;

!!BMx16:H?y72;                          [speichere HP]
!!VRy72:-10;                            [decrease HP]
!!BMx16&y72>0:Hy72;                     [apply original HP for ally creatures]

!!VRv9396&x16=41:S0;
!!en;

*-------------------------------shield -----------------------------------------*
!!if&v9397=10;
!!BMx16:G27/?y80/?y11;                  [check fьr shield]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy80:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy19:Sy1-1;                          [duration -1 says second round]
.!!if&y19=y80;
!!FU(AC_Function_120):Px16;             [**]
.!!en;
!!VRv9397&x16=41:S0;
!!en;

*-------------------------------air shield ------------------------------------*
!!if&v9398=10;
!!BMx16:G28/?y90/?y11;                  [check fьr air shield]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy90:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy20:Sy1-1;                          [duration -1 says second round]
.!!if&y20=y90;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9398&x16=41:S0;
!!en;

*-------------------------------magic mirror ----------------------------------*
!!if&v9399=10;
!!BMx16:G36/?y93/?y11;                  [check fьr magic mirror]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy93:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy21:Sy1-1;                          [duration -1 says second round]
.!!if&y21=y93;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9399&x16=41:S0;
!!en;

*-------------------------------counterspell ----------------------------------*
!!if&v9400=1000; Disabled
!!BMx16:G34/?y94/?y11;                  [check fьr counterspell]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy94:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy22:Sy1-1;                          [duration -1 says second round]
.!!if&y22=y94;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9400&x16=41:S0;
!!en;

*--------------------------------mirth ----------------------------------------*
!!if&v9401=10;
!!BMx16:G49/?y95/?y11;                  [check fьr mirth]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy95:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy23:Sy1-1;                          [duration -1 says second round]
.!!if&y23=y95;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9401&x16=41:S0;
!!en;

*--------------------------------luck -----------------------------------------*
!!if&v9402=10;
!!BMx16:G51/?y96/?y11;                  [check fьr luck]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy96:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy24:Sy1-1;                          [duration -1 says second round]
.!!if&y24=y96;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9402&x16=41:S0;
!!en;

*--------------------------------counterstrike---------------------------------*
!!if&v9403=1000; Disabled
!!BMx16:G58/?y97/?y11;                  [check fьr counterstrike]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy97:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy25:Sy1-1;                          [duration -1 says second round]
.!!if&y25=y97;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9403&x16=41:S0;
!!en;

*--------------------------------slayer----------------------------------------*
!!if&v9404=10;
!!BMx16:G55/?y98/?y11;                  [check fьr slayer]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy98:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy26:Sy1-1;                          [duration -1 says second round]
.!!if&y26=y98;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9404&x16=41:S0;
!!en;

*--------------------------------fire shield-----------------------------------*
!!if&v9405=10;
!!BMx16:G29/?y99/?y11;                  [check fьr fire shield]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy99:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy27:Sy1-1;                          [duration -1 says second round]
.!!if&y27=y99;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9405&x16=41:S0;
!!en;

*--------------------------------frenzy----------------------------------------*
!!if&v9406=1000; Disabled
!!BMx16:G56/?y81/?y11;                  [check fьr frenzy]
.!!if|y81=1/y81=2;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9406&x16=41:S0;
!!en;
*--------------------------------prot fire-------------------------------------*
!!if&v9407=10;
!!BMx16:G31/?y82/?y11;                  [check fьr prot fire]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy82:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy28:Sy1-1;
.!!if&y82=y28;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9407&x16=41:S0;
!!en;
*--------------------------------prot water-------------------------------------*
!!if&v9408=10;
!!BMx16:G32/?y83/?y11;                  [check fьr prot water]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy83:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy29:Sy1-1;
.!!if&y83=y29;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9408&x16=41:S0;
!!en;
*--------------------------------prot earth-------------------------------------*
!!if&v9409=10;
!!BMx16:G33/?y84/?y11;                  [check fьr prot earth]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy84:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy30:Sy1-1;
.!!if&y84=y30;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9409&x16=41:S0;
!!en;
*--------------------------------prot air-------------------------------------*
!!if&v9410=10;
!!BMx16:G30/?y85/?y11;                  [check fьr prot air]

.!!if&x16>0;                           [creature bigger than 0]
!!VRy85:-1;                             [reduce duration from creature 1 bis 20 um 1]
.!!en;
!!VRy31:Sy1-1;
.!!if&y85=y31;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9410&x16=41:S0;
!!en;
*--------------------------------Summon Fire Elementals------------------------*
!!if&v9276=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]                      ***Add check for Skills***]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Fire_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Fire Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S114;                     [Set Fire]
!!VRy80&y86=1:S129;                     [Set Energy]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look undead bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Fire]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Fire_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Fire Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S114;                     [Set Fire]
!!VRy80&y86=1:S129;                     [Set Energy]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Fire]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;
*--------------------------------Summon Earth Elementals-----------------------*
!!if&v9277=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Earth_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Earth Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S113;                     [Set Earth  Fix for Grandmaster Magma Elemental Summon]
!!VRy80&y86=1:S125;                     [Set Magma]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Earth]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Earth_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Earth Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S113;                     [Set Earth]
!!VRy80&y86=1:S125;                     [Set Magma]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Earth]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;
*--------------------------------Summon Water Elementals-----------------------*
!!if&v9278=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Water_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Water Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S115;                     [Set Water]
!!VRy80&y86=1:S123;                     [Set Ice]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Water]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Water_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Water Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S115;                     [Set Water]
!!VRy80&y86=1:S123;                     [Set Ice]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Water]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;
*--------------------------------Summon Air Elementals-------------------------*
!!if&v9279=1;
!!BMx16:I?y76;                          [Side index as for heroes (0:left, 1:right)]

!!if&y76=0/v9287=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Air_1^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Air Magic_1_Hero%V9281^/?y86;
!!VRy80&y86=0:S112;                     [Set Air]
!!VRy80&y86=1:S127;                     [Set Storm]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Air]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;


!!if&y76=1/v9288=10;
!!BMx16:T?y77;                          [creature number]
!!SN:W^H3_Summon_Air_0^/?y10;
!!VRy11:Sy10+1;
!!SN:W^H3_Air Magic_1_Hero%V9282^/?y86;
!!VRy80&y86=0:S112;                     [Set Air]
!!VRy80&y86=1:S127;                     [Set Storm]
!!if&y77=y80/v997<=y11;
!!BMx16:F?y78;                          [read flags]
!!VRy78:&4194304;                       [just look summoned bit]
!!BMx16&y78>0:N?y59;                    [current number]
!!VRy3:Sy49 +110;
!!VRy3&y86>0:+10;                       [+10% If GM Air]
!!VRy59&y78>0/y59>0:*y3:100;            [grow 10% + SP%]
!!BMx16&y78>0/y59>0:Ny59;               [Set current number]
!!BMx16&y78>0/y59>0:By59;               [Set number at beginning of Battle]
!!en;
!!en;
!!en;



*--------------------------------------------------------------------Take Bonus Extra Conditions Dispel/Disrupting Ray------------------------------------------------------------------------*

!?FU(AC_Function_108);                  [Fix function for early Cure or Dispel]

!!if&x16<21;
!!HEv9281:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9281;
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9282;
!!en;
!!SN:W^Spell_Duration_Mod^/?y95;
!!FU(Calc_Spell_Duration)&y95=1:Py23/-1/?y1;

*-------------------------------stoneskin--------------------------------------*
!!if&v9390=10;
!!BMx16:G46/?y10/?y11;                  [check fьr stoneskin]
!!BMx16:D?y12;                          [speichere Defense]

!!VRy13:Sy1;                            [duration -1 says second round]
.!!if&y13=y10;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/46/1/d/?y22;
*!VRy12:-y22;                                                                   [reduce defense]
!!VRy12:-5;                             [reduce defense]
!!BMx16:Dy12;                           [apply original defense]
.!!en;
!!VRv9390&x16=41:S0;
!!en;

*-------------------------------blessing---------------------------------------*
!!if&v9391=1000; Disabled
!!BMx16:G41/?y20/?y11;                  [check fьr blessing]
!!BMx16:U2/?y22;                        [speichere max Damage]

!!VRy14:Sy1;                            [duration -1 says second round]
.!!if&y14=y20;
!!VRy22:-2;                             [reduce max damage]
!!BMx16:U2/y22;                         [apply original damage]
.!!en;
!!VRv9391&x16=41:S0;
!!en;

*-------------------------------bloodlust -------------------------------------*
!!if&v9392=10;
!!BMx16:G43/?y30/?y11;                  [check fьr bloodlust]
!!BMx16:A?y32;                          [speichere attack]

!!VRy15:Sy1;                            [duration -1 says second round]
.!!if&y15=y30;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS43&y21=43:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/43/1/d/?y22;
!!VRy32:-y22;                           [increase max attack]
!!BMx16:Ay32;                           [apply original attack]
.!!en;
!!VRv9392&x16=41:S0;
!!en;

*-------------------------------precision -------------------------------------*
!!if&v9393=1000; disabled
!!BMx16:G44/?y40/?y11;                  [check fьr precision]
*!BMx16:A?y42;                                                                  [speichere attack]

!!VRy16:Sy1;                            [duration -1 says second round]
.!!if&y16=y40;
*!VRy42:-5;                                                                     [increase max attack]
*!BMx16:Ay42;                                                                   [apply original attack]
!!FU(AC_Function_114):Px16;
.!!en;
!!VRv9393&x16=41:S0;
!!en;

*-------------------------------haste -----------------------------------------*
!!if&v9394=10;
!!BMx16:G53/?y50/?y11;                  [check fьr haste]
!!BMx16:S?y52;                          [speichere speed]

!!VRy17:Sy1;                            [duration -1 says second round]
.!!if&y17=y50;
*!IF:M^Haste F:33671^;
!!VRy52:-1;                             [increase max speed]
!!BMx16:Sy52;                           [apply original speed]
.!!en;
!!VRv9394&x16=41:S0;
!!en;

*-------------------------------slow -----------------------------------------*
!!if&v9395=10;

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!BMx16:G54/?y60/?y11;                  [check fьr slow]
!!BMx16:S?y62;                          [speichere speed]
!!VRy60&x16=0:+1;                       [fix for first creature only necaserie when new round]

!!VRy18:Sy2;                            [duration -1 says second round]
.!!if&y18=y60;
!!VRy62:+1;                             [increase max speed]
!!BMx16:Sy62;                           [apply original speed]
.!!en;
!!VRv9395&x16=41:S0;
!!en;
*-------------------------------heal ------------------------------------------*

Cant Cleanse That Effect

*-------------------------------shield -----------------------------------------*
!!if&v9397=10;
!!BMx16:G27/?y80/?y11;                  [check fьr shield]

!!VRy19:Sy1;
.!!if&y19=y80;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9397&x16=41:S0;
!!en;

*-------------------------------air shield ------------------------------------*
!!if&v9398=10;
!!BMx16:G28/?y90/?y11;                  [check fьr air shield]

!!VRy20:Sy1;
.!!if&y20=y90;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9398&x16=41:S0;
!!en;

*-------------------------------magic mirror ----------------------------------*
!!if&v9399=10;
!!BMx16:G36/?y93/?y11;                  [check fьr magic mirror]

!!VRy21:Sy1;
.!!if&y21=y93;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9399&x16=41:S0;
!!en;

*-------------------------------counterspell ----------------------------------*
!!if&v9400=1000; Disabled
!!BMx16:G34/?y94/?y11;                  [check fьr counterspell]

!!VRy22:Sy1;
.!!if&y22=y94;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9400&x16=41:S0;
!!en;

*-------------------------------mirth -----------------------------------------*
!!if&v9401=10;
!!BMx16:G49/?y95/?y11;                  [check fьr mirth]

!!VRy23:Sy1;
.!!if&y23=y95;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9401&x16=41:S0;
!!en;

*-------------------------------luck ------------------------------------------*
!!if&v9402=10;
!!BMx16:G51/?y96/?y11;                  [check fьr luck]

!!VRy24:Sy1;
.!!if&y24=y96;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9402&x16=41:S0;
!!en;

*-------------------------------counterstrike ---------------------------------*
!!if&v9403=1000; Disabled
!!BMx16:G58/?y97/?y11;                  [check fьr counterstrike]

!!VRy25:Sy1;
.!!if&y25=y97;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9403&x16=41:S0;
!!en;

*-------------------------------slayer ----------------------------------------*
!!if&v9404=10;
!!BMx16:G55/?y98/?y11;                  [check fьr slayer]

!!VRy26:Sy1;
.!!if&y26=y98;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9404&x16=41:S0;
!!en;

*-------------------------------fire shield -----------------------------------*
!!if&v9405=10;
!!BMx16:G29/?y99/?y11;                  [check fьr fire shield]

!!VRy27:Sy1;
.!!if&y27=y99;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9405&x16=41:S0;
!!en;

*-------------------------------frenzy ----------------------------------------*
!!if&v9406=1000; Disabled
!!BMx16:G29/?y82/?y11;                  [check fьr frenzy]

.!!if&y82=1;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9406&x16=41:S0;
!!en;

*-------------------------------prot fire -------------------------------------*
!!if&v9407=10;
!!BMx16:G29/?y82/?y11;                  [check fьr prot fire]

!!VRy28:Sy1;
.!!if&y28=y82;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9407&x16=41:S0;
!!en;

*-------------------------------prot water ------------------------------------*
!!if&v9408=10;
!!BMx16:G29/?y83/?y11;                  [check fьr prot water]

!!VRy29:Sy1;
.!!if&y29=y83;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9408&x16=41:S0;
!!en;

*-------------------------------prot earth ------------------------------------*
!!if&v9409=10;
!!BMx16:G29/?y84/?y11;                  [check fьr prot earth]

!!VRy30:Sy1;
.!!if&y30=y84;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9409&x16=41:S0;
!!en;

*-------------------------------prot air --------------------------------------*
!!if&v9410=10;
!!BMx16:G29/?y85/?y11;                  [check fьr prot air]

!!VRy31:Sy1;
.!!if&y31=y85;
!!FU(AC_Function_120):Px16;
.!!en;
!!VRv9410&x16=41:S0;
!!en;
*-------------------------------shield -----------------------------------------*
!!SN:W^shield_var1^/?y50;
!!SN:W^shield_var2^/?y60;
!!if&y50=10|y60=10;
*!SN:W^H3_Earth Magic_1_Hero%V9283^/?y87;                                       [Earth Magic Bonus handling]
!!BMx16:G27/?y87/?y11;                  [check fьr shield]

!!VRy3:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy3:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA thx Sal]
!!EAy3:L?y77;
!!FU&y77=0:E;
!!VRy15:Sy77 %2;

.!!if&y87>0/y15=0;
!!BMx16:H?y73;                          [speichere hit points]
!!VRy18:Sy1 *10 +100;                   [calculate shield value]
!!VRy73:-y18;
*!BMx16:Hy73;
!!VRy77:-1;                             [set shield]
!!EAy3:Ly77;                            [now shield bonus can not be applied again this fight]
.!!en;
!!en;

!!BA:Q?f;
!!BU&f=0:R;                             [Redraw battlefield]


*--------------------------------------------------------------------Take Bonus Extra Conditions Disrupting Ray------------------------------------------------------------------------*

!?FU(TakeStoneSkinBonusDisRay);         [Fix function for early Disrupting Ray]

!!if&x1<21;
!!HEv9281:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9281;
!!en;

!!if&x1>20;
!!HEv9282:Fd/d/?y1/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                       [139 Ring of the Magi]
!!VRy23:Sv9282;
!!en;
!!SN:W^Spell_Duration_Mod^/?y95;
!!FU(Calc_Spell_Duration)&y95=1:Py23/-1/?y1;

!!if&v9390=10;
!!BMx1:G46/?y10/?y11;                   [check fьr stoneskin]
!!BMx1:D?y12;                           [speichere Defense]

!!VRy13:Sy1;                            [duration -1 says second round]
.!!if&y13=y10;
!!SN:W^Scaling_Magic_Spell_Number_^/?y21;
!!SS46&y21=46:E3/?y22;
!!FU(ApplyRemoveSpellScaling)&y21<>46:Py23/46/1/d/?y22;
*!VRy12:-y22;                                                                   [reduce defense]
!!VRy12:-5;                             [reduce defense]
!!VRy12&y12<0:S0;
!!BMx1:Dy12;                            [apply original defense]
!!VRy14:Sv9280 *-1 +1;                  [Side of the target is 1 minus current side]
!!SN:W^Stoneskin_Cast%Y14^/?y14;
!!SN&y13>0/y14=1:W^DisRayStoneSkinRemoved%X1^/1;
.!!en;
!!VRv9390&x1=41:S0;
!!en;

*--------------------------------------------------------------------Give Bonus Extra Abilities--------------------------------------------------------------------------*

!?FU(AC_Function_114);                  [Function for giving extra abilities]

!!BMx16:T?y1;
!!VRy2:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy2:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA thx Sal]

!!if&v9290=107/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Shield Block]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9290=108/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Air Shield Block]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9290=108/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Air Shield Block]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9290=109/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Magic Mirror Cast]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/106/16/50/50/50/50/50/50/50/50/50/50/50; [Battle Monster]
!!en;

!!if&v9290=110/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterspell cast Dispel]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/99/78/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9290=111/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Mirth Fly]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/70/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=112/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Luck Champion Distance Bonus]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/102/99/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=113/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterstrike No Retaliation]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/102/82/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=114/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Slayer Death Blow]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/101/61/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9290=115/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Fire Shield Summon Clone]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/108/114/25/25/25/25/25/25/25/25/25/25/25; [Battle Monster]
!!en;

!!if&v9290=116/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Frenzy Strike and Return]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/102/98/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9290=117/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=118/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=119/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=120/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
!!EAy2&y3>=0:By3/1/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9290=103/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Precision Shoot when Adjacent]
*!EAy2:F0/?y3;                          [Check for next available bonus line: y3]
*!EAy2&y3>=0:By3/1/102/115/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

*--------------------------------------------------------------------Take Bonus Extra Abilities----------------------------------------------------------------------------*

!?FU(AC_Function_120);                  [Function for taking extra abilities]

!!BMx16:T?y1;
!!VRy2:Sx16;                            [use stack ID (read below*), I set y2 to current stack number]
!!VRy2:+1*-1;                           [now I add +1 then change to negative  value, we have now number of stack for EA  thx Sal]

!!if&v9397=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Shield]
!!EAy2:F76/?y3;                         [Check for Deflect/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9398=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Air Shield]
!!EAy2:F76/?y3;                         [Check for Deflect/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/76/29/30/30/30/30/30/30/30/30/30/30/30; [Battle Monster]
!!en;

!!if&v9399=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Magic Mirror Ice Lightning]
!!EAy2:F106/?y3;                        [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/106/16/50/50/50/50/50/50/50/50/50/50/50; [Battle Monster]
!!en;

!!if&v9400=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterspell cast Dispel]
*!EAy2:F99/78/?y3;                      [Check for Cast/next available bonus line: y3]
*!EAy2&y3>=0:By3/0/99/78/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9401=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Mirth Fly]
!!EAy2:F102/70/?y3;                     [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/102/70/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9402=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Luck Champion Distance Bonus]
!!EAy2:F102/99/?y3;                     [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/102/99/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9403=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Counterstrike No Retaliation]
*!EAy2:F102/82/?y3;                     [Check for Cast/next available bonus line: y3]
*!EAy2&y3>=0:By3/0/102/82/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9404=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Slayer Death Blow]
!!EAy2:F101/?y3;                        [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/101/61/100/100/100/100/100/100/100/100/100/100/100; [Battle Monster]
!!en;

!!if&v9405=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Fire Shield Summon Clone]
!!EAy2:F108/114/?y3;                    [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/108/114/25/25/25/25/25/25/25/25/25/25/25; [Battle Monster]
!!en;

!!if&v9406=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Frenzy Death Stare]
!!EAy2:F102/98/?y3;                     [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/102/98/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;

!!if&v9407=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9408=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9409=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9410=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Protection Elements]
!!EAy2:F75/15/?y3;                      [Check for Cast/next available bonus line: y3]
!!EAy2&y3>=0:By3/0/75/15/75/75/75/75/75/75/75/75/75/75/75; [Battle Monster]
!!en;

!!if&v9393=10/y1<>145/y1<>146/y1<>147/y1<>148/y1<>149; [Precision Shoot when Adjacent]
*!EAy2:F102/115/?y3;                    [Check for Cast/next available bonus line: y3]
*!EAy2&y3>=0:By3/0/102/115/1/1/1/1/1/1/1/1/1/1/1; [Battle Monster]
!!en;
*--------------------------------------------------------------------Extra Function fьr Slow and Heal----------------------------------------------------------------------*

!?FU(AC_Function_121);

!!if&x16<21;
!!HEv9282:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9281:Fd/d/?y2/d;                   [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14; [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                        [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                        [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                        [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                       [139 Ring of the Magi]
!!en;

!!if&v9395=10;
!!BMx16:G54/?y60/?y11;                  [check fьr slow]
!!BMx16:S?y62;                          [speichere speed]
.!!if&y2=y60;
!!VRy62:+1;                             [increase max speed]
!!BMx16:Sy62;                           [apply original speed]
.!!en;
!!VRv9395&x16=41:S0;
!!en;


*--------------------------------------------------------------------Extra Function fьr Bless/Curse -----------------------------------------------------------------------------*
!?FU(AC_Function_122);

!!if&x16<21;
!!HEv9281:Fd/d/?y2/d;                                                           [Save Spellpower aka aka Duration for defender]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y2/d;                                                           [Save Spellpower aka aka Duration for attacker]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy2&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy2&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy2&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy2&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;

!!if&v9391=10;
!!BMx16:G41/?y20/?y11;                                                          [check fьr bless]
!!BMx16:U2/?y22;                                                                [speichere max damage]
.!!if&y2=y20;
!!VRy22:-2;                                                                     [reduce max damage]
!!BMx16:U2/y22;                                                                 [apply original damage]
.!!en;
!!VRv9391&x16=41:S0;
!!en;


*--------------------------------------------------------------------Extra Trigger for Forgetfulness -----------------------------------------------------------------------------*
!?FU(AC_Function_113);

!!BMx16:G61/?y13/?y14;                                                          [check for Forgetfulness]
!!FU&y13=0:E;

!!BA:Hv9280/?y99;
!!SN:W^H3_Water Magic_0_Hero%Y99^/?y16;
!!HEy99&y99>=0:S16/?y82 S25/?y85 Fd/d/?y22/d S24/?y87;                         [Checke ob der Held Sorcery und Water Magic hat und Spellpower]
*!VRy85&y85><0/v7198=1:+4;
!!FU|y82<3/y16<>1:E;

!!SN:W^H3_Water Magic_1_Hero%Y99^/?y87;
!!VRy22::3;
!!VRy22:+10;                                                                   [chance is 10% plus 1% per 3 Spellpower]
!!VRy22&y87=1:+5;                                                              [+5% with GM Water]
!!VRy1:S0T99;
!!BMx16&y1<y22:M59/1/3;


!?FU(AC_Function_112)&1000;     Return Creature Number

!!UN:C42231940/4/?y4;
!!UN:C6919200/4/?y2;
!!VRy4:-y2 -21708 :1352;
!!VRx1:Sy4;


*--------------------------------------------------------------------Extra Trigger for Blind -----------------------------------------------------------------------------*
!?FU(AC_Function_111);

!!if&x16<21;
!!HEv9281:Fd/d/?y1/d;                                                           [Save Spellpower aka aka Duration for attacker]
!!HEv9281:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;

!!if&x16>20;
!!HEv9282:Fd/d/?y1/d;                                                           [Save Spellpower aka aka Duration for defender]
!!HEv9282:A2/76/?y15/?y14 A2/77/?y16/?y14 A2/78/?y17/?y14 A2/139/?y18/?y14;     [check for spell duration changing artifacts]
!!VRy1&y15=1:+1;                                                                [76 Collar of Conjuring]
!!VRy1&y16=1:+2;                                                                [77 Ring of Conjuring]
!!VRy1&y17=1:+3;                                                                [78 Cape of Conjuring]
!!VRy1&y18=1:+56;                                                               [139 Ring of the Magi]
!!en;


!!BMx16:G62/?y86/?y11;                                                          [check fьr blind]

!!VRy32:Sy1;
.!!if&y11=3;
!!BMx16:M62/1/2;
.!!en;

*--------------------------------------------------------------------Extra Trigger for Dispel -----------------------------------------------------------------------------*
!?FU(AC_Function_115);

!!VRv9442:Sx16;
!!SN:W^Crea_Num%X16_Spell%Y1^/x16;                                              [Create dynamic variables]
!!DO(AC_Function_118)/27/58/1:P;


!?FU(AC_Function_118);

!!if&v9442>=0/v9442<=41;
!!BMv9442:Gx16/?y2/?y3;                                                         [check for active spells]
!!SN:W^Crea_Num%V9442_Spell%X16^/y2;                                            [Write duration in Creature_Var]
!!en;


!?FU(AC_Function_116);                                                                      [Give Back Spell Function]
!!VRv9448:Sx16;
!!DO(AC_Function_117)/27/58/1:P;


!?FU(AC_Function_117);                                                                      [Give Back Spell Function]
!!if&v9442>=0/v9442<=41;
!!SN:W^Crea_Num%V9448_Spell%X16^/?y2;                                           [Check duration in Creature_Var]
!!if&y2>0/x16<>35/x16<>37/x16<>38/x16<>39/x16<>40/x16<>42/x16<>45/x16<>47/x16<>50/x16<>52/x16<>54/x16<>59/x16<>60/x16<>61/x16<>62;
!!BMv9448:I?y1;
!!BA:Hy1/?y1;
!!FU(ApplyRemoveSpellScaling):Py1/x16/1/?y3/?y4;
!!SSx16:Ey3/y4;
!!BMv9448:Mx16/1/y3;                                                             [Give back Spell with 1 duration]
!!FU(ApplyRemoveSpellScaling):Py1/x16/-1/?y3/?y4;
!!SSx16:Ey3/y4;
!!en;
!!en;


*--------------------------------------------------------------------Extra Trigger for Force Field -----------------------------------------------------------------------------*
!?FU(AC_Function_100);

!!VRy10:S0;
!!BU:Ox16/?y1;                          [Check for Obstacle on Battlefield position]

!!if&y1>10;                            [If Obstacle is Force Field run HP Bonus Routine]
*!BG:N?y40;
!!VRy2:Sx16 -1;
*!VRy2&v9280=0:Sx16 -1;                                                         [Offset for left side]
*!VRy2&v9280=1:Sx16 +1;                                                         [Offset for right side]
!!BU&y2>=0:Ey2/?y3;                     [Get or check the stack number to of a living monster at position before the Force Field]

!!FU&y3=-1:E;                           [If no living Monster at that position Exit]

!!BMy3:H?y83;                           [Get HP of Creature]
!!SN&y3=0:W^M0_HP^/?y1; !!SN&y3=21:W^M21_HP^/?y1;
!!SN&y3=1:W^M1_HP^/?y1; !!SN&y3=22:W^M22_HP^/?y1;
!!SN&y3=2:W^M2_HP^/?y1; !!SN&y3=23:W^M23_HP^/?y1;
!!SN&y3=3:W^M3_HP^/?y1; !!SN&y3=24:W^M24_HP^/?y1;
!!SN&y3=4:W^M4_HP^/?y1; !!SN&y3=25:W^M25_HP^/?y1;
!!SN&y3=5:W^M5_HP^/?y1; !!SN&y3=26:W^M26_HP^/?y1;
!!SN&y3=6:W^M6_HP^/?y1; !!SN&y3=27:W^M27_HP^/?y1;
!!SN&y3=7:W^M7_HP^/?y1; !!SN&y3=28:W^M28_HP^/?y1;
!!SN&y3=8:W^M8_HP^/?y1; !!SN&y3=29:W^M29_HP^/?y1;
!!SN&y3=9:W^M9_HP^/?y1; !!SN&y3=30:W^M31_HP^/?y1;
!!SN&y3=10:W^M10_HP^/?y1; !!SN&y3=31:W^M31_HP^/?y1;

!!VRy10&y1=y83:S1;

!!if&y10=1;
!!VRy84:Sy83 *3+1:2;                    [Give +50% HP] (rounded up, @alf)]
!!BMy3:Hy84;
!!BMy3:T?y19;                           [monter type? attacking]
!!MA&y19>=0:Ly19/?y20;                  [monster level of receiving stack and defending stack]
!!VRy20:Sy20 +2;                        [Level of Monster + 2 damage]
!!BMy3:U1/?y21;                         [Check extra Damage]
!!BMy3:U2/?y22;
!!VRy21:+y20;
!!VRy22:+y20;
!!BMy3:U1/y21;                          [Give extra Damage]
!!BMy3:U2/y22;

!!VRz1:S^MAGCHDRN^;
!!SN:Pz1;
*Play Animation on Hex
!!UN:C6919200/4/?y11;
!!SN:E4810128/2/y11/77/y2/100/0;
!!en;
!!en;


!?FU(AC_Function_119);

!!VRy10:S0;
!!BMx16:H?y83;

!!if&x16<11;
!!SN&x16=0:W^M0_HP^/?y1; !!SN&x16=21:W^M21_HP^/?y1;
!!SN&x16=1:W^M1_HP^/?y1; !!SN&x16=22:W^M22_HP^/?y1;
!!SN&x16=2:W^M2_HP^/?y1; !!SN&x16=23:W^M23_HP^/?y1;
!!SN&x16=3:W^M3_HP^/?y1; !!SN&x16=24:W^M24_HP^/?y1;
!!SN&x16=4:W^M4_HP^/?y1; !!SN&x16=25:W^M25_HP^/?y1;
!!SN&x16=5:W^M5_HP^/?y1; !!SN&x16=26:W^M26_HP^/?y1;
!!SN&x16=6:W^M6_HP^/?y1; !!SN&x16=27:W^M27_HP^/?y1;
!!SN&x16=7:W^M7_HP^/?y1; !!SN&x16=28:W^M28_HP^/?y1;
!!SN&x16=8:W^M8_HP^/?y1; !!SN&x16=29:W^M29_HP^/?y1;
!!SN&x16=9:W^M9_HP^/?y1; !!SN&x16=30:W^M31_HP^/?y1;
!!SN&x16=10:W^M10_HP^/?y1; !!SN&x16=31:W^M31_HP^/?y1;

!!VRy5:Sy1 *3+1:2;                      [(rounded up, @alf)]
!!VRy10&y5=y83/y5<>0:S1;

!!FU&y10=0:E;

!!BMx16:F?i;                            [read flags]
!!VRi:&1;                               [just look at double wide]
!!BMx16:P?y2;                           [Check position of creature]
*!IF:M^Position is %Y2^;
*!VRy2&v9280=0:+1;                                                                      [Offset for Force Field Attacker]
*!VRy2&v9280=1:-1;                                                                      [Offset for Force Field Defender]
!!VRy2:+1;
*!VRy2&i>0/v9280=0:+1;                                                                  [Offset for Big Creature]
*!VRy2&i>0/v9280=1:-1;                                                                  [Offset for Big Creature]
!!VRy2&i>0:+1;
*!IF:M^Now Offeset Position is %Y2 and side is %V9280^;
!!BU:Oy2/?y3;                           [Check for Obstacle on Battlefield position]
!!FU&y3>10:E;                           [Exit it creature is next to Force Field]

!!BMx16:Hy1;                            []

!!BMx16:T?y19;                          [monter type? attacking]
!!MA&y19>=0:Ly19/?y20;                  [monster level of receiving stack and defending stack]
!!VRy20:Sy20 +2;                        [Level of Monster + 2 damage]
!!BMx16:U1/?y21;                        [Check extra Damage]
!!BMx16:U2/?y22;
!!VRy21:-y20;
!!VRy22:-y20;
!!BMx16:U1/y21;                         [Take extra Damage]
!!BMx16:U2/y22;
!!en;


!?FU(AC_Function_107);

!!BMx16:H?y1;
!!SN&x16=0:W^M0_HP^/y1; !!SN&x16=1:W^M1_HP^/y1; !!SN&x16=2:W^M2_HP^/y1; !!SN&x16=3:W^M3_HP^/y1; !!SN&x16=4:W^M4_HP^/y1; [**Save HP for first 11 creature of attacker]
!!SN&x16=5:W^M5_HP^/y1; !!SN&x16=6:W^M6_HP^/y1; !!SN&x16=7:W^M7_HP^/y1; !!SN&x16=8:W^M8_HP^/y1; !!SN&x16=9:W^M9_HP^/y1; !!SN&x16=10:W^M10_HP^/y1;
!!SN&x16=21:W^M21_HP^/y1; !!SN&x16=22:W^M22_HP^/y1; !!SN&x16=23:W^M23_HP^/y1; !!SN&x16=24:W^M24_HP^/y1; !!SN&x16=25:W^M25_HP^/y1;
!!SN&x16=26:W^M26_HP^/y1; !!SN&x16=27:W^M27_HP^/y1; !!SN&x16=28:W^M287_HP^/y1; !!SN&x16=29:W^M29_HP^/y1; !!SN&x16=30:W^M30_HP^/y1; !!SN&x16=31:W^M31_HP^/y1; [**Save HP for first 11 creature of defender]


*--------------------------------------------------------------------Extra Trigger for Quicksand -----------------------------------------------------------------------------*
!?FU(AC_Function_123);

!!BMx16:F?i;
!!VRi:&4;                               [just look at shooting bit]
!!if&i>0;
!!BMx16:P?y1;
!!VRy2:S1;
!!VRy2&x16>=21:S4;
!!FU(AC_Function_126):Py1/y2/?y3;
!!BMx16:Q0/y3/1;
!!en;

!?FU(AC_Function_126);                  [Function to calculate neighbouring Hex cells]
!!UN:C6919200/4/?y1;                    [Y1 = combatManager]
!!VRx2:*2;
!!VRx1:*12+ y1+ 78952+ x2;
!!UN:Cx1/2/?x3;


*--------------------------------------------------------------------Teleport -----------------------------------------------------------------------------*
!?FU(AC_Function_125);

!!BMx16:P?y1;
!!VRy1&x1=10:S0;
!!SN&x16=0:W^M0_PO^/y1; !!SN&x16=1:W^M1_PO^/y1; !!SN&x16=2:W^M2_PO^/y1; !!SN&x16=3:W^M3_PO^/y1; !!SN&x16=4:W^M4_PO^/y1; [**Save PO for first 11 creature of attacker]
!!SN&x16=5:W^M5_PO^/y1; !!SN&x16=6:W^M6_PO^/y1; !!SN&x16=7:W^M7_PO^/y1; !!SN&x16=8:W^M8_PO^/y1; !!SN&x16=9:W^M9_PO^/y1; !!SN&x16=10:W^M10_PO^/y1;
!!SN&x16=21:W^M21_PO^/y1; !!SN&x16=22:W^M22_PO^/y1; !!SN&x16=23:W^M23_PO^/y1; !!SN&x16=24:W^M24_PO^/y1; !!SN&x16=25:W^M25_PO^/y1;
!!SN&x16=26:W^M26_PO^/y1; !!SN&x16=27:W^M27_PO^/y1; !!SN&x16=28:W^M287_PO^/y1; !!SN&x16=29:W^M29_PO^/y1; !!SN&x16=30:W^M30_PO^/y1; !!SN&x16=31:W^M31_PO^/y1; [**Save PO for first 11 creature of defender]

*--------------------------------------------------------------------Teleport -----------------------------------------------------------------------------*
!?FU(AC_Function_124);

!!BG:N?y20;
!!BMx16:P?y2;
!!FU&v9280=0/x16>10:E;
!!FU&v9280=1/x16<21:E;

!!if&x16>=0/x16<=10;
!!SN&x16=0:W^M0_PO^/?y1;
!!SN&x16=1:W^M1_PO^/?y1;
!!SN&x16=2:W^M2_PO^/?y1;
!!SN&x16=3:W^M3_PO^/?y1;
!!SN&x16=4:W^M4_PO^/?y1;
!!SN&x16=5:W^M5_PO^/?y1;
!!SN&x16=6:W^M6_PO^/?y1;
!!SN&x16=7:W^M7_PO^/?y1;
!!SN&x16=8:W^M8_PO^/?y1;
!!SN&x16=9:W^M9_PO^/?y1;
!!SN&x16=10:W^M10_PO^/?y1;
!!en;

!!if&x16>=21/x16<=31;
!!SN&x16=21:W^M21_PO^/?y1;
!!SN&x16=22:W^M22_PO^/?y1;
!!SN&x16=23:W^M23_PO^/?y1;
!!SN&x16=24:W^M24_PO^/?y1;
!!SN&x16=25:W^M25_PO^/?y1;
!!SN&x16=26:W^M26_PO^/?y1;
!!SN&x16=27:W^M27_PO^/?y1;
!!SN&x16=28:W^M28_PO^/?y1;
!!SN&x16=29:W^M29_PO^/?y1;
!!SN&x16=30:W^M30_PO^/?y1;
!!SN&x16=31:W^M31_PO^/?y1;
!!en;

!!if&y2<>y1;
!!BMx16:P?y4;
!!FU(AC_Function_126):Py4/0/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/1/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/2/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/3/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/4/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/5/?y3;
!!BMy20:Q1/y3/1;


!!BMx16:F?i;                            [read flags]
!!VRi:&1;                               [just look at double wide]

!!if&i>0;
!!BMx16:P?y4;
!!VRy4&v9280=0:+1;                      [Offset position for big creature attacker]
!!VRy4&v9280=1:-1;                      [Offset position for big creature defender]
!!FU(AC_Function_126):Py4/0/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/1/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/2/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/3/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/4/?y3;
!!BMy20:Q1/y3/1;
!!FU(AC_Function_126):Py4/5/?y3;
!!BMy20:Q1/y3/1;
!!en;
!!en;


*--------------------------------------------------------------------Earthquake -----------------------------------------------------------------------------*
!?FU(AC_Function_127);

!!BMx16:H?y1;
!!BMx16:U3/?y6;                         [save number of shots ]
!!FU&y1<1:E;
!!HE-1:Fd/d/?y3/d;
!!VRy2:S0T99;
!!VRy4:Sy3 *3 :10;                      [Chance is 15% +3% per 10SP]
!!VRy5:Sy4 +15;
!!VRy5&y5>30:S30;                       [cap at 30% chance ]

!!if&y2<y5;
!!BMx16:M74/1/0;
!!en;

!!if&y6>0;                             [50% chance to loose 3 ammunition]
!!VRy2:S0T1;
!!VRy6&y2=1:-3;
!!VRy6&y6<0:S0;
!!BMx16:U3/y6;                          [apply number of shots]
!!BMx16&y2=1:V48;                       [show misfortune if shots ammunition lost]
!!en;

*--------------------------------------------------------------------Remove Obstacle -----------------------------------------------------------------------------*
!?FU(AC_Function_96);

!!HE-1:Fd/d/?y60/d;
!!VRy61:S0T99;
!!VRy60:+30;
!!VRy62&y61<y60:S1;

!!BG:Q?y1;                              [Current attacking side]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;

!!if&y62=1/y4=0;
!!BHv9280:M0;
!!SN:T^AC_Misc.Obstacle cast^/?z1;
!!BU&1000/f=0:Mz1;
!!VRz1:S^FORTUNE^;
!!SN&1000/f=0:Pz1;
!!en;

*--------------------------------------------------------------------Armageddon -----------------------------------------------------------------------------*
!?FU(AC_Function_97);

!!BMx16:M31/1/3;

*--------------------------------------------------------------------Berserker -----------------------------------------------------------------------------*
!?FU(AC_Function_98);

!!BMx16:G59/?y1/?y2;

!!SN&x16=0:W^BE_00^/y1;
!!SN&x16=1:W^BE_01^/y1;
!!SN&x16=2:W^BE_02^/y1;
!!SN&x16=3:W^BE_03^/y1;
!!SN&x16=4:W^BE_04^/y1;
!!SN&x16=5:W^BE_05^/y1;
!!SN&x16=6:W^BE_06^/y1;
!!SN&x16=7:W^BE_07^/y1;
!!SN&x16=8:W^BE_08^/y1;
!!SN&x16=9:W^BE_09^/y1;

!!SN&x16=21:W^BE_21^/y1;
!!SN&x16=22:W^BE_22^/y1;
!!SN&x16=23:W^BE_23^/y1;
!!SN&x16=24:W^BE_24^/y1;
!!SN&x16=25:W^BE_25^/y1;
!!SN&x16=26:W^BE_26^/y1;
!!SN&x16=27:W^BE_27^/y1;
!!SN&x16=28:W^BE_28^/y1;
!!SN&x16=29:W^BE_29^/y1;


!?FU(AC_Function_99);

!!BMx16:G59/?y3/?y4;

!!SN&x16=0:W^BE_00^/?y1;
!!SN&x16=1:W^BE_01^/?y1;
!!SN&x16=2:W^BE_02^/?y1;
!!SN&x16=3:W^BE_03^/?y1;
!!SN&x16=4:W^BE_04^/?y1;
!!SN&x16=5:W^BE_05^/?y1;
!!SN&x16=6:W^BE_06^/?y1;
!!SN&x16=7:W^BE_07^/?y1;
!!SN&x16=8:W^BE_08^/?y1;
!!SN&x16=9:W^BE_09^/?y1;

!!SN&x16=21:W^BE_21^/?y1;
!!SN&x16=22:W^BE_22^/?y1;
!!SN&x16=23:W^BE_23^/?y1;
!!SN&x16=24:W^BE_24^/?y1;
!!SN&x16=25:W^BE_25^/?y1;
!!SN&x16=26:W^BE_26^/?y1;
!!SN&x16=27:W^BE_27^/?y1;
!!SN&x16=28:W^BE_28^/?y1;
!!SN&x16=29:W^BE_29^/?y1;

!!BMx16:N?y10;
!!BMx16&y3=0/y1>0/y10>0:M54/2/3;
!!BMx16&y3=0/y1>0/y10>0:V19;

!!BGx16:E?y11;                          [Berserker spread handling]
!!SN:W^Bers_spread^/?y15;
!!if&y11>=0/y11<=41/y3=0/y1>0/y10>0/y15=0;
!!BMy11:G59/?y12/?y13;
!!VRy14&y12=0:S0T3;                     [25% chance to spread Berserk]
!!BMy11&y14=1/y12=0:M59/2/3;
!!BMy11&y14=1/y12=0:V35;
!!SN&y14=1/y12=0:W^Bers_spread^/1;      [Can only happen once per Battleround]
!!en;

*--------------------------------------------------------------------Animate Dead -----------------------------------------------------------------------------*
!?FU(AC_Function_104);

!!BMx16:N?y1;

!!if&y1>0;
!!SN&x16=0:W^Animate_00^/y1;
!!SN&x16=1:W^Animate_01^/y1;
!!SN&x16=2:W^Animate_02^/y1;
!!SN&x16=3:W^Animate_03^/y1;
!!SN&x16=4:W^Animate_04^/y1;
!!SN&x16=5:W^Animate_05^/y1;
!!SN&x16=6:W^Animate_06^/y1;
!!SN&x16=7:W^Animate_07^/y1;
!!SN&x16=8:W^Animate_08^/y1;
!!SN&x16=9:W^Animate_09^/y1;

!!SN&x16=21:W^Animate_21^/y1;
!!SN&x16=22:W^Animate_22^/y1;
!!SN&x16=23:W^Animate_23^/y1;
!!SN&x16=24:W^Animate_24^/y1;
!!SN&x16=25:W^Animate_25^/y1;
!!SN&x16=26:W^Animate_26^/y1;
!!SN&x16=27:W^Animate_27^/y1;
!!SN&x16=28:W^Animate_28^/y1;
!!SN&x16=29:W^Animate_29^/y1;
!!en;

!?FU(AC_Function_128);

!!BMx16:N?y2;

!!if&y2>0;
!!SN&x16=0:W^Animate_00^/?y1;
!!SN&x16=1:W^Animate_01^/?y1;
!!SN&x16=2:W^Animate_02^/?y1;
!!SN&x16=3:W^Animate_03^/?y1;
!!SN&x16=4:W^Animate_04^/?y1;
!!SN&x16=5:W^Animate_05^/?y1;
!!SN&x16=6:W^Animate_06^/?y1;
!!SN&x16=7:W^Animate_07^/?y1;
!!SN&x16=8:W^Animate_08^/?y1;
!!SN&x16=9:W^Animate_09^/?y1;

!!SN&x16=21:W^Animate_21^/?y1;
!!SN&x16=22:W^Animate_22^/?y1;
!!SN&x16=23:W^Animate_23^/?y1;
!!SN&x16=24:W^Animate_24^/?y1;
!!SN&x16=25:W^Animate_25^/?y1;
!!SN&x16=26:W^Animate_26^/?y1;
!!SN&x16=27:W^Animate_27^/?y1;
!!SN&x16=28:W^Animate_28^/?y1;
!!SN&x16=29:W^Animate_29^/?y1;

!!if&y2<>y1/y1>0;
!!SN:W^Animate_Monster^/x16;
!!en;
!!en;

*--------------------------------------------------------------------Magic Arrow -----------------------------------------------------------------------------*
!?FU(AC_Function_129);
*[refer to hero 0-155]

!!SN:W^Magic_Arrow_Hero%X16^/0;         [at map start reset counter for magic arrow]

*--------------------------------------------------------------------Magic Mirror -----------------------------------------------------------------------------*
!?FU(AC_Function_102);                  [Count Function]

!!BMx16:G36/?y12/?y13;
!!SN&y12>0:W^Magic_Mirror_Counter^/d+1;

!?FU(AC_Function_103);                  [Apply Function]

[:LoopRandomMonster]
!!VRy5&x4=1:S0T7;
!!VRy5&x4=2:S21R7;
!!BMy5:N?y2;
!!BMy5:T?y3;
!!SN|y2=0/y3=145/y3=146/y3=147/y3=148/y3=149:G[LoopRandomMonster]; [Loop until it finds a valid Stack to apply debuff, execlude Warmachines]

!!BMy5:Mx3/x2/3;

!!VRx1:-1;
!!VRx16&x1=0:S41;                       [End if no more creatures have magic mirror]


***********************************Reworking some spells***************
*Bless deals with the next attack bonus damage based on the heroes current spell points*
!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!SN:W^BlessSpell_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^BlessSpell_Attacking_Stack^/y4;

!!BMy1:I?y2;                            [Side index as for heroes (0:left, 1:right)]
!!SN:W^Bless_Cast%Y2^/?y3;              [Check if there was a valid Bless cast]
!!FU&y3=0:E;                            [Exit if there was not a correct bless cast this battle]
!!SN:W^Bless_Strike_Creature%Y1^/?y11;  [Disable for creature so it only works once]
!!FU&y11=0:E;

!!BMy1:G41/?y13/?y14;                   [check for Bless Duration]
!!FU&y13=0:E;
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;
!!MF:F?y4;                              [original damage]
!!HEy99:I?y6/1;                         [Get Current spell points]
!!VRy4:Sy4+y6;
!!MF&y6>0:Fy4;                          [deal new updated damage with spell points damage]
!!SN&y6>0:W^Bless_Strike_Creature%Y1^/0;[Disable for creature so it only works once]
!!BA:Q?f;
!!SN&f=0:T^AC_Misc.Bless_SP_Damage^/?z-1/^damage^/y6;
!!BU&f=0/1000:Mz-1;
!!en;

***********************************
*Anti Magic, as long as AM is active on any of your stacks all your creatures gain +15% MR*
!?MR2&1000;                             [Magic Resistance Trigger]

!!MR:N?y1;                              [Get Creature Number]
!!BMy1:I?y2;                            [Get Creature Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y4;                           [Get Hero Number of creature side]
!!FU&y4<0:E;
!!SN:W^H3_Water Magic_0_Hero%Y4^/?y10;  [Water Magic Bonus handling]
!!FU|y50=y4/y10=0:E;                    [Exit for beneficial spells, meaning same hero]
!!VRy20:S0;
!!if&y2=1;                             [Check Defender Creatures]
!!re i/21/31;                          [34 Anti-Magic]
!!BMi:G34/?y12/?y13;
!!VRy20&y12>0:S1;
!!en;
!!en;
!!if&y2=0;                             [Check Attacker creatures]
!!re i/0/10;                           [34 Anti-Magic]
!!BMi:G34/?y12/?y13;                    [check for Anti Magic]
!!VRy20&y12>0:S1;                       [Set y20 to 1 if creature found]
!!en;
!!en;

!!if&y20=1;                            [If a creature with Anti Magic was found increase all MR]
!!MR:F?y5;                              [Get temporarily MR of Creature]
!!VRy5:+15; !!VRy5&y5>=100:S100;        [Cannot be more than 100%]
!!MR:Fy5;                               [Apply increased resistance chance to that stack temporarily]
!!en;


***********************************
*Precision next range attack deals AOE damage based on your SP*
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y90;   [Air Magic Bonus handling]
!!BMy1:G44/?y12/?y13;                   [44  Precision]
!!SN:W^Precision_Strike_Creature%Y1^/?y11; [Check if Creature still can hit]
!!FU|y90=0/y12=0/y11=0:E;               [Exit if not Master Air or No Precision cast on stack or no more hits]

!!BA:Q?f;
!!BMy4&f=0/1000:V53;                    [Show Fireball animation]
!!BMy4:P?y1 I?y30;                      [get target position and Side]
!!MF:F?y10;                             [get damage of ranged attack]
!!HEy5:F?y21/?y21/?y20/?y21;            [Get Spell Power of Hero in y20]
!!VRy12:Sy20:5+20;                      [AOE Damage is 20%+1% per 5 SP]
!!VRy10:*y12:100;                       [% of the damage]

!!FU(AC_Function_126):Py1/0/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/1/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/2/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/3/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/4/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/5/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!BG:N?y1;                              [Attacking Stack]
!!SN:W^Precision_Strike_Creature%Y1^/0; [Disable for creature so it only works once]

!?BF;

!!re y1/0/41;
 !!SN:W^Bless_Strike_Creature%Y1^/0;    [Reset Strikes before any Battle]
 !!SN:W^Precision_Strike_Creature%Y1^/0;
!!en;


************************
Frenzy: chance to avoid retaliations

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;          [Only run when melee or strikes all round]

!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>6:E;                           [Exit if not melee attack]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!FU&y4<>y1:E;                          [If attacking stack same as defending stack it means retaliation]
!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Fire Magic_0_Hero%Y99^/?y90;  [Fire Magic Bonus handling]
!!SN:W^H3_Fire Magic_1_Hero%Y99^/?y91;  [Fire Magic Bonus handling]
!!BMy1:G56/?y12/?y13;                   [56 Frenzy]
!!FU|y12=0/y90=0:E;

!!HEy99:F?y41/?y41/?y40/?y41;
!!VRy20:S0T99;
!!VRy40::5 +20;                         [+SP/5% +20% chance to dodge]
!!VRy40&y91>0:+10;                      [+10% chance with GM Air]

!!if&y40>y20;                          [If roll is successful]
  !!BA:Q?f;
  !!VRz-1&1000:S^AIRSHELD^;
  !!SN&1000/f=0:Pz-1;
  !!MF:E0;                              [apply reduced damage]
  !!MF:F0;
  !!SN:T^AC_Misc.Air Dodge^/?z-1;
  !!BU&1000/f=0:Mz-1;                   [show message in log]
!!en;
!!en;


************************
Counterstrike: Increases retaliation damage based on your SP

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;          [Only run when melee or strikes all round]

!!MF:W?y80;
!!FU&y80>0:E;
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>6:E;                           [Exit if not melee attack]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]

!!SN:W^Counterstrike_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Counterstrike_Attacking_Stack^/y4;

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!SN:W^H3_Air Magic_0_Hero%Y99^/?y90;   [Air Magic Bonus handling]
!!SN:W^H3_Air Magic_1_Hero%Y99^/?y91;   [Air Magic Bonus handling]
!!SN:W^Counterstrike_Cast%Y5^/?y3;      [Check if there was a valid Bless cast]
!!BMy1:G58/?y12/?y13;                   [58 Counterstrike]
!!FU|y12=0/y90=0/y3=0:E;                [Exit if conditions are wrong]

!!HEy99:F?y41/?y41/?y40/?y41;
!!VRy40::3 +10 +100;                    [+SP/3% +10% increased damage]
!!VRy40&y91>0:+10;                      [+10% increase with GM Air]

!!MF:F?y6;                              [damage dealt]
!!VRy10:Sy6*y40:100-y6;                 [Calc increased damage]
!!VRy6:+y10;
!!MF:Fy6;
!!BA:Q?f;
!!SN&1000:T^AC_Misc.Counterstrike_Avoid^/?z-1/^damage1^/y10;
!!BU&1000/f=0:Mz-1;
!!en;


*--------------------------------------------------------------------free -----------------------------------------------------------------------------*










*--------------------------------------------------------------------Not Used for now -----------------------------------------------------------------------------*
!?FU(AC_Function_70);
!!FU:E;
**Check for flying bit
* for natural born flyers (it's their monster ability (eg. gryffin), check their flying flag
!!VRi:S0;
!!BMx16:F?i;                            [check if monster is flying creature (has flying flag)]
!!VRi:&2;                               [set to <> 0 if flying creature]
!!VRy77:Si;
!!if&y77=0;
!!BMx16:F?i;                            [look on bits]
!!VRi:|2;                               [set stack to done acting this round (lost movement possibility)]
!!BMx16:Fi;                             [set new modified bit if stack is flying]
*!IF:M^Set^;
* for experience bonus flyers (eg. imp), check if bonus line is active
!!en;


*-----------------------Set correct Spell Description---------------------------
**Set when click on Spell Book
**Set when click on Mage Guild in Town
**Set in Battle
**Set when click cast spell on Adv.Map

!?CM2;                                  [Spell Book Click]
!!CM:S?y1 T?y2 I?y3;
!!FU|y1<>12/y2<>512/y3<>19:E;           [When Left Click on the Spell Book]
!!HE-1:N?y1;
!!FU(H3_Set_Spell_Descriptions)&1000/y1>=0/y1<=155:Py1/3;

!?FU(OnBattleRegeneratePhase)&1000;     [Set spells in Combat]
!!SN:X?y1/?y2/0;                        [get who moves]
!!VRy2:Sy1:21;                          [get side]
!!BHy2:N?y1;                            [get owner]
!!FU(H3_Set_Spell_Descriptions)&1000/y1>=0/y1<=155:Py1/y2;

!?CM1;                                  [town screen click]
!!CM:I?y1;
!!FU&y1>5:E;                            [0-5 mage guild click]
!!FU(H3_Set_Spell_Descriptions_Orginal)&1000:P;

!?CM5;                                  [Left Click Adventure Screen]
!!CM:I?y2;
!!if&y2=8;
!!OW:A-1/?y1;
!!FU(H3_Set_Spell_Descriptions)&1000/y1>=0/y1<=155:Py1/3; [When clicked on Cast Spell Button on Adventure Screen]
!!en;

*?OB54&1000;                       [When visiting a Monster, this is done so that spells applied to a monster have the normal power]
*!VRz1:S^SPTRAITS.TXT^;            [Normal Sptraits]
*!UN:C5890966/4/9597928;
*!SN:E5890960/1;
*!UN:C5890966/4/6849372;

!?FU(H3_Set_Spell_Descriptions);

!!SN:W^Damage_Spells_Increment^/?y79;
!!SN:W^Spell_Trainer_Mod^/?y80;         [Check for Spell Trainer option]

!!HEx1:F?y1/?y1/?y2/?y1;
!!HEx1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S25/?y85; [Checke current hero Sorcery und Magien hat]

!!TRv998/v999/v1000:G?y1;               [Check for Terrain on Which the hero stands to prevent wrong spell description if on special terrain]
!!VRy81&y1=46:S3; Magic Plains 46 !!VRy81&y1=226:S3; [Fiery Field 226]
!!VRy82&y1=46:S3; Magic Plains 46 !!VRy82&y1=229:S3; [Magic Clouds 229]
!!VRy83&y1=46:S3; Magic Plains 46 !!VRy83&y1=228:S3; [Loucid Pool 228]
!!VRy84&y1=46:S3; Magic Plains 46 !!VRy84&y1=231:S3; [Rocklands 231]

!!SN:W^H3_Sorcery_0_Hero%X1^/?y20;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y21;

!!VRy1&y85=0:S0;                        [No Sorcery]
!!VRy1&y85=1/y20=0/y21=0:S1;            [Basic         +1 Spell Points]
!!VRy1&y85=2/y20=0/y21=0:S2;            [Advanced      +2]
!!VRy1&y85=3/y20=0/y21=0:S3;            [Expert        +3]
!!VRy1&y85=3/y20=1/y21=0:S4;            [Master        +4]
!!VRy1&y85=3/y20=1/y21=1:S5;            [Grandmaster   +5]

!!VRy30:S0; !!VRy31:S0;
!!SN&x2=0:W^Magic_Specialists_%V997_Cast_Count_Att^/?y30;
!!SN&x2=1:W^Magic_Specialists_%V997_Cast_Count_Def^/?y30;
!!VRy31&y30=0:S0; !!VRy31&y30=1:S2; !!VRy31&y30=2:S5; !!VRy31&y30=3:S10; !!VRy31&y30=4:S15; !!VRy31&y30=5:S20; !!VRy31&y30=6:S25; !!VRy31&y30=7:S30; !!VRy31&y30=8:S30; !!VRy31&y30=9:S30; !!VRy31&y30>=10:S30;
!!VRy1:+y31;

[Restore original spell value]
!!re i/0/69;
  !!SN:W^H3_Normal_Spell_%Vi_Cost^/?t;    !!SSi:C0/t;
  !!SN:W^H3_Basic_Spell_%Vi_Cost^/?t;     !!SSi:C1/t;
  !!SN:W^H3_Advanced_Spell_%Vi_Cost^/?t;  !!SSi:C2/t;
  !!SN:W^H3_Expert_Spell_%Vi_Cost^/?t;    !!SSi:C3/t;

  !!if|i=11/i=13/i=15/i=16/i=17/i=18/i=19/i=20/i=21/i=22/i=23/i=24/i=25/i=26/i=57;
    !!SN:W^H3_Normal_Spell_%Vi_Effect^/?t;   !!SSi:E0/t; [Normal]
    !!SN:W^H3_Basic_Spell_%Vi_Effect^/?t;    !!SSi:E1/t; [Basic]
    !!SN:W^H3_Advanced_Spell_%Vi_Effect^/?t; !!SSi:E2/t; [Advanced]
    !!SN:W^H3_Expert_Spell_%Vi_Effect^/?t;   !!SSi:E3/t; [Expert]
  !!en;
!!en;

*Change Spell Point Costs for all Spells (replaces SPTRAITS, should be safer to use but just guessing) at least fixes the bug that the ballista is calles SPTRAITS in battle
*!DO(AC_Function_72)/0/69/1:Py1;        [Increase]
!!re i/0/69;
  !!SSi:C0/dy1;                         [Normal]
  !!SSi:C1/dy1;                         [Basic]
  !!SSi:C2/dy1;                         [Advanced]
  !!SSi:C3/dy1;                         [Expert]

  !!if|i=11/i=13/i=15/i=16/i=17/i=18/i=19/i=20/i=21/i=22/i=23/i=24/i=25/i=26/i=57; [Disabled for now]
    !!SSi:S?y60;                        [Get spell's magic school bits]
    *!FU(MSR_Determine_Spell_Type):Pi/0/0/?y26; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
    !!VRy61:Sy60:1%2;                   [air. If bits of this spell contain school of air magic, this will be equal to 1]
    !!VRy62:Sy60:2%2;                   [fire]
    !!VRy63:Sy60:4%2;                   [water]
    !!VRy64:Sy60:8%2;                   [earth]
    !!VRy25&y61=1:S1;                   [air y3]
    !!VRy25&y62=1:S4;                   [fire y4]
    !!VRy25&y63=1:S8;                   [water y5]
    !!VRy25&y64=1:S2;                   [earth y6]
    !!VRy26&y25=1:Sy82;                 [Air]
    !!VRy26&y25=2:Sy84;                 [Earth]
    !!VRy26&y25=4:Sy81;                 [Fire]
    !!VRy26&y25=8:Sy83;                 [Water]
    !!if&y25=15;
      !!VRy26|y81=0/y82=0/y83=0/y84=0:S0;
      !!VRy26|y81=1/y82=1/y83=1/y84=1:S1;
      !!VRy26|y81=2/y82=2/y83=2/y84=2:S2;
      !!VRy26|y81=3/y82=3/y83=3/y84=3:S3;
    !!en;
    !!SSi:Ey26/?y3; !!SSi:P?y5;         [Get Spell damage Power and Extra Damage]
    !!FU(H3_Calc_Normal_Spell_Damage):Px1/?y99/?y98/0/i/0;
    !!VRy23:Sy5*y2+y3;
    !!VRy24:Sy5*y2+y3*y99:100;

    !!VRy24:Sy24-y23+y3;
    *!IF&i=24:L^now %Vi y23 is%Y23    Total:%Y24  Readout y3:%Y3  and power is y5:%Y5  and SP is:%Y2  y99 is %Y99^;
    !!if|i=11/i=13;
      !!SN&i=13:W^Hero%X1_Fire Wall_Upgrade^/?y23; !!VRy24&i=13:Sy23*50+y3; [Exception for Landmine]
      !!SN&i=11:W^Hero%X1_Land Mine_Upgrade^/?y23; !!VRy24&i=11:Sy23*35+y3; [Exception for Fire Wall]
    !!en;
    !!SSi:Ey26/y24;
  !!en;
!!en;

!!FU(Calc_Magic_Strength):Px1/?y90;

!!SN:W^H3_Fire Magic_0_Hero%X1^/?y10;   [Fire Magic Bonus handling]
!!SN:W^H3_Fire Magic_1_Hero%X1^/?y11;
!!FU(Fire_Spells_Improved_Description):Px1/y2/y11/y10/y11/y81/y90/y85/y80/y79; [Pass Spell Power Y2 and Hero Number X1 and (Intelligence Y11) and Master Y10  and Grandmaster Level Y11 and Fire Magic Y81 and Magic Strength Y90 and Sorcery Y85 and y80 spell trainer option]

!!SN:W^H3_Air Magic_0_Hero%X1^/?y10;    [Air Magic Bonus handling]
!!SN:W^H3_Air Magic_1_Hero%X1^/?y11;
!!FU(Air_Spells_Improved_Description):Px1/y2/y11/y10/y11/y82/y90/y85/y80/y79;

!!SN:W^H3_Water Magic_0_Hero%X1^/?y10;  [Water Magic Bonus handling]
!!SN:W^H3_Water Magic_1_Hero%X1^/?y11;
!!FU(Water_Spells_Improved_Description):Px1/y2/y11/y10/y11/y83/y90/y85/y80/y79;

!!SN:W^H3_Earth Magic_0_Hero%X1^/?y10;  [Earth Magic Bonus handling]
!!SN:W^H3_Earth Magic_1_Hero%X1^/?y11;
!!FU(Earth_Spells_Improved_Description):Px1/y2/y11/y10/y11/y84/y90/y85/y80/y79;

!!SN:W^H3_Fire Magic_0_Hero%X1^/?y10;   [Fire Magic Bonus handling]
!!SN:W^H3_Fire Magic_1_Hero%X1^/?y11;
!!SN:W^H3_Air Magic_0_Hero%X1^/?y13;    [Air Magic Bonus handling]
!!SN:W^H3_Air Magic_1_Hero%X1^/?y14;
!!SN:W^H3_Water Magic_0_Hero%X1^/?y15;  [Water Magic Bonus handling]
!!SN:W^H3_Water Magic_1_Hero%X1^/?y16;
!!SN:W^H3_Earth Magic_0_Hero%X1^/?y17;  [Earth Magic Bonus handling]
!!SN:W^H3_Earth Magic_1_Hero%X1^/?y18;

!!VRy50&y10=0/y13=0/y15=0/y17=0:S0;
!!VRy50|y10=1/y13=1/y15=1/y17=1:S1;
!!VRy50|y11=1/y14=1/y16=1/y18=1:S2;

!!FU(Magic_Arrow_Improved_Description):Px1/y81/y82/y83/y84/y50/y85/0/y80/y79; [Normal-Expert]


********************************************************************************
*Sets the Spell Description in the Mage Guilt
!?FU(H3_Set_Spell_Descriptions_Orginal);

!!VRz125:Sz199705;                      [Magic Arrow]
!!SS15:D0/z125;

** Fire
!!VRz121:Sz199701;                      [Land Mine]
!!SS11:D0/z121;

!!VRz123:Sz199703;                      [Fire Wall]
!!SS13:D0/z123;

!!VRz131:Sz199711;                      [Fireball]
!!SS21:D0/z131;

!!VRz132:Sz199712;                      [Inferno]
!!SS22:D0/z132;

!!VRz136:Sz199716;                      [Armageddon]
!!SS26:D0/z136;

!!VRz139:Sz199719;                      [Fire Shield]
!!SS29:D0/z139;

!!VRz481:Sz199720;                      [Protection from Fire]
!!SS31:D0/z481;

!!VRz258:Sz199730;                      [Sacrifice]
!!SS40:D0/z258;

!!VRz257:Sz199732;                      [Curse]
!!SS42:D0/z257;

!!VRz256:Sz199733;                      [Bloodlust]
!!SS43:D0/z256;

!!VRz255:Sz199742;                      [Misfortune]
!!SS52:D0/z255;

!!VRz770:Sz199745;                      [Slayer]
!!SS55:D0/z770;

!!VRz254:Sz199746;                      [Frenzy]
!!SS56:D0/z254;

!!VRz730:Sz199749;                      [Berserk]
!!SS59:D0/z730;

!!VRz772:Sz199752;                      [Blind]
!!SS62:D0/z772;

!!VRz776:Sz199756;                      [Summon Fire Elemental]
!!SS66:D0/z776;
**

**Air
!!VRz127:Sz199707;                      [Lightning Bolt}]
!!SS17:D0/z127;

!!VRz129:Sz199709;                      [Chain Lightning}]
!!SS19:D0/z129;

!!VRz135:Sz199715;                      [Destroy Undead}]
!!SS25:D0/z135;

!!VRz138:Sz199718;                      [Air Shield}]
!!SS28:D0/z138;

!!VRz140:Sz199720;                      [Protection from Air}]
!!SS30:D0/z140;

!!VRz119:Sz199726;                      [Magic Mirror}]
!!SS36:D0/z119;

!!VRz253:Sz199734;                      [Precision}]
!!SS44:D0/z253;

!!VRz252:Sz199737;                      [Disrupting Ray}]
!!SS47:D0/z252;

!!VRz251:Sz199741;                      [Fortune}]
!!SS51:D0/z251;

!!VRz250:Sz199743;                      [Haste}]
!!SS53:D0/z250;

!!VRz598:Sz199748;                      [Counterstrike}]
!!SS58:D0/z598;


!!VRz731:Sz199750;                      [Hypnotize}]
!!SS60:D0/z731;

!!VRz779:Sz199759;                      [Summon Air Elemental}]
!!SS69:D0/z779;
**

**Water
!!VRz487:Sz199727;                      [Cure}]
!!SS37:D0/z487;                         [set cure description]

!!VRz126:Sz199706;                      [Ice Bolt}]
!!SS16:D0/z126;

!!VRz130:Sz199710;                      [Frost Ring}]
!!SS20:D0/z130;

!!VRz482:Sz199722;                      [Protection from Water}]
!!SS32:D0/z482;

!!VRz485:Sz199725;                      [Dispel}]
!!SS35:D0/z485;

!!VRz780:Sz199731;                      [Bless}]
!!SS41:D0/z780;

!!VRz781:Sz199735;                      [Weakness}]
!!SS45:D0/z781;

!!VRz782:Sz199738;                      [Prayer}]
!!SS48:D0/z782;

!!VRz783:Sz199739;                      [Mirth}]
!!SS49:D0/z783;

!!VRz771:Sz199751;                      [Forgetfulness}]
!!SS61:D0/z771;

!!VRz773:Sz199753;                      [Teleport}]
!!SS63:D0/z773;

!!VRz774:Sz199754;                      [Remove Obstacle}]
!!SS64:D0/z774;

!!VRz775:Sz199755;                      [Clone}]
!!SS65:D0/z775;

!!VRz778:Sz199758;                      [Summon Water Elemental}]
!!SS68:D0/z778;
**

**Earth
!!VRz120:Sz199700;                      [Quicksand}]
!!SS10:D0/z120;

!!VRz122:Sz199702;                      [Force Field}]
!!SS12:D0/z122;

!!VRz124:Sz199704;                      [Earthquake}]
!!SS14:D0/z124;

!!VRz128:Sz199708;                      [Implosion}]
!!SS18:D0/z128;

!!VRz133:Sz199713;                      [Meteor Shower}]
!!SS23:D0/z133;

!!VRz134:Sz199714;                      [Death Ripple}]
!!SS24:D0/z134;

!!VRz137:Sz199717;                      [Shield}]
!!SS27:D0/z137;

!!VRz483:Sz199723;                      [Protection from Earth}]
!!SS33:D0/z483;

!!VRz484:Sz199724;                      [Anti-Magic}]
!!SS34:D0/z484;

!!VRz488:Sz199728;                      [Resurrection}]
!!SS38:D0/z488;

!!VRz489:Sz199729;                      [Animate Dead}]
!!SS39:D0/z489;

!!VRz786:Sz199736;                      [Stone Skin}]
!!SS46:D0/z786;

!!VRz784:Sz199740;                      [Sorrow}]
!!SS50:D0/z784;

!!VRz785:Sz199744;                      [Slow}]
!!SS54:D0/z785;

!!VRz777:Sz199757;                      [Summon Earth Elemental}]
!!SS67:D0/z777;


****************************************************************************************************************************************************************
*Sets the Spell Description in the Hero Book and Combat*

!?FU(Magic_Arrow_Improved_Description);
!!VRz6|x2=0/x3=0/x4=0/x5=0:S^g^;        [Normal]
!!VRz6|x2=1/x3=1/x4=1/x5=1:S^g^;        [Basic]
!!VRz6|x2=2/x3=2/x4=2/x5=2:S^g^;        [Advanced]
!!VRz6|x2=3/x3=3/x4=3/x5=3:S^g^;        [Expert]
!!VRz6&x6=1:S^DodgerBlue^;              [Master]
!!VRz6&x6=2:S^r^;                       [Grandmaster]

!!SN|x2=0/x3=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN|x2=1/x3=1/x4=1/x5=1:T^AC_Spells.Spell_Basic^/?z5;
!!SN|x2=2/x3=2/x4=2/x5=2:T^AC_Spells.Spell_Advanced^/?z5;
!!SN|x2=3/x3=3/x4=3/x5=3:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=1:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=2:T^AC_Spells.Spell_Grandmaster^/?z5;

!!SN:W^Magic_Arrow_Hero%X1^/?y15;
!!VRy15:*10;

!!SN:T^AC_Spells.Magic_Arrow_0^/?z125;
!!SN&x6>0:T^AC_Spells.Magic_Arrow_1^/?z125;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell15^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;

!!VRz125&x9=1:+z1;!!SN:Iz125/?z125;
!!SS15|x2=0/x3=0/x4=0/x5=0:D0/z125;
!!SS15|x2=1/x3=1/x4=1/x5=1:D1/z125;
!!SS15|x2=2/x3=2/x4=2/x5=2:D2/z125;
!!SS15|x2=3/x3=3/x4=3/x5=3:D3/z125;


***************************************
!?FU(Fire_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


**Fire
!!FU(ApplyRemoveSpellScaling):Px1/43/0/?y1/?y43; [Bloodlust]
!!FU(ApplyRemoveSpellScaling):Px1/42/0/?y1/?y42; [Curse]
!!FU(ApplyRemoveSpellScaling):Px1/29/0/?y1/?y29; [Fire Shield]
!!FU(ApplyRemoveSpellScaling):Px1/66/0/?y1/?y66; [Fire Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/31/0/?y1/?y31; [Protection from Fire]
!!FU(ApplyRemoveSpellScaling):Px1/52/0/?y1/?y52; [Misfortune]
!!FU(ApplyRemoveSpellScaling):Px1/55/0/?y1/?y55; [Slayer]


!!VRy6&x6=0:S4; !!VRy6&x6=1:S4; !!VRy6&x6=2:S6; !!VRy6&x6=3:S8;
!!VRy7:Sx2 :2 +10;
!!SN&x4=1:T^AC_Spells.Land_Mine_0^/?z121;
!!SN&x4=0:T^AC_Spells.Land_Mine_1^/?z121;
!!SN:W^Hero%X1_Land Mine_Upgrade^/?y78;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell11^/?y79; !!VRy78&x9=1:Sy78*50;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Casts^/?z1/^damage^/y78/^casts^/y79;
!!VRz121&x9=1:+z1; !!SN:Iz121/?z121; !!SS11:Dx6/z121;


!!SN&x4=1:T^AC_Spells.Fire_Wall_0^/?z123;
!!SN&x4=0:T^AC_Spells.Fire_Wall_1^/?z123;
!!SN:W^Hero%X1_Fire Wall_Upgrade^/?y80;
!!SN:W^SpellTrainerHero%X1_Spell13^/?y81; !!VRy80&x9=1:Sy80*35;
!!SN&x9=1:T^AC_Spells.Trainer_Damage_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz123&x9=1:+z1; !!SN:Iz123/?z123; !!SS13:Dx6/z123;


!!VRy8&x4=1:S27;
!!VRy8&x5=1:S40;
!!SN&x4=1:T^AC_Spells.Fire_Ball_0^/?z131;
!!SN&x4=0:T^AC_Spells.Fire_Ball_1^/?z131;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell21^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz131&x9=1:+z1; !!SN:Iz131/?z131; !!SS21:Dx6/z131;


!!SN&x4=1:T^AC_Spells.Inferno_0^/?z132;
!!SN&x4=0:T^AC_Spells.Inferno_1^/?z132;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell22^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz132&x9=1:+z1; !!SN:Iz132/?z132; !!SS22:Dx6/z132;


!!SN&x4=1:T^AC_Spells.Armageddon_0^/?z136;
!!SN&x4=0:T^AC_Spells.Armageddon_1^/?z136;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell26^/?y95; !!VRy95&x9=1:Sy95*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y95;
!!VRz136&x9=1:+z1; !!SN:Iz136/?z136; !!SS26:Dx6/z136;


!!VRy92:Sx2 :2 +10;                     [+10% + 1% per 2SP]
!!VRy92&x3>0:+10;                       [+10% with GM Fire]
!!VRy92&y92>=50/x3=0:S50;               [Cap at 50%]
!!VRy92&y92>=65/x3=1:S65;               [65% with GM Fire]
!!FU(Fire_Shield_Calculation):Px1/0/0/0/0/1/0/?y29/0;
!!SN&x4=1:T^AC_Spells.Fire_Shield_0^/?z139;
!!SN&x4=0:T^AC_Spells.Fire_Shield_1^/?z139;
!!SN:Iz139/?z139; !!SS29:Dx6/z139;


!!VRy16:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy16&x3>0:+20;                       [+20% chance with GM Fire]
!!VRy16&y16>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy31&x9=1:+y71; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Fire_Protection_0^/?z481;
!!SN&x6=3/x4=0:T^AC_Spells.Fire_Protection_1^/?z481;
!!SN&x6<3/x4=0:T^AC_Spells.Fire_Protection_2^/?z481;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz481&x9=1:+z1; !!SN:Iz481/?z481; !!SS31:Dx6/z481;


!!SN&x6=3/x4=1:T^AC_Spells.Sacrifice_0^/?z258;
!!SN|x6<3/x4=0:T^AC_Spells.Sacrifice_1^/?z258;
!!SN:Iz258/?z258; !!SS40:Dx6/z258;


!!SN&x9=1:W^Hero%X1_Curse_Upgrade^/?y72; !!VRy42&x9=1:+y72; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Curse_0^/?z257;
!!SN&x6=3/x4=0:T^AC_Spells.Curse_1^/?z257;
!!SN&x6<3/x4=0:T^AC_Spells.Curse_2^/?z257;
!!SN:W^SpellTrainerHero%X1_Spell42^/?y73;
!!SN&x9=1:T^AC_Spells.Trainer_MinDmg_Casts^/?z1/^damage^/y72/^casts^/y73;
!!VRz257&x9=1:+z1; !!SN:Iz257/?z257; !!SS42:Dx6/z257;



!!FU(Count_Set_Pieces_2):Px1/?y90;      [Count Set Pieces function X2]
!!VRy43&y90>=4:+4;
!!SN&x9=1:W^Hero%X1_Bloodlust_Upgrade^/?y74; !!VRy43&x9=1:+y74; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Bloodlust_0^/?z256;
!!SN&x6=3/x4=0:T^AC_Spells.Bloodlust_1^/?z256;
!!SN&x6<3/x4=0:T^AC_Spells.Bloodlust_2^/?z256;
!!SN:W^SpellTrainerHero%X1_Spell43^/?y75;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y74/^casts^/y75;
!!VRz256&x9=1:+z1; !!SN:Iz256/?z256; !!SS43:Dx6/z256;


!!VRy78:Sx2 :2 +20;                     [Chance is 20% + 5% per 10SP]
!!VRy78&x3>0:+5;                        [+5% with GM Fire]
!!VRy78&y78>=50/x3=0:S50;
!!VRy78&y78>=60/x3=1:S60;
!!SN&x9=1:W^Hero%X1_Misfortune_Upgrade^/?y76; !!VRy52&x9=1:+y76; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Misfortune_0^/?z255;
!!SN&x6=3/x4=0:T^AC_Spells.Misfortune_1^/?z255;
!!SN&x6<3/x4=0:T^AC_Spells.Misfortune_2^/?z255;
!!SN:W^SpellTrainerHero%X1_Spell52^/?y77;
!!SN&x9=1:T^AC_Spells.Trainer_Luck1_Casts^/?z1/^damage^/y76/^casts^/y77;
!!VRz255&x9=1:+z1; !!SN:Iz255/?z255; !!SS52:Dx6/z255;


!!VRy79:Sx2 :2 +20;                     [Chance for Crushing Blow is SP/2 + 20%]
!!VRy79&x3>0:+10;                       [+10% chance with GM Fire]
!!VRy79&y79>=100:S100;
!!SN&x9=1:W^Hero%X1_Slayer_Upgrade^/?y30; !!VRy55&x9=1:+y30; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Slayer_0^/?z770;
!!SN&x6=3/x4=0:T^AC_Spells.Slayer_1^/?z770;
!!SN&x6=2/x4=0:T^AC_Spells.Slayer_2^/?z770;
!!SN&x6<2/x4=0:T^AC_Spells.Slayer_3^/?z770;
!!SN:W^SpellTrainerHero%X1_Spell52^/?y31;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y30/^casts^/y31;
!!VRz770&x9=1:+z1; !!SN:Iz770/?z770; !!SS55:Dx6/z770;


!!SS56:Ex6/?y7;
!!VRy85:Sx2 :5 +20;                     [Chance for Aviod is SP/2 + 20%]
!!VRy85&x3>0:+10;                       [+10% chance with GM Fire]
!!VRy85&y85>=100:S100;
!!SN&x9=1:W^Hero%X1_Frenzy_Upgrade^/?y32; !!VRy32:*5; !!VRy7&x9=1:+y32; Add Spell Trainer Effect
!!SN&x4=1:T^AC_Spells.Frenzy_0^/?z254/^damage^/y85;
!!SN&x4=0:T^AC_Spells.Frenzy_1^/?z254;
!!SN:W^SpellTrainerHero%X1_Spell56^/?y33;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y32/^casts^/y33;
!!VRz254&x9=1:+z1; !!SN:Iz254/?z254; !!SS56:Dx6/z254;


!!SN&x6>0/x4=1:T^AC_Spells.Berserk_0^/?z730;
!!SN&x6>2/x4=0:T^AC_Spells.Berserk_1^/?z730;
!!SN&x6<3/x4=0:T^AC_Spells.Berserk_2^/?z730;
!!SN:Iz730/?z730; !!SS59:Dx6/z730;


!!VRy8:S3 -x6 *25;
!!SN&x4=1:T^AC_Spells.Blind_0^/?z772;
!!SN&x6=3/x4=0:T^AC_Spells.Blind_1^/?z772;
!!SN&x6<3/x4=0:T^AC_Spells.Blind_2^/?z772;
!!SN:Iz772/?z772; !!SS62:Dx6/z772;


!!VRy64:Sx2 +30;
!!VRy64&y64>=100:S100;                  [Cap at 100]
!!SN&x4=1:T^AC_Spells.Remove_0^/?z774;
!!SN&x4=0:T^AC_Spells.Remove_1^/?z774;
!!SN:Iz774/?z774; !!SS64:Dx6/z774;


!!VRy66:Sx2:2+10;
!!VRy66&x3>0:+10;                       [with GM Fire]
!!SN:T^AC_Spells.Fire^/?z7;
!!SN&x3>0:T^AC_Spells.Energy^/?z7;
!!FU(Calc_Summoning_Power):Px1/66/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*100;
!!SN&x6>0/x4=1:T^AC_Spells.Fire_Element_0^/?z776;
!!SN&x4=0:T^AC_Spells.Fire_Element_1^/?z776;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y34/^casts^/y35;
!!VRz776&x9=1:+z1; !!SN:Iz776/?z776; !!SS66:Dx6/z776;


****************************************
!?FU(Air_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


!!FU(ApplyRemoveSpellScaling):Px1/44/0/?y1/?y44; [Precision]
!!FU(ApplyRemoveSpellScaling):Px1/28/0/?y1/?y28; [Air Shield]
!!FU(ApplyRemoveSpellScaling):Px1/51/0/?y1/?y51; [Fortune]
!!FU(ApplyRemoveSpellScaling):Px1/53/0/?y1/?y53; [Haste]
!!FU(ApplyRemoveSpellScaling):Px1/47/0/?y1/?y47; [Disrupting Ray]
!!FU(ApplyRemoveSpellScaling):Px1/69/0/?y1/?y69; [Air Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/30/0/?y1/?y30; [Protection from Air]
!!FU(ApplyRemoveSpellScaling):Px1/58/0/?y1/?y58; [Counterstrike]
!!FU(ApplyRemoveSpellScaling):Px1/36/0/?y1/?y36; [Magic Mirror]


!!SN&x4=1:T^AC_Spells.Lightning_0^/?z127;
!!SN&x4=0:T^AC_Spells.Lightning_1^/?z127;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell17^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz127&x9=1:+z1; !!SN:Iz127/?z127; !!SS17:Dx6/z127;


!!VRy61&x6=0/x4=0/x5=0:S4;              [No Rank]
!!VRy61&x6=1/x4=0/x5=0:S4;              [Basic]
!!VRy61&x6=2/x4=0/x5=0:S5;              [Advanced]
!!VRy61&x6=3/x4=0/x5=0:S5;              [Expert]
!!VRy61&x6=3/x4=1/x5=0:S5;              [Master]
!!VRy61&x6=3/x4=1/x5=1:S5;              [Grandmaster]

!!SN&x4=1:T^AC_Spells.Chain_0^/?z129;
!!SN&x4=0:T^AC_Spells.Chain_1^/?z129;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell19^/?y95; !!VRy95&x9=1:Sy95*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y95;
!!VRz129&x9=1:+z1; !!SN:Iz129/?z129; !!SS19:Dx6/z129;


!!SN&x4=1:T^AC_Spells.Destroy_0^/?z135;
!!SN&x4=0:T^AC_Spells.Destroy_1^/?z135;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell25^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz135&x9=1:+z1; !!SN:Iz135/?z135; !!SS25:Dx6/z135;


!!VRy5:Sx2:10 +5;                       [+SP/10% +5% chance to dodge]
!!VRy5&x3>0:+3;                         [+3% chance with GM Air]
!!SN&x9=1:W^Hero%X1_Air Shield_Upgrade^/?y80; !!VRy28&x9=1:+y80; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Air_Shield_0^/?z138;
!!SN&x6=3/x4=0:T^AC_Spells.Air_Shield_1^/?z138;
!!SN&x6<3/x4=0:T^AC_Spells.Air_Shield_2^/?z138;
!!SN:W^SpellTrainerHero%X1_Spell28^/?y81;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz138&x9=1:+z1; !!SN:Iz138/?z138; !!SS28:Dx6/z138;


!!VRy11:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy11&x3>0:+20;                       [+20% chance with GM Air]
!!VRy11&y11>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy30&x9=1:+y71; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Air_Protect_0^/?z140;
!!SN&x6=3/x4=0:T^AC_Spells.Air_Protect_1^/?z140;
!!SN&x6<3/x4=0:T^AC_Spells.Air_Protect_2^/?z140;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz140&x9=1:+z1; !!SN:Iz140/?z140; !!SS30:Dx6/z140;


!!SN&x4=1:T^AC_Spells.Magic_Mirror_0^/?z119;
!!SN&x4=0:T^AC_Spells.Magic_Mirror_1^/?z119;
!!SN:Iz119/?z119; !!SS36:Dx6/z119;


!!VRy6:Sx2:5+20;                        [AOE Damage is 20%+1% per 5 SP]
!!SN&x9=1:W^Hero%X1_Precision_Upgrade^/?y82; !!VRy44&x9=1:+y82; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Precision_0^/?z253/^damage^/y6;
!!SN&x6=3/x4=0:T^AC_Spells.Precision_1^/?z253;
!!SN&x6<3/x4=0:T^AC_Spells.Precision_2^/?z253;
!!SN:W^SpellTrainerHero%X1_Spell44^/?y83;
!!SN&x9=1:T^AC_Spells.Trainer_Attack_Casts^/?z1/^damage^/y82/^casts^/y83;
!!VRz253&x9=1:+z1; !!SN:Iz253/?z253; !!SS44:Dx6/z253;


!!VRy60&x4=1/x5=0:S1;                   [+1 chance with Master]
!!VRy60&x4=1/x5=1:S2;                   [+2 chance with GM]
!!SN&x9=1:W^Hero%X1_Disrupting Ray_Upgrade^/?y84; !!VRy47&x9=1:+y84; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Disrupting_0^/?z252;
!!SN&x4=0:T^AC_Spells.Disrupting_1^/?z252;
!!SN:W^SpellTrainerHero%X1_Spell47^/?y85;
!!SN&x9=1:T^AC_Spells.Trainer_reduce_Casts^/?z1/^damage^/y84/^casts^/y85;
!!VRz252&x9=1:+z1; !!SN:Iz252/?z252; !!SS47:Dx6/z252;


!!VRy77:Sx2:2;
!!VRy77:+20;                            [Chance is 20% + 1% per 2SP]
!!VRy77&x3>0:+10;                       [+10% with GM Air]
!!VRy77&y77>=100:S100;
!!SN&x9=1:W^Hero%X1_Fortune_Upgrade^/?y88; !!VRy51&x9=1:+y88; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Fortune_0^/?z251;
!!SN&x6=3/x4=0:T^AC_Spells.Fortune_1^/?z251;
!!SN&x6<3/x4=0:T^AC_Spells.Fortune_2^/?z251;
!!SN:W^SpellTrainerHero%X1_Spell51^/?y89;
!!SN&x9=1:T^AC_Spells.Trainer_Luck2_Casts^/?z1/^damage^/y88/^casts^/y89;
!!VRz251&x9=1:+z1; !!SN:Iz251/?z251; !!SS51:Dx6/z251;


!!SN&x9=1:W^Hero%X1_Haste_Upgrade^/?y86; !!VRy53&x9=1:+y86; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Haste_0^/?z250;
!!SN&x6=3/x4=0:T^AC_Spells.Haste_1^/?z250;
!!SN&x6<3/x4=0:T^AC_Spells.Haste_2^/?z250;
!!SN:W^SpellTrainerHero%X1_Spell53^/?y87;
!!SN&x9=1:T^AC_Spells.Trainer_Haste_Casts^/?z1/^damage^/y86/^casts^/y87;
!!VRz250&x9=1:+z1; !!SN:Iz250/?z250; !!SS53:Dx6/z250;


!!VRy49:Sx2:3+10;                       [Chance is 10% + 1% per 3SP]
!!VRy49&x3>0:+10;                       [+10% with GM Air]
!!SN&x6>0/x4=1:T^AC_Spells.Counterstrike_0^/?z598/^damage^/y49;
!!SN&x6=3/x4=0:T^AC_Spells.Counterstrike_1^/?z598;
!!SN&x6<3/x4=0:T^AC_Spells.Counterstrike_2^/?z598;
!!SN:Iz598/?z598; !!SS58:Dx6/z598;


!!VRy60:Sx2 +20;                        [20% base + SP%]
!!VRy60&x3>0:+20;                       [+20% chance with GM Air]
!!VRy60&y60>=100:S100;
!!SN&x4=1:T^AC_Spells.Hypnotize_0^/?z731;
!!SN&x4=0:T^AC_Spells.Hypnotize_1^/?z731;
!!SN:Iz731/?z731; !!SS60:Dx6/z731;


!!VRy69:Sx2:2+10;
!!VRy69&x3>0:+10;                       [with GM Air]
!!SN:T^AC_Spells.Air^/?z7;
!!SN&x3>0:T^AC_Spells.Storm^/?z7;
!!FU(Calc_Summoning_Power):Px1/69/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*100;
!!SN&x4=1:T^AC_Spells.Summon_Air_0^/?z779;
!!SN&x4=0:T^AC_Spells.Summon_Air_1^/?z779;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y34/^casts^/y35;
!!VRz779&x9=1:+z1; !!SN:Iz779/?z779; !!SS69:Dx6/z779;


****************************************
!?FU(Water_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


**Water
!!FU(ApplyRemoveSpellScaling):Px1/41/0/?y1/?y41; [Bless]
!!FU(ApplyRemoveSpellScaling):Px1/45/0/?y1/?y45; [Weakness]
!!FU(ApplyRemoveSpellScaling):Px1/68/0/?y1/?y68; [Water Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/32/0/?y1/?y32; [Protection from Water]
!!FU(ApplyRemoveSpellScaling):Px1/48/0/?y1/?y48; [Prayer]
!!FU(ApplyRemoveSpellScaling):Px1/49/0/?y1/?y49; [Mirth]


!!SS37:P?y7;
!!SS37:Ex6/?y8;
!!VRy37:Sx2 *y7 +y8;
!!VRy9:Sy37;
!!VRy37&x3>0:+100;                      [+100HP healed with GM Water]
!!HEx1:X?y7/?y8/d/d/d/d/d;              [Check Hero Speciality]
!!VRy37&y7=3/y8=37:*2;                  [Double Cure heal for specialists @alf]
!!VRz-2:S^doubles^;
!!VRz-2&y7=3/y8=37:S^{~Gold}triples{~}^;
!!SN&x9=1:W^Hero%X1_Cure_Upgrade^/?y80; !!VRy80:*5; !!VRy37&x9=1:+y80; Add Spell Trainer Effect !!VRy9&x9=1:+y80;
!!SN&x6=3/x4=1:T^AC_Spells.Cure_0^/?z487;
!!SN&x6=3/x4=0:T^AC_Spells.Cure_1^/?z487;
!!SN&x6<3/x4=0:T^AC_Spells.Cure_2^/?z487;
!!SN:W^SpellTrainerHero%X1_Spell37^/?y81;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz487&x9=1:+z1; !!SN:Iz487/?z487; !!SS37:Dx6/z487;      [set cure description]


!!VRy20:S1;
!!VRy20&x3>0:S2;
!!SN&x6>0/x4=1:T^AC_Spells.Ice_Bolt_0^/?z126;
!!SN&x4=0:T^AC_Spells.Ice_Bolt_1^/?z126;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell16^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz126&x9=1:+z1; !!SN:Iz126/?z126; !!SS16:Dx6/z126;


!!VRy20:S1;
!!VRy20&x3>0:S2;
!!SN&x6>0/x4=1:T^AC_Spells.Frost_Ring_0^/?z130;
!!SN&x4=0:T^AC_Spells.Frost_Ring_1^/?z130;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell20^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz130&x9=1:+z1; !!SN:Iz130/?z130; !!SS20:Dx6/z130;


!!VRy14:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy14&x3>0:+20;                       [+20% chance with GM Water]
!!VRy14&y14>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy32&x9=1:+y71; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Water_Protection_0^/?z482;
!!SN&x6=3/x4=0:T^AC_Spells.Water_Protection_1^/?z482;
!!SN&x6<3/x4=0:T^AC_Spells.Water_Protection_2^/?z482;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz482&x9=1:+z1; !!SN:Iz482/?z482; !!SS32:Dx6/z482;


!!SN&x6>0/x4=1:T^AC_Spells.Disple_0^/?z485;
!!SN&x6=3/x4=0:T^AC_Spells.Disple_1^/?z485;
!!SN&x6=2/x4=0:T^AC_Spells.Disple_2^/?z485;
!!SN&x6<2/x4=0:T^AC_Spells.Disple_3^/?z485;
!!SN:Iz485/?z485; !!SS35:Dx6/z485;

!!HEx1:I?y98/1;              [Get current Hero Spell Points]
!!SN&x9=1:W^Hero%X1_Bless_Upgrade^/?y82; !!VRy41&x9=1:+y82; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Bless_0^/?z780/^damage^/y98;
!!SN&x6=3/x4=0:T^AC_Spells.Bless_1^/?z780;
!!SN&x6<3/x4=0:T^AC_Spells.Bless_2^/?z780;
!!SN:W^SpellTrainerHero%X1_Spell41^/?y83;
!!SN&x9=1:T^AC_Spells.Trainer_MaxDmg_Casts^/?z1/^damage^/y82/^casts^/y83;
!!VRz780&x9=1:+z1; !!SN:Iz780/?z780; !!SS41:Dx6/z780;


!!SN&x9=1:W^Hero%X1_Weakness_Upgrade^/?y84; !!VRy45&x9=1:+y84; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Weakness_0^/?z781;
!!SN&x6=3/x4=0:T^AC_Spells.Weakness_1^/?z781;
!!SN&x6<3/x4=0:T^AC_Spells.Weakness_2^/?z781;
!!SN:W^SpellTrainerHero%X1_Spell45^/?y85;
!!SN&x9=1:T^AC_Spells.Trainer_Attack2_Casts^/?z1/^damage^/y84/^casts^/y85;
!!VRz781&x9=1:+z1; !!SN:Iz781/?z781; !!SS45:Dx6/z781;


!!FU(Count_Set_Pieces):Px1/0/0/0/0/0/0/0/0/0/0/0/0/?y90; [Count Set Pieces function X14]
!!VRy48&y90>=5:+2;
!!VRy11:Sx2*2;                          [additional holy damage]
!!VRy11::5;                             [2% more damage per 5SP]
!!VRy11&x3>0:+5;                        [+5% more damage with GM Water]
!!VRy11&y11>=25:S25;                    [Limit to 25% Bonus damage]
!!SN&x9=1:W^Hero%X1_Prayer_Upgrade^/?y86; !!VRy48&x9=1:+y86; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Prayer_0^/?z782;
!!SN&x6=3/x4=0:T^AC_Spells.Prayer_1^/?z782;
!!SN&x6<3/x4=0:T^AC_Spells.Prayer_2^/?z782;
!!SN:W^SpellTrainerHero%X1_Spell48^/?y87;
!!SN&x9=1:T^AC_Spells.Trainer_Prayer_Casts^/?z1/^damage^/y86/^casts^/y87;
!!VRz782&x9=1:+z1; !!SN:Iz782/?z782; !!SS48:Dx6/z782;


!!VRy12:Sx2 :2;
!!VRy12&x3>0:+10;                       [With GM Water]
!!SN&x9=1:W^Hero%X1_Mirth_Upgrade^/?y88; !!VRy49&x9=1:+y88; [Add Spell Trainer Effect]
!!SN&x6>0/x4=1:T^AC_Spells.Mirth_0^/?z783;
!!SN&x6=3/x4=0:T^AC_Spells.Mirth_1^/?z783;
!!SN&x6<3/x4=0:T^AC_Spells.Mirth_2^/?z783;
!!SN:W^SpellTrainerHero%X1_Spell49^/?y89;
!!SN&x9=1:T^AC_Spells.Trainer_Morale_Casts^/?z1/^damage^/y88/^casts^/y89;
!!VRz783&x9=1:+z1; !!SN:Iz783/?z783; !!SS49:Dx6/z783;


!!VRy61:Sx2:3;
!!VRy61:+10;                            [chance is 10% plus 1% per 3 Spellpower]
!!VRy61&x3>0:+5;                        [With GM Water]
!!VRy61&y61>=100:S100;
!!SN&x6>0/x4=1:T^AC_Spells.Forgetfulness_0^/?z771;
!!SN&x6=3/x4=0:T^AC_Spells.Forgetfulness_1^/?z771;
!!SN&x6=2/x4=0:T^AC_Spells.Forgetfulness_2^/?z771;
!!SN&x6<2/x4=0:T^AC_Spells.Forgetfulness_3^/?z771;
!!SN:Iz771/?z771; !!SS61:Dx6/z771;


!!SN&x6>2/x4=1:T^AC_Spells.Teleport_0^/?z773;
!!SN&x6=3/x4=0:T^AC_Spells.Teleport_1^/?z773;
!!SN&x6=2/x4=0:T^AC_Spells.Teleport_2^/?z773;
!!SN&x6<2/x4=0:T^AC_Spells.Teleport_3^/?z773;
!!SN:Iz773/?z773; !!SS63:Dx6/z773;


!!VRy6&x6=0:S5; !!VRy6&x6=1:S5; !!VRy6&x6=2:S6; !!VRy6&x6=3:S7;
!!VRy65:S25;
!!VRy65&x3>0:+10;                       [with GM Water]
!!SN&x6>0/x4=1:T^AC_Spells.Clone_0^/?z775;
!!SN&x4=0:T^AC_Spells.Clone_1^/?z775;
!!SN:Iz775/?z775; !!SS65:Dx6/z775;


!!VRy68:Sx2:2+10;
!!VRy68&x3>0:+10;                       [with GM Water]
!!VRz7:S^Water^; !!VRz7&x3>0:S^Ice^;
!!SN:T^AC_Spells.Water^/?z7;
!!SN&x3>0:T^AC_Spells.Ice^/?z7;
!!FU(Calc_Summoning_Power):Px1/68/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*100;
!!SN&x6>0/x4=1:T^AC_Spells.Summon_Water_0^/?z778;
!!SN&x4=0:T^AC_Spells.Summon_Water_1^/?z778;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y34/^casts^/y35;
!!VRz778&x9=1:+z1; !!SN:Iz778/?z778; !!SS68:Dx6/z778;



****************************************
!?FU(Earth_Spells_Improved_Description);
!!VRz6&x6=0/x4=0/x5=0:S^g^;             [Normal]
!!VRz6&x6=1/x4=0/x5=0:S^g^;             [Basic]
!!VRz6&x6=2/x4=0/x5=0:S^g^;             [Advanced]
!!VRz6&x6=3/x4=0/x5=0:S^g^;             [Expert]
!!VRz6&x6=3/x4=1/x5=0:S^DodgerBlue^;    [Master]
!!VRz6&x6=3/x4=1/x5=1:S^r^;             [Grandmaster]

!!SN&x6=0/x4=0/x5=0:T^AC_Spells.Spell_Normal^/?z5;
!!SN&x6=1/x4=0/x5=0:T^AC_Spells.Spell_Basic^/?z5;
!!SN&x6=2/x4=0/x5=0:T^AC_Spells.Spell_Advanced^/?z5;
!!SN&x6=3/x4=0/x5=0:T^AC_Spells.Spell_Expert^/?z5;
!!SN&x6=3/x4=1/x5=0:T^AC_Spells.Spell_Master^/?z5;
!!SN&x6=3/x4=1/x5=1:T^AC_Spells.Spell_Grandmaster^/?z5;

!!if&x6=0/x4=0/x5=0;                   [Means no rank]
!!VRz-6:S^^;                            [z-6 is female ending]
!!VRz-7:S^^;                            [z-7 is male ending]
!!VRz-8:S^^;                            [z-8 is plural ending]
!!VRz-9:S^^;                            [z-9 is neutral ending]
!!en;

!!if&x6=1/x4=0/x5=0;                   [Means Basic]
!!SN:T^AC_Spells.Basic_female^/?z-6;
!!SN:T^AC_Spells.Basic_male^/?z-7;
!!SN:T^AC_Spells.Basic_plural^/?z-8;
!!SN:T^AC_Spells.Basic_neutral^/?z-9;
!!en;

!!if&x6=2/x4=0/x5=0;                   [Means Advanced]
!!SN:T^AC_Spells.Advanced_female^/?z-6;
!!SN:T^AC_Spells.Advanced_male^/?z-7;
!!SN:T^AC_Spells.Advanced_plural^/?z-8;
!!SN:T^AC_Spells.Advanced_neutral^/?z-9;
!!en;

!!if&x6=3/x4=0/x5=0;                   [Means Expert]
!!SN:T^AC_Spells.Expert_female^/?z-6;
!!SN:T^AC_Spells.Expert_male^/?z-7;
!!SN:T^AC_Spells.Expert_plural^/?z-8;
!!SN:T^AC_Spells.Expert_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=0;                   [Means Master]
!!SN:T^AC_Spells.Master_female^/?z-6;
!!SN:T^AC_Spells.Master_male^/?z-7;
!!SN:T^AC_Spells.Master_plural^/?z-8;
!!SN:T^AC_Spells.Master_neutral^/?z-9;
!!en;

!!if&x6=3/x4=1/x5=1;                   [Means Grandmaster]
!!SN:T^AC_Spells.Grandmaster_female^/?z-6;
!!SN:T^AC_Spells.Grandmaster_male^/?z-7;
!!SN:T^AC_Spells.Grandmaster_plural^/?z-8;
!!SN:T^AC_Spells.Grandmaster_neutral^/?z-9;
!!en;


**Earth
!!FU(ApplyRemoveSpellScaling):Px1/27/0/?y1/?y27; [Shield]
!!FU(ApplyRemoveSpellScaling):Px1/46/0/?y1/?y46; [Stone Skin]
!!FU(ApplyRemoveSpellScaling):Px1/54/0/?y1/?y54; [Slow]
!!FU(ApplyRemoveSpellScaling):Px1/67/0/?y1/?y67; [Earth Elemental]
!!FU(ApplyRemoveSpellScaling):Px1/33/0/?y1/?y33; [Protection from Earth]
!!FU(ApplyRemoveSpellScaling):Px1/50/0/?y1/?y50; [Sorrow]



!!VRy6&x6=0:S4; !!VRy6&x6=1:S4; !!VRy6&x6=2:S6; !!VRy6&x6=3:S8;
!!SN&x6>0/x4=1:T^AC_Spells.Quicksand_0^/?z120;
!!SN&x4=0:T^AC_Spells.Quicksand_1^/?z120;
!!SN:Iz120/?z120; !!SS10:Dx6/z120;


!!VRy11&x6<=1:S2; !!VRy11&x6>1:S3;
!!SN&x6>0/x4=1:T^AC_Spells.Force_Field_0^/?z122;
!!SN&x4=0:T^AC_Spells.Force_Field_1^/?z122;
!!SN:Iz122/?z122; !!SS12:Dx6/z122;


!!VRy7&x6=0:S2; !!VRy7&x6=1:S2; !!VRy7&x6=2:S3; !!VRy7&x6=3:S4;
!!VRy14:Sx2 *3 :10;                     [Chance is 15% +3% per 10SP]
!!VRy14:+15;
!!VRy14&y14>30:S30;
!!SN&x6>0/x4=1:T^AC_Spells.Earthquake_0^/?z124;
!!SN&x4=0:T^AC_Spells.Earthquake_1^/?z124;
!!SN:Iz124/?z124; !!SS14:Dx6/z124;


!!VRy8:S2;
!!VRy8&x3=1:S4;
!!SN&x6>0/x4=1:T^AC_Spells.Implosion_0^/?z128;
!!SN&x4=0:T^AC_Spells.Implosion_1^/?z128;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell18^/?y93; !!VRy93&x9=1:Sy93*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y93;
!!VRz128&x9=1:+z1; !!SN:Iz128/?z128; !!SS18:Dx6/z128;


!!VRy8:S2;
!!VRy8&x3=1:S4;
!!SN&x6>0/x4=1:T^AC_Spells.Meteor_0^/?z133;
!!SN&x4=0:T^AC_Spells.Meteor_1^/?z133;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell23^/?y94; !!VRy94&x9=1:Sy94*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y94;
!!VRz133&x9=1:+z1; !!SN:Iz133/?z133; !!SS23:Dx6/z133;


!!SN&x6>0/x4=1:T^AC_Spells.Death_Ripple_0^/?z134;
!!SN&x4=0:T^AC_Spells.Death_Ripple_1^/?z134;
!!SN&x9=1:W^SpellTrainerHero%X1_Spell24^/?y95; !!VRy95&x9=1:Sy95*x10;
!!SN&x9=1:T^AC_Spells.Trainer_Damage^/?z1/^damage^/y95;
!!VRz134&x9=1:+z1; !!SN:Iz134/?z134; !!SS24:Dx6/z134;


!!VRy71:Sx2 *10 +100;
!!VRy71&x3>0:Sx2 *15 +150;              [with GM Earth]
!!SN&x9=1:W^Hero%X1_Shield_Upgrade^/?y80; !!VRy27&x9=1:+y80; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Shield_0^/?z137;
!!SN&x6=3/x4=0:T^AC_Spells.Shield_1^/?z137;
!!SN&x6<3/x4=0:T^AC_Spells.Shield_2^/?z137;
!!SN:W^SpellTrainerHero%X1_Spell27^/?y81;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y80/^casts^/y81;
!!VRz137&x9=1:+z1; !!SN:Iz137/?z137; !!SS27:Dx6/z137;


!!VRy15:Sx2:2 +10;                      [+SP/2% +10% chance to shake off]
!!VRy15&x3>0:+20;                       [+20% chance with GM Earth]
!!VRy15&y15>=75:S75;                    [Cap at 75%]
!!SN&x9=1:W^Hero%X1_Protection_Upgrade^/?y71; !!VRy33&x9=1:+y71; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Earth_Protection_0^/?z483;
!!SN&x6=3/x4=0:T^AC_Spells.Earth_Protection_1^/?z483;
!!SN&x6<3/x4=0:T^AC_Spells.Earth_Protection_2^/?z483;
!!SN:W^SpellTrainerHero%X1_Spell30^/?y70;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y71/^casts^/y70;
!!VRz483&x9=1:+z1; !!SN:Iz483/?z483; !!SS33:Dx6/z483;


!!VRy9&x6=0:S2; !!VRy9&x6=1:S3; !!VRy9&x6=2:S4; !!VRy9&x6=3:S5;
!!SN&x4=1:T^AC_Spells.Anti_Magic_0^/?z484;
!!SN&x4=0:T^AC_Spells.Anti_Magic_1^/?z484;
!!SN:Iz484/?z484; !!SS34:Dx6/z484;


!!FU(Count_Set_Pieces):Px1/0/0/0/0/0/?y90;   [Check for Priest of Light Set]
!!SS38:P?y5;
!!SS38:Ex6/?y6;
!!VRy7:Sx2 *y5 +y6;
!!VRy7&y90>=5:*3:2;
!!SN&x9=1:W^Hero%X1_Resurrection_Upgrade^/?y82; !!VRy82&x9=1:*80; !!VRy7&x9=1:+y82; Add Spell Trainer Effect
!!SN&x6=3/x4=1:T^AC_Spells.Resurrection_0^/?z488;
!!SN&x6>1/x4=0:T^AC_Spells.Resurrection_1^/?z488;
!!SN&x6<2/x4=0:T^AC_Spells.Resurrection_2^/?z488;
!!SN:W^SpellTrainerHero%X1_Spell38^/?y83;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y82/^casts^/y83;
!!VRz488&x9=1:+z1; !!SN:Iz488/?z488; !!SS38:Dx6/z488;


!!FU(Count_Set_Pieces):Px1/0/0/0/0/0/0/?y90;  [Priest of the Dark Set Darzogs Armor]
!!VRy39:Sx2;
!!VRy80:S5;
!!VRy80&x3>0:S15;                       [with GM Earth]
!!SS39:P?y5;
!!SS39:Ex6/?y6;
!!VRy7:Sx2 *y5 +y6;
!!VRy7&y90>=5:*3:2;
!!SN&x9=1:W^Hero%X1_Animation_Upgrade^/?y84; !!VRy84&x9=1:*100; !!VRy7&x9=1:+y84; Add Spell Trainer Effect
!!SN&x4=1:T^AC_Spells.Animate_Dead_0^/?z489;
!!SN&x4=0:T^AC_Spells.Animate_Dead_1^/?z489;
!!SN:W^SpellTrainerHero%X1_Spell39^/?y85;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y84/^casts^/y85;
!!VRz489&x9=1:+z1; !!SN:Iz489/?z489; !!SS39:Dx6/z489;


!!SN&x9=1:W^Hero%X1_Stoneskin_Upgrade^/?y86; !!VRy46&x9=1:+y86; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Stone_Skin_0^/?z786;
!!SN&x6=3/x4=0:T^AC_Spells.Stone_Skin_1^/?z786;
!!SN&x6<3/x4=0:T^AC_Spells.Stone_Skin_2^/?z786;
!!SN:W^SpellTrainerHero%X1_Spell46^/?y87;
!!SN&x9=1:T^AC_Spells.Trainer_Defense_Casts^/?z1/^damage^/y86/^casts^/y87;
!!VRz786&x9=1:+z1; !!SN:Iz786/?z786; !!SS46:Dx6/z786;


!!SN&x9=1:W^Hero%X1_Sorrow_Upgrade^/?y88; !!VRy50&x9=1:+y88; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Sorrow_0^/?z784;
!!SN&x6=3/x4=0:T^AC_Spells.Sorrow_1^/?z784;
!!SN&x6<3/x4=0:T^AC_Spells.Sorrow_2^/?z784;
!!SN:W^SpellTrainerHero%X1_Spell50^/?y89;
!!SN&x9=1:T^AC_Spells.Trainer_Morale_Casts^/?z1/^damage^/y88/^casts^/y89;
!!VRz784&x9=1:+z1; !!SN:Iz784/?z784; !!SS50:Dx6/z784;


!!SN&x9=1:W^Hero%X1_Slow_Upgrade^/?y90; !!VRy54&x9=1:+y90; Add Spell Trainer Effect
!!SN&x6>0/x4=1:T^AC_Spells.Slow_0^/?z785;
!!SN&x6=3/x4=0:T^AC_Spells.Slow_1^/?z785;
!!SN&x6<3/x4=0:T^AC_Spells.Slow_2^/?z785;
!!SN:W^SpellTrainerHero%X1_Spell54^/?y91;
!!SN&x9=1:T^AC_Spells.Trainer_Reduction_Casts^/?z1/^damage^/y90/^casts^/y91;
!!VRz785&x9=1:+z1; !!SN:Iz785/?z785; !!SS54:Dx6/z785;


!!VRy67:Sx2:2+10;
!!VRy67&x3>0:+10;                       [with GM Earth]
!!SN:T^AC_Spells.Earth^/?z7;
!!SN&x3>0:T^AC_Spells.Magma^/?z7;
!!FU(Calc_Summoning_Power):Px1/67/?y10; [Pass Hero Number, Spell Number, Returns total Summoned HP]
!!SN&x9=1:W^Hero%X1_Summoning_Upgrade^/?y34; !!VRy34:*100;
!!SN&x4=1:T^AC_Spells.Summon_Earth_0^/?z777;
!!SN&x4=0:T^AC_Spells.Summon_Earth_1^/?z777;
!!SN:W^SpellTrainerHero%X1_Spell66^/?y35;
!!SN&x9=1:T^AC_Spells.Trainer_HP_Casts^/?z1/^damage^/y34/^casts^/y35;
!!VRz777&x9=1:+z1; !!SN:Iz777/?z777; !!SS67:Dx6/z777;


*end this shit

***********

!?BF&1000;

!!DO(AC_Function_69)/0/41/1:P1;         [When Battle Starts Set Number of Shield Blocks to 1 for every Stack]

!?FU(AC_Function_69);

!!SN:W^H3_Shield_0_Block_Stack_%X16^/x1;[Normal Damage]
!!SN:W^H3_Shield_1_Block_Stack_%X16^/x1;[Magic Damage]
!!SN:W^H3_Shield_2_Block_Stack_%X16^/x1;[Free]


!?FU(AC_Function_73);                   [Save Spell Points change of Spells at Map start]

!!SSx16:C0/?y1; Normal   !!SN:W^H3_Normal_Spell_%X16_Cost^/y1;
!!SSx16:C1/?y1; Basic    !!SN:W^H3_Basic_Spell_%X16_Cost^/y1;
!!SSx16:C2/?y1; Advanced !!SN:W^H3_Advanced_Spell_%X16_Cost^/y1;
!!SSx16:C3/?y1; Expert   !!SN:W^H3_Expert_Spell_%X16_Cost^/y1;

!!SSx16:E0/?y1; Normal   !!SN:W^H3_Normal_Spell_%X16_Effect^/y1;
!!SSx16:E1/?y1; Basic    !!SN:W^H3_Basic_Spell_%X16_Effect^/y1;
!!SSx16:E2/?y1; Advanced !!SN:W^H3_Advanced_Spell_%X16_Effect^/y1;
!!SSx16:E3/?y1; Expert   !!SN:W^H3_Expert_Spell_%X16_Effect^/y1;


!?FU(AC_Function_71);                   [Restore Spell Points change of Spells]

!!SN:W^H3_Normal_Spell_%X16_Cost^/?y1;    !!SSx16:C0/y1;
!!SN:W^H3_Basic_Spell_%X16_Cost^/?y1;     !!SSx16:C1/y1;
!!SN:W^H3_Advanced_Spell_%X16_Cost^/?y1;  !!SSx16:C2/y1;
!!SN:W^H3_Expert_Spell_%X16_Cost^/?y1;    !!SSx16:C3/y1;

!?FU(AC_Function_72);                   [Set increase Costs for Sorcery]
*x1 holds the increase cost (1-5)
!!SSx16:C0/dx1;                         [Normal]
!!SSx16:C1/dx1;                         [Basic]
!!SSx16:C2/dx1;                         [Advanced]
!!SSx16:C3/dx1;                         [Expert]


********************************************************************************
*[Scaling Magic]*
*a mod by Perry R and Alf with Cake*


!#UN:X?i/?j;
!#VRy1&i=36:S1;                         [Set 1 for S size]
!#VRy1&i=72:S2;                         [Set 2 for M size]
!#VRy1&i=108:S3;                        [Set 3 for L size]
!#VRy1&i=144:S4;                        [Set 4 for XL size]
!#VRy1&i>144:S5;                        [Set 5 for XXL size]
!#SN:W^Scaling_Magic_Map_Size^/y1;

!#SN:W^Scaling_Magic_Mod^/1;            [Scaling Magic Mod Active]

*------------------------------------------------------------------------------*
!?CM2&1000;                             [Show Spell level when right click on spell book]

!!FU:E;                                 [Disabled and moved to Spell Book]

!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]

!!if&v3=512/v4=19;                     [if right click and specialty icon are clicked]
!!HE-1:N?y99;                           [Get current hero #]

!!HEy99:S14/?y81 S15/?y82 S16/?y83 S17/?y84 Fd/d/?y86/d S25/?y87; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien und Sorcery(25)hat]
!!HEy99:S18/?y88 S7/?y89 S24/?y91 S8/?y92; [Checke current hero Scholar(18) and Wisdom[7] Intelligence[24] Mysticism [8]hat]

!!FU(Calc_Magic_Strength):Py99/?y86;

!!FU(ApplyRemoveSpellScaling):Py99/27/1/?y1/?y27; [Shield]
!!FU(ApplyRemoveSpellScaling):Py99/46/1/?y1/?y46; [Stone Skin]
!!FU(ApplyRemoveSpellScaling):Py99/54/1/?y1/?y54; [Slow]
!!FU(ApplyRemoveSpellScaling):Py99/67/1/?y1/?y67; [Earth Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/33/1/?y1/?y33; [Protection from Earth]
!!FU(ApplyRemoveSpellScaling):Py99/50/1/?y1/?y50; [Sorrow]
!!FU(ApplyRemoveSpellScaling):Py99/41/1/?y1/?y41; [Bless]
!!FU(ApplyRemoveSpellScaling):Py99/45/1/?y1/?y45; [Weakness]
!!FU(ApplyRemoveSpellScaling):Py99/68/1/?y1/?y68; [Water Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/32/1/?y1/?y32; [Protection from Water]
!!FU(ApplyRemoveSpellScaling):Py99/48/1/?y1/?y48; [Prayer]
!!FU(ApplyRemoveSpellScaling):Py99/49/1/?y1/?y49; [Mirth]
!!FU(ApplyRemoveSpellScaling):Py99/43/1/?y1/?y43; [Bloodlust]
!!FU(ApplyRemoveSpellScaling):Py99/42/1/?y1/?y42; [Curse]
!!FU(ApplyRemoveSpellScaling):Py99/29/1/?y1/?y29; [Fire Shield]
!!FU(ApplyRemoveSpellScaling):Py99/66/1/?y1/?y66; [Fire Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/31/1/?y1/?y31; [Protection from Fire]
!!FU(ApplyRemoveSpellScaling):Py99/52/1/?y1/?y52; [Misfortune]
!!FU(ApplyRemoveSpellScaling):Py99/55/1/?y1/?y55; [Slayer]
!!FU(ApplyRemoveSpellScaling):Py99/44/1/?y1/?y44; [Precision]
!!FU(ApplyRemoveSpellScaling):Py99/28/1/?y1/?y28; [Air Shield]
!!FU(ApplyRemoveSpellScaling):Py99/51/1/?y1/?y51; [Fortune]
!!FU(ApplyRemoveSpellScaling):Py99/53/1/?y1/?y53; [Haste]
!!FU(ApplyRemoveSpellScaling):Py99/47/1/?y1/?y47; [Disrupting Ray]
!!FU(ApplyRemoveSpellScaling):Py99/69/1/?y1/?y69; [Air Elemental]
!!FU(ApplyRemoveSpellScaling):Py99/30/1/?y1/?y30; [Protection from Air]
!!FU(ApplyRemoveSpellScaling):Py99/58/1/?y1/?y58; [Counterstrike]
!!FU(ApplyRemoveSpellScaling):Py99/36/1/?y1/?y36; [Magic Mirror]

!!IF:M^           Spell Upgrades List:

{~Red}Magic Strength:%Y86{~}

{~Green}Earth{~}:
{Shield} Multiplier:*0.%Y27
{Stone Skin} Defense:+%Y46
{Slow} Multiplier:*0.%Y54
{Sorrow} Morale:-%Y50
{Summon Earth} Bonus:*%Y69
{Protec. Earth} Multiplier:*0.%Y33

{~Blue}Water{~}:
{Bless} Max. Damage:+%Y41
{Weakness} Attack:%Y45
{Prayer} Stats:+%Y48
{Mirth} Morale:+%Y49
{Summon Water} Bonus:*%Y68
{Protec. Water} Multipl.:*0.%Y32

{~Red}Fire{~}:
{Bloodlust} Attack:+%Y43
{Curse} Min. Damage:-%Y42
{Fire Shield} Reflected:%Y29%
{Misfortune} Luck:-%Y52
{Slayer} Attack:+%Y55
{Summon Fire} Bonus:*%Y66
{Protec. Fire} Multiplier:*0.%Y31

{~White}Air{~}:
{Haste} Speed:+%Y53
{Disrupting Ray} Defense:-%Y47
{Precision} Attack:+%Y44
{Fortune} Luck:+%Y51
{Air Shield} Multiplier:*0.%Y28
{Magic Mirror} Reflect:%Y36%
{Counterstrike} Retaliations:%Y58
{Summon Air} Bonus:*%Y67
{Protec. Air} Multiplier:*0.%Y30
^;

*!SN:T^AC_Spells.Spell Upgrades List^/?z2;
*!IF:M^%Z2^;

!!CM:R0;                                [disable default reaction]
!!en;


*------------------------------------------------------------------------------*
!?PI;
!!SN:W^Specialists_SP_Damage_spell_bonus^/125; [in percents]

!?BG0&1000;                             [Trigger Buff/Debuff Spells]

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;

!!BG:A?y1;                              [Aktion in y1 must be Hero Cast]
!!FU&y1<>1:E;

!!BG:Q?y1;                              [Check Side]
!!BA:Hy1/?y99;                          [Check Hero Number]
!!FU&y99=-2:E;

!!HEy99:S14/?y81 S15/?y82 S16/?y83 S17/?y84 Fd/d/?y86/d S25/?y87; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien und Sorcery(25)hat]
!!HEy99:S18/?y88 S7/?y89 S24/?y91 S8/?y92; [Checke current hero Scholar(18) and Wisdom[7] Intelligence[24] Mysticism [8]hat]

!!BG:S?y4;                              [Spell Number]
!!FU|y4<10/y4>69:E;
!!SN:W^Scaling_Magic_Spell_Number_^/y4; [Save Spell Number]

*-----------------------*  Mystic and Intelligence Specialist can increase Spell Power for additional Spell Points
!!HEy99:X?y11/?y12/d/d/d/d/d;
!!if&y11=0;                            [If SS Speci]
!!if|y12=8/y12=24;                     [If Mystic or Intelligence]
!!FU(Check_For_Valid_Spell):Py4/?y50;
!!if&y50>0;
!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit when Auto Combat]
!!BA:Q?y1;                              [Exit Quick Combat]
!!FU&y1=1:E;
!!FU(MSR_Determine_Spell_Type):Py4/0/0/?y13; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
!!HEy99:I?y96/1;                        [Spell Points in y96]
!!SSy4&y13=1:Cy82/?y20;                 [Air                                                    [Determine Mana Cost by Spell School]
!!SSy4&y13=2:Cy84/?y20;                 [Earth]
!!SSy4&y13=4:Cy81/?y20;                 [Fire]
!!SSy4&y13=8:Cy83/?y20;                 [Water]
!!SSy4&y13=15:C0/?y20;                  [Magic Arrow]
!!VRy19:Sy20;
!!VRy20:*2;                             [Take Spell Cost times 2]
!!if&y20<y96;                          [If double Spell Points is more than current Spell Points of the Hero]
!!SN:W^Specialists_SP_Damage_increase^/1; [calculate effect increase]

!!if&y50=1;                       [For damage spells]
!!FU(H3_Calc_Vanilla_Bonus_Spell_Damage):Py99/y4/?y3;
!!SN:W^Specialists_SP_Damage_spell_bonus^/?y5;
!!VRy2:Sy3 *y5 :100;
!!en;

!!if|y50=2/y50=3;                 [For stat spells]
!!FU(ApplyRemoveSpellScaling):Py99/y4/0/?y1/?y2;
!!SN:W^Specialists_SP_Damage_increase^/0;
!!FU(ApplyRemoveSpellScaling):Py99/y4/0/?y1/?y3;
!!en;

!!if&y50=4;                       [For summon spells]
!!FU(Calc_Summoning_Power):Py99/y4/?y2;
!!SN:W^Specialists_SP_Damage_increase^/0;
!!FU(Calc_Summoning_Power):Py99/y4/?y3;
!!en;

!!VRy2:-y3;
!!VRz3:S^^;
!!SN&y50=1:T^AC_Misc.Cast Damage^/?z3;
!!SN&y50=2:T^AC_Misc.Cast Percentage^/?z3;
!!SN&y50=3:T^AC_Misc.Cast Stat^/?z3;
!!SN&y50=4:T^AC_Misc.Cast Summon^/?z3;
!!SN:Iz3/?z3;
!!if&y2=0;
!!SN:T^AC_Misc.Failed Spend Spell Points^/?z2 Iz2/?z2;
!!IF:Q1/9/y4/1/z2;
!!SN:W^Specialists_SP_Damage_increase^/0;
!!en;
!!if&y2>0;
!!SN:T^AC_Misc.Spend Spell Points^/?z2 Iz2/?z2;
!!IF:Q1/9/y4/2/z2;
!!SN&1:W^Specialists_SP_Damage_increase^/1; [Set Flag to true if Player agreed to buff Spell]
!!SN&-1:W^Specialists_SP_Damage_increase^/0;
!!en;
!!en;
!!en;
!!en;
!!en;

*---------------------*

!!FU(ApplyRemoveSpellScaling):Py99/y4/1/?y1/?y2;
!!SSy4:Ey1/y2;                          [Set new Spell Value]

!!VRy19&1:*-1;
!!HEy99&1:Idy19/1;                      [Reduce Mana Pool]
!!HEy99&1:I?y96/1;
!!HEy99&y96<0/1:I0/1;

!!SN:W^Scaling_Magic_Flag^/1;           [Set Flag]

*!IF:M^%Y11 SpecialSchool%Y12 and Spell:%Y4 and School_from_Spell %Y13 and Manacost%Y20 and Hero Mana %Y96  Flag 1 is %F1^;

*------------------------------------------------------------------------------*
!?BG1&1000;                             [After Action Reset Spell Value to old                        [Trigger Buff/Debuff Spells]

!!SN:W^Scaling_Magic_Flag^/?y1;
!!FU&y1<>1:E;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;

!!SN:W^Scaling_Magic_Spell_Number_^/?y4;

!!FU(ApplyRemoveSpellScaling):Py99/y4/-1/?y1/?y2;

!!SSy4:Ey1/y2;

!!SN:W^Scaling_Magic_Spell_Number_^/0;
!!SN:W^Scaling_Magic_Flag^/0;
!!SN:W^Specialists_SP_Damage_increase^/0;


********************************************************************************
!?FU(CalcSpellScaling);
x1 - hero id; x2 - spell id; x3 - return how much effect will be added.

!!FU(Calc_Magic_Strength):Px1/?y1;      [Get MS of hero in y1]
!!VRx3:S0;

;Percentage spells
; Shield27, Air Shield28, 4 Protections from Element30-33, Magic Mirror36, Slow54.
; Fire Shield29 is special
!!if|x2=27/x2=28/x2=30/x2=31/x2=32/x2=33/x2=36;
!!VRx3&y1>=15:S3;
!!VRx3&y1>=20:S5;
!!VRx3&y1>=25:S8;
!!VRx3&y1>=30:S10;
!!VRx3&y1>=40:S12;
!!VRx3&y1>=50:S15;
!!VRx3&y1>=65:S17;
!!VRx3&y1>=85:S20;
!!VRx3&y1>=100:S25;
!!VRx3&y1>=110:Sy1*3:10-3;
!!VRx3&x3>=99/x2<>36:S99;               [max 99% for reduction spells]
!!VRx3&x3>=100/x2=36:S100;              [max 100% for Magic Mirror]
!!en;

; Slow54.
!!if&x2=54;
!!VRx3&y1>=15:S2;
!!VRx3&y1>=20:S4;
!!VRx3&y1>=25:S6;
!!VRx3&y1>=30:S8;
!!VRx3&y1>=35:S10;
!!VRx3&y1>=40:S12;
!!VRx3&y1>=50:S14;
!!VRx3&y1>=60:S16;
!!VRx3&y1>=70:S18;
!!VRx3&y1>=85:S20;
!!VRx3&y1>=100:S25;
!!VRx3&y1>=110:S30;
!!VRx3&y1>=120:S35;
!!VRx3&x3>=99:S99;                      [max 99% for reduction spells]
!!en;

!!if&x2=29;                            [Fire Shield]
!!VRx3&y1>=20:S2;
!!VRx3&y1>=25:S5;
!!VRx3&y1>=30:S8;
!!VRx3&y1>=40:S10;
!!VRx3&y1>=50:S12;
!!VRx3&y1>=65:S15;
!!VRx3&y1>=85:S17;
!!VRx3&y1>=100:S20;
!!VRx3&y1>=110:Sy1*3:10-10;
!!en;


;Attack/Defence
; Bloodlust43, Precision44, Weakness45, Stone Skin46, Disrupting Ray47, Slayer55
!!if|x2=43/x2=44/x2=45/x2=46/x2=47/x2=55;
!!VRx3&y1>=25:S1;
!!VRx3&y1>=30:S2;
!!VRx3&y1>=35:S3;
!!VRx3&y1>=45:S4;
!!VRx3&y1>=55:S5;
!!VRx3&y1>=70:S6;
!!VRx3&y1>=90:S7;
!!VRx3&y1>=105:S8;
!!VRx3&y1>=120:Sy1:10-3;
!!en;


;Damage
; Bless41, Curse42
!!if|x2=41/x2=42;
!!VRx3&y1>=25:S1;
!!VRx3&y1>=60:S2;
!!VRx3&y1>=100:S3;
!!VRx3&y1>=150:S4;
!!en;


;Morale/Luck/Retals
; Mirth49, Sorrow50, Fortune51, Misfortune52, Counterstrike58
!!if|x2=49/x2=50/x2=51/x2=52/x2=58;
!!VRx3&y1>=40:S1;
!!VRx3&y1>=70:S2;
!!VRx3&y1>=110:Sy1*3:100;
!!en;


;Haste53/Prayer48
!!if|x2=48/x2=53;
!!VRx3&y1>=35:S1;
!!VRx3&y1>=45:S2;
!!VRx3&y1>=75:S3;
!!VRx3&y1>=110:Sy1:25;
!!en;


;Summons
; Summon Fire66, Summon Air67, Summon Water68, Summon Earth69
!!if|x2=66/x2=67/x2=68/x2=69;
!!VRx3&y1>=30:S1;
!!VRx3&y1>=50:Sy1:25;
!!en;


********************************************************************************
!?FU(GetSpellRank);
*x1 is hero id, x2 is spell id, x3=return rank (for example Basic 1 or Expert 3)

!!HEx1:S14/?y81 S15/?y82 S16/?y83 S17/?y84; [Get current hero Fire14 Air15 Water16 Earth17 Magics]
!!SSx2:S?y1;                            [Get spell's magic school bits]
!!VRy3:Sy1:1%2;                         [air. If bits of this spell contain school of air magic, this will be equal to 1]
!!VRy4:Sy1:2%2;                         [fire]
!!VRy5:Sy1:4%2;                         [water]
!!VRy6:Sy1:8%2;                         [earth]
!!VRy1:S0;
!!VRy1&y3=1/y82>y1:Sy82;                [air y3, y82]
!!VRy1&y4=1/y81>y1:Sy81;                [fire y4, y81]
!!VRy1&y5=1/y83>y1:Sy83;                [water y5, y83]
!!VRy1&y6=1/y84>y1:Sy84;                [earth y6, y84]
Now y1 has spell's highest magic school rank.
!!VRx3:Sy1;


********************************************************************************
!?FU(ApplyRemoveSpellScaling);          [Doesn't apply or remove scaling immideately, it just returns rank and effect to set.]
x1 - hero id; x2 - spell id; x3 - mode. -1 is remove, 1 - apply, 0 - print for descriptions; x4 - return spell school rank; x5 - return applied effect.

!!FU(CalcSpellScaling):Px1/x2/?y1;
!!FU(GetSpellRank):Px1/x2/?x4;
!!SSx2:Ex4/?x5;
!!VRy1|x2=27/x2=28/x2=30/x2=31/x2=32/x2=33/x2=54:*-1; [Reduction spells decrease multiplier.]
!!VRy1&x3=-1:*-1;                       [Remove mode decreases effect]
!!VRx5:+y1;
!!if&x3=0;
!!VRx5|x2=27/x2=28/x2=30/x2=31/x2=32/x2=33/x2=54:-100 *-1; [For descriptions change reduction spells values: (35% multiplier) to (100-35=65% reduction)]
!!en;


********************************************************************************
!?FU(Calc_Magic_Strength);

!!HEx1:S14/?y81 S15/?y82 S16/?y83 S17/?y84 Fd/d/?y86/d S25/?y87; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien, SpellPower und Sorcery(25)hat]
!!HEx1:S18/?y88 S7/?y89 S24/?y91 S8/?y92;[Checke current hero Scholar(18) and Wisdom[7] Intelligence[24] Mysticism [8]hat]


*-----Special conditions which can change MS, like weeks, artifacts, spells, heroes etc...----*
!!SN:W^Magic_Week_Number^/?y99;
!!VRy86&y99=46:+20;                     [+20 Magic Strength if Special Week 46]

!!SN:W^Specialists_SP_Damage_increase^/?y1; [Intelligence and Mystic Specialists can increase MS]
!!VRy86&y1=1:+20;

!!HEx1:A2/57/?y15/?y16 A2/141/?y15/?y17;[57 Garniture of Interference +5 Magic Strength, Magic Wand +20 to MS]
!!VRy86&y16=1:+5;
!!VRy86&y17=1:+20;

!!SN:W^Grandmaser_Mage_Hero%X1^/?y30;   [Gm Mage Channeling ability If Spell Points are abouve maximum increase MS by +15]
!!if&y30=1;
  !!FU(Intelligence_Set_Spell_Points):Px1/0/?y31/1; [Return Number of Max Possible Spell Points in y31 for the Hero and only check not set]
  !!HEx1:I?y32/1;                       [Get Current Heroes Spell Points]
  !!VRy86&y32>=y31:+15;                 [Increase MS by +15 is condition is true]
!!en;
*---------------------*

*!VRy87&y87><0/v7198=1:+4;                                                      [Fix for Sorcery II Offset]

!!SN:W^H3_Sorcery_0_Hero%X1^/?y1; !!SN:W^H3_Sorcery_1_Hero%X1^/?y2;
!!VRy86&y87=1/y1=0/y2=0:+4;             [Basic Sorc gives +4 to scaling]
!!VRy86&y87=2/y1=0/y2=0:+6;             [Advanced Sorc gives +6 to scaling]
!!VRy86&y87=3/y1=0/y2=0:+8;             [Expert Sorc gives +8 to scaling]
!!VRy86&y87=3/y1=1/y2=0:+12;            [Master +12]
!!VRy86&y87=3/y1=1/y2=0:+16;            [GM +16]

!!SN:W^H3_Fire Magic_0_Hero%X1^/?y1; !!SN:W^H3_Fire Magic_1_Hero%X1^/?y2;
!!VRy86&y81=1/y1=0/y2=0:+2;             [Basic Fire Magic gives +2 to scaling]
!!VRy86&y81=2/y1=0/y2=0:+3;             [Advanced Fire Magic gives +3 to scaling]
!!VRy86&y81=3/y1=0/y2=0:+4;             [Expert Fire Magic gives +4 to scaling]
!!VRy86&y81=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y81=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Air Magic_0_Hero%X1^/?y1; !!SN:W^H3_Air Magic_1_Hero%X1^/?y2;
!!VRy86&y82=1/y1=0/y2=0:+2;             [Basic Air Magic gives +2 to scaling]
!!VRy86&y82=2/y1=0/y2=0:+3;             [Advanced Air Magic gives +3 to scaling]
!!VRy86&y82=3/y1=0/y2=0:+4;             [Expert Air Magic gives +4 to scaling]
!!VRy86&y82=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y82=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Water Magic_0_Hero%X1^/?y1; !!SN:W^H3_Water Magic_1_Hero%X1^/?y2;
!!VRy86&y83=1/y1=0/y2=0:+2;             [Basic Water Magic gives +2 to scaling]
!!VRy86&y83=2/y1=0/y2=0:+3;             [Advanced Water Magic gives +3 to scaling]
!!VRy86&y83=3/y1=0/y2=0:+4;             [Expert Water Magic gives +4 to scaling]
!!VRy86&y83=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y83=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Earth Magic_0_Hero%X1^/?y1; !!SN:W^H3_Earth Magic_1_Hero%X1^/?y2;
!!VRy86&y84=1/y1=0/y2=0:+2;             [Basic Earth Magic gives +2 to scaling]
!!VRy86&y84=2/y1=0/y2=0:+3;             [Advanced Earth Magic gives +3 to scaling]
!!VRy86&y84=3/y1=0/y2=0:+4;             [Expert Earth Magic gives +4 to scaling]
!!VRy86&y84=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y84=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Scholar_0_Hero%X1^/?y1; !!SN:W^H3_Scholar_1_Hero%X1^/?y2;
!!VRy86&y88=1/y1=0/y2=0:+3;             [Basic Scholar gives +3 to scaling]
!!VRy86&y88=2/y1=0/y2=0:+4;             [Advanced Scholar gives +4 to scaling]
!!VRy86&y88=3/y1=0/y2=0:+5;             [Expert Scholar gives +5 to scaling]
!!VRy86&y88=3/y1=1/y2=0:+6;             [Master +6]
!!VRy86&y88=3/y1=1/y2=1:+8;             [GM +8]

!!SN:W^H3_Wisdom_0_Hero%X1^/?y1; !!SN:W^H3_Wisdom_1_Hero%X1^/?y2;
!!VRy86&y89=1/y1=0/y2=0:+1;             [Basic Wisdom gives +1 to scaling]
!!VRy86&y89=2/y1=0/y2=0:+2;             [Advanced Wisdom gives +2 to scaling]
!!VRy86&y89=3/y1=0/y2=0:+3;             [Expert Wisdom gives +3 to scaling]
!!VRy86&y89=3/y1=1/y2=0:+5;             [Master +5]
!!VRy86&y89=3/y1=1/y2=1:+7;             [GM +7]

!!SN:W^H3_Intelligence_0_Hero%X1^/?y1; !!SN:W^H3_Intelligence_1_Hero%X1^/?y2;
!!VRy86&y91=1/y1=0/y2=0:+1;             [Basic Intelligence gives +1 to scaling]
!!VRy86&y91=2/y1=0/y2=0:+2;             [Advanced Intelligence gives +2 to scaling]
!!VRy86&y91=3/y1=0/y2=0:+3;             [Expert Intelligence gives +3 to scaling]
!!VRy86&y91=3/y1=1/y2=0:+5;             [Master +5]
!!VRy86&y91=3/y1=1/y2=1:+7;             [GM +7]

!!SN:W^H3_Mysticism_0_Hero%X1^/?y1; !!SN:W^H3_Mysticism_1_Hero%X1^/?y2;
!!VRy86&y92=1/y1=0/y2=0:+2;             [Basic Mysticism gives +2 to scaling]
!!VRy86&y92=2/y1=0/y2=0:+3;             [Advanced Mysticism gives +3 to scaling]
!!VRy86&y92=3/y1=0/y2=0:+4;             [Expert Mysticism gives +4 to scaling]
!!VRy86&y92=3/y1=1/y2=0:+5;             [Master +5]
!!VRy86&y92=3/y1=1/y2=1:+7;             [GM +7]

!!SN:W^H3_Eagle Eye_0_Hero%X1^/?y1; !!SN:W^H3_Eagle Eye_1_Hero%X1^/?y2;
!!VRy86&y1=1/y2=0:+2;                   [Master Eagle Eye]
!!VRy86&y1=1/y2=1:+3;                   [GM Eagle Eye]

!!SN:W^Scaling_Magic_Map_Size^/?y10;

!!VRy86&y10=1:*120:100;                 [+20% Bonus on S size map]
!!VRy86&y10=2:*110:100;                 [+10% Bonus on M size map]
!!VRy86&y10=3:+0;                       [0 penalty on L size map]
!!VRy86&y10=4:*85:100;                  [-15% penalty on XL size map]
!!VRy86&y10=5:*80:100;                  [-20% penalty on XXL size map]

!!SN:W^Spell_Trainer_Mod^/?y1;          [Spell Trainer option reduces your MS by 25%]
!!VRy86&y1=1:*75:100;

!!VRx2:Sy86;                            [Set MS to x2 for return]
!!VRx2&x2<1:S1;                         [Set Minimum to 1]


!?FU(Check_For_Valid_Spell);
!!VRx2:S0;
!!VRx2|x1=15/x1=16/x1=17/x1=18/x1=19/x1=20/x1=21/x1=22/x1=23/x1=24/x1=25/x1=26:S1; [Damaging spells]
!!VRx2|x1=27/x1=28/x1=30/x1=31/x1=32/x1=33/x1=36/x1=54:S2; [Percentage spells, no Fire Shield]
!!VRx2|x1=41/x1=42/x1=43/x1=44/x1=45/x1=46/x1=47/x1=48:S3; [Other stat spells]
!!VRx2|x1=49/x1=50/x1=51/x1=52/x1=53/x1=55:S3; [Other stat spells]
!!VRx2|x1=66/x1=67/x1=68/x1=69:S4; [Summon spells]



*Fire Shield Rework*
!?MF1;
!!UN:C42149568/4/?y10;                  [Physical Damage]
!!MF:F?y6;                              [Damage]
!!MF:N?y4;                              [Damage receiving stack]
!!BMy4:N?y20 H?y21 L?y22;               [Get Number and Life of Stack to calc real applied damage]
!!VRy23:Sy20*y21 -y22;
!!VRy6&y23<y6:Sy23;                     [If rest life of the stack is smaller than applied damage only set the rest life as new damage]

!!SN&y10=4462398:W^Damage_Fire_Shield^/y6; [Save Physical Damage]

!!FU&y10<>4458589:E;                    [Exit if damage does not come from Fire Shield]
!!BG:N?y1 E?y2 Q?y3;
!!MF:N?y4;                              [Damage receiving stack]
!!BMy4:T?y80;
!!VRy90:S0;
!!VRy90|y80=27/y80=33/y80=55/y80=69/y80=82/y80=83/y80=116/y80=117:S1;
!!VRy90|y80=121/y80=151/y80=153/y80=155/y80=172/y80=195:S1;
!!MF&y90=1:E0;                          [Apply Zero Damage if Immune]
!!MF&y90=1:F0;                          [Apply Zero Damage if Immune]
!!FU&y90=1:E;                           [Exit]

*Immune Creatures*
27 Gold Dragon
33 Iron Golem
55 Arch Devil
69 Ghost Dragon
82 Red Dragon
83 Black Dragon
116 Gold Golem
117 Diamond Golem
121 Magic Elemental
151 Diamond Dragon
153 Antichrist
155 Darkness Dragon
172 Nightmare
195 Hell Steed

!!VRy3:-1 *-1;
!!BHy3:N?y5;                            [Hero Number]
!!SN:W^Damage_Fire_Shield^/?y8;         [Physical Damage]
!!FU(Fire_Shield_Calculation):Py5/y1/y4/y2/y3/y8/?y7/0/1;
!!MF:Fy7;                               [Apply new Damage]


!?FU(Fire_Shield_Calculation);
*x1=Hero Number, x2=attacking stack, x3=damage receiving stack, x4=destination monster stack, x5=attacking side, x6=damage, x7=returns damage, x7=returns only magic damage, x9=State (1)Combat/Non-Combat(0)

!!VRx6::10;                             [10% of physical damage]
!!HEx1&x1>=0:F?y2/?y3/?y4/?y5;
!!VRy4&x1<0:S1;                         [Set Spell Power to 1 if no Hero]

!!HEx1&x1>=0:S14/?y10;                  [Fire Magic]
!!SN:W^H3_Fire Magic_0_Hero%X1^/?y11;
!!SN:W^H3_Fire Magic_1_Hero%X1^/?y12;
!!VRy17:S100;
!!VRy16:S50;
!!VRy16&y10=0/y11=0/y12=0:S50;   !!VRy16&y10=1/y11=0/y12=0:S100;   !!VRy16&y10=2/y11=0/y12=0:S150;  !!VRy16&y10=3/y11=0/y12=0:S200; [Flat Damage from Basic and Expert Fire Magic]
!!VRy17&y10=3/y11=0/y12=0:S100;  !!VRy17&y10=3/y11=1/y12=0:S115;  !!VRy17&y10=3/y11=1/y12=1:S125;
!!VRy9:Sy4*20+y16*y17:100;              [Formula is 10%+(25+SP*20*Sorcery);]

!!HEx1&x1>=0:S25/?y10;                  [Sorcery]
!!SN:W^H3_Sorcery_0_Hero%X1^/?y11;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y12;
!!VRy15:S100;
!!VRy15&y10=0/y11=0/y12=0:S100;  !!VRy15&y10=1/y11=0/y12=0:S110;  !!VRy15&y10=2/y11=0/y12=0:S120;  !!VRy15&y10=3/y11=0/y12=0:S130;  !!VRy15&y10=3/y11=1/y12=0:S140;  !!VRy15&y10=3/y11=1/y12=1:S150;
!!VRy9:*y15:100;                        [Formula is 10%+(25+SP*10*Sorcery);]

!!HEx1:A2/81/?y60/?y61;
!!VRy9&y61=1:*150:100;                  [+50% damage with Orb of Fire]

!!VRx8:Sy9;                             [Get only the additional Magic Damage without the physical part]
!!FU&x9=0:E;                            [Exit here if only damage for the spell book is wanted (Non Combat)]
!!VRy30:Sx6+y9;                         [Total Damage  add Physical Damage]
!!VRy30&x1<0:-y9;                       [If no Hero damage is only 10%]
!!VRy30&y30<0:S0;

!!VRx5:-1 *-1;
!!BHx5:N?x1;                            [Hero Number]
!!if&x1>=0;                            [Resistance]
!!HEx1:S26/?y10;
!!SN:W^H3_Resistance_0_Hero%X1^/?y11;
!!SN:W^H3_Resistance_1_Hero%X1^/?y12;
!!VRy15:S100;
!!VRy15&y10=0/y11=0/y12=0:S100;  !!VRy15&y10=1/y11=0/y12=0:S90;  !!VRy15&y10=2/y11=0/y12=0:S85;  !!VRy15&y10=3/y11=0/y12=0:S80;  !!VRy15&y10=3/y11=1/y12=0:S75;  !!VRy15&y10=3/y11=1/y12=1:S70;
!!VRy30:*y15:100;                       [Reduce damage if enemy hero has resistance]

!!VRy40:S0T100;
!!VRy16:S0;
!!VRy16&y10=0/y11=0/y12=0:S0;  !!VRy16&y10=1/y11=0/y12=0:S10;  !!VRy16&y10=2/y11=0/y12=0:S15;  !!VRy16&y10=3/y11=0/y12=0:S20;  !!VRy16&y10=3/y11=1/y12=0:S25;  !!VRy16&y10=3/y11=1/y12=1:S30;

!!HEx1:A2/57/?y10/?y15; !!VRy16&y15=1:+10; [57 Garniture of Interference]
!!HEx1:A2/58/?y10/?y15; !!VRy16&y15=1:+15; [58 Surcoat of Counterpoise]
!!HEx1:A2/59/?y10/?y15; !!VRy16&y15=1:+20; [59 Boots of Polarity]
!!VRy30&y40<=y16:S0;                    [Deal Zero Damage if Spell can be resisted]
*!IF:M^Chance to resist is %Y16 and Roll is %Y40 , Total Damage is %Y30^;
!!en;

!!BMx3&x3>=0/x3<=41:G31/?y70/?y71;      [Check for Protection of Fire]
!!VRy30&y70>0::2;                       [Half damage from Fire Shield if Protection is On]

!!VRx7:Sy30;                            [Transfer New damage]


********************************************************************************
*Summoning Spell Rework by Remagic from Algor* modified by PerryR

** Summoning spells:
** - have a "standard" calculation formula (SP * a + b)
** - receive a 50% bonus if the hero has a sphere of the corresponding element.
** - do not have a restriction on summoning only one type of creature in battle.

!?FU(OnGameEnter);
!!UN:C5896327/1/235;  [Disable type checking of called elemental]
!!UN:C5936848/1/235;

!?BG0;

!!BG:A?y1;
!!FU&y1<>1:E;
!!BG:S?y1 Q?y2;
!!FU|y1<66/y1>69:E; [Exit if Spell is not Summon]
*!VRy4&y1=66:S164;
*!VRy4&y1=67:S165;
*!VRy4&y1=68:S167;
*!VRy4&y1=69:S166;

112 Air Elemental    Creature Number
113 Earth Elemental
114 Fire Elemental
115 Water Elemental

66 Fire Elemental    Spell Number
67 Earth Elemental
68 Water Elemental
69 Air Elemental

!!BA:Hy2/?y5;
!!SN&y1=66:W^H3_Fire Magic_1_Hero%Y5^/?y30;    [Check for Grandmaster Fire]
!!SN&y1=67:W^H3_Earth Magic_1_Hero%Y5^/?y30;   [Check for Grandmaster Earth]
!!SN&y1=68:W^H3_Water Magic_1_Hero%Y5^/?y30;   [Check for Grandmaster Water]
!!SN&y1=69:W^H3_Air Magic_1_Hero%Y5^/?y30;     [Check for Grandmaster Air]

!!VRy4&y1=66:S114; !!VRy4&y1=66/y30=1:S129;    [Set Summoned Creature to Fire Elemental or Energy Elemental if Grandmaster]
!!VRy4&y1=67:S113; !!VRy4&y1=67/y30=1:S125;    [Set Summoned Creature to Earth Elemental or Magma Elemental if Grandmaster]
!!VRy4&y1=68:S115; !!VRy4&y1=68/y30=1:S123;    [Set Summoned Creature to Water Elemental or Ice Elemental if Grandmaster]
!!VRy4&y1=69:S112; !!VRy4&y1=69/y30=1:S127;    [Set Summoned Creature to Air Elemental or Storm Elemental if Grandmaster]

!!FU(Summoning_Rework6):Py1/0/y5/?y7;
!!SSy1:Cy7/?y9 Ey7/?y10 P?y11;
!!VRy9:*-1;

!!FU(Calc_Summoning_Power):Py5/y1/?y13; [Pass Hero Number, Spell Number, Returns total Summoned HP]

!!MA:Py4/?y20;
!!VRy21:Sy13 :y20 +1;

!!VRy22:Sy13 %y20 -y20 *-1;
!!VRy21&y22=0:-1;
!!FU(Summoning_Rework1):Py4/y2/y21/?y18/y22;
!!BA:Q?f;
!!if&y18=0;
  !!BHy2:M1;
  !!HEy5:Idy9/1 B0/?z1;
*!UN&f=0:N1/2/y1;
*!SN&f=0:T^AC_Misc.Summon_1^/?z3;
*!VRz3&f=0:Sz180000;
*!MM&f=0:Sz3;
!!en;
!!BG:A0;


!?FU(Summoning_Rework1);
!!VRy1:Sx2 *21;
!!VRy2:Sy1 +20;
!!VRy3:S-1;
!!DO(Summoning_Rework2)/y1/y2/1:P?y3;
!!BA:Q?f;
!!if&y3=-1;
  !!SN&f=0:T^AC_Misc.Summon_2^/?z3;
  !!MM&f=0:Sz3;
  !!VRx4:S1;
  !!FU:E;
!!en;
!!VRv1:S0;
!!DO(Summoning_Rework3)/0/10/1:P0/x2;
!!if&v1>0;
  !!VRv1:-1;
  !!VRy4:S1Tv1;
  !!VRv1:S0;
  !!DO(Summoning_Rework3)/0/10/1:Py4/x2;
  !!BU:Sx1/x3/v1/x2/-1/1 Ev1/?y4;
  !!BMy4:Lx5;
  !!BMy4:F?i; !!VRi:|4194304; !!BMy4:Fi;[Add Summoning Flag]

  !!SN|x1=123/x1=115:W^Summoned_Water_Perk_%X2^/1; [If Water or Ice  Elemental was summoned Set Flag to 1]
  !!SN|x1=113/x1=125:W^Summoned_Earth_Perk_%X2^/1; [If Earth or Magma Elemental was summoned Set Flag to 1]

  !!BMy4|x1=114/x1=129:M29/99/3;        [Apply 29 Fire Shield to Fire Elemental or Energy Elemental]
  !!BMy4|x1=112/x1=127:Sd2;             [Apply +2 Speed to Air Elemental or Storm Elemental]
  !!VRz1&f=0:S^SUMNELM^;
  !!SN&f=0:Pz1;
  !!VRx4:S0;
  !!BU&f=0:R;
!!el;
  !!SN&f=0:T^AC_Misc.Summon_3^/?z3;
  !!MM&f=0:Sz3;
  !!VRx4:S2;
  !!FU:E;
!!en;

!?FU(Summoning_Rework2);
!!BMx16:T?y1 N?y2;
!!FU|y1<>-1/y2<>0:E;
!!VRx1:Sx16;
!!VRx16:S100500;

!?FU(Summoning_Rework3);
!!VRi:Sx2 *13;
!!VRy1:Sx16 *17 +1 +i;
!!VRy1&y1=20:+1;
!!BU:Dy1/?y2 Oy1/?y3 Ey1/?y4;
!!VRv1&y2=-1/y3=0/y4=-1:+1;
!!if&x1>0/x1=v1;
  !!VRv1:Sy1;
  !!VRx16:S100500;
  !!BU&f=0:R;
  !!FU:E;
!!en;
!!VRy1:+1;
!!BU:Dy1/?y2 Oy1/?y3 Ey1/?y4;
!!VRv1&y2=-1/y3=0/y4=-1:+1;
!!if&x1>0/x1=v1;
  !!VRv1:Sy1;
  !!VRx16:S100500;
  !!BU&f=0:R;
  !!FU:E;
!!en;


!?PI;

!!DO(Summoning_Rework4)/0/196/1:P;
!?FU(Summoning_Rework4);
!!DO(Summoning_Rework5)/0/19/1:Px16;
!?FU(Summoning_Rework5);
!!EAx1:Bx16/?y2/?y3/?y4/d/d/d/d/d/d/d/d/d/d/d;
!!if|y3=74/y3=97/y3=99/y3=106/y3=112/y3=115;
  !!EAx1&y4>65/y4<70:Bx16/0/d/d/0/0/0/0/0/0/0/0/0/0/0;
!!en;


!?BG0;

!!BG:A?y1;
!!FU&y1<>10:E;
!!BG:Q?y2 N?y3;
!!BMy3:T?y4 U4/?y1 E?y30;
!!FU|y1<66/y1>69/y4<174/y4>191/y30<1:E;
!!VRy4&y1=66:S114;
!!VRy4&y1=67:S113;
!!VRy4&y1=68:S115;
!!VRy4&y1=69:S112;
!!BA:Hy2/?y5;
!!COy5:S4/?y6;
!!VRy7:S2;
!!BA:P?y11/?y12/?y13;
!!TRy11/y12/y13:G?y8;
!!VRy7&y8=46:S3;
!!VRy7&y1=69/y8=229:S3;
!!VRy7&y1=66/y8=226:S3;
!!VRy7&y1=68/y8=228:S3;
!!VRy7&y1=67/y8=231:S3;
!!HEy5:A2/79/?i/?y14 A2/80/?i/?y15 A2/81/?i/?y16 A2/82/?i/?y17;
!!VRy9:Sy6 +1 *y7;
!!VRy9&y1=66/y16>0:*3 :2;
!!VRy9&y1=67/y17>0:*3 :2;
!!VRy9&y1=68/y15>0:*3 :2;
!!VRy9&y1=69/y14>0:*3 :2;
!!FU(Summoning_Rework1):Py4/y2/y9/?y18/0;
!!if&y18=0;
  !!BG:A12;
  !!VRy30:-1;
  !!BMy3:Ey30;
!!en;

!?FU(Summoning_Rework6);
!!VRy10:S0;
!!HEx3&x2=1:P?y1/?y2/?y3;
!!BA&x2=0:P?y1/?y2/?y3;
!!TRy1/y2/y3:G?y4;
!!SSx1:S?y5;
!!VRy6:Sy5 &1;
!!VRy7:Sy5 &4;
!!VRy8:Sy5 &2;
!!VRy9:Sy5 &8;
!!HEx3:S15/?y11 S16/?y12 S14/?y13 S17/?y14;
!!VRy10&y6>0/y10<y11:Sy11;
!!VRy10&y7>0/y10<y12:Sy12;
!!VRy10&y8>0/y10<y13:Sy13;
!!VRy10&y9>0/y10<y14:Sy14;
!!VRy10&y4=46:S3;
!!VRy10&y6>0/y4=229:S3;
!!VRy10&y7>0/y4=228:S3;
!!VRy10&y8>0/y4=226:S3;
!!VRy10&y9>0/y4=231:S3;
!!VRx4:Sy10;


!?FU(Calc_Summoning_Power);
[Pass Hero Number, Spell Number, Returns total Summoned HP]

66 Fire Elemental
67 Earth Elemental
68 Water Elemental
69 Air Elemental

!!VRz1&x2=66:S^Fire^;  !!VRy2&x2=66:S14;
!!VRz1&x2=67:S^Earth^; !!VRy2&x2=67:S17;
!!VRz1&x2=68:S^Water^; !!VRy2&x2=68:S16;
!!VRz1&x2=69:S^Air^;   !!VRy2&x2=69:S15;

!!HEx1&x1>=0:Sy2/?y10;                  [Fire Magic]
!!SN:W^H3_%Z1 Magic_0_Hero%X1^/?y11;
!!SN:W^H3_%Z1 Magic_1_Hero%X1^/?y12;

!!VRy16&y10=0/y11=0/y12=0:S100;   !!VRy16&y10=1/y11=0/y12=0:S200;   !!VRy16&y10=2/y11=0/y12=0:S300;  !!VRy16&y10=3/y11=0/y12=0:S500; !!VRy16&y10=3/y11=1/y12=0:S750;  !!VRy16&y10=3/y11=1/y12=1:S1000; [Flat Damage from Basic until GM]
!!FU(Calc_Magic_Strength):Px1/?y90;
!!VRy20:S100;
!!VRy20&x2=69:S75; !!VRy20&x2=68:S100; !!VRy20&x2=66:S150; !!VRy20&x2=67:S200;

!!VRy9:Sy90*20+y16 *y20:100;            [Formula is (MS*20) * Spell Level Modifier 75% for Air 100% Water 150% Fire 200%Earth]

!!HEx1:A2/79/?i/?y24 A2/82/?i/?y25 A2/81/?i/?y26 A2/80/?i/?y27 A2/143/?i/?y28;
!!VRy9&x2=66/y26>0:*3 :2;               [+50% HP with Orbs]
!!VRy9&x2=67/y27>0:*3 :2;
!!VRy9&x2=68/y25>0:*3 :2;
!!VRy9&x2=69/y24>0:*3 :2;

!!SN:W^Hero%X1_Summoning_Upgrade^/?y50;
!!VRy50:*100;                           [+100 HP per Spell Upgrade]
!!VRy9:+y50;
!!VRy9&y28=1:+1000;                     [+1000HP with the scroll of summoning]

!!VRx3:Sy9;                             [Return and pass HP value]

!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4455011/y10=4456676; [Only run when melee or shooting damage or Strikes all Enemies Around]

!!SN:W^Summoned_Water_Perk_0^/?y5;      [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/?y6;      [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/?y7;      [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/?y8;      [For Defender Side 1]
!!FU&y5=0/y6=0/y7=0/y8=0:E;             [Exit if no Summoning Flag is enabled]

!!BG:A?y1;                              [Aktion in y1]
!!if|y1=6/y1=7;

!!BG:N?y1;                              [Attacking Stack]
!!BG:E?y2;                              [Destination Stack]
!!MF:N?y4;                              [Damage receiving stack]
!!BMy4:I?y5;
!!SN:W^Summoned_Earth_Perk_%Y5^/?y6;
!!if&y6=1;
!!MF:F?y10;                             [damage dealt]
!!VRy11:Sy10*95:100;                    [Reduce Damage by 5%]
!!MF:Fy11;
!!en;

!!SN:W^Summon_Attacking_Stack^/?y50;
!!VRy1&y4=y1/y50>=0/y50<=41:Sy50;       [If Attacking Stack gleich Damage Recieving Stack it means Retaliation]
!!SN:W^Summon_Attacking_Stack^/y4;

!!BMy1:I?y5;
!!SN:W^Summoned_Water_Perk_%Y5^/?y6;
!!if&y6=1;
!!MF:F?y10;                             [damage dealt]
!!VRy11:Sy10*105:100;                   [Increase Damage by 5%]
!!MF:Fy11;
*!IF:M^Attacking Stack is %Y1 and Damage Receiving Stack is %Y4  and Destination Stack is %Y2 and Damage is %Y11 and old %Y10^;
!!en;
!!en;
!!en;


!?FU(OnBattleRegeneratePhase)&1000;
!!BA:Q?y1;
!!FU&y1=1:E;                            [Exit in Quick Combat]

!!SN:X?y1;                              [Event parameter]
!!BMy1:I?y2;                            [Acting Side Monster]
!!BA:Hy2/?y4;                           [Current Hero]
!!FU&y4<0:E;                            [Exit if none]
!!SN:W^Summoned_Water_Perk_0^/?y5;      [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/?y6;      [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/?y7;      [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/?y8;      [For Defender Side 1]
!!FU&y5=0/y6=0/y7=0/y8=0:E;             [Exit if no Summoning Flag is enabled]

!!SN:W^Summoned_Water_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Earth_Perk_0^/0;        [For Attacker Side 0]
!!SN:W^Summoned_Water_Perk_1^/0;        [For Defender Side 1]
!!SN:W^Summoned_Earth_Perk_1^/0;        [For Defender Side 1]
!!DO(Check_Summon_Flags)/0/41/1:P;


!?FU(Check_Summon_Flags);

!!BMx16:N?y1;                           [Get Number of Creatures in y1]
!!FU&y1=0:E;

!!if&x16<21;
!!BMx16:T?y3;                           [Get Creature Number]
!!if|y3=113/y3=125;                    [Earth or Magma]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Earth_Perk_0^/1;   [Enable Flag For Attacker Side 0 again]
!!en;
!!if|y3=115/y3=123;                    [Water or Ice]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Water_Perk_0^/1;   [Enable Flag For Attacker Side 0 again]
*!IF:M^Now %Y3 Water %Y4^;
!!en;
!!en;

!!if&x16>20;
!!BMx16:T?y3;                           [Get Creature Number]
!!if|y3=113/y3=125;                    [Earth or Magma]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Earth_Perk_1^/1;   [Enable Flag For Defender Side 1 again]
!!en;
!!if|y3=115/y3=123;                    [Water or Ice]
!!BMx16:F?y2;                           [Get Flag in y2]
!!VRy2:&4194304;                        [Check for Summoning Flag]
!!SN&y2>0:W^Summoned_Water_Perk_1^/1;   [Enable Flag For Defender Side 1 again]
!!en;
!!en;


********************************************************************************


                 Reworked Magic Specialists Mod Section


a Mod by PerryR V.1.6
ERMS_ScriptAuthor=PerryR
********************************************************************************
**V-Vars used: v3,v4
**Z-Vars used:
**Function used: FU377879 -FU377885
**Flags used:

!#SN:W^Reworked_Magic_Specialists_Mod^/1;[Reworked_Magic_Specialists_Mod Set to active]
!#UN:P39/?y1;                           [Check if Hero Specialisation Boost ins enabled in WoG]
!_#IF&y1=0:M^Hero Specialisation Boost seems disabled. To keep balance the crit chance for unique spells and the 0.5% spell damage per level for magic heroes will be disabled. Have fun.^;


********************************************************************************[Set Speciality Description]
!?CM2&1000;
!!CM:F?v3 I?v4 S?v5 T?v6;               [where we click and click subtype]
!!FU|v4<>118/v6<>512/v5=13:E;           [If not Specialty Icon Clicked Exit]

!!if|v3=512/v3=0;                      [if right or left click]
!!HE-1:N?y6;                            [Get current hero #]
!!FU(Set_Desc_Hero_Speciality):Py6/?y11/?y12;
!!en;


********************************************************************************
!?BF&1000;                              [Prepare Battle]
!!BH0:N?y2;                             [For Attacker]
!!if&y2>=0;
  !!HEy2:X?y11/?y12/?y13/?y14/?y15/?y16/?y17; [Check Hero Speciality]
  !!SN&y11=0/y12=25:W^Magic_Specialists_Att_Spells_Saved^/1; [Set Saved Spells Flag true for Sorcery Specialists]
  !!DO(AC_Function_74)/10/69/1&y11=0/y12=25:Py2; [Remember Attacker Hero Spells Sorcery]

  !!if|y12=14/y12=15/y12=16/y12=17;
    !!DO(AC_Function_74)/10/69/1&y11=0:Py2; [Remember Attacker Hero Spells Fire, Air, Water, Earth Magic]
    !!SN&y11=0:W^Magic_Specialists_Att_Spells_Saved^/1; [Set Saved Spells Flag true for Sorcery Specialists]
  !!en;

    !!if&y11=3/y12>=13/y12<=26;        [If spell specialist and its damage spell increase spell counter]
      !!HEy2:Ed/?y4/1;
      !!HEy2:My12/?y30;                 [Check if Hero acctually knows his spell to prevent blank spell book]
      !!if&y30=1;
        !!DO(AC_Function_74)/10/69/1:Py2;[Remember Attacker Hero Spells]
        !!SN:W^Magic_Specialists_Att_Spells_Saved^/1;

        !!VRy4&y12=15::6;               [Magic Arrow]
        !!VRy4&y12=16::8;               [Ice Bolt]
        !!VRy4&y12=20::10;              [Frost Ring]
        !!VRy4&y12=19::15;              [Chain Lighnting]
        !!VRy4&y12=22::13;              [Inferno]
        !!VRy4&y12=23::12;              [Meteor Shower]
        !!VRy4&y12=21::10;              [Fireball]
        !!VRy4&y12=24::15;              [Death Ripple]
        !!VRy4&y12=13::10;              [Fire Wall]
        !!VRy4&y12=17::10;              [Lightning Bolt]
        !!VRy4&y12=18::16;              [Implosion]
        !!SN:W^Magic_Specialists_Att^/y4;
        *!FU(Save_Special_Spell_Mana_Cost):Py2/y12/0;                                   [Save Own Special Spell Attacker]
      !!en;
    !!en;
  !!en;

!!BH1:N?y3;
!!if&y3>=0;                            [For Defender]
  !!HEy3:X?y21/?y22/?y23/?y24/?y25/?y26/?y27; [Check Hero Speciality]
  *!FU(Save_Special_Spell_Mana_Cost):Py3/y12/0;                                   [Save Special Spell from Attacker for Defender]
  !!SN&y21=0/y22=25:W^Magic_Specialists_Def_Spells_Saved^/1;
  !!DO(AC_Function_74)/10/69/1&y21=0/y22=25:Py3; [Remember Defender Hero Spells Sorcery]

  !!if|y22=14/y22=15/y22=16/y22=17;
    !!DO(AC_Function_74)/10/69/1&y21=0:Py3; [Remember Attacker Hero Spells Fire, Air, Water, Earth Magic]
    !!SN&y21=0:W^Magic_Specialists_Def_Spells_Saved^/1;
  !!en;

    !!if&y21=3/y22>=13/y22<=26;        [If spell specialist and its damage spell increase spell counter]
      !!HEy3:Ed/?y5/1;
      !!HEy3:My22/?y31;                 [Check if Hero acctually knows his spell to prevent blank spell book]
      !!if&y31=1;
        !!DO(AC_Function_74)/10/69/1:Py3;[Remember Defender Hero Spells]
        !!SN:W^Magic_Specialists_Def_Spells_Saved^/1;
        !!VRy5&y22=15::6;               [Magic Arrow]
        !!VRy5&y22=16::8;               [Ice Bolt]
        !!VRy5&y22=20::10;              [Frost Ring]
        !!VRy5&y22=19::15;              [Chain Lighnting]
        !!VRy5&y22=22::13;              [Inferno]
        !!VRy5&y22=23::12;              [Meteor Shower]
        !!VRy5&y22=21::10;              [Fireball]
        !!VRy5&y22=24::15;              [Death Ripple]
        !!VRy5&y22=13::10;              [Fire Wall]
        !!VRy4&y22=17::10;              [Lightning Bolt]
        !!VRy4&y22=18::16;              [Implosion]
        !!SN:W^Magic_Specialists_Def^/y5;[Extra Cast Variable Defender Set 1]
        *!FU(Save_Special_Spell_Mana_Cost):Py3/y22/1;                                   [Save Own Special Spell Defender]
      !!en;
    !!en;
  !!en;


********************************************************************************
!?FU(OnAfterBattleUniversal)&1000;      [Give Back Hero Spells after Fight]

!!BA:H0/?y2;                            [For Attacker]
!!SN:W^Magic_Specialists_Att_Spells_Saved^/?y1;
!!if&y2>=0/y1=1;
!!DO(AC_Function_75)/10/69/1:Py2/1;     [Give Back Hero Spells Function]
!!DO(AC_Function_76)/86/89/1:Py2/2;     [Give Back Hero Spells Function Books]
!!DO(AC_Function_76)/1011/1070/1:Py2/2; [Give Back Hero Spells Function Scrolls]
!!DO(AC_Function_77)/10/69/1:Py2;       [Reset Book Spells Vars]
*!FU(Restore_Special_Spell_Mana_Cost):Py2;                                      [Reset Special Spell Mana Cost Attacker]
!!HEy2:A2/128/?y10/?y11;
!!HEy2&y11=1:A3/128/1/1;
!!HEy2&y11=1:A4/128;                    [Reequip Armageddon Blade after fight]
!!HEy2&y11=1:Fd-3/d-3/d-3/d-6;          [Reduce Stats to compensate for AM stats]
*!HEy2:A2/124/?y10/?y11;
*!HEy2&y11=1:A3/124/1/1;
*!HEy2&y11=1:A4/124;                                                            [Reequip 124 Spellbinder's Hat  after fight]
!!en;

!!BA:H1/?y3;                            [For Defender]
!!SN:W^Magic_Specialists_Def_Spells_Saved^/?y1;
!!if&y3>=0/y1=1;
!!DO(AC_Function_75)/10/69/1:Py3/1;     [Give Back Hero Spells Function]
!!DO(AC_Function_76)/86/89/1:Py3/2;     [Give Back Hero Spells Function Books]
!!DO(AC_Function_76)/1011/1070/1:Py3/2; [Give Back Hero Spells Function Scrolls]
!!DO(AC_Function_77)/10/69/1:Py3;       [Reset Book Spells Vars]
*!FU(Restore_Special_Spell_Mana_Cost):Py3;                                      [Reset Special Spell Mana Cost]
!!HEy3:A2/128/?y10/?y11;
!!HEy3&y11=1:A3/128/1/1;
!!HEy3&y11=1:A4/128;                    [Reequip Armageddon Blade after fight]
!!HEy3&y11=1:Fd-3/d-3/d-3/d-6;          [Reduce Stats to compensate for AM stats]
*!HEy3:A2/124/?y10/?y11;
*!HEy3&y11=1:A3/124/1/1;
*!HEy3&y11=1:A4/124;                                                            [Reequip 124 Spellbinder's Hat  after fight]
!!en;

!!SN:W^Magic_Specialists_Att^/0;        [Reset extra Cast at Battle End]
!!SN:W^Magic_Specialists_Def^/0;
!!SN:W^Sorcery_Specialists_Cast_Counter^/0;
!!SN:W^Elemental_Specialists_Cast_Counter^/0;
!!SN:W^Magic_Specialists_Def_Spells_Saved^/0;
!!SN:W^Magic_Specialists_Att_Spells_Saved^/0;
!!DO(AC_Function_78)/0/25/1:P;          [Reset Cast Counter at Battle End]


********************************************************************************
!?BR&v997>=1/1000;

!!BH0:N?y2;                             [For Attacker]
!!SN:W^Magic_Specialists_Att_Spells_Saved^/?y1;
!!if&y2>=0/y1=1;
!!DO(AC_Function_75)/10/69/1:Py2;       [Give Back Hero Spells Function]
*!FU(Restore_Special_Spell_Mana_Cost):Py2;                                      [Reset Special Spell Mana Cost]
!!en;

!!BH1:N?y3;                             [For Defender]
!!SN:W^Magic_Specialists_Def_Spells_Saved^/?y1;
!!if&y3>=0/y1=1;
!!DO(AC_Function_75)/10/69/1:Py3;       [Give Back Hero Spells Function]
*!FU(Restore_Special_Spell_Mana_Cost):Py3;                                      [Reset Special Spell Mana Cost]
!!en;


********************************************************************************
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

*!IF:M^Eins %Y4 und %Y2 und %Y3 und %Y5 und %Y6 und %Y7^;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;    [fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]

!!BG:Q?y1;                              [Acting Side]
!!BHy1:N?y2;                            [Hero Number]
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y3>=10/y3<=69/y20=1;

!!HEy2&y2>-1:X?y5/?y6/?y7/?y8/?y9/?y10/?y11; [Check Hero Speciality]
!!if&y5=3/y6>=13/y6<=26;               [If spell specialist and its damage spell increase spell counter]
!!SN&y1=0:W^Magic_Specialists_Att^/?y4; [Extra Cast Variable Attacker]
!!SN&y1=1:W^Magic_Specialists_Def^/?y4; [Extra Cast Variable Defender]

!!DO(AC_Function_79)/10/69/1&y5=3/y4>0/y3<>y6:Py2/y3/y6; [Remove Hero Spells Fkt if Spell was not Specialist Spell]

!!if&y3=y6;                            [Extra Mana Cost Handling]
*!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;                         [Increase Battle Round Special Spell Cast Counter by 1]
*!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;
!!en;
!!en;
!!en;
!!en;

**************Some Heroes will get extra cast to bring them on level with other strong multicast Heroes**********
!?BF;

!!SN:W^Special_Hero_Extra_Cast_Att^/0;  [Reset Extra Cast Counter before any Battle]
!!SN:W^Special_Hero_Extra_Cast_Def^/0;

!!BA:H0/?y1;
!!if|y1=9/y1=10/y1=14/y1=25/y1=40/y1=46/y1=59/y1=61/y1=77/y1=95/y1=107/y1=108/y1=120/y1=137/y1=139;
  !!HEy1:E?y2/?y3/1;
  !!SN&y3>=20:W^Special_Hero_Extra_Cast_Att^/1; [Give one Extra Cast for Level 20]
  !!SN&y3>=40:W^Special_Hero_Extra_Cast_Att^/2; [Give two Extra Cast for Level 40]
!!en;

!!BA:H1/?y1;
!!if|y1=9/y1=10/y1=14/y1=25/y1=40/y1=46/y1=59/y1=61/y1=77/y1=95/y1=107/y1=108/y1=120/y1=137/y1=139;
  !!HEy1:E?y2/?y3/1;
  !!SN&y3>=20:W^Special_Hero_Extra_Cast_Def^/1; [Give one Extra Cast for Level 20]
  !!SN&y3>=40:W^Special_Hero_Extra_Cast_Def^/2; [Give two Extra Cast for Level 40]
!!en;
9 Adela, 10 Cuthbert, 14 Loynis, 25 Uland, 40 Astral, 46 Cyra, 61 Ash, 59 Olema, 77 Xsi, 95 Darkstorn,
107 Terek, 108 Zubin, 120 Mirlanda, 137 Brissa, 139 Labetha,


!?BG1;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;
!!BA:Q?f;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Magic_Specialists_Att^/?y8; [Check Cast Variable Attacker]
!!SN&y1=1:W^Magic_Specialists_Def^/?y8; [Check Cast Variable Defender]

*!IF:M^Eins %Y4 und %Y2 und %Y3 und %Y5 und %Y6 und %Y7^;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;[fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]
  !!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y2; [Check Cast Variable Attacker]
  !!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y2; [Check Cast Variable Defender]
  !!FU&y2<=0:E;
  !!BHy1:M?y3;
  !!FU&y3=0:E;
  !!BHy1:M0;                            [Renable Cast]

  !!SN:T^AC_Misc.Specialists Extra Cast^/?z-1;
  !!BU&1000/f=0:Mz-1;
  !!VRz1:S^FORTUNE^;
  !!SN&1000/f=0:Pz1;
  !!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/d-1; [Decrease Extra Cast Counter]
  !!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/d-1;
!!en;



********************************************************************************
!?FU(OnBattleRegeneratePhase);          [Set Spell Points and Reset Spell Points]

!!FU:E;                                 [Test Disabled Mana Cost increase for Special Spells]
!!SN:X?y1/?y2/0;                        [get who moves]
!!VRy2:Sy1:21;                          [get side]
!!BHy2:N?y1;                            [get owner]

!!if&y1>=0;
!!FU(Restore_Special_Spell_Mana_Cost):Py1/0; [Reset Special Spell Mana Cost]
!!FU(Restore_Special_Spell_Mana_Cost):Py1/1; [Reset Special Spell Mana Cost]

!!SN&y2=0:W^Magic_Specialists_%V997_Cast_Count_Att^/?y77;
!!SN&y2=1:W^Magic_Specialists_%V997_Cast_Count_Def^/?y77;
!!VRy77:+1;                             [Add +1 for correct Mana increase]

!!HEy1:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;  [Check Hero Speciality]

!!if&y5=3/y6>=13/y6<=26;               [If spell specialist and its damage spell increase spell counter]

!!HEy1:S14/?y30 S15/?y31 S16/?y32 S17/?y33; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien]

!!VRy12|y6=17/y6=19/y6=25:S1;           [Air]
!!VRy12|y6=18/y6=23/y6=24:S2;           [Earth]
!!VRy12|y6=21/y6=22/y6=26:S4;           [Fire]
!!VRy12|y6=16/y6=20:S8;                 [Water]
!!VRy12&y6=15:S15;                      [Magic Arrow]

!!SSy6&y12=1:Cy31/?y20;                 [Determine Mana Cost by Spell School]
!!SSy6&y12=2:Cy33/?y20;
!!SSy6&y12=4:Cy30/?y20;
!!SSy6&y12=8:Cy32/?y20;
!!SSy6&y12=15:C3/?y20;

!!VRy21:Sy20 *y77;

!!SSy6&y12=1:Cy31/y21;                  [Set Mana Cost by Spell School and times Cast]
!!SSy6&y12=2:Cy33/y21;
!!SSy6&y12=4:Cy30/y21;
!!SSy6&y12=8:Cy32/y21;
!!SSy6&y12=15:C3/y21;
!!en;
!!en;

********************************************************************************
!?BG1&1000;                             [Speciality extra cast per combat]

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;
!!BA:Q?f;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

*!IF:M^Eins %Y4 und %Y2 und %Y3 und %Y5 und %Y6 und %Y7^;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;    [fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]

!!SN&y1=0:W^Magic_Specialists_Att^/?y2; [Check Cast Variable Attacker]
!!SN&y1=1:W^Magic_Specialists_Def^/?y2; [Check Cast Variable Defender]

!!FU&y2<=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;                              [Renable Cast]

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!SN:T^AC_Misc.Specialists Extra Cast^/?z-1;
!!BU&1000/f=0:Mz-1;
!!VRz1:S^FORTUNE^;
!!SN&1000/f=0:Pz1;

!!SN&y1=0:W^Magic_Specialists_Att^/d-1;
!!SN&y1=1:W^Magic_Specialists_Def^/d-1;
!!en;

************************** Sorcery Specialists *********************************
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;    [fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]

!!BHy1:N?y2;                            [Hero Number]
!!FU&y2=-1:E;
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y3>=10/y3<=69/y20=1;
!!HEy2:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;
!!if&y5=0/y6=25;                       [If Sorcery Specialist]
!!HEy2:Ed/?y60/1;
!!SN:W^Sorcery_Specialists_Cast_Counter^/?y1;
!!FU&y1=1/y60<20:E;
!!FU&y1=2/y60<40:E;
!!FU&y1=3/y60<50:E;
!!FU&y1=4/y60<80:E;
!!FU&y1=5/y60<100:E;
!!FU&y1=6:E;
!!SN:W^Sorcery_Specialists_Sec_Cast^/1;
!!DO(AC_Function_79)/10/10/1:Py2;       [Remove Quicksand]
!!DO(AC_Function_79)/12/12/1:Py2;       [Remove Force Field]
!!DO(AC_Function_79)/14/14/1:Py2;       [Remove Earthquake]
!!DO(AC_Function_79)/27/69/1:Py2;       [Remove Spells 27-69]
!!en;
!!en;
!!en;
**Gird the Battle Mage
**Malekith the Warlock
**Sandro the Necromancer
**Styg the Witch
**Zydar the Heretic

!?BG1&1000;

!!SN:W^Sorcery_Specialists_Sec_Cast^/?y1;
!!FU&y1<>1:E;

!!BG:Q?y10;                             [Acting Side]
!!BHy10:N?y2;                           [Hero Number]
!!FU&y2=-1:E;
!!HEy2:Ed/?y60/1;
!!VRy61:S0T100;
!!VRy60:+14;
!!VRy62&y61<y60:S1;

!!if&y62=1;
!!BA:Q?f;
!!BHy10:M0;

!!SN&y10=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y10=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^FORTUNE^;
!!SN&f=0:Pz-1;
!!SN:T^AC_Misc.Sorcery Specialists Extra^/?z-1;
!!BU&1000/f=0:Mz-1;
!!SN:W^Sorcery_Specialists_Cast_Counter^/d+1;
!!en;
!!SN:W^Sorcery_Specialists_Sec_Cast^/0;


************************** Elemental Specialists Multi Cast*******************************
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!SN&y1=0:W^Magic_Week_41_att^/?y3;
!!SN&y1=1:W^Magic_Week_41_def^/?y3;
!!SN:W^Magic_Week_Spell_Element^/?y5;
!!SN&y1=0:W^Elemental_Set_att^/?y6;
!!SN&y1=1:W^Elemental_Set_def^/?y6;
!!SN&y1=0:W^Master_Mage_Extra_Cast_att^/?y7;
!!SN&y1=1:W^Master_Mage_Extra_Cast_def^/?y7;
!!SN&y1=0:W^Special_Hero_Extra_Cast_Att^/?y8;
!!SN&y1=1:W^Special_Hero_Extra_Cast_Def^/?y8;

!!if&y4=0/y2=0/y3=0/y5=0/y6=0/y7=0/y8=0;    [fix with Double Cast mod and Magic Week 34,41 37,38,39,40 and Wizards Knowledge]
!!BHy1:N?y2;                            [Hero Number]

!!FU&y2=-1:E;
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y3>=10/y3<=69/y20=1;              [If Hero Cast and Spell]
!!HEy2:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;
!!FU&y5<>0:E;                           [Exit if not a secondary skill Specialist]

!!if|y6=14/y6=15/y6=16/y6=17;          [Fire, Air, Water, Earth Magic]
!!HEy2:Ed/?y60/1;
!!SN:W^Elemental_Specialists_Cast_Counter^/?y1;
!!FU&y1=1/y60<25:E;
!!FU&y1=2/y60<40:E;
!!FU&y1=3/y60<60:E;
!!FU&y1=4/y60<80:E;
!!FU&y1=5/y60<100:E;
!!FU&y1=6:E;
!!SN:W^Elemental_Specialists_Sec_Cast^/1;

!!FU(MSR_Determine_Spell_Type):Py3/?y20/?y21/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
!!DO(AC_Function_80)/10/69/1&y6=14/y22<>4:Py2/y6/4; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
!!DO(AC_Function_80)/10/69/1&y6=15/y22<>1:Py2/y6/1; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
!!DO(AC_Function_80)/10/69/1&y6=16/y22<>8:Py2/y6/8; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
!!DO(AC_Function_80)/10/69/1&y6=17/y22<>2:Py2/y6/2; [Remove Spells, Pass Hero Number, Hero Speciality, School of Spell]
*!IF:M^School y6 is%Y6 and School of Spell y22 is%Y22 and Hero y2 is%Y2 and casts y1 is%Y1^;
!!en;
!!en;
!!en;
**Geon 92
**Malcom 28
**Nimbus 75
**Oris 110
**Sanya 13
**Serena 42
**Tiva 127 (replaced as Luck Specialist)

!?BG1&1000;

!!SN:W^Elemental_Specialists_Sec_Cast^/?y1;
!!FU&y1<>1:E;

!!BA:Q?f;
!!BG:Q?y10;                             [Acting Side]
!!BHy10:N?y2;                           [Hero Number]
!!FU&y2=-1:E;
!!HEy2:Ed/?y60/1;
!!VRy61:S0T100;
!!VRy60:+14;
!!VRy62&y61<y60:S1;

!!if&y62=1;
!!BHy10:M0;

!!SN&y10=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y10=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^FORTUNE^;
!!SN&1000/f=0:Pz-1;
!!SN:T^AC_Misc.Elemental Specialists Extra^/?z-1;
!!BU&1000/f=0:Mz-1;
!!SN:W^Elemental_Specialists_Cast_Counter^/d+1;
!!en;
!!SN:W^Elemental_Specialists_Sec_Cast^/0;


********************************************************************************
***Hero Class Bonus Handling 1% SP per two Heroes Level ***
!?MR1&1000;

!!FU:E;   Disabled for now!

!!UN:P39/?y1;                                                                   [Check if Hero Specialisation Boost ins enabled in WoG]
!!FU&y1=0:E;                                                                    [Exit if disabled]

!!BG:S?y50;                                                                     [Spell Number]
!!BG:A?y20;                                                                     [Aktion]
!!if&y50>=10/y50<=69/y20=1;
!!BG:Q?y1;
!!BHy1:N?y10;
!!HEy10:Ed/?y1/1;                       [Get Level]
!!HEy10:B2/?y2;                         [Get Class]
!!VRy3:Sy2 %2;
!!VRy3&y3=1:Sy1:2 +100;                 [If 1 is Mage Class set y3 to Hero level/2 to increase Magic Damage]

!!if&y3>0;
!!MR:F?y4;                              [Get magic damage]
!!VRy5:Sy4 *y3:100;
!!MR:Fy5;                               [apply increased damage]
!!en;
!!en;

********************************************************************************
***Elemental Specialists Deal +15% Bonus Damage***
!?MR1;
!!FU:E; Test

!!BG:S?y50;                             [Spell Number]
!!BG:A?y20;                             [Aktion]
!!if&y50>=10/y50<=27/y20=1;            [If Hero Cast and Damage Spell]
!!BG:Q?y1;
!!BHy1:N?y10;
!!FU&y10<0:E;                           [Exit if no Valid Hero]

!!HEy10:X?y23/?y24/?y25/?y26/?y27/?y28/?y29; [Check Hero Speciality]
!!FU&y23<>0:E;                          [Exit if no Secondary Skill Specialists]
*!IF:M^Spell %Y50   Hero %Y10  School %Y22 y3 %Y3 and Damage %Y4  and Specialisation %Y24 and y23 is %Y23^;
!!FU(MSR_Determine_Spell_Type):Py50/0/0/?y22; [y22 Holds Spell School]  [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]

!!VRy3:S100;
!!VRy3&y24=14/y22=4:S115;               [Set Fire Spells to +15% Damage]
!!VRy3&y24=15/y22=1:S115;               [Set Air Spells to +15% Damage]
!!VRy3&y24=16/y22=8:S115;               [Set Water Spells to +15% Damage]
!!VRy3&y24=17/y22=2:S115;               [Set Fire Spells to +15% Damage]
!!FU&y3<>115:E;


14 Fire Magic
15 Air Magic
16 Water Magic
17 Earth Magic

!!if&y3>0;
!!MR:F?y4;                              [Get magic damage]
*!IF:M^Spell %Y50   Hero %Y10  School %Y22 y3 %Y3 and Damage %Y4  and Specialisation %Y24^;
!!VRy5:Sy4 *y3:100;
!!MR:Fy5;                               [apply increased damage]

!!en;
!!en;


********************************************************************************
**Special Spell Crit Handling**
!?MR1&1000;                             [Magic Res Trigger for Crit]

!!FU:E;                                 [Disabled for now]

!!UN:P39/?y1;                           [Check if Hero Specialisation Boost ins enabled in WoG]
!!FU&y1=0:E;                            [Exit if disabled]

!!SN:W^Critical_Sorcery_Mod^/?y1;       [If Critical Sorcery Mod enabled disable that part of Code]
!!FU&y1=1:E;

!!BG:H?y1;                              [Determine if AI controlls Hero]
!!HEy1:O?y1;
!!OW:Iy1/?y1;
!!FU&y1=1:E;

!!UN:C6919200/4/?y1;                    [y1 - combatmanager]
!!VRy2:Sy1 +78532;                      [y2 - _ptr_ autoCombat]
!!UN:Cy2/1/?y3;                         [y3 - autoCombat status]
!!FU&y3=1:E;                            [Exit in Quick Combat]

!!BG:Q?y4;
!!BA:Hy4/?y4;
!!FU&y4=-2:E;

!!HEy4&y4>=0:X?y21/?y22/?y23/?y24/?y25/?y26/?y27; [Check Hero Speciality]
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:S?y2;                              [Falls Aktion ein Cast ist dann Speichere 1 in y2]
!!FU&y2<=9|y2>69:E;
!!FU&y22<>y2:E;                         [Exit if spell is not speciality]

!!MR:F?y3;                              [Speichere DMG in y3]
!!FU&y3<=0:E;

!!MR:N?y5;                              [return Creature number which took magic damage]

!!if&y5>=0/y5<=41;
!!HEy4:S18/?y17 S8/?y21;                [check for Bildung in y17 Bildung macht 50% mehr Schaden] [Checke ob der Held Mystik hat und Speichere in y21]
!!HEy4:E?y15/?y16/1;                    [Checke das Level vom Helden und Speichern in y16]
!!VRy9:S0T100;                          [y9 chance to crit (0..99)]

!!if&y9<y16;
!!VRy99:S100;
!!VRy99:+50;                            [Normaler Crit wenn LvL kleiner als Random Wert ist]
!!VRy3:*y99:100;

!!MR:Fy3;                               [apply new damage]
!!BMy5:V82;                             [show crit animation]
!!en;
!!en;


******************************** Bonus Handling*********************************
***Haste***Stoneskin***Bloodlust***Bless***Disrupting Ray***Precision***Weakness
!?BG0&1000;

!!BA:Q?y1;                              [Exit if Quick Combat]
!!FU&y1=1:E;

!!BG:Q?y1;                              [Acting Side]
!!BHy1:N?y2;                            [Hero Number]
!!FU&y2=-1:E;
!!BG:S?y3;                              [Spell Number]
!!BG:A?y20;                             [Aktion]

!!if&y3>=27/y3<=69/y20=1;
!!HEy2:X?y5/?y6/?y7/?y8/?y9/?y10/?y11;
*!IF:M^%Y5 und %Y6 und %Y7 und %Y8 und %Y9 und %Y10 und %Y11^;

!!if&y5=3/y6=43/y3=43;                 [If Bloodlust Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS43:Ey61/?y10;                       [Get Bloodlust Power]
!!SN:W^Bloodlust_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :10 +y10;
!!SS43:Ey61/y60;                        [Set New Power]
!!SN:W^Bloodlust_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=46/y3=46;                 [If Stoneskin Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS46:Ey61/?y10;                       [Get Stoneskin Power]
!!SN:W^Stoneskin_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :10 +y10;
!!SS46:Ey61/y60;                        [Set New Power]
!!SN:W^Stoneskin_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=53/y3=53;                 [If Haste Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS53:Ey61/?y10;                       [Get Haste Power]
!!SN:W^Haste_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :20 +y10;
!!SS53:Ey61/y60;                        [Set New Power]
!!SN:W^Haste_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=41/y3=41;                 [If Bless Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS41:Ey61/?y10;                       [Get Bless Power]
!!SN:W^Bless_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :25 +y10;
!!SS41:Ey61/y60;                        [Set New Power]
!!SN:W^Bless_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=42/y3=42;                 [If Curse Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS42:Ey61/?y10;                       [Get Curse Power]
!!SN:W^Curse_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :25 +y10;
!!SS42:Ey61/y60;                        [Set New Power]
!!SN:W^Curse_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=47/y3=47;                 [If Disrupting Ray Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS47:Ey61/?y10;                       [Get Disrupting Ray Power]
!!SN:W^Disrupting Ray_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 +5 :10 +y10;
!!SS47:Ey61/y60;                        [Set New Power]
!!SN:W^Disrupting Ray_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=44/y3=44;                 [If Precision Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS44:Ey61/?y10;                       [Get Precision Power]
!!SN:W^Precision_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 +5 :10 +y10;
!!SS44:Ey61/y60;                        [Set New Power]
!!SN:W^Precision_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=55/y3=55;                 [If Slayer Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS55:Ey61/?y10;                       [Get Slayer Power]
!!SN:W^Slayer_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 +5 :10 +y10;
!!SS55:Ey61/y60;                        [Set New Power]
!!SN:W^Slayer_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=45/y3=45;                 [If Weakness Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS45:Ey61/?y10;                       [Get Weakness Power]
!!SN:W^Weakness_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :10 +y10;
!!SS45:Ey61/y60;                        [Set New Power]
!!SN:W^Weakness_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=48/y3=48;                 [If Prayer Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Air Magic Skill]
!!SS48:Ey61/?y10;                       [Get Prayer Power]
!!SN:W^Prayer_Specialist_Start^/y10;
!!VRy60:Sy62 +y63 :25 +y10;
!!SS48:Ey61/y60;                        [Set New Power]
!!SN:W^Prayer_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=38/y3=38;                 [If Resurrection Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS38:Ey61/?y10;                       [Get Resurrection Power]
!!SN:W^Resurrection_Specialists_Start^/y10;
!!VRy60:Sy62 +y63 *20 +y10;
!!SS38:Ey61/y60;                        [Set New Power]
!!SN:W^Resurrection_Specialists_Flag^/1;
!!en;

!!if&y5=3/y6=39/y3=39;                 [If Animate Dead Specialist]
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS39:Ey61/?y10;                       [Get Animate Dead Power]
!!SN:W^Animate_Specialists_Start^/y10;
!!VRy60:Sy62 +y63 *20 +y10;
!!SS39:Ey61/y60;                        [Set New Power]
!!SN:W^Animate_Specialists_Flag^/1;
!!en;

!!SN:W^Buff_Specialists_Flag^/1;
!!en;

*************
!?BG1&1000;

!!SN:W^Buff_Specialists_Flag^/?y1;
!!FU&y1<>1:E;

!!BG:Q?y1;                              [Acting Side]
!!BHy1:N?y2;                            [Hero Number]
!!FU&y2=-1:E;

!!SN:W^Bloodlust_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS43:Ey61/?y10;                       [Get Bloodlust Power]
!!VRy60:Sy62 +y63 :10 *-1 +y10;
!!SS43:Ey61/y60;                        [Set New Power]
!!SN:W^Bloodlust_Specialists_Flag^/0;
!!en;

!!SN:W^Stoneskin_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS46:Ey61/?y10;                       [Get Stoneskin Power]
!!VRy60:Sy62 +y63 :10 *-1 +y10;
!!SS46:Ey61/y60;                        [Set New Power]
!!SN:W^Stoneskin_Specialists_Flag^/0;
!!en;

!!SN:W^Haste_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS53:Ey61/?y10;                       [Get Haste Power]
!!VRy60:Sy62 +y63 :20 *-1 +y10;
!!SS53:Ey61/y60;                        [Set New Power]
!!SN:W^Haste_Specialists_Flag^/0;
!!en;

!!SN:W^Bless_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS41:Ey61/?y10;                       [Get Bless Power]
!!VRy60:Sy62 +y63 :25 *-1 +y10;
!!SS41:Ey61/y60;                        [Set New Power]
!!SN:W^Bless_Specialists_Flag^/0;
!!en;

!!SN:W^Curse_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS42:Ey61/?y10;                       [Get Curse Power]
!!VRy60:Sy62 +y63 :25 *-1 +y10;
!!SS42:Ey61/y60;                        [Set New Power]
!!SN:W^Curse_Specialists_Flag^/0;
!!en;

!!SN:W^Disrupting Ray_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS47:Ey61/?y10;                       [Get Disrupting Ray Power]
!!VRy60:Sy62 +y63 +5 :8 *-1 +y10;
!!SS47:Ey61/y60;                        [Set New Power]
!!SN:W^Disrupting Ray_Specialists_Flag^/0;
!!en;

!!SN:W^Precision_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S15/?y61;                        [Get Air Magic Skill]
!!SS44:Ey61/?y10;                       [Get Precision Power]
!!VRy60:Sy62 +y63 +5 :10 *-1 +y10;
!!SS44:Ey61/y60;                        [Set New Power]
!!SN:W^Precision_Specialists_Flag^/0;
!!en;

!!SN:W^Slayer_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S14/?y61;                        [Get Fire Magic Skill]
!!SS55:Ey61/?y10;                       [Get Slayer Power]
!!VRy60:Sy62 +y63 +5 :10 *-1 +y10;
!!SS55:Ey61/y60;                        [Set New Power]
!!SN:W^Slayer_Specialists_Flag^/0;
!!en;

!!SN:W^Weakness_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Water Magic Skill]
!!SS45:Ey61/?y10;                       [Get Weakness Power]
!!VRy60:Sy62 +y63 :10 *-1 +y10;
!!SS45:Ey61/y60;                        [Set New Power]
!!SN:W^Weakness_Specialists_Flag^/0;
!!en;

!!SN:W^Prayer_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S16/?y61;                        [Get Air Magic Skill]
!!SS48:Ey61/?y10;                       [Get Prayer Power]
!!VRy60:Sy62 +y63 :25 *-1 +y10;
!!SS48:Ey61/y60;                        [Set New Power]
!!SN:W^Prayer_Specialists_Flag^/0;
!!en;

!!SN:W^Resurrection_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS38:Ey61/?y10;                       [Get Resurrection Power]
!!VRy60:Sy62 +y63 *20 *-1 +y10;
!!SS38:Ey61/y60;                        [Set New Power]
!!SN:W^Resurrection_Specialists_Flag^/0;
!!en;

!!SN:W^Animate_Specialists_Flag^/?y3;
!!if&y3=1;
!!HEy2:Ed/?y62/1;                       [Get Hero Level]
!!HEy2:Fd/d/?y63/d;                     [Get Spell Power]
!!HEy2:S17/?y61;                        [Get Earth Magic Skill]
!!SS39:Ey61/?y10;                       [Get Animate Dead Power]
!!VRy60:Sy62 +y63 *20 *-1 +y10;
!!SS39:Ey61/y60;                        [Set New Power]
!!SN:W^Animate_Specialists_Flag^/0;
!!en;


!!SN:W^Buff_Specialists_Flag^/0;

********************************************************************************
!?FU(AC_Function_79);                   [Remove Hero Spells]

!!HEx1&x16<>x3:Mx16/0;

!?FU(AC_Function_80);                   [Remove Hero Spells]

!!FU(MSR_Determine_Spell_Type):Px16/0/0/?y1; [y1 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
!!HEx1&x3<>y1:Mx16/0;                   [Remove all Spells Except Your Specialisation]

********************************************************************************
!?FU(AC_Function_74);                   [Save all Hero Spells]

!!HEx1:Mx16/?y1;
!!SN:W^Hero%X1_Spell%X16_Specialists^/y1;

!!HEx1&y1=1:M=x16/1;
!!SN&-1/y1=1:W^Hero%X1_Spell%X16_Flag1^/1; [if flag is zero the spell is saved because its learned from scroll or book]


********************************************************************************
!?FU(AC_Function_75);                   [Restore all Hero Spells]

!!SN:W^Hero%X1_Spell%X16_Specialists^/?y2;
!!HEx1:Mx16/y2;

!!SN&x2=1:W^Hero%X1_Spell%X16_Flag1^/?y1;[At battle end remove all spells learned from books]
!!HEx1&y1=1/x2=1:Mx16/0;


!?FU(AC_Function_76);

!!SN:W^Critical_Sorcery_Mod^/?y1;       [*If critical Sorcery is enabled disable the Set Count Fkt in Critical Sorcery Mod]
!!SN&y1=1:W^Critical_Sorcery_Book_Fix^/1;

!!HEx1&x2=2:A2/x16/?y15/?y14;           [check for books]
!!HEx1&x2=2/y14=1:A3/x16/1/1;           [remove books first]
!!HEx1&x2=2/y14=1:A4/x16;               [than reequip books]

!!SN&y1=1:W^Critical_Sorcery_Book_Fix^/0;[Activate again     Why disable again 12.2.2019]

********************************************************************************
!?FU(AC_Function_77);                   [Reset Vars after Combat]

!!SN:W^Hero%X1_Spell%X16_Specialists^/0;
!!SN:W^Hero%X1_Spell%X16_Flag1^/0;

!?FU(AC_Function_78);                   [Reset Vars after Combat]

!!SN:W^Magic_Specialists_%X16_Cast_Count_Att^/0;
!!SN:W^Magic_Specialists_%X16_Cast_Count_Def^/0;

********************************************************************************
!?FU(Set_Desc_Hero_Speciality);         [Set description for Hero Speciality]

!!HEx1:Ed/?y1/1;                        [Get Hero Level]
!!HEx1:Fd/d/?y60/d;                     [Get Spell Power]
!!HEx1:B0/?z-1;
!!HEx1:R2/?y70;
!!VRz-2&y70=0:S^%Z139120^;              [his]
!!VRz-2&y70=1:S^%Z139121^;              [her]
!!HEx1&x1>-1:X?y5/?y6/?y7/?y8/?y9/?y10/?y11; [Check Hero Speciality]


!!if&y5=3/y6=19;                       [45 Solomyr Cain Lightning]
!!VRy20:S15; *!VRz3:S^Chain Lightning^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=24;                       [72 Septienna Death Ripple]
!!VRy20:S15; *!VRz3:S^Death Ripple^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=13;                       [136 Luna Fire Wall]
!!VRy20:S10; *!VRz3:S^Fire Wall^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Fire Wall Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=16;                       [30 Alagar Ice Bolt]
!!VRy20:S8; *!VRz3:S^Ice Bolt^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=22;                       [57 Xyron Inferno]
!!VRy20:S13; *!VRz3:S^Inferno^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=23;                       [73 Aislinn Meteor Shower  93 Deemer]
!!VRy20:S12; *!VRz3:S^Meteor Shower^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=21;                       [63 Xarfax Fireball]
!!VRy20:S10; *!VRz3:S^Fireball^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=20;                       [11 Adelaide Frost Ring]
!!VRy20:S10; *!VRz3:S^Frost Ring^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=17;                       [Lightning Bolt]
!!VRy20:S10; *!VRz3:S^Lightning Bolt^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=18;                       [Implosion]
!!VRy20:S16; *!VRz3:S^Implosion^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Spell Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y5=3/y6=15;                       [138 Ciele Magic Arrow]
!!VRy20:S6; *!VRz3:S^Magic Arrow^; !!UN:N1/3/y6;
!!VRy16:Sy1 :y20; !!VRx2:Sy6; !!SN:T^AC_Misc.Magic Arrow Specialist^/?z4/^casts^/y20; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click  Spells]
!!en;

!!if&y6=25/y5=0;                       [104 Gird or 90 Malekith or 74 Sandro or 125 Styg or 62 Zydar  Sorcery]
!!FU(Skill_Value_Database):Px1/y6/y1/?y71; [Pass Hero Number, Skill, Hero Level, Return Value]

!!VRy17:S1; !!VRy17&y1>=25:S2; !!VRy17&y1>=40:S3; !!VRy17&y1>=60:S4; !!VRy17&y1>=80:S5;
!!VRy16:Sy1 +14; !!VRy16&y16>=100:S100; !!VRx2:S25; !!SN:T^AC_Misc.Sorcery Specialist^/?z4/^casts^/y17; !!VRx3:S1; !!SN:Iz4/?z4;
!!IF:Q1/20/80/4^%Z4^; !!CM:R0;          [show description for Hero Speciality when right click  Sorcery]
!!en;
**Gird the Battle Mage
**Malekith the Warlock
**Sandro the Necromancer
**Styg the Witch
**Zydar the Heretic

!!if&y5=0;
!!if|y6=14/y6=15/y6=16/y6=17;
!!VRy17:S1; !!VRy17&y1>=25:S2; !!VRy17&y1>=40:S3; !!VRy17&y1>=60:S4; !!VRy17&y1>=80:S5;
!!VRy16:Sy1 +14; !!VRy16&y16>=100:S100; !!VRx2&y6=14:S47; !!VRx2&y6=15:S50; !!VRx2&y6=16:S53; !!VRx2&y6=17:S56;
!!SN&y6=14:T^AC_Misc.Fire^/?z3; !!SN&y6=15:T^AC_Misc.Air^/?z3; !!SN&y6=16:T^AC_Misc.Water^/?z3; !!SN&y6=17:T^AC_Misc.Earth^/?z3;
!!SN:T^AC_Misc.Elemental Specialist^/?z4/^casts^/y17; !!SN:Iz4/?z4;
!!VRx3:S1; !!IF:Q1/20/x2/4^%Z4^; !!CM:R0;[show description for Hero Speciality when right click]
!!en;
!!en;
**Geon 92
**Malcom 28
**Nimbus 75
**Oris 110
**Sanya 13
**Serena 42
**Tiva 127 (Replaced as Luck Specialists)

!!if&y5=0/y6=8;                        [Mysticism  Specialists]
!!VRx2&y6=8:S8; !!VRy50:Sy1:2+1; !!SN:T^AC_Misc.Mysticism Specialist^/?z4; !!VRx3:S1; !!SN:Iz4/?z4; [Y50 Level/2 to get additional Spell Points Recovery]
!!IF:Q1/20/29/4^%Z4^; !!CM:R0;          [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=41;                       [9 Adela Bless]
*!VRz3:S^Bless^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :25; !!VRx2:Sy6; !!SN:T^AC_Misc.Bless Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=42;                       [Curse]
*!VRz3:S^Curse^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :25; !!VRx2:Sy6; !!SN:T^AC_Misc.Curse Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=43;                       [61 Ash Bloodlust]
*!VRz3:S^Bloodlust^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Bloodlust Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=46;                       [95 Darkstorm 139 Labetha 124 Merist 77 Xsi Stoneskin]
*!VRz3:S^Stoneskin^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Stoneskin Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=53;                       [137 Brissa 46 Cyra 107 Terek Haste]
*!VRz3:S^Haste^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :20; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Haste Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=47;                        [141 Aenain Disrupting Ray  (Outdated)]
*!VRz3:S^Disrupting Ray^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 +5 :8 +2; !!VRx2:Sy6; !!SN:T^AC_Misc.Disrupting Ray Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=44;                        [108 Zubin Precision]
*!VRz3:S^Precision^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 +5 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Precision Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=45;                       [10 Cuthbert 120 Mirlanda 59 Olema  Weakness]
*!VRz3:S^Weakness^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :10; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!SN:T^AC_Misc.Weakness Specialist^/?z4; !!VRx3:S0; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=48;                        [14 Loynis Prayer]
*!VRz3:S^Prayer^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 :25; !!VRy17:Sy16+3; !!VRy18:Sy16+2; !!VRy19:Sy16+1; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Prayer Specialist^/?z4; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=38;                        [Resurrection]
*!VRz3:S^Resurrection^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 *20; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Resurrection Specialist^/?z4; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=39;                        [Animate Dead]
*!VRz3:S^Animate Dead^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 *20; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Animate Specialist^/?z4; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;

!!if&y5=3/y6=55;                        [Slayer]
*!VRz3:S^Slayer^; !!UN:N1/3/y6;
!!VRy16:Sy60 +y1 +5 :10; !!VRx2:Sy6; !!VRx3:S0; !!SN:T^AC_Misc.Slayer Specialist^/?z4; !!SN:Iz4/?z4;
!!IF:Q1/9/y6/4^%Z4^; !!CM:R0;           [show description for Hero Speciality when right click]
!!en;
********************************************************************************





******************************************************************************
!?FU(Save_Special_Spell_Mana_Cost);     [Save Special Spell Mana Cost]
!!HEx1:S14/?y30 S15/?y31 S16/?y32 S17/?y33; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien]

!!VRy13|x2=17/x2=19/x2=25:S1;           [Air]
!!VRy13|x2=18/x2=23/x2=24:S2;           [Earth]
!!VRy13|x2=21/x2=22/x2=26:S4;           [Fire]
!!VRy13|x2=16/x2=20:S8;                 [Water]
!!VRy13&x2=15:S15;                      [Magic Arrow]

!!SSx2&y13=1:Cy31/?y20;                 [Determine Mana Cost by Spell School]
!!SSx2&y13=2:Cy33/?y20;
!!SSx2&y13=4:Cy30/?y20;
!!SSx2&y13=8:Cy32/?y20;
!!SSx2&y13=15:C3/?y20;

!!SN&x3=0:W^Magic_Specialists_Att_Mana_Spell^/y20;
!!SN&x3=0:W^Magic_Specialists_Att_Spell^/x2;
!!SN&x3=1:W^Magic_Specialists_Def_Mana_Spell^/y20;
!!SN&x3=1:W^Magic_Specialists_Def_Spell^/x2;


!?FU(Restore_Special_Spell_Mana_Cost);  [Restore Special Spell Mana Cost]
!!HEx1:S14/?y30 S15/?y31 S16/?y32 S17/?y33; [Checke current hero  Fire14 Air15 Water16 Earth17 Magien]

!!SN&x2=0:W^Magic_Specialists_Att_Mana_Spell^/?y20;
!!SN&x2=0:W^Magic_Specialists_Att_Spell^/?y12;
!!SN&x2=1:W^Magic_Specialists_Def_Mana_Spell^/?y20;
!!SN&x2=1:W^Magic_Specialists_Def_Spell^/?y12;

!!VRy13|y12=17/y12=19/y12=25:S1;        [Air]
!!VRy13|y12=18/y12=23/y12=24:S2;        [Earth]
!!VRy13|y12=21/y12=22/y12=26:S4;        [Fire]
!!VRy13|y12=16/y12=20:S8;               [Water]
!!VRy13&y12=15:S15;                     [Magic Arrow]

!!SSy12&y13=1:Cy31/y20;                 [Determine Mana Cost by Spell School]
!!SSy12&y13=2:Cy33/y20;
!!SSy12&y13=4:Cy30/y20;
!!SSy12&y13=8:Cy32/y20;
!!SSy12&y13=15:C3/y20;


!?FU(MSR_Determine_Spell_Type);
**Funtion to determine the Spell Type School**
[x1=spell number,  x2/y96 returns level (Level 1-5), x3/y97 returns type (Adventurer/Combat), x4/y98 returns element (Air 1, Earth 2, Fire 4 Water 8 )]
!!FU|x1<0/x1>69:E;
*!SSx1:L?y96;                           [Check level of Spell 1-5]
*!SSx1:F?i;                             [Get flag in i]
*!VRi:&2;                               [Check Flag for Adventure Spell]
*!VRy97&i>0:S1;                         [Set y97 to 1 if Adventure Spell]
*!SSx1:F?i;                             [Get flag in i]
*!VRi:&1;                               [Check Flag for Combat Spell]
*!VRy97&i>0:S2;                         [Set y97 to 2 if Combat Spell]

!!SSx1:S?y1;                            [Get spell's magic school bits]
!!VRy3:Sy1:1%2;                         [air. If bits of this spell contain school of air magic, this will be equal to 1]
!!VRy4:Sy1:2%2;                         [fire]
!!VRy5:Sy1:4%2;                         [water]
!!VRy6:Sy1:8%2;                         [earth]
!!VRy98&y3=1:S1;                        [air y3]
!!VRy98&y4=1:S4;                        [fire y4]
!!VRy98&y5=1:S8;                        [water y5]
!!VRy98&y6=1:S2;                        [earth y6]

!!VRx2:Sy96;
!!VRx3:Sy97;
!!VRx4:Sy98;
*!IF:M^Spell%X1  %X2 %X3 %X4^;
********************************************************************************

*-------------Castle-----------------------*
!#UN:G2/1/1/160; !#UN:G2/1/3/160;
!#UN:G2/2/1/161; !#UN:G2/2/3/161;
!#UN:G2/5/1/162; !#UN:G2/5/3/162;
!#UN:G2/7/1/164; !#UN:G2/7/3/164;
!#UN:G2/12/1/163; !#UN:G2/12/3/163;
!_#HE3:S5/2;  Sylvia has advanced Navigation
!#HE3:S21/0;                            [Sylvia Learning]
!#HE3:S6/0;
!#HE3:S4/1;

!#VRy10:S2T1;                           [starts with 1 stack of swordsman]
!#HE5:C0/2/6/y10;

!#HE8:S11/1;                            [Rion Eagle Eye instead of Wisdom]
!#HE8:S7/0;                             [Remove Wisdom]

!#HE9:S16/1;                            [Adela Water magic instead of Wisdom and Offense instead of Leadership]
!#HE9:S7/0;
!_#HE9:S22/1;
!#HE9:S6/0;

!#HE11:S8/1;                            [Adelaide Water Magic and Mysticism instead of Adv. Wisdom]
!#HE11:S16/1;
!#HE11:S7/0;
!#HE11:F0/0/2/3;                        [1 bonus knowledge]

!#HE12:C0/2/8/1;                        [Inghamn starts with 1 Monk]

!#UN:G2/13/1/305; !#UN:G2/13/3/305; !#HE13:X0/16; !#HE13:S11/0;  !#HE13:S16/1; [Sanya Water]
!#HE14:S7/0;                            [Loynis Water magic instead of Wisdom]
!#HE14:S16/1;
!#HE14:S7/0;                            [Loynis Water magic instead of Wisdom]
!#HE14:S16/1;

!#HE15:S7/0;                            [Caitlin remove Wisdom]
!#HE15:S24/0;                           [Remove Intelligence]
!#HE15:S11/1;                           [Give Eagle Eye]
!#HE15:S21/1;                           [Give Learning]
*------------------------------------------*


*-------------Rampart-----------------------*
!#UN:G2/17/1/169; !#UN:G2/17/3/169;
!#UN:G2/19/1/172; !#UN:G2/19/3/172;
!#UN:G2/21/1/170; !#UN:G2/21/3/170;
!#UN:G2/22/1/173; !#UN:G2/22/3/173;
!#UN:G2/31/1/171; !#UN:G2/31/3/171;

!#HE17:C0/2/14/15;                      [17 Ufretin starts some more Centaures]

!#HE18:S11/1;                           [Jenova Give Eagle Eye]
!#HE18:S5/1;                            [Jenova Give Nobility]
!#HE18:S1/0;                            [Remove Adv. Archery]

!#HE19:C0/2/22/1;                       [19 Ryland starts with 1 Dendroid]

!#VRy10:S4T2;                           [starts with 1 stack of elves]
!#HE21:C0/2/18/y10;

!#HE23:S3/1;                            [Kyrre Basic Scouting instead of Archery]
!#HE23:S1/0;

!#HE24:M55/0;                           [Ice Bolt instead of Slayer]
!#HE24:M16/1;
!#HE24:X0/7;                            [Coronius Now Wisdom Specialist]
!#HE24:S7/3;                            [Starts with Expert Wisdom]

!#HE25:A1/6/15;                         [Uland starts first aid Tent]
!#HE25:S7/1;                            [Basic Wisdom]
!#HE25:F0/2/3/2;                        [+2 Spell Power]

!#HE27:S27/1;                           [Gem Advanced First Aid instead of Basic and Diplomacy instead of Wisdom]
!#HE27:S4/1;
!#HE27:S7/0;
!#UN:G2/28/1/305; !#UN:G2/28/3/305; !#HE28:X0/16;  !#HE28:S11/0;  !#HE28:S16/1; [Malcom Water]

!#HE29:S7/0;                            [Melodia starts with Diplomancy instead of Wisdom]
!#HE29:S4/1;
!#HE29:M51/0;                           [Bloodlust instead of Fortune]
!#HE29:M43/1;
!#HE29:X0/4;                            [Diplomacy]
!#UN:G2/29/3/295;
!#UN:G2/29/1/295;

!#HE31:S22/1;                           [Aeris Offense]
!#HE31:S7/0;                            [no Wisdom]
!#HE31:S23/1;                           [Armourer]
!#HE31:S3/0;                            [no Scouting]
!#VRy10:S2T1;                           [starts with 1 stack of pegasus]
!#HE31:C0/2/20/y10;
*------------------------------------------*


*-------------Tower------------------------*
!#UN:G2/32/1/178; !#UN:G2/32/3/178;
!#UN:G2/44/1/180; !#UN:G2/44/3/180;
!#UN:G2/34/1/179; !#UN:G2/34/3/179;
!#UN:G2/38/1/177; !#UN:G2/38/3/177;
!#UN:G2/39/1/181; !#UN:G2/39/3/181;
!#UN:G2/37/1/182; !#UN:G2/37/3/182;
!#HE33:S18/1;                           [Thane Basic Scholar]
!#HE33:S25/1;
!#HE33:M15/0;                           [Lightning Bolt instead of Magic Arrow]
!#HE33:M17/1;
!#HE33:X0/18;                           [Thane Scholar Special]

!#HE35:S17/1;                           [Neela starts with Earth magic instead of Scholar]
!#HE35:S18/0;

!_#HE36:X1/176; Torosar Commander Special
!#HE36:X3/2;                            [Torosar Commander Special]
!#UN:G2/36/1/276; !#UN:G2/36/3/276;
!#HE36:S1/1;                            [Starts with Archery instead of Mysticism]
!#HE36:S8/0;

!#HE37:S18/0;                           [Fafner Replace Basic Scholar with Luck]
!#HE37:S9/1;

!#HE38:S8/0;                            [Rissa starts with Archery and Air Magic instead of Mysticism and Offense]
!#HE38:S22/0;
!#HE38:S1/1;
!#HE38:S15/1;
!#HE38:X1/28;                           [Gremlin Specialist   changed from 29]
!#VRy10:S30 R10;                        [Rissa starts with Master Gremlins]
!#HE38:C0/0/29/y10;
!#VRy10:S30 R10;
!#HE38:C0/1/29/y10;
!#VRy10:S30 R10;
!#HE38:C0/2/29/y10;
!#HE38:F0/1/1/2;                        [Down from 1/1/2/2]

!#HE39:S18/0;                           [Iona Replace Basic Scholar with Leadership]
!#HE39:S6/1;
!#HE39:C0/2/36/1;                       [Iona starts with 1 genie instead of possible golems]
!#UN:G2/39/1/39; !#UN:G2/39/3/39;

!#HE40:F0/0/4/3;                        [+2 Spell Power  40 Astral]

!#UN:G2/42/1/292; !#UN:G2/42/3/292; !#HE42:X0/15; !#HE42:S11/0;  !#HE42:S15/1; [Serena Air]

!#HE43:S7/0;                            [Daremyth starts with Diplomacy, Learning instead of Wisdom and Intelligence.]
!#HE43:S24/0;
!#HE43:S4/1;
!_#HE43:S2/1;, Logistics(no)
!#HE43:S21/1;
!#HE43:X0/4;

!#HE44:S16/1;                           [Theodorus Water Magic instead of Wisdom, Archery instead of Ballistics]
!#HE44:S7/0;
!#HE44:S1/1;
!#HE44:S10/0;
!#HE44:M63/1;                           [Teleport instead of Shield]
!#HE44:M27/0;
!#VRy10:S3T1;                           [starts with 2 stacks 3-4 Mages and a possible stack of 5-7 stone gargoyles]
!#HE44:C0/0/34/y10;
!#VRy10:S4T1;
!#HE44:C0/1/34/y10;
!#VRy10:S5T2;
!#HE44:C0/2/30/y10;

!#HE45:S8/1;                            [Solmyr starts with Mysticism and Wisdom instead of Sorcery]
!#HE45:S7/1;
!#HE45:S25/0;

!#HE46:S15/1;                           [Cyra starts with Air magic instead of Leadership]
!#HE46:S6/0;
!#HE46:S7/0;                            [Removes Wisdom]
!#HE46:S20/1;                           [Artillery instead of Diplomacy]
!#HE46:S4/0;
!#HE46:A1/4/13;                         [Cyra starts with a Ballista war machine]

!#HE47:S6/0;                            [Aine Remove Wisdom and Scholar]
!#HE47:S7/0;                            [Removes Wisdom]
!#HE47:S18/0;                           [Removes Scholar]
!#HE47:S13/1;                           [Give Estate]
!#HE47:S4/1;                            [Give Diplomacy]
*------------------------------------------*


*-------------Inferno------------------------*
!#UN:G2/49/1/190; !#UN:G2/49/3/190;
!#UN:G2/50/1/188; !#UN:G2/50/3/188;
!#UN:G2/51/1/185; !#UN:G2/51/3/185;
!#UN:G2/53/1/186; !#UN:G2/53/3/186;
!#UN:G2/55/1/189; !#UN:G2/55/3/189;

!#HE48:S21/1;                           [Fiona starts with Learning in addition to Advanced Scouting]
!#HE48:S3/1;
!#HE48:X0/3;                            [Fiona Scouting specialist]
!#VRy10:S4T2;
!#HE48:C0/2/46/y10;
!#UN:G2/48/1/302; !#UN:G2/48/3/302;

!#HE49:S18/0;                           [Rashka starts with Leadership instead of Scholar]
!#HE49:S6/1;

!#VRy10:S3T1;                           [starts with 1 stack of Damons]
!#HE50:C0/2/48/y10;

!#HE52:S18/0;                           [Octavia remove Scholar and Offense and give Estate and Diplomacy]
!#HE52:S22/0;
!#HE52:S13/1;
!#HE52:S4/1;

!#HE55:C0/2/50/2;                       [55 Nymus starts with 2 Pit Fiends]

!#HE57:X3/22;                           [Xyron Inferno]
!#UN:G2/57/1/57; !#UN:G2/57/3/57;

!#HE59:S23/1;                           [Olema starts with Armourer instead of Leadership]
!#HE59:S6/0;
!#HE59:S7/0;                            [No Wisdom]
!#HE59:S16/1;                           [Water Magic]
!#HE59:S10/0;                           [Removes Ballistics]

!#HE60:S7/0;                            [Calid starts with Pathfinding instead of Wisdom.]
!#HE60:S0/1;                            [Set to basic Pathfinding]
!#HE60:S4/1;                            [Diplomacy]
!#HE60:S21/0;                           [no Learning]
!#HE60:X0/0;

!#HE61:S14/1;                           [Ash Fire Magic and Warfare instead of Wisdom and Eagle Eye]
!#HE61:S19/1;
!#HE61:S7/0;
!#HE61:S11/0;

!#HE62:M15/1;                           [Zydar starts with Magic Arrow instead of Stone skin (Stone skin? Like, for real?)]
!#HE62:M46/0;
!#HE63:S14/1;                           [Xarfax starts with Fire magic instead of Leadership]
!#HE63:S6/0;
!#HE63:S8/1;                            [Mysticism instead of Wisdom]
!#HE63:S7/0;
!#HE63:X3/57;
*------------------------------------------*


*-------------Necropolis------------------------*
!#UN:G2/64/1/193; !#UN:G2/64/3/193;
!#UN:G2/65/1/195; !#UN:G2/65/3/195;
!#UN:G2/66/1/196; !#UN:G2/66/3/196;
!#UN:G2/67/1/194; !#UN:G2/67/3/194;
!#UN:G2/68/1/197; !#UN:G2/68/3/197;
!#UN:G2/71/1/192; !#UN:G2/71/3/192;
!#UN:G2/79/1/156; !#UN:G2/79/3/156;

!#VRy10:S2T1;                           [starts with 1 stack of Vampires]
!#HE65:C0/2/62/y10;

!#HE66:C0/2/64/1;                       [66 Moandor 1 Liche]

!#VRy10:S4T2;
!#HE67:C0/2/60/y10;                     [67 Charna]

!#HE70:X0/22;                           [Clavius Offense specialist]

!#HE74:M15/1;                           [Sandro starts with Magic arrow instead of Slow]
!#HE74:M54/0;

!#UN:G2/75/1/296; !#UN:G2/75/3/296;
!#HE75:X0/17;
!#HE75:S11/0;
!#HE75:S17/1;                           [Nimbus Earth]

!#HE76:M39/1;                           [Thant starts with Reanimate Dead again.]
!#HE76:M46/0;

!#HE77:S17/1;                           [Xsi starts with Earth magic instead of Learning]
!#HE77:S21/0;

!#HE78:S12/1;                           [Vidomina starts with Learning and Basic Necro]
!#HE78:S21/1;
!#HE78:X0/21;                           [Learning]

!#HE79:S2/1;                            [Nagash Logistics]
!#HE79:S21/0;                           [No Learning]
!#HE79:S24/0;                           [No Intelligence]
*------------------------------------------*



*-------------Dungeon------------------------*
!#UN:G2/80/1/201; !#UN:G2/80/3/201;
!#UN:G2/82/1/205; !#UN:G2/82/3/205;
!#UN:G2/83/1/202; !#UN:G2/83/3/202;
!#UN:G2/84/1/204; !#UN:G2/84/3/204;     [84 Damacon 204 Medusa Queen  Specialist]
!#UN:G2/86/1/206; !#UN:G2/86/3/206;
!#UN:G2/87/1/200; !#UN:G2/87/3/200;

!#VRy10:S3T2;                           [starts with 1 stack of Harpy]
!#HE80:C0/2/72/y10;

!#HE82:C0/2/78/1;                       [82 Dace starts with 1 Minotaure]

!#VRy10:S4T2;                           [starts with 1 stack of Beholder]
!#HE83:C0/2/74/y10;

!#VRy10:S2T1;                           [starts with 1 stack of Medusa]
!#HE84:C0/2/76/y10;
!#HE84:X1/76;                           [Make him Medusa Specialist]
!#HE84:S13/1;                           [Damacon starts with Archery and Estates instead of Adv. Offense]
!#HE84:S1/1;
!#HE84:S22/0;

!#HE85:S13/1;                           [Gunnar starts with Basic Estates instead of Tactics]
!#HE85:S19/0;

!#HE90:M15/1;                           [Malekith starts with Magic Arrow instead of Bloodlust]
!#HE90:M43/0;

!#HE91:S13/1;                           [Jeddite starts with Estates and Scouting instead of adv. Wisdom]
!#HE91:S3/1;
!#HE91:S7/0;

!#UN:G2/92/1/296; !#UN:G2/92/3/296; !#HE92:X0/17; !#HE92:S11/0;  !#HE92:S17/1; [Geon Earth]

!#HE93:S17/1;                           [Deemer Earth and Intelligence instead Wisdom and Scouting]
!#HE93:S24/1;
!#HE93:S7/0;
!#HE93:S3/0;

!_#HE94:S2/1; Sephironth starts with Diplomacy, Logistics instead of Wisdom and Intelligence
!_#HE94:S4/1;
!#HE94:S13/2;                           [Sephironth starts with Adv. Estates instead of Wisdom and Intelligence]
!#HE94:S7/0;
!#HE94:S24/0;
!#HE94:S3/0;
!#HE94:M43/1;                           [Bloodlust instead of Air Protection.]
!#HE94:M30/0;
!#HE94:X0/13;                           [Estates Special]

!#HE95:S17/1;                           [Darkstorn starts with Earth magic instead of Learning]
!#HE95:S21/0;
!#HE95:S19/1;                           [Warfare instead of Wisdom]
!#HE95:S7/0;
*------------------------------------------*



*-------------Stronghold------------------------*
!#UN:G2/96/1/214; !#UN:G2/96/3/214;
!#UN:G2/98/1/211; !#UN:G2/98/3/211;
!#UN:G2/99/1/213; !#UN:G2/99/3/213;
!#UN:G2/100/1/209; !#UN:G2/100/3/209;
!#UN:G2/101/1/212; !#UN:G2/101/3/212;
!#UN:G2/103/1/210; !#UN:G2/103/3/210;

!#HE96:S1/1;                            [Yog starts with Archery instead of Ballistics]
!#HE96:S10/0;
!#HE97:S20/1;                           [Gurnisson starts with Artillery instead of Offense]
!#HE97:S22/1;

!#HE99:C0/2/92/1;                       [99 Shiva starts with one Bird]

!#VRy10:S2T1;                           [starts with 1 stack of 2-3 Ogers]
!#HE101:C0/2/90/y10;

!#HE104:M16/1;                          [Gird starts with Ice bolt instead of Bloodlust]
!#HE104:M43/0;

!_#HE105:X1/181; Vey is now Commander Specialist instead of Ogres
!#HE105:X3/2;
!#HE105:S19/1;                          [Warfare instead of Wisdom]
!#HE105:S7/0;

!#UN:G2/105/1/281; !#UN:G2/105/3/281;

!#HE106:A1/6/15;                        [Dessa starts first aid Tent]
!#HE106:S3/1;                           [Dessa starts with Scouting and Logistics instead of Wisdom and Logistics]
!#HE106:S7/0;

!#HE107:S15/1;                          [Terek starts with Air magic instead of Tactics]
!#HE107:S19/0;
!#HE107:S22/1;                          [Offense instead of Wisdom]
!#HE107:S7/0;

!#HE108:S15/1;                          [Zubin starts with Air magic instead of Wisdom]
!#HE108:S7/0;
!#HE108:A1/4/13;                        [ballista Zubin]

!#HE109:X0/3;                           [Gundula is now Scouting Specialist]
!#UN:G2/109/1/302; !#UN:G2/109/3/302;
!#HE109:S7/0;                           [Starts with Scouting instead of Wisdom and remove Offense and add Eagle Eye]
!#HE109:S3/1;
!#HE109:S22/0;
!#HE109:S11/1;

!#UN:G2/110/1/145; !#UN:G2/110/3/145; !#HE110:X0/14;  !#HE110:S11/0;  !#HE110:S14/1; [Oris Fire]

!#HE111:S7/0;                           [Saurug starts with Sorcery and Air Magic instead of Wisdom and Resitance.]
!#HE111:S26/0;
!#HE111:S15/1;
!#HE111:S25/1;
!#HE111:M43/0;                          [Lightning Bolt instead of Bloodlust]
!#HE111:M17/1;
!#HE111:X3/17;                          [Saurog Lightning]
*------------------------------------------*



*-------------Fortress------------------------*
!#UN:G2/112/1/219; !#UN:G2/112/3/219;
!#UN:G2/113/1/216; !#UN:G2/113/3/216;
!#UN:G2/114/1/217; !#UN:G2/114/3/217;
!#UN:G2/116/1/220; !#UN:G2/116/3/220;
!#UN:G2/117/1/218; !#UN:G2/117/3/218;
!#UN:G2/119/1/221; !#UN:G2/119/3/221;

!#VRy10:S2T1;                           [starts with 1 stack of Basilisks]
!#HE112:C0/3/106/y10;

!#VRy10:S5T3;                           [starts with 1 stack of Lizards]
!#HE114:C0/3/100/y10;                   [114 Wystan]

!#HE116:C0/3/102/1;                     [116 Alkin starts with 1 Gorgon]

!#VRy10:S4T2;                           [starts with 1 stack of Serpents]
!#HE117:C0/3/104/y10;                   [117 Korbac]

!#HE118:X0/19;                          [Gerwulf is now a Warfare Specialist]
!#HE118:S23/0;                          [Gerwulf starts with Warfare insteach of Armorer]
!#HE118:S19/1;

!#HE120:M29/1;                          [Mirlanda starts with Fire Shield in addition to Weakness]
!#HE120:S14/1;
!#HE120:S16/1;
!#HE120:S7/0;

!#HE122:S5/1;                           [Voy starts with Basic Nobility and Pathfinding instead of Expert Nobility and Wisdom]
!#HE122:S0/1;
!#HE122:S7/0;

!#HE123:S27/2;                          [Verdish starts with Advanced First Aid  instead of Wisdom and Basic FA]
!#HE123:S7/0;

!#HE124:S7/0;                           [Merist starts with Pathfinding, and Logistics instead of Wisdom and Learning]
!#HE124:S21/0;
!#HE124:S0/1;
!#HE124:S2/1;
!#HE124:X0/0;                           [Merist Pathfinding]

!#HE125:M20/1;                          [Styg starts with Frost Ring instead of Shield ->]
!#HE125:M27/0;                          [->]
!#HE125:S16/1;                          [-> and Water magic instead of Wisdom]
!#HE125:S7/0;

!#HE127:S9/2;                           [Tiva starts with Advanced Luck, Basic Eagle Eye]
!#HE127:S11/0;
!#HE127:S7/0;
!#HE127:F1/1/2/2;                       [Tiva also starts with least possible primary attributes]
!#HE127:M46/0;                          [Tiva doesn't know Stone Skin yet]
!#HE127:X0/9; Luck

*#HE127:S21/2;                          [Tiva starts with Advanced Learning, Basic Eagle Eye]
*#HE127:S11/1;
*#HE127:S7/0;
*#HE127:F1/1/1/1;                       [Tiva also starts with least possible primary attributes]
*#HE127:M46/0;                          [Tiva doesn't know Stone Skin yet]
*#HE127:X0/21;
!_#UN:G2/127/1/296; !_#UN:G2/127/3/296; !_#HE127:X0/17; !_#HE127:S11/0;  !_#HE127:S17/1; [Tiva Earth]
*------------------------------------------*


*-------------Conflux------------------------*
!_#HE128:X1/182;       [Pasis Commander Specialist]

!#SN:W^Zulu_Mod_On^/?y1;

!#HE128&y1=0:X3/2;
!#UN&y1=0:G2/128/1/282; !#UN&y1=0:G2/128/3/282;

!#HE129&y1=0:X3/67;                          [Thunar Earth Elemental Spell]
!#HE129&y1=0:A1/0/17;                        [Get spell book]
!#HE129&y1=0:M67/1;                          [Get Summon Earth Elemental]
!#HE129&y1=0:S13/0;
!#HE129&y1=0:S19/0;                          [Delete Tactics and Estates]
!#HE129&y1=0:S17/2;                          [Get Advanced Earth Magic]
!#HE129&y1=0:F0/0/1/3;                       [Adjust Primary Skills]

!#HE130&y1=0:S10/1;                          [Ignissa starts with Ballistics instead of Offense]
!#HE130&y1=0:S22/0;
!_#HE130:X1/130;                             [Ignissa Fire Bird Specialist]
!#HE130&y1=0:X3/2;                           [Make Her Master of Spell so Firebird gets no additional Bonus]
!#HE130&y1=0:F0/0/1/1;                       [Adjust Primary Skills to lowest Possible]

!#HE131&y1=0:X0/19;                          [Lacus Warfare Specialist]

!#UN&y1=0:G2/130/1/232; !#UN&y1=0:G2/130/3/232;
!#UN&y1=0:G2/132/1/231; !#UN&y1=0:G2/132/3/231;
!#UN&y1=0:G2/133/1/230; !#UN&y1=0:G2/133/3/230;
!#UN&y1=0:G2/134/1/229; !#UN&y1=0:G2/134/3/229;
!#UN&y1=0:G2/135/1/228; !#UN&y1=0:G2/135/3/228;
!#UN&y1=0:G2/141/1/227; !#UN&y1=0:G2/141/3/227;
132 Monere    !#HE132&y1=0:X1/120;
133 Erdamon   !#HE133&y1=0:X1/113;
134 Fiur      !#HE134&y1=0:X1/114;
135 Kalt      !#HE135&y1=0:X1/115;
141 Aenian    !#HE141&y1=0:X1/226;


!#HE133&y1=0:C0/2/113/1;                [133 Erdamon starts with 1 Earth Element]

!#VRy10&y1=0:S2T1;                      [starts with 2 stacks 4-5 Fire Elements]
!#HE134&y1=0:C0/2/114/y10;

!#VRy10&y1=0:S4T2;                      [starts with 2 stacks 4-5 Water Elements]
!#HE135&y1=0:C0/2/115/y10;              [135 Kalt]

!#HE137&y1=0:S9/1;
!#HE137&y1=0:S7/0;                      [Brissa Luck instead of Wisdom]

!#HE138&y1=0:S25/1;                     [Ciele starts with Sorcery instead of Wisdom]
!#HE138&y1=0:S7/0;
!#HE138&y1=0:F0/0/2/2;                  [Adjust Primary Skills]

!#HE139&y1=0:S27/1;                     [Labetha First aid instead of Wisdom]
!#HE139&y1=0:S7/0;
!#HE139&y1=0:A1/6/15;                   [starts with first aid Tent]

!#HE140&y1=0:M43/0;                     [Inteus starts with Fireball instead of Bloodlust]
!#HE140&y1=0:M21/1;
!#HE140&y1=0:X3/21;

!#UN&y1=0:G2/140/1/140;
!#UN&y1=0:G2/140/3/140;                 [Fireball Specialist]

!#HE141&y1=0:X1/112;                    [Aenain Air Elemental Specialist]
!#HE141&y1=0:F2/1/1/1;                  [Adjust Primary Skills]
!#HE141&y1=0:S7/0;                      [Starts with Warfare and Ballistics instead of Wisdom and Air Magic.]
!#HE141&y1=0:S15/0;
!#HE141&y1=0:S19/1;
!#HE141&y1=0:S10/1;                     [141 Aenain]
!#VRy10&y1=0:S5T2;                      [starts with 2 stacks 4-5 Air Elements]
!#HE141&y1=0:C0/2/112/y10;

!#HE142&y1=0:S7/0;                      [Gelare starts with Expert Learning instead of Wisdom and Water Magic]
!#HE142&y1=0:S16/0;
!#HE142&y1=0:S21/3;
!#HE142&y1=0:X0/21;                     [Gelare Learning]

!#HE143&y1=0:S7/0;                      [Grindan remove Wisdom and Earth]
!#HE143&y1=0:S17/0;
!#HE143&y1=0:S4/1;                      [Gives Estates and Diplomacy]
!#HE143&y1=0:S13/1;
!#HE145&y1=0:X0/14;                     [Adrienne Is Fire]

!#SN:W^H3_Fire Magic_0_Hero145^/1;      [Adrienne starts with Grandmaster Fire]
!#SN:W^H3_Fire Magic_1_Hero145^/1;
*------------------------------------------*
Extension Heroes
*#HE144&y1=0:X0/14;                     [144 Sir Mullich - Speed]
!#HE146&y1=0:X1/6;                      [146 Catherine - Crusader]
*#HE147&y1=0:X0/14;                     [147 Dracon Enchanters]
*#HE148&y1=0:X0/14;                     [148 Gelu Sharpshooters]
!#HE149&y1=0:X1/96;                     [149 Kilgor Behemots]
!#HE150&y1=0:X1/66;                     [150 Lord Haart Black Knight ]
*#HE151&y1=0:X1/14;                     [151 Mutare Dragons]
!#HE152&y1=0:X1/6;                      [152 Roland Crusaders]
*#HE153&y1=0:X1/14;                     [153 Mutare Drake Dragons]
*#HE154&y1=0:X0/14;                     [154 Boragus Ogers]
!#HE155&y1=0:X1/54;                     [155 Xeron Devils]

*Pictures
!#UN&y1=0:G2/146/1/162; !#UN&y1=0:G2/146/3/162;
!#UN&y1=0:G2/149/1/215; !#UN&y1=0:G2/149/3/215;
!#UN&y1=0:G2/150/1/197; !#UN&y1=0:G2/150/3/197;
!#UN&y1=0:G2/152/1/162; !#UN&y1=0:G2/152/3/162;
!#UN&y1=0:G2/154/1/212; !#UN&y1=0:G2/154/3/212;
!#UN&y1=0:G2/155/1/191; !#UN&y1=0:G2/155/3/191;


********************************************************************************



                        Magic Weeks Section



********************************************************************************


**V-Vars used: v2125
**Z-Vars used: Z710-Z712
**Function used: F7779, FU(AC_Function_84)
**Flags used: V891, V936


!?BG0&1000/-936;                        [Disable Triggers in Quick Combat]
!!BA:Q?y1;
!!IF&y1=1:V936/1;
!!FU&y1=1:E;

********************************************************************************
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerDay^>1/i^timerWeekDay^=1/i^timerIsAi^=0; [Trigger each monday]

!!VRy1:S0T46;                           [Set Random Week]
!!VRy1&y1=13:S13 R1;                    [Half chance for tripple Magic Arrow v=14 reserved]      *Fire]
!!VRy1&y1=15:S15 R1;                    [Half chance for quintuple Magic Arrow v=16 reserved]   *Water]
!!VRy1&y1=11:S11 R1;                    [Half chance for Implosion Bonus v=12 reserved]        *Earth]
!!VRy1&y1=17:S17 R1;                    [Half chance for Lightning Strike Bonus v=18 reserved]*Air]
!!VRy1&y1=19:S19 R1;                    [Half chance for Ice Lightning Bonus v=20 reserved]
!!VRy1&y1=21:S21 R1;                    [Half chance for Fireball Bonus v=22 reserved]
!!VRy1&y1=41:S41 R1;                    [Half chance for 2 extra casts]

!!VRy1&y1=28:S0;                        [Disabled Spell Counter Week]
!!VRy1&y1=27:S44;                       [Disabled Double Summoining Week]
!!VRy1&y1=43:S0;                        [Disabled Magic School Weeks]
!!SN:W^Critical_Sorcery_Mod^/?y10;
!!if&y10=0;
!!VRy1&y1=5:S10;                        [If Critical Sorcery Mod is disabled Set Week to more Spell Power]
!!VRy1&y1=6:S10;
!!en;

!!SN:W^Reworked_Magic_Specialists_Mod^/?y10;
!!if&y10=1;
!!VRy1|y1=23/y1=24/y1=25/y1=26:S0;      [If Reworked_Magic_Specialists_Mod is enabled Set Week to Nothing for now to prevent getting learned all spells if wrong mod order]
!!en;

*!VRy1:S0; **test var**                                                        [Set Week on purpose here for testing]

!!SN:W^Magic_Week_Number^/y1;
!!FU(Show_Magic_Week):P;


!?FU(Show_Magic_Week);

!!SN:W^Magic_Week_Number^/?y1;

!!if|y1=0/y1=20/y1=22;
!!SN:T^AC_Spells.No_Week^/?s^Magic_Week^;
!!IF&1000:Q2/13/0/1^%S(Magic_Week)^;    [Nothing this week]
!!en;

!!if&y1=1|y1=12;
!!SN:T^AC_Spells.Earth_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/56/1^%S(Magic_Week)^;   [Earth Week]
!!en;

!!if&y1=2|y1=14;
!!SN:T^AC_Spells.Air_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/50/1^%S(Magic_Week)^;   [Air Week]
!!en;

!!if&y1=3|y1=16;
!!SN:T^AC_Spells.Water_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/53/1^%S(Magic_Week)^;   [Water Week]
!!en;

!!if&y1=4|y1=18;
!!SN:T^AC_Spells.Fire_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/47/1^%S(Magic_Week)^;   [Fire Week]
!!en;

!!if&y1=5;
!!SN:T^AC_Spells.CritChance_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/19/1^%S(Magic_Week)^;    [Crit chance Week]
!!en;

!!if&y1=6;
!!SN:T^AC_Spells.CritDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/57/1^%S(Magic_Week)^;    [Crit dmg Week]
!!en;

!!if&y1=7;
!!SN:T^AC_Spells.LessDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/16/1/1^%S(Magic_Week)^;    [Less dmg Week]
!!en;

!!if&y1=8;
!!SN:T^AC_Spells.LessPoints_Week^/?s^Magic_Week^;
!!IF&1000:Q2/34/0/1^%S(Magic_Week)^;    [Mana Bonus]
!!en;

!!if&y1=9;
!!SN:T^AC_Spells.MagicArrow2X_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/15/1^%S(Magic_Week)^;    [Magic Arrow Bonus]
!!en;

!!if&y1=10;
!!SN:T^AC_Spells.SP10_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Spell Power Bonus]
!!en;

!!if&y1=11;
!!SN:T^AC_Spells.Implosion_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/18/1^%S(Magic_Week)^;    [Implosion Bonus]
!!en;

!!if&y1=13;
!!SN:T^AC_Spells.MagicArrow3X_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/15/1^%S(Magic_Week)^;    [3X Magic Arrow Bonus]
!!en;

!!if&y1=15;
!!SN:T^AC_Spells.MagicArrow5X_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/15/1^%S(Magic_Week)^;    [5X Magic Arrow Bonus]
!!en;

!!if&y1=17;
!!SN:T^AC_Spells.LightningBolt_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/17/1^%S(Magic_Week)^;    [Lightning Strike Bonus]
!!en;

!!if&y1=19;
!!SN:T^AC_Spells.IceLigthing_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/16/1^%S(Magic_Week)^;    [Ice Lightning Bonus]
!!en;

!!if&y1=21;
!!SN:T^AC_Spells.Fireball_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/21/1^%S(Magic_Week)^;    [Fireball Bonus]
!!en;

!!if&y1=23;
!!SN:T^AC_Spells.FireSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/86/1^%S(Magic_Week)^;    [All Fire Spells Bonus]
!!en;


!!if&y1=24;
!!SN:T^AC_Spells.AirSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/87/1^%S(Magic_Week)^;    [All Air Spells Bonus]
!!en;


!!if&y1=25;
!!SN:T^AC_Spells.EarthSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/89/1^%S(Magic_Week)^;    [All Earth Spells Bonus]
!!en;


!!if&y1=26;
!!SN:T^AC_Spells.WaterSpells_Week^/?s^Magic_Week^;
!!IF&1000:Q2/8/88/1^%S(Magic_Week)^;    [All Water Spells Bonus]
!!en;


!!if&y1=27;
!!SN:T^AC_Spells.Summon_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/66/1^%S(Magic_Week)^;    [All Summoning Bonus]
!!en;


!!if&y1=28;
!!SN:T^AC_Spells.SpellBlock_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/34/1^%S(Magic_Week)^;    [Spell block Bonus]
!!en;


!!if&y1=29;
!!SN:T^AC_Spells.Slow_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/54/1^%S(Magic_Week)^;    [Slow Bonus]
!!en;


!!if&y1=30;
!!SN:T^AC_Spells.Haste_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/53/1^%S(Magic_Week)^;    [Haste Bonus]
!!en;


!!if&y1=31;
!!SN:T^AC_Spells.Bless_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/41/1^%S(Magic_Week)^;    [Bless Bonus]
!!en;


!!if&y1=32;
!!SN:T^AC_Spells.Bloodlust_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/43/1^%S(Magic_Week)^;    [Bloodlust Bonus]
!!en;

!!if&y1=33;
!!SN:T^AC_Spells.StoneSkin_Week^/?s^Magic_Week^;
!!IF&1000:Q2/9/46/1^%S(Magic_Week)^;    [Stone Skin Bonus]
!!en;

!!if&y1=34;
!!SN:T^AC_Spells.CastI_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Extra Cast Bonus 1]
!!en;

!!if&y1=35;
!!SN:T^AC_Spells.Artifact_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Double Artifact Bonus]
!!en;

!!if&y1=36;
!!SN:T^AC_Spells.PointsDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/34/0/1^%S(Magic_Week)^;    [Spell Point Bonus]
!!en;

!!if&y1=37;
!!SN:T^AC_Spells.FireCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/47/1^%S(Magic_Week)^;   [Reanable Fire Cast]
!!en;

!!if&y1=38;
!!SN:T^AC_Spells.WaterCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/53/1^%S(Magic_Week)^;   [Reanable Water Cast]
!!en;

!!if&y1=39;
!!SN:T^AC_Spells.EarthCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/56/1^%S(Magic_Week)^;   [Reanable earth Cast]
!!en;

!!if&y1=40;
!!SN:T^AC_Spells.AirCast_Week^/?s^Magic_Week^;
!!IF&1000:Q2/20/50/1^%S(Magic_Week)^;   [Reanable Air Cast]
!!en;

!!if&y1=41;
!!SN:T^AC_Spells.CastII_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Extra Cast Bonus 2]
!!en;

!!if&y1=42;
!!SN:T^AC_Spells.SP20Bonus_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Spell Power Bonus 20%]
!!en;

!!if&y1=43;
!!SN:T^AC_Spells.School_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Magic Schools]
!!en;

!!if&y1=44;
!!SN:T^AC_Spells.Mana_Week^/?s^Magic_Week^;
!!IF&1000:Q2/34/0/1^%S(Magic_Week)^;    [Battle Mana Bonus]
!!en;

!!if&y1=45;
!!SN:T^AC_Spells.LvLDmg_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Spell Damage per Level]
!!en;

!!if&y1=46;
!!SN:T^AC_Spells.MS_Week^/?s^Magic_Week^;
!!IF&1000:Q2/33/0/1^%S(Magic_Week)^;    [Magic Strength Bonus]
!!en;


When right-clicking on System Icon at Adventure Map show Magic Weeks
!?CM&1000;
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!FU(Show_Magic_Week)&v3=512/v4=12:P;   [if right click and specialty icon are clicked]


********************************************************************************
!?FU(OnBeforeBattleUniversal)&1000;     [Combat Spell Power for Hero (single player only right now)]

!!SN:W^Magic_Week_Number^/?y99;

!!IF:V936/0;                            [Quick Combat Flag]
!!SN&y99=34:W^Magic_Week_34_att^/1;     [Extra Cast Variable Attacker Set 1]
!!SN&y99=34:W^Magic_Week_34_def^/1;     [Extra Cast Variable Defender Set 1]

!!SN&y99=41:W^Magic_Week_41_att^/2;     [Extra Cast Variable Attacker Set 2]
!!SN&y99=41:W^Magic_Week_41_def^/2;     [Extra Cast Variable Defender Set 2]

!!BA:H0/?y88;                           [Attacking Hero]
!!BA:H1/?y89;                           [Defending Hero]

!!FU(AC_Function_83)&y88>=0:Py88/y99;   [For Attacker]Call Fkt Pass hero number and week number]
!!FU(AC_Function_83)&y89>=0:Py89/y99;   [For Defender]

!!HEy88&y88>=0/y99=44:Id10/1;           [Week 44 +10 Mana for each battle]
!!HEy89&y89>=0/y99=44:Id10/1;

!!SN:W^Week_Slow_Cast0^/0;              [So only works once per combat]
!!SN:W^Week_Slow_Cast1^/0;
!!SN:W^Week_Haste_Cast0^/0;             [So only works once per combat]
!!SN:W^Week_Haste_Cast1^/0;


!?FU(AC_Function_83);

!!SN:W^Spell_000^/0; !!SN:W^Spell_001^/0; !!SN:W^Spell_002^/0; !!SN:W^Spell_003^/0;
!!SN:W^Spell_004^/0; !!SN:W^Spell_005^/0; !!SN:W^Spell_006^/0; !!SN:W^Spell_007^/0;
!!SN:W^Spell_008^/0; !!SN:W^Spell_009^/0; !!SN:W^Spell_010^/0; !!SN:W^Spell_011^/0;
!!SN:W^Spell_012^/0; !!SN:W^Spell_013^/0; !!SN:W^Spell_014^/0; !!SN:W^Spell_015^/0;
!!SN:W^Spell_016^/0;

!!if&x2=23;
!!HEx1:M11/?y50 M13/?y51 M21/?y52 M22/?y53 M26/?y54 M29/?y55; [Check if the hero already has fire Spell]
!!HEx1:M31/?y56 M40/?y57 M42/?y58 M43/?y59 M52/?y60 M55/?y61;
!!HEx1:M56/?y62 M59/?y63 M62/?y64 M64/?y65 M66/?y66;

!!HEx1:M11/1 M13/1 M21/1 M22/1 M26/1 M29/1 M31/1;
!!HEx1:M40/1 M42/1 M43/1 M52/1 M55/1 M56/1 M59/1;
!!HEx1:M62/1 M64/1 M66/1;               [Give Spell]
!!en;

!!if&x2=24;
!!HEx1:M02/?y50 M04/?y51 M05/?y52 M06/?y53 M17/?y54 M19/?y55; [Check if the hero already has air Spell]
!!HEx1:M25/?y56 M28/?y57 M30/?y58 M36/?y59 M44/?y60 M47/?y61;
!!HEx1:M51/?y62 M53/?y63 M58/?y64 M60/?y65 M69/?y66;

!!HEx1:M02/1 M04/1 M05/1 M06/1 M17/1 M19/1 M25/1;
!!HEx1:M28/1 M30/1 M36/1 M44/1 M47/1 M51/1 M53/1;
!!HEx1:M58/1 M60/1 M69/1;               [Give Spell]
!!en;

!!if&x2=25;
!!HEx1:M03/?y50 M09/?y51 M10/?y52 M12/?y53 M14/?y54 M18/?y55; [Check if the hero already has Earth Spell]
!!HEx1:M23/?y56 M24/?y57 M27/?y58 M33/?y59 M34/?y60 M38/?y61;
!!HEx1:M39/?y62 M46/?y63 M50/?y64 M54/?y65 M67/?y66;

!!HEx1:M03/1 M09/1 M10/1 M12/1 M14/1 M18/1;
!!HEx1:M23/1 M24/1 M27/1 M33/1 M34/1 M38/1;
!!HEx1:M39/1 M46/1 M50/1 M54/1 M67/1;   [Give Spell]
!!en;

!!if&x2=26;
!!HEx1:M00/?y50 M01/?y51 M07/?y52 M08/?y53 M16/?y54 M20/?y55; [Check if the hero already has water Spell]
!!HEx1:M32/?y56 M35/?y57 M37/?y58 M41/?y59 M45/?y60 M48/?y61;
!!HEx1:M49/?y62 M61/?y63 M63/?y64 M65/?y65 M68/?y66;

!!HEx1:M00/1 M01/1 M07/1 M08/1 M16/1 M20/1;
!!HEx1:M32/1 M35/1 M37/1 M41/1 M45/1 M48/1;
!!HEx1:M49/1 M61/1 M63/1 M65/1 M68/1;   [Give Spells]
!!en;

!!SN:W^Spell_000^/y50; !!SN:W^Spell_001^/y51; !!SN:W^Spell_002^/y52; !!SN:W^Spell_003^/y53;
!!SN:W^Spell_004^/y54; !!SN:W^Spell_005^/y55; !!SN:W^Spell_006^/y56; !!SN:W^Spell_007^/y57;
!!SN:W^Spell_008^/y58; !!SN:W^Spell_009^/y59; !!SN:W^Spell_010^/y60; !!SN:W^Spell_011^/y61;
!!SN:W^Spell_012^/y62; !!SN:W^Spell_013^/y63; !!SN:W^Spell_014^/y64; !!SN:W^Spell_015^/y65;
!!SN:W^Spell_016^/y66;


********************************************************************************
!?FU(OnAfterBattleUniversal)&1000;

!!BA:H0/?y88;                           [Attacking Hero]
!!BA:H1/?y89;                           [Defending Hero]

!!SN:W^Magic_Week_Number^/?y99;

!!FU(AC_Function_82)&y88>=0:Py88/y99;   [For Attacker] Pass hero number and week number]
!!FU(AC_Function_82)&y89>=0:Py89/y99;

!!SN:W^Magic_Week_34_att^/0;            [Extra Cast Variable Attacker Reset]
!!SN:W^Magic_Week_34_def^/0;            [Extra Cast Variable Defender Reset]

!!SN:W^Magic_Week_41_att^/0;            [Extra Cast Variable Attacker Reset]
!!SN:W^Magic_Week_41_def^/0;            [Extra Cast Variable Defender Reset]

!!SN:W^Magic_Week_Spell_Element^/0;     [Extra Cast Variable Element Week Reset]


!?FU(AC_Function_82);

!!SN:W^Spell_000^/?y50; !!SN:W^Spell_001^/?y51; !!SN:W^Spell_002^/?y52; !!SN:W^Spell_003^/?y53;
!!SN:W^Spell_004^/?y54; !!SN:W^Spell_005^/?y55; !!SN:W^Spell_006^/?y56; !!SN:W^Spell_007^/?y57;
!!SN:W^Spell_008^/?y58; !!SN:W^Spell_009^/?y59; !!SN:W^Spell_010^/?y60; !!SN:W^Spell_011^/?y61;
!!SN:W^Spell_012^/?y62; !!SN:W^Spell_013^/?y63; !!SN:W^Spell_014^/?y64; !!SN:W^Spell_015^/?y65;
!!SN:W^Spell_016^/?y66;

!!if&x2=23;
!!HEx1&y50<>1:M11/0; !!HEx1&y51<>1:M13/0; !!HEx1&y52<>1:M21/0; !!HEx1&y53<>1:M22/0; !!HEx1&y54<>1:M26/0; !!HEx1&y55<>1:M29/0; !!HEx1&y56<>1:M31/0;
!!HEx1&y57<>1:M40/0; !!HEx1&y58<>1:M42/0; !!HEx1&y59<>1:M43/0; !!HEx1&y60<>1:M52/0; !!HEx1&y61<>1:M55/0; !!HEx1&y62<>1:M56/0; !!HEx1&y63<>1:M59/0;
!!HEx1&y64<>1:M62/0; !!HEx1&y65<>1:M64/0; !!HEx1&y66<>1:M66/0; [Take fire Spells]
!!en;

!!if&x2=24;
!!HEx1&y50<>1:M02/0; !!HEx1&y51<>1:M04/0; !!HEx1&y52<>1:M05/0; !!HEx1&y53<>1:M06/0; !!HEx1&y54<>1:M17/0; !!HEx1&y55<>1:M19/0; !!HEx1&y56<>1:M25/0;
!!HEx1&y57<>1:M28/0; !!HEx1&y58<>1:M30/0; !!HEx1&y59<>1:M36/0; !!HEx1&y60<>1:M44/0; !!HEx1&y61<>1:M47/0; !!HEx1&y62<>1:M51/0; !!HEx1&y63<>1:M53/0;
!!HEx1&y64<>1:M58/0; !!HEx1&y65<>1:M60/0; !!HEx1&y66<>1:M69/0; [Take air Spells]
!!en;

!!if&x2=25;
!!HEx1&y50<>1:M03/0; !!HEx1&y51<>1:M09/0; !!HEx1&y52<>1:M10/0; !!HEx1&y53<>1:M12/0; !!HEx1&y54<>1:M14/0; !!HEx1&y55<>1:M18/0; !!HEx1&y56<>1:M23/0;
!!HEx1&y57<>1:M24/0; !!HEx1&y58<>1:M27/0; !!HEx1&y59<>1:M33/0; !!HEx1&y60<>1:M34/0; !!HEx1&y61<>1:M38/0; !!HEx1&y62<>1:M39/0; !!HEx1&y63<>1:M46/0;
!!HEx1&y64<>1:M50/0; !!HEx1&y65<>1:M54/0; !!HEx1&y66<>1:M67/0; [Take earth Spells]
!!en;

!!if&x2=26;
!!HEx1&y50<>1:M00/0; !!HEx1&y51<>1:M01/0; !!HEx1&y52<>1:M07/0; !!HEx1&y53<>1:M08/0; !!HEx1&y54<>1:M16/0; !!HEx1&y55<>1:M20/0; !!HEx1&y56<>1:M32/0;
!!HEx1&y57<>1:M35/0; !!HEx1&y58<>1:M37/0; !!HEx1&y59<>1:M41/0; !!HEx1&y60<>1:M45/0; !!HEx1&y61<>1:M48/0; !!HEx1&y62<>1:M49/0; !!HEx1&y63<>1:M61/0;
!!HEx1&y64<>1:M63/0; !!HEx1&y65<>1:M65/0; !!HEx1&y66<>1:M68/0; [Take water Spells]
!!en;

********************************************************************************
!?MR1;

!!BG:H?y88;
!!FU&y88=-1:E;
!!BG:A?y1;                              [Hero casts a spell]
!!FU&y1<>1:E;
!!BG:S?y11;                             [y11 now contains spell number]
!!FU&y11<=9|y11>69:E;
!!FU(MSR_Determine_Spell_Type):Py11/?y20/?y21/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]
*!IF:M^Spell Element %Y-98 and %Y-97 and %Y-96 and Spell %Y11^;

!!SN:W^Magic_Week_Number^/?y99;

!!MR:F?y14;                             [get Spell damage in y14]

!!if&y99=36;                           [If week 36 ]
!!HEy88:I?y3/1;
!!VRy14:Sy14 +y3;                       [Add Current Spell Points to Magic Damage]
!!en;

!!if&y99=8;                            [Mana Bonus]
!!HEy88:Id3/1;
!!en;

!!if&y22=8;                            [Water]
!!VRy14|y99=3/y99=16:*125: 100;
!!en;

!!if&y22=4;                            [Fire]
!!VRy14|y99=4/y99=18:*125: 100;
!!en;

!!if&y22=1;                            [Air]
!!VRy14|y99=2/y99=14:*125: 100;
!!en;

!!if&y22=2;                            [Earth]
!!VRy14|y99=1/y99=12:*125: 100;
!!en;

!!if&y99=7;                            [less Magic Damage]
!!VRy14:*75: 100;
!!en;

!!if&y99=10;                           [10% Magic Damage]
!!VRy14:*110: 100;
!!en;

!!if&y99=42;                           [20% Magic Damage]
!!VRy14:*120: 100;
!!en;

!!if&y99=43;                           [5% per Magic School Magic Damage]
!!HEy88:S14/?y24; !!HEy88:S15/?y25; !!HEy88:S16/?y26; !!HEy88:S17/?y27;
!!VRy49:S100;
!!VRy49&y24>0:+5; !!VRy49&y25>0:+5; !!VRy49&y26>0:+5; !!VRy49&y27>0:+5;
!!VRy14:*y49: 100;
!!en;

!!if&y99=45;                           [1% per Hero Level Magic Damage]
!!HEy88:E?y30/?y48/1;
!!VRy49:Sy48+100;
!!VRy14:*y49: 100;
!!en;

!!if&y99=9/y11=15;                     [Magic Arrow Bonus]
!!VRy14:*200: 100;
!!en;

!!if&y99=13/y11=15;                    [3X Magic Arrow Bonus]
!!VRy14:*300: 100;
!!en;

!!if&y99=15/y11=15;                    [5X Magic Arrow Bonus]
!!VRy14:*500: 100;
!!en;

!!if&y99=11/y11=18;                    [Implosion Bonus]
!!VRy14:*130: 100;
!!en;

!!if&y99=17/y11=17;                    [Lightning Strike Bonus]
!!VRy15:S120R80;
!!VRy14:*y15: 100;
!!en;

!!if&y99=19/y11=16;                    [Ice Bolt Bonus]
!!VRy15:S120R80;
!!VRy14:*y15: 100;
!!en;

!!if&y99=21/y11=21;                    [Fireball Bolt Bonus]
!!VRy15:S120R80;
!!VRy14:*y15: 100;
!!en;

!!MR:Fy14;                              [Set new damage]



!?BG0;

!!SN:W^Magic_Week_Number^/?y99;
!!FU|y99<29/y99>30:E;
!!BG:H?y88;
!!FU&y88=-1:E;
!!BG:A?y1;                              [Hero casts a spell]
!!FU&y1<>1:E;
!!BG:S?y11;                             [y11 now contains spell number]
!!BG:Q?y3;

!!if&y11=53/y99=30;                    [If Spell is Haste]
!!SN&y3=0:W^Week_Haste_Cast0^/?y4;      [So only works once per combat]
!!SN&y3=1:W^Week_Haste_Cast1^/?y4;
!!FU&y4=1:E;
!!SN&y3=0:W^Week_Haste_Cast0^/1;        [So only works once per combat]
!!SN&y3=1:W^Week_Haste_Cast1^/1;
!!DO(AC_Function_84)/0/20/1&y3=0:P0/2;
!!DO(AC_Function_84)/21/40/1&y3=1:P0/2;
!!en;

!!if&y11=54/y99=29;                    [If Spell is Slow]
!!SN&y3=0:W^Week_Slow_Cast0^/?y4;       [So only works once per combat]
!!SN&y3=1:W^Week_Slow_Cast1^/?y4;
!!FU&y4=1:E;
!!SN&y3=0:W^Week_Slow_Cast0^/1;         [So only works once per combat]
!!SN&y3=1:W^Week_Slow_Cast1^/1;
!!DO(AC_Function_84)/21/41/1&y3=0:P0/3;
!!DO(AC_Function_84)/0/20/1&y3=1:P0/3;
!!en;





********************************************************************************
!?BG0&1000;                             [Continue trigger if magic week is enabled]

!!SN:W^Magic_Week_Number^/?y99;
!!FU:E;                                 [Disabled for now]

!!BG:A?y1;                              [Hero casts a spell]
!!FU&y1<>1:E;

!!BG:Q?y90;                             [Current attacking side]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!HEy88&y90=1:S8/?y20;
!!HEy89&y90=0:S8/?y21;
!!FU&y21=0/y20=0:E;

!!VRy20:*10;                            [chance to block at expert mysticism is 30%]
!!VRy21:*10;

!!BG:E?y1 A?y2 Q?y3 S?y4 N?y11;         [get destination stack, action type, side, spell, acting stack]
!!BMy1&y1>-1/y2=1:I?y5 P?y8;            [if hero casting, get side, position of target stack]
!!BMy1&y1>-1/y2=10:I?y5 P?y8;           [if monster casting, get side, position of target stack]

!!VRy10&y4>=27/y4<=33:S1;
!!VRy10|y4=37/y4=41/y4=43/y4=44/y4=46/y4=48/y4=49/y4=51/y4=53/y4=58:S1; [check for beneficial (mass) spells]

*!VRy9&y1=-1/y10=1:S1;                                                          [if hero cast spell with no target (mass) set to 1]
*!VRy9&y1>-1/y3=y5:S1;                                                          [if caster is targeting own side set to 1]

!!VRy6:S0T99;                           [random roll]
*!VRy6:S10;
*!IF:M^y6 is %Y6^;

!!VRy7&y3=0/y21>0/y6<y21:S1;            [if attacker cast, check against defender Eagle Eye rating]
!!VRy7&y3=1/y20>0/y6<y20:S1;            [if defender cast, check against attacker Eagle Eye rating]

!!BMy11&y1>-1/y7=1/y2=10:C0/y8/0/0/1 E?y12; [have current stack cast summon boat (for sound effect), get # of spells remaining]
!!VRy12&y1>-1/y7=1/y2=10:-1;            [reduce spell count by 1]
!!BMy11&y1>-1/y7=1/y2=10:V32 V32 V32 Ey12; [show animation (caster), reset spell count]
!!BG&y1>-1/y2=10/y7=1:A2;               [make unit move (cancel action)]

!!BG&y7=1/y2=1:S0;                      [reset spell to summon boat]
!!BMy11&y7=1/y2=1:V60 V60 V60;          [show animation (hero)]

!!VRz2&y7=1:S^{Magic Week} spell counter!^; [set combat message]
!!MM&y7=1:Sz2;                          [display combat message]


********************************************************************************
[Start of battlefield trigger]
!?BF&1000;

!!SN:W^Magic_Week_Number^/?y50;         [Exit if not correct week]

!!if|y50=31/y50=32/y50=33;
!!BA:H0/?y98 H1/?y99;

!!DO(AC_Function_84)/0/20/1&y98>=0:Py50/1;
!!DO(AC_Function_84)/21/40/1&y99>=0:Py50/1;
!!en;

!?FU(AC_Function_84);
!!BMx16&x1=31/x2=1:M41/99/3;            [Apply Expert Bless]
!!BMx16&x1=32/x2=1:M43/99/3;            [Apply Expert Bloodlust]
!!BMx16&x1=33/x2=1:M46/99/3;            [Apply Expert Stone Skin]
*!BMx16:M29/99/3;                                                                    [Apply Fire Shield]

!!BMx16:T?y1;
!!if&y1<145;
!!BMx16&x2=2:Sd1;                       [add Speed]

!!BMx16&x2=3:S?y2;
!!VRy2&x2=3:-1;
!!VRy2&x2=3/y2<=2:S2;
!!BMx16&x2=3:Sy2;                       [remove Speed]
!!en;                                  [Cannot be lower than 2]


********************************************************************************
!?BG1&1000;                             [1 extra cast per combat week 34]

!!SN:W^Magic_Week_Number^/?y50;
!!if&y50=34|y50=41;                    [Exit if wrong week]

!!BG:Q?y1;                              [Fix for Double Cast]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;

!!if&y4=0;
!!BA:Q?f;
!!BG:Q?y90;                             [Current attacking side]
!!BH0:N?y88;                            [Attacking Hero]
!!BH1:N?y89;                            [Defending Hero]

!!HEy88&y88>=0/y90=0:S8/?y4;
!!HEy89&y89>=0/y90=1:S8/?y4;

!!VRy4:S3;                              [Added]

!!FU&y4=0:E;

!!if&y50=34;
!!BG:Q?y1;
!!SN&y1=0:W^Magic_Week_34_att^/?y2;
!!SN&y1=1:W^Magic_Week_34_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^{Magic Week Extra Cast!}^;
!!BU&1000/f=0:Mz-1;
!!SN&y1=0:W^Magic_Week_34_att^/0;
!!SN&y1=1:W^Magic_Week_34_def^/0;
!!en;

!!if&y50=41;
!!BG:Q?y1;
!!SN&y1=0:W^Magic_Week_41_att^/?y2;
!!SN&y1=1:W^Magic_Week_41_def^/?y2;
!!FU&y2=0:E;
!!BHy1:M?y3;
!!FU&y3=0:E;
!!BHy1:M0;

!!SN&y1=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y1=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!VRz-1:S^{Magic Week Extra Cast!}^;
!!BU&1000/f=0:Mz-1;
!!SN&y1=0:W^Magic_Week_41_att^/d-1;
!!SN&y1=1:W^Magic_Week_41_def^/d-1;
!!en;
!!en;
!!en;

********************************************************************************
!?BG0&1000;                             [Elemental extra cast per combat, week 37-40]

!!SN:W^Magic_Week_Number^/?y99;
!!FU&y99<37|y99>40:E;

!!BG:Q?y1;                              [Fix for Double Cast]
!!SN&y1=0:W^Double_Cast_Attacker^/?y4;
!!SN&y1=1:W^Double_Cast_Defender^/?y4;
!!SN:W^Magic_Week_Spell_Element^/0;

!!VRy10:S0T99;                          [25% Chance Roll]

!!if&y4=0/y10<25;

!!BG:Q?y90;                             [Current attacking side]
!!BHy90:N?y88;                          [Current Hero Number]

!!if&y88>=0;
!!BG:A?y82;                             [Hero casts a spell]
!!FU&y82<>1:E;
!!BG:S?y11;                             [y11 now contains spell number]
!!FU&y11<=9|y11>69:E;
!!FU(MSR_Determine_Spell_Type):Py11/0/0/?y22; [y22 Returns the Magic School of the Spell that was Cast  1Air  2Earth  4Fire  8Water   15Magic Arrow]

*!IF:M^Now Roll is successfull and no more double cast Element is %Y-98 and %Y99^;
!!SN&y99=37/y22=4:W^Magic_Week_Spell_Element^/y22;
!!SN&y99=38/y22=8:W^Magic_Week_Spell_Element^/y22;
!!SN&y99=39/y22=2:W^Magic_Week_Spell_Element^/y22;
!!SN&y99=40/y22=1:W^Magic_Week_Spell_Element^/y22;
!!en;
!!en;
********************************************************************************
!?BG1&1000;                             [Elemental extra cast per combat, week 37-40]

!!SN:W^Magic_Week_Number^/?y99;
!!FU&y99<37|y99>40:E;

!!SN:W^Magic_Week_Spell_Element^/?y5;
!!FU&y5=0:E;

!!BA:Q?f;
!!BG:Q?y90;                             [Current attacking side]

!!BHy90&y99=37/y5=4:M0;                 [Fire]
!!BHy90&y99=38/y5=8:M0;                 [Water]
!!BHy90&y99=39/y5=2:M0;                 [Earth]
!!BHy90&y99=40/y5=1:M0;                 [Air]

!!SN&y90=0:W^Magic_Specialists_%V997_Cast_Count_Att^/d1;
!!SN&y90=1:W^Magic_Specialists_%V997_Cast_Count_Def^/d1;

!!BHy90:M?y11;
!!if&y11=0;
!!VRz-1:S^FORTUNE^;
!!SN&1000/f=0:Pz-1;
!!VRz-1:S^{Magic Week Extra Cast!}^;
!!BU&1000/f=0:Mz-1;
!!en;

********************************************************************************
Spell Duration Mod from Alf :)

!?BG0;                                  [Before every action]
!!SN:W^Spell_Duration_Mod^/?y1;
!!FU&y1=0:E;                            [Exit if Mod not active]

!!SN:W^Duration_Mod_Hero_Id^/-1;        [Reset Var]
!!SN:W^Duration_Mod_Spell_Id^/-1;       [Reset Var]
!!SN:W^Duration_Mod_Changed^/0;         [Reset Var]

!!BG:A?y1;
!!FU&y1<>1:E;                           [If Hero Casts a Spell]

!!BG:S?y2;                              [Get spell id]
!!FU|y2<27/y2>62/y2=35/y2=37/y2=38/y2=39/y2=40/y2=47/y2=56/y2=57/y2=59:E;
Spells allowed: Shield, Air Shield, Fire Shield, Protection from element, Anti-magic, Magic Mirror, Bless, Curse, Bloodlust, Precision,
Weakness, Stone Skin, Prayer, Mirth, Sorrow, Fortune, Misfortune, Haste, Slow, Slayer, Counterstrike, Hypnotize, Forgetfulness, Blind.
!!SN:W^Duration_Mod_Spell_Id^/y2;       [Save spell id]

!!BG:H?y3;                              [Get hero id]
!!SN:W^Duration_Mod_Hero_Id^/y3;        [Save hero id]

------------------------------------------------------------------------------------------------------------------------

!?BG1;                                  [After action]
!!SN:W^Spell_Duration_Mod^/?y1;
!!FU&y1=0:E;                            [Exit if Mod not active]

!!SN:W^Duration_Mod_Hero_Id^/?y99;      [Get hero id]
!!SN:W^Duration_Mod_Spell_Id^/?y2;      [Get spell id]
!!FU|y99=-1/y2<10:E;                    [Exit if false]

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;

!!BG:D?y3;                              [Get hex id that was affected]
*!IF:M^Hex ID is %Y3^;
!!SSy2:O?y4;                            [Get which type of stack does the spell affect]
!!BG:Q?y5;                              [Get hero side]
!!FU(Calc_Spell_Duration):Py99/y2/?y6/?y7; [Get spell duration with new and old formula, accordingly.]
!!DO(Battle_Stacks_Valid_Spellcast)/0/41/1&y3=-1:Py99/y2/y4/y5/y6/y7; [Run Function and loop through all Battle stacks if not mass spell]
!!if&y3>-1;                            [If casted spell is not mass and current stack is the target]
!!BU:Ey3/?y1;                           [Get stack id standing on hex]
!!BMy1:Gy2/?y3/?y4;                     [Get current duration and power of the spell]
*!IF:M^%Y3 %Y7^;
!!BMy1&y3=y7:Gy2/y6/y4;                 [Set duration if spell target valid]
!!en;
!!SN:W^Duration_Mod_Changed^/1;


!?FU(Battle_Stacks_Valid_Spellcast);    [For stacks that were affected, change duration from SP to 1.5 + SP/10, rounded down]
x1 hero id, x2 spell id, x3 type of target, x4 hero side, x5 new spell duration, x6 vanilla spell duration
!!BMx16:I?y1;                           [Get side of current stack]
!!VRy2:Sy1+x4;                          [Sum of hero side and stack side variables. Equals 1 if both from different side.]

!!if&x3=-1/y2=1;                       [If spell is mass, affects enemies and current stack is enemy]
!!BMx16:Gx2/?y2/?y3;                    [Get current duration and power of the spell]
!!BMx16&y2=x6:Gx2/x5/y3;                [Set duration if spell target valid]
!!en;

!!if&x3=1/y2<>1;                       [If spell is mass, affects allies and current stack is ally]
!!BMx16:Gx2/?y2/?y3;
!!BMx16&y2=x6:Gx2/x5/y3;                [Set duration if spell target valid]
!!en;


!?FU(Calc_Spell_Duration);
x1 hero id, x2 spell id, x3 returns new duration, x4 returns vanilla duration
y1-y20 reserved for spells, y21-y40 for artifacts.
!!HEx1:Fd/d/?y1/d S14/?y2 S15/?y3 S16/?y4 S17/?y5 S25/?y6; [Get current hero's Spellpower, Fire14 Air15 Water16 Earth17 and Sorcery(25, not used).]
!!VRx4:Sy1;                             [Duration first equals spellpower]
!!HEx1:A2/76/?y88/?y21;                      [Check for spell duration changing artifacts]
!!VRx4&y21=1:+1;                        [76 Collar of Conjuring]
!!HEx1:A2/77/?y88/?y22;
!!VRx4&y22=1:+2;                        [77 Ring of Conjuring]
!!HEx1:A2/78/?y88/?y23;
!!VRx4&y23=1:+3;                        [78 Cape of Conjuring]
!!HEx1:A2/139/?y88/?y24;
!!VRx4&y24=1:+56;                       [139 Ring of the Magi]

!!VRx3:Sy1+13;                          [Calculate new duration as (spellpower+13)/8, rounded down]
!!VRx3&y21=1:+5;                        [76 Collar of Conjuring gives 5 effective SP]
!!VRx3&y22=1:+10;                       [77 Ring of Conjuring gives 10 effective SP]
!!VRx3&y23=1:+15;                       [78 Cape of Conjuring gives 15 effective SP]
!!VRx3&y24=1:+100;                      [139 Ring of the Magi gives 100 effective SP]

!!VRx3&y2=3:+2;
!!VRx3&y3=3:+2;
!!VRx3&y4=3:+2;
!!VRx3&y5=3:+2;
!!SN:W^H3_Sorcery_1_Hero%X1^/?y11;
!!VRx3&y11=1:+10;                       [Grandmaster Sorcery gives extra 10 too]
!!VRx3::8;
****************************************************************************************************



****************************************************************************************************
Warmachine Upgrades and Enchantments. Call DL in Town Screen when clicking Smith or Mage Guild
!?CM1;                                  [Town Screen Trigger]

!!CM:T?y1 F?y2 I?y3 S?y4;               [where we click and click subtype]
!!FU&y4<>14:E; !!FU&y2<>512:E;
!!if&y1=512/y2=512/y4=14;              [if left click and kingdom overview icon are clicked]

!!CA-1:H1/?y5;                          [town Visitor]
!!FU|y5<0/y5>155:E;
!!FU(Warmachine_Upgrade_Town)&y1=512/y2=512/y3=16/y4=14:Py5/1; [Jump to Warmachine Function for Upgrades]
!!FU(Warmachine_Upgrade_Town)&y1=512/y2=512/y3>=0/y3<=4/y4=14:Py5/2; [Jump to Warmachine Function for Enchantments]
!!SN:W^WM_Upgrade_Hero^/y5;
!!SN:W^WM_Visit_Purchased^/0;
!!en;


****************************************************************************************************
!?FU(Warmachine_Upgrade_Town);
x1=Hero Number, x1= 1 or 2 (Blacksmith or Mage Guild)

!!FU(Play_Blacksmith_Sound)&x2=1:P1;
!!FU(Play_Mage_Guild_Sound)&x2=2:P1;
!!SN&x2=1:W^WM_Window_Selection^/x2;
!!SN&x2=2:W^WM_Window_Selection^/x2;

!!DL81:N^WM_Sel.txt^;                   [parse dialogue]
!!SN&x2=1:T^AC_Warmachine.Upgrade^/?z1;
!!SN&x2=2:T^AC_Warmachine.Enchantment^/?z1;
!!SN:T^AC_Warmachine.Ballista_0^/?z2;
!!SN:T^AC_Warmachine.Cart_0^/?z3;
!!SN:T^AC_Warmachine.Tent_0^/?z4;
!!SN:T^AC_Warmachine.All_Machines^/?z5;
!!SN&x2=1:T^AC_Warmachine.Say_Hello_Upg^/?z6;
!!SN&x2=2:T^AC_Warmachine.Say_Hello_Ench^/?z6;

*!VRz2:S^%Z2 %Z7^; *!VRz3:S^%Z3 %Z7^; *!VRz4:S^%Z4 %Z7^; *!VRz5:S^%Z5 %Z7^;

!!DL81:A10/3/z1/1;                      [show correct skill text what can be leveled]
!!DL81:A11/3/z2/1;                      [show correct skill text what can be leveled]
!!DL81:A12/3/z3/1;                      [show correct skill text what can be leveled]
!!DL81:A13/3/z4/1;                      [show correct skill text what can be leveled]
!!DL81:A14/3/z5/1;                      [show correct skill text what can be leveled]
!!DL81:A14/3/z5/1;                      [show correct skill text what can be leveled]
!!DL81:A15/3/z6/1;                      [show correct skill text what can be leveled]
!!DL81&x2=1:A3/4/0/1;                   [show correct skill text what can be leveled]
!!DL81&x2=2:A3/4/1/1;                   [show correct skill text what can be leveled]
!!DL81&x2=1:A4/4/0/1;                   [show correct skill text what can be leveled]
!!DL81&x2=2:A4/4/1/1;                   [show correct skill text what can be leveled]
!!DL81:S;


!?DL&v998=81/v999>=5/v999<=8/v1000=13;  [left click on the three pictures asks if you want to buy the upgrade]

!!VRv3:S0;
!!VRy99:S0;
!!VRv3&v999=5:S1;
!!VRv3&v999=6:S2;
!!VRv3&v999=7:S4;
!!VRv3&v999=8:S8;

!!SN:W^WM_Upgrade_Selection^/v3;
!!CA-1:H1/?x1; !!FU|x1<0/x1>155:E;      [Exit if no valid hero]
!!SN:W^WM_Window_Selection^/?y99;

!!if&y99=1;
  !!FU(Play_Blacksmith_Sound)|v3=0/v3>8:P3;
  !!FU|v3=0/v3>8:E;                     [Exit if no choice or leave]

  !!DL51:N^WM_Upg.txt^;                 [parse dialogue]

  !!if&v3=1;
  !!SN:T^AC_Warmachine.Ballista_0^/?z-2;
  !!VRz-3:S^S_Bal.pcx^;
  !!VRz-7:S^Bal_Upg_1.pcx^;
  !!VRz-8:S^Bal_Upg_2.pcx^;
  !!VRz-9:S^Bal_Upg_3.pcx^;
  !!SN:T^AC_Warmachine.Bal_Upg_1^/?z-4;
  !!SN:T^AC_Warmachine.Bal_Upg_2^/?z-5;
  !!SN:T^AC_Warmachine.Bal_Upg_3^/?z-6;
  !!SN:W^Ballista_Morale_%X1^/?y10;    [Check if options have already been activated]
  !!SN:W^Ballista_Add_Shots_%X1^/?y11;
  !!SN:W^Ballista_Crippling_%X1^/?y12;
  !!en;


  !!if&v3=2;
  !!SN:T^AC_Warmachine.Cart_0^/?z-2;
  !!VRz-3:S^S_Cart.pcx^;
  !!VRz-7:S^Cart_Upg_1.pcx^;
  !!VRz-8:S^Cart_Upg_2.pcx^;
  !!VRz-9:S^Cart_Upg_3.pcx^;
  !!SN:T^AC_Warmachine.Cart_Upg_1^/?z-4;
  !!SN:T^AC_Warmachine.Cart_Upg_2^/?z-5;
  !!SN:T^AC_Warmachine.Cart_Upg_3^/?z-6;
  !!SN:W^Ammo_Supply_%X1^/?y10;   [Check if options have already been activated]
  !!SN:W^Ammo_Goblin_%X1^/?y11;
  !!SN:W^Ammo_Enhanced_Arrow_%X1^/?y12;
  !!en;


  !!if&v3=4;
  !!SN:T^AC_Warmachine.Tent_0^/?z-2;
  !!VRz-3:S^S_Tent.pcx^;
  !!VRz-7:S^Tent_Upg_1.pcx^;
  !!VRz-8:S^Tent_Upg_2.pcx^;
  !!VRz-9:S^Tent_Upg_3.pcx^;
  !!SN:T^AC_Warmachine.Tent_Upg_1^/?z-4;
  !!SN:T^AC_Warmachine.Tent_Upg_2^/?z-5;
  !!SN:T^AC_Warmachine.Tent_Upg_3^/?z-6;
  !!SN:W^Tent_Improved_%X1^/?y10;    [Check if options have already been activated]
  !!SN:W^Tent_Capacity_Upgrade_%X1^/?y11;
  !!SN:W^Tent_Gold_Gain_%X1^/?y12;
  !!en;


  !!if&v3=8;
  !!SN:T^AC_Warmachine.Warmachines_0^/?z-2;
  !!VRz-3:S^S_Upg.pcx^;
  !!VRz-7:S^All_Upg_1.pcx^;
  !!VRz-8:S^All_Upg_2.pcx^;
  !!VRz-9:S^All_Upg_3.pcx^;
  !!SN:T^AC_Warmachine.All_Upg_1^/?z-4;
  !!SN:T^AC_Warmachine.All_Upg_2^/?z-5;
  !!SN:T^AC_Warmachine.All_Upg_3^/?z-6;
  !!SN:W^WM_Fortification_%X1^/?y10;    [Check if options have already been activated]
  !!SN:W^WM_Maintainability_%X1^/?y11;
  !!SN:W^WM_Versatility_%X1^/?y12;
  !!en;

  !!DL51:A5/11/z-3/1;                      [show correct skill text what can be leveled]
  !!DL51:A1/11/z-7/1;
  !!DL51:A2/11/z-8/1;
  !!DL51:A3/11/z-9/1;
  !!DL51:A6/3/z-4/1;                      [show correct skill text what can be leveled]
  !!DL51:A9/3/z-5/1;                      [show correct skill text what can be leveled]
  !!DL51:A10/3/z-6/1;                     [show correct skill text what can be leveled]
  !!DL51:A13/4/y10/1;
  !!DL51:A14/4/y11/1;
  !!DL51:A15/4/y12/1;
  !!DL51:S;
!!en;


!!if&y99=2;
  !!FU(Play_Mage_Guild_Sound)|v3=0/v3>8:P3;
  !!FU|v3=0/v3>8:E;                       [Exit if no choice or leave]

  !!DL52:N^WM_Ench.txt^;         [parse dialogue]

  !!if&v3=1;
  !!SN:T^AC_Warmachine.Ballista_0^/?z-2;
  !!VRz-3:S^S_Bal.pcx^;
  !!VRz-7:S^Bal_Ench_1.pcx^;
  !!VRz-8:S^Bal_Ench_2.pcx^;
  !!VRz-9:S^Bal_Ench_3.pcx^;
  !!SN:T^AC_Warmachine.Bal_Ench_1^/?z-4;
  !!SN:T^AC_Warmachine.Bal_Ench_2^/?z-5;
  !!SN:T^AC_Warmachine.Bal_Ench_3^/?z-6;
  !!SN:W^Ballista_Fireball_Attack_%X1^/?y10;    [Check if options have already been activated]
  !!SN:W^Ballista_Magic_Arrow_%X1^/?y11;
  !!SN:W^Ballista_Spell_Trigger_%X1^/?y12;
  !!en;

  !!if&v3=2;
  !!SN:T^AC_Warmachine.Cart_0^/?z-2;
  !!VRz-3:S^S_Cart.pcx^;
  !!VRz-7:S^Cart_Ench_1.pcx^;
  !!VRz-8:S^Cart_Ench_2.pcx^;
  !!VRz-9:S^Cart_Ench_3.pcx^;
  !!SN:T^AC_Warmachine.Cart_Ench_1^/?z-4;
  !!SN:T^AC_Warmachine.Cart_Ench_2^/?z-5;
  !!SN:T^AC_Warmachine.Cart_Ench_3^/?z-6;
  !!SN:W^Ammo_Booby_Trap_%X1^/?y10;
  !!SN:W^Ammo_Replensih_SP_%X1^/?y11;
  !!SN:W^Ammo_Burning_Arrow_%X1^/?y12;
  !!en;

  !!if&v3=4;
  !!SN:T^AC_Warmachine.Tent_0^/?z-2;
  !!VRz-3:S^S_Tent.pcx^;
  !!VRz-7:S^Tent_Ench_1.pcx^;
  !!VRz-8:S^Tent_Ench_2.pcx^;
  !!VRz-9:S^Tent_Ench_3.pcx^;
  !!SN:T^AC_Warmachine.Tent_Ench_1^/?z-4;
  !!SN:T^AC_Warmachine.Tent_Ench_2^/?z-5;
  !!SN:T^AC_Warmachine.Tent_Ench_3^/?z-6;
  !!SN:W^Tent_Herbalism_%X1^/?y10;    [Check if options have already been activated]
  !!SN:W^Tent_Overheal_%X1^/?y11;
  !!SN:W^Tent_Life_Aura_%X1^/?y12;
  !!en;

  !!if&v3=8;
  !!SN:T^AC_Warmachine.Warmachines_0^/?z-2;
  !!VRz-3:S^S_Ench.pcx^;
  !!VRz-7:S^All_Ench_1.pcx^;
  !!VRz-8:S^All_Ench_2.pcx^;
  !!VRz-9:S^All_Ench_3.pcx^;
  !!SN:T^AC_Warmachine.All_Ench_1^/?z-4;
  !!SN:T^AC_Warmachine.All_Ench_2^/?z-5;
  !!SN:T^AC_Warmachine.All_Ench_3^/?z-6;
  !!SN:W^WM_Shield_Ench_%X1^/?y10;    [Check if options have already been activated]
  !!SN:W^WM_MR_Ench_%X1^/?y11;
  !!SN:W^WM_MR_Aura_%X1^/?y12;
  !!en;

  !!DL52:A5/11/z-3/1;                   [show correct skill text what can be leveled]
  !!DL52:A1/11/z-7/1;
  !!DL52:A2/11/z-8/1;
  !!DL52:A3/11/z-9/1;
  !!DL52:A6/3/z-4/1;                    [show correct skill text what can be leveled]
  !!DL52:A9/3/z-5/1;                    [show correct skill text what can be leveled]
  !!DL52:A10/3/z-6/1;                   [show correct skill text what can be leveled]
  !!DL52:A13/4/y10/1;
  !!DL52:A14/4/y11/1;
  !!DL52:A15/4/y12/1;
  !!DL52:S;
!!en;


!?DL&v998=51/v999>=1/v999<=3/v1000=13;  [left click on the three pictures asks if you want to buy the upgrade]
!!VRz1:S^Button.wav^;
!!SN:Pz1;

!!CA-1:H1/?x1; !!FU|x1<0/x1>155:E;      [Exit if no valid hero]
!!SN:W^WM_Upgrade_Selection^/?y10;

!!if&y10=1;
  !!HEx1:A2/4/?y1/?y2;                  [4  Ballista]
  !!SN&y2=0:T^AC_Warmachine.No_Ballista^/?s^Warmachine^;
  !!IF&y2=0:M^%S(Warmachine)^;
  !!FU(Upgrade_Buy_Blacksmith)&y2=1:Px1/v999/y10;
!!en;

!!if&y10=2;
  !!HEx1:A2/5/?y1/?y2;                  [5  Ammo Cart]
  !!SN&y2=0:T^AC_Warmachine.No_Ammo^/?s^Warmachine^;
  !!IF&y2=0:M^%S(Warmachine)^;
  !!FU(Upgrade_Buy_Blacksmith)&y2=1:Px1/v999/y10;
!!en;

!!if&y10=4;
  !!HEx1:A2/6/?y1/?y2;                  [6  First Aid Tent]
  !!SN&y2=0:T^AC_Warmachine.No_Tent^/?s^Warmachine^;
  !!IF&y2=0:M^%S(Warmachine)^;
  !!FU(Upgrade_Buy_Blacksmith)&y2=1:Px1/v999/y10;
!!en;

!!if&y10=8;
  !!HEx1:A2/4/?y1/?y2;                  [All WM]
  !!HEx1:A2/5/?y1/?y3;
  !!HEx1:A2/6/?y1/?y4;
  !!SN|y2=0/y3=0/y4=0:T^AC_Warmachine.No_Machines^/?s^Warmachine^;
  !!IF|y2=0/y3=0/y4=0:M^%S(Warmachine)^;
  !!FU(Upgrade_Buy_Blacksmith)&y2=1/y3=1/y4=1:Px1/v999/y10;
!!en;


!?FU(Upgrade_Buy_Blacksmith);
x1=Hero Number, x2=dialogue ID, x3=selection

!!VRz1&x2=1/x3=1:S^Ballista_Morale^;
!!VRz1&x2=2/x3=1:S^Ballista_Add_Shots^;
!!VRz1&x2=3/x3=1:S^Ballista_Crippling^;

!!VRz1&x2=1/x3=2:S^Ammo_Supply^;
!!VRz1&x2=2/x3=2:S^Ammo_Goblin^;
!!VRz1&x2=3/x3=2:S^Ammo_Enhanced_Arrow^;

!!VRz1&x2=1/x3=4:S^Tent_Improved^;
!!VRz1&x2=2/x3=4:S^Tent_Capacity_Upgrade^;
!!VRz1&x2=3/x3=4:S^Tent_Gold_Gain^;

!!VRz1&x2=1/x3=8:S^WM_Fortification^;
!!VRz1&x2=2/x3=8:S^WM_Maintainability^;
!!VRz1&x2=3/x3=8:S^WM_Versatility^;

!!SN:W^%Z1_%X1^/?y1;
!!SN:T^AC_Warmachine.Already_Bought^/?s^Warmachine^;
!!IF&y1=1:M^%S(Warmachine)^;            [Show text if already bought]
!!FU&y1=1:E;                            [Exit if already bought]

!!if&x2=1/x3=1;                        [Ballista_Morale]
!!VRy20:S15;                            [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S15;                            [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S6000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S6;                             [6  Leadership]
!!SN:T^AC_Warmachine.Bal_Upg_1^/?z-1;   [Get Upgrade Name]
!!en;

!!if&x2=2/x3=1;                        [Ballista_Add_Shots]
!!VRy20:S5;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S11;                            [11 Eagle Eye]
!!SN:T^AC_Warmachine.Bal_Upg_2^/?z-1;
!!en;

!!if&x2=3/x3=1;                        [Ballista_Crippling]
!!VRy20:S5;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S15000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S10;                            [10 Ballistics]
!!SN:T^AC_Warmachine.Bal_Upg_3^/?z-1;
!!en;

!!if&x2=1/x3=2;                        [Ammo_Supply]
!!VRy20:S0;                             [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S26;                            [26 Resistance]
!!SN:T^AC_Warmachine.Cart_Upg_1^/?z-1;
!!en;

!!if&x2=2/x3=2;                        [Ammo_Goblin]
!!VRy20:S5;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S9;                             [9  Luck]
!!SN:T^AC_Warmachine.Cart_Upg_2^/?z-1;
!!en;

!!if&x2=3/x3=2;                        [Ammo_Enhanced_Arrow]
!!VRy20:S20;                            [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S20;                            [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S15000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S8;                             [8  Mysticism]
!!SN:T^AC_Warmachine.Cart_Upg_3^/?z-1;
!!en;

!!if&x2=1/x3=4;                        [Tent_Improved]
!!VRy20:S0;                             [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S10;                            [Gems]
!!VRy26:S8000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S23;                            [23 Armorer]
!!SN:T^AC_Warmachine.Tent_Upg_1^/?z-1;
!!en;

!!if&x2=2/x3=4;                        [Tent_Capacity_Upgrade]
!!VRy20:S0;                             [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S10;                            [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S6000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S18;                            [18 Scholar]
!!SN:T^AC_Warmachine.Tent_Upg_2^/?z-1;
!!en;

!!if&x2=3/x3=4;                        [Tent_Gold_Gain]
!!VRy20:S0;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S13;                            [13 Estates]
!!SN:T^AC_Warmachine.Tent_Upg_3^/?z-1;
!!en;

!!if&x2=1/x3=8;                        [WM_Fortification]
!!VRy20:S10;                            [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S20;                            [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S5000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S-1;                            [None]
!!SN:T^AC_Warmachine.All_Upg_1^/?z-1;
!!en;

!!if&x2=2/x3=8;                        [WM_Maintainability]
!!VRy20:S10;                            [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S-1;                            [None]
!!SN:T^AC_Warmachine.All_Upg_2^/?z-1;
!!en;

!!if&x2=3/x3=8;                        [WM_Versatility]
!!VRy20:S10;                            [Wood]
!!VRy21:S10;                            [Mercury]
!!VRy22:S10;                            [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S0;                             [0  Pathfinding]
!!SN:T^AC_Warmachine.All_Upg_3^/?z-1;
!!en;

!!VRy50:S0R2;
!!SN&y50=0:T^AC_Warmachine.Solid_Choice_1^/?z-2; [Generate Random quote 1]
!!SN&y50=1:T^AC_Warmachine.Solid_Choice_2^/?z-2; [Generate Random quote 2]
!!SN&y50=2:T^AC_Warmachine.Solid_Choice_3^/?z-2; [Generate Random quote 3]
!!SN&y28>=0:H^secskill^/y28/0/?z-3;     [Get Name of Secondary Skill]
!!SN&y28=-1:T^AC_Warmachine.Requirement_1^/?z-4; [Dont Show text with skill requirement]
!!SN&y28>=0:T^AC_Warmachine.Requirement_2^/?z-4; !!SN:Iz-4/?z-4; [Show text with skill requirement]
!!VRy50:S0R2;
!!SN&y50=0:T^AC_Warmachine.Buying_1^/?z-5; [Generate Random quote 1]
!!SN&y50=1:T^AC_Warmachine.Buying_2^/?z-5; [Generate Random quote 2]
!!SN&y50=2:T^AC_Warmachine.Buying_3^/?z-5; [Generate Random quote 3]

!!SN:T^AC_Warmachine.Upgrade_Costs^/?z10; !!SN:Iz10/?z10;
!!IF:Q1^%Z10^;                          [Show text with costs]

!!SN&-1:T^AC_Warmachine.Next_Time^/?s^Warmachine^;
!!VRy1&-1:S0R1;
!!FU(Play_Blacksmith_Sound)&-1/y1=1:P3; [If you dont want to buy play angry sound]

!!if&1;                                [If you want to buy]
!!HEx1:O?y1;                            [Get Hero Owner]
!!VRy29&y28=-1:S1;
!!HEx1&y28>=0/y28<=27:Sy28/?y29;        [Get Secondary Skill check in y29]
!!OW:Ry1/0/?y30 Ry1/1/?y31 Ry1/2/?y32 Ry1/3/?y33 Ry1/4/?y34 Ry1/5/?y35 Ry1/6/?y36 Ry1/7/?y37; [Get value of Resources]

!!if&y30>=y20/y31>=y21/y32>=y22/y33>=y23/y34>=y24/y35>=y25/y36>=y26/y37>=y27/y29>0; [When enough resources and skill learned]
!!VRy20:*-1; !!VRy21:*-1; !!VRy22:*-1; !!VRy23:*-1; !!VRy24:*-1; !!VRy25:*-1; !!VRy26:*-1; !!VRy27:*-1;
!!OW:Ry1/0/dy20 Ry1/1/dy21 Ry1/2/dy22 Ry1/3/dy23 Ry1/4/dy24 Ry1/5/dy25 Ry1/6/dy26 Ry1/7/dy27; [Substract Res from player]

!!SN:T^AC_Warmachine.Purchased^/?s^Warmachine^;
*!IF:M^%S(Warmachine)^;                 [Purchased text]
!!SN:W^%Z1_%X1^/1;                      [Set flag for upgrade]
!!SN:W^WM_Visit_Purchased^/1;
!!VRz9:S^fixit^;
!!SN:Pz9;
!!FU(Play_Blacksmith_Sound):P4;
!!FU(Set_WM_Checkboxes):Px1;            [call func for switch on the user's choice]
!!SN:D;                                 [Redraw status bar]
!!el;                                  [else]
!!SN:T^AC_Warmachine.cant_afford^/?s^Warmachine^;
*!IF:M^%S(Warmachine)^;                 [cant afford text]
!!FU(Play_Blacksmith_Sound):P2;
!!en;
!!en;

!?FU(Set_WM_Checkboxes);

!!SN:W^WM_Upgrade_Selection^/?y1;

!!if&y1=1;
  !!SN:W^Ballista_Morale_%X1^/?y10;
  !!SN:W^Ballista_Add_Shots_%X1^/?y11;
  !!SN:W^Ballista_Crippling_%X1^/?y12;
  !!DL51:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;

!!if&y1=2;
  !!SN:W^Ammo_Supply_%X1^/?y10;
  !!SN:W^Ammo_Goblin_%X1^/?y11;
  !!SN:W^Ammo_Enhanced_Arrow_%X1^/?y12;
  !!DL51:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;

!!if&y1=4;
  !!SN:W^Tent_Improved_%X1^/?y10;
  !!SN:W^Tent_Capacity_Upgrade_%X1^/?y11;
  !!SN:W^Tent_Gold_Gain_%X1^/?y12;
  !!DL51:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;

!!if&y1=8;
  !!SN:W^WM_Fortification_%X1^/?y10;
  !!SN:W^WM_Maintainability_%X1^/?y11;
  !!SN:W^WM_Versatility_%X1^/?y12;
  !!DL51:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;


!?DL&v998=51/v999>=1/v999<=3/v1000=14;  [right click on the three pictures to show text for upgrade and description]

!!SN:W^WM_Upgrade_Selection^/?y1;

!!if&y1=1;
  !!SN&v999=1:T^AC_Warmachine.Bal_Upg_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.Bal_Upg_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.Bal_Upg_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.Bal_Upg_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.Bal_Upg_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.Bal_Upg_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!!if&y1=2;
  !!SN&v999=1:T^AC_Warmachine.Cart_Upg_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.Cart_Upg_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.Cart_Upg_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.Cart_Upg_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.Cart_Upg_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.Cart_Upg_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!!if&y1=4;
  !!SN&v999=1:T^AC_Warmachine.Tent_Upg_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.Tent_Upg_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.Tent_Upg_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.Tent_Upg_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.Tent_Upg_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.Tent_Upg_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!!if&y1=8;
  !!SN&v999=1:T^AC_Warmachine.All_Upg_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.All_WM_Upg_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.All_Upg_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.All_WM_Upg_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.All_Upg_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.All_WM_Upg_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!?FU(Play_Blacksmith_Sound);
x1=attidude 1-4

!!CA-1:T?y1;
!!FU|y1<0/y1>8:E;                       [Exit if no valid Town number]
!!VRz2&y1=0:S^Human^;
!!VRz2&y1=1:S^Dwarf^;
!!VRz2&y1=2:S^Wizard^;
!!VRz2&y1=3:S^Evil^;
!!VRz2&y1=4:S^Evil^;
!!VRz2&y1=5:S^Warlock^;
!!VRz2&y1=6:S^Warlock^;
!!VRz2&y1=7:S^Human^;
!!VRz2&y1=8:S^Elf^;
!!VRz1:S^%Z2 Weapon shop 0%X1^;
!!SN:Pz1;                               [play quest sound before showing dialogue]


!?DL&v998=51/v999=30721/v1000=13;       [Reset Close]
!!DL:C1;

!?DL&v998=51/v999=30722/v1000=13;       [Save Confirm]
!!DL:C1;


****************************************************************************************************
!?DL&v998=52/v999>=1/v999<=3/v1000=13;  [left click on the three pictures asks if you want to buy the upgrade]

!!VRz1:S^Button.wav^;
!!SN:Pz1;

!!CA-1:H1/?x1; !!FU|x1<0/x1>155:E;      [Exit if no valid hero]
!!SN:W^WM_Upgrade_Selection^/?y10;

!!if&y10=1;
!!HEx1:A2/4/?y1/?y2;                    [4  Ballista]
!!SN&y2=0:T^AC_Warmachine.No_Ballista^/?s^Warmachine^;
!!IF&y2=0:M^%S(Warmachine)^;
!!FU(Upgrade_Buy_Mage_Guild)&y2=1:Px1/v999/y10;
!!en;

!!if&y10=2;
!!HEx1:A2/5/?y1/?y2;                    [5  Ammo Cart]
!!SN&y2=0:T^AC_Warmachine.No_Ammo^/?s^Warmachine^;
!!IF&y2=0:M^%S(Warmachine)^;
!!FU(Upgrade_Buy_Mage_Guild)&y2=1:Px1/v999/y10;
!!en;

!!if&y10=4;
!!HEx1:A2/6/?y1/?y2;                    [6  First Aid Tent]
!!SN&y2=0:T^AC_Warmachine.No_Tent^/?s^Warmachine^;
!!IF&y2=0:M^%S(Warmachine)^;
!!FU(Upgrade_Buy_Mage_Guild)&y2=1:Px1/v999/y10;
!!en;

!!if&y10=8;
!!HEx1:A2/4/?y1/?y2;                    [All WM]
!!HEx1:A2/5/?y1/?y3;
!!HEx1:A2/6/?y1/?y4;
!!SN|y2=0/y3=0/y4=0:T^AC_Warmachine.No_Machines^/?s^Warmachine^;
!!IF|y2=0/y3=0/y4=0:M^%S(Warmachine)^;
!!FU(Upgrade_Buy_Mage_Guild)&y2=1/y3=1/y4=1:Px1/v999/y10;
!!en;


!?FU(Upgrade_Buy_Mage_Guild);
x1=Hero Number, x2=dialogue ID, x3=selection

!!VRz1&x2=1/x3=1:S^Ballista_Fireball_Attack^;
!!VRz1&x2=2/x3=1:S^Ballista_Magic_Arrow^;
!!VRz1&x2=3/x3=1:S^Ballista_Spell_Trigger^;

!!VRz1&x2=1/x3=2:S^Ammo_Booby_Trap^;
!!VRz1&x2=2/x3=2:S^Ammo_Replensih_SP^;
!!VRz1&x2=3/x3=2:S^Ammo_Burning_Arrow^;

!!VRz1&x2=1/x3=4:S^Tent_Herbalism^;
!!VRz1&x2=2/x3=4:S^Tent_Overheal^;
!!VRz1&x2=3/x3=4:S^Tent_Life_Aura^;

!!VRz1&x2=1/x3=8:S^WM_Shield_Ench^;
!!VRz1&x2=2/x3=8:S^WM_MR_Ench^;
!!VRz1&x2=3/x3=8:S^WM_MR_Aura^;

!!SN:W^%Z1_%X1^/?y1;
!!SN:T^AC_Warmachine.Already_Bought^/?s^Warmachine^;
!!IF&y1=1:M^%S(Warmachine)^;            [Show text if already bought]
!!FU&y1=1:E;                            [Exit if already bought]

!!if&x2=1/x3=1;                        [Ballista_Fireball_Attack]
!!VRy20:S0;                             [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S15;                            [Sulfur]
!!VRy24:S10;                            [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S14;                            [14 Fire Magic]
!!SN:T^AC_Warmachine.Bal_Ench_1^/?z-1;  [Get Upgrade Name]
!!en;

!!if&x2=2/x3=1;                        [Ballista_Magic_Arrow]
!!VRy20:S0;                             [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S0;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S20000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S25;                            [25 Sorcery]
!!SN:T^AC_Warmachine.Bal_Ench_2^/?z-1;
!!en;

!!if&x2=3/x3=1;                        [Ballista_Spell_Trigger]
!!VRy20:S0;                             [Wood]
!!VRy21:S15;                            [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S15;                            [Sulfur]
!!VRy24:S15;                            [Crystal]
!!VRy25:S15;                            [Gems]
!!VRy26:S5000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S4;                             [4  Diplomacy]
!!SN:T^AC_Warmachine.Bal_Ench_3^/?z-1;
!!en;

!!if&x2=1/x3=2;                        [Ammo_Booby_Trap]
!!VRy20:S15;                            [Wood]
!!VRy21:S0;                             [Mercury]
!!VRy22:S10;                            [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S0;                             [Crystal]
!!VRy25:S0;                             [Gems]
!!VRy26:S5000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S22;                            [22 Offence]
!!SN:T^AC_Warmachine.Cart_Ench_1^/?z-1;
!!en;

!!if&x2=2/x3=2;                        [Ammo_Replensih_SP]
!!VRy20:S5;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S5000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S21;                            [21 Learning]
!!SN:T^AC_Warmachine.Cart_Ench_2^/?z-1;
!!en;

!!if&x2=3/x3=2;                        [Ammo_Burning_Arrow]
!!VRy20:S20;                            [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S20;                            [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S15000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S14;                            [14 Fire Magic]
!!SN:T^AC_Warmachine.Cart_Ench_3^/?z-1;
!!en;

!!if&x2=1/x3=4;                        [Tent_Herbalism]
!!VRy20:S5;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S27;                            [27 First Aid]
!!SN:T^AC_Warmachine.Tent_Ench_1^/?z-1;
!!en;

!!if&x2=2/x3=4;                        [Tent_Overheal]
!!VRy20:S2;                             [Wood]
!!VRy21:S2;                             [Mercury]
!!VRy22:S2;                             [Ore]
!!VRy23:S2;                             [Sulfur]
!!VRy24:S2;                             [Crystal]
!!VRy25:S2;                             [Gems]
!!VRy26:S15000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S19;                            [19 Tactics]
!!SN:T^AC_Warmachine.Tent_Ench_2^/?z-1;
!!en;

!!if&x2=3/x3=4;                        [Tent_Life_Aura]
!!VRy20:S0;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S10;                            [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S20000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S16;                            [16 Water Magic]
!!SN:T^AC_Warmachine.Tent_Ench_3^/?z-1;
!!en;

!!if&x2=1/x3=8;                        [WM_Shield_Ench]
!!VRy20:S0;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S0;                             [Ore]
!!VRy23:S2;                             [Sulfur]
!!VRy24:S2;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S8000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S17;                            [17 Earth Magic]
!!SN:T^AC_Warmachine.All_Ench_1^/?z-1;
!!en;

!!if&x2=2/x3=8;                        [WM_MR_Ench]
!!VRy20:S5;                             [Wood]
!!VRy21:S5;                             [Mercury]
!!VRy22:S5;                             [Ore]
!!VRy23:S5;                             [Sulfur]
!!VRy24:S5;                             [Crystal]
!!VRy25:S5;                             [Gems]
!!VRy26:S6000;                          [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S-1;                            [None]
!!SN:T^AC_Warmachine.All_Ench_2^/?z-1;
!!en;

!!if&x2=3/x3=8;                        [WM_MR_Aura]
!!VRy20:S10;                            [Wood]
!!VRy21:S10;                            [Mercury]
!!VRy22:S10;                            [Ore]
!!VRy23:S10;                            [Sulfur]
!!VRy24:S10;                            [Crystal]
!!VRy25:S10;                            [Gems]
!!VRy26:S10000;                         [Gold]
!!VRy27:S0;                             [Mithril]
!!VRy28:S-1;                            [None]
!!SN:T^AC_Warmachine.All_Ench_3^/?z-1;
!!en;

!!VRy50:S0R2;
!!SN&y50=0:T^AC_Warmachine.Solid_Choice_1^/?z-2; [Generate Random quote 1]
!!SN&y50=1:T^AC_Warmachine.Solid_Choice_2^/?z-2; [Generate Random quote 2]
!!SN&y50=2:T^AC_Warmachine.Solid_Choice_3^/?z-2; [Generate Random quote 3]
!!SN&y28>=0:H^secskill^/y28/0/?z-3;     [Get Name of Secondary Skill]
!!SN&y28=-1:T^AC_Warmachine.Requirement_1^/?z-4; [Dont Show text with skill requirement]
!!SN&y28>=0:T^AC_Warmachine.Requirement_2^/?z-4; !!SN:Iz-4/?z-4; [Show text with skill requirement]
!!VRy50:S0R2;
!!SN&y50=0:T^AC_Warmachine.Buying_1^/?z-5; [Generate Random quote 1]
!!SN&y50=1:T^AC_Warmachine.Buying_2^/?z-5; [Generate Random quote 2]
!!SN&y50=2:T^AC_Warmachine.Buying_3^/?z-5; [Generate Random quote 3]

!!SN:T^AC_Warmachine.Upgrade_Costs^/?z10; !!SN:Iz10/?z10;
!!IF:Q1^%Z10^;                [Show text with costs]


!!SN&-1:T^AC_Warmachine.Next_Time^/?s^Warmachine^;
!!VRy1&-1:S0R1;
!!FU(Play_Mage_Guild_Sound)&-1/y1=1:P3; [Angry Sound If you dont want to buy]

!!if&1;                                [If you want to buy]
!!HEx1:O?y1;                            [Get Hero Owner]
!!VRy29&y28=-1:S1;
!!HEx1&y28>=0/y28<=27:Sy28/?y29;        [Get Secondary Skill check in y29]
!!OW:Ry1/0/?y30 Ry1/1/?y31 Ry1/2/?y32 Ry1/3/?y33 Ry1/4/?y34 Ry1/5/?y35 Ry1/6/?y36 Ry1/7/?y37; [Get value of Resources]

!!if&y30>=y20/y31>=y21/y32>=y22/y33>=y23/y34>=y24/y35>=y25/y36>=y26/y37>=y27/y29>0; [When enough resources and skill learned]
!!VRy20:*-1; !!VRy21:*-1; !!VRy22:*-1; !!VRy23:*-1; !!VRy24:*-1; !!VRy25:*-1; !!VRy26:*-1; !!VRy27:*-1;
!!OW:Ry1/0/dy20 Ry1/1/dy21 Ry1/2/dy22 Ry1/3/dy23 Ry1/4/dy24 Ry1/5/dy25 Ry1/6/dy26 Ry1/7/dy27; [Substract Res from player]

!!SN:T^AC_Warmachine.Purchased^/?s^Warmachine^;
*!IF:M^%S(Warmachine)^;                 [Purchased text]
!!SN:W^%Z1_%X1^/1;                      [Set flag for upgrade]
!!SN:W^WM_Visit_Purchased^/1;
*!VRy1:S0R1;
!!VRz9:S^Enchant Item^;
!!SN:Pz9;
!!FU(Play_Mage_Guild_Sound):P4;         [play quest sound before showing dialogue approve sounds]

!!FU(Set_WM_Checkboxes_1):Px1;          [call func for switch on the user's choice]
!!SN:D;                                 [Redraw status bar]
!!el;                                  [else]
!!SN:T^AC_Warmachine.cant_afford^/?s^Warmachine^;
*!IF:M^%S(Warmachine)^;                 [cant afford text]
!!FU(Play_Mage_Guild_Sound):P2;         [Not enough Money]
!!en;
!!en;


!?FU(Set_WM_Checkboxes_1);

!!SN:W^WM_Upgrade_Selection^/?y1;

!!if&y1=1;
  !!SN:W^Ballista_Fireball_Attack_%X1^/?y10; [Check if options have already been activated]
  !!SN:W^Ballista_Magic_Arrow_%X1^/?y11;
  !!SN:W^Ballista_Spell_Trigger_%X1^/?y12;
  !!DL52:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;

!!if&y1=2;
  !!SN:W^Ammo_Booby_Trap_%X1^/?y10;     [Check if options have already been activated]
  !!SN:W^Ammo_Replensih_SP_%X1^/?y11;
  !!SN:W^Ammo_Burning_Arrow_%X1^/?y12;
  !!DL52:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;

!!if&y1=4;
  !!SN:W^Tent_Herbalism_%X1^/?y10;      [Check if options have already been activated]
  !!SN:W^Tent_Overheal_%X1^/?y11;
  !!SN:W^Tent_Life_Aura_%X1^/?y12;
  !!DL52:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;

!!if&y1=8;
  !!SN:W^WM_Shield_Ench_%X1^/?y10;      [Check if options have already been activated]
  !!SN:W^WM_MR_Ench_%X1^/?y11;
  !!SN:W^WM_MR_Aura_%X1^/?y12;
  !!DL52:A13/4/y10/1 A14/4/y11/1 A15/4/y12/1;
!!en;


!?DL&v998=52/v999>=1/v999<=3/v1000=14;  [right click on the three pictures to show text for upgrade and description]

!!SN:W^WM_Upgrade_Selection^/?y1;

!!if&y1=1;
  !!SN&v999=1:T^AC_Warmachine.Bal_Ench_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.Bal_Ench_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.Bal_Ench_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.Bal_Ench_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.Bal_Ench_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.Bal_Ench_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!!if&y1=2;
  !!SN&v999=1:T^AC_Warmachine.Cart_Ench_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.Cart_Ench_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.Cart_Ench_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.Cart_Ench_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.Cart_Ench_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.Cart_Ench_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!!if&y1=4;
  !!SN&v999=1:T^AC_Warmachine.Tent_Ench_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.Tent_Ench_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.Tent_Ench_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.Tent_Ench_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.Tent_Ench_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.Tent_Ench_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;

!!if&y1=8;
  !!SN&v999=1:T^AC_Warmachine.All_Ench_1^/?z-1; [Get Upgrade Name of 1st]
  !!SN&v999=1:T^AC_Warmachine.All_WM_Ench_1_Description^/?z1; [set text for 1st]
  !!SN&v999=2:T^AC_Warmachine.All_Ench_2^/?z-1;
  !!SN&v999=2:T^AC_Warmachine.All_WM_Ench_2_Description^/?z1; [2nd]
  !!SN&v999=3:T^AC_Warmachine.All_Ench_3^/?z-1;
  !!SN&v999=3:T^AC_Warmachine.All_WM_Ench_3_Description^/?z1; [...]
  !!SN:Iz1/?z1;
  !!IF:M0/4/^%Z1^;
!!en;


!?FU(Play_Mage_Guild_Sound);
x1=attidude 1-4

!!CA-1:T?y1;
!!FU|y1<0/y1>8:E;                       [Exit if no valid Town number]
!!VRz2&y1=0:S^Human^;
!!VRz2&y1=1:S^Dwarf^;
!!VRz2&y1=2:S^Wizard^;
!!VRz2&y1=3:S^Evil^;
!!VRz2&y1=4:S^Evil^;
!!VRz2&y1=5:S^Warlock^;
!!VRz2&y1=6:S^Warlock^;
!!VRz2&y1=7:S^Human^;
!!VRz2&y1=8:S^Elf^;
!!VRz1:S^%Z2 Magic shop 0%X1^;
!!SN:Pz1;                               [play quest sound before showing dialogue]

Close Dialouges*
!?DL&v998=52/v999=30721/v1000=13;       [Reset Close]
!!DL:C1;

!?DL&v998=52/v999=30722/v1000=13;       [Save Confirm]
!!DL:C1;

!?DL&v998=81/v999=30722/v1000=13;
!!SN:W^WM_Window_Selection^/?y1;
!!SN:W^WM_Visit_Purchased^/?y2;
!!FU(Play_Blacksmith_Sound)&y1=1/y2=0:P3;
!!FU(Play_Mage_Guild_Sound)&y1=2/y2=0:P3;[Play angry sound if no upgrade was purchased this visit]
!!DL:C1;

****************************************************************************************************

                      Combat Scripting of Warchmines Upgrades

****************************************************************************************************
*Teach AI how to use WM Upgrades and Enchantments
!?HL-1&-1000;
There are 24 Upgrades in total.
!!VRy2:S1R23;                           [Generate Random Number from 1-24]
!!HE-1:N?y1;                            [Get Hero Number]
!!SN&y2=1:W^Ballista_Fireball_Attack_%Y1^/1;
!!SN&y2=2:W^Ballista_Magic_Arrow_%Y1^/1;
!!SN&y2=3:W^Ballista_Spell_Trigger_%Y1^/1;
!!SN&y2=4:W^Ammo_Booby_Trap_%Y1^/1;
!!SN&y2=5:W^Ammo_Replensih_SP_%Y1^/1;
!!SN&y2=6:W^Ammo_Burning_Arrow_%Y1^/1;
!!SN&y2=7:W^Tent_Herbalism_%Y1^/1;
!!SN&y2=8:W^Tent_Overheal_%Y1^/1;
!!SN&y2=9:W^Tent_Life_Aura_%Y1^/1;
!!SN&y2=10:W^WM_Shield_Ench_%Y1^/1;
!!SN&y2=11:W^WM_MR_Ench_%Y1^/1;
!!SN&y2=12:W^WM_MR_Aura_%Y1^/1;
!!SN&y2=13:W^Ballista_Morale_%Y1^/1;
!!SN&y2=14:W^Ballista_Add_Shots_%Y1^/1;
!!SN&y2=15:W^Ballista_Crippling_%Y1^/1;
!!SN&y2=16:W^Ammo_Supply_%Y1^/1;
!!SN&y2=17:W^Ammo_Goblin_%Y1^/1;
!!SN&y2=18:W^Ammo_Enhanced_Arrow_%Y1^/1;
!!SN&y2=19:W^Tent_Improved_%Y1^/1;
!!SN&y2=20:W^Tent_Capacity_Upgrade_%Y1^/1;
!!SN&y2=21:W^Tent_Gold_Gain_%Y1^/1;
!!SN&y2=22:W^WM_Fortification_%Y1^/1;
!!SN&y2=23:W^WM_Maintainability_%Y1^/1;
!!SN&y2=24:W^WM_Versatility_%Y1^/1;


**********************Fortified Warmachines* Add HP and Def to all**********************************
*adds 250HP and 5 Defense to all WM*

!?FU(OnCombatRound)&v997=0;             [On First visible combat round]

!!BA:H0/?y1;
!!SN:W^WM_Fortification_%Y1^/?y10;
!!VRy5:S5;                              [Attack and Defense]
!!VRy6:S250;                            [Health]

!!re i/0/10;
  !!BMi:T?y3;                           [Get Creature Type ]
    !!if&y10=1;
      !!if|y3=145/y3=146/y3=147/y3=148;[If Ballista found for Defender]
        !!BMi:Ddy5;
        !!BMi:Hdy6;
      !!en;
    !!en;
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!SN:W^WM_Fortification_%Y1^/?y10; !!FU&y10=0:E;
!!re i/21/31;
  !!BMi:T?y3;                           [Get Creature Type ]
    !!if&y10=1;
      !!if|y3=145/y3=146/y3=147/y3=148;[If Ballista found for Defender]
        !!BMi:Ddy5;
        !!BMi:Hdy6;
      !!en;
    !!en;
!!en;


**********************Warmachines can have Morale********************
*Sets Morale Flag to Ballista*
!?BG0&1000;

!!VRy1:S0R99;
!!FU&y1>=10:E;                          [10% chance for Morale]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y2 N?y3;
!!BG:A?y4;                              [Aktion in y1]
!!BG:H?y5;                              [Current Hero]
!!FU&y5<0:E;                            [Exit if no Hero]
!!SN:W^Ballista_Morale_%Y5^/?y6;

!!if&y2=146/y3=1/y4=7/y6=1;
!!UN:C4605354/4/1;                      [some UN C Magic]
!!SN:W^Warmachines_Morale_Trigger^/1;   [enable Flag]
!!en;

!?BG1&1000;

!!SN:W^Warmachines_Morale_Trigger^/?y1; [check flag]
!!FU&y1<>1:E;                           [exit if not]
!!SN:W^Warmachines_Morale_Trigger^/0;   [reset flag]
!!UN:C4605354/4/24;


!?BF&1000;
*Remove Ballista Flag for no morale for attacker and defender
!!BA:H0/?y1;
!!SN:W^Ballista_Morale_%Y1^/?y2;
!!if&y1>=0/y2=1;
  !!re i/0/10;
    !!BMi:T?y3;
    !!if&y3=146;
      !!BMi:F?y1;
      !!VRy1:&-131073;                  [Flag for no morale]
      !!BMi:Fy1;
    !!en;
  !!en;
!!en;

!!BA:H1/?y1;
!!SN:W^Ballista_Morale_%Y1^/?y2;
!!if&y1>=0/y2=1;
  !!re i/21/31;
    !!BMi:T?y3;
    !!if&y3=146;
      !!BMi:F?y1;
      !!VRy1:&-131073;                  [Flag for no morale]
      !!BMi:Fy1;
    !!en;
  !!en;
!!en;

************************Ballista Enchantment Fireball Attack**********************
*Fireball Attack deals 33% of the damage to all surrounding creatures

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y40;                           [Get Type in y40]
!!FU&y40<>146:E;                        [Exit if no Ballista as Attacker]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ballista_Fireball_Attack_%Y99^/?y90; [Check if options have already been activated]
!!FU&y90=0:E;                           [Exit if enchantment is not bought]

!!BA:Q?f;
!!BMy4&f=0:V53;                         [Show Fireball animation]
!!BMy4:P?y1 I?y30;                      [get target position and Side]
!!MF:F?y10;                             [get damage of ballista]
!!VRy10::3;                             [33% of the damage]

!!FU(AC_Function_126):Py1/0/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/1/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/2/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/3/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/4/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]

!!FU(AC_Function_126):Py1/5/?y3;
!!BU&y3>=0/y3<=186:Ey3/?y8;             [-2 if there is alive stack at that position]
!!BMy8&y8>=0/y8<=41/y4<>y8:I?y40;       [apply damage to surrounding creatures]
!!BMy8&y8>=0/y8<=41/y4<>y8/y40=y30:Ky10;[apply damage to surrounding creatures if same side]


************************Ballista Magic Arrow upgrade**********************
*Magic Damage based on your SP*5 is added to damage

!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y40;                           [Get Type in y40]
!!FU&y40<>146:E;                        [Exit if no Ballista as Attacker]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ballista_Magic_Arrow_%Y99^/?y90; [Check if options have already been activated]
!!FU&y90=0:E;                           [Exit if enchantment is not bought]
!!HEy99:F?y9/?y9/?y11/?y9;
!!VRy12:Sy11*5;                         [add 5* Spell Power from Hero to Damage]
!!MF:F?y10;                             [get damage of ballista]
!!VRy13:Sy10+y12;
!!MF:Fy13;

************************Ballista Spell Trigger upgrade**********************
*Chance with every hit to Trigger a Spell on the Target

!?MF1;

!!VRy1:S0R99;
!!FU&y1>10:E;                           [10% Chance to Trigger the Spell]
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!BMy1:T?y40;                           [Get Type in y40]
!!FU&y40<>146:E;                        [Exit if no Ballista as Attacker]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ballista_Spell_Trigger_%Y99^/?y90;[Check if options have already been activated]
!!FU&y90=0:E;                           [Exit if enchantment is not bought]
!!BMy4:P?y2;
!!VRy10:S0R6;
!!VRy11|y10=0/y10=1:S15;                [Magic Arrow]
!!VRy11|y10=2/y10=3:S16;                [Ice Bolt]
!!VRy11|y10=4/y10=5:S17;                [Lightning]
!!VRy11&y10=6:S18;                      [Implosion]
!!BMy1:Cy11/y2/3/3/1;                   [Make Ballista Cast Spell on Target]

****************************************************************************************************
*Ammo Cart adds a little bonus movement 100
!?FU(OnEveryDay)&i^timerOnce^=1/i^timerIsAi^=0;

!!re y1/0/155;
  !!HEy1:O?y2;                          [Checke Hero Owner]
  !!if&y2>=0/y2<=7;
    !!SN:W^Ammo_Supply_%Y1^/?y11;       [Check if options have already been activated]
    !!HEy1:A2/5/?y9/?y10;               [5 Ammo Cart]
    !!HEy1&y10=1/y11=1:Wd100/1;         [Add little Bonus Movement]
  !!en;
!!en;


************************Ammo Cart Supply Upgrade***********************************************
*+1 Speed in first Battle Round

!?FU(OnCombatRound)&v997=0;

!!SN:W^Ammo_Speed_Bonus_Att^/0;
!!SN:W^Ammo_Speed_Bonus_Def^/0;

!!BH0:N?y1;                             [Attacker]
!!HEy1:A2/5/?y1/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Supply_%Y1^/?y11;           [Check if options have already been activated]
!!DO(AC_Function_4)/0/20/1&y10=1/y11=1:P1; [Increase Speed]
!!SN&y10=1/y11=1:W^Ammo_Speed_Bonus_Att^/1; [Set Flag for Attacker]

!!BH1:N?y1;                             [Defender]
!!FU&y1<0:E;
!!HEy1:A2/5/?y1/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Supply_%Y1^/?y11;           [Check if options have already been activated]
!!DO(AC_Function_4)/21/41/1&y10=1/y11=1:P1;
!!SN&y10=1/y11=1:W^Ammo_Speed_Bonus_Def^/1;


!?FU(OnCombatRound)&v997=1;

!!SN:W^Ammo_Speed_Bonus_Att^/?y1;       [Check Flag]
!!DO(AC_Function_4)/0/20/1&y1=1:P2;     [Reduce Speed]
!!SN:W^Ammo_Speed_Bonus_Def^/?y1;
!!DO(AC_Function_4)/21/41/1&y1=1:P2;


***************************Ballista Upgrade**********************
*Chance for Crushing Blow for Ballista at Blacksmith
First hit works 100%, the next Arrow only has 20% chance to hit
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy1:T?y2;                            [Creature Type]
!!FU&y2<>146:E;                         [Exit if no Ballista]
!!BG:H?y5;                              [Hero Number]
!!SN:W^Ballista_Crippling_%Y5^/?y6;     [Exit if no Upgrade]
!!FU|y6=0/y5<0:E;
!!SN:W^Ballista_Crippling_Target_%Y4^/?y1; [Set flag that creature has been targetet with ballista]

!!if&y1=1;
  !!VRy10:S0T99;
  !!FU&y10>=24:E;                       [If Target has already been hit the next arrow only has 25% chance to crush]
!!en;
!!if&y1>1;
  !!VRy10:S0T99;
  !!FU&y10>=14:E;                       [If Target has already been hit the next arrow only has 15% chance to crush]
!!en;

!!BA:Q?f;
!!BMy4&1000/f=0:V14;
!!BMy4:Ad-4;                            [Attack -x]
!!BMy4:Dd-4;                            [Defense -x]
!!BMy4:Sd-1;                            [Speed -x]
!!BMy4:A?y20; !!VRy20&y20<=1:S1; !!BMy4:Ay20;
!!BMy4:D?y21; !!VRy21&y21<=1:S1; !!BMy4:Dy21;
!!BMy4:S?y22; !!VRy22&y22<=2:S2; !!BMy4:Sy22;

!!SN:W^Ballista_Crippling_Target_%Y4^/d1;[Set flag that creature has been targetet with ballista]
!!VRz-1&1000:S^DWRFDFND^;
!!SN&1000/f=0:Pz-1;

!?BF;
!!re y1/0/41;
!!SN:W^Ballista_Crippling_Target_%Y1^/0;[Set flag that creature has been targetet with ballista]
!!en;


*********************************Burning Arrows*****************************************************
*Blacksmith Upgrade for Ammo Cart lets ranged attacks burn enemies for 10% (or 15% with Fire Orb) of the damage in the next round
!?MF1;

!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!FU&y10<>4455011:E;                    [Shooting Damage]

!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>7:E;                           [or Shoot]
!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]
!!FU|y40=33/y40=52/y40=53/y40=82/y40=83/y40=114/y40=116/y40=117/y40=121/y40=125:E;
!!FU|y40=129/y40=130/y40=131/y40=155/y40=158/y40=164/y40=195:E;
!!BMy4:G31/?y41/?y42;                   [Get Fire Resistance]
!!FU&y41>0/y42=3:E;                     [Exit if Expert Fire Resistance]

!!BMy1:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ammo_Burning_Arrow_%Y99^/?y90;
!!FU&y90=0:E;                           [Exit if Set is not complete (6)]

!!HEy99:A2/5/?y10/?y16;                 [5  Ammo Cart ]
!!FU&y16=0:E;                           [Exit if No Ammo Cart]
!!HEy99:A2/81/?y10/?y16;                [81 Orb of Tempestuous Fire]
!!VRy50:S10;
!!VRy50&y16=1:S15;
!!MF:F?y6;
!!VRy7:Sy6*y50:100;                     [Take 10% of damage dealt]
!!FU&y7=0:E;                            [Exit if not enough damage]
!!BMy4:M21/1/3;                         [apply incinerate to stack]
!!BMy4&y4=0:M21/2/3;                    [fix?]
!!SN:W^Burned_Stack_%Y4^/dy7;           [Add and Stack Damage to the Stack]


***************************Ammo Cart Enhanced Arrows**********************
*+1 Max damage to all troops
!?FU(OnCombatRound)&v997=0;

!!BH0:N?y1;                             [Attacker]
!!HEy1:A2/5/?y2/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Enhanced_Arrow_%Y1^/?y11;   [Check if options have already been activated]
!!if&y10=1/y11=1;
  !!re i/0/20;
    !!BMi:U2/d1;                        [+1Max Damage]
  !!en;
!!en;

!!BH1:N?y1; !!FU&y1<0:E;                [Defender]
!!HEy1:A2/5/?y2/?y10;                   [5 Ammo Cart]
!!SN:W^Ammo_Enhanced_Arrow_%Y1^/?y11;   [Check if options have already been activated]
!!if&y10=1/y11=1;
  !!re i/21/41;
    !!BMi:U2/d1;                        [+1Max Damage]
  !!en;
!!en;


***************************Ammo Cart Booby Trap**********************
*If Strike kills Ammo Cart it explodes and deals 25%+2000 points of damage in melee

!?MF1;
!!UN:C42149568/4/?y10;                  [Get Physical Damage type]
!!if|y10=4462398/y10=4456676;          [Only run when melee or surround damage]

!!BG:N?y1;                              [Attacking Stack]
!!MF:N?y4;                              [damage receiving stack]
!!BMy4:T?y40;                           [Get Type in y40]
!!FU&y40<>148:E;                        [Exit if not Ammo Cart]

!!BMy4:I?y5;                            [Side index as for heroes (0:left, 1:right)]
!!BA:Hy5/?y99;
!!FU&y99<0:E;                           [Exit if no Hero]
!!SN:W^Ammo_Booby_Trap_%Y99^/?y90;
!!FU&y90=0:E;                           [Exit if Upgrade not bought]

!!BMy4:H?y10;                           [Get Health of Ammo Cart]
!!MF:F?y6;
!!BA:Q?f;
!!if&y6>=y10;                          [If damage is biggger than Health of Ammo Cart]
  !!VRz-1&f=0:S^ExplosionMine^;
  !!SN&f=0:Pz-1;                        [play quest sound before showing dialogue]
  !!BMy1&f=0:V9;                        [Play Inferno Animation]
  !!BMy1:N?y2 H?y4;
  !!VRy5:Sy2*y4:4+2000;
  !!BMy1:Ky5;                           [Strike with 25% of stacks health +1000 points]
  !!BMy1:N?y3;
  !!if&y3=0/y2>0;                      [If monster would be killes set to summon so it vanishes]
    !!BMy1:F?i;
    !!VRi:|813694976;
    !!BMy1:Fi K1;                       [set new modified bit]
  !!en;
!!en;


*******************************Life Aura First Aid Tent Upgrade*************************************
!?FU(OnCombatRound)&v997=0;
*Life Aura Gives all living untis +5% HP

!!BH0:N?y1;                             [Attacker]
!!HEy1:A2/6/?y2/?y10;                   [6  First Aid Tent]
!!SN:W^Tent_Life_Aura_%Y1^/?y11;
!!if&y10=1/y11=1;
  !!re i/0/20;
  !!BMi:F?j; !!VRj:&16;                 [Check living flag]
  !!BMi:H?y3;!!VRy4:Sy3*105:100; !!VRy4&y4=y3:+1; !!BMi&j>0:Hy4; [+5% HP but min+1HP]
  !!en;
!!en;

!!BH1:N?y1; !!FU&y1<0:E;                [Defender]
!!HEy1:A2/6/?y2/?y10;                   [6  First Aid Tent]
!!SN:W^Tent_Life_Aura_%Y1^/?y11;
!!if&y10=1/y11=1;
  !!re i/21/41;
  !!BMi:F?j; !!VRj:&16;                 [Check living flag]
  !!BMi:H?y3;!!VRy4:Sy3*105:100; !!VRy4&y4=y3:+1; !!BMi&j>0:Hy4; [+5% HP but min+1HP]
  !!en;
!!en;


*******************************WM Maintainability***************************************************
*WM get repaired after battle, but that costs a few 250 movement points*
*Upgrade happens without further notice to the player, you can just see on the decerased movement points*
!?FU(OnBeforeBattleUniversal);

!!SN:W^WM_Maintain_Att_Bal^/0;  !!SN:W^WM_Maintain_Def_Bal^/0;
!!SN:W^WM_Maintain_Att_Ammo^/0; !!SN:W^WM_Maintain_Def_Ammo^/0;
!!SN:W^WM_Maintain_Att_Tent^/0; !!SN:W^WM_Maintain_Def_Tent^/0;

!!BA:H0/?y1;                            [Attacker]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!SN&y10=1:W^WM_Maintain_Att_Bal^/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN&y11=1:W^WM_Maintain_Att_Ammo^/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN&y12=1:W^WM_Maintain_Att_Tent^/1; [6  First Aid Tent]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Defender]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!SN&y10=1:W^WM_Maintain_Def_Bal^/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN&y11=1:W^WM_Maintain_Def_Ammo^/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN&y12=1:W^WM_Maintain_Def_Tent^/1; [6  First Aid Tent]
!!en;

!?FU(OnAfterBattleUniversal);

!!BA:H0/?y1;                            [Attacker]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!VRy50:S-250;
  !!HEy1:A2/4/?y2/?y10; !!SN:W^WM_Maintain_Att_Bal^/?y21;  !!HEy1&y10=0/y21=1:A4/4; !!HEy1&y10=0/y21=1/1000:Wdy50/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN:W^WM_Maintain_Att_Ammo^/?y22; !!HEy1&y11=0/y22=1:A4/5; !!HEy1&y11=0/y22=1/1000:Wdy50/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN:W^WM_Maintain_Att_Tent^/?y23; !!HEy1&y12=0/y23=1:A4/6; !!HEy1&y12=0/y23=1/1000:Wdy50/1; [6  First Aid Tent]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Defender]
!!SN:W^WM_Maintainability_%Y1^/?y11;
!!if&y11=1;
  !!VRy50:S-250;
  !!HEy1:A2/4/?y2/?y10; !!SN:W^WM_Maintain_Def_Bal^/?y21;  !!HEy1&y10=0/y21=1:A4/4; !!HEy1&y10=0/y21=1/1000:Wdy50/1; [4  Ballista ]
  !!HEy1:A2/5/?y2/?y11; !!SN:W^WM_Maintain_Def_Ammo^/?y22; !!HEy1&y11=0/y22=1:A4/5; !!HEy1&y11=0/y22=1/1000:Wdy50/1; [5  Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!SN:W^WM_Maintain_Def_Tent^/?y23; !!HEy1&y12=0/y23=1:A4/6; !!HEy1&y12=0/y23=1/1000:Wdy50/1; [6  First Aid Tent]
!!en;


**********************Warmachines can be used everywhere********************************************
!?BF&1000;

!!BA:H0/?y1;                            [Attacker]
!!SN:W^WM_Versatility_%Y1^/?y11;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!BU:E51/?y3 E52/?y4;!!BU&y10=1/y3=-1/y4=-1:S146/1/51/0/-1/0; [Summon Ballista]
  !!HEy1:A2/5/?y2/?y11; !!BU:E18/?y3;        !!BU&y11=1/y3=-1:S148/1/18/0/-1/0; [Summon Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!BU:E153/?y3;       !!BU&y12=1/y3=-1:S147/1/153/0/-1/0; [Summon First Aid Tent]
!!en;

*!FU:E;                                 [Makes only sense for Attacker -_- well except for Siege :) ]
!!BA:H1/?y1;                            [Defender]
!!FU&y1<0:E;
!!SN:W^WM_Versatility_%Y1^/?y11;
!!VRy11:S1;
!!if&y11=1;
  !!HEy1:A2/4/?y2/?y10; !!BU:E67/?y3 E66/?y4;!!BU&y10=1/y3=-1/y4=-1:S146/1/67/1/-1/0; [Summon Ballista]
  !!HEy1:A2/5/?y2/?y11; !!BU:E32/?y3;        !!BU&y11=1/y3=-1:S148/1/32/1/-1/0; [Summon Ammo Cart]
  !!HEy1:A2/6/?y2/?y12; !!BU:E169/?y3;       !!BU&y12=1/y3=-1:S147/1/169/1/-1/0; [Summon First Aid Tent]
!!en;


**********************Shield Enchantment for universal WM*******************************************
*At the beginning of the fight casts a random Shield on all your Warmachines
!?FU(OnCombatRound)&v997=0;

!!BA:H0/?y1;
!!SN:W^WM_Shield_Ench_%Y1^/?y10;
!!VRy20:S0R2;
!!VRy5&y20=0:S27; !!VRy5&y20=1:S28;  !!VRy5&y20=2:S29; [27-Shield  28-AirShield  29-FireShield]
!!re i/0/10;
  !!BMi:T?y3;                           [Get Creature Type ]
  !!BMi&y3=145/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=146/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=147/y10=1:My5/99/3;          [If Ammo Cart found for Attacker]
  !!BMi&y3=148/y10=1:My5/99/3;          [If First Aid Tent found for Attacker]
!!en;

!!BA:H1/?y1; !!FU&y1<0:E;               [Exit if no Defending Hero]
!!SN:W^WM_Shield_Ench_%Y1^/?y10;
!!VRy20:S0R2;
!!VRy5&y20=0:S27; !!VRy5&y20=1:S28;  !!VRy5&y20=2:S29; [27-Shield  28-AirShield  29-FireShield]
!!re i/21/31;
  !!BMi:T?y3;                           [Get Creature Type ]
  !!BMi&y3=145/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=146/y10=1:My5/99/3;          [If Ballista found for Attacker]
  !!BMi&y3=147/y10=1:My5/99/3;          [If Ammo Cart found for Attacker]
  !!BMi&y3=148/y10=1:My5/99/3;          [If First Aid Tent found for Attacker]
!!en;


**********************Magic Resistance for universal WM*******************************************
*Makes all Warmachines immune to direct damage spells or AOE Spells*

!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1 S?y5;                         [Get Creature Number, Spell Number]
!!BMy1:I?y2 T?y3;                       [Get Creature Side, Type]
!!if|y3=145/y3=146/y3=147/y3=148;      [All WM]
  !!BG:H?y50;                           [Get Casting Hero]
  !!BA:Hy2/?y4;                         [Get Hero Number of creature side]
  !!FU&y4<0:E;
  *!FU&y50=y4:E;                        [Exit for beneficial spells, meaning same hero]
  !!if|y5=15/y5=16/y5=17/y5=18/y5=19/y5=20/y5=21/y5=22/y5=23/y5=24/y5=25/y5=26/y5=57; [If any Damage Spell]
    !!SN:W^WM_MR_Ench_%Y4^/?y10;
    !!MR&y10=1:F100;                    [Apply increased resistance chance to that stack temporarily]
  !!en;
!!en;


**********************Magic Resistance Aura for universal WM****************************************
*All Units standing next to Warmachines have a +15% chance to resist spells*
*Effect can double if standing between two WM*

!?MR2;                                  [Magic Resistance Trigger]

!!MR:N?y1 S?y7;                         [Get Creature Number and Spell Number]
!!BMy1:I?y2 T?y3 P?y4;                  [Get Creature Side]
!!BG:H?y50;                             [Get Casting Hero]
!!BA:Hy2/?y5;                           [Get Hero Number of creature side]
!!FU&y5<0:E;                            [Exit if no Hero]
!!FU&y50=y5:E;                          [Exit for beneficial spells, meaning same hero]
!!SN:W^WM_MR_Aura_%Y5^/?y10;

*Ammo Cart
!!BU&y2=0:E18/?y8; !!BMy8&y8>=0/y8<=41/y2=0:T?y8; [Check Ammo Cart Attacker]
!!if&y2=0/y8=148/y10=1;
  !!MR|y4=1/y4=19/y4=35:Fd15;           [Apply increased resistance chance to that stack temporarily]
!!en;

!!BU&y2=1:E32/?y8; !!BMy8&y8>=0/y8<=41/y2=1:T?y8; [Check Ammo Cart Defender]
!!if&y2=1/y8=148/y10=1;
  !!MR|y4=14/y4=15/y4=31/y4=48/y4=49:Fd15; [Apply increased resistance chance to that stack temporarily]
!!en;

*Ballista
!!BU&y2=0:E51/?y8; !!BMy8&y8>=0/y8<=41/y2=0:T?y8; [Check Ballista Attacker]
!!if&y2=0/y8=146/y10=1;
  !!MR|y4=35/y4=53/y4=69:Fd15;          [Apply increased resistance chance to that stack temporarily]
!!en;

!!BU&y2=1:E67/?y8; !!BMy8&y8>=0/y8<=41/y2=1:T?y8; [Check Ballista Defender]
!!if&y2=1/y8=146/y10=1;
  !!MR|y4=49/y4=48/y4=65/y4=82/y4=83:Fd15; [Apply increased resistance chance to that stack temporarily]
!!en;

*First Aid Tent
!!BU&y2=0:E153/?y8; !!BMy8&y8>=0/y8<=41/y2=0:T?y8; [Check First Aid Tent Attacker]
!!if&y2=0/y8=147/y10=1;
  !!MR|y4=137/y4=155/y4=171:Fd15;       [Apply increased resistance chance to that stack temporarily]
!!en;

!!BU&y2=1:E169/?y8; !!BMy8&y8>=0/y8<=41/y2=1:T?y8; [Check First Aid Tent Defender]
!!if&y2=1/y8=147/y10=1;
  !!MR|y4=151/y4=150/y4=167/y4=184/y4=185:Fd15; [Apply increased resistance chance to that stack temporarily]
!!en;


*********************************Ammo Cart Goblin Support********************************************
*The Goblin Support adds a chance to find additional Resources after combat*

!?FU(OnAfterBattleUniversal)&1000;

!!BA:H0/?y1;                            [Attacker Hero Number]
!!FU&y1<0:E;                            [Exit if no Hero]
!!SN:W^Ammo_Goblin_%Y1^/?y11; !!FU&y11=0:E;
!!HEy1:O?y2;                            [get owner of this hero]
!!SN:W^Hero_Attacker_Owner0^/?y3;       [Check Owner Before Fight]
!!FU&y2<>y3:E;                          [Prevent to give Bonus if retreat]
!!FU&y2=-1:E;

!!VRy99:S0R99;                          [Random Roll 0-99]
!!FU(AC_Goblin_Support)&y99<=16/y1>=0/y1<=155:Py1/0/y2/y99;

!?FU(AC_Goblin_Support);
** function for Goblin    x1=hero number   x2=scouting  x3=Hero Owner  x4=Encouter

!!DL122:N^GoblinDL.txt^;                [Name of Dialogue text file Parse Dialogue]

!!if&x4>=0/x4<=3;                      [Gold Reward]
  !!HEx1:E?y5/?y6/1;                    [get hero's level]
  !!VRy60:S1Ty6*200+500R1000;
  !!VRy60&x5=1:+1000;
  !!SN:T^AC_Warmachine.Goblin_Support_Gold_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Gold_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/6/y60/1^%Z21^;                [2= Gold]
  !!OW:Rx3/6/dy60;                      [give gold]
!!en;

!!if&x4>=4/x4<=7;                      [Resource Reward]
  !!VRy61:S0T5;                         [random resource 0 to 5]
  !!VRy60:S1T3;                         [random quantity 1 to 3]
  !!VRy60&x5=1:+2;
  !!VRy60&y61=0:*3:2;                   [double for wood]
  !!VRy60&y61=2:*3:2;                   [double for ore]
  !!SN:T^AC_Warmachine.Goblin_Support_Res_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Res_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/y61/y60/1^%Z21^;
  !!OW:Rx3/y61/dy60;                    [give the resources]
!!en;

!!if&x4>=8/x4<=10;                     [Creature Reward]
  !!FU(pick_a_monster):P?y4;            [call function (pick_a_monster) to pick monster]   5= pick monster  give hero]
  !!VRy1:S0T2;
  !!if&y1=2;
    !!HEx1:B2/?y1;
    !!VRy4|y1=0/y1=1:S0T13;             [Castle]
    !!VRy4|y1=2/y1=3:S14R13;
    !!VRy4|y1=4/y1=5:S28R13;
    !!VRy4|y1=6/y1=7:S42R13;
    !!VRy4|y1=8/y1=9:S56R13;
    !!VRy4|y1=10/y1=11:S70R13;
    !!VRy4|y1=12/y1=13:S84R13;
    !!VRy4|y1=14/y1=15:S97R13;
    !!VRy4|y1=16/y1=17:S112R13;         [Conflux]
    !!VRy4|y4=122/y4=124:S127;
    !!VRy6:S0T6;                        [Generate random slot]
    !!HEx1:C0/y6/?y40/?y5;              [Check creature slot]
    !!VRy4&y40>=0/y5>0:Sy40;            [Change monster to one of the hereos army]
    !!if|y4=-1/y5=0;
      !!VRy6:S0T6;                      [Generate random slot]
      !!HEx1:C0/y6/?y40/?y5;            [Check creature slot]
      !!VRy4&y40>=0/y5>0:Sy40;          [Change monster to one of the hereos army]
    !!en;
  !!en;
  !!VRy1:S0T2;
  !!VRy4&x1=48/y1=1:S46;                [HS1]
  !!VRy4&x1=48/y1=2:S47;
  !!VRy2:S84R13;
  !!VRy4&x1=109/y1=1:Sy2;               [HS2]
  !!VRy4&x1=109/y1=2:Sy2;
  !!MA:Gy4/?y60;                        [get 1 weeks production]
  !!VRy60:Sy60R2;                       [**]
  !!MA:Ly4/?y5;                         [Get Level of Monster]
  !!if&i^timerDay^<22;
    !!VRy4|y4=132/y4=133/y4=134/y4=135:S137; [OP Dragons cannot be found in first 14 days and are set to Sharpshooters instead]
  !!en;
  !!VRy4&y5=6/i^timerDay^<16:S137;      [Level 7 creatures cannot be found in first two weeks gets changes to Sharpshooters]
  !!VRy4&y5=5/i^timerDay^<8:S138;       [Level 6 creatures cannot be found in first week gets changes to Halflings]
  !!UN:N3/z704/y4/0;                    [refresh get monster name]
  !!UN:N3/z705/y4/1;                    [refresh get monsters name]
  !!SN:T^AC_Warmachine.Goblin_Support_Creature_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Creature_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!HEx1&1000:Cy4/y60/-1/0/-1/0/-1/0/-1/0/-1/0/-1/0; [give creatures]
!!en;

!!if&x4>=11/x4<=13;                    [Experience Reward]
  !!HEx1:E?y5/?y6/1;                    [get hero's level]
  !!VRy60:Sy6*150R500;                  [(level + 0-20) x 50]
  !!VRy60&x5=1:Sy60R1000;               [Specialist]
  !!VRy60&y6>15:*2; !!VRy60&y6>20:*2; !!VRy60&y6>40:*2; !!VRy60&y6>50:*2; [Increase Exp with level so it doesnt get useless]
  !!SN:T^AC_Warmachine.Goblin_Support_Exp_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Exp_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/17/y60/1^%Z21^;               [8= experience]
  !!HEx1:Edy60;                         [give experience]
!!en;

!!if&x4>=14/x4<=14;                    [Artifact Reward]
  !!VRy1:S0T2;
  !!UN|y1=0/y1=1:J6/2/?y2;              [get a random Treasure artifact  2/3 chance]
  !!UN&y1=2:J6/4/?y2;                   [get a random Minor artifact  1/3 chance]
  !!SN:T^AC_Warmachine.Goblin_Support_Artifact_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Artifact_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF:Q2/8/y2/1^%Z21^;
  !!HEx1:Ay2;                           [Give Artifact]
!!en;

!!if&x4>=15/x4<=15;                    [Spell Reward]
  !!HEx1:A2/0/d/?y15;                   [Check for Spell Book]
  !!FU&y15=0:E;                         [Exit if no Spell Book]
  !!FU$spell$:P1/4/0/0/1/1/6/7/8/9;     [Function to generate a random level 1-4 spell which skips banned spells]
  !!HEx1:S7/?y14;                       [7 Wisdom]
  !!SSy-99:L?y5;                        [Spell Level]
  !!if&y-99>=0/y-99<=69;               [Valid Spell]
    !!FU&y5=5/y14<3:E;                  [Exit if Wisdom level not high enough]
    !!FU&y5=4/y14<2:E;
    !!FU&y5=3/y14<1:E;
    !!SN:T^AC_Warmachine.Goblin_Support_Spell_0^/?z20;
    !!SN:T^AC_Warmachine.Goblin_Support_Spell_1^/?z21;
    !!DL122:A4/3/z20/1;                 [Set text to text fields]
    !!DL122:S1;
    !!IF:Q2/9/y-99/1^%Z21^;
    !!HEx1:My-99/1;                     [Give Spell]
  !!en;
!!en;

!!if&x4>=16/x4<=16;                    [Primary Skill Reward]
  !!VRy96:S2T3;
  !!SN&y96=2:T^AC_Misc.Scout_Attack1^/?z-9;
  !!SN&y96=3:T^AC_Misc.Scout_Defense1^/?z-9;
  !!SN&y96=4:T^AC_Misc.Scout_SP1^/?z-9;
  !!SN&y96=5:T^AC_Misc.Scout_Knowledge1^/?z-9;
  !!SN:T^AC_Warmachine.Goblin_Support_Skill_0^/?z20;
  !!SN:T^AC_Warmachine.Goblin_Support_Skill_1^/?z21;
  !!DL122:A4/3/z20/1;                   [Set text to text fields]
  !!DL122:S1;
  !!IF&y96=2:Q2/31/1/1^%Z21^;
  !!HEx1&y96=2:Fd1/d/d/d;
  !!IF&y96=3:Q2/32/1/1^%Z21^;
  !!HEx1&y96=3:Fd/d1/d/d;
  !!IF&y96=4:Q2/33/1/1^%Z21^;
  !!HEx1&y96=4:Fd/d/d1/d;
  !!IF&y96=5:Q2/34/1/1^%Z21^;
  !!HEx1&y96=5:Fd/d/d/d1;
!!en;

!!UN:R1;                                [redraw hero screen]

!?DL&v998=122/v999=30722/v1000=13;      [When clicking on the close Button in Goblin Support DL]
!!DL:C1;


!?CM2;                                  [Show Warmachine Upgrades when clicking on WM in Hero Screen]
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!HE-1:N?y99;                           [Get current hero #]

18 Catapult Slot
3 Catapult
!!HEy99:A2/3/d/?y15;                    [Check for 3 Catapult]
!!if&v3=512/v4=18/v5=14/y15=1;         [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.All_Upg_1^/?z21; !!SN:W^WM_Fortification_%Y99^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^; [Check if hero has bought the upgrade and set color of text accordingly]
  !!SN:T^AC_Warmachine.All_Upg_2^/?z22; !!SN:W^WM_Maintainability_%Y99^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Upg_3^/?z23; !!SN:W^WM_Versatility_%Y99^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Ench_1^/?z24; !!SN:W^WM_Shield_Ench_%Y99^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Ench_2^/?z25; !!SN:W^WM_MR_Ench_%Y99^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.All_Ench_3^/?z26; !!SN:W^WM_MR_Aura_%Y99^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  !!UN:A3/10/0;                         [restore original artefact description]
  !!SN:H^art^/3/1/?z2;                  [readout artefact description]
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  !!UN:A3/10/z1;                        [Set new Ammo Cart description to show it on right click]
!!en;

16 Ammo Cart Slot
5 Ammo Cart
!!HEy99:A2/5/d/?y15;                    [Check for 5 Ammo Cart]
!!if&v3=512/v4=16/v5=14/y15=1;         [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.Cart_Upg_1^/?z21; !!SN:W^Ammo_Supply_%Y99^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Upg_2^/?z22; !!SN:W^Ammo_Goblin_%Y99^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Upg_3^/?z23; !!SN:W^Ammo_Enhanced_Arrow_%Y99^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Ench_1^/?z24; !!SN:W^Ammo_Booby_Trap_%Y99^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Ench_2^/?z25; !!SN:W^Ammo_Replensih_SP_%Y99^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Cart_Ench_3^/?z26; !!SN:W^Ammo_Burning_Arrow_%Y99^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  !!UN:A5/10/0;
  !!SN:H^art^/5/1/?z2;
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  !!UN:A5/10/z1;                        [Set new Ammo Cart description]
!!en;

15 Ballista Slot
4 Ballista
!!HEy99:A2/4/d/?y15;                    [Check for 4 Ballista]
!!if&v3=512/v4=15/v5=14/y15=1;         [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.Bal_Upg_1^/?z21; !!SN:W^Ballista_Morale_%Y99^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Upg_2^/?z22; !!SN:W^Ballista_Add_Shots_%Y99^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Upg_3^/?z23; !!SN:W^Ballista_Crippling_%Y99^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Ench_1^/?z24; !!SN:W^Ballista_Fireball_Attack_%Y99^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Ench_2^/?z25; !!SN:W^Ballista_Magic_Arrow_%Y99^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Bal_Ench_3^/?z26; !!SN:W^Ballista_Spell_Trigger_%Y99^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  !!UN:A4/10/0;
  !!SN:H^art^/4/1/?z2;
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  !!UN:A4/10/z1;
!!en;

17 First Aid Tent Slot
6 First Aid Tent
!!HEy99:A2/6/d/?y15;                    [Check for 4 Tent]
!!if&v3=512/v4=17/v5=14/y15=1;         [if right click and specialty icon are clicked]
  !!SN:T^AC_Warmachine.Tent_Upg_1^/?z21; !!SN:W^Tent_Improved_%Y99^/?y10; !!VRz31&y10=0:S^Grey^; !!VRz31&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Upg_2^/?z22; !!SN:W^Tent_Capacity_Upgrade_%Y99^/?y10; !!VRz32&y10=0:S^Grey^; !!VRz32&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Upg_3^/?z23; !!SN:W^Tent_Gold_Gain_%Y99^/?y10; !!VRz33&y10=0:S^Grey^; !!VRz33&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Ench_1^/?z24; !!SN:W^Tent_Herbalism_%Y99^/?y10; !!VRz34&y10=0:S^Grey^; !!VRz34&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Ench_2^/?z25; !!SN:W^Tent_Overheal_%Y99^/?y10; !!VRz35&y10=0:S^Grey^; !!VRz35&y10=1:S^Gold^;
  !!SN:T^AC_Warmachine.Tent_Ench_3^/?z26; !!SN:W^Tent_Life_Aura_%Y99^/?y10; !!VRz36&y10=0:S^Grey^; !!VRz36&y10=1:S^Gold^;
  !!UN:A6/10/0;
  !!SN:H^art^/6/1/?z2;
  !!VRz1:S^%Z2

  {~%Z31}%Z21{~}
  {~%Z32}%Z22{~}
  {~%Z33}%Z23{~}
  {~%Z34}%Z24{~}
  {~%Z35}%Z25{~}
  {~%Z36}%Z26{~}^;
  !!UN:A6/10/z1;
!!en;


****************************************************************************************************
**Spell Trainer
*by Perry R

**V-Vars used: v3,v4,v5
**Z-Vars used: z735-z737, z426-z428, z937
**Function used:
**Flags used:

*#SN:W^Spell_Trainer_Mod^/1;            [Spell Trainer Mod Active]
!#SN:W^Damage_Spells_Increment^/2;      [Change the Increment for Damage Spells in this Line e.g. change 3 to 2 or 3 to 5]

********************************************************************************
!?PI;

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
!!DO(Spell_Trainer_Reset_1)/0/155/1&y1=1:P; [Reset spell damage increase/counter for all Heroes when Map Starts]
!!FU(Spell_Trainer_Reset_2)&y1=1:P;

*------------------------------------------------------------------------------*
!?CM2;                                  [Show Spell level when right click on spell book]
!!CM:F?v3 I?v4 S?v5;                    [where we click and click subtype]
!!HE-1:N?y99;                           [Get current hero #]

!!SN:W^Spell_Trainer_Mod^/?y1;          [Check if options have already been activated]
!!if&v3=512/v4=19/y1=1;                [if right click and specialty icon are clicked]

!!DL88:N^SpTr.txt^;                     [Name of Dialogue text file Parse Dialogue]

!!SN:W^Damage_Spells_Increment^/?y98;

**Earth
!!SN:W^Hero%Y99_Shield_Upgrade^/?y10; !!SN:W^SpellTrainerHero%Y99_Spell27^/?y11;
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/?y12; !!SN:W^SpellTrainerHero%Y99_Spell46^/?y13;
!!SN:W^Hero%Y99_Slow_Upgrade^/?y14; !!SN:W^SpellTrainerHero%Y99_Spell54^/?y15;
!!SN:W^Hero%Y99_Resurrection_Upgrade^/?y16; !!SN:W^SpellTrainerHero%Y99_Spell38^/?y17; !!VRy16:*80;
!!SN:W^Hero%Y99_Animation_Upgrade^/?y18; !!SN:W^SpellTrainerHero%Y99_Spell39^/?y19; !!VRy18:*100;
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/?y20; !!SN:W^SpellTrainerHero%Y99_Spell24^/?y21; !!VRy20:*30;
                                            !!SN:W^SpellTrainerHero%Y99_Spell23^/?y23; !!VRy22:Sy23 *y98 +100; [**Meteor Shower]
                                            !!SN:W^SpellTrainerHero%Y99_Spell18^/?y25; !!VRy24:Sy25 *y98 +100; [**Implosion]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y26; !!SN:W^SpellTrainerHero%Y99_Spell66^/?y27;    !!VRy26:*100; [**Summoning]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y28; !!SN:W^SpellTrainerHero%Y99_Spell30^/?y29;
!!SN:W^Hero%Y99_Sorrow_Upgrade^/?y68; !!SN:W^SpellTrainerHero%Y99_Spell50^/?y69;

**Water
!!SN:W^Hero%Y99_Bless_Upgrade^/?y30; !!SN:W^SpellTrainerHero%Y99_Spell41^/?y31;
!!SN:W^Hero%Y99_Weakness_Upgrade^/?y32; !!SN:W^SpellTrainerHero%Y99_Spell45^/?y33;
!!SN:W^Hero%Y99_Prayer_Upgrade^/?y34; !!SN:W^SpellTrainerHero%Y99_Spell48^/?y35;
!!SN:W^Hero%Y99_Mirth_Upgrade^/?y64; !!SN:W^SpellTrainerHero%Y99_Spell49^/?y65;
!!SN:W^Hero%Y99_Cure_Upgrade^/?y76; !!SN:W^SpellTrainerHero%Y99_Spell37^/?y77;         !!VRy76:*5;
                                            !!SN:W^SpellTrainerHero%Y99_Spell16^/?y37; !!VRy36:Sy37 *y98 +100; [**Ice Bolt]
                                            !!SN:W^SpellTrainerHero%Y99_Spell20^/?y39; !!VRy38:Sy39 *y98 +100; [**Frost Ring]
**Fire
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/?y40; !!SN:W^SpellTrainerHero%Y99_Spell43^/?y41;
!!SN:W^Hero%Y99_Curse_Upgrade^/?y42; !!SN:W^SpellTrainerHero%Y99_Spell42^/?y43;
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/?y44; !!SN:W^SpellTrainerHero%Y99_Spell29^/?y45;
!!SN:W^Hero%Y99_Misfortune_Upgrade^/?y72; !!SN:W^SpellTrainerHero%Y99_Spell52^/?y73;
!!SN:W^Hero%Y99_Frenzy_Upgrade^/?y74; !!SN:W^SpellTrainerHero%Y99_Spell56^/?y75;       !!VRy74:*5;
!!SN:W^Hero%Y99_Slayer_Upgrade^/?y66; !!SN:W^SpellTrainerHero%Y99_Spell55^/?y67;
                                            !!SN:W^SpellTrainerHero%Y99_Spell21^/?y47; !!VRy46:Sy47 *y98 +100; [**Fire Ball]
                                            !!SN:W^SpellTrainerHero%Y99_Spell22^/?y49; !!VRy48:Sy49 *y98 +100; [**Inferno]
!!SN:W^Hero%Y99_Land Mine_Upgrade^/?y78; !!SN:W^SpellTrainerHero%Y99_Spell11^/?y79;    !!VRy78:*50; [**Land Mine]
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/?y80;  !!SN:W^SpellTrainerHero%Y99_Spell13^/?y81;   !!VRy80:*35; [**Fire Wall]
                                            !!SN:W^SpellTrainerHero%Y99_Spell26^/?y83; !!VRy82:Sy83 *y98 +100; [**Armageddon]
**Air
!!SN:W^Hero%Y99_Haste_Upgrade^/?y50; !!SN:W^SpellTrainerHero%Y99_Spell53^/?y51;
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/?y52; !!SN:W^SpellTrainerHero%Y99_Spell47^/?y53;
!!SN:W^Hero%Y99_Precision_Upgrade^/?y54; !!SN:W^SpellTrainerHero%Y99_Spell44^/?y55;
!!SN:W^Hero%Y99_Air Shield_Upgrade^/?y56; !!SN:W^SpellTrainerHero%Y99_Spell28^/?y57;
!!SN:W^Hero%Y99_Fortune_Upgrade^/?y70; !!SN:W^SpellTrainerHero%Y99_Spell51^/?y71;
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/?y58; !!SN:W^SpellTrainerHero%Y99_Spell25^/?y59; !!VRy58:*50;
                                            !!SN:W^SpellTrainerHero%Y99_Spell17^/?y61; !!VRy60:Sy61 *y98 +100; [**Lightning Bolt]
                                            !!SN:W^SpellTrainerHero%Y99_Spell19^/?y63; !!VRy62:Sy63 *y98 +100; [**Chain Lightning]

!!FU(Spell_Trainer_Calc):Py99/?y92/?y93;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]
!!CM:R0;                                [disable standard reaction]

!!VRz14:S^Spell Upgrades List:

Spell Upgrades per combat: {~Red}%Y92{~} Chance for Spell Upgrade: {~Red}%Y93%%{~}^;


!!VRz10:S^
{~Green}Earth{~}:
{Shield} Reduction:+%Y10%% casts:%Y11
{Stone Skin} Defense:+%Y12 casts:%Y13
{Slow} Reduce:+%Y14%% casts:%Y15
{Resurrection} extra HP:+%Y16 casts:%Y17
{Animate Dead} extra HP:+%Y18 casts:%Y19
{Sorrow} Moral:-%Y68 casts:%Y69
{Death Ripple} extra dmg:+%Y20 casts:%Y21
{Meteor Shower} Damage:%Y22%% casts:%Y23
{Implosion} Damage:%Y24%% casts:%Y25
{Summon Earth} Bonus HP:+%Y26 casts:%Y27
{Protec. Earth} Reduction:+%Y28%% casts:%Y29
^;


!!VRz11:S^
{~Blue}Water{~}:
{Bless} Max. Damage:+%Y30 casts:%Y31
{Weakness} Attack:-%Y32 casts:%Y33
{Prayer} Stats:+%Y34 casts:%Y35
{Ice Bolt} Damage:%Y36%% casts:%Y37
{Frost Ring} Damage:%Y38%% casts:%Y39
{Mirth} Moral:%Y64 casts:%Y65
{Cure} HP healed:+%Y76 casts:%Y77
{Summon Water} Bonus HP:+%Y26 casts:%Y27
{Protec. Water} Reduction:+%Y28%% casts:%Y29
^;


!!VRz12:S^
{~Red}Fire{~}:
{Bloodlust} Attack:+%Y40 casts:%Y41
{Curse} Min. Damage:-%Y42 casts:%Y43
{Fire Shield} Reflected:+%Y44%% casts:%Y45
{Fire Ball} Damage:%Y46%% casts:%Y47
{Inferno} Damage:%Y48%% casts:%Y49
{Land Mine} extra dmg:+%Y78 casts:%Y79
{Fire Wall} extra dmg:+%Y80 casts:%Y81
{Armageddon} Damage:%Y82%% casts:%Y83
{Slayer} Attack:+%Y66 casts:%Y67
{Frenzy} Attack:+%Y74%% casts:%Y75
{Misfortune} Luck:-%Y72 casts:%Y73
{Summon Fire} Bonus HP:+%Y26 casts:%Y27
{Protec. Fire} Reduction:+%Y28%% casts:%Y29
^;


!!VRz13:S^
{~White}Air{~}:
{Haste} Speed:+%Y50 casts:%Y51
{Disrupting Ray} Defense:-%Y52 casts:%Y53
{Precision} Attack:+%Y54 casts:%Y55
{Air Shield} Reduction:+%Y56%% casts:%Y57
{Fortune} Luck:+%Y70 casts:%Y71
{Destroy Undead} extra dmg:+%Y58 casts:%Y59
{Lightning Bolt} Damage:%Y60%% casts:%Y61
{Chain Lightn.} Damage:%Y62%% casts:%Y63
{Summon Air} Bonus HP:+%Y26 casts:%Y27
{Protec. Air} Reduction:+%Y28%% casts:%Y29
^;

!!DL88:A1/3/z12/1;
!!DL88:A2/3/z10/1;
!!DL88:A3/3/z13/1;
!!DL88:A4/3/z11/1;
!!DL88:A5/3/z14/1;

!!DL88:S1;                              [Show complete Dialogue number 88]
!!en;

!?DL&v998=88/v999=30722/v1000=13;       [When clicking on the close Button]
!!DL:C1;


!?FU(Spell_Trainer_Calc);
x1=Hero Number, x2=returns number of spell upgrades, x3=returns chance for spell upgrade
Chance:
Warrior:10%
Adventurer:25%
Mage:50%
Scholar:+25%
Mage Class Points:+x%
Colar of Conjuring:+15%

Possible Upgrades:
Warrior:0
Adventurer:0
Mage:+1
Scholar Basic:+1
Scholar Expert:+1
Scholar Grandmaster:+1
Ring of Conjuring:+1
Druid:+1
Battlemage:+1
Grandmaster Mage:+1

!!VRy5:S0;                              [Chance]
!!VRy6:S0;                              [Spell Upgrades]
!!FU(acm_RecalcClassPoints):Px1/0/?y10;

!!VRy5:+y10;                            [+Class Points]

!!HEx1:B2/?y1;                          [Get Hero Class]
!!VRy1:Sy1 %2;                          [if y1=1 it means Magic Class Hero, if y1=0 it means Might Class Hero]
!!FU(Valid_Adventurer_Hero):Px1/?y60;   [Call Function to Check if Adventurer Hero 1 means yes]
!!VRy5&y1=1/y60=0:+50;                  [+Class Points [If Mage and no Adventurer Hero]
!!VRy5&y1=1/y60=1:+25;                  [+Class Points [If Mage and Adventurer Hero]
!!VRy5&y1=0/y60=1:+25;                  [+Class Points [If Warrior and Adventurer Hero]
!!VRy5&y1=0/y60=0:+10;                  [+Class Points [If Mage and no Adventurer Hero]

!!VRy6&y1=1/y60=0:+1;                   [+1 Spell Upgrade per Combat If Mage and no Adventurer Hero]

!!SN:W^H3_Scholar_0_Hero%X1^/?y14;
!!SN:W^H3_Scholar_1_Hero%X1^/?y15;

!!HEx1:S18/?y4;                         [Checke current hero Scholar]
!!VRy5&y4>0:+25;                        [+Scholar Bonus]
!!VRy6&y4>0:+1;                         [+Spell Upgrade for Basic Scholar]
!!VRy6&y4=3/y14=0/y15=0:+1;             [+Spell Upgrade for Expert Scholar]
!!VRy6&y4=3/y14=1/y15=1:+1;             [+Spell Upgrade for Grandmaster Scholar]

!!HEx1:A2/76/d/?y20 A2/77/d/?y21 A2/78/d/?y22 A2/139/d/?y23; [Check for Artifacts Collar,Ring,Cape,Ring of the Magi]
!!VRy5|y21=1/y23=1:+15;                 [+Artifact Bonus Chance]
!!VRy6|y20=1/y23=1:+1;                  [+Artifact Bonus Spell Upgrade]

!!SN:W^Master_Adventurer_Hero%X1^/?y90;
!!SN:W^Master_Mage_Hero%X1^/?y91;
!!VRy6&y90=1/y91=1:+1;                  [+1 Spell Upgrade if Druid]
!!SN:W^Master_Warrior_Hero%X1^/?y90;
!!SN:W^Master_Mage_Hero%X1^/?y91;
!!VRy6&y90=1/y91=1:+1;                  [+1 Spell Upgrade if Battlemage]
!!SN:W^Grandmaster_Mage_Hero%X1^/?y90;
!!VRy6&y90=1/y91=1:+1;                  [+1 Spell Upgrade if Grandmaster]

!!VRy5&y5>100:S100;                     [Cap at hundred percent]

!!VRx2:Sy6;                             [Return Spell Upgrades]
!!VRx3:Sy5;                             [Return Spell Upgrade Chance]


*------------------------------------------------------------------------------*
!?FU(OnBeforeBattleUniversal)&1000;

!!SN:W^Upgrade_Counter^/0;              [Reset Upgrade_Counter at Battle Start]
!!SN:W^Monster_Level^/0;                [Reset Monster_Level at Battle Start]

*?BA1&1000;
*!SN:W^SpellTrainer_Sound_End^/?y1;
*!FU&y1<>1:E;
*!VRz1:S^CLIMAX^;
*!SN:Pz1;
*!SN:W^SpellTrainer_Sound_End^/0;

*------------------------------------------------------------------------------*
!?BG0&1000;                             [Trigger Buff/Debuff Spells]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;                            [Exit if AI Hero]

!!BA:Q?y1;                              [Check for Quick Combat]
!!if&y1=1;
  !!VRy99:S0T99;
  !!FU&y99>50:E;                        [In Quick Combat the chance to level up a spell is only 50% to encourage the player to use his spells and not get the level ups for free]
!!en;

!!BG:A?y1;                              [Aktion in y1 Must be Hero Cast]
!!if|y1=1/y1=0;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;                          [Exit if no defending Hero]

!!FU(Spell_Trainer_Calc):Py99/?y90/?y91;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]
!!FU&y90=0:E;                           [Exit if NO possible Spell Upgrades]
!!VRy92:S0R99;                          [Random Roll: Chance for Might Heros without Scholar to level up is 33%]
!!FU&y91<y92:E;                         [Exit if Roll was not successful]

!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S18/?y85; [Checke current hero Scholar und Magien hat]
!!BG:S?y4;                              [Spell Number]

!!SN&y4>=24/y4<=69:W^Spell_Number_Buff^/y4;
!!SN&y4>=24/y4<=69:W^Flag_V898_Value^/1;
!!SN|y4=11/y4=13:W^Spell_Number_Buff^/y4;
!!SN|y4=11/y4=13:W^Flag_V898_Value^/1;

!!if&y4=27/y84=3;                      [Shield]
!!SN:W^Hero%Y99_Shield_Upgrade^/?y20;
!!SS27:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS27:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell27^/d+1;
!!en;

!!if&y4=43/y81=3;                      [Bloodlust]
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/?y20;
!!SS43:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS43:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell43^/d+1;
*!IF:L^Bloodlust %Y20 and %Y10 and numbers is %Y1^;
!!en;

!!if&y4=41/y83=3;                      [Bless]
!!SN:W^Hero%Y99_Bless_Upgrade^/?y20;
!!SS41:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS41:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell41^/d+1;
!!en;

!!if&y4=42/y81=3;                      [Curse]
!!SN:W^Hero%Y99_Curse_Upgrade^/?y20;
!!SS42:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS42:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell42^/d+1;
!!en;

!!if&y4=44/y82=3;                      [Precision]
!!SN:W^Hero%Y99_Precision_Upgrade^/?y20;
!!SS44:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS44:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell44^/d+1;
!!en;

!!if&y4=45/y83=3;                      [Weakness]
!!SN:W^Hero%Y99_Weakness_Upgrade^/?y20;
!!SS45:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS45:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell45^/d+1;
!!en;

!!if&y4=46/y84=3;                      [Stoneskin]
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/?y20;
!!SS46:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS46:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell46^/d+1;
!!en;

!!if&y4=28/y82=3;                      [Air Shield]
!!SN:W^Hero%Y99_Air Shield_Upgrade^/?y20;
!!SS28:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS28:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell28^/d+1;
!!en;

!!if&y4=29/y81=3;                      [Fire Shield]
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/?y20;
!!SS29:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS29:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell29^/d+1;
!!en;

!!if&y4=53/y82=3;                      [Haste]
!!SN:W^Hero%Y99_Haste_Upgrade^/?y20;
!!SS53:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS53:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell53^/d+1;
!!en;

!!if&y4=54/y84=3;                      [Slow]
!!SN:W^Hero%Y99_Slow_Upgrade^/?y20;
!!SS54:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS54:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell54^/d+1;
!!en;

!!if&y4=47/y82=3;                      [Disrupting Ray]
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/?y20;
!!SS47:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS47:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell47^/d+1;
!!en;

!!if&y4=66/y81=3;                      [SummoningFire]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS66:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS66:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=67/y82=3;                      [SummoningAir]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS67:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS67:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=68/y83=3;                      [SummoningWater]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS68:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS68:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=69/y84=3;                      [SummoningEarth]
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
!!SS69:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS69:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell66^/d+1;
!!en;

!!if&y4=31/y81=3;                      [ProtectionFire]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS31:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS31:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=30/y82=3;                      [ProtectionAir]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS30:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS30:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=32/y83=3;                      [ProtectionWater]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS32:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS32:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=33/y84=3;                      [ProtectionEarth]
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
!!SS33:E3/?y10;
!!VRy10:Sy10 -y20;
!!SS33:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell30^/d+1;
!!en;

!!if&y4=38/y84=3;                      [Resurrection]
!!SN:W^Hero%Y99_Resurrection_Upgrade^/?y20;
!!SS38:E3/?y10; !!VRy20:*80;
!!VRy10:Sy10 +y20;
!!SS38:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell38^/d+1;
!!en;

!!if&y4=39/y84=3;                      [Animation]
!!SN:W^Hero%Y99_Animation_Upgrade^/?y20;
!!SS39:E3/?y10; !!VRy20:*100;
!!VRy10:Sy10 +y20;
!!SS39:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell39^/d+1;
!!en;

!!if&y4=24/y84=30;                     [Disabled                      [Death Ripple]
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/?y20;
!!SS24:E3/?y10; !!VRy20:*30;
!!VRy10:Sy10 +y20;
!!SS24:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell24^/d+1;
!!en;

!!if&y4=25/y82=30;                     [Disabled                     [Destroy Undead]
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/?y20;
!!SS25:E3/?y10; !!VRy20:*50;
!!VRy10:Sy10 +y20;
!!SS25:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell25^/d+1;
!!en;

!!if&y4=48/y83=3;                      [Prayer]
!!SN:W^Hero%Y99_Prayer_Upgrade^/?y20;
!!SS48:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS48:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell48^/d+1;
!!en;

!!if&y4=55/y81=3;                      [Slayer]
!!SN:W^Hero%Y99_Slayer_Upgrade^/?y20;
!!SS55:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS55:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell55^/d+1;
!!en;

!!if&y4=49/y83=3;                      [Mirth]
!!SN:W^Hero%Y99_Mirth_Upgrade^/?y20;
!!SS49:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS49:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell49^/d+1;
!!en;

!!if&y4=50/y84=3;                      [Sorrow]
!!SN:W^Hero%Y99_Sorrow_Upgrade^/?y20;
!!SS50:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS50:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell50^/d+1;
!!en;

!!if&y4=51/y82=3;                      [Fortune]
!!SN:W^Hero%Y99_Fortune_Upgrade^/?y20;
!!SS51:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS51:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell51^/d+1;
!!en;

!!if&y4=52/y81=3;                      [Misfortune]
!!SN:W^Hero%Y99_Misfortune_Upgrade^/?y20;
!!SS52:E3/?y10;
!!VRy10:Sy10 +y20;
!!SS52:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell52^/d+1;
!!en;

!!if&y4=56/y81=3;                      [Frenzy]
!!SN:W^Hero%Y99_Frenzy_Upgrade^/?y20;
!!SS56:E3/?y10; !!VRy20:*5;
!!VRy10:Sy10 +y20;
!!SS56:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell56^/d+1;
!!en;

!!if&y4=37/y83=3;                      [Cure]
!!SN:W^Hero%Y99_Cure_Upgrade^/?y20;
!!SS37:E3/?y10; !!VRy20:*5;
!!VRy10:Sy10 +y20;
!!SS37:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell37^/d+1;
!!en;

!!if&y4=13/y81=3;                      [Fire Wall]
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/?y20;
!!SS13:E3/?y10; !!VRy20:*35;
!!VRy10:Sy10 +y20;
!!SS13:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell13^/d+1;
!!en;

!!if&y4=11/y81=3;                      [Land Mine]
!!SN:W^Hero%Y99_Land Mine_Upgrade^/?y20;
!!SS11:E3/?y10; !!VRy20:*50;
!!VRy10:Sy10 +y20;
!!SS11:E3/y10;
!!SN:W^SpellTrainerHero%Y99_Spell11^/d+1;
!!en;

!!en;

*------------------------------------------------------------------------------*
!?BG1&1000;                             [Trigger Buff/Debuff Spells]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!SN:W^Flag_V898_Value^/?y1;
!!FU&y1<>1:E;
!!SN:W^Flag_V898_Value^/0;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S18/?y85; [Checke current hero Scholar und Magien hat]

!!SS43:E3/?y10;                         [revert bloodlust to original value]
!!SN:W^Bloodlust_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS43:E3/y10;

!!SS27:E3/?y10;                         [revert shield to original value]
!!SN:W^Shield_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS27:E3/y10;

!!SS41:E3/?y10;                         [revert Bless to original value]
!!SN:W^Bless_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS41:E3/y10;

!!SS42:E3/?y10;                         [revert Curse to original value]
!!SN:W^Curse_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS42:E3/y10;

!!SS44:E3/?y10;                         [revert Precision to original value]
!!SN:W^Precision_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS44:E3/y10;

!!SS45:E3/?y10;                         [revert Weakness to original value]
!!SN:W^Weakness_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS45:E3/y10;

!!SS46:E3/?y10;                         [revert Stoneskin to original value]
!!SN:W^Stoneskin_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS46:E3/y10;

!!SS28:E3/?y10;                         [revert Air Shield to original value]
!!SN:W^Air Shield_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS28:E3/y10;

!!SS29:E3/?y10;                         [revert Fire Shield to original value]
!!SN:W^Fire Shield_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS29:E3/y10;

!!SS53:E3/?y10;                         [revert Haste to original value]
!!SN:W^Haste_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS53:E3/y10;

!!SS54:E3/?y10;                         [revert Slow to original value]
!!SN:W^Slow_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS54:E3/y10;

!!SS47:E3/?y10;                         [revert Disrupting Ray to original value]
!!SN:W^Disrupting Ray_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS47:E3/y10;

!!SS66:E3/?y10;                         [revert SummoningFire to original value]
!!SN:W^SummoningFire_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS66:E3/y10;

!!SS67:E3/?y10;                         [revert SummoningAir to original value]
!!SN:W^SummoningAir_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS67:E3/y10;

!!SS68:E3/?y10;                         [revert SummoningWater to original value]
!!SN:W^SummoningWater_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS68:E3/y10;

!!SS69:E3/?y10;                         [revert SummoningEarth to original value]
!!SN:W^SummoningEarth_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS69:E3/y10;

!!SS31:E3/?y10;                         [revert ProtectionFire to original value]
!!SN:W^ProtectionFire_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS31:E3/y10;

!!SS30:E3/?y10;                         [revert ProtectionAir to original value]
!!SN:W^ProtectionAir_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS30:E3/y10;

!!SS32:E3/?y10;                         [revert ProtectionWater to original value]
!!SN:W^ProtectionWater_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS32:E3/y10;

!!SS33:E3/?y10;                         [revert ProtectionEarth to original value]
!!SN:W^ProtectionEarth_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS33:E3/y10;

!!SS38:E3/?y10;                         [revert Resurrection to original value]
!!SN:W^Resurrection_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS38:E3/y10;

!!SS39:E3/?y10;                         [revert Animation to original value]
!!SN:W^Animation_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS39:E3/y10;

!!if&y1=100; Disabled
  !!SS24:E3/?y10;                         [revert Death Ripple to original value]
  !!SN:W^Death Ripple_Value_Start^/?y30;
  !!VRy10&y10<>y30:Sy30;
  !!SS24:E3/y10;

  !!SS25:E3/?y10;                         [revert Destroy Undead to original value]
  !!SN:W^Destroy Undead_Value_Start^/?y30;
  !!VRy10&y10<>y30:Sy30;
  !!SS25:E3/y10;
!!en;

!!SS48:E3/?y10;                         [revert Prayer to original value]
!!SN:W^Prayer_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS48:E3/y10;

!!SS55:E3/?y10;                         [revert Slayer to original value]
!!SN:W^Slayer_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS55:E3/y10;

!!SS49:E3/?y10;                         [revert Mirth to original value]
!!SN:W^Mirth_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS49:E3/y10;

!!SS50:E3/?y10;                         [revert Sorrow to original value]
!!SN:W^Sorrow_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS50:E3/y10;

!!SS51:E3/?y10;                         [revert Fortune to original value]
!!SN:W^Fortune_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS51:E3/y10;

!!SS52:E3/?y10;                         [revert Misfortune to original value]
!!SN:W^Misfortune_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS52:E3/y10;

!!SS56:E3/?y10;                         [revert Frenzy to original value]
!!SN:W^Frenzy_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS56:E3/y10;

!!SS37:E3/?y10;                         [revert Cure to original value]
!!SN:W^Cure_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS37:E3/y10;

!!SS13:E3/?y10;                         [revert Fire Wall to original value]
!!SN:W^Fire Wall_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS13:E3/y10;

!!SS11:E3/?y10;                         [revert Land Mine to original value]
!!SN:W^Land Mine_Value_Start^/?y30;
!!VRy10&y10<>y30:Sy30;
!!SS11:E3/y10;

!!FU(Spell_Trainer_Calc):Py99/?y85;     [Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]

!!SN:W^Upgrade_Counter^/?y21;
!!FU&y85=1/y21>=1:E;                    [can only upgrade 1 times in one battle witch basic scholar]
!!FU&y85=2/y21>=2:E;                    [can only upgrade 2 times in one battle witch advanced scholar]
!!FU&y85=3/y21>=3:E;                    [can only upgrade 3 times in one battle witch expert scholar]
!!FU&y85=4/y21>=4:E;                    [allows +1 spell upgrade with Collar of conjuring]
!!FU&y85=5/y21>=5:E;                    [allows +1 spell upgrade with Ring of conjuring]
!!FU&y85=6/y21>=6:E;
!!FU&y85=7/y21>=7:E;

!!BG:S?y2;                              [y2 now contains spell number]

!!FU&y2<=9|y2>69:E;
!!SN:W^Spell_Number_Buff^/?y3;

!!FU&y2<>y3:E;                          [Exit if different Spell than Hero cast]


!!if&y2=27/y84=3;                      [Shield]
!!SN:W^SpellTrainerHero%Y99_Spell27^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Shield_Upgrade^/?y20;
*!SS27:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Shield^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Shield_Upgrade^/d+1;    [set upgrade counter and increase upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=43/y81=3;                      [Bloodlust]
!!SN:W^SpellTrainerHero%Y99_Spell43^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/?y20;
*!SS43:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Bloodlust^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Bloodlust_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=41/y83=3;                      [Bless]
!!SN:W^SpellTrainerHero%Y99_Spell41^/?y1;
!!if|y1=7/y1=20/y1=35/y1=60/y1=90/y1=120/y1=150/y1=200/y1=250/y1=300/y1=350/y1=400/y1=450/y1=500/y1=550;
!!SN:W^Hero%Y99_Bless_Upgrade^/?y20;
*!SS41:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Bless^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Bless_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=42/y81=3;                      [Curse]
!!SN:W^SpellTrainerHero%Y99_Spell42^/?y1;
!!if|y1=7/y1=20/y1=35/y1=60/y1=90/y1=120/y1=150/y1=200/y1=250/y1=300/y1=350/y1=400/y1=450/y1=500/y1=550;
!!SN:W^Hero%Y99_Curse_Upgrade^/?y20;
*!SS42:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Curse^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Curse_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=44/y82=3;                      [Precision]
!!SN:W^SpellTrainerHero%Y99_Spell44^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Precision_Upgrade^/?y20;
*!SS44:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Precision^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Precision_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=45/y83=3;                      [Weakness]
!!SN:W^SpellTrainerHero%Y99_Spell45^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Weakness_Upgrade^/?y20;
*!SS45:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Weakness^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Weakness_Upgrade^/d+1;  [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=46/y84=3;                      [Stoneskin]
!!SN:W^SpellTrainerHero%Y99_Spell46^/?y1;
!!if|y1=3/y1=7/y1=12/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/?y20;
*!SS46:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Stoneskin^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Stoneskin_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=28/y82=3;                      [Air Shield]
!!SN:W^SpellTrainerHero%Y99_Spell28^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Air Shield_Upgrade^/?y20;
*!SS28:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_AirShield^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Air Shield_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=29/y81=3;                      [Fire Shield]
!!SN:W^SpellTrainerHero%Y99_Spell29^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=60/y1=70/y1=80/y1=90/y1=100;
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/?y20;
*!SS29:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_FireShield^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Fire Shield_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=53/y82=3;                      [Haste]
!!SN:W^SpellTrainerHero%Y99_Spell53^/?y1;
!!if|y1=4/y1=13/y1=28/y1=40/y1=65/y1=85/y1=110/y1=150/y1=200/y1=250/y1=300/y1=350;
!!SN:W^Hero%Y99_Haste_Upgrade^/?y20;
*!SS53:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Haste^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Haste_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=54/y84=3;                      [Slow]
!!SN:W^SpellTrainerHero%Y99_Spell54^/?y1;
!!if|y1=3/y1=8/y1=17/y1=26/y1=35/y1=45/y1=50/y1=60/y1=70/y1=80/y1>80;
!!if|y1<=80/y1=100/y1=120/y1=150/y1=160/y1=180/y1=200/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Slow_Upgrade^/?y20;
*!SS54:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Slow^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Slow_Upgrade^/d+1;      [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=47/y82=3;                      [Disrupting Ray]
!!SN:W^SpellTrainerHero%Y99_Spell47^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/?y20;
*!SS47:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Disrupting^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Disrupting Ray_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=66/y81=3;                      [SummoningFire]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=7/y1=12/y1=18/y1=25/y1=33/y1=40/y1=50/y1=60/y1=70/y1=100/y1=150/y1=200/y1=300;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
*!SS66:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20*100;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=67/y82=3;                      [SummoningAir]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=7/y1=12/y1=18/y1=25/y1=33/y1=40/y1=50/y1=60/y1=70/y1=100/y1=150/y1=200/y1=300;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
*!SS67:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20*100;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=68/y83=3;                      [SummoningWater]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=7/y1=12/y1=18/y1=25/y1=33/y1=40/y1=50/y1=60/y1=70/y1=100/y1=150/y1=200/y1=300;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
*!SS68:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20*100;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=69/y84=3;                      [SummoningEarth]
!!SN:W^SpellTrainerHero%Y99_Spell66^/?y1;
!!if|y1=2/y1=7/y1=12/y1=18/y1=25/y1=33/y1=40/y1=50/y1=60/y1=70/y1=100/y1=150/y1=200/y1=300;
!!SN:W^Hero%Y99_Summoning_Upgrade^/?y20;
*!SS69:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20*100;
!!SN:T^AC_Spells.Trainer_Summoning^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Summoning_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=31/y81=3;                      [ProtectionFire]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS31:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=30/y82=3;                      [ProtectionAir]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS30:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=32/y83=3;                      [ProtectionWater]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS32:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=33/y84=3;                      [ProtectionEarth]
!!SN:W^SpellTrainerHero%Y99_Spell30^/?y1;
!!if|y1=2/y1=5/y1=9/y1=13/y1=17/y1=21/y1=25/y1=29/y1=34/y1=40/y1=50/y1=65/y1=80/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Protection_Upgrade^/?y20;
*!SS33:E3/?y10;
*!VRy10:Sy10 -y20 -101 * -1;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Protection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Protection_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=38/y84=3;                      [Resurrection]
!!SN:W^SpellTrainerHero%Y99_Spell38^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Resurrection_Upgrade^/?y20;
!!VRy22:Sy20*80;
!!VRy10:Sy22 +80;
!!SN:T^AC_Spells.Trainer_Resurrection^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Resurrection_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=39/y84=3;                      [Animation]
!!SN:W^SpellTrainerHero%Y99_Spell39^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Animation_Upgrade^/?y20;
!!VRy22:Sy20*100;
!!VRy10:Sy22 +100;
!!SN:T^AC_Spells.Trainer_Animation^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Animation_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=24/y84=30;                     [Disabled                      [Death Ripple]
!!SN:W^SpellTrainerHero%Y99_Spell24^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/?y20;
!!VRy22:Sy20*30;
!!VRy10:S50 +y22;
!!SN:T^AC_Spells.Trainer_Ripple^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Death Ripple_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=25/y82=30;                     [Disabled                    [Destroy Undead]
!!SN:W^SpellTrainerHero%Y99_Spell25^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/?y20;
!!VRy22:Sy20*50;
!!VRy10:S50 +y22;
!!SN:T^AC_Spells.Trainer_Destroy^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Destroy Undead_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=48/y83=3;                      [Prayer]
!!SN:W^SpellTrainerHero%Y99_Spell48^/?y1;
!!if|y1=5/y1=15/y1=30/y1=50/y1=80/y1=100/y1=150/y1=200/y1=210/y1=220/y1=250/y1=300;
!!SN:W^Hero%Y99_Prayer_Upgrade^/?y20;
*!SS48:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Prayer^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Prayer_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=55/y81=3;                      [Slayer]
!!SN:W^SpellTrainerHero%Y99_Spell55^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=60/y1=70/y1=80/y1=90/y1=100;
!!SN:W^Hero%Y99_Slayer_Upgrade^/?y20;
*!SS55:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Slayer^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Slayer_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=49/y83=3;                      [Mirth]
!!SN:W^SpellTrainerHero%Y99_Spell49^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Mirth_Upgrade^/?y20;
*!SS49:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Mirth^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Mirth_Upgrade^/d+1;     [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=50/y84=3;                      [Sorrow]
!!SN:W^SpellTrainerHero%Y99_Spell50^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Sorrow_Upgrade^/?y20;
*!SS50:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Sorrow^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Sorrow_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=51/y82=3;                      [Fortune]
!!SN:W^SpellTrainerHero%Y99_Spell51^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Fortune_Upgrade^/?y20;
*!SS51:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Fortune^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Fortune_Upgrade^/d+1;   [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=52/y81=3;                      [Misfortune]
!!SN:W^SpellTrainerHero%Y99_Spell52^/?y1;
!!if|y1=10/y1=30/y1=60/y1=100;
!!SN:W^Hero%Y99_Misfortune_Upgrade^/?y20;
*!SS52:E3/?y10;
*!VRy10:+1 +y20;
!!VRy10:Sy20 +1;
!!SN:T^AC_Spells.Trainer_Misfortune^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Misfortune_Upgrade^/d+1;[set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=56/y81=3;                      [Frenzy]
!!SN:W^SpellTrainerHero%Y99_Spell56^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=60/y1=70/y1=80/y1=90/y1=100;
!!SN:W^Hero%Y99_Frenzy_Upgrade^/?y20;
!!VRy22:Sy20*5;                         [5% extra Bonus per level]
!!VRy10:S5 +y22;
!!SN:T^AC_Spells.Trainer_Frenzy^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Frenzy_Upgrade^/d+1;    [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;

!!if&y2=37/y83=3;                      [Cure]
!!SN:W^SpellTrainerHero%Y99_Spell37^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=23/y1=30/y1=35/y1=40/y1=45/y1=50/y1=55/y1=60/y1=65/y1>65;
!!if|y1<=65/y1=70/y1=80/y1=85/y1=90/y1=95/y1=100/y1=120/y1=140/y1=160/y1=180/y1=200;
!!SN:W^Hero%Y99_Cure_Upgrade^/?y20;
!!VRy22:Sy20*5;                         [5 extra HP per level]
!!VRy10:S5 +y22;
!!SN:T^AC_Spells.Trainer_Cure^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Cure_Upgrade^/d+1;      [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=13/y81=3;                      [Fire Wall]
!!SN:W^SpellTrainerHero%Y99_Spell13^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/?y20;
!!VRy22:Sy20*35;
!!VRy10:S35 +y22;
!!SN:T^AC_Spells.Trainer_FireWall^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Fire Wall_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;

!!if&y2=11/y81=3;                      [Land Mine]
!!SN:W^SpellTrainerHero%Y99_Spell11^/?y1;
!!if|y1=2/y1=6/y1=11/y1=17/y1=24/y1=32/y1=41/y1=50/y1=61/y1=73/y1=86/y1=100/y1>100;
!!if|y1<=100/y1=120/y1=140/y1=160/y1=180/y1=200/y1=220/y1=240/y1=260/y1=280/y1=300;
!!SN:W^Hero%Y99_Land Mine_Upgrade^/?y20;
!!VRy22:Sy20*50;
!!VRy10:S50 +y22;
!!SN:T^AC_Spells.Trainer_LandMine^/?z1/^damage^/y10;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!SN:W^Hero%Y99_Land Mine_Upgrade^/d+1; [set upgrade counter]
!!VRy21:+1;                             [only 3 upgrades per battle allowed]
!!SN:W^Upgrade_Counter^/y21;
!!en;
!!en;
!!en;


*------------------------------------------------------------------------------*
!?BG1&1000;                             [Trigger damage Spells]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!SN:W^Flag_V896_Value^/?y1;
!!FU&y1<>1:E;
!!SN:W^Flag_V896_Value^/0;

!!BG:H?y3;                              [Determine if AI controlls Hero]
!!HEy3:O?y3;
!!OW:Iy3/?y3;
!!FU&y3=1:E;                            [Exit if AI Hero]

!!BG:S?y2;                              [y2 now contains spell number]
!!FU&y2<=9|y2>69:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;                          [Get Hero Number]
!!FU&y99=-2:E;                          [Exit if no Hero]

!!FU(Spell_Trainer_Calc):Py99/?y85/?y91;[Pass Hero Number and return Number of Spell Upgrades and Chance for Spell Upgrade]
!!FU&y85=0:E;                           [Exit if NO possible Spell Upgrades]
!!VRy92:S0R99;                          [Random Roll: Chance for Might Heros without Scholar to level up is 33%]
!!FU&y91<y92:E;                         [Exit if Roll was not successful]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84; [Checke ob der Held scholar und Magien hat]

!!HEy99&y99>=0:E?y70/?y71/1;            [Get Heroes level]
!!HEy99&y99>=0:A2/76/d/?y76 A2/77/d/?y77 A2/78/d/?y78 A2/139/d/?y79; [Check for Artifacts Collar,Ring,Cape,Ring of the Magi]

!!VRy71&y78=1|y79=1:+5;                 [If hero wears cape/ring of the magi increase maximal level of spells by 5]

!!SN:W^Damage_Spells_Increment^/?y60;
!!VRy60&y79=1:*2;

!!SN:W^Upgrade_Counter^/?y90;
!!FU&y85=1/y90>=1:E;                    [can only upgrade 1 times in one battle witch basic scholar]
!!FU&y85=2/y90>=2:E;
!!FU&y85=3/y90>=3:E;
!!FU&y85=4/y90>=4:E;
!!FU&y85=5/y90>=5:E;
!!FU&y85=6/y90>=6:E;
!!FU&y85=7/y90>=7:E;

!!SN:W^Spell_Number_Damage^/?y2;
!!SN:W^Stack_Number1^/?y50;
!!SN:W^Monster_Level^/?y52;

!!if&y50>=0/y50<=41;
!!BMy50:N?y51;
!!VRy51|y2=19/y2=24/y2=25/y2=26:S0;                 [Chain Lightning, Armageddon, 25  Destroy Undead, 24 Death Ripple dont neet to kill to level up]
!!if&y51=0;


!!if&y2=15;
!!if|y81>0/y82>0/y83>0/y84>0;
!!SN:W^SpellTrainerHero%Y99_Spell15^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell15^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell15^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell15^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;     [Total spell damages increased]
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;
!!en;

!!if&y2=16/y83>0;
!!SN:W^SpellTrainerHero%Y99_Spell16^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell16^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell16^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell16^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=17/y82>0;
!!SN:W^SpellTrainerHero%Y99_Spell17^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell17^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell17^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell17^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=21/y81>0;
!!SN:W^SpellTrainerHero%Y99_Spell21^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell21^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell21^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell21^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=22/y52>0/y81>0;
!!SN:W^SpellTrainerHero%Y99_Spell22^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell22^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell22^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell22^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=23/y52>0/y84>0;
!!SN:W^SpellTrainerHero%Y99_Spell23^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell23^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell23^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell23^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=20/y83>0;
!!SN:W^SpellTrainerHero%Y99_Spell20^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell20^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell20^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell20^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!VRy80:S0R3;                           [1/4 chance to level]
!!if&y2=19/y80=3/y82>0;
!!SN:W^SpellTrainerHero%Y99_Spell19^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell19^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell19^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell19^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=18/y52>2/y84>0;
!!SN:W^SpellTrainerHero%Y99_Spell18^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell18^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell18^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell18^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=26/y80=3/y81>0;                [1/4 chance to level]
!!SN:W^SpellTrainerHero%Y99_Spell26^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell26^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell26^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell26^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
*!SN:W^SpellTrainer_Sound_End^/1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=24/y80=3/y84>0;                24  Death Ripple
!!SN:W^SpellTrainerHero%Y99_Spell24^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell24^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell24^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell24^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
*!SN:W^SpellTrainer_Sound_End^/1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!if&y2=25/y80=3/y82>0;               25 Destroy Undead
!!SN:W^SpellTrainerHero%Y99_Spell25^/?y1;
!!VRy72:+y1 -y71;
!!VRy73:S0R10;
!!VRy73&y72<0:S11;
!!VRy73&y73>y72:S11;
!!if&y73=11;
!!SN:W^SpellTrainerHero%Y99_Spell25^/d+1;
!!SN&y79=1:W^SpellTrainerHero%Y99_Spell25^/d+1;
!!SN:W^SpellTrainerHero%Y99_Spell25^/?y1;
!!VRy10:Sy1 *y60; !!VRy10&y79=1::2;
!!VRy90:+1;
!!UN:N1/2/y2; !!SN:T^AC_Spells.Trainer^/?z1/^damage^/y60/^damage2^/y10; !!VRz1:S^{%Z2 %Z1}^;
!!BU:Mz1;
*!SN:W^SpellTrainer_Sound_End^/1;
!!VRz1:S^CLIMAX^;
!!SN:Pz1;
!!en;
!!en;

!!en;
!!en;
!!SN:W^Upgrade_Counter^/y90;


*------------------------------------------------------------------------------*
!?MR1&1000;                             [after stack takes magic damage]

!!SN:W^Spell_Trainer_Mod^/?y1; !!FU&y1=0:E; [Check if options have already been activated]
!!BG:A?y1;                              [Aktion in y1]
!!FU&y1<>1:E;

!!BG:Q?y1;
!!BA:Hy1/?y99;
!!FU&y99=-2:E;                          [Exit if no Hero]
!!HEy99&y99>=0:S14/?y81 S15/?y82 S16/?y83 S17/?y84 S18/?y85; [Checke current hero Scholar und Magien hat]
!!HEy99&y99>=0:E?y70/?y71/1;            [Get Heroes level]

!!MR:N?y50;

!!MR:S?y4;                              [Spell Number]
!!FU|y4<10/y4>26:E;                     [Exit if no valid Spell]
!!SN:W^Spell_Number_Damage^/y4;
!!MR:F?y10;                             [Get damage in y10]
!!SN:W^Stack_Number1^/y50;
!!BMy50&y50>=0:T?y51;
!!MA:Ly51/?y52;                         [monster type and level}]
!!SN:W^Monster_Level^/y52;

!!SN:W^Flag_V896_Value^/1;
!!FU:E; Test Rest is Disabled and moved to Spell Description

!!SN:W^Damage_Spells_Increment^/?y60;


!!if&y4=15;                            [Magic Arrow]
!!SN:W^SpellTrainerHero%Y99_Spell15^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=16/y83>0;                      [Ice Bolt]
!!SN:W^SpellTrainerHero%Y99_Spell16^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=17/y82>0;                      [Lightning Bolt]
!!SN:W^SpellTrainerHero%Y99_Spell17^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=21/y81>0;                      [Fireball]
!!SN:W^SpellTrainerHero%Y99_Spell21^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=23/y84>0;                      [Meteor Shower]
!!SN:W^SpellTrainerHero%Y99_Spell23^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=20/y83>0;                      [Frost Ring]
!!SN:W^SpellTrainerHero%Y99_Spell20^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=19/y82>0;                      [Chain Lightning]
!!SN:W^SpellTrainerHero%Y99_Spell19^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=22/y81>0;                      [Inferno]
!!SN:W^SpellTrainerHero%Y99_Spell22^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=18/y84>0;                      [Implosion]
!!SN:W^SpellTrainerHero%Y99_Spell18^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!if&y4=26/y84>0;                      [Armageddon]
!!SN:W^SpellTrainerHero%Y99_Spell26^/?y1;
!!VRy11:Sy1 *y60 +100;                  [3% stronger with every use]
!!VRy10:Sy10 *y11 :100;
!!en;

!!MR:Fy10;                              [apply new damage]

!!SN:W^Flag_V896_Value^/1;


*------------------------------------------------------------------------------*
!?FU(Spell_Trainer_Reset_1);

!!DO(Spell_Trainer_Reset)/0/69/1:Px16;  [Reset spell damage increase/counter for all Heroes when Map Starts]

!?FU(Spell_Trainer_Reset);
!!SN:W^SpellTrainerHero%X1_Spell%X16^/0;


*------------------------------------------------------------------------------*
!?FU(Spell_Trainer_Reset_2);

!!DO(Map_Start_Upgrade_Spells_Reset)/0/155/1:P; [Reset Spell Upgrades for all Heroes when Map Starts]


!?FU(Map_Start_Upgrade_Spells_Reset);

!!SS27:E3/?y10;
!!SN:W^Hero%X16_Shield_Upgrade^/0;
!!SN:W^Shield_Value_Start^/y10;

!!SS43:E3/?y10;
!!SN:W^Hero%X16_Bloodlust_Upgrade^/0;
!!SN:W^Bloodlust_Value_Start^/y10;

!!SS41:E3/?y10;
!!SN:W^Hero%X16_Bless_Upgrade^/0;
!!SN:W^Bless_Value_Start^/y10;

!!SS42:E3/?y10;
!!SN:W^Hero%X16_Curse_Upgrade^/0;
!!SN:W^Curse_Value_Start^/y10;

!!SS44:E3/?y10;
!!SN:W^Hero%X16_Precision_Upgrade^/0;
!!SN:W^Precision_Value_Start^/y10;

!!SS45:E3/?y10;
!!SN:W^Hero%X16_Weakness_Upgrade^/0;
!!SN:W^Weakness_Value_Start^/y10;

!!SS46:E3/?y10;
!!SN:W^Hero%X16_Stoneskin_Upgrade^/0;
!!SN:W^Stoneskin_Value_Start^/y10;

!!SS28:E3/?y10;
!!SN:W^Hero%X16_Air Shield_Upgrade^/0;
!!SN:W^Air Shield_Value_Start^/y10;

!!SS29:E3/?y10;
!!SN:W^Hero%X16_Fire Shield_Upgrade^/0;
!!SN:W^Fire Shield_Value_Start^/y10;

!!SS53:E3/?y10;
!!SN:W^Hero%X16_Haste_Upgrade^/0;
!!SN:W^Haste_Value_Start^/y10;

!!SS54:E3/?y10;
!!SN:W^Hero%X16_Slow_Upgrade^/0;
!!SN:W^Slow_Value_Start^/y10;

!!SS47:E3/?y10;
!!SN:W^Hero%X16_Disrupting Ray_Upgrade^/0;
!!SN:W^Disrupting Ray_Value_Start^/y10;

!!SS66:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningFire_Value_Start^/y10;

!!SS67:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningAir_Value_Start^/y10;

!!SS68:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningWater_Value_Start^/y10;

!!SS69:E3/?y10;
!!SN:W^Hero%X16_Summoning_Upgrade^/0;
!!SN:W^SummoningEarth_Value_Start^/y10;

!!SS31:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionFire_Value_Start^/y10;

!!SS30:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionAir_Value_Start^/y10;

!!SS32:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionWater_Value_Start^/y10;

!!SS33:E3/?y10;
!!SN:W^Hero%X16_Protection_Upgrade^/0;
!!SN:W^ProtectionEarth_Value_Start^/y10;

!!SS38:E3/?y10;
!!SN:W^Hero%X16_Resurrection_Upgrade^/0;
!!SN:W^Resurrection_Value_Start^/y10;

!!SS39:E3/?y10;
!!SN:W^Hero%X16_Animation_Upgrade^/0;
!!SN:W^Animation_Value_Start^/y10;

!!SS24:E3/?y10;
!!SN:W^Hero%X16_Death Ripple_Upgrade^/0;
!!SN:W^Death Ripple_Value_Start^/y10;

!!SS25:E3/?y10;
!!SN:W^Hero%X16_Destroy Undead_Upgrade^/0;
!!SN:W^Destroy Undead_Value_Start^/y10;

!!SS48:E3/?y10;
!!SN:W^Hero%X16_Prayer_Upgrade^/0;
!!SN:W^Prayer_Value_Start^/y10;

!!SS55:E3/?y10;
!!SN:W^Hero%X16_Slayer_Upgrade^/0;
!!SN:W^Slayer_Value_Start^/y10;

!!SS49:E3/?y10;
!!SN:W^Hero%X16_Mirth_Upgrade^/0;
!!SN:W^Mirth_Value_Start^/y10;

!!SS50:E3/?y10;
!!SN:W^Hero%X16_Sorrow_Upgrade^/0;
!!SN:W^Sorrow_Value_Start^/y10;

!!SS51:E3/?y10;
!!SN:W^Hero%X16_Fortune_Upgrade^/0;
!!SN:W^Fortune_Value_Start^/y10;

!!SS52:E3/?y10;
!!SN:W^Hero%X16_Misfortune_Upgrade^/0;
!!SN:W^Misfortune_Value_Start^/y10;

!!SS56:E3/?y10;
!!SN:W^Hero%X16_Frenzy_Upgrade^/0;
!!SN:W^Frenzy_Value_Start^/y10;

!!SS37:E3/?y10;
!!SN:W^Hero%X16_Cure_Upgrade^/0;
!!SN:W^Cure_Value_Start^/y10;

!!SS11:E3/?y10;
!!SN:W^Hero%X16_Land Mine_Upgrade^/0;
!!SN:W^Land Mine_Value_Start^/y10;

!!SS13:E3/?y10;
!!SN:W^Hero%X16_Fire Wall_Upgrade^/0;
!!SN:W^Fire Wall_Value_Start^/y10;


****************************************************************************************************








****************************************************************************************************
*The modified Eagle Eye script from WoG, that lets you visit objects from afar and increases
the amount of res and treasure chests

!#UN:P23/0;    [Disable Sorcery Script]
!#SN:W^Advanced_Classes_Mod_Active^/?v1;
 [Set Flags 410 to False]
!#IF&v1=1:V410/0;

-----------------------------------------------------------------------------------------
 [Set up Timer 18 for giving AI with Sorcery a bonus to movement as compensation]

!#SN:W^Advanced_Classes_Mod_Active^/?v1;
!#TM18&v1=1:S1/999/1/255;

 [Set up table of bit values]
!#VRv550&v1=1:C1/2/4/8/16/32/64/128/256/512;

-----------------------------------------------------------------------------------------
 [Check version of ERM to see if it's current enough]
 [Display warning message if it isn't]
!#IF:V1/0;
!#UN:V?v310/?v311;
!#IF&v310<357:V1/1;
!#IF&v311<260:V1/1;
!#IF&1:M1/z198704;
-----------------------------------------------------------------------------------------
 [Start of CM trigger]
!?CM;

!!SN:W^Advanced_Classes_Mod_Active^/?v1;

!?CM&v1=1; [Continue trigger if Sorcery script is enabled]

 [Check item area clicked]
!!CM:I?v1;

 [If item area is adventure map, call Function 5000]
!!FU25511&v1=37:P;
-----------------------------------------------------------------------------------------
 [Start of Function 5000 - get coordinates and object type/subtype]
 [and control word at the right-click location]
!?FU25511;

 [Get number of currently selected hero - store in y8]
!!OW:A-1/?y8;

 [Get coordinates clicked - store in y1,y2,y3]
!!CM&y8>=0:P?y1/?y2/?y3;

 [Get object type (y4), subtype (y5) and control word (y6)]
!!OBy1/y2/y3:T?y4 U?y5 C?y6;

 [Set Flag 3 to false]
!!IF:V3/0;

 [Get Eagle Eye skill level of current hero - store in y9]
!!HEy8&y8>=0:S11/?y9;

 [Get current player - store in y10 and add 550]
 [then store corresponding bit value from vy10]
!!OW:C?y10;
!!VRy10:+550;
!!VRy10:Svy10;

 [Get visibility of square clicked - store in y17]
!!TRy1/y2/y3:V?y17;

 [Just look at visibility bit for current player - 0=in shroud]
!!VRy17:&y10;

 [Check if object has customized hint text (y16)]
!!OBy1/y2/y3:H?y16;

 [If object has hint text, set y17 to 0]
!!VRy17&y16<>0:S0;
-------------------------------------------
 [Only continue Function 5000 if hero has EE skill and object isn't in shroud]
 [and doesn't have standard customized hint text and a Hero is selected (y8>=0)]
!!FU|y9<=0/y17=0/y8<0:E;


!!HEy8:Ed0/?y10/1;

!!SN:W^H3_Eagle Eye_0_Hero%Y8^/?y41;                                              [Checke ob der Held Master Archery hat und Speichere in y11]
!!SN:W^H3_Eagle Eye_1_Hero%Y8^/?y42;                                              [Checke ob der Held Grandmaster Archery hat und Speichere in y12]

!!VRy10&y9=1:S10;               [Set Radius according to EE skill level]
!!VRy10&y9=2:S16;
!!VRy10&y9=3:S20;
!!VRy10&y9=3/y41=1/y42=0:S20;
!!VRy10&y9=3/y41=1/y42=1:S25;

 [Store hero's coordinates in y11/y12/y13]
!!HEy8:P?y11/?y12/?y13;

 [Calculate distance to object - store in y15]
!!VRy14:Sy11 -y1;  [(x1-x2)]
!!VRy14:*y14;      [* (x1-x2)]
!!VRy15:Sy12 -y2;  [(y1-y2)]
!!VRy15:*y15;      [* (y1-y2)]
!!VRy15:+y14;      [(x1-x2)*(x1-x2) + (y1-y2)*(y1-y2)]

*!IF:L^y10 is %Y10 and y15 is %Y15^;
-------------------------------------------
 [Only continue Function 5000 if hero has EE skill (y9>0),
 [is on the same map level as object (y3=y13),]
 [and is within range of the object (y15<=y10)]
 [and object is not in shroud (y17<>0) and a Hero is selected (y8>=0)]
!!FU|y9<=0/y3<>y13/y15>y10/y17=0/y8<0:E;

 [Check if a new chest is standard or custom (ERM) - y7=0 if chest not ERM enabled]
!!UN&y4=101/y5>0/y5<7:By5/?y7;

 [Disable standard right-click info for this visit if object]
 [is one for which expanded "hint text" will be displayed]
!!CM|y4=79/y4=81/y4=12/y4=93/y4=39/y4=105/y4=22/y4=112/y4=91/y4=102:R0;
!!CM|y4=55/y4=108/y4=5/y4=86/y4=29/y4=82/y4=104/y4=109:R0;
!!CM&y4=63/y5=0:R0;       [Pyramid]
!!CM&y4=101/y5=0:R0;      [Standard chest]
!!CM&y4=101/y5>0/y5<7/y7=0:R0; [New chest, non-ERM enabled]

!!IF:V1/0; [Clear flag 1]
!!FU849:P; [Flag 1 will be set if Chest script in use]

!!FU25512&y4=79:Py1/y2/y3/y5/y6; [Resource pile]
!!FU25513&y4=81:Py1/y2/y3/y8; [Scholar]
!!FU25514&y4=101/y7=0/y5<7:Py1/y2/y3; [Treasure Chest (standard)]
!!FU25515&y4=101/y5=1/y7=1/1:Py1/y2/y3; [ERM Chest - Display "Trapped/Non-Trapped"]
!!FU25516&y4=12:Py1/y2/y3; [Campfire]
!!FU25517&y4=93:Py1/y2/y3; [Scroll]
!!FU25518&y4=39:Py1/y2/y3; [Lean To]
!!FU25519&y4=105:Py1/y2/y3; [Wagon]
!!FU25520&y4=22:Py1/y2/y3; [Skeleton]
!!FU25521&y4=112:Py1/y2/y3/y9/y41/y42; [View/Visit Windmill]
!!FU25522|y4=91/y4=59:Py1/y2/y3; [Sign or Bottle]
!!FU25523&y4=102:Py1/y2/y3/y6; [Tree of Knowledge]
!!FU25524&y4=55:Py1/y2/y3/y6/y9/y41/y42; [View/Visit Mystical Garden]
!!FU25525&y4=108:Py1/y2/y3; [Warrior's Tomb]
!!FU25526|y4=113/y4=88/y4=89/y4=90:Py1/y2/y3/y6; [Witch Hut or Shrine]
!!FU25527&y4=100/y9=3/999:Py1/y2/y3/y8/y41/y42; [Visit Learning Stone]
!!FU25528&y4=63/y5=0:Py1/y2/y3; [Pyramid]
!!FU25529&y4=5:Py1/y2/y3/y5/y6; [Artifact]
!!FU25530&y4=86:Py1/y2/y3/y6; [Shipwreck Survivor]
!!FU25531&y4=29:Py1/y2/y3/y6; [Flotsam]
!!FU25532&y4=82:Py1/y2/y3/y6; [Sea Chest]
!!FU25533&y4=104:Py1/y2/y3; [University]
!!FU25534&y4=109:Py1/y2/y3/y9/y41/y42; [View/Visit Water Wheel]
!!FU25535&y4=61/y9=3/999/y41=1:Py1/y2/y3/y6/y8; [Visit Star Axis]
!!FU25536&y4=32/y9=3/999/y41=1:Py1/y2/y3/y6/y8; [Visit Garden of Revelation]
-----------------------------------------------------------------------------------------
 [Start of Function 5001 - Display Resource Pile Amounts]
!?FU25512;

 [Store amount of resource in y1]
!!ARx1/x2/x3:V?y1;

 [If resource is gold, multiply amount by 100]
!!VRy1&x4=6:*100;

 [Set Flag 1 to false and z3 to null]
!!IF:V1/0; !!VRz3:S^^;

~~ARx1/x2/x3&x5<0:X?y2; [Check if guards are turned on: y2]

 [Check each slot for guards (if resource pile has set-up) - store in z3]
!!DO25544/0/6/1&x5<0:Px1/x2/x3;

 [Call Function 5020 to set up appropriate hint text]
!!FU25541:Px4/y1;

 [Add additional hint text if there are guards]
!!VRz1&1:Sz198705;

 [If not guards, just resource pile information (z1)]
!!VRz1&-1:Sz2;

 [Display hint text]
!!IF:Q1/x4/y1/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5002 - Display Scholar details]
!?FU25513;

 [Check what Scholar teaches (y1): 0=Primary skill, 1=Secondary skill, 2=Spell]
 [Primary skill # in y2, Secondary skill # in y3, Spell # in y4]
!!SCx1/x2/x3:T?y1 P?y2 S?y3 L?y4;

 [Type 0 - Primary skill]
!!VRz2:S^^;
!!VRy5&y1=0:Sy2 +31;
!!VRy6&y1=0:S1;
!!VRz1&y1=0/y2<2:Sz198706;
!!VRz1&y1=0/y2=2:Sz198707;
!!VRz1&y1=0/y2=3:Sz198708;

 [Type 1 - Secondary skill]

 [Check hero's level in skill - store in y7]
!!HEx4&y1=1:Sy3/?y7;
!!VRy5&y1=1:S20;
!!VRy6&y1=1:Sy3 *3 +3;
!!VRy6&y1=1/y7=1:+1;
!!VRy6&y1=1/y7=2:+2;
!!VRz1&y1=1:Sz198709;

 [Type 2 - Spell]
!!VRy5&y1=2:S9;
!!VRz1&y1=2:Sz198710;
 [Subtract 1024 to get spell number]
!!VRy4&y1=2:-1024;
!!VRy6&y1=2:Sy4;

 [Display hint text]
!!IF:Q1/y5/y6/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5003 - Display Treasure Chest Contents]
!?FU25514;

 [Contents - y1 = bonus type (artifact or gold/experience), y2=artifact number,]
 [y3 = bonus amount (if gold/experience)]
!!CHx1/x2/x3:S?y1 A?y2 B?y3;

 [Multiply bonus amount by 500 to get gold amount (y5), subtract 500 for experience (y6)]
!!VRy5&y1=0:Sy3*500;
!!VRy6&y1=0:Sy5-500;

 [Display hint text for gold/experience]
!!IF&y1=0:Q1/6/y5/17/y6/4/z198711;

 [Display hint text for artifact]
!!IF&y1<>0:Q1/8/y2/4/z198712;
-----------------------------------------------------------------------------------------
 [Start of Function 5004 - Display Campfire Contents]
!?FU25516;

 [Store campfire bonus type (y1) and value (y2)]
!!FRx1/x2/x3:B?y1/?y2;

 [Multiply bonus value by 100 (gold), store in y3]
!!VRy3:Sy2 *100;

 [Display hint text]
!!IF:Q1/6/y3/y1/y2/4/z198713;
-----------------------------------------------------------------------------------------
 [Start of Function 5005 - Display Scroll Spell]
!?FU25517;

 [Get scroll spell number (y1)]
!!ARx1/x2/x3:V?y1;

 [Check scroll's control word to see if it has any setup or not]
 [Store number in variable i -- a negative number indicates setup]
!!OBx1/x2/x3:C?i;

 [Set Flag 1 to false and z3 to null]
!!IF:V1/0; !!VRz3:S^^;

 [Check each slot for guards (if scroll has set up) - store in z3]
!!DO25544/0/6/1&i<0:Px1/x2/x3;

 [Look up name of spell (z2)]
!!UN:N1/2/y1;

 [Set y2 to 1 if a Living Scroll]
!!UN:P33/?y2; [Check if Living Scrolls is enabled: y2=1 if  yes]
!!VRy2|y1<10/y1=24/y1=25/y1=35/y1=38/y1=39/y1=40/y1=65/y1=66/y1=67/y1=68/y1=69:S0;
!!VRz-1&y2=1:Sz198104;
!!VRz-1&y2=0:S^^;

 [Add additional hint text if there are guards]
!!VRz1&1:Sz198714;

 [If not guards, just scroll spell name (z1)]
!!VRz1&-1:Sz198715;

 [Display hint text]
!!IF:Q1/9/y1/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5006 - Display Lean To Contents]
!?FU25518;

 [If red square is clicked on, add one to x position (x1)]
!!TRx1/x2/x3:P?y3;
!!VRx1&y3=0:+1;

 [Get resource type (y1) and value (y2)]
!!LNx1/x2/x3:B?y1/?y2;

 [Call Function 5020 to set up appropriate hint text]
!!FU25541:Py1/y2;

 [If Lean To is empty, set z2 to this message]
!!VRz2&y2<1:Sz198716;
!!VRy1&y2<1:S-1;

 [Set up new hint text (z1)]
!!VRz1:Sz198717;

 [Display hint text]
!!IF:Q1/y1/y2/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5007 - Display Wagon Contents]
!?FU25519;

 [Check wagon details: y1 (bonus or not), y2 (bonus type: artifact or resource),]
 [y3 (artifact number), y4 (resource type), y5 (resource amount)]
!!WGx1/x2/x3:S?y1 B?y2 A?y3 R?y4/?y5;

 [If resource bonus Call Function 5020 to set up appropriate hint text (z2)]
!!FU25541&y1<>0/y2=0:Py4/y5;

 [Lookup artifact class - z2]
!!FU25537&y2<>0:Py3;

 [Set up hint text in z1 for resources]
!!VRz1&y1<>0/y2=0:Sz198718;

 [Set up hint text in z1 for artifact]
!!VRz1&y1<>0/y2<>0:Sz198719;
!!VRy4&y1<>0/y2<>0:S8;

 [If wagon is empty, set z1 to "Wagon contains nothing of value."]
 [and set y4 and y5 to -1]
!!VRz1&y1=0:Sz198720;
!!VRy4&y1=0:S-1;
!!VRy5&y1=0:S-1;

 [Display hint text for resources]
!!IF&y2=0:Q1/y4/y5/4^%Z1^;

 [Display hint text for artifact]
!!IF&y2<>0:Q1/y4/y3/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5008 - Display Skeleton Contents]
!?FU25520;

 [Get skeleton bonus (y1) and artifact type, if any (y2)]
!!SKx1/x2/x3:S?y1 A?y2;

 [Set y3 to artifact type]
!!VRy3&y1<>0:S8; [Artifact]

 [If skeleon has nothing, set z1 to "Skeleton has nothing of value."]
 [Set type (y3) and subtype (y2) to -1]
!!VRz1&y1=0:Sz198721;
!!VRy2&y1=0:S-1;
!!VRy3&y1=0:S-1;

 [Look up class of artifact (z2)]
!!FU25537&y1<>0:Py2;

 [Set up hint text in z1 for artifact]
!!VRz1&y1<>0:Sz198722;

 [Display hint text]
!!IF:Q1/y3/y2/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5009 - Display Windmill Contents]
!?FU25521;

 [Check type of resource (y1) and amount (y2)]
!!MLx1/x2/x3:B?y1/?y2;

 [Call Function 5020 to set up appropriate resource hint text]
!!FU25541:Py1/y2;

 [If resources gone for the week, set z2 to (Visited)]
!!VRz2&y2<1:Sz198723;
!!VRy1&y2<1:S-1;
!!VRy2&y2<1:S-1;

 [Check if Windmill is upgraded by Mithril and if it is (y3=2 or 3), set z3]
!!POx1/x2/x3:N?y3;
!!VRy3|y3=2/y3=3:S2; [If y3=2 or 3, set it to 2]
!!VRz3:S^^;
!!VRz3&y3=2:Sz198724;

 [Set up hint text in z1]
!!VRz1:Sz198725;

 [Display hint text]
!!if&x5=0/x6=0;
!!IF|x4<=3/y2<1:Q1/y1/y2/4^%Z1^;
!!en;

 [If hero has Expert Sorcery, call Function 5027 and player]
 [is offered the chance to visit the Windmill from a distance]

!!FU25543&x4=3/y2>0/999/x5=1:Px1/x2/x3/y1/y2;           Scheise
-----------------------------------------------------------------------------------------
 [Start of Function 5027 - Remotely visit Windmill]
!?FU25543;

 [Check if Windmill is upgraded by Mithril and if it is (y3=2 or 3), set z3]
!!POx1/x2/x3:N?y3;
!!VRz3:S^^;
!!VRz3|y3=2/y3=3:Sz198726;

 [Ask if player wishes to visit windmill remotely - answer in Flag 2]
!!IF:Q2/x4/x5/2/z198727;

 [If player clicks OK, display message]
!!IF&2:Q2/x4/x5/1/z198728;

 [Give player mill resources if player visited remotely]
!!OW&2:R-1/x4/dx5;

 [Set mill resources to 0 and "visited"]
!!MLx1/x2/x3&2:Bd0/0;
----------------------------------------------------------------------------------------
 [Start of Function 5010 - Display Sign Message]
!?FU25522;

 [Store sign message in z1]
!!SGx1/x2/x3:M?z1;

 [Check if sign is default or blank - Flag 1 set to false if empty]
!!VRz1:H1;

 [If sign is default or blank, set z1 to this text]
!!VRz1&-1:Sz198729;

 [Display hint text]
!!IF:Q1/-1/-1/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5011 - Display Tree of Knowledge type]
!?FU25523;

 [Store type in y1 and tree number in y2]
!!KTx1/x2/x3:S?y1 N?y2;

 [Get active hero number - store in y3]
!!OW:A-1/?y3;

!!VRz2&y1=0:Sz198730;
!!VRy5&y1=0:S-1;
!!VRy6&y1=0:S-1;
!!VRz2&y1=1:Sz198731;
!!VRy5&y1=1:S6;
!!VRy6&y1=1:S2000;
!!VRz2&y1=2:Sz198732;
!!VRy5&y1=2:S5;
!!VRy6&y1=2:S10;

 [Check if hero has visited this tree - y4=1 if visited]
!!HEy3:V5/y2/?y4;

 [If hero visited tree, set z3 to (already visited), otherwise set it ^^]
!!VRz3&y4=1:Sz198733;
!!VRz3&y4=0:S^^;

!!VRz1:Sz198734;

 [Display hint text]
!!IF:Q1/y5/y6/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5012 - Display Mystical Garden Contents]
!?FU25524;

 [Check yellow square values for square clicked - store in y5]
!!TRx1/x2/x3:E?y5;

 [Check Garden's bonus type (y1) and resource type (y2)]
!!GDx1/x2/x3:T?y1 B?y2;

 [Set resource amounts]
!!VRy3|y2=5/y2=7:S5;
!!VRy3&y2=6:S500;

 [Call Function 5020 to set up appropriate hint text if it's a resource]
!!FU25541&y1<>0:Py2/y3;

 [Check if Garden already visited this week]
!!VRz2&x4<-1600:Sz198735;
!!VRy2&x4<-1600:S-1;
!!VRy3&x4<-1600:S-1;

 [Set z1 to hint text]
!!VRz1:Sz198736;

 [If a red square is clicked on, set hint text to this instead]
!!VRz1&y5=1:Sz198737;
!!VRy2&y5=1:S-1;
!!VRy3&y5=1:S-1;

 [Display hint text]
!!IF|x5<3/x4<=-1600/y5=1:Q1/y2/y3/4^%Z1^;

 [If hero has Expert EE, call Function 5028 and player]
 [is offered the chance to visit the Mystical Garden from a distance]
 [Only allow remote visit if clicking on yellow square]
!!FU25542&x5=3/x4>-1600/y5=0/999/x6=1:Px1/x2/x3/y2/y3;
-----------------------------------------------------------------------------------------
 [Start of Function 5028 - Remotely visit Mystical Garden]
!?FU25542;

 [Ask if player wishes to visit mystical garden remotely - answer in Flag 2]
!!IF:Q2/x4/x5/2/z198738;

 [If player clicks OK, display message]
!!IF&2:Q2/x4/x5/1/z198739;

 [Give player mystical garden resources if player visited remotely]
!!OW&2:R-1/x4/dx5;

 [Set mystical garden resources to 0 and "visited"]
!!OBx1/x2/x3&2:C-1650;
-----------------------------------------------------------------------------------------
 [Start of Function 5013 - Display contents of Warrior's Tomb]
!?FU25525;

 [If red square is clicked on, add one to x position (x1)]
!!TRx1/x2/x3:P?y3;
!!VRx1&y3=0:+1;

 [Store artifact/no artifact in y1, artifact number in y2]
!!WTx1/x2/x3:S?y1 A?y2;

 [Lookup artifact class - z2]
!!FU25537:Py2;

!!VRy4:S8; [Artifact]
!!VRz1&y1<>0:Sz198740;

 [If Tomb has nothing, set z1 to "Warrior's Tomb is empty."]
!!VRz1&y1=0:Sz198741;
!!VRy2&y1=0:S-1;
!!VRy4&y1=0:S-1;

 [Display hint text]
!!IF:Q1/y4/y2/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5014 - Display Witch Hut Skill or Shrine Spell]
!?FU25526;

 [Get current player - store in y1]
!!OW:C?y1;

 [Convert player number into bit value for control word (y1)]
!!VRy1:+550;
!!VRy1:Svy1;
!!VRy1:*32;

 [Set control word so that active player has 'visited' witch hut]
!!VRx4:|y1;
!!OBx1/x2/x3:Cx4;
-----------------------------------------------------------------------------------------
 [Start of Function 5015 - Remotely Visit Learning Stone]
!?FU25527;

 [Get number of learning stone (y1)]
!!STx1/x2/x3:N?y1;

 [Check if hero has visited this learning stone (y2)]
!!HEx4:V0/y1/?y2;

!!FU|y2<>0/x5=0:E; [Exit if hero has already visited this Learning Stone or has no Master Eagle Eye]

 [Ask if player wishes to visit learning stone remotely - answer in Flag 2]
!!IF:Q2/17/1000/2/z198742;

 [If player clicks OK, display message]
!!IF&2:Q2/17/1000/1/z198743;

 [Set Learning Stone as visited if player chose to visit remotely]
!!HEx4&2:V0/y1/1;

 [Give hero 1000 experience (or more if knows Learning) if player chose to visit remotely]
!!HEx4&2:S21/?y3; [Level of Learning skill known: y3]
!!HEx4&2/y3=0:Ed1000; [No skill]
!!HEx4&2/y3=1:Ed1050; [Basic Learning]
!!HEx4&2/y3=2:Ed1100; [Advanced Learning]
!!HEx4&2/y3=3:Ed1150; [Expert Learning]

 [Disable right-click for this visit]
!!CM:R0;
-----------------------------------------------------------------------------------------
 [Start of Function 5016 - Display Pyramid Spell]
!?FU25528;

 [If red square is clicked on, add one to x position (x1)]
!!TRx1/x2/x3:P?y3;
!!VRx1&y3=0:+1;

 [Store pyramid spell number in y1 and visited status in y2]
!!PMx1/x2/x3:S?y1 V?y2;

 [Determine Spell name - store in z2 - store type/subtype in y5 and y6]
!!UN&y1<>0:N1/2/y1;
!!VRy5:S9;
!!VRy6:Sy1;

 [Get active hero number - store in y3]
!!OW:A-1/?y3;

 [Check if active hero knows this spell already - y4 > 0 if hero knows spell]
!!HEy3:My1/?y4;

 [Add additional (already learned) text (z2) if hero knows spell (y4 > 0)]
!!VRz2&y4>0:Sz198744;

 [If Pyramid already visited, set, set z2 to "(visited)"]
!!VRz2&y2=0:Sz198745;

!!VRz1&y1<>0:Sz198746;
!!VRy5&y2=0:S-1;
!!VRy6&y2=0:S-1;

 [Display hint text]
!!IF:Q1/y5/y6/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5017 - Display Artifact name]
!?FU25529;

 [Set Flag 1 to false and z3 to null]
!!IF:V1/0;
!!VRz3:S^^;

~~ARx1/x2/x3&x5<>0:X?y1; [Check if guards are turned on: y1]

 [Check each slot for guards - store in z3]
 [Flag 1 is set to true if there are any guards]
!!DO25544/0/6/1&x5<>0:Px1/x2/x3;

 [Lookup artifact class - z2]
!!FU25537:Px4;

 [Add additional hint text if there are guards]
!!VRz1&1:Sz198747;

 [If no guards, just artifact class and picture]
!!VRz1&-1:S^%Z2^;

 [Display hint text]
!!IF:Q1/8/x4/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5018 - Display Artifact/Scroll/Resource Guards]
!?FU25544;

 [Check artifact/scroll/resource guard type (y1) and number (y2) in each slot]
!!ARx1/x2/x3:Gx16/?y1/?y2;

 [If there's a guard in any slot set Flag 1]
!!IF&y1<>-1/y2>0:V1/1;

 [If there's a guard in this slot, look up name of monster (z2)]
!!UN&y1<>-1/y2=1:N3/2/y1/0;
!!UN&y1<>-1/y2>1:N3/2/y1/1;

 [If there's a guard in this slot, add name and number to z3 variable list]
!!VRz3&y1<>-1/y2>0:S^%Z3
%Y2 %Z2^;
-----------------------------------------------------------------------------------------
 [Start of Function 5019 - Display Shipwreck Survivor Artifact]
!?FU25530;

 [Lookup artifact class - z2]
!!FU25537:Px4;

 [Display hint text]
!!IF:Q1/8/x4/4/z198748;
-----------------------------------------------------------------------------------------
 [Start of Function 5020 - Hint text for resources - stored in z2]
!?FU25541;

 [Set up appropriate hint text]
!!VRz2:S^{%X2} ^;
!!VRz2&x1=0/x2=1:+z198749;
!!VRz2&x1=0/x2>1:+z198750;
!!VRz2&x1=1/x2=1:+z198751;
!!VRz2&x1=1/x2>1:+z198752;
!!VRz2&x1=2/x2=1:+z198753;
!!VRz2&x1=2/x2>1:+z198754;
!!VRz2&x1=3/x2=1:+z198755;
!!VRz2&x1=3/x2>1:+z198756;
!!VRz2&x1=4/x2=1:+z198757;
!!VRz2&x1=4/x2>1:+z198758;
!!VRz2&x1=5/x2=1:+z198759;
!!VRz2&x1=5/x2>1:+z198760;
!!VRz2&x1=6/x2=1:+z198761;
!!VRz2&x1=6/x2>1:+z198762;
!!VRz2&x1=7/x2=1:+z198763;
!!VRz2&x1=7/x2>1:+z198764;
-----------------------------------------------------------------------------------------
 [Start of Function 5021 - Display Flotsam Type]
!?FU25531;

!!VRz2&x4=0:Sz198765;
!!VRy1&x4=0:S-1;
!!VRy3&x4<2:S-1;
!!VRz2&x4=1:Sz198766;
!!VRy1&x4>0:S0;
!!VRy2&x4>0/x4<3:S5;
!!VRz2&x4=2:Sz198767;
!!VRy3&x4>1:S6;
!!VRy4&x4=2:S200;
!!VRz2&x4=3:Sz198768;
!!VRy2&x4=3:S10;
!!VRy4&x4=3:S500;

 [Set up hint text (z1)]
!!VRz1:Sz198769;

 [Display hint text]
!!IF:Q1/y1/y2/y3/y4/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5022 - Sea Chest Type]
!?FU25532;

 [For chest type, &7 control word - store in y1]
!!VRy1:Sx4 &7;

 [Determine artifact number - store in y2]
!!VRy2&y1=2:Sx4 :8 &255 -1;

 [Lookup artifact class - z2]
!!FU25537&y1=2:Py2;

 [Set up z1 to store "Sea Chest"]
!!VRz1:Sz198770;

 [Display hint text for empty]
!!IF&y1=0:Q1/-1/-1/4/z198771;

 [Display hint text for 1500 gold]
!!IF&y1=1:Q1/6/1500/4/z198772;

 [Display hint text for 1000 gold plus artifact]
!!IF&y1=2:Q1/36/1000/8/y2/4/z198773;
-----------------------------------------------------------------------------------------
 [Start of Function 5023 - Display skills offered by University]
!?FU25533;

 [Check if square clicked is yellow (0=yellow)]
!!TRx1/x2/x3:E?y5;

 [Get university details if yellow square clicked]
!!URx1/x2/x3&y5=0:S?y1/?y2/?y3/?y4;
!!VRz1:Sz198774;
!!UN:N4/2/y1;
!!VRz1:S^%Z1
{%Z2,}^;
!!UN:N4/2/y2;
!!VRz1:S^%Z1 {%Z2}^;
!!UN:N4/2/y3;
!!VRz1:S^%Z1
{%Z2,}^;
!!UN:N4/2/y4;
!!VRz1:S^%Z1 {%Z2.}^;

 [If PO:N is 2, and Mithril script active, it's]
 [an Advanced University (upgraded by Mithril)]
!!UN:P36/?y6;
!!POx1/x2/x3:N?y7;
!!VRz-1:S^^;
!!VRz-1&y6=1/y7=2:Sz198775+^ ^;

 [Display hint text if yellow square clicked]
!!IF&y5=0:Q1/-1/-1/4^%Z-1%Z1^;

 [Enable standard right-click hint text if non-yellow square clicked]
!!CM&y5<>0:R1;
-----------------------------------------------------------------------------------------
 [Resource object trigger - Enhance resource piles]
!?OB79&-875;

!!SN:W^Advanced_Classes_Mod_Active^/?v1;

!?OB79&v1=1; [Continue trigger if Sorcery script is enabled]

 [Store hero's Estate level in v1]
!!HE-1:S13/?v1;

 [If hero has Advanced or better Estate skill, call Function 5025]
!!FU25540&v1>1:Pv1;
-----------------------------------------------------------------------------------------
 [Start of Function 5025 - Resource pile Enhancement with Advanced Estate skill]
!?FU25540;

 [Get value of resource pile (y1)]
!!ARv998/v999/v1000:V?y1;

 [Get type of resource - store  in y6]
!!OB998:U?y6;
!!FU&y6=7:E; Exit for Mithril

 [Check value stored at resource pile position (y5)]
!!PO998:N?y5;

 [If value is 0, set value at resource pile position to y1]
!!PO998&y5=0:Ny1;

 [If value at position (y1) isn't 0 and is higher than value of pile (y5),]
 [set it to value of pile]
!!VRy1&y1>y5/y5<>0:Sy5;

 [Get hero's level (y2)]
!!HE-1:Ed0/?y2;

 [Store hero's name in z5]
!!HE-1:B0/?z5;

 [If resource is wood, ore or gold, divide hero's level (y2) by 7]
!!VRy2|y6=0/y6=2/y6=6::7;

 [If resource is precious, divide hero's level (y2) by 10]
!!VRy2|y6=1/y6=3/y6=4/y6=5/y6=7::10;

 [If bonus is less than one, make it one]
!!VRy2&y2<1:S1;

 [If hero has Expert Estate skill, add one]
!!VRy2&x1=3:+1;

 [Increase value of resource pile (y1) by y2]
!!VRy1:Sy1 +y2;
!!ARv998/v999/v1000:Vy1;

 [Set z1 to "Advanced" or "Expert" depending on skill level]
!!VRz1&x1=2:Sz198775;
!!VRz1&x1=3:Sz198776;

 [If resource is gold, multiply by 100 (y1 and y3)]
!!VRy3:Sy2;
!!VRy3&y6=6:*100;
!!VRy1&y6=6:*100;

 [Set z2 string according to type and number of resource bonus]
!!FU25541:Py6/y3;

 [Check if Mithril is being used as Mithril - store in y9]
!!UN:B0/?y9;

 [If resource is mithril, set Flag 410 to True to let the Mithril script know]
 [it shouldn't display a picking-up-mithril message]
!!IF&y6=7/y9=1:V410/1; [Set 410 to True if resource is mithril]
!!IF&y6<>7:V410/0; [Set 410 to False if resource isn't mithril]

 [For mithril, set "bar" or "bars" in z-1 temporary variable]
!!VRz-1&410/y3=1:Sz198777;
!!VRz-1&410/y3>1:Sz198778;

 [Determine player's current mithril and store in y8]
!!OW:R-1/7/?y7; [Store current player's previous total mithril in y7]
!!VRy8:Sy7 +y1; [Add new mithril to previous mithril - store in y8]

 [Check if Enhanced Estate resource bonus display is disabled]
!!OW:C?y10; [Current player: y10]
!!VRy10:+1; [Add 1 to y10]
!!FU$bit$:Py10; [Convert to bit number: y-100]
!!VRy11:Sv3320; [Set y11 to v3320]
!!VRy11:&y-100; [Check if message is disabled for current player: y11]
!!FU&y11=y-100/-410:E; [Exit Function if message is disabled for current player unless Mithril]

!!FU:E; Test

 [Display increase of value message (except Mithril)]
!!IF&1000/-410:Q1/y6/y3/1/z198779;

 [If resource is mithril, display this instead]
!!IF&1000/410:Q1/y6/y1/1/z198780;
-----------------------------------------------------------------------------------------
 [Treasure Chest object trigger - Enhance gold/experience value]
!?OB101;

!!SN:W^Advanced_Classes_Mod_Active^/?y1;
!!FU&y1<>1:E; [Exit if Sorcery script isn't enabled]

!!HE-1:N?y10;

 [Store hero's Learning/Navigation/Nobility level in v1]
!!HE-1:S5/?v1;

 [Get chest subtype - v2]
!!OB998:U?v2; [v2=0 for standard chest, v2>0 for new chest types, v2>6 for Power Stones]
!!FU&v2>6:E; [Exit if it's a Power Stone]

 [Check if chest is custom or standard]
!!VRv3:S0;
!!UN&v2>0:Bv2/?v3; [v3=0 if standard operation, v3=1 if advanced (scripted)]

 [Check if chest has an artifact or not]
!!CH998&v2>0/v3=0/-875:S?v4;
!!CH998&v2=0/-875:S?v4;

 [If hero has Basic Advanced or better Learning skill and if chest is set as,]
 [standard type and doesn't contain an artifact, call Function 5026]
 [Also, must if Hero didn't die from Rogue attack (875 must be false)]
!!FU25539&v1>0/v3=0/v4=0/-875:Pv1/y10;      Pass Nobility Skill Level and Hero Number
-----------------------------------------------------------------------------------------
 [Start of Function 5026 - Treasure Chest Enhancement with Advanced Nobility skill]
!?FU25539;

 [Get value of treasure chest (y1)]
!!CHv998/v999/v1000:B?y1;

 [Disable chest object message for human player]
!!OB998&1000:M-1/1/0;

!!HEx2:A2/66/?y49/?y66;
!!HEx2:A2/67/?y49/?y67;
!!HEx2:A2/68/?y49/?y68;
!!VRy33&y66=1/y67=1/y68=1:S1;       Double Bonus if complete Set

!!SN:W^H3_Nobility_1_Hero%X2^/?y10;  If Hero has Grandmaster Nobility increase value further

 [Increase value of chest by 1 for Advanced Nobility, by 2 for Expert Nobility]
!!VRy1&y67=1:+1;  Increase Value with Diplomats Ring
!!VRy1&y33=1:+1;  Increase Value with complete Set
!!VRy1&y10=1:+1;  Increase Value with Grandmaster Nobility

!!VRy1&x1=1:+1;
!!VRy1&x1=2:+1;
!!VRy1&x1=3:+2;

!!VRy4&y67=1:+1;  Increase Value with Diplomats Ring
!!VRy4&x1=1:S500;
!!VRy4&x1=2:S500;
!!VRy4&x1=3:S1000;
!!VRy4&y10=1:S1500;


 [If value of y1 is greater than 15, set it to 15]
!!VRy1&y1>15:S15;

 [Set new value of chest]
!!CHv998/v999/v1000:By1;

 [If hero has Adventure Cave "Treasure" skill (w64=3), double y1]
!!IF:W-1;
!!VRy1&w64=3:*2;

 [If value of y1 is greater than 15, set it to 15]
!!VRy1&y1>15:S15;

 [Set y2 to 500 x y1 for gold display purposes]
!!VRy2:Sy1 *500;

 [Set y3 to y2 - 500 for experience display purposes]
!!VRy3:Sy2 -500;

 [Set z1 to "Advanced" or "Expert" depending on skill level]
!!VRz1&x1=2:Sz198781;
!!VRz1&x1=3:Sz198782;

 [Display chest message with choice of gold or experience]
 [Don't display if hero belongs to an AI]
!!IF&1000:Q2/6/y2/17/y3/7/z198783;
-----------------------------------------------------------------------------------------
 [Start of Function 5029 - Display Water Wheel details]
!?FU25534;

 [Check if square is yellow - store value in y1 (0=yellow)]
!!TRx1/x2/x3:E?y1;

 [Store bonus (gold) value in y2, actual gold value in y3]
!!WMx1/x2/x3:B?y2;
!!VRy3:Sy2 *500;

 [Restore normal right-click hint display if not yellow (y1=1) or visited (y2<1)]
!!CM|y1<>0/y2<1:R1;

 [Check if Water Wheel is upgraded by Mithril and if it is (y4=2 or 3), set z3]
!!POx1/x2/x3:N?y4;
!!VRz3:S^^;
!!VRz3|y4=2/y4=3:Sz198784;

!!VRz1:Sz198785;

 [If hero has Expert Sorcery, call Function 5030 and player]
 [is offered the chance to visit the Water Wheel from a distance]
 [y1=0 (yellow square), x4=3 (Expert Sorcery), y2>0 (not visited)]
!!FU25538&y1=0/x4=3/y2>0/999/x5=1:Px1/x2/x3/y3;

 [Display hint text if yellow square, not visited and flag 3 is true]
 [y1=0 (yellow square), x4<>3 (not Expert Sorcery) y2>0 (not visited)]
!!IF&y1=0/x4<>3/y2>0:Q1/6/y3/4^%Z1^;
-----------------------------------------------------------------------------------------
 [Start of Function 5030 - Remotely visit Water Wheel]
!?FU25538;

 [Check if Water Wheel is upgraded by Mithril and if it is (y4=2 or 3), set z3]
!!POx1/x2/x3:N?y4;
!!VRz3:S^^;
!!VRz3|y4=2/y4=3:Sz198786;

 [Ask if player wishes to visit water wheel remotely - answer in Flag 2]
!!IF:Q2/6/x4/2/z198787;

 [If player clicks OK, display message]
!!IF&2:Q2/6/x4/1/z198788;

 [Give player water wheel resources if player visited remotely]
!!OW&2:R-1/6/dx4;

 [Set water wheel resources to 0 and "visited" for current colour]
!!WMx1/x2/x3&2:B0;
!!OW&2:C?y1;
!!VRy2&2/y1=0:S-8160;
!!VRy2&2/y1=1:S-8128;
!!VRy2&2/y1=2:S-8000;
!!VRy2&2/y1=3:S-7872;
!!VRy2&2/y1=4:S-7680;
!!VRy2&2/y1=5:S-7168;
!!VRy2&2/y1=6:S-6144;
!!VRy2&2/y1=7:S-4096;
!!OBx1/x2/x3&2:C?y3;
!!VRy3&2:|y2;
!!OBx1/x2/x3&2:Cy3;
-----------------------------------------------------------------------------------------
 [Start of Function 5034 - Remotely visit Star Axis]
!?FU25535;

 [Check if hero has visited this star axis (y2) (x4=number of star axis)]
!!HEx5:V4/x4/?y2;
-------------------------------------------
 [Continue Function 5034 only if hero hasn't already visited this Star Axis]
!?FU25535&y2=0;

 [Ask if player wishes to visit star axis remotely - answer in Flag 2]
!!IF:Q2/33/1/2/z198789;

 [If player clicks OK, display message]
!!IF&2:Q2/33/1/1/z198790;

 [Give hero +1 power if player chose to visit remotely]
!!HEx5&2:Fd/d/d1/d;

 [Set Star Axis as visited if player chose to visit remotely]
!!HEx5&2:V4/x4/1;

 [Redraw screen]
!!UN:R1;

 [Disable right-click for this visit]
!!CM:R0;
-----------------------------------------------------------------------------------------
 [Start of Function 5035 - Remotely visit Garden of Revelation]
!?FU25536;

 [Check if hero has visited this garden of revelation(y2) (x4=number of garden)]
!!HEx5:V2/x4/?y2;
-------------------------------------------
 [Continue Function 5035 only if hero hasn't already visited this Garden of Revelation]
!?FU25536&y2=0;

 [Ask if player wishes to visit garden - answer in Flag 2]
!!IF:Q2/34/1/2/z198791;

 [If player clicks OK, display message]
!!IF&2:Q2/34/1/1/z198792;

 [Give hero +1 knowledge if player chose to visit remotely]
!!HEx5&2:Fd/d/d/d1;

 [Set Garden of Revelation as visited if player chose to visit remotely]
!!HEx5&2:V2/x4/1;

 [Redraw screen]
!!UN:R1;

 [Disable right-click for this visit]
!!CM:R0;
-----------------------------------------------------------------------------------------
 [Start of Function 5036 - Look up artifact class]
!?FU25537;

 [x1=artifact number. Lookup artifact class (y1) and store text in z2]
!!UN:Ax1/3/?y1;
!!VRz2:Sz198793;
!!VRz2&x1=0:Sz198794;
!!VRz2&x1=2:Sz198795;
!!VRz2&x1>=3/x1<=6:Sz198796;
!!VRz2&y1=2:Sz198797;
!!VRz2&y1=4:Sz198798;
!!VRz2&y1=8:Sz198799;
!!VRz2&y1=16:Sz198800;
!!VRz2&x1>=146/x1<=155:Sz198801;
-----------------------------------------------------------------------------------------
 [Start of Function 5037 - ERM Chest -  Display "Trapped/Non-Trapped" message]
!?FU25515;

 [Check for trap (x mod 4 = 0, y mod 4 = 0]
!!VRx1:%4;
!!VRx2:%4;

 [Display message if chest trapped]
!!IF&x1=0/x2=0:Q1/-1/-1/4/z198802;

 [Display message if chest is not trapped]
!!IF|x1<>0/x2<>0:Q1/-1/-1/4/z198803;

 [Disable standard right-click Info]
!!CM:R0;

** End of Script **
****************************************************************************************************
Various Tweaks


!?BG0&1000;
Change graphics of Meteor Shower and Implosion when at Master and GM level
!!BG:A?v1 S?v2;
!!FU|v1<>1/v2<>23:E;                    [exit if not Hero cast or spell not FB]

!!BG:H?y10;
!!SN:W^H3_Earth Magic_0_Hero%Y10^/?y20; [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]
!!FU&y20=0:E;

!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
!!SN:Ey2/1/^C08SPE0.def^/^Meteor.def^;  [switch Lightning DEF to asdFireball C20SPX.DEF C13SPF.DEF]

!?BG1&1000;
!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
!!SN:Ey2/1/^C08SPE0.def^/^^;            [restore Fireball DEF]


!?BG0&1000;
Change graphics of Meteor Shower and Implosion when at Master and GM level
!!BG:A?v1 S?v2;
!!FU|v1<>1/v2<>18:E;                    [exit if not Hero cast or spell not CL]

!!BG:H?y10;
!!SN:W^H3_Earth Magic_0_Hero%Y10^/?y20; [Checke ob der Held Grandmaster Nobility hat und Speichere in y12]
!!FU&y20=0:E;

!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
*!SN:Ey2/1/^C06SPF0.def^/^C07SPE0.def^; switch  Armageddon to Mass Fear
*!SN:Ey2/1/^C06SPF0.def^/^C08SPE0.def^; switch  Armageddon to Meteor Shower
!!SN:Ey2/1/^C05SPE0.def^/^Implosion.def^;[switch  Old Implosion to new Animation]

!?BG1&1000;
!!SN:L^Era.dll^/?y1;                    [y1=handle]
!!SN:Ay1/^RedirectFile^/?y2;            [y2=FU address]
!!SN:Ey2/1/^C05SPE0.def^/^^;


!?CM4;                                  [Disable the renewal spell book cast bypass]
*Now you cannot mulitcast by clicking on your hero in battle, you need to perform min one action
!!CM:I?v1 D?v2;
!!CM&v1=0/v2=252:R;

!?BF;
*Bad fix: prevent Soul Eater from casting in all quick Battles to prevent crash
!!SN:W^Typhon_Third_Upgrade_Mod_Active^/?y1; !!FU&y1=0:E; [Check for Third Upgrade Mod]
!!BA:Q?y1;
!!FU&y1=0:E;

!!re i/0/41;
  !!BMi:T?y3;
  !!if|y3=178/y3=187;
  !!BMi:E0;
  !!en;
!!en;


********************************************************************************



                                      TEST SECTION




********************************************************************************


*********************
!?FU(OnGameEnter);
!!FU:E;
!!rei /0/155;
    !!FU(acm_Chear):Pi;
!!en;


!?FU(acm_Chear);

*!SN:W^H3_Pathfinding_0_Hero%X1^/1;
*!SN:W^H3_Pathfinding_1_Hero%X1^/1;
*!SN:W^H3_Archery_0_Hero%X1^/1;
*!SN:W^H3_Archery_1_Hero%X1^/1;
*!SN:W^H3_Logistics_0_Hero%X1^/1;
*!SN:W^H3_Logistics_1_Hero%X1^/1;
*!SN:W^H3_Scouting_0_Hero%X1^/1;
*!SN:W^H3_Scouting_1_Hero%X1^/1;
*!SN:W^H3_Diplomacy_0_Hero%X1^/1;
*!SN:W^H3_Diplomacy_1_Hero%X1^/1;
*!SN:W^H3_Nobility_0_Hero%X1^/1;
*!SN:W^H3_Nobility_1_Hero%X1^/1;
*!SN:W^H3_Leadership_0_Hero%X1^/1;
*!SN:W^H3_Leadership_1_Hero%X1^/1;
*!SN:W^H3_Wisdom_0_Hero%X1^/1;
*!SN:W^H3_Wisdom_1_Hero%X1^/1;
*!SN:W^H3_Mysticism_0_Hero%X1^/1;
*!SN:W^H3_Mysticism_1_Hero%X1^/1;
*!SN:W^H3_Luck_0_Hero%X1^/1;
*!SN:W^H3_Luck_1_Hero%X1^/1;
!!SN:W^H3_Ballistics_0_Hero%X1^/1;
!!SN:W^H3_Ballistics_1_Hero%X1^/1;
*!SN:W^H3_Eagle Eye_0_Hero%X1^/1;
*!SN:W^H3_Eagle Eye_1_Hero%X1^/1;
*!SN:W^H3_Necromancy_0_Hero%X1^/1;
*!SN:W^H3_Necromancy_1_Hero%X1^/1;
*!SN:W^H3_Estates_0_Hero%X1^/1;
*!SN:W^H3_Estates_1_Hero%X1^/1;
*!SN:W^H3_Fire Magic_0_Hero%X1^/1;
*!SN:W^H3_Fire Magic_1_Hero%X1^/1;
*!SN:W^H3_Air Magic_0_Hero%X1^/1;
*!SN:W^H3_Air Magic_1_Hero%X1^/1;
*!SN:W^H3_Water Magic_0_Hero%X1^/1;
*!SN:W^H3_Water Magic_1_Hero%X1^/1;
*!SN:W^H3_Earth Magic_0_Hero%X1^/1;
*!SN:W^H3_Earth Magic_1_Hero%X1^/1;
*!SN:W^H3_Scholar_0_Hero%X1^/1;
*!SN:W^H3_Scholar_1_Hero%X1^/1;
*!SN:W^H3_Tactics_0_Hero%X1^/1;
*!SN:W^H3_Tactics_1_Hero%X1^/1;
*!SN:W^H3_Artillery_0_Hero%X1^/1;
*!SN:W^H3_Artillery_1_Hero%X1^/1;
*!SN:W^H3_Learning_0_Hero%X1^/1;
*!SN:W^H3_Learning_1_Hero%X1^/1;
*!SN:W^H3_Offense_0_Hero%X1^/1;
*!SN:W^H3_Offense_1_Hero%X1^/1;
*!SN:W^H3_Armorer_0_Hero%X1^/1;
*!SN:W^H3_Armorer_1_Hero%X1^/1;
*!SN:W^H3_Intelligence_0_Hero%X1^/1;
*!SN:W^H3_Intelligence_1_Hero%X1^/1;
*!SN:W^H3_Sorcery_0_Hero%X1^/1;
*!SN:W^H3_Sorcery_1_Hero%X1^/1;
*!SN:W^H3_Resistance_0_Hero%X1^/1;
*!SN:W^H3_Resistance_1_Hero%X1^/1;
*!SN:W^H3_First Aid_0_Hero%X1^/1;
*!SN:W^H3_First Aid_1_Hero%X1^/1;